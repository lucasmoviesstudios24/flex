<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Flex â€” Shop &amp; Flex Game (Inventory at Bottom)</title>
<link href="https://fonts.googleapis.com/css2?family=Bungee:wght@400&amp;family=Russo+One&amp;family=Rajdhani:wght@600;700&amp;display=swap" rel="stylesheet"/>
<style>
:root{
  --ui-blue:#59a7ff;
  --ui-blue-dark:#2973e3;
  --ink:#0a0f1a;
  --panel:#3a3a42;
  --panel-2:#2b2b31;
  --slot:#9aa0a6;
  --success:#2ecc71;
  --danger:#e74c3c;
  --gold:#ffb200;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --radius:28px;
  --c-common:#6dff79;
  --c-rare:#4cc4ff;
  --c-epic:#b66bff;
  --c-legendary:#ffd84a;
  --c-legacy:#ffffff;
  --c-mythic:#ffd700;
}

/* page / backdrop */
html,body{ height:100%; margin:0; background: linear-gradient(to bottom, #89CFF0 0%, #90EE90 100%); overscroll-behavior:none; color:#fff; font-family:"Rajdhani", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; user-select:none; }
body::before{
  content:"";
  position:fixed;
  inset:0;
  background-image: linear-gradient(0deg, rgba(0,0,0,.06), rgba(255,255,255,.06)), repeating-linear-gradient(45deg, #1aa69e 0 12px, #1ca3d8 12px 24px, #1f7fb8 24px 36px), repeating-linear-gradient(-45deg, #1dc79d 0 12px, #1ea9d0 12px 24px, #2b6ab8 24px 36px);
  filter:contrast(115%) saturate(120%);
  image-rendering:pixelated;
  background-size: 100% 100%, 24px 24px, 24px 24px;
  mix-blend-mode: normal;
  z-index:-2;
}
body::after{
  content:"";
  position:fixed;
  inset:0;
  z-index:-1;
  background:linear-gradient(90deg, rgba(255,255,255,.05), rgba(0,0,0,.05));
  image-rendering: pixelated;
  background-size: 8px 8px;
  opacity:.45;
}
/* ðŸ”´ðŸ”µ Red/Blue override */
body.redblue::before {
  content: "";
  position: fixed;
  inset: 0;
  z-index: -2;
  background: linear-gradient(to bottom, #ff4b5c 0%, #4b6aff 100%) !important;
}

body.redblue::after {
  content: "";
  position: fixed;
  inset: 0;
  z-index: -1;
  background: none !important;
}

/* game container */
.game{
  position:relative;
  min-height:100%;
  padding:20px;
  /* make space at bottom so fixed inventory doesn't overlap other content */
  padding-bottom:220px;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  gap:24px;
}

/* topbar */
.cash{
  font-family:"Bungee", sans-serif;
  font-size: clamp(28px, 5vw, 54px);
  background: var(--ui-blue);
  color:#000;
  border:6px solid #0e2a4c;
  border-radius: 28px;
  padding: 6px 28px 8px;
  box-shadow: var(--shadow);
  letter-spacing:2px;
  text-shadow: 0 2px 0 rgba(255,255,255,.35);
}
.topbar{ display:flex; gap:14px; align-items:center; justify-content:center; flex-wrap:wrap; }
.eps{ padding:6px 12px; border-radius:12px; background:rgba(0,0,0,.35); font-weight:800; }

/* left rail */
.left-rail{
  position:fixed;
  left:16px;
  top:120px;
  display:flex;
  flex-direction:column;
  gap:16px;
  z-index:7;
}
.icon-btn{
  width:96px;
  height:96px;
  border-radius:20px;
  display:grid;
  place-items:center;
  cursor:pointer;
  box-shadow:var(--shadow);
  border:4px solid rgba(0,0,0,.4);
}
.icon-shop{ background:#57d85a; }
.icon-tools{ background:#8c8f95; }
.icon-music{ background: linear-gradient(45deg,#ffd86a,#ff7ac7); }
.icon-pets{ background: #ffb6e6; } /* paw button style */
.icon-btn svg{ width:64%; height:64%; }
.icon-btn img{ width:80%; height:80%; }

/* stands / pedestals area (keeps visually centered above inventory) */
.stands{
  margin-top:24px;
  margin-bottom:12px; /* small gap before the visual area above the inventory */
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:40px;
  width:min(100%,1000px);
  z-index:3;
}
.stand{
  position:relative;
  /* taller so pedestals sit well above the bottom inventory bar */
  height:160px;
  display:flex;
  align-items:flex-end;
  justify-content:center;
}
.pedestal{
  width: 200px;
  height: 48px;
  background: linear-gradient(#ffda66, #f0a800);
  border-radius: 12px;
  box-shadow: inset 0 6px 0 rgba(255,255,255,.35), 0 10px 0 #bb7a00, 0 14px 18px rgba(0,0,0,.4);
}
.placed{
  position:absolute;
  /* position above pedestal; increased so it reads nicely above the bottom inventory */
  bottom:110px;
  display:flex;
  align-items:center;
  justify-content:center;
  width:160px;
  height:80px;
  border-radius:16px;
  background:rgba(0,0,0,.18);
  backdrop-filter: blur(1px);
  outline:4px solid rgba(0,0,0,.35);
  transition:transform .15s ease, box-shadow .2s;
  z-index:4;
}
.placed:hover{ transform:translateY(-3px) scale(1.02); }
.placed.glow{ box-shadow:0 8px 30px rgba(255,220,120,.9); transform:translateY(-6px) scale(1.06); }

/* PET ROW */
.pet-row{
  margin-top:8px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:40px;
  width:min(100%,1000px);
  z-index:3;
}
.pet-stand{
  position:relative;
  height:120px;
  display:flex;
  align-items:flex-end;
  justify-content:center;
}
.pet-pedestal{
  width: 140px;
  height: 40px;
  background: linear-gradient(#c3c3c3, #8e8e8e);
  border-radius: 10px;
  box-shadow: inset 0 4px 0 rgba(255,255,255,.35), 0 6px 0 rgba(0,0,0,.25);
}
.pet-placed{
  position:absolute;
  bottom:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  width:120px;
  height:64px;
  border-radius:12px;
  background:rgba(0,0,0,.14);
  outline:3px solid rgba(0,0,0,.35);
  z-index:4;
}
.pet-placed img{ width:56px; height:56px; border-radius:8px; margin-right:6px; }

/* timer badge on pet placed */
.pet-timer{
  position:absolute;
  bottom:58px;
  left:6px;
  font-size:12px;
  padding:4px 8px;
  border-radius:10px;
  background:rgba(0,0,0,.6);
  color:#fff;
  z-index:6;
}

/* === INVENTORY FIXED TO BOTTOM (MAIN CHANGES) === */
.inventory-wrap{
  /* make the inventory a fixed bottom bar centered horizontally */
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:18px;
  width: min(1100px, 96%);
  z-index:8;
  display:flex;
  justify-content:center;
  pointer-events:auto;
}

/* inventory container styled to match the concept art: big rounded rectangle with thick outline */
.inventory{
  display:flex;
  gap:16px;
  overflow-x:auto;
  padding:20px;
  background: linear-gradient(180deg, #d0d2d6, #a9adaf); /* subtle metallic grey like the concept */
  border-radius:28px;
  box-shadow: 0 18px 50px rgba(0,0,0,.6), var(--shadow);
  border:8px solid #111; /* thick dark outline similar to concept */
  align-items:center;
  /* ensure the inventory bar doesn't shrink too small on tiny screens */
  min-width: 320px;
}

/* larger slot sizes to match concept visuals */
.slot{
  min-width:140px;
  height:112px;
  background: #b4b8bd;
  border-radius:20px;
  display:grid;
  place-items:center;
  color:#111;
  font-weight:700;
  border:6px solid #262a2f;
  position:relative;
  cursor:pointer;
  flex: 0 0 auto;
  box-shadow: 0 6px 18px rgba(0,0,0,.35) inset;
}
.slot.selected{ outline:6px solid var(--ui-blue);}
.slot .rar{
  position:absolute;
  right:8px;
  bottom:8px;
  font-size:12px;
  padding:3px 8px;
  border-radius:12px;
  background:rgba(0,0,0,.4);
  color:#fff;
}
.slot img{ width:72px; height:72px; border-radius:10px; }

/* === Pet image size upgrade === */
.slot.is-pet { height: 132px; }
.slot.is-pet img { width: 96px; height: 96px; }

.pet-stand { height: 150px; }
.pet-placed { height: 80px; }
.pet-placed img { width: 72px; height: 72px; border-radius: 10px; }

/* shop overlay and other UI left mostly unchanged */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}
.overlay.show{ display:flex; }
.shop{
  width:min(1000px, 92%);
  background:#4a4a52;
  border-radius:30px;
  border:6px solid #212127;
  box-shadow:var(--shadow);
  padding:24px;
  position:relative;
  color:#e8e8ee;
}
.shop h2{ text-align:center; margin:0 0 18px 0; font-family:"Russo One"; font-size:42px; letter-spacing:1px; color:#8aff8f; text-shadow:0 2px 0 #0f0f0f; }
.refresh-note{ text-align:center; font-weight:700; opacity:.85; margin-top:10px; }
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }
.card{ background:#33333b; border-radius:22px; border:4px solid #1a1a1f; padding:18px; display:flex; flex-direction:column; gap:8px; justify-content:space-between; min-height:160px; }
.card h3{ margin:0; font-size:30px; font-family:"Russo One"; letter-spacing:1px; color:#d7d9dd; }
.tag{ font-size:26px; font-family:"Bungee"; letter-spacing:1px; -webkit-text-stroke:2px #000; color:transparent; filter:drop-shadow(0 2px 0 rgba(0,0,0,.5)); }
.t-common{ color:var(--c-common); }
.t-rare{ color:var(--c-rare); }
.t-epic{ color:var(--c-epic); }
.t-legendary{ color:var(--c-legendary); }
.t-birthday {
  background: linear-gradient(90deg, #ff62d5, #ffd700, #ff62d5);
  background-size: 200% auto;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  animation: birthdayAnim 1.2s linear infinite;
  font-weight:900;
}
@keyframes birthdayAnim {
  0% { background-position: 0% 50%; letter-spacing: 2px; }
  50% { background-position: 100% 50%; letter-spacing: 6px; }
  100% { background-position: 0% 50%; letter-spacing: 2px; }
}
.t-legacy{
  background: linear-gradient(90deg, #ff004c, #ff7a00, #ffd400, #18e300, #00e7ff, #3a31ff, #ff31ff, #ff004c);
  background-size: 400% 100%;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  animation: rainbowShift 4s linear infinite;
}
.t-mythic{
  background: linear-gradient(90deg, #ffd700, #fff8b0, #ffcc00);
  background-size: 200% auto;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  animation: goldShimmer 2.5s linear infinite;
  font-weight:900;
}

.t-unique {
  color: navy;
  text-shadow: 0 0 6px rgba(0,0,128,.6);
  animation: uniqueSparkle 2s linear infinite;
}
@keyframes uniqueSparkle {
  0%,100% { text-shadow: 0 0 6px rgba(255,255,255,.2); }
  50%     { text-shadow: 0 0 10px rgba(255,255,255,.7); }
}

.t-exotic {
  color: cyan;
  text-shadow: 0 0 8px rgba(0,255,255,.7);
  animation: exoticPulse 2.5s ease-in-out infinite;
}
@keyframes exoticPulse {
  0%,100% { text-shadow: 0 0 8px rgba(0,255,255,.3); }
  50%     { text-shadow: 0 0 16px rgba(0,255,255,1); }
}

/* apply on the <p> wrapper holding the item image */
.glow-exotic {
  filter: drop-shadow(0 0 8px rgba(0,255,255,.8))
          drop-shadow(0 0 16px rgba(0,255,255,.5));
}

.t-unique {
  color: navy;
  position: relative;
  text-shadow: 0 0 3px rgba(255,255,255,0.3);
}

/* Sparkle effect overlay */
.t-unique::after {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  width: calc(100% + 4px);
  height: calc(100% + 4px);
  pointer-events: none;
  background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,0.5) 50%, transparent 100%);
  background-size: 200% 100%;
  animation: uniqueSparkle 2.5s linear infinite;
  mix-blend-mode: screen;
  border-radius: 4px;
}

@keyframes uniqueSparkle {
  0%   { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

@keyframes rainbowShift{ 0%{ background-position: 0% 50%; } 100%{ background-position: 100% 50%; } }
@keyframes goldShimmer{ 0%{ background-position: 0% 50%; } 100%{ background-position: 200% 50%; } }

.price{ font-weight:900; font-size:22px; }
.buy{ align-self:flex-end; padding:10px 16px; font-weight:900; border:none; border-radius:14px; cursor:pointer; background:linear-gradient(var(--ui-blue), var(--ui-blue-dark)); color:#fff; box-shadow:var(--shadow); }
.upgrade{ align-self:flex-end; padding:10px 16px; font-weight:900; border:none; border-radius:14px; cursor:pointer;
  background:linear-gradient(45deg,#ffd86a,#ff7a00); color:#111; box-shadow:var(--shadow); }
.upgrade:disabled{ filter:grayscale(1) brightness(.7); cursor:not-allowed; }

/* Badge above EPS for total multiplier (pet + rebirth) */
#multBadge{ padding:2px 10px; border-radius:12px; background:linear-gradient(45deg,#ffd86a,#ff7a00); color:#000;
  font-weight:900; display:none; margin-left:6px; }

.buy:disabled{ filter:grayscale(1) brightness(.7); cursor:not-allowed; }
.closeX{ position:absolute; right:12px; top:8px; font-size:28px; background:#222; color:#fff; border:none; border-radius:14px; width:44px; height:44px; cursor:pointer; }

/* forge button */
#forgeBtn{
  margin-top:6px;
  padding:10px 18px;
  border-radius:14px;
  background: linear-gradient(45deg, #ffd86a, #ffb200);
  border:4px solid rgba(0,0,0,.35);
  color:#000;
  font-weight:900;
  box-shadow: 0 8px 30px rgba(255,200,60,0.18);
  cursor:pointer;
  display:none;
}

/* responsive tweaks */
@media (max-width:800px){
  .stands{ gap:22px; }
  .pedestal{ width:150px;}
  .placed{ width:130px; bottom:90px; }
  .icon-btn{ width:76px; height:76px; }
  .slot{ min-width:100px; height:88px; }
  .inventory{ padding:12px; gap:8px; border-radius:18px; }
  .inventory-wrap{ bottom:12px; width: calc(100% - 30px); }
}

/* ðŸ”´ðŸ”µ Full background override for red/blue mode */
body.redblue {
  background: linear-gradient(to bottom, #ff4b5c 0%, #4b6aff 100%) !important;
}

body.redblue::before,
body.redblue::after {
  display: none !important; /* turn off the original pseudo-element layers */
}

// === Universal PNG resolver for any item name ===
window.ITEM_FILE_MAP = window.ITEM_FILE_MAP || {};
window.ITEM_FILENAME_MAP = window.ITEM_FILENAME_MAP || {};

function __normalizeFileNameFromName(n){
  return String(n||'').toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'') + '.png';
}

// Folders we will try in order for file-backed items
window.__ICON_FOLDERS = [
  'icons/',
  'stranger_things_items/',
  'hawkins_items/',
  'cosmic_items/',
  'dodger_items/',
  'pets/'
];

// Build NAME -> filename map dynamically from any global arrays that look like [{name, file}]
(function buildDynamicItemFileMap(){
  try{
    for (const key in window){
      const val = window[key];
      if (Array.isArray(val) && val.length && typeof val[0]==='object'){
        val.forEach(x=>{
          if (x && typeof x.name==='string' && typeof x.file==='string' && /\.png$/i.test(x.file)){
            // try to infer folder from any code that sets obj.svg = 'folder/'+it.file
            // we can't parse code at runtime, so store filename; folder will be resolved below
            ITEM_FILENAME_MAP[x.name] = x.file;
          }
        });
      }
    }
  }catch(e){}
})();

function __tryResolvePathSync(name){
  // Highest priority: explicit map with full path
  if (ITEM_FILE_MAP[name]) return ITEM_FILE_MAP[name];
  const file = ITEM_FILENAME_MAP[name] || __normalizeFileNameFromName(name);
  for (const folder of __ICON_FOLDERS){
    // naive return; we'll verify with onerror/onload later
    return folder + file;
  }
  return null;
}

// Attach lazy fix-up on <img> elements for items that might need probing
function __attachImageFixups(img, it){
  if (!img) return;
  let tried = 0;
  const file = ITEM_FILENAME_MAP[it.name] || __normalizeFileNameFromName(it.name);
  const candidates = [];
  for (const folder of __ICON_FOLDERS){ candidates.push(folder + file); }

  function tryNext(){
    if (tried >= candidates.length){ return; }
    const next = candidates[tried++];
    img.src = next;
  }

  img.addEventListener('error', ()=>{
    tryNext();
  });

  img.addEventListener('load', ()=>{
    try{
      // if we loaded a PNG path, persist it
      const src = img.getAttribute('src')||'';
      if (src.endsWith('.png')){
        it.svg = src;
        if (typeof save === 'function'){ save(); }
      }
    }catch(e){}
  });

  // If current src is not a .png, start probing
  const cur = img.getAttribute('src')||'';
  if (!/\.png($|\?)/i.test(cur)){ tryNext(); }
}
/* === Add-on: Achievements + Background Selector === */
.right-rail{position:fixed;right:16px;top:180px;display:flex;flex-direction:column;gap:16px;z-index:8;}
.icon-achievements,.bg-selector-btn{width:76px;height:76px;border-radius:20px;display:grid;place-items:center;cursor:pointer;box-shadow:var(--shadow);border:4px solid rgba(0,0,0,.4);}
.icon-achievements{background:#ffd24a;}
.bg-selector-btn{position:fixed;right:120px;bottom:24px;z-index:9;background:linear-gradient(45deg,#222,#444);}
.icon-achievements svg,.bg-selector-btn svg{width:60%;height:60%;}

.sheet{width:min(1024px,94%);background:#4a4a52;border-radius:30px;border:6px solid #212127;box-shadow:var(--shadow);padding:24px;color:#e8e8ee;position:relative;}
.sheet h2{margin:0 0 18px;font-family:"Russo One";font-size:42px;letter-spacing:1px;text-align:center;}

.rarity-rail{width:220px;background:#25252b;border-radius:24px;border:4px solid #111;padding:16px;display:flex;flex-direction:column;gap:8px;align-self:flex-start;}
.achv-wrap{display:grid;grid-template-columns:220px 1fr;gap:18px;}
.rail-btn{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:14px;background:#33333b;border:2px solid #1a1a1f;font-weight:800;cursor:pointer;}
.rail-btn.active{outline:3px solid var(--ui-blue);}
.badge-dot{width:10px;height:10px;border-radius:999px;background:#666;}
.badge-dot.done{background:#58e36c;}

.quest-card{background:#33333b;border-radius:22px;border:4px solid #1a1a1f;padding:18px;display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:14px;}
.quest-card .q-left{display:flex;align-items:center;gap:12px;}
.q-check{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;border:2px solid #111;background:#555;font-weight:900;}
.q-check.ok{background:#58e36c;color:#111;}
.reward-pill{padding:6px 10px;border-radius:12px;background:#ffb200;color:#000;font-weight:900;}

.bg-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;}
.bg-tile{height:120px;border-radius:18px;border:4px solid #111;display:flex;flex-direction:column;justify-content:flex-end;padding:12px;box-shadow:var(--shadow);position:relative;overflow:hidden;}
.bg-tile.locked::after{content:"LOCKED";position:absolute;inset:auto 0 0 0;background:rgba(0,0,0,.55);color:#fff;text-align:center;padding:6px 0;font-weight:900;}
.bg-apply{align-self:flex-end;margin-top:6px;}

body.bg-green{background:linear-gradient(to bottom,#3edc64,#1e6f2b)!important;}
body.bg-blue{background:linear-gradient(to bottom,#4aa3ff,#0b2e6e)!important;}
body.bg-purple{background:linear-gradient(to bottom,#a76bff,#ff72c6)!important;}
body.bg-orange{background:linear-gradient(to bottom,#ff9b3d,#b98200)!important;}
body.bg-legacy{background:linear-gradient(135deg,#ff7eb3,#ff2a68)!important;}
body.bg-unique{background:linear-gradient(135deg,#0a1a4b,#123a8c)!important;}
body.bg-exotic{background:linear-gradient(135deg,#cfefff,#a0a9b8)!important;}
body.bg-mythic{background:linear-gradient(135deg,#FFD700,#B8860B)!important;}
body.bg-crypto{background:linear-gradient(135deg,#ff62d5,#ffd84a)!important;}
body.bg-rainbow{background:linear-gradient(135deg,#ff004c,#ff7a00,#ffd400,#18e300,#00e7ff,#3a31ff,#ff31ff);background-size:400% 400%;animation:rainbowFlow 14s linear infinite;}
@keyframes rainbowFlow{0%{background-position:0% 50%}100%{background-position:100% 50%}}

/* Deletion mode */
body.deleting .slot .del-x { display:block !important; }
.slot .del-x,
.pet-placed .del-x {
  display:none; position:absolute; right:-8px; top:-8px; width:26px; height:26px; border-radius:50%;
  background:#ff3b30; color:#fff; font-weight:900; box-shadow:0 2px 6px rgba(0,0,0,.4);
  border:2px solid #111; cursor:pointer; display:grid; place-items:center; z-index:3;
}
.slot { position:relative; }
/* Trash toggle visual state */
#deleteToggleBtn svg{filter:none;opacity:.95;}
#deleteToggleBtn.active svg{filter:drop-shadow(0 0 6px rgba(255,59,48,.6));stroke:#ff3b30;}

/* === Achievements overlay: size, scroll, and no-overlap (final) === */
#achOverlay .sheet{
  max-height: min(90vh, 820px);
  display: flex;
  flex-direction: column;
  overflow: hidden; /* keeps the sheet capped; inner area will scroll */
}

#achOverlay .achv-wrap{
  /* scrollable inner area */
  flex: 1 1 auto;
  min-height: 0;
  overflow: auto;

  /* lock the two columns so they don't overlap */
  display: grid !important;
  grid-template-columns: 220px minmax(0, 1fr) !important;
  gap: 16px;
  align-items: start;
}

#achOverlay .rarity-rail{
  grid-column: 1;
  width: 220px; min-width: 220px; max-width: 220px;
  position: sticky; top: 0;      /* rail stays visible while the right side scrolls */
  z-index: 1;
  float: none;                   /* neutralize any stray float rules */
}

#achOverlay #achContent{
  grid-column: 2;
  min-width: 0;                  /* CRITICAL: lets content shrink within its grid track */
}

/* safety so children don't force overflow */
#achOverlay .achv-wrap > *{
  min-width: 0;
  box-sizing: border-box;
}

/* Right-side vertical list under Achievements */
.right-rail{
  position: fixed;
  right: 16px;
  top: 180px;
  display: flex;
  flex-direction: column;  /* vertical list */
  gap: 16px;
  z-index: 8;
}

/* Use the rail footprint; ignore any old fixed/inset styles */
.right-rail #openBgSelector,
.right-rail #deleteToggleBtn{
  position: static !important;
  inset: auto !important;
  width: 76px; height: 76px;   /* same size as Achievements */
  margin: 0;
  display: grid; place-items: center;
}

/* Ensure the delete button is icon-only (no button background/border) */
#deleteToggleBtn.delete-toggle-btn{
  background: none !important;
  border: none !important;
  box-shadow: none !important;
}

/* === Red Money (top money banner override) === */
body.money-red .cash{
  background: linear-gradient(#ff4b5c, #8b0000) !important;
  border-color: #3a0a0a !important;
}

/* === Pet Shop: make overlay scrollable & keep the X reachable === */
#petOverlay{
  overflow: auto;
  padding: 24px 12px; /* breathing room so the dialog isn't flush to edges while scrolling */
}
#petOverlay .shop{
  max-height: min(92dvh, 840px); /* cap height so content fits on small screens */
  overflow: auto;                /* allow inner scrolling */
}
/* Keep the close button reachable while scrolling the Pet Shop */
/* Pet Shop close button: like before (absolute); reach it by scrolling to the top */
#petOverlay .shop .closeX{
  position: absolute;
  top: 8px;
  right: 12px;
  margin-left: 0;
  z-index: 20;
}
@media (max-width: 800px){
  #petOverlay .shop{ max-height: min(92dvh, 740px); }
}

/* ===== admin broadcast banner ===== */
#adminMsgBanner{
  position:fixed; left:0; right:0; top:-120px; z-index:9999;
  display:flex; gap:12px; align-items:center; justify-content:center;
  min-height:56px; padding:10px 16px;
  font-weight:800; letter-spacing:.2px;
  color:#000; text-shadow:0 1px 0 rgba(255,255,255,.4);
  border-bottom:4px solid rgba(0,0,0,.35);
  box-shadow:0 10px 30px rgba(0,0,0,.35);
  transition: transform .35s ease, top .35s ease, background .25s;
  transform: translateY(-100%);
}
#adminMsgBanner.show{ top:0; transform: translateY(0); }
#adminMsgBanner .msg{ max-width:1100px; text-align:center; }
#adminMsgBanner .close{ margin-left:auto; cursor:pointer; font-weight:900; }
#adminMsgBanner.info{ background: #79ffe1; }
#adminMsgBanner.warn{ background: #ffd86a; }
#adminMsgBanner.success{ background: #a7ff83; }

/* === Quick Inventory Filters (mini-sheet) === */
.inv-filter-toggle{
  position:fixed;
  right:16px;
  bottom: 90px; /* sits just above the bottom inventory bar */
  width:64px;height:64px;
  border-radius:18px;
  background:#2b2b31;
  border:4px solid rgba(0,0,0,.45);
  box-shadow: var(--shadow);
  display:grid;place-items:center;
  cursor:pointer;
  z-index:10;
}
.inv-filter-toggle svg{width:60%;height:60%}
.inv-filter-toggle:active{transform:translateY(1px)}

.inv-filter-sheet{
  position:fixed;
  right:16px;
  bottom: 146px; /* opens right above the toggle */
  width:260px;
  max-height:60vh;
  background:#3e3e46;
  color:#f1f1f5;
  border-radius:20px;
  border:3px solid rgba(0,0,0,.45);
  box-shadow: var(--shadow);
  transform: translateY(16px) scale(.98);
  opacity:0; pointer-events:none;
  transition: transform .18s ease, opacity .18s ease;
  z-index: 20;
}
.inv-filter-sheet.show{ opacity:1; pointer-events:auto; transform:none; }
.inv-filter-sheet header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px; font-weight:800; letter-spacing:.25px;
}
.inv-filter-sheet header button{ 
  background:#ff4b5c; color:#fff; border:none; border-radius:12px; 
  padding:6px 10px; font-weight:800; cursor:pointer;
}
.inv-filter-sheet .opts{ padding:6px 12px 12px; display:grid; grid-template-columns:1fr 1fr; gap:8px 12px; }
.inv-filter-sheet .opt{ display:flex; align-items:center; gap:8px; background:#494952; padding:8px 10px; border-radius:12px; }
.inv-filter-sheet .actions{ display:flex; gap:10px; padding:10px 12px 14px; }
.inv-filter-sheet .actions button{
  flex:1 1 auto; padding:10px 12px; border-radius:12px; border:none; font-weight:800; cursor:pointer;
}
.inv-filter-sheet .actions .all{ background:#1fb978; color:#fff; }
.inv-filter-sheet .actions .clear{ background:#2b2b31; color:#fff; border:2px solid #565660; }
@media (max-width: 900px){
  .inv-filter-toggle{ right:12px; bottom: 90px; width:56px; height:56px; }
  .inv-filter-sheet{ right:12px; bottom: 146px; width:238px; }
}

/* === Rarity-themed styles for filter options === */
:root{
  --c-common:#27c553;
  --c-rare:#2ea0ff;
  --c-epic:#b060ff;
  --c-legendary:#ffa21a;
  --c-legacy:#ffffff;
  --c-unique:#00c0ff;
  --c-exotic:#00d4a8;
  --c-mythic:#ffd400;
  --c-crypto:#ff7a5a;
  --c-pets:#f7a8d8;
  --c-eggs:#6cc24a;
  --c-event:#ff3b30;
}
@keyframes opt-glow { 0%,100%{ box-shadow:0 0 0 0 rgba(255,255,255,.08);} 50%{ box-shadow:0 0 0 6px rgba(255,255,255,0);} }
@keyframes opt-shine { 0%{ background-position:200% 0;} 100%{ background-position:-200% 0;} }
@keyframes opt-gradmove { 0%{background-position:0% 50%;} 100%{background-position:100% 50%;} }
@keyframes opt-rotate { to { transform: rotate(360deg);} }

.inv-filter-sheet .opt{
  position:relative;
  overflow:hidden;
}
.inv-filter-sheet .opt input{ accent-color: var(--c, #9aa0a6); }

/* Left color bar */
.inv-filter-sheet .opt::before{
  content:''; position:absolute; left:0; top:0; bottom:0; width:6px; background:var(--c,#888);
}

/* Common */
.inv-filter-sheet .opt-common{ --c: var(--c-common); }
.inv-filter-sheet .opt-common span{ color: var(--c-common); }

/* Rare */
.inv-filter-sheet .opt-rare{ --c: var(--c-rare); }
.inv-filter-sheet .opt-rare span{ color: var(--c-rare); }
.inv-filter-sheet .opt-rare{ box-shadow: inset 0 0 0 1px rgba(46,160,255,.25); }

/* Epic */
.inv-filter-sheet .opt-epic{ --c: var(--c-epic); }
.inv-filter-sheet .opt-epic span{ color: var(--c-epic); }
.inv-filter-sheet .opt-epic{ animation: opt-glow 2.2s ease-in-out infinite; }

/* Legendary (gold flicker + shine) */
.inv-filter-sheet .opt-legendary{ --c: var(--c-legendary);
  background-image: linear-gradient(90deg, rgba(255,255,255,.09), rgba(255,255,255,0) 40%, rgba(255,255,255,.09));
  background-size:200% 100%; animation: opt-shine 3.2s linear infinite;
  box-shadow: inset 0 0 0 1px rgba(255,162,26,.28);
}
.inv-filter-sheet .opt-legendary span{ color: var(--c-legendary); }

/* Legacy (rainbow text) */
.inv-filter-sheet .opt-legacy{ --c: var(--c-legacy); }
.inv-filter-sheet .opt-legacy span{
  background: linear-gradient(45deg,#ff004c,#ffb600,#00ff95,#00a2ff,#b400ff);
  background-size: 300% 100%;
  -webkit-background-clip: text; background-clip:text; color: transparent;
  animation: opt-gradmove 6s linear infinite;
}

/* Unique (cyan sparkle) */
.inv-filter-sheet .opt-unique{ --c: var(--c-unique); }
.inv-filter-sheet .opt-unique span{ color: var(--c-unique); }
.inv-filter-sheet .opt-unique{ box-shadow: inset 0 0 0 1px rgba(0,192,255,.28); }

/* Exotic (teal pulse) */
.inv-filter-sheet .opt-exotic{ --c: var(--c-exotic); }
.inv-filter-sheet .opt-exotic span{ color: var(--c-exotic); }
.inv-filter-sheet .opt-exotic{ animation: opt-glow 2.8s ease-in-out infinite; }

/* Mythic (golden shine) */
.inv-filter-sheet .opt-mythic{ --c: var(--c-mythic);
  background-image: linear-gradient(90deg, rgba(255,255,255,.1), rgba(255,255,255,0) 40%, rgba(255,255,255,.1));
  background-size:200% 100%; animation: opt-shine 2.4s linear infinite;
  box-shadow: inset 0 0 0 1px rgba(255,212,0,.3);
}
.inv-filter-sheet .opt-mythic span{ color: var(--c-mythic); }

/* Crypto (animated border ring vibe) */
.inv-filter-sheet .opt-crypto{ --c: var(--c-crypto); position:relative; }
.inv-filter-sheet .opt-crypto span{
  background: linear-gradient(45deg,#ff4bd1,#ffd54b,#ff4bd1);
  background-size:200% 100%; -webkit-background-clip:text; background-clip:text; color:transparent;
  animation: opt-gradmove 4.5s linear infinite;
}
.inv-filter-sheet .opt-crypto::after{
  content:''; position:absolute; inset:-2px; border-radius:12px;
  padding:2px;
  background: conic-gradient(from 0deg,#ff4bd1,#ffd54b,#ff4bd1);
  -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor; mask-composite: exclude;
  animation: opt-rotate 6s linear infinite;
}

/* Pets */
.inv-filter-sheet .opt-pets{ --c: var(--c-pets); }
.inv-filter-sheet .opt-pets span{ color: var(--c-pets); }

/* Eggs */
.inv-filter-sheet .opt-eggs{ --c: var(--c-eggs); }
.inv-filter-sheet .opt-eggs span{ color: var(--c-eggs); }

/* Event (red pulse) */
.inv-filter-sheet .opt-event{ --c: var(--c-event); }
.inv-filter-sheet .opt-event span{ color: var(--c-event); }
.inv-filter-sheet .opt-event{ animation: opt-glow 1.8s ease-in-out infinite; }

/* === Remove Dodgers Event UI (button & overlay only) â€” keep items/data intact === */
.event-row{ display:none !important; }
#dodgerOverlay{ display:none !important; }

/* Red Pedestal cosmetic (applies to item pedestals only) */
body.red-pedestals .pedestal{
  background: linear-gradient(180deg,#ff5a5a,#8b0000) !important;
  box-shadow: inset 0 6px 0 rgba(255,255,255,.25), 0 10px 0 #710000, 0 14px 18px rgba(0,0,0,.45) !important;
}

/* Aqua Pedestal cosmetic (applies to item pedestals only) */
/* Ocean/Aqua wave look */
/* Ocean/Aqua wave look â€” distinct from Light/Dark Blue */
body.aqua-pedestals .pedestal{
  background:
    /* white foam arcs rising from the bottom */
    radial-gradient(60% 180% at 15% 120%, rgba(255,255,255,0.60) 12%, rgba(255,255,255,0) 13%),
    radial-gradient(60% 180% at 45% 120%, rgba(255,255,255,0.50) 12%, rgba(255,255,255,0) 13%),
    radial-gradient(60% 180% at 75% 120%, rgba(255,255,255,0.55) 12%, rgba(255,255,255,0) 13%),
    /* faint angled bands to suggest swell */
    repeating-linear-gradient(-12deg, rgba(255,255,255,0.18) 0 6px, rgba(255,255,255,0.00) 6px 26px),
    /* aqua gradient base with teal highlights */
    linear-gradient(180deg,#34d2e8 0%, #9be9ff 28%, #53bfff 60%, #0a4cbf 100%) !important;
  box-shadow: inset 0 6px 0 rgba(255,255,255,.28), 0 10px 0 #0a3a86, 0 14px 18px rgba(0,0,0,.35) !important;
}
/* Pedestal page tiles */
.ped-grid{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:18px;}
.ped-grid{margin-bottom:12px;}


/* Sandy Shores - applied to main pedestals (grain + tiny rocks) */
body.sandy-pedestals .pedestal{
  background:
    /* sand grain specks */
    radial-gradient(1.5px 1.5px at 10% 20%, rgba(140,110,60,0.20) 0 40%, transparent 45%) ,
    radial-gradient(1.2px 1.2px at 22% 38%, rgba(120,95,55,0.20) 0 40%, transparent 45%) ,
    radial-gradient(1.4px 1.4px at 35% 52%, rgba(150,120,75,0.20) 0 40%, transparent 45%) ,
    radial-gradient(1.2px 1.2px at 64% 28%, rgba(100,80,50,0.20) 0 40%, transparent 45%) ,
    radial-gradient(1.4px 1.4px at 74% 48%, rgba(130,100,60,0.20) 0 40%, transparent 45%) ,
    radial-gradient(1.3px 1.3px at 86% 36%, rgba(110,90,55,0.20) 0 40%, transparent 45%) ,
    /* tiny pebbles / small rocks */
    radial-gradient(10px 7px at 20% 78%, rgba(110,90,70,0.35) 0 60%, rgba(110,90,70,0.00) 65%) ,
    radial-gradient(8px 6px at 44% 74%, rgba(95,80,60,0.32) 0 60%, rgba(95,80,60,0.00) 65%) ,
    radial-gradient(9px 7px at 71% 82%, rgba(125,105,85,0.35) 0 60%, rgba(125,105,85,0.00) 65%) ,
    radial-gradient(7px 5px at 83% 70%, rgba(80,70,60,0.32) 0 60%, rgba(80,70,60,0.00) 65%) ,
    /* subtle dune wave */
    linear-gradient(6deg, rgba(255,255,255,0.10) 20%, rgba(255,255,255,0.00) 22% 78%, rgba(0,0,0,0.05) 80%) ,
    /* warm sand base */
    linear-gradient(180deg,#ffe6a1 0%, #ffd788 55%, #e6bb62 100%) !important;
  box-shadow: inset 0 6px 0 rgba(255,255,255,.28), 0 10px 0 #caa54a, 0 14px 18px rgba(0,0,0,.25) !important;
}


.ped-tile{height:120px;border-radius:18px;border:4px solid #111;display:flex;flex-direction:column;justify-content:flex-end;padding:12px;box-shadow:var(--shadow);position:relative;overflow:hidden;background:linear-gradient(180deg,#ffd24a,#b8860b);}
.ped-tile.locked::after{content:"LOCKED";position:absolute;inset:auto 0 0 0;background:rgba(0,0,0,.55);color:#fff;text-align:center;padding:6px 0;font-weight:900;}
.ped-apply{align-self:flex-end;margin-top:6px;}


/* === Crate open animation & reward toast === */
#crateAnim {
  position: fixed; inset: 0; display:flex; align-items:center; justify-content:center;
  z-index: 9999; pointer-events:none;
}
#crateAnim .burst {
  position: absolute; width: 220px; height: 220px; border-radius: 50%;
  background: radial-gradient(circle, rgba(255,255,255,.95), rgba(255,215,128,.6) 40%, rgba(255,140,0,.0) 60%);
  filter: blur(2px); opacity: 0;
  animation: burstFade .65s ease-out forwards;
}
#crateAnim .crate {
  width: 180px; height: 180px; opacity: 0; transform: scale(.7);
  animation: crateOpen .65s cubic-bezier(.2,.9,.3,1) forwards;
  image-rendering: -webkit-optimize-contrast;
  filter: drop-shadow(0 18px 40px rgba(0,0,0,.45));
}
#crateAnim .reward {
  display:flex; flex-direction:column; align-items:center; gap:10px;
  margin-top: 200px; opacity: 0; transform: translateY(40px) scale(.9);
  animation: rewardRise 1.2s .45s ease-out forwards;
  font-weight: 1000; font-size: 20px; color: #fff; text-shadow: 0 2px 0 rgba(0,0,0,.35);
}
#crateAnim .reward img { width: 110px; height:110px; filter: drop-shadow(0 12px 24px rgba(0,0,0,.4)); border-radius: 14px; }
#crateAnim.fade-out .reward { animation: flyAway .6s ease-in forwards; }
@keyframes crateOpen {
  0%{opacity:0; transform:scale(.7) rotate(0);}
  50%{opacity:1; transform:scale(1.06) rotate(-2deg);}
  100%{opacity:0; transform:scale(1.15) rotate(6deg);}
}
@keyframes burstFade {
  0%{opacity:0; transform:scale(.5);}
  40%{opacity:1; transform:scale(1.2);}
  100%{opacity:0; transform:scale(1.6);}
}
@keyframes rewardRise {
  0%{opacity:0; transform: translateY(40px) scale(.9);}
  50%{opacity:1; transform: translateY(-6px) scale(1.02);}
  100%{opacity:1; transform: translateY(0) scale(1);}
}
@keyframes flyAway {
  0%{opacity:1; transform: translateY(0) scale(1);}
  100%{opacity:0; transform: translateY(-140px) scale(.6);}
}


/* === FLEX PASS header: ocean-breeze animated text === */
#flexPassHeader h2,
#flexPassHeader .season{
  position: relative;
  color: transparent;
  -webkit-text-fill-color: transparent;
  background-image: linear-gradient(130deg, #b3e5ff, #4ec5ff 30%, #1a8cff 55%, #00d0ff 80%, #b3e5ff);
  background-size: 220% 220%;
  background-clip: text;
  -webkit-background-clip: text;
  animation: oceanFlow 6.5s ease-in-out infinite;
  text-shadow: 0 2px 0 rgba(0,0,0,.15);
}
#flexPassHeader h2::after,
#flexPassHeader .season::after{
  content: "";
  position: absolute; inset: 0;
  pointer-events: none;
  background: repeating-linear-gradient(-12deg, rgba(255,255,255,.18), rgba(255,255,255,.18) 4px, rgba(255,255,255,0) 10px);
  mix-blend-mode: screen;
  animation: breezeSlide 5.5s linear infinite;
  border-radius: .2em;
  -webkit-mask-image: linear-gradient(#000, #000);
          mask-image: linear-gradient(#000, #000);
}

#flexPassHeader h2{
  animation-name: oceanFlow, sway;
  animation-duration: 6.5s, 4.2s;
  animation-timing-function: ease-in-out, ease-in-out;
  animation-iteration-count: infinite, infinite;
}

@keyframes oceanFlow{
  0%{ background-position: 0% 50%; }
  50%{ background-position: 100% 50%; }
  100%{ background-position: 0% 50%; }
}
@keyframes breezeSlide{
  0%{ background-position: 0 0; }
  100%{ background-position: 320px 0; }
}
@keyframes sway{
  0%{ transform: translateY(0) rotate(0deg); }
  50%{ transform: translateY(-1px) rotate(-0.2deg); }
  100%{ transform: translateY(0) rotate(0.25deg); }
}


/* ==== Rising Tides XP Events (Top-Right HUD + Falling Items) ==== */
#rtxp-hud{
  position: fixed;
  top: 14px;
  right: 14px;
  z-index: 5000;
  background: rgba(20,24,34,.85);
  color: #fff;
  border: 1px solid rgba(255,255,255,.15);
  border-radius: 12px;
  padding: 10px 14px;
  font-family: 'Rajdhani', system-ui, sans-serif;
  font-weight: 700;
  display:none;
  box-shadow: 0 6px 24px rgba(0,0,0,.35);
  backdrop-filter: blur(6px);
}
#rtxp-hud .title{font-size:14px; opacity:.9; letter-spacing:.3px;}
#rtxp-hud .timer{font-size:18px; margin-top:2px;}
#rtxp-layer{
  position: fixed;
  inset: 0;
  pointer-events: none; /* clicks only on items */
  z-index: 4500;
  overflow: hidden;
}
.rtxp-item{
  position: absolute;
  top: -80px;
  width: 64px;
  height: 64px;
  pointer-events: auto;
  user-select: none;
  cursor: pointer;
  will-change: transform, top;
  image-rendering: auto;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
  transition: transform .08s ease;
}
.rtxp-item:active{ transform: scale(.92) rotate(-6deg); }
@keyframes rtxp-fall {
  from{ transform: translateY(-80px) rotate(0deg); }
  to  { transform: translateY(110vh) rotate(360deg); }
}


/* === Coastal: refined animation (no spinning aura) === */
.placed.coastal-waves::before,
.placed.coastal-waves::after{ content:none !important; }

.placed.coastal-waves{
  position: relative;
  transform-origin: 50% 95%;
  animation: coastalRock 3.6s ease-in-out infinite;
}

/* Subtle shimmer sweep across the whole item */
.placed.coastal-waves::after{
  content:"";
  position:absolute;
  inset:-4px;
  border-radius:16px;
  pointer-events:none;
  background: linear-gradient(120deg,
    rgba(255,255,255,0) 0%,
    rgba(255,255,255,0.20) 12%,
    rgba(104,182,255,0.25) 18%,
    rgba(255,255,255,0.18) 24%,
    rgba(255,255,255,0) 36%);
  background-size: 250% 100%;
  animation: coastalShine 5s linear infinite;
  mix-blend-mode: screen;
  opacity: .45;
}

@keyframes coastalRock{
  0% { transform: rotate(-1.2deg) translateY(0px); }
  50%{ transform: rotate(1.2deg)  translateY(1px); }
  100%{ transform: rotate(-1.2deg) translateY(0px); }
}
@keyframes coastalShine{
  0%{ background-position: -120% 0; }
  100%{ background-position: 220% 0; }
}


/* === Coastal fix: keep absolute positioning; gentle rock only (no translate) === */
.placed.coastal-waves{ 
  position: absolute !important; /* ensure same placement as other rarities */
  transform-origin: 50% 60%;
  animation: coastalRock 4.2s ease-in-out infinite;
  will-change: transform;
}
@keyframes coastalRock{
  0% { transform: rotate(-1deg); }
  50%{ transform: rotate(1deg);  }
  100%{ transform: rotate(-1deg); }
}

/* Reduce shimmer to stay within bounds */
.placed.coastal-waves::after{
  inset:0; /* no outward expansion */
  border-radius: 14px;
  opacity:.35;
}

/* === Coastal gradient background under transparent sprite === */
.placed.coastal-waves .img-wrap{ 
  position: relative; 
  border-radius: 14px;
  overflow: hidden; /* clip gradient to icon shape */
}
.placed.coastal-waves .img-wrap::before{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(180deg, #eaf6ff 0%, #bfe2ff 50%, #68b6ff 100%);
  opacity: 0.9;
  z-index: 0;
}
.placed.coastal-waves .img-wrap > img{
  position: relative;
  z-index: 1;
}


/* === Coastal: full-frame gradient background === */
.placed.coastal-waves{
  overflow: hidden;               /* clip gradient to the frame */
  position: absolute !important;  /* keep original layout */
}
.placed.coastal-waves::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius: inherit;
  background: linear-gradient(180deg, #eaf6ff 0%, #bfe2ff 50%, #68b6ff 100%);
  z-index: 0;
  pointer-events: none;
}
/* Make sure shimmer stays above, but still non-interactive */
.placed.coastal-waves::after{
  z-index: 1;
  pointer-events: none;
}
/* Lift children above the gradient base */
.placed.coastal-waves > *{
  position: relative;
  z-index: 2;
}

/* Remove earlier icon-only gradient so the full-frame one is used */
.placed.coastal-waves .img-wrap::before{ content:none !important; }


/* === Brewer Recipes: keep inside panel, add scrolling; hide durations; better visibility === */
#brewOverlay .panel{ position:fixed; } /* ensure positioned ancestor exists */
#brewOverlay .panel .brew-recipes{
  position: absolute !important;
  left: 22px !important;
  top: 74px !important;    /* sit nicely below the centered title */
  bottom: 22px !important; /* stop at bottom of the panel */
  width: var(--recipesW) !important;
  height: auto !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  padding-right: 8px !important;
  display: grid !important;
  grid-template-columns: 1fr !important;
  gap: 12px !important;
}

/* Switch to two columns automatically when the panel gives us more width */
@media (min-width: 980px){
  #brewOverlay .panel .brew-recipes{ grid-template-columns: 1fr 1fr !important; }
}

/* Hide duration lines on cards */
#brewOverlay .panel .recipe-note{ display: none !important; }

/* Make recipe names easier to read */
#brewOverlay .panel .recipe-name{
  color: #000 !important;
  text-shadow: none !important;
  -webkit-text-stroke: 0 !important;
}

/* Keep recipe list title readable and pinned at top of the scroll container */
#brewOverlay .panel .recipes-title{
  position: sticky; top: 0; z-index: 2;
  padding-top: 2px; padding-bottom: 8px;
  background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.75));
  color: #111 !important;
  border-radius: 12px;
}
</style>

    <!-- Disable Winter Gifts and Stranger Things events -->
    <style id="disable-events">
      /* Hide event buttons and overlays to turn off Winter Gifts and Stranger Things events */
      #openWinterGifts,
      .icon-winter,
      #winterOverlay,
      #giftOpenOverlay,
      #blizzard,
      .snowflake,
      #openStranger,
      .icon-stranger,
      #strangerOverlay,
      #strangerReveal {
        display: none !important;
      }
    </style>
<style>
/* === Cosmic Event (Limited Time) === */
.icon-cosmic{ background: radial-gradient(circle at 30% 30%, #1a2a6c, #000428); position:relative; }
.icon-cosmic::after{
  content:""; position:absolute; inset:0; border-radius:20px; pointer-events:auto;
  background: radial-gradient(2px 2px at 25% 35%, #ffd84a 0 60%, transparent 60%),
              radial-gradient(2.5px 2.5px at 68% 22%, #8fd3ff 0 60%, transparent 60%),
              radial-gradient(1.6px 1.6px at 70% 64%, #ffd84a 0 60%, transparent 60%),
              radial-gradient(1.8px 1.8px at 44% 76%, #8fd3ff 0 60%, transparent 60%);
  animation: cosmicBtnSparkle 3.5s linear infinite;
}
@keyframes cosmicBtnSparkle {
  0% { opacity: .7; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.02); }
  100% { opacity: .7; transform: scale(1); }
}

/* Event Sheet */
#cosmicOverlay .sheet{ background: radial-gradient(1200px 600px at 50% -200px, #0b1a35, #151823) #151823;
  color:#e6f3ff; border-color:#0b0f1a; }
#cosmicOverlay h2{ color:#7fd0ff; text-shadow:0 2px 0 rgba(0,0,0,.6); }
.cosmic-grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }
.cosmic-card{ background:#1f2433; border-radius:22px; border:4px solid #0d1222; padding:18px; min-height:170px;
  box-shadow: 0 12px 28px rgba(0,0,0,.45) }
.cosmic-card h3{ margin:0; font-family:"Russo One"; color:#d7ecff; }
.cosmic-desc{ opacity:.9; font-size:18px; }
.cosmic-price{ font-weight:900; font-size:20px; }
.cosmic-buy{ align-self:flex-end; padding:10px 16px; font-weight:900; border:none; border-radius:14px; cursor:pointer;
  background:linear-gradient(#59a7ff,#2973e3); color:#fff; }
.cosmic-badge{ font-family:"Bungee"; letter-spacing:1px; font-size:24px; -webkit-text-stroke:2px #000; }

/* Cosmic rarity label + sparkle */
.t-cosmic{
  color:#8fd0ff;
  text-shadow:0 0 8px rgba(0,180,255,.65), 0 0 16px rgba(0,120,255,.4);
  position:relative; font-weight:900;
}
.t-cosmic::after{
  content:""; position:absolute; left:-6px; top:-6px; right:-6px; bottom:-6px; pointer-events:auto;
  background: radial-gradient(1.5px 1.5px at 12% 30%, #ffd84a 0 60%, transparent 61%),
              radial-gradient(1.2px 1.2px at 72% 20%, #ffd84a 0 60%, transparent 61%),
              radial-gradient(1.8px 1.8px at 30% 78%, #ffd84a 0 60%, transparent 61%),
              radial-gradient(1.6px 1.6px at 86% 62%, #ffd84a 0 60%, transparent 61%);
  animation: cosmicSparkle 2.2s linear infinite;
}
@keyframes cosmicSparkle{
  0%{ background-position: 0 0, 0 0, 0 0, 0 0; opacity:.8; }
  50%{ background-position: 6px 6px, -4px 3px, 2px -5px, -6px -2px; opacity:1; }
  100%{ background-position: 0 0, 0 0, 0 0, 0 0; opacity:.8; }
}

/* Pull-up reward animation */
.cosmic-reveal{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1000;
  background: radial-gradient(800px 400px at 50% 50%, rgba(15,22,40,.86), rgba(0,0,0,.85));
}
.cosmic-reveal.show{ display:flex; }
.cosmic-reveal .card{
  background:#0e1628; border:5px solid #0a0f1a; border-radius:24px; padding:22px; text-align:center; color:#e6f3ff;
  box-shadow:0 0 80px rgba(80,180,255,.28), 0 20px 60px rgba(0,0,0,.65);
  animation: popin .25s ease-out;
}
@keyframes popin{ from{ transform: scale(.8); opacity:0; } to{ transform: scale(1); opacity:1; } }
.cosmic-reveal img{ width:110px; height:110px; border-radius:16px; display:block; margin:8px auto; }

/* Background: Space View */
body.bg-spaceview{background:url('space_view_files/space_view.png') center center / cover no-repeat fixed !important;}
body.bg-spaceview::before{
  content:""; position:fixed; inset:0; z-index:-2; background:#04060c;
  background-image:
    radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.9) 0 60%, transparent 61%),
    radial-gradient(1px 1px at 30% 80%, rgba(255,255,255,.8) 0 60%, transparent 61%),
    radial-gradient(2px 2px at 70% 10%, rgba(255,255,255,.9) 0 60%, transparent 61%),
    radial-gradient(1px 1px at 80% 70%, rgba(255,255,255,.9) 0 60%, transparent 61%);
  animation: starDrift 24s linear infinite;
}
@keyframes starDrift { 0%{ background-position: 0 0, 0 0, 0 0, 0 0; } 100%{ background-position: -500px 240px, -200px 160px, -600px 400px, -300px 260px; } }
</style>
<style>
/* === LA Dodgers Event === */

/* Improved icon rendering via CSS var (works even if <img> fails) */
.icon-dodger{ 
  background:linear-gradient(180deg, #ffffff 0%, #dff1ff 35%, #9fd5ff 100%); position:relative; overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  box-shadow: inset 0 0 0 2px #cfe9ff, 0 6px 16px rgba(0,84,164,.15);
}
.icon-dodger::after{
  content: ""; position:absolute; inset:14%; border-radius:12px;
  background: var(--dodger-icon, none) center/contain no-repeat;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.4));
}
.icon-dodger .fallback-text{
  font-family:"Bungee", system-ui; font-weight:900; font-size:22px; letter-spacing:1px;
  color:#0a5aa8; text-shadow:0 2px 0 rgba(255,255,255,.7);
}
#dodgerShopLogo{ width: 140px; height: 100px; object-fit: contain; }
#dodgerShopLogo.fallback{
  display:grid; place-items:center; background:linear-gradient(180deg,#ffffff,#e6f4ff); color:#0a5aa8; font-weight:900; 
  width: 140px; height: 100px; border-radius:14px; box-shadow: inset 0 0 0 2px #cfe9ff;
}

.icon-dodger{ background:#0b2e6e; position:relative; overflow:hidden; }
.icon-dodger img{ width:64%; height:64%; object-fit:contain; image-rendering:auto; filter:drop-shadow(0 2px 6px rgba(0,0,0,.4)); }

#dodgerOverlay .sheet{ background: radial-gradient(1200px 600px at 50% -200px,#ffffff,#e9f5ff 45%,#cfe9ff 75%); color:#0d2640; border-color:#d2ebff; }
#dodgerOverlay h2{ color:#0b74ff; text-shadow:0 1px 0 rgba(255,255,255,.9); }
.dodger-grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }
.dodger-card{ background:rgba(255,255,255,.96); border-radius:22px; border:3px solid #d8ecff; padding:18px; min-height:170px; box-shadow:0 12px 28px rgba(0,84,164,.12); }
.dodger-card h3{ margin:0; font-family:"Russo One"; color:#0d3b66; }
.dodger-desc{ opacity:.9; font-size:18px; color:#123b5f; }
.dodger-price{ font-weight:900; font-size:20px; }
.dodger-buy{ align-self:flex-end; padding:10px 16px; font-weight:900; border:none; border-radius:14px; cursor:pointer; background:linear-gradient(#a6d9ff,#65b9ff); color:#093054; }


/* === Coastal rarity: blue/white with wave + shimmering blue === */
.t-coastal{
  background: linear-gradient(90deg,#eaf6ff,#68b6ff,#eaf6ff);
  background-size: 200% auto;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  animation: coastalShimmer 3s linear infinite;
  font-weight: 900;
  position: relative;
}
@keyframes coastalShimmer{
  0%{ background-position: 0% 50%; }
  100%{ background-position: 200% 50%; }
}

/* Wave aura around placed coastal items */
.placed.coastal-waves::before,
.placed.coastal-waves::after{
  content:"";
  position:absolute;
  inset:-6px;
  border-radius:16px;
  pointer-events:none;
  background: conic-gradient(
    from 0deg,
    rgba(255,255,255,0) 0% 18%,
    rgba(255,255,255,.50) 26%,
    rgba(30,144,255,.55) 38%,
    rgba(255,255,255,.35) 52%,
    rgba(255,255,255,0) 66%
  );
  animation: coastalSpin 4s linear infinite;
  mix-blend-mode: screen;
}
.placed.coastal-waves::after{
  filter: blur(6px);
  animation-duration: 6s;
  opacity: .75;
}
@keyframes coastalSpin{ to { transform: rotate(360deg);} }

/* Dodger rarity label */
.t-dodger{
  color:#0b74ff;
  text-shadow:0 0 10px rgba(255,255,255,.9), 0 0 18px rgba(11,116,255,.55);
  position:relative; font-weight:900;
}

/* Blue & white animated waves around the placed item when rarity=DODGER */
.placed.dodger-waves::before,
.placed.dodger-waves::after{
  content:""; position:absolute; inset:-6px; border-radius:16px; pointer-events:auto;
  background: conic-gradient(from 0deg, rgba(255,255,255,0), rgba(255,255,255,.35) 15%, rgba(30,144,255,.55) 30%, rgba(255,255,255,.35) 45%, rgba(255,255,255,0) 60%);
  animation:dodgerSpin 3.2s linear infinite; mix-blend-mode: screen;
}
.placed.dodger-waves::after{ filter: blur(4px); animation-duration:5s; opacity:.6; }
@keyframes dodgerSpin{ to{ transform: rotate(360deg); } }

/* Background: Dodger Stadium Style */
body.bg-dodger{ background:url('la_dodgers_style_files/la_dodgers_style.png') center center / cover no-repeat fixed !important; }

/* Background: Sunrise (redeemable) */
body.bg-sunrise{
  background: url('background_files/sunrise_style.png') center center / cover no-repeat fixed !important;
}

/* Background: The Great Wave (redeemable) */
body.bg-greatwave{
  background: url('background_files/the_great_wave.png') center center / cover no-repeat fixed !important;
}
</style>
<style>
/* === Backgrounds overlay: scrollable grid === */
#bgOverlay .sheet{
  max-height: min(92vh, 860px);
  display: flex;
  flex-direction: column;
  overflow: visible; /* cap the dialog; inner grid will scroll */
}
#bgOverlay h2{ margin: 0 0 12px 0; }
#bgOverlay #bgGrid{
  flex: 1 1 auto;
  min-height: 0;
  overflow-y: auto;
  padding-right: 6px;   /* avoid content under scrollbar */
  scroll-behavior: smooth;
}

/* Optional: subtle custom scrollbar */
#bgOverlay #bgGrid::-webkit-scrollbar{ width: 10px; }
#bgOverlay #bgGrid::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.15); border-radius: 8px; }
#bgOverlay #bgGrid::-webkit-scrollbar-track{ background: transparent; }

@media (max-width: 800px){
  #bgOverlay .sheet{ max-height: min(92vh, 720px); }
}
</style>
<style id="no-scroll-patch">
  /* Lock the main page from scrolling; overlays handle their own internal scroll */
  html, body { overflow: hidden !important; height: 100%; }
</style>
<style id="event-row-style">
  .event-row{
    position: fixed;
    top: 16px;
    left: 16px;
    display: flex;
    gap: 12px;
    z-index: 9;
  }
  .event-row .icon-btn{
    width: 72px;
    height: 72px;
    border-radius: 16px;
  }
  .event-row .icon-btn svg{
    width: 60%;
    height: 60%;
  }
  @media (max-width: 800px){
    .event-row{ top: 12px; left: 12px; gap: 10px; }
    .event-row .icon-btn{ width: 64px; height: 64px; }
  }
</style>
<style id="no-scroll-patch">
  /* Restore scrolling for the whole page */
  html, body { 
    overflow-y: auto !important; 
    overflow-x: hidden; 
    height: auto !important; 
  }
  body { min-height: 100%; }
</style>
<style>
/* === CRYPTO rarity === */
.t-crypto{
  background: linear-gradient(90deg, #ff62d5, #ffd84a, #ff62d5);
  background-size: 200% auto;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  font-weight: 900;
  animation: cryptoShimmer 2.5s linear infinite;
}
@keyframes cryptoShift {
  0%   { background-position: 0% 50%;   letter-spacing: 1px; }
  50%  { background-position: 100% 50%; letter-spacing: 3px; }
  100% { background-position: 0% 50%;   letter-spacing: 1px; }
}
/* Glow on placed container when CRYPTO is present */
.crypto-glow{
  filter: drop-shadow(0 0 10px rgba(255,120,220,.85))
          drop-shadow(0 0 18px rgba(255,216,74,.6));
}
</style>
<style>
/* === Crypto Ring Animation (no letter movement) === */
@keyframes cryptoShimmer {
  0%   { background-position: 0% 50%; }
  50%  { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

@keyframes cryptoRingSpin {
  to { transform: rotate(360deg); }
}

.img-wrap{
  position: relative;
  display: inline-block;
  line-height: 0; /* eliminate inline gaps */
}

.img-wrap > img{
  display: block;
}

.img-wrap .crypto-ring{
  position: absolute;
  inset: -6px;           /* ring slightly outside the image bounds */
  border-radius: 50%;
  pointer-events: none;
  /* Create a donut ring using mask */
  --ring: 4px;
  background: conic-gradient(from 0deg, #ff62d5, #ffd84a, #ff62d5);
  -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - var(--ring)), #000 calc(100% - var(--ring)));
  mask: radial-gradient(farthest-side, transparent calc(100% - var(--ring)), #000 calc(100% - var(--ring)));
  animation: cryptoRingSpin 2.4s linear infinite;
  filter: drop-shadow(0 0 8px rgba(255,98,213,.45)) drop-shadow(0 0 10px rgba(255,216,74,.35));
}
</style>
<style>
/* Disable pedestal forge buttons entirely */
#exoticForgeBtn, #cryptoForgeBtn, #mythicForgeBtn {
  display: none !important;
  visibility: hidden !important;
  pointer-events: none !important;
}
</style>
<!-- Stranger Things Event styles -->
<style>
.icon-stranger{
  position:relative;
  width:64px;height:64px;
  border-radius:18px;
  background:#0b0b0b;
  box-shadow:0 6px 16px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.06);
  overflow:hidden;
}
.icon-stranger::after{
  content:"";
  position:absolute; inset:14%;
  background: var(--stranger-icon) center/contain no-repeat;
  filter: drop-shadow(0 6px 14px rgba(0,0,0,.35));
  border-radius:14px;
}
.icon-stranger .fallback-text{
  position:absolute; inset:0; display:grid; place-items:center;
  font-family:'Bungee', system-ui, sans-serif; font-weight:900;
  color:#d21d1d; letter-spacing:1px;
}
#strangerOverlay .sheet{
  width:min(980px, 92vw);
  background: radial-gradient(1200px 600px at 50% -10%, #5b0f12 0%, #2b0a0b 46%, #160507 100%);
  border:4px solid #111; border-radius:22px;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
  color:#fff;
}
#strangerTitle{
  font-family:'Bungee', system-ui, sans-serif;
  text-align:center;
  color:#ffd200;
  text-shadow:0 4px 0 #5c0d0d, 0 10px 35px rgba(255,215,0,.25);
  letter-spacing:2px;
}
.stranger-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:18px; padding:6px 16px 16px; }
@media (max-width:860px){ .stranger-grid{ grid-template-columns:1fr; } }
.stranger-card{
  display:flex; flex-direction:column; gap:8px; padding:16px;
  background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.35));
  border:2px solid rgba(255,255,255,.06); border-radius:16px;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}
.stranger-desc{ font-weight:800; opacity:.9; line-height:1.2; }
.stranger-price{ font-weight:900; color:#ffd84a; text-shadow:0 2px 0 rgba(0,0,0,.35); }
.stranger-buy{ padding:9px 14px; font-weight:900; border-radius:12px; border:none; cursor:pointer;
  background:linear-gradient(180deg,#ffa600,#ff6a00); color:#111; box-shadow:0 6px 18px rgba(255,165,0,.25);
}
#strangerShopLogo{ height:120px; filter: drop-shadow(0 8px 30px rgba(255,216,74,.35)); opacity:.96; }
.rar.t-demon{
  background:linear-gradient(45deg,#ff2b2b,#ff7a7a);
  color:#300; border:2px solid rgba(255,255,255,.25); box-shadow:0 3px 10px rgba(255,0,0,.25);
}
.demonized{ animation: demonBeat 1.25s infinite; }
@keyframes demonBeat{
  0%{ transform:scale(1); box-shadow:0 0 0 0 rgba(255,0,0,.35); }
  50%{ transform:scale(1.045); box-shadow:0 0 24px 12px rgba(255,0,0,.20); }
  100%{ transform:scale(1); box-shadow:0 0 0 0 rgba(255,0,0,.35); }
}
.cosmic-reveal#strangerReveal .card{ background:#1a0a0c; border-color:#0f0405; }

/* Toolbar behind-overlay blur fix: drop below overlay so it dims/blur like the others */
#toolBarArea{ z-index: 8 !important; }
</style>
<!-- override: enlarge Stranger Things icon on button -->
<style>
  .icon-stranger::after{ inset:6% !important; }
</style>
<!-- override: max-size Stranger Things icon and hide fallback text -->
<style>
  /* Fill the button with the icon artwork */
  .icon-stranger::after{ inset:0% !important; }
  /* Remove the 'ST' letters behind the icon */
  .icon-stranger .fallback-text{ display:none !important; }
</style>
<!-- v112 demon-persist patch: include `demon` in save() for inventory and placed items -->
<style>
/* === Side tabs (Backgrounds / Pedestals) === */
#bgOverlay .sheet{ position: relative; overflow: visible; }
#bgOverlay .bg-side-tabs{
  position: absolute;
  right: -132px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 20;
}
#bgOverlay .bg-tab{
  font-family: 'Bungee', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji';
  letter-spacing: 1px;
  font-size: 18px;
  padding: 12px 18px;
  border-radius: 16px;
  border: 4px solid var(--ui-blue-dark);
  background: #f5f8fe;
  color: #0c3556;
  box-shadow: 0 3px 0 rgba(0,0,0,.35), 0 6px 14px rgba(0,0,0,.15);
  text-shadow: none;
  user-select: none;
}
#bgOverlay .bg-tab.active{
  background: linear-gradient(to bottom, var(--ui-blue) 0%, #2f8de6 100%);
  color:#fff;
  border-color:#1a5fbf;
}
#bgOverlay .bg-tab:focus{ outline: none; }
#bgOverlay .bg-tab:active{ transform: translateY(1px); }
#bgOverlay .pedestal-page{ flex:1 1 auto; min-height:0; overflow-y:auto; padding-right:6px; scroll-behavior:smooth; padding-bottom:12px; }
@media (max-width: 980px){
  #bgOverlay .bg-side-tabs{
    position: absolute;
    right: 12px;
    top: 72px;
    transform: none;
    display: flex;
    flex-direction: column;
    gap: 12px;
    z-index: 20;
  }
  #bgOverlay .bg-tab{ font-size: 16px; padding: 10px 14px; }
}
</style>
<style id="bg-tabs-connected-override">
/* Connect Backgrounds/Pedestals tabs to the overlay sheet so they track it */
#bgOverlay .sheet{ overflow: visible !important; position: relative; }
#bgOverlay .bg-side-tabs{
  position: absolute !important;
  right: -132px !important;  /* hang just outside the sheet edge */
  top: 50% !important;
  transform: translateY(-50%) !important;
  display: flex; flex-direction: column; gap: 12px;
  z-index: 20;
}
@media (max-width: 980px){
  #bgOverlay .bg-side-tabs{
    position: absolute !important;
    right: 12px !important;    /* tuck inside on small screens so it's always visible */
    top: 72px !important;
    transform: none !important;
  }
}
</style>
<style id="bg-tabs-under-title-override">
/* Place Backgrounds / Pedestals buttons under the title on the left */
#bgOverlay .sheet { position: relative; overflow: visible; }
#bgOverlay h2#bgTitle { text-align: left; }
#bgOverlay .bg-side-tabs{
  position: static !important;
  right: auto !important;
  top: auto !important;
  transform: none !important;
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  justify-content: flex-start !important;
  gap: 10px !important;
  margin: 0 0 12px 0 !important; /* sit directly under the title */
  z-index: 1 !important;
}
#bgOverlay .bg-tab{
  font-size: 16px !important;
  padding: 10px 14px !important;
  border-radius: 14px !important;
}
/* Ensure the grid doesn't get overlapped by the buttons */
#bgOverlay .bg-grid{ margin-top: 0 !important; }
/* Mobile: keep same layout; buttons wrap nicely if needed */
@media (max-width: 600px){
  #bgOverlay .bg-side-tabs{ flex-wrap: wrap !important; gap: 8px !important; }
  #bgOverlay .bg-tab{ font-size: 15px !important; padding: 9px 12px !important; }
}
</style>
<style>
/* === Upside Down mode styles === */
body.upside-down .icon-btn,
body.upside-down .right-rail button,
body.upside-down #toolBarArea button,
body.upside-down #invFilterToggle{
  background: #0b0b0b !important;
  border-color: #0b0b0b !important;
  filter: none !important;
}
body.upside-down .icon-btn svg,
body.upside-down .right-rail button svg,
body.upside-down #invFilterToggle svg{
  stroke: #e40000 !important;
  color: #e40000 !important;
}
/* timer badge (top-right) */
#udTimerBadge{
  position: fixed; right: 32px; top: 18px; z-index: 9999;
  background: #0b0b0b; color:#ff3b3b; font-family: 'Bungee', system-ui, sans-serif;
  font-size: 28px; padding: 8px 16px; border-radius: 24px; 
  border: 4px solid rgba(255,0,0,.6); box-shadow: 0 6px 24px rgba(0,0,0,.5);
  display:none;
}
/* portal spinner overlay */
#udSpinOverlay{
  position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); z-index:9998;
}
#udSpinOverlay .spinner{
  width:120px;height:120px;border-radius:50%;
  border:10px solid rgba(255,0,0,.2); border-top-color:#ff3b3b; animation: udspin 1.1s linear infinite;
}
@keyframes udspin{ to{ transform: rotate(360deg); } }

/* Stranger Quests tab UI */
#strangerSideTabs{
  position: absolute; right: 20px; top: 70px; z-index: 2; display:flex; flex-direction:column; gap:10px;
}
#strangerSideTabs .st-tab{
  font-family:'Bungee', system-ui; letter-spacing:1px; font-weight:700;
  font-size:20px; padding: 12px 18px; border-radius: 16px;
  border:4px solid #1a5fbf; background:#f5f8fe; color:#0c3556; cursor:pointer;
  box-shadow: 0 3px 0 rgba(0,0,0,.35), 0 6px 14px rgba(0,0,0,.15);
}
#strangerSideTabs .st-tab.active{ background:linear-gradient(to bottom, var(--ui-blue) 0%, #2f8de6 100%); color:#fff; }

#strangerShopPage{}
#strangerQuestsPage{ display:none; position: relative; }

/* Save Hawkins layout */
.save-hawkins-title{
  text-align:center; font-family:'Bungee'; font-size:42px; color:#ffcb31; text-shadow: 0 4px 0 #630; letter-spacing:2px;
  margin: 8px 0 8px 0;
}
.ud-quest-wrap{
  display:flex; gap:24px; align-items:flex-start; justify-content:center; flex-wrap:wrap;
}
.ud-quest-box{
  width: min(420px, 90vw);
  background:#2b2b31; color:#f1f1f5; border-radius:18px; border:4px solid rgba(0,0,0,.45);
  padding:18px; box-shadow: var(--shadow);
}
.ud-quest-box h4{ margin:0 0 8px 0; font-size:22px; }
.ud-q{ display:flex; align-items:center; gap:12px; font-weight:900; margin:10px 0; }
.ud-q .check{ width:24px;height:24px; border-radius:6px; border:3px solid #888; display:grid;place-items:center; }
.ud-q.done .check{ background:#16c47f; border-color:#16c47f; color:#000; }
.ud-q .meta{ opacity:.85; font-weight:700; font-size:14px; }

.ud-portal{
  position:relative; width:min(560px, 92vw); height:280px; border-radius:22px;
  background:linear-gradient(135deg,#1a1a1a,#0b0b0b); border:6px solid #3b0406; box-shadow: inset 0 0 0 3px rgba(255,0,0,.15), 0 18px 40px rgba(0,0,0,.5);
  overflow:hidden; display:grid; place-items:center;
}
#enterUpsideDownBtn, #udPortalNote{ position:relative; z-index:2; display:inline-block; }

.ud-portal .stack{ filter: brightness(1.15); opacity:0.95;
  position:absolute; width:80%; height:80%; border-radius:16px; background: linear-gradient(145deg,#1f1f1f,#262626); left:10%; top:10%;
  transform: rotate(-8deg); box-shadow: 0 10px 30px rgba(0,0,0,.5);
 z-index:0; }
.ud-portal .stack:nth-child(2){ transform: rotate(-2deg); left:12%; top:12%; }
.ud-portal .stack:nth-child(3){ transform: rotate(6deg); left:14%; top:14%; }
#enterUpsideDownBtn{
  font-family:'Bungee'; font-size:22px; letter-spacing:1px;
  background:#ff5132; color:#000; border:4px solid #2b0707; border-radius:16px; padding:14px 22px; cursor:pointer;
  box-shadow:0 6px 0 #8c190f, 0 12px 22px rgba(0,0,0,.45);
}
#enterUpsideDownBtn:disabled{ filter: grayscale(1) brightness(.7); cursor:not-allowed; }
.ud-note{ margin-top:12px; font-weight:900; color:#ffd86a; text-align:center; }

/* Align Enter button to the right within the portal stack (visual nudge) */
.ud-portal{ place-items:center; justify-items:center; }
@media (max-width: 979px){
  .ud-portal{ place-items:center; } /* fallback on mobile */
}

/* Stranger side tabs: red/black theme */
#strangerSideTabs .st-tab{
  border-color:#550a0c !important;
  background:#0b0b0b !important;
  color:#ffdfdf !important;
  text-shadow:none !important;
}
#strangerSideTabs .st-tab.active{
  background: linear-gradient(180deg, #ff5842, #c12c1e) !important;
  color:#111 !important;
  border-color:#7a0f12 !important;
}

/* Save Hawkins page gradient background */
#strangerOverlay .sheet{
  background: linear-gradient(180deg, #ff5b5b, #7a0f12) !important;
}

/* Desktop placement: QUESTS LEFT, PORTAL RIGHT (fits 1000px sheet) */
@media (min-width: 980px){
  .ud-quest-wrap{
    display:grid !important;
    grid-template-columns: minmax(360px, 44%) minmax(420px, 1fr) !important;
    align-items:start !important;
    gap: 24px !important;
  }
  .ud-quest-box{ order: 1 !important; width:auto !important; justify-self:start !important; }
  .ud-portal{ order: 2 !important; width:100% !important; justify-self:end !important; }
}

/* Position Shop/Quests buttons next to the titles (top-right) */
#strangerSideTabs{
  position: absolute !important;
  top: 12px !important;
  right: 16px !important;
  flex-direction: column !important;
  gap: 10px !important;
  z-index: 30 !important;
}
@media (max-width: 980px){
  #strangerSideTabs{ top: 52px !important; right: 12px !important; }
}

/* Default, unchangeable background while in the Upside Down */
body.ud-default-bg{
  background: url('background_files/upside_down_default.png') center center / cover no-repeat fixed !important;
}
/* Disable the background selector button while in Upside Down */
body.upside-down #openBgSelector{
  pointer-events: none !important;
  filter: grayscale(1) brightness(.7) !important;
  opacity: .6 !important;
}

/* Yellow hanging tendrils around the portal */
.ud-portal .hangs{ position:absolute; inset:-8px; pointer-events:none; }
.ud-portal .hang{ position:absolute; width:6px; height:34px; background:linear-gradient(#ffd86a,#ffb200); border-radius:3px; box-shadow: 0 4px 6px rgba(0,0,0,.35); transform-origin:top center; opacity:0.85; }
.ud-portal .hang::after{ content:''; position:absolute; left:50%; top:30px; transform:translateX(-50%); width:10px; height:10px; border-radius:50%; background:#ffd86a; box-shadow:0 2px 6px rgba(0,0,0,.4); }
@keyframes sway{ 0%{ transform:rotate(-2deg);} 50%{transform:rotate(2deg);} 100%{ transform:rotate(-2deg);} }
.ud-portal .hang{ animation:sway 4s ease-in-out infinite; }

/* Hard center alignment for the Enter button within the portal */
.ud-portal{ display:grid !important; place-items:center !important; }
#enterUpsideDownBtn{ margin:0 auto !important; }

/* Place Stranger SHOP / QUESTS tabs under the title on the left (like Backgrounds) */
#strangerOverlay .sheet { position: relative; }
#strangerSideTabs{
  position: static !important;
  display: flex !important;
  flex-direction: row !important;
  gap: 12px !important;
  margin: 0 0 12px 0 !important;
}
#strangerSideTabs .st-tab{ min-width: 140px; text-align:center; }
@media (max-width: 820px){
  #strangerSideTabs{ flex-wrap: wrap; gap: 10px; }
}

/* Flip animation when entering the Upside Down: 0 -> 180 -> 360 */
@keyframes udFlip {
  0%   { transform: rotate(0deg); }
  50%  { transform: rotate(180deg); }
  100% { transform: rotate(360deg); }
}
body.ud-flip {
  animation: udFlip 900ms ease-in-out;
  transform-origin: 50% 50%;
}
</style>
<style>
body.bg-upsidedown{
  background: url('background_files/stranger_things_quests_style.png') center center / cover no-repeat fixed !important;
}
</style>
<!-- Inventory Redesign Override -->
<style id="inventory-redesign">
  /* --- Glassy, see-through inventory bar --- */
  .inventory-wrap{
    /* keep position from existing, we only nudge visuals if needed */
    padding-bottom: 0;
  }
  .inventory{
    background: linear-gradient(180deg, rgba(120, 226, 220, .45), rgba(100, 208, 206, .40));
    backdrop-filter: blur(12px) saturate(120%);
    -webkit-backdrop-filter: blur(12px) saturate(120%);
    border-radius: 28px;
    border: 6px solid #22272b;
    box-shadow:
      inset 0 6px 0 rgba(255,255,255,.35),
      inset 0 -8px 0 rgba(0,0,0,.20),
      0 14px 30px rgba(0,0,0,.45);
  }
  /* --- 3D inventory slots resembling the reference --- */
  .slot{
    min-width: 128px;
    height: 106px;
    border-radius: 22px;
    position: relative;
    cursor: pointer;
    background:
      linear-gradient(180deg, #aeb3b8 5%, #9ba0a6 45%, #8c9197 100%) padding-box,
      linear-gradient(#272b30, #272b30) border-box;
    border: 6px solid transparent; /* border rendered by the second gradient */
    box-shadow:
      inset 0 7px 0 rgba(255,255,255,.38),   /* top bevel */
      inset 0 -10px 0 rgba(0,0,0,.22),      /* bottom bevel */
      0 6px 0 #1b1e22,                       /* base ledge */
      0 12px 16px rgba(0,0,0,.45);           /* soft drop */
  }
  /* deeper drop shadow behind each slot */
  .slot::after{
    content:"";
    position:absolute;
    left:0; right:0; bottom:-10px; top:auto;
    height: 12px;
    border-radius: 18px;
    background: rgba(0,0,0,.65);
    filter: blur(4px);
    opacity:.75;
    z-index:-1;
  }
  /* inner rim highlight */
  .slot::before{
    content:"";
    position:absolute;
    inset: 3px;
    border-radius: 16px;
    box-shadow:
      inset 0 3px 0 rgba(255,255,255,.35),
      inset 0 -4px 0 rgba(0,0,0,.18);
    pointer-events:none;
  }
  .slot img{ width:72px; height:72px; border-radius:12px; }
  .slot.is-pet { height: 126px; }
  .slot.is-pet img { width: 96px; height: 96px; }

  /* selection state unchanged but make sure it sits above bevels */
  .slot.selected{ outline:6px solid var(--ui-blue); outline-offset:2px; }

  /* tighter spacing like the screenshot */
  .inventory{ gap: 24px; }
</style>
<style id="inventory-hover-pop">/* === Inventory: extra subtle hover "pop" effect === */
.inventory .slot{
  transition: transform 120ms cubic-bezier(.2,.8,.2,1), box-shadow 120ms cubic-bezier(.2,.8,.2,1);
  transform-origin: center;
  will-change: transform;
}
.inventory .slot:hover{
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 6px 16px rgba(0,0,0,.22), 0 1px 4px rgba(0,0,0,.10);
  z-index: 2;
}
.inventory .slot:active{
  transform: translateY(-1px) scale(1.01);
}
.inventory .slot:focus-visible{
  outline: 2px solid var(--ui-blue, #2973e3);
  outline-offset: 2px;
  transform: translateY(-2px) scale(1.02);
}</style>
<style>
/* Snowy Pedestal CSS */
body.snowy-pedestals .pedestal{
  background: linear-gradient(#f6fbff, #d9f0ff) !important;
  box-shadow: inset 0 6px 0 rgba(255,255,255,.8), inset 0 -6px 0 rgba(0,0,0,.15), 0 10px 28px rgba(0,120,160,.25) !important;
  position: relative;
}
body.snowy-pedestals .pedestal::after{
  content:"";
  position:absolute; inset:0; pointer-events:none; border-radius:inherit;
  background-image:
    radial-gradient(#fff 1.2px, transparent 1.2px),
    radial-gradient(#fff 1px, transparent 1px);
  background-size: 10px 10px, 6px 6px;
  background-position: 0 0, 3px 3px;
  opacity: .30;
  animation: snowySparkle 2.4s linear infinite;
}
@keyframes snowySparkle {
  0%   { opacity: .22; }
  50%  { opacity: .40; }
  100% { opacity: .22; }
}
</style>


<style>
/* === FLEX PASS button === */
.right-rail .flexpass-btn{
  width: 76px; height: 76px; border-radius: 20px;
  border: 4px solid rgba(0,0,0,.4);
  box-shadow: var(--shadow);
  cursor: pointer;
  background: linear-gradient(180deg,#ffb22e,#ff6f00);
  display:flex; align-items:center; justify-content:center;
}
.right-rail .flexpass-btn img{
  width: 60%; height: 60%;
  image-rendering: -webkit-optimize-contrast;
}

/* === FLEX PASS overlay === */
#flexPassOverlay .sheet{ max-width: 1100px; background: linear-gradient(180deg,#ffd2a7,#ffaf7a); }
#flexPassHeader{
  display:flex; align-items:end; justify-content:space-between; gap:16px;
  margin-bottom:16px; padding-bottom:8px; border-bottom:4px solid rgba(0,0,0,.25);
}
#flexPassHeader h2{ margin:0; font-size:56px; line-height:1; letter-spacing:.5px; }
#flexPassHeader .season{ font-weight:900; opacity:.9; font-size:18px; }
#flexLevelBox{ display:flex; align-items:center; gap:14px; }
#flexLevelNum{
  font-weight:900; font-size:38px; padding:6px 14px; border-radius:12px;
  background: #000; color:#ffda75; border:3px solid rgba(255,255,255,.25);
  box-shadow:0 3px 0 rgba(0,0,0,.35);
}
#flexXPBar{ position:relative; height:22px; border-radius:14px; overflow:hidden; background: rgba(0,0,0,.25); border:3px solid rgba(0,0,0,.35); }
#flexXPFill{ position:absolute; left:0; top:0; bottom:0; width:0%; background: linear-gradient(90deg,#ffe082,#ffd54f,#ffca28); }
#flexXPCap{ font-weight:800; margin-left:12px; }

.flex-rows{ display:flex; flex-direction:column; gap:14px; }
.flex-row{ display:flex; gap:14px; overflow-x:auto; padding-bottom:6px; }
.flex-reward{
  min-width: 200px;
  background: linear-gradient(180deg,#1f7aff,#2bc0ff);
  border-radius:22px; padding:10px; box-shadow:0 6px 18px rgba(0,0,0,.35);
  border: 3px solid rgba(255,255,255,.25); color:#fff; position:relative;
}
.flex-reward .lvl{ position:absolute; right:12px; bottom:8px; font-weight:1000; font-size:28px; text-shadow:0 2px 0 rgba(0,0,0,.2); }
.flex-reward .img{ height:110px; display:flex; align-items:center; justify-content:center; }
.flex-reward .img img{ height:96px; filter: drop-shadow(0 6px 12px rgba(0,0,0,.35)); }
.flex-reward .claim{
  display:block; width:100%; margin-top:6px; font-weight:900;
  border-radius:14px; padding:8px 10px; border:0; cursor:pointer;
  color:#000; background:linear-gradient(180deg,#ffd54f,#ffb300);
  box-shadow:0 3px 0 rgba(0,0,0,.25); letter-spacing:.2px;
}
/* Claimed state: red, disabled look */
.flex-reward .claim.claimed{  background: linear-gradient(180deg,#ff6b6b,#e63946);  color:#fff; cursor:default; box-shadow:0 0 0 rgba(0,0,0,0);}
.flex-reward .claim:disabled{ cursor:default; }

.flex-reward.locked{ opacity:.6; filter:grayscale(0.1) saturate(.7); }
.flex-row.row2 .flex-reward{ background: linear-gradient(180deg,#ff9da0,#ff7aa6); }

/* simple crate explode animation */
@keyframes cratePop{ 0%{ transform:scale(1); } 30%{ transform:scale(1.08); } 50%{ transform:scale(0.88); } 100%{ transform:scale(1); } }
.crate-pop{ animation: cratePop .65s ease-in-out; }

/* Aqua morph visuals */
.rar.t-aqua{ background: linear-gradient(45deg,#8fe7ff,#2c9eff); color:#022; border:2px solid rgba(255,255,255,.25); box-shadow:0 3px 10px rgba(0,150,255,.25); }
/* Improved aqua morph animation: gentle pulsing glow */
/* Aqua morph items shimmer like water. They gently rotate back and forth and pulse with a cool
   glow to evoke waves. The animation lasts longer for a more fluid feel. */
.aqua-morph{ animation: aquaGlow 2.4s ease-in-out infinite; }
@keyframes aquaGlow{
  0%   { transform: rotate(0deg) scale(1);    box-shadow:0 0 8px 2px rgba(0,180,255,.35); }
  25%  { transform: rotate(3deg) scale(1.05); box-shadow:0 0 28px 12px rgba(0,200,255,.45); }
  50%  { transform: rotate(0deg) scale(1.1);  box-shadow:0 0 40px 18px rgba(0,160,255,.40); }
  75%  { transform: rotate(-3deg) scale(1.05);box-shadow:0 0 28px 12px rgba(0,200,255,.45); }
  100% { transform: rotate(0deg) scale(1);    box-shadow:0 0 8px 2px rgba(0,180,255,.35); }
}

/* Coastal rarity color (sandy + ocean) */
:root{ --c-coastal: linear-gradient(90deg, #eaf6ff, #bfe2ff, #68b6ff, #ffffff); }
.bg-coastal{ background: var(--c-coastal) !important; }
body.bg-beachvibes{ background: url('background_files/beach_vibes.png') center center / cover no-repeat fixed !important; }
body.bg-winter{ background: url('background_files/winter_wonderland.png') center center / cover no-repeat fixed !important; }


/* Sandy Shores pedestals */
.sandy-pedestals .stands .stand .placed{ background-image: linear-gradient(180deg,rgba(252,230,173,.25),rgba(255,255,255,.05)); }
</style>

<style id="money-spin-style">
@keyframes money-spin {
  0%   { transform: rotateY(0deg)   scale(1); }
  50%  { transform: rotateY(180deg) scale(1.08); }
  100% { transform: rotateY(360deg) scale(1); }
}
/* apply when claiming a money reward */
.flex-reward .img img.money-spin {
  animation: money-spin 1.1s ease-in-out;
  transform-style: preserve-3d;
  backface-visibility: hidden;
  will-change: transform;
}
</style>

<style>

/* === MAX LEVEL RED CRAZY ANIMATION === */
.max-level-overlay{
  position: fixed;
  inset: 0;
  z-index: 99999;
  pointer-events: none;
  background:
    radial-gradient(120vmax 120vmax at 20% 30%, rgba(255,0,0,0.85), transparent 60%),
    radial-gradient(120vmax 120vmax at 80% 20%, rgba(255,60,60,0.75), transparent 60%),
    radial-gradient(120vmax 120vmax at 30% 80%, rgba(255,0,120,0.6), transparent 60%),
    repeating-linear-gradient(25deg, rgba(255,0,0,0.2) 0 10px, rgba(255,0,80,0.2) 10px 20px);
  mix-blend-mode: screen;
  animation: maxPulse 900ms ease-in-out 0s infinite alternate, maxDrift 8s linear 0s infinite;
  backdrop-filter: blur(2.5px) saturate(1.35);
}
.max-level-overlay .max-text{
  position:absolute;
  top:50%;
  left:50%;
  transform: translate(-50%,-50%);
  font-weight: 900;
  font-size: clamp(48px, 7vw, 120px);
  letter-spacing: 0.2em;
  color: #fff;
  text-shadow: 0 0 10px #ff0022, 0 0 30px #ff0022, 0 0 60px rgba(255,0,0,0.9);
  animation: maxTextFlash 700ms ease-in-out 0s infinite alternate;
}
@keyframes maxPulse{
  from{ transform: scale(1) rotate(0deg); filter: contrast(1.1) hue-rotate(-10deg) }
  to{   transform: scale(1.06) rotate(1deg); filter: contrast(1.6) hue-rotate(10deg) }
}
@keyframes maxDrift{
  from{ background-position: 0 0, 0 0, 0 0, 0 0; }
  to{   background-position: 220px -220px, -180px 180px, 140px 260px, 400px 0; }
}
@keyframes maxTextFlash{
  from{ opacity: 0.75; text-shadow: 0 0 10px #ff2244, 0 0 30px #ff2244, 0 0 60px rgba(255,0,0,1); }
  to{   opacity: 1;    text-shadow: 0 0 20px #ff0022, 0 0 60px #ff0022, 0 0 120px rgba(255,0,0,1); }
}

</style>

<style id="brewCenterRainbowPatch">
/* === GPT patch (v4 center-only + rainbow) === */
/* Keep the page static; center only the brewer content inside the overlay */
#brewOverlay.show{ display: grid !important; place-items: center !important; }
#brewOverlay .panel{ display: grid; justify-items: center; }
#brewTitle{ text-align:center; margin-bottom: 12px; }
/* Keep the grid block centered within the panel */
.brew-grid{ margin-inline: auto; }

/* Rainbow gradient frame for the "Other" slot */
@keyframes brewRainbowHue { from{filter:hue-rotate(0deg)} to{filter:hue-rotate(360deg)} }
#brewOther{
  border: 3px solid transparent;
  border-radius: 12px;
  background:
    linear-gradient(transparent, transparent) padding-box,
    linear-gradient(135deg, #ff0040, #ff8a00, #ffee00, #00d084, #00b8ff, #7a00ff, #ff00ea) border-box;
  animation: brewRainbowHue 10s linear infinite;
}
/* Ensure hover dotted outline is visible above the gradient */
#brewOther.drop-ok::after, #brewOther.brew-hover::after{
  content: "";
  position: absolute; inset: 0;
  border-radius: 10px;
  border: 4px dotted #FFD400;
  box-shadow: 0 0 0 3px rgba(255,212,0,0.35);
  pointer-events: none;
}
/* === End GPT patch === */



/* Lift the brewer panel upward so the full inventory remains visible */
:root{ --brewYOffset: -10vh; }
#brewOverlay .panel{ transform: translateY(var(--brewYOffset)); }
/* Nudge less aggressively on shorter viewports */
@media (max-height: 800px){ :root{ --brewYOffset: -8vh; } }
@media (max-height: 680px){ :root{ --brewYOffset: -6vh; } }
@media (max-height: 560px){ :root{ --brewYOffset: -4vh; } }
</style>

<style id="brewRecipesStyles">
/* === Brewer Recipes Panel styles === */
#brewOverlay .panel .brew-grid{
  grid-template-columns: minmax(240px, 280px) 1fr 1fr !important;
  align-items: start !important;
}

.brew-recipes{
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding-right: 8px;
  min-width: 240px;
}

.brew-recipes .recipes-title{
  font-weight: 900;
  letter-spacing: 1px;
  font-size: 14px;
  opacity: .85;
  margin-bottom: -2px;
}

.recipe-card{
  border-radius: 16px;
  border: 3px solid rgba(0,0,0,.35);
  background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(235,240,255,.88));
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
  padding: 10px;
}

.recipe-head{
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.recipe-icon{
  width: 38px; height: 38px; border-radius: 10px;
  background: rgba(255,255,255,.6);
  border: 3px solid rgba(0,0,0,.25);
  box-shadow: 0 6px 18px rgba(0,0,0,.2) inset, 0 8px 20px rgba(0,0,0,.25);
  object-fit: contain; padding: 4px;
}

.recipe-name{
  font-size: 16px; font-weight: 900; letter-spacing: .5px;
}

.recipe-steps{
  display: flex; align-items: center; flex-wrap: wrap; gap: 6px;
  font-weight: 800;
}

.recipe-steps .plus{ opacity: .6; padding: 0 2px; }

.chip{
  display: inline-flex; align-items: center; justify-content: center;
  padding: 2px 8px; border-radius: 999px;
  border: 2px solid rgba(0,0,0,.35);
  background: #fff; color: #111; font-weight: 900; letter-spacing: .3px;
  font-size: 12px; line-height: 16px;
}
.chip.fuel{ background: linear-gradient(#ffdca6, #ffba52); }
.chip.unique{ background: linear-gradient(#8cc7ff, #3a7dff); color: #061b3a; }
.chip.other.legendary{ background: linear-gradient(#ffe6a6, #ffc852); }
.chip.other.potion{ background: linear-gradient(#f1d6ff, #d6a8ff); }
.chip.other.legacy{ background: linear-gradient(#ffd0d0, #ff8080); }
.chip.other.exotic{ background: linear-gradient(#d7ffd0, #7cff86); }
.chip.other.crypto{ background: linear-gradient(#d0fff6, #7cecff); }

.recipe-note{ margin-top: 6px; font-size: 12px; opacity: .8; }

.fuels-key{
  display: flex; align-items: center; gap: 8px;
  margin-top: 4px; padding: 6px 6px 0 6px; opacity: .8; font-weight: 800;
}
.fuels-key img{ width: 20px; height: 20px; object-fit: contain; border-radius: 6px; border: 2px solid rgba(0,0,0,.3); background:#fff; padding:2px; }
.fuels-key span{ margin-left: 4px; font-size: 12px; }

</style>

<style id="brewRecipesPinnedPatch">
/* === GPT patch: Pin Recipes panel to left edge/top; responsive 1â€“2 columns === */
:root{
  --recipesW: 340px; /* single-column width */
  --recipesPad: 12px;
}

/* Place recipes fixed to the viewport left/top while brewer overlay is open */
#brewOverlay .brew-recipes{
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: var(--recipesW) !important;
  height: 100vh !important;
  overflow: auto !important;
  padding: var(--recipesPad) !important;
  z-index: 10000 !important;
  display: grid !important;
  grid-template-columns: 1fr;
  align-content: start;
  gap: 10px;
  /* nice subtle backdrop so text reads on any bg */
  background: linear-gradient(180deg, rgba(62,35,200,0.18), rgba(255,255,255,0.02));
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  border-right: 3px solid rgba(0,0,0,.25);
}

/* Keep title visible while scrolling recipes */
#brewOverlay .brew-recipes .recipes-title{
  position: sticky; top: 0; z-index: 1;
  background: linear-gradient(180deg, rgba(255,255,255,.45), rgba(255,255,255,0));
  padding: 6px 0 8px 0;
  margin: -2px 0 0 0;
}

/* Shift the main brewer content right to make space for pinned recipes */
#brewOverlay .panel{
  padding-left: calc(var(--recipesW) + var(--recipesPad) + 8px) !important;
}

/* Slightly nudge the close button to not collide with the pinned rail */
#brewOverlay .closeBrew{ right: 16px !important; }

/* When the viewport is short, switch the recipe panel to 2 columns and widen it */
@media (max-height: 860px){
  :root{ --recipesW: 620px; }
  #brewOverlay .brew-recipes{ grid-template-columns: 1fr 1fr; }
}

/* When extremely short, reduce card padding and gaps to fit more */
@media (max-height: 720px){
  :root{ --recipesW: 620px; }
  #brewOverlay .brew-recipes{ gap: 8px; }
  #brewOverlay .brew-recipes .recipe-card{ padding: 8px; }
  #brewOverlay .brew-recipes .recipe-name{ font-size: 15px; }
}
/* === End GPT patch === */

</style>

<style>

/* === Injected: Advanced Announcement UI (v2.1) === */
#flexRichAnn{
  position:fixed; left:50%; transform:translateX(-50%);
  z-index:99999; display:none;
  max-width:min(1200px, 96vw);
  color:#fff; border-radius:14px; padding:14px 16px;
  box-shadow:0 12px 28px rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.08);
}
#flexRichAnn.show{ display:block; }
#flexRichAnn .inner{
  display:flex; align-items:center; justify-content:center; gap:.6rem;
  font:700 28px/1.1 'Inter', system-ui, sans-serif; text-align:center;
  text-transform:none; letter-spacing:0; white-space:pre-wrap;
}
#flexRichAnn .icon{ font-size:1.1em; line-height:1; }
#flexRichAnn.top{ top:14px; }
#flexRichAnn.center{ top:50%; transform:translate(-50%,-50%); }
#flexRichAnn.bottom{ bottom:14px; }
#flexRichAnn.toast{ min-width: 320px; }
#flexRichAnn.banner{ width:100%; }
#flexRichAnn.fade{ animation: fra-fade .25s ease-out both; }
#flexRichAnn.slide{ animation: fra-slide .28s ease-out both; }
#flexRichAnn.pop{ animation: fra-pop .2s ease-out both; }
@keyframes fra-fade{ from{ opacity:0; transform: translateX(-50%) translateY(4px);} to{opacity:1; transform: translateX(-50%) translateY(0);} }
@keyframes fra-slide{ from{ opacity:0; transform: translateX(-50%) translateY(-12px);} to{opacity:1; transform: translateX(-50%) translateY(0);} }
@keyframes fra-pop{ from{ opacity:0; transform: translateX(-50%) scale(.98);} to{opacity:1; transform: translateX(-50%) scale(1);} }

/* Hide legacy banner while advanced is visible */
body.flex-hide-legacy-banner #adminMsgBanner{ display:none !important; }
/* === /Injected === */

</style>

<style id="flexwood-css">
/* === FLEXWOOD (Event) â€” visuals === */
.icon-flexwood{
  width:72px;height:72px;border-radius:20px; border:3px solid rgba(0,0,0,.35);
  /* Switch the Flexwood button to a yellow theme.  The icon remains the
     same, but the surrounding gradient shifts from red to a warm golden
     gradient. */
  background: url('icons/flexwood_icon.png') center/58% no-repeat,
              linear-gradient(180deg,#ffd54f,#ffb300);
  box-shadow:var(--shadow);
}
.img-wrap{ position:relative; }
.img-wrap .hollywood-ring{
  position:absolute; inset:-6px; border-radius:16px;
  background: conic-gradient(from 0deg, rgba(255,221,64,0.0), rgba(255,221,64,0.75), rgba(255,221,64,0.0));
  -webkit-mask: radial-gradient(circle, transparent 64%, #000 66%);
  mask: radial-gradient(circle, transparent 64%, #000 66%);
  animation: hw-spin 0.8s linear infinite;
  pointer-events:none;
  box-shadow: 0 0 10px rgba(255,221,64,0.65), inset 0 0 10px rgba(255,221,64,0.25);
}
/* Tag for Hollywood morph items when placed on a pedestal */
/* Tag styles for morph items */
/* Hollywood tag shares base tag styling but uses a golden gradient */
.hollywood-tag{
  display:inline-block;
  margin-left:4px;
  margin-top:2px;
  padding:2px 6px;
  border-radius:6px;
  font-size:11px;
  font-weight:900;
  text-transform: uppercase;
  background: linear-gradient(90deg,#ffdd40,#ffec82);
  color:#111;
  box-shadow:0 0 6px rgba(255,221,64,.45), inset 0 0 3px rgba(255,221,64,.25);
}
/* Aqua tag uses a cool blue gradient and aligns like Hollywood */
.aqua-tag{
  display:inline-block;
  margin-left:4px;
  margin-top:2px;
  padding:2px 6px;
  border-radius:6px;
  font-size:11px;
  font-weight:900;
  text-transform: uppercase;
  background: linear-gradient(90deg,#8fe7ff,#2c9eff);
  color:#002;
  box-shadow:0 0 6px rgba(0,180,255,.45), inset 0 0 3px rgba(0,180,255,.25);
}
/* Demon tag uses a fiery red gradient and aligns like Hollywood */
.demon-tag{
  display:inline-block;
  margin-left:4px;
  margin-top:2px;
  padding:2px 6px;
  border-radius:6px;
  font-size:11px;
  font-weight:900;
  text-transform: uppercase;
  background: linear-gradient(90deg,#ff4c4c,#ff8d8d);
  color:#300;
  box-shadow:0 0 6px rgba(255,0,0,.45), inset 0 0 3px rgba(255,0,0,.25);
}

/* Demon morph ring: swirling crimson energy around the item */
.img-wrap .demon-ring{
  position:absolute;
  inset:-6px;
  border-radius:16px;
  background: conic-gradient(from 0deg, rgba(255,64,64,0.0), rgba(255,64,64,0.7), rgba(255,64,64,0.0));
  -webkit-mask: radial-gradient(circle, transparent 64%, #000 66%);
  mask: radial-gradient(circle, transparent 64%, #000 66%);
  animation: d-spin 1.1s linear infinite;
  pointer-events:none;
  box-shadow: 0 0 12px rgba(255,64,64,0.65), inset 0 0 12px rgba(255,64,64,0.25);
}
@keyframes d-spin{ to{ transform: rotate(360deg); } }
/* Aqua morph ring: swirling teal energy around the item */
.img-wrap .aqua-ring{
  position:absolute;
  inset:-6px;
  border-radius:16px;
  background: conic-gradient(from 0deg, rgba(0,180,255,0.0), rgba(0,180,255,0.65), rgba(0,180,255,0.0));
  -webkit-mask: radial-gradient(circle, transparent 64%, #000 66%);
  mask: radial-gradient(circle, transparent 64%, #000 66%);
  animation: aq-spin 1.2s linear infinite;
  pointer-events:none;
  box-shadow: 0 0 12px rgba(0,180,255,0.6), inset 0 0 12px rgba(0,180,255,0.3);
}
@keyframes aq-spin{ to{ transform: rotate(-360deg); } }
@keyframes hw-spin{ to{ transform: rotate(360deg);} }

#flexwoodOverlay{ position:fixed; inset:0; display:none; z-index:10000 !important; background:rgba(0,0,0,.55); }
#flexwoodOverlay.show{ display:block; }
#flexwoodOverlay .sheet{ position:absolute; left:50%; top:54px; transform:translateX(-50%); width:min(100%, 980px); max-height: calc(100% - 80px); overflow:auto;
  /* Redesigned Flexwood sheet: replace the red motif with a deep
     midnightâ€‘blue gradient that ties into the core Flex colour palette.  A
     faint golden border alludes to Hollywood glamour while staying on
     brand. */
  background: linear-gradient(180deg,#1b3048,#0d1628);
  border:3px solid rgba(255,215,64,.35);
  border-radius:16px;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
  color:#fff;
  padding:16px;
}
#flexwoodOverlay .title{
  display:flex;
  align-items:center;
  gap:12px;
  /* Increase the font size and apply a bold white colour to emulate the Hollywood sign.
     Drop shadows give the letters depth and the feel of being mounted on a hillside. */
  font: 900 32px/1.1 "Bungee", sans-serif;
  position: relative;
  color: #fff;
  text-shadow: -4px 3px 0 #3c0202, -8px 6px 0 #000;
}

/* Add a stylised mountain silhouette beneath the title text.  The clipâ€‘path creates
   an uneven horizon reminiscent of hills.  This pseudo element extends the
   width of the title and sits just below the baseline of the text. */
#flexwoodOverlay .title::after{
  content: '';
  position: absolute;
  left: 0;
  right: 0;
  bottom: -4px;
  height: 20px;
  background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0));
  clip-path: polygon(0 100%, 10% 60%, 20% 80%, 30% 50%, 40% 70%, 50% 40%, 60% 75%, 70% 45%, 80% 65%, 90% 55%, 100% 90%);
  pointer-events: none;
}
#flexwoodGrid{
  display:grid;
  /* Use an autoâ€‘fitting grid so cards wrap gracefully on smaller screens.  The
     minmax ensures a comfortable width for each card. */
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap:18px;
  margin-top:12px;
}
.flexwood-card{
  /* Updated card design: a subtle blue gradient reminiscent of a night
     sky, edged with a soft gold border.  A gentle shadow lifts the card
     from the sheet, and added padding/height allows room for the
     progress bar. */
  background: linear-gradient(180deg, #233954, #0f1e33);
  border: 2px solid rgba(255,215,64,0.25);
  border-radius:14px;
  padding:14px;
  position:relative;
  min-height:180px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.flexwood-card.locked{ opacity:0.6; filter:saturate(0.6); }
.flexwood-card .top{ display:flex; gap:10px; align-items:center; }
.flexwood-card img{ width:64px; height:64px; border-radius:10px; background:#111; border:2px solid rgba(255,255,255,.12); }
.flexwood-card .label{ font-weight:900; letter-spacing:0.5px; }
.flexwood-card .quest{ margin-top:6px; opacity:0.95; font-weight:700; }
.flexwood-card .claim{ margin-top:10px; }
.flexwood-card .big{
  position:absolute; right:8px; top:8px;
  font-weight:800;
  font-size:12px;
  padding:2px 8px;
  border-radius:10px;
  /* Highlight BIG REWARD badges with a golden shimmer to tie into the
     Hollywood theme.  The dark text remains legible against the light
     background. */
  background: linear-gradient(90deg,#ffe57e,#ffb92a);
  color:#2b1c02;
}
/*
 * Progress bar styling for Flexwood cards.  A subtle translucent track
 * sits behind a vibrant gradient bar that fills according to quest
 * progress.  Rounded corners and smooth transitions make the meter
 * blend seamlessly with the card design.  The height and margin
 * complement the existing spacing within cards.
 */
.flexwood-card .progress{
  margin-top: 6px;
  width: 100%;
  height: 8px;
  background: rgba(255,255,255,0.12);
  border-radius: 6px;
  overflow: hidden;
}
.flexwood-card .progress-bar{
  height: 100%;
  background: linear-gradient(90deg, var(--ui-blue), var(--ui-blue-dark));
  border-radius: 6px;
  transition: width .4s ease;
}
.flexwood-close{ position:absolute; right:12px; top:12px; background:#000; color:#fff; border:2px solid rgba(255,255,255,.25); border-radius:10px; padding:6px 10px; font-weight:800; }

/* Red Carpet Pedestals look (distinct from 'red') */
.redcarpet-pedestals .pedestal{
  background:
    repeating-linear-gradient(135deg, rgba(255,255,255,0.10) 0 4px, rgba(255,255,255,0.0) 4px 8px),
    linear-gradient(180deg,#a80f1f,#6e0712);
  border: 3px solid #5a0410;
  box-shadow: inset 0 6px 0 rgba(255,255,255,0.08), 0 10px 0 rgba(0,0,0,.35);
}
.redcarpet-pedestals .pedestal::before{
  /* Remove the decorative yellow line that ran along the top of the red carpet
     pedestal.  Players found this strip distracting, so we eliminate it
     entirely by hiding the pseudo-element. */
  content: '';
  display: none;
}
</style>


<style id="flexwood-bright-text">
  /* Make all Flexwood overlay text brighter and higher contrast */
  #flexwoodOverlay .sheet{ color:#ffffff; }
  #flexwoodOverlay .title{ text-shadow: 0 2px 0 rgba(0,0,0,.6), 0 0 10px rgba(255,215,64,.25); }
  #flexwoodOverlay .flexwood-card .label{ color:#ffffff; text-shadow:0 1px 0 rgba(0,0,0,.6); }
  #flexwoodOverlay .flexwood-card .quest{ color:#ffffff; opacity:1; text-shadow:0 1px 0 rgba(0,0,0,.6); }
  #flexwoodOverlay .flexwood-card .big{ color:#ffffff; text-shadow:0 1px 0 rgba(0,0,0,.7); }
  #flexwoodOverlay .flexwood-close{ color:#ffffff; text-shadow:0 1px 0 rgba(0,0,0,.8); }

  /* Buttons: ensure readability in both states */
  #flexwoodOverlay .buy.claim{ color:#111; font-weight:900; background:linear-gradient(180deg,#ffd54f,#ffb300); border-color:#ffca2a; }
  #flexwoodOverlay .buy.claim[disabled]{ color:#eaeaea; background:rgba(255,255,255,.15); border-color:rgba(255,255,255,.35); }

  /* Also brighten any small helper text that might appear inside cards */
  #flexwoodOverlay .flexwood-card p,
  #flexwoodOverlay .flexwood-card span{ color:#ffffff; }
</style>


<style id="flexwood-blur-fix">
  /* Blur only the page behind the overlay, not the overlay content */
  #flexwoodOverlay{
    background: rgba(0,0,0,.35) !important;
  }
  #flexwoodOverlay::before{
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    -webkit-backdrop-filter: blur(6px);
    backdrop-filter: blur(6px);
  }
  #flexwoodOverlay .sheet{
    -webkit-backdrop-filter: none !important;
    backdrop-filter: none !important;
    filter: none !important;
  }
</style>


<style id="flexwood-fullwhite">
  /* Force full-bright white text in Flexwood overlay */
  #flexwoodOverlay .sheet,
  #flexwoodOverlay .title,
  #flexwoodOverlay .flexwood-card,
  #flexwoodOverlay .flexwood-card .label,
  #flexwoodOverlay .flexwood-card .quest,
  #flexwoodOverlay .flexwood-card .big,
  #flexwoodOverlay .flexwood-close {
    color: #ffffff !important;
    opacity: 1 !important;
    text-shadow: 0 1px 0 rgba(0,0,0,.85);
  }
  /* Ensure any nested spans/p elements inherit full white */
  #flexwoodOverlay .flexwood-card p,
  #flexwoodOverlay .flexwood-card span,
  #flexwoodOverlay .flexwood-card div {
    color: #ffffff !important;
  }
  /* Keep buttons readable in both states */
  #flexwoodOverlay .buy.claim { color:#111 !important; }
  #flexwoodOverlay .buy.claim[disabled] { color:#f5f5f5 !important; }
</style>

</head>
<body>
<!-- Rising Tides XP UI -->
<div id="rtxp-hud" aria-live="polite">
  <div class="title">Event: <span id="rtxp-name">â€”</span></div>
  <div class="timer">Time left: <span id="rtxp-eta">60</span>s</div>
</div>
<div id="rtxp-layer"></div>
<div class="event-row" id="eventRow"></div>
<div class="game">
<div class="topbar">
<div class="cash" id="cash">$1,000,000</div>
<div class="eps" id="eps">+ $0 / sec</div>
<div class="eps" id="multBadge"></div>
</div>
<div class="left-rail">
<div id="userDisplay" style="margin-bottom:16px;text-align:center;font-weight:bold;font-size:1.2em;color:#222;background:#fff7e0;padding:8px 0;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.10);">
<!-- Username will appear here -->
</div>
<button aria-label="Open shop" class="icon-btn icon-shop" id="openShop" title="Shop">
<svg fill="none" stroke="#e40000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24">
<circle cx="9" cy="21" r="1.8"></circle>
<circle cx="20" cy="21" r="1.8"></circle>
<path d="M1 2h3l3.6 12.4a2 2 0 0 0 2 1.6h7.8a2 2 0 0 0 2-1.6L23 6H6"></path>
</svg>
</button>
<button aria-label="Tools" class="icon-btn icon-tools" id="toolsBtn" title="Tools (toggle fast refresh)">
<img alt="Gear Shop" src="icons/gear_shop_icon.png"/>
</button>
<!-- NEW: Pet Shop button (paw) -->
<button aria-label="Pet Shop" class="icon-btn icon-pets" id="openPetShop" title="Pet Shop"> <svg aria-hidden="true" fill="none" stroke="#111" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" viewbox="0 0 24 24">
<!-- toes -->
<circle cx="7.5" cy="7.5" r="2"></circle>
<circle cx="12" cy="6" r="2"></circle>
<circle cx="16.5" cy="7.5" r="2"></circle>
<circle cx="10" cy="10.5" r="1.8" style="display:none"></circle> <!-- (optional hidden) -->
<!-- main pad outline -->
<path d="M12 13c-2.8 0-6 2.2-6 5 0 2.2 3 3.5 6 3.5s6-1.3 6-3.5c0-2.8-3.2-5-6-5z"></path>
</svg>
</button>
<button aria-label="Toggle music" class="icon-btn icon-music" id="musicBtn" title="Toggle music">
<svg fill="none" stroke="#111" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" viewbox="0 0 24 24"><path d="M9 17V5l11-2v12"></path><circle cx="6" cy="18" r="2"></circle><circle cx="17" cy="16" r="2"></circle></svg>
</button>
</div>
<div class="stands" id="stands"></div>
<!-- Pet row will be rendered directly under stands inside renderStands -->
<!-- Forge button -->
<button id="forgeBtn" title="Forge 4 Legendaries into 1 Mythic">FORGE</button>
<!-- inventory is now fixed to bottom via CSS -->
<div class="inventory-wrap">
<div class="inventory" id="inventory"></div>
</div>
</div>
<div aria-hidden="true" class="overlay" id="shopOverlay">
<div aria-labelledby="shopTitle" aria-modal="true" class="shop" role="dialog">
<button aria-label="Close" class="closeX" id="closeShop">âœ•</button>
<h2 id="shopTitle">Shop</h2>
<div class="grid" id="shopGrid"></div>
<div class="refresh-note" id="refreshNote">Shop refreshes every 1:30</div>
</div>
</div>
<!-- Pet Shop Overlay -->
<div aria-hidden="true" class="overlay" id="petOverlay">
<div aria-labelledby="petTitle" aria-modal="true" class="shop" role="dialog">
<button aria-label="Close" class="closeX" id="closePetShop">âœ•</button>
<h2 id="petTitle">Pet Shop</h2>
<div class="grid">
<div class="card">
<h3>Pet Pedestal</h3>
<div style="font-size:18px; opacity:0.9;">Adds a pet pedestal below the pedestals. Max 2. Place eggs here to incubate.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$15,000,000</div>
<button class="buy" id="buyPetPedestal">Purchase</button>
</div>
<div id="petPedestalStatus" style="margin-top:6px;font-weight:700;color:#6dff79;"></div>
</div>
<div class="card">
<h3>Legendary Egg</h3>
<div style="font-size:18px; opacity:0.9;">Hatch into Dog / Cat / Gold Dog.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$10,000,000</div>
<button class="buy" id="buyLegendEgg">Purchase</button>
</div>
</div>
<div class="card">
<h3>Mythical Egg</h3>
<div style="font-size:18px; opacity:0.9;">Hatch into Lion / Bear / Dino.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$15,000,000</div>
<button class="buy" id="buyMythEgg">Purchase</button>
</div>
</div>
<div class="card">
<h3>Enchanted Egg</h3>
<div style="font-size:18px; opacity:0.9;">Hatch into Owl / Rainbow Panda / Flex T-Rex.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$25,000,000</div>
<button class="buy" id="buyEnchantedEgg">Purchase</button>
</div>
</div>
<div class="card">
<h3>Universal Egg</h3>
<div style="font-size:18px; opacity:0.9;">Hatch into Lizard / Alien / Hudsonâ€“Drakeâ€“Molly / Flex Dragon.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$1,000,000,000</div>
<button class="buy" id="buyUniversalEgg">Purchase</button>
</div>
</div>
<div class="card">
<h3>Magical Egg</h3>
<div style="font-size:18px; opacity:0.9;">Rainbow gradient + sparkles. Hatches: Frog / Tiger / Deer / Nellaâ€“Ozzyâ€“Chloe / Flexicorn.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$2,000,000,000</div>
<button class="buy" id="buyMagicalEgg">Purchase</button>
</div>
</div>
</div>
<div class="refresh-note" id="petNote">Pets hatch in 10 minutes</div>
</div>
</div>
<!-- Gear Overlay -->
<div aria-hidden="true" class="overlay" id="gearOverlay">
<div aria-labelledby="gearTitle" aria-modal="true" class="shop" role="dialog">
<button aria-label="Close" class="closeX" id="closeGear">âœ•</button>
<h2 id="gearTitle" style="color:#ff5050;text-align:center;">Gear</h2>
<div class="grid">
<!-- Rebirth Multiplier -->
<div class="card" id="rebirthCard">
<h3>Rebirth X <span id="rebirthLevelTag" style="font-size:18px;opacity:.8;">(Level 0)</span></h3>
<div style="font-size:18px; opacity:0.85;">Resets money to $1,000,000, increases multiplier. Max level 19.</div>
<!-- Redeem Overlay (small white modal) -->
<div aria-hidden="true" class="overlay" id="redeemOverlay">
<div aria-labelledby="redeemTitle" aria-modal="true" class="shop" role="dialog" style="max-width:520px;background:#fff;color:#111">
<button aria-label="Close" class="closeX" id="closeRedeem" style="color:#111">âœ•</button>
<h2 id="redeemTitle" style="color:#111;text-align:center;">Redeem Code</h2>
<div style="display:flex;flex-direction:column;gap:10px;margin-top:8px">
<input id="redeemInput" inputmode="numeric" maxlength="12" pattern="[0-9]*" placeholder="Enter 12â€‘digit code" style="padding:10px;border-radius:10px;border:1px solid #ccc;font-size:18px"/>
<div style="display:flex;gap:8px;justify-content:flex-end;align-items:center;margin-top:6px">
<button class="upgrade" id="doRedeem" style="background:#111;color:#fff">Redeem</button>
</div>
<div class="small" id="redeemMsg" style="min-height:20px;color:#111;opacity:.9"></div>
</div>
</div>
</div>
<div id="rebirthStatus" style="margin-top:6px;font-weight:700;color:#6dff79;">Current Rebirth Multiplier: x1</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price" id="rebirthPrice">$1,000,000,000</div>
<button class="upgrade" id="rebirthUpgrade">Upgrade</button>
</div>
</div>
<!-- Redeem Codes -->
<div class="card" id="redeemCard">
<h3>Redeem</h3>
<div style="font-size:18px; opacity:0.85;">Enter a 12â€‘digit redeem code to unlock an item, background, or pet.</div>
<div style="display:flex;justify-content:flex-end;align-items:center;">
<button class="buy" id="openRedeemOverlay">Enter redeem code</button>
</div>
</div>
<!-- Background Tool -->
<div class="card" id="backgroundCard">
<h3>Background Red/Blue</h3>
<div style="font-size:18px; opacity:0.85;">Switch gradient to red/blue.<br/>One-time purchase.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$4,000,000</div>
<button class="buy" id="buyBackground">Purchase</button>
</div>
<button class="buy" id="toggleBackground" style="display:none;background:linear-gradient(#ff7a7a,#6aaaff);">Disable</button>
</div>
<!-- Red Money Tool -->
<div class="card" id="redMoneyCard">
<h3>Red Money</h3>
<div style="font-size:18px; opacity:0.85;">Changes the top money banner to red/dark red.<br/>One-time purchase.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$1,000,000,000,000</div>
<button class="buy" id="buyRedMoney">Purchase</button>
</div>
<button class="buy" id="toggleRedMoney" style="display:none;background:linear-gradient(#ff6b6b,#8b0000);">Disable</button>
</div>
<div class="overlay hidden" id="settingsOverlay">
<h2>Settings</h2>
<div>
<button onclick="toggleBackground()">Toggle Background</button>
</div>
<div style="margin-top: 10px;">
<button onclick="downloadSave()">Download Save</button>
</div>
<div style="margin-top: 10px;">
<input accept=".json" id="uploadSaveInput" onchange="handleSaveUpload(event)" style="display:none" type="file"/>
<button onclick="document.getElementById('uploadSaveInput').click()">Upload Save</button>
</div>
</div>
</div>
</div>
</div>
<!--
  NOTE:
  The JavaScript from your original file is compatible with these layout changes.
  I intentionally left the script logic intact (no changes) â€” only the styles and layout were updated so the
  inventory bar sits fixed at the bottom like your concept art, pedestals/placed items are raised above it,
  and slots have larger sizes and a thick outlined container matching the visual.
-->
<!-- Log Out button replaces the old reset game button. It remains fixed in the same location -->
<!-- Log Out button will appear here (replaces old reset/delete user button).  Hidden by default; the script will
     toggle display when a user is logged in. -->
<button id="resetUserBtn" style="margin-left:20px;background:#e74c3c;color:#fff;padding:6px 8px;border-radius:12px;border:none;font-weight:bold;cursor:pointer;font-size:14px;white-space:nowrap;">Log Out</button>
<script>
// Removed the reset game handler.  The button in this position now logs the user out via separate logic.
/* ---------------------------
   Paste your entire original JavaScript here (unchanged).
   For brevity in this example I am keeping the JS unchanged from your provided code.
   Make sure to copy the whole <script> contents from your original file into this spot.
   --------------------------- */

  /*****************
   * GAME CONSTANTS
   * (full JS from original file goes here)
   *****************/

  const MONEY_START = 1_000_000;
  const STAND_COUNT = 4;
  const SHOP_SLOTS = 4;

  // --------------------------------------------------------------------------
  // Helper: ensure the main stands array always has the correct length.
  // Occasionally other scripts or corrupted saves can accidentally shrink or
  // expand the `state.stands` array.  Losing a pedestal entirely breaks
  // earnings, so this guard keeps the array at `STAND_COUNT` length.  It
  // preserves existing entries and pads with `null` as needed.  If the array
  // somehow grows too long, extra entries are trimmed off the end.
  function ensureStandsLength(){
    try{
      // If state or stands is missing, initialize a fresh array
      if(!state || !Array.isArray(state.stands)){
        state.stands = Array(STAND_COUNT).fill(null);
      } else {
        // Pad with nulls if too short
        while(state.stands.length < STAND_COUNT){
          state.stands.push(null);
        }
        // Trim extra entries if too long
        if(state.stands.length > STAND_COUNT){
          state.stands = state.stands.slice(0, STAND_COUNT);
        }
      }
    } catch(e){
      // On any unexpected error, reset to a clean slate
      state.stands = Array(STAND_COUNT).fill(null);
    }
  }

  const RARITY = {
    common: { label:'COMMON', color:'var(--c-common)', income: 50, price:[8_000, 40_000], prob: 0.60 },
    rare: { label:'RARE', color:'var(--c-rare)', income: 200, price:[40_000, 150_000], prob: 0.25 },
    epic: { label:'EPIC', color:'var(--c-epic)', income: 800, price:[150_000, 420_000], prob: 0.12 },
    legendary:{ label:'LEGENDARY', color:'var(--c-legendary)', income: 3000, price:[420_000, 920_000], prob: 0.03 },
    legacy:{ label:'LEGACY', color:'var(--c-legacy)', income: 8000, price:[900_000, 2_500_000], prob: 0.005 },
    birthday: { label:'BIRTHDAY', color:'#ff62d5', income: 15000, price:[0,0], prob: 0 },
    mythic:{ label:'MYTHIC', color:'var(--c-mythic)', income: 20000, price:[0,0], prob: 0 },
    unique:  { label:'UNIQUE', color:'navy', income: 10000, price:[2_500_000,4_000_000], prob: 0.003 },
    exotic:  { label:'EXOTIC', color:'cyan', income: 15000, price:[0,0], prob: 0 },
     crypto:  { label:'CRYPTO', color:'#ff62d5', income: 50000, price:[0,0], prob: 0 }
  };

  const ITEM_NAMES = [
    '24 King Crown','Donut','3D Printer','Space Nathan','Candy Blossom',
    'Frog Sneakers','Snake','Harry Potter\'s Wand','Retro Gameboy','Crystal Cube',
    'Swat Night','Flashforge','Blue Walls','Golden Spatula','Rainbow Headphones',
    'Red Government','Vecna','Aqua Drone','Burning Bud','Espresso',
    'Pixel Panda','Sabrina','Nether Portal','Alt','Natan',
    'Apple Watch','Chicken Jockey','67','Nathan\'s Playstation','Stale Goldfish Bag',
    'Duolingo','Dillon\'s PC','Apple','Icon of the Seas','North America',
    'Sheldon','Old Fan','$$$','McFlex','Junior Lifeguards',
    'Carl','Supreme','Nike Guy','Puma Socks','Blue',
    'Barbie','','Golden Jacket','Lucas Movies','Movie Clip Reel','Leo\'s Ethernet','Ryan\'s Hat','Lebron','Pigs\'s Blanket','Lamborghini','Dean\'s PC','USA','China','Iron Man\'s Helmet','Hanging Tree',
    'Yellow Unicorn','Brown Bison','Delta','JP\'s Scooter','Salmon','41','Siri','GTA 6','Pink Guard','Bo\'ttle o Wa\'er','Tivon\'s Bike','Harold','Super Leo','Bambu Lab','Adobe','Willy','Oasis','Deck 13?','Wheel of Doom','Hollywood','Delorean','Chick-fil-a','LA','Piccadilly Line'
  ];
  while (ITEM_NAMES.length < 50) ITEM_NAMES.push('Item #' + (ITEM_NAMES.length+1));

  const ICON_PATHS = {
    "24 King Crown": `<path d="M18 62h60v10H18z M20 62l10-22 18 20 18-20 10 22" fill="none" stroke-width="6" stroke-linejoin="round"/>`,
    "Donut": `<circle cx="48" cy="48" r="26" fill="none" stroke-width="6"/><circle cx="48" cy="48" r="10" fill="none" stroke-width="6"/>`,
    "3D Printer": `<rect x="18" y="18" width="60" height="48" rx="6" fill="none" stroke-width="6"/><path d="M26 26h44v16H26zM48 42v20" fill="none" stroke-width="6"/>`,
    "Space Nathan": `<circle cx="48" cy="38" r="14" fill="none" stroke-width="6"/><rect x="34" y="52" width="28" height="22" rx="6" fill="none" stroke-width="6"/>`,
    "Candy Blossom": `<path d="M48 20v24M48 44c-14 0-14 18 0 18s14-18 0-18z" fill="none" stroke-width="6"/><circle cx="48" cy="20" r="6" fill="none" stroke-width="6"/>`,
    "Frog Sneakers": `<rect x="20" y="54" width="56" height="16" rx="8" fill="none" stroke-width="6"/><path d="M24 54c6-12 24-12 30 0" fill="none" stroke-width="6"/>`,
    "Snake": `<path d="M20 58c10-18 26-18 36-8s20 10 20 2-8-12-16-12" fill="none" stroke-width="6" stroke-linecap="round"/>`,
    "Harry Potter's Wand": `<path d="M20 74L76 18" fill="none" stroke-width="6"/><circle cx="76" cy="18" r="4" />`,
    "Retro Gameboy": `<rect x="28" y="16" width="40" height="64" rx="8" fill="none" stroke-width="6"/><rect x="34" y="22" width="28" height="24" rx="4" fill="none" stroke-width="6"/><circle cx="46" cy="56" r="4"/><circle cx="54" cy="60" r="4"/>`,
    "Crystal Cube": `<rect x="28" y="28" width="40" height="40" rx="6" fill="none" stroke-width="6"/><path d="M28 48h40M48 28v40" fill="none" stroke-width="6"/>`,
    "Swat Night": `<path d="M22 60h52l8-20H30z" fill="none" stroke-width="6"/><circle cx="34" cy="64" r="4"/><circle cx="62" cy="64" r="4"/>`,
    "Flashforge": `<path d="M24 48l24-24 24 24-24 24z" fill="none" stroke-width="6"/>`,
    "Blue Walls": `<rect x="20" y="24" width="56" height="44" rx="4" fill="none" stroke-width="6"/><path d="M20 46h56" fill="none" stroke-width="6"/>`,
    "Golden Spatula": `<path d="M48 22v44" fill="none" stroke-width="6"/><rect x="36" y="22" width="24" height="12" rx="2" fill="none" stroke-width="6"/>`,
    "Rainbow Headphones": `<path d="M26 48a22 22 0 0 1 44 0" fill="none" stroke-width="6"/><rect x="18" y="44" width="14" height="24" rx="6" fill="none" stroke-width="6"/><rect x="64" y="44" width="14" height="24" rx="6" fill="none" stroke-width="6"/>`,
    "Red Government": `<rect x="24" y="40" width="48" height="28" rx="4" fill="none" stroke-width="6"/><path d="M24 40l24-16 24 16" fill="none" stroke-width="6"/>`,
    "Vecna": `<path d="M48 20c-10 8-10 16 0 24 10-8 10-16 0-24z" fill="none" stroke-width="6"/><circle cx="48" cy="58" r="10" fill="none" stroke-width="6"/>`,
    "Aqua Drone": `<circle cx="48" cy="48" r="12" fill="none" stroke-width="6"/><path d="M20 48h16M60 48h16M48 20v16M48 60v16" fill="none" stroke-width="6"/>`,
    "Burning Bud": `<path d="M48 24c-18 12-18 28 0 40 18-12 18-28 0-40z" fill="none" stroke-width="6"/><path d="M36 66h24" fill="none" stroke-width="6"/>`,
    "Espresso": `<rect x="28" y="38" width="40" height="24" rx="4" fill="none" stroke-width="6"/><path d="M68 40h10v10a6 6 0 0 1-10 0z" fill="none" stroke-width="6"/>`,
    "Pixel Panda": `<rect x="28" y="28" width="40" height="40" fill="none" stroke-width="6"/><rect x="36" y="36" width="8" height="8"/><rect x="52" y="36" width="8" height="8"/>`,
    "Sabrina": `<circle cx="48" cy="38" r="12" fill="none" stroke-width="6"/><path d="M34 54h28l6 18H28z" fill="none" stroke-width="6"/>`,
    "Nether Portal": `<rect x="28" y="18" width="40" height="60" rx="6" fill="none" stroke-width="6"/><rect x="36" y="26" width="24" height="44" rx="3" fill="none" stroke-width="6" />`,
    "Alt": `<path d="M24 60l24-36 24 36" fill="none" stroke-width="6"/>`,
    "Natan": `<path d="M24 64l24-24 24 24" fill="none" stroke-width="6"/><circle cx="48" cy="34" r="6" fill="none" stroke-width="6"/>`,
    "Apple Watch": `<rect x="28" y="28" width="40" height="40" rx="10" fill="none" stroke-width="6"/><rect x="36" y="36" width="24" height="24" rx="6" fill="none" stroke-width="6"/>`,
    "Chicken Jockey": `<circle cx="36" cy="44" r="10" fill="none" stroke-width="6"/><rect x="42" y="48" width="26" height="18" rx="6" fill="none" stroke-width="6"/>`,
    "67": `<g transform="skewX(-10)"><path d="M48 28H34V72H52V56H38M56 28H74L60 72" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/></g>`,
    "Nathan's Playstation": `<rect x="24" y="56" width="48" height="10" rx="4" fill="none" stroke-width="6"/><path d="M28 56h40l-6-16H34z" fill="none" stroke-width="6"/>`,
    "Stale Goldfish Bag": `<rect x="30" y="24" width="36" height="48" rx="6" fill="none" stroke-width="6"/><path d="M30 32h36" fill="none" stroke-width="6"/>`,
    "Duolingo": `<path d="M30 44l18-12 18 12-18 12z" fill="none" stroke-width="6"/><circle cx="40" cy="44" r="3"/><circle cx="56" cy="44" r="3"/>`,
    "Dillon's PC": `<rect x="24" y="28" width="48" height="30" rx="6" fill="none" stroke-width="6"/><rect x="34" y="60" width="28" height="6" rx="3" fill="none" stroke-width="6"/>`,
    "Apple": `<circle cx="48" cy="44" r="16" fill="none" stroke-width="6"/><path d="M48 26c4 0 6 2 8 4" fill="none" stroke-width="6"/>`,
    "Icon of the Seas": `<path d="M24 58h48l8-10H32z" fill="none" stroke-width="6"/><rect x="36" y="42" width="24" height="8" rx="2" fill="none" stroke-width="6"/>`,
    "North America": `<path d="M28 40l10-8 12 6 10-8 8 10-8 10-12 4-10-6z" fill="none" stroke-width="6"/>`,
    "Sheldon": `<circle cx="48" cy="36" r="10" fill="none" stroke-width="6"/><rect x="36" y="48" width="24" height="20" rx="8" fill="none" stroke-width="6"/>`,
    "Old Fan": `<circle cx="48" cy="48" r="18" fill="none" stroke-width="6"/><path d="M48 30v36M30 48h36" fill="none" stroke-width="6"/>`,
    "$$$": `<path d="M48 24v48M34 38c0-8 28-8 28 0s-28 8-28 16 28 8 28 0" fill="none" stroke-width="6"/>`,
    "McFlex": `<rect x="24" y="40" width="48" height="24" rx="6" fill="none" stroke-width="6"/><path d="M28 40c8-12 32-12 40 0" fill="none" stroke-width="6"/>`,
    "Junior Lifeguards": `<circle cx="48" cy="48" r="18" fill="none" stroke-width="6"/><path d="M48 30v36M30 48h36" fill="none" stroke-width="6"/>`,
    "Carl": `<path d="M36 32h24v12H36zM34 50h28v14H34z" fill="none" stroke-width="6"/>`,
    "Supreme": `<rect x="22" y="42" width="52" height="14" rx="7" fill="none" stroke-width="6"/>`,
    "Nike Guy": `<path d="M24 62c24-4 40-14 48-24-6 14-22 24-48 24z" fill="none" stroke-width="6" stroke-linecap="round"/>`,
    "Puma Socks": `<rect x="28" y="46" width="18" height="20" rx="4" fill="none" stroke-width="6"/><path d="M46 64h22v-14" fill="none" stroke-width="6"/>`,
    "Blue": `<circle cx="48" cy="48" r="20" fill="none" stroke-width="6"/>`,
    "Barbie": `<path d="M30 62c6-12 24-12 36 0" fill="none" stroke-width="6"/><circle cx="48" cy="40" r="10" fill="none" stroke-width="6"/>`,
    "": `<path d="M48 26l18 36H30z" fill="none" stroke-width="6"/>`,
    "Golden Jacket": `<rect x="26" y="28" width="44" height="36" rx="8" fill="none" stroke-width="6"/><path d="M26 44h44" fill="none" stroke-width="6"/>`,
    "Lucas Movies": `<rect x="26" y="34" width="44" height="28" rx="4" fill="none" stroke-width="6"/><rect x="24" y="38" width="8" height="20"/><rect x="64" y="38" width="8" height="20"/>`,
    "Movie Clip Reel": `<circle cx="36" cy="48" r="12" fill="none" stroke-width="6"/><circle cx="60" cy="48" r="12" fill="none" stroke-width="6"/><path d="M24 48h12M60 48h12" fill="none" stroke-width="6"/>`,
    "Leo's Ethernet": `<rect x="24" y="52" width="48" height="10" rx="3" fill="none" stroke-width="6"/><path d="M30 52V42h36v10" fill="none" stroke-width="6"/>`,
    "Ryan's Hat": `<path d="M24 54c8-18 40-18 48 0" fill="none" stroke-width="6"/><rect x="24" y="54" width="48" height="10" rx="5" fill="none" stroke-width="6"/>`,
    "Lebron": `<circle cx="48" cy="40" r="10" fill="none" stroke-width="6"/><rect x="34" y="52" width="28" height="20" rx="6" fill="none" stroke-width="6"/>`,
    "Pigs's Blanket": `<rect x="26" y="40" width="44" height="22" rx="6" fill="none" stroke-width="6"/><circle cx="34" cy="52" r="4"/>`,
    "Lamborghini": `<path d="M22 56h52l8-12H30z" fill="none" stroke-width="6"/><circle cx="34" cy="62" r="4"/><circle cx="62" cy="62" r="4"/>`,
    "Dean's PC": `<rect x="24" y="28" width="48" height="30" rx="6" fill="none" stroke-width="6"/><rect x="34" y="60" width="28" height="6" rx="3" fill="none" stroke-width="6"/>`,
    "USA": `<path d="M26 42h44M26 50h44M26 58h44" fill="none" stroke-width="6"/><rect x="26" y="34" width="16" height="16" fill="none" stroke-width="6"/>`,
    "China": `<rect x="28" y="34" width="40" height="28" fill="none" stroke-width="6"/><path d="M32 40l4-2 2 4" fill="none" stroke-width="6"/>`,
    "Iron Man's Helmet": `<path d="M32 24h32l8 16v20l-8 12H32L24 60V40z" fill="none" stroke-width="6"/>`,
    "Hanging Tree": `<path d="M30 66V26M30 32h28M58 32v22" fill="none" stroke-width="6"/><path d="M30 26c8-4 16-4 24 0" fill="none" stroke-width="6"/>`,
  "Yellow Unicorn": `<path d="M0 0" opacity="0"/><circle cx="42" cy="52" r="12" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M54 44c4 4 6 10 6 16" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M50 36l10-8" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M46 40l-6-6" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M30 60c8 4 18 4 28 0" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M56 34l8-14" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M36 46h4" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M38 56c2 2 6 2 8 0" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Brown Bison": `<path d="M16 54c6-16 22-26 40-22 12 2 20 10 24 20" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 66h14M44 66h14M64 66h14" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M64 44c6-6 12-8 16-6" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M28 50c-2 4-2 8 2 10" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M46 42c8 0 12 6 12 12" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="50" cy="52" r="2" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="60" cy="52" r="2" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M50 58c4 2 8 2 12 0" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Delta": `<path d="M48 18L78 78H18Z" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M48 18L62 50H34Z" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "JP's Scooter": `<path d="M0 0" opacity="0"/><circle cx="28" cy="66" r="8" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="64" cy="66" r="8" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M32 66h24" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M56 66V40" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M56 40h10l8-8" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M30 58l10-6" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Salmon": `<path d="M20 40c8-10 38-12 52 2s0 30-24 30-36-10-36-20 4-10 8-12" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><ellipse cx="56" cy="56" rx="8" ry="6" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M48 48c8-4 16-2 20 2" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M30 50c4-4 10-6 16-6" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "41": `<g transform="skewX(-10)"><path d="M34 28v16M26 44h16M42 28v30" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M60 28v30M60 28l-8 8" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/></g>`,
  "Siri": `<circle cx="48" cy="48" r="26" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 52c8-8 20-8 28 0s20 8 24 0" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 44c8 8 20 8 28 0s20-8 24 0" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M48 22c0 8 0 44 0 52" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "GTA 6": `<path d="M24 26l24 44 24-44" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M70 26v44" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Pink Guard": `<path d="M0 0" opacity="0"/><path d="M30 70h36l4-24a22 22 0 0 0-44 0z" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><rect x="40" y="42" width="16" height="16" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Bo'ttle o Wa'er": `<path d="M0 0" opacity="0"/><rect x="42" y="28" width="12" height="6" rx="2" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M40 34h16" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><rect x="38" y="34" width="20" height="32" rx="6" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M38 52h20" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Tivon's Bike": `<path d="M0 0" opacity="0"/><circle cx="30" cy="64" r="10" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="66" cy="64" r="10" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M30 64l18-12 12 12" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M48 52l-6-10h12" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M60 52h10" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Harold": `<path d="M0 0" opacity="0"/><circle cx="48" cy="48" r="18" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M40 54c4 2 12 2 16 0" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="42" cy="46" r="2" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="54" cy="46" r="2" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M42 40l-6 4M54 40l6 4" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Super Leo": `<path d="M0 0" opacity="0"/><path d="M24 48l24-18 24 18-24 18z" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M44 40v16h10" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Bambu Lab": `<path d="M0 0" opacity="0"/><rect x="24" y="28" width="48" height="40" rx="4" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M34 36h28v24H34z" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M50 36v24" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M38 54h20" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Adobe": `<path d="M0 0" opacity="0"/><path d="M24 68L48 26l24 42" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M36 68l12-24 12 24" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Willy": `<path d="M30 40h36a10 10 0 0 0-10-10H40a10 10 0 0 0-10 10z" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><ellipse cx="48" cy="56" rx="26" ry="6" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M66 34l10-10" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Oasis": `<path d="M0 0" opacity="0"/><circle cx="72" cy="28" r="8" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M24 68c8-10 24-10 32 0" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M32 68V44" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M28 48l4-8 4 8" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Deck 13?": `<path d="M16 60h48l8-10h8" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M24 54h28M20 50h34" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M36 42h14l4 8" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="26" cy="60" r="2" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="36" cy="60" r="2" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="46" cy="60" r="2" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="56" cy="60" r="2" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M58 40v-6M64 42v-8" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Wheel of Doom": `<circle cx="48" cy="50" r="22" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="48" cy="50" r="4" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M48 28v44M26 50h44M33 35l30 30M63 35l-30 30" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M48 16l6 10h-12z" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Hollywood": `<path d="M8 68l14-8 14 6 16-10 16 12 14-6" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 44v14M20 44v14M12 50h8" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M26 44v14M26 58h8" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M40 44l6 7M52 44l-6 7M46 51v7" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M56 44l4 14 4-10 4 10 4-14" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M72 44v14M72 44h8c6 0 10 4 10 7s-4 7-10 7h-8" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Delorean": `<path d="M0 0" opacity="0"/><path d="M22 58h48l8-12H34z" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="30" cy="62" r="6" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="62" cy="62" r="6" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M50 46h18" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M38 46l-8-8" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Chick-fil-a": `<path d="M28 44c4-8 16-10 24-6 8 4 12 14 8 22-4 8-14 10-22 6-6-4-10-10-10-18" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M32 40c-2-6 4-8 8-6" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M62 40c4-6-4-8-8-6" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M44 56c4 2 8 2 12 0" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="44" cy="50" r="1.5" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="56" cy="50" r="1.5" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "LA": `<path d="M28 34v36M28 66h18" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M56 70V38l12 28M52 50h18" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`,
  "Piccadilly Line": `<path d="M0 0" opacity="0"/><circle cx="48" cy="48" r="22" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><rect x="20" y="44" width="56" height="8" rx="4" fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>`

  };

  function getItemSvg(name, idx, rarity){
    // Prefer file-based icon if we have one for this name
    try {
      if (ITEM_FILE_MAP && ITEM_FILE_MAP[name]) { return ITEM_FILE_MAP[name]; }
    } catch (e) {}
    
    const size = 96;
    const accentByRarity = {
        common:'#8ee78e',
        rare:'#6ec8ff',
        epic:'#c28bff',
        legendary:'#ffd86a',
        legacy:'#ffffff',
        mythic:'#ffd86a',
        unique:'navy',
        exotic:'cyan',
        crypto:'#ff62d5'
    };
    const accent = accentByRarity[rarity] || '#cfd3d7';
    const hue = (idx*53 + (rarity==='legendary'?40:rarity==='epic'?20:0)) % 360;
    const bg = `hsl(${hue} 65% 24%)`;
    const body = ICON_PATHS.hasOwnProperty(name) ? ICON_PATHS[name] : `<circle cx="48" cy="48" r="20" fill="none" stroke-width="6"/>`;
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 96 96">
      <defs>
        <filter id="d${idx}" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.35"/>
        </filter>
      </defs>
      <rect x="4" y="4" width="88" height="88" rx="14" fill="${bg}" />
      <g transform="translate(0,0)" filter="url(#d${idx})" stroke="${accent}">
        ${body}
      </g>
    </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }

  /* Simple egg SVG generator */
  
  /* Simple egg SVG generator (with 'universal' red/blue gradient support) */
  function getEggSvg(eggType, seed){
  try { if (String(eggType).toLowerCase() === 'aqua') return 'icons/eggs/aqua_egg.png'; } catch (e) {}

    const size=96;
    const colorMap = { legendary: '#ffd86a', mythical:'#ff9900', enchanted:'#33cc33' };
    const gradId = `ueg${seed}`;

    const ellipseFill = (eggType==='universal')
      ? `url(#${gradId})`
      : (colorMap[eggType] || '#ddd');

    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 96 96">
      <defs>
        <filter id="eg${seed}" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.35"/>
        </filter>
        ${eggType==='universal' ? `<linearGradient id="${gradId}" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#ff4b5c"/>
          <stop offset="100%" stop-color="#4b6aff"/>
        </linearGradient>` : ``}
      </defs>
      <rect x="4" y="4" width="88" height="88" rx="14" fill="#333" />
      <g filter="url(#eg${seed})">
        <ellipse cx="48" cy="52" rx="22" ry="28" fill="${ellipseFill}" />
        <ellipse cx="40" cy="40" rx="6" ry="4" fill="#fff" opacity="0.65"/>
      </g>
    </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }

function getPetSvg(petName, seed){
  // Normalize filename
  const nameMap = { "Dog": "dog.png",
    "Cat": "cat.png",
    "Dino": "dino.png",
    "Bear": "bear.png",
    "Lion": "lion.png",
    "Gold Dog": "gold_dog.png",
    "Owl": "owl.png",
    "Rainbow Panda": "rainbow_panda.png",
    "Flex T-Rex": "flex_t_rex.png",
    "Lizard": "lizard.png",
    "Alien": "alien.png",
    "Hudson": "hudson.png",
    "Drake": "drake.png",
    "Molly": "molly.png",
    "Flex Dragon": "flex_dragon.png",
    "Rainbow Flex T-Rex": "rainbow_flex_t_rex.png",
    "Rainbow Flex Dragon": "rainbow_flex_dragon.png",
    
  
"Frog": "frog.png",
"Tiger": "tiger.png",
    // Added special redeem-only pet Weston
"Weston": "weston.png",
"Deer": "deer.png",
"Ozzy": "ozzy.png",
"Nella": "nella.png",
"Chloe": "chloe.png",
"Flexicorn": "flexicorn.png",
};
  // --- Aqua Egg pets mapped to explicit PNG files ---
  try { Object.assign(nameMap, {
    'Fish': 'fish.png',
    'Seahorse': 'seahorse.png',
    'Dolphin': 'dolphin.png',
    'Flex Shark': 'flex_shark.png'
  }); } catch(e){}


  const file = nameMap[petName] || null;

  if (file) {
    // âœ… return direct PNG path (adjust folder if needed)
    return `pets/${file}`;
  }

  // ðŸ©¶ fallback placeholder if not found
  const size = 96;
  const hue = (seed * 97) % 360;
  const bg = `hsl(${hue} 60% 35%)`;
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 96 96">
    <rect x="4" y="4" width="88" height="88" rx="14" fill="${bg}" />
    <text x="48" y="58" font-size="14" font-weight="700" text-anchor="middle" fill="#fff">${escapeXml(petName.slice(0,6))}</text>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

  function escapeXml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function displayName(n){ return (n && n.trim()) ? n : 'Mystery'; }

  const LS_KEY = 'flex-save-v1';
  const LOCAL_BACKUP_KEY = 'flex-main-save-v3';
  const LOCAL_BACKUP_PREV = 'flex-main-save-v3-prev';
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const state = {
    money: MONEY_START,
    eps: 0,
    inventory: [],
    stands: [null,null,null,null],
    placed: {},
    selectedItemUid: null,
    fastMode: false,
    shop: { items:[], nextRefreshAt:0 },

    // new pet-related state:
    petPedestalsPurchased: 0,           // 0..2
    petStands: [null,null],             // each entry: null or { uid,name,isEgg,eggType,petType,petEps,svg,baseIdx }
    petTimers: {},                      // map index -> timestamp (ms) when hatch will happen
    permanentPetMultiplier: 1,
    rebirthLevel: 0           // becomes 5 if Flex T-Rex hatched
  };
  // Guard: only allow saving after a full load
  let __loadComplete = false;
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
 const SERVER_BASE = (()=>{  const p=new URLSearchParams(location.search).get('api');  const s=localStorage.getItem('flex_api_base');  const d='https://flex-sdww.onrender.com/api/game';  return p||s||d;})();

// Identify user (for demo, use a prompt and store in localStorage)
// Enhanced username prompt: allow players to request logging into an existing account.
let USER_ID = localStorage.getItem('flex-userid');

  // Flag to track whether we've shown the login choice overlay.  If this is
  // true and no user/pending is set, initLoginAndBoot() will early return
  // until the player makes a selection.
  window.__loginChoiceShown = false;

  /**
   * Display a modal overlay prompting the player to either log in to an
   * existing account or create a new one.  The provided callback will be
   * invoked with either the string `'login'` or `'create'` depending on
   * which button the player clicks.  This helper also marks the
   * `__loginChoiceShown` flag so the boot routine knows to wait.
   *
   * @param {Function} onChoice callback invoked with `'login'` or `'create'`
   */
  function showLoginOptionDialog(onChoice) {
    window.__loginChoiceShown = true;
    const overlay = document.createElement('div');
    overlay.id = 'loginOptionOverlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.65);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;';
    const box = document.createElement('div');
    box.style.cssText = 'background:#fff;color:#222;padding:20px 30px;border-radius:8px;max-width:90%;text-align:center;font-family:Russo One, sans-serif;box-shadow:0 4px 10px rgba(0,0,0,0.3)';
    box.innerHTML = '<h2 style="margin-top:0">Welcome to Flex!</h2>' +
      '<p style="margin:10px 0 20px;font-family:Rajdhani, sans-serif;font-size:16px;">Do you already have an existing account?</p>';
    const btnContainer = document.createElement('div');
    btnContainer.style.cssText = 'display:flex;justify-content:center;gap:20px;';
    const loginBtn = document.createElement('button');
    loginBtn.textContent = 'Log In';
    loginBtn.style.cssText = 'padding:10px 20px;font-size:16px;border-radius:5px;border:none;cursor:pointer;background:#4CAF50;color:#fff;font-family:Russo One, sans-serif;';
    const createBtn = document.createElement('button');
    createBtn.textContent = 'New Account';
    createBtn.style.cssText = 'padding:10px 20px;font-size:16px;border-radius:5px;border:none;cursor:pointer;background:#2196F3;color:#fff;font-family:Russo One, sans-serif;';
    loginBtn.addEventListener('click', () => {
      document.body.removeChild(overlay);
      window.__loginChoiceShown = false;
      if (typeof onChoice === 'function') onChoice('login');
    });
    createBtn.addEventListener('click', () => {
      document.body.removeChild(overlay);
      window.__loginChoiceShown = false;
      if (typeof onChoice === 'function') onChoice('create');
    });
    btnContainer.appendChild(loginBtn);
    btnContainer.appendChild(createBtn);
    box.appendChild(btnContainer);
    overlay.appendChild(box);
    document.body.appendChild(overlay);
  }

  // Track whether a pending-login overlay is active. When true, initLoginAndBoot()
  // will not re-run its pending-check alert.
  window.__pendingOverlayShown = false;

  /* ====== Remote login-request helpers ======
   * These helpers use the same game API used for save/load to store login requests
   * and approvals on the server.  This avoids relying on localStorage across
   * different HTML files (file:/// origins), which can prevent admin pages from
   * seeing requests created by the game.  Requests are stored under the
   * pseudoâ€‘user "__login_requests__" as an array of usernames.  Individual
   * approvals are stored under "__login_approved_<username>" as an object
   * like { approved:true }.  When a request is approved or cancelled it is
   * removed from the list.
   */
  async function fetchLoginRequests() {
    try {
      const res = await fetch(`${SERVER_BASE}/load?user=${encodeURIComponent('__login_requests__')}`, { cache:'no-store' });
      if (res && res.ok) {
        const data = await res.json().catch(() => null);
        return Array.isArray(data) ? data : [];
      }
    } catch (e) {}
    return [];
  }
  async function addLoginRequest(name) {
    try {
      const list = await fetchLoginRequests();
      if (!list.includes(name)) list.push(name);
      await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent('__login_requests__')}`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(list)
      });
    } catch (e) {}
  }
  async function removeLoginRequest(name) {
    try {
      let list = await fetchLoginRequests();
      list = list.filter(u => u !== name);
      await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent('__login_requests__')}`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(list)
      });
    } catch (e) {}
  }
  async function checkApproval(name) {
    try {
      const res = await fetch(`${SERVER_BASE}/load?user=${encodeURIComponent('__login_approved_' + name)}`, { cache:'no-store' });
      if (res && res.ok) {
        const data = await res.json().catch(() => null);
        return data && data.approved;
      }
    } catch (e) {}
    return false;
  }
  async function setApproval(name) {
    try {
      await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent('__login_approved_' + name)}`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ approved:true })
      });
    } catch (e) {}
  }
  async function clearApproval(name) {
    try {
      await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent('__login_approved_' + name)}`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: '{}' // mark as empty object
      });
    } catch (e) {}
  }

  /**
   * Display an overlay informing the player that their login request has been
   * submitted.  Provides a Cancel button that removes the request from the
   * server and local storage, then re-displays the login/new-account menu.  A
   * manual refresh is still needed once the owner has approved.  The overlay
   * sets __pendingOverlayShown to true so the boot routine doesnâ€™t show an
   * additional alert.
   *
   * @param {string} username the pending username
   */
  function showPendingLoginOverlay(username) {
    window.__pendingOverlayShown = true;
    const overlay = document.createElement('div');
    overlay.id = 'loginPendingOverlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.65);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;';
    const box = document.createElement('div');
    box.style.cssText = 'background:#fff;color:#222;padding:20px 30px;border-radius:8px;max-width:90%;text-align:center;font-family:Russo One, sans-serif;box-shadow:0 4px 10px rgba(0,0,0,0.3)';
    box.innerHTML = '<h2 style="margin-top:0">Login Request Sent</h2>' +
      '<p style="margin:10px 0 20px;font-family:Rajdhani, sans-serif;font-size:16px;">Your request to log into <strong>' + username.replace(/</g,'&lt;') + '</strong> has been sent.\nAsk the owner to approve it.\n\nOnce approved, refresh this page.\n\nYou can also cancel the request below.</p>';
    const btnContainer = document.createElement('div');
    btnContainer.style.cssText = 'display:flex;justify-content:center;gap:20px;';
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancel Request';
    cancelBtn.style.cssText = 'padding:10px 20px;font-size:16px;border-radius:5px;border:none;cursor:pointer;background:#f44336;color:#fff;font-family:Russo One, sans-serif;';
    cancelBtn.addEventListener('click', async () => {
      document.body.removeChild(overlay);
      window.__pendingOverlayShown = false;
      // remove from server and local state
      try { await removeLoginRequest(username); } catch(e){}
      localStorage.removeItem('flex_login_pending');
      // show login/new-account menu again
      showLoginOptionDialog(async (choice) => {
        if (choice === 'login') {
          // re-run login flow
          while (true) {
            let input = prompt('Enter your exact username to request login:');
            if (input === null) { alert('You must enter your username to request login.'); continue; }
            input = String(input).trim();
            if (!input) { alert('Please enter a non-empty username.'); continue; }
            localStorage.setItem('flex_login_pending', input);
            try { await addLoginRequest(input); } catch(e){}
            // show this overlay again
            USER_ID = null;
            const ud = document.getElementById("userDisplay");
            if (ud) ud.textContent = 'No user';
            showPendingLoginOverlay(input);
            break;
          }
        } else {
          // handle new account creation on cancel
          while (true) {
            let input = prompt('Enter a username to play (required).');
            if (input === null) { alert('A username is required.'); continue; }
            input = String(input).trim();
            if (!input || input.toLowerCase() === 'guest') { alert('Please enter a non-empty username. "guest" is not allowed.'); continue; }
            USER_ID = input;
            localStorage.setItem('flex-userid', USER_ID);
            try { sessionStorage.setItem('flex-userid-just-set','1'); } catch(e){}
            const ud = document.getElementById("userDisplay");
            if (ud) ud.textContent = USER_ID ? `User: ${USER_ID}` : 'No user';
            // boot game normally
            if (typeof initLoginAndBoot === 'function') initLoginAndBoot();
            break;
          }
        }
      });
    });
    btnContainer.appendChild(cancelBtn);
    box.appendChild(btnContainer);
    overlay.appendChild(box);
    document.body.appendChild(overlay);
  }
/*
 * We support two flows when a user first visits the game:
 *  1. Create a brand new account by picking a unique username.
 *  2. Request to log into an existing account (for example, if the player reset their computer or browser).
 *
 * Login requests are stored in localStorage under "flex_login_requests" as a JSON array. The owner/Admin
 * uses a separate admin page to approve these requests. Once approved, the admin page writes a key of the
 * form "flex_login_approved_<username>" with value "1" back into localStorage. This page periodically
 * checks for approval and, once granted, assigns USER_ID and continues loading the player's data.
 *
 * If a login request has been submitted by this browser (key: "flex_login_pending"), we hold off on prompting
 * again and instead wait for approval.
 */
if (!USER_ID) {
  const pendingLogin = localStorage.getItem('flex_login_pending');
  if (!pendingLogin) {
    // Present a friendly overlay with buttons for login or account creation instead of using confirm().
    showLoginOptionDialog(async function(choice) {
      if (choice === 'login') {
        // Prompt for the exact username and register a login request via the server.
        while (true) {
          let input = prompt('Enter your exact username to request login:');
          if (input === null) {
            alert('You must enter your username to request login.');
            continue;
          }
          input = String(input).trim();
          if (!input) {
            alert('Please enter a non-empty username.');
            continue;
          }
          // Save the pending request for this browser and push the request to the remote list.
          localStorage.setItem('flex_login_pending', input);
          try { await addLoginRequest(input); } catch (e) {}
          // Clear current user and update display
          USER_ID = null;
          const ud = document.getElementById("userDisplay");
          if (ud) ud.textContent = 'No user';
          // Show a pending overlay with a cancel option; do not immediately boot.
          showPendingLoginOverlay(input);
          break;
        }
      } else {
        // Create a new username (no empty values or "guest").
        while (true) {
          let input = prompt('Enter a username to play (required).');
          if (input === null) {
            alert('A username is required.');
            continue;
          }
          input = String(input).trim();
          if (!input || input.toLowerCase() === 'guest') {
            alert('Please enter a non-empty username. "guest" is not allowed.');
            continue;
          }
          USER_ID = input;
          localStorage.setItem('flex-userid', USER_ID);
          // Mark that we just set a username this session so load() can check uniqueness once.
          try { sessionStorage.setItem('flex-userid-just-set', '1'); } catch (e) {}
          break;
        }
        // Update display and start the boot process now that we have a username
        const ud = document.getElementById("userDisplay");
        if (ud) ud.textContent = USER_ID ? `User: ${USER_ID}` : 'No user';
        if (typeof initLoginAndBoot === 'function') initLoginAndBoot();
      }
    });
  } else {
    // The player has already requested a login but it hasn't been approved yet.
    USER_ID = null;
  }
}
// Update user display. If USER_ID is null (pending login), show a placeholder.
document.getElementById("userDisplay").textContent = USER_ID ? `User: ${USER_ID}` : "No user";

let __saveTimer = null;
async function save(){
  // If we have not loaded a save yet, do not write anything (prevents reset if user spam-refreshes)
  if(!__loadComplete){ return; }
  if(__saveTimer){ clearTimeout(__saveTimer); }
  // Batch saves occurring within 400ms
  await new Promise(r=>{ __saveTimer = setTimeout(()=>{ __saveTimer=null; r(); }, 400); });

  // Write a fast local backup first so spam-refresh can't wipe state
  const __nowTs = Date.now();

  const payload = {
    money: state.money,
    eps: state.eps,
    // Persist morph states on each inventory item.  In addition to Hollywood we also
    // persist Aqua and Demon flags so morphs survive a page reload.  Keep other
    // fields identical to the source item.
    inventory: state.inventory.map(it=>({
      svg: it.svg,
      uid: it.uid,
      name: it.name,
      rarity: it.rarity,
      price: it.price,
      baseIdx: it.baseIdx,
      isEgg: it.isEgg,
      eggType: it.eggType,
      petType: it.petType,
      petEps: it.petEps,
      hollywood: !!it.hollywood,
      aqua: !!it.aqua,
      demon: !!it.demon,
    })),
    stands: state.stands,
    shop: state.shop,
    fastMode: state.fastMode,
    multiplierLevel,
    multiplierActiveUntil,
    multiplierCooldownUntil,
    backgroundPurchased,
    backgroundEnabled,
    redMoneyPurchased,
    redMoneyEnabled,

    placed: {},
    petPedestalsPurchased: state.petPedestalsPurchased,
    petStands: {}, // serialized by index
    petTimers: state.petTimers,
    permanentPetMultiplier: state.permanentPetMultiplier,
    petDex: (state.petDex || {}),
    rebirthLevel: state.rebirthLevel || 0,
    // Persist unlocked backgrounds, selected background and achievements (quests) to the server.  These
    // were previously only stored in localStorage via the addon, but now we include them in the
    // remote save so they travel with the user across browsers.
    unlockedBackgrounds: state.unlockedBackgrounds || {},
    selectedBackground: state.selectedBackground || 'default',
    ach: state.ach || { questsDone: {} },
    pedestalSkins: state.pedestalSkins || { default:true, red: !!((state.ach||{}).redPedestalUnlocked) },
    selectedPedestalSkin: state.selectedPedestalSkin || 'default',
    upsideDown: state.upsideDown || { purchases:0, earned:0, hatchedDemo:false, completed:false },
    winterGifts: (state.winterGifts || {forge:0,hatch:0,legacyPurchases:0,uniquePurchases:0,gift:{},blizzardActive:false,pendingRewards:[]}),
    brewer: (state.brewer || { owned:false, active:null }),
    activePotions: (state.activePotions || { multiplier: { until:0, factor:1 }, shopLuckUntil: 0, fastHatchUntil: 0 }),
  };
  for(const k in state.placed){
    const it = state.placed[k];
    if(it) {
      // Persist all morph flags for placed items: demon, hollywood and aqua
      payload.placed[k] = {
        uid: it.uid,
        name: it.name,
        rarity: it.rarity,
        price: it.price,
        baseIdx: it.baseIdx,
        demon: !!it.demon,
        hollywood: !!it.hollywood,
        aqua: !!it.aqua,
        svg: it.svg
      };
    }
  }
  // serialize pet stands
  state.petStands.forEach((ps, idx) => {
    if(ps) payload.petStands[idx] = { uid:ps.uid, name:ps.name, isEgg:!!ps.isEgg, eggType:ps.eggType||null, petType:ps.petType||null, petEps:ps.petEps||0, svg:ps.svg, baseIdx: ps.baseIdx||0 };
  });

    // include Flex Pass progress
    try{
      payload.flexPass = state.flexPass || { level: 1, xp: 0, claimed: {} };
    }catch(e){}
    // --- Flexwood (event) progress & Hollywood/Aqua/Demon morph flags ---
    try{
      payload.flexwood = state.flexwood || {
        top1: { purchases:0, claimed:false },
        top2: { x6Brewed:0, claimed:false },
        top3: { unlocked:false, claimed:false },
        bot1: { rarePurchases:0, claimed:false },
        bot2: { levelReached:false, claimed:false },
        bot3: { unlocked:false, claimed:false }
      };
      if(Array.isArray(payload.inventory)){
        payload.inventory.forEach((row, idx) => {
          const src = (state.inventory||[])[idx];
          // Copy morph flags from the live item to the serialized row. Persist hollywood,
          // aqua and demon flags for each inventory entry.
          row.hollywood = !!(src && src.hollywood);
          row.aqua      = !!(src && src.aqua);
          row.demon     = !!(src && src.demon);
        });
      }
      if(payload.placed && state.placed){
        for(const k in payload.placed){
          const src = state.placed[k];
          if(src){
            payload.placed[k].hollywood = !!src.hollywood;
            payload.placed[k].aqua      = !!src.aqua;
            payload.placed[k].demon     = !!src.demon;
          }
        }
      }
    }catch(e){}
// add timestamp and local backup
  try {
    payload.__ts = __nowTs;
    try {
      const cur = localStorage.getItem(LOCAL_BACKUP_KEY);
      if (cur) { try { localStorage.setItem(LOCAL_BACKUP_PREV, cur); } catch(e){} }
      localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify({ ts: payload.__ts, data: payload }));
    } catch (e) {}
    // If we haven't finished loading yet, don't touch the server to avoid wiping with defaults
    if (!__loadComplete) { return; }
    await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent(USER_ID)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
  } catch (e) {
    console.error('Failed to save game:', e);
  }
  await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent(USER_ID)}`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(payload),
  keepalive: true
});
}

async function load() {
  try{ window.__isFirstTimePlayer = false; }catch(e){}

  // Local backup candidate (mirrors how achievements/backgrounds persist)
  let __localCandidate = null;
  try {
    if (sessionStorage.getItem('doGameReset') === '1') {
      try { localStorage.removeItem(LOCAL_BACKUP_KEY); } catch (e) {}
      sessionStorage.removeItem('doGameReset');
    } else {
      const raw = localStorage.getItem(LOCAL_BACKUP_KEY);
      if (raw) { const obj = JSON.parse(raw); __localCandidate = obj && (obj.data || null); }
      // Also check a previous backup for safety
      let __localPrev = null; try{ const p = localStorage.getItem(LOCAL_BACKUP_PREV); if(p){ const pobj = JSON.parse(p); __localPrev = pobj && (pobj.data || null); } }catch(e){}
    }
  } catch (e) {}

  try {
    let dat = null;
    let res = null;
    try {
  res = await fetch(`${SERVER_BASE}/load?user=${encodeURIComponent(USER_ID)}`, { cache: 'no-store' });
} catch (e) {
  res = null;
}
    if (res && res.ok) { dat = await res.json(); } else { dat = __localCandidate; }
    // If the server returns nothing/empty, prefer the local backup
const isEmpty = !dat || (typeof dat === 'object' && Object.keys(dat).length === 0);
if (isEmpty && __localCandidate) dat = __localCandidate;
    
      // --- Username availability check (runs BEFORE creating a fresh save) ---
      try {
        const __justSet = sessionStorage.getItem('flex-userid-just-set') === '1';
        if (__justSet && USER_ID) {
          // If server (or fallback) returned data for this username, treat it as taken and re-prompt.
          const __hasServerSave = dat && typeof dat === 'object' && Object.keys(dat).length > 0;
          if (__hasServerSave) {
            alert('That username is already taken. Please choose another.');
            while (true) {
              const input = prompt('Enter a different username (required).');
              if (input === null) { alert('A username is required.'); continue; }
              const trimmed = String(input).trim();
              if (!trimmed || trimmed.toLowerCase() === 'guest') {
                alert('Please enter a non-empty username. "guest" is not allowed.');
                continue;
              }
              // Check new name directly against the server (best effort)
              try {
                const chk = await fetch(`${SERVER_BASE}/load?user=${encodeURIComponent(trimmed)}`, { cache: 'no-store' });
                const j = chk && chk.ok ? await chk.json().catch(()=>null) : null;
                if (j && Object.keys(j).length) {
                  alert('That username is already taken. Try again.');
                  continue;
                }
              } catch (e) { /* ignore network error: allow name to keep game playable */ }
              USER_ID = trimmed;
              try { localStorage.setItem('flex-userid', USER_ID); } catch (e) {}
              const ud = document.getElementById('userDisplay');
              if (ud) ud.textContent = USER_ID ? `User: ${USER_ID}` : 'No user';
              try { sessionStorage.removeItem('flex-userid-just-set'); } catch (e) {}
              // Re-run load under the new username
              return await load();
            }
          } else {
            // Name is free; clear the flag so later uniqueness guard doesn't misfire.
            try { sessionStorage.removeItem('flex-userid-just-set'); } catch (e) {}
          }
        }
      } catch (e) {/* no-op */}

      if (!dat) {
  // First-time player: create a brand new save on the server and locally
  const fresh = {
    money: (typeof state !== 'undefined' && typeof state.money === 'number') ? state.money : (typeof MONEY_START !== 'undefined' ? MONEY_START : 0),
    eps: 0,
    inventory: [],
    stands: (typeof STAND_COUNT !== 'undefined' && Number(STAND_COUNT)) ? Array(STAND_COUNT).fill(null) : [null,null,null,null],
    shop: { items: [], nextRefreshAt: 0 },
    fastMode: false,
    multiplierLevel: 1,
    multiplierActiveUntil: 0,
    multiplierCooldownUntil: 0,
    backgroundPurchased: false,
    backgroundEnabled: false,
    redMoneyPurchased: false,
    redMoneyEnabled: false,
    placed: {},
    petPedestalsPurchased: 0,
    petStands: {},
    petTimers: {},
    permanentPetMultiplier: 1,
    petDex: {},
    rebirthLevel: 0,
    brewer: { owned:false, active:null },
    activePotions: { multiplier:{until:0, factor:1}, shopLuckUntil:0, fastHatchUntil:0 },
    __ts: Date.now()
  };
  dat = fresh;
  try{ window.__isFirstTimePlayer = true; }catch(e){}

  try {
    localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify({ ts: fresh.__ts, data: fresh }));
  } catch(e) {}
  try {
    await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent(USER_ID)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(fresh)
    });
  } catch (e) {
    console.warn('Initial save create failed', e);
  }
}
    // Prefer the best of: server, local current, local prev
    try {
      const ldat = __localCandidate;
      const pdat = __localPrev;
      const lts = (ldat && ldat.__ts) ? ldat.__ts : 0;
      const pts = (pdat && pdat.__ts) ? pdat.__ts : 0;
      const sts = (dat && dat.__ts) ? dat.__ts : 0;
      const richness = d => !d ? -1 : ((d.inventory||[]).length) + (Array.isArray(d.stands)? d.stands.filter(Boolean).length : 0) * 2 + (d.petStands ? Object.keys(d.petStands).length : 0);
      let cand = dat; let cts = sts;
      if (ldat && ((lts > cts) || (lts === cts && richness(ldat) > richness(cand)))) { cand = ldat; cts = lts; }
      if (pdat && ((pts > cts) || (pts === cts && richness(pdat) > richness(cand)))) { cand = pdat; cts = pts; }
      // Integrity check: if candidate looks empty while another has meaningful progress, choose the richer one
      const looksEmpty = d => !d || (((d.inventory||[]).length===0) && (!d.money || d.money <= 1000000) && (!d.stands || d.stands.filter(Boolean).length===0));
      if (looksEmpty(cand)){
        const opts = [dat, ldat, pdat].filter(Boolean);
        let best = cand;
        for (const o of opts){ if (richness(o) > richness(best)) best = o; }
        cand = best || cand;
      }
      dat = cand;
    } catch (e) {}
// If this is the very first time we set a username this session and it's already in use on the server,
            // re-prompt until they choose a free, non-empty name (no "guest").
            try {
              const justSet = sessionStorage.getItem('flex-userid-just-set') === '1';
              if (justSet && USER_ID) {
                const hasServerSave = dat && typeof dat === 'object' && Object.keys(dat).length > 0;
                if (hasServerSave) {
                  alert('That username is already taken. Please choose another.');
                  while (true) {
                    const input = prompt('Enter a different username (required).');
                    if (input === null) { alert('A username is required.'); continue; }
                    const trimmed = String(input).trim();
                    if (!trimmed || trimmed.toLowerCase() === 'guest') {
                      alert('Please enter a non-empty username. "guest" is not allowed.');
                      continue;
                    }
                    // Check the new name against the server (best effort)
                    try {
                      const chk = await fetch(`${SERVER_BASE}/load?user=${encodeURIComponent(trimmed)}`, { cache: 'no-store' });
                      const j = chk.ok ? await chk.json().catch(()=>null) : null;
                      if (j && Object.keys(j).length) {
                        alert('That username is already taken. Try again.');
                        continue;
                      }
                    } catch (e) {
                      // Network check failed; accept the name to keep the game playable
                    }
                    USER_ID = trimmed;
                    localStorage.setItem('flex-userid', USER_ID);
                    const ud = document.getElementById("userDisplay");
                    if (ud) ud.textContent = USER_ID ? `User: ${USER_ID}` : "No user";
                    sessionStorage.removeItem('flex-userid-just-set');
                    // Re-run load under the new USER_ID and stop processing the old data
                    return await load();
                  }
                }
              }
              // Either not first set this session or name wasn't taken; clear the marker.
              sessionStorage.removeItem('flex-userid-just-set');
            } catch (e) {
              // ignore
            }state.money = dat.money ?? state.money;
    state.eps = dat.eps ?? state.eps;
    // Rebuild the inventory array from the loaded data.  If an item lacks
    // a proper PNG path in its `svg` field (either missing, an inline
    // `<svg>` string from an older save, or a nonâ€‘PNG), override it using
    // our ITEM_FILE_MAP or the appropriate helper (egg/pet/item).  This
    // ensures legacy saves and unobtainable items show the correct icon
    // immediately on load.
    state.inventory = (dat.inventory || []).map(it => {
      const name = it.name;
    // Restore Flexwood event progress and Hollywood flags
    try{ state.flexwood = (dat.flexwood || state.flexwood || {
      top1:{purchases:0,claimed:false}, top2:{x6Brewed:0,claimed:false}, top3:{unlocked:false,claimed:false},
      bot1:{rarePurchases:0,claimed:false}, bot2:{levelReached:false,claimed:false}, bot3:{unlocked:false,claimed:false}
    }); }catch(e){}
    try{
      // Restore morph flags for inventory items.  If the saved row has a Hollywood,
      // Aqua or Demon flag set, copy it back onto the inâ€‘memory item.  This ensures
      // morph rings and tags persist when reloading a saved game.
      (dat.inventory||[]).forEach((row, idx) => {
        if(row && state.inventory[idx]){
          if(row.hollywood) state.inventory[idx].hollywood = !!row.hollywood;
          if(row.aqua)      state.inventory[idx].aqua      = !!row.aqua;
          if(row.demon)     state.inventory[idx].demon     = !!row.demon;
        }
      });
    }catch(e){}

      let icon = it.svg;
      // Normalize the saved svg: ignore inline SVG strings or nonâ€‘PNG
      const isPng = (typeof icon === 'string' && /\.png($|\?)/i.test(icon));
      const looksInlineSvg = (typeof icon === 'string' && icon.trim().startsWith('<'));
      // Use a normalized key for lookup (trim + lowercase) so we catch names
      // with different casing or stray whitespace.
      const nameKey = name ? name.trim().toLowerCase() : '';
      if (!icon || looksInlineSvg || !isPng) {
        // If we have an explicit file path mapping (case sensitive or lowercase), use it
        if (ITEM_FILE_MAP && (ITEM_FILE_MAP[name] || ITEM_FILE_MAP[nameKey])) {
          icon = ITEM_FILE_MAP[name] || ITEM_FILE_MAP[nameKey];
        } else if (it.isEgg) {
          // Eggs use the special egg SVG generator
          icon = getEggSvg(it.eggType || 'legendary', Math.floor(Math.random() * 9999));
        } else if (it.petType) {
          // Pets should be resolved via getPetSvg.  Only call getPetSvg
          // for true pet items; non-pet items without a mapping should
          // fall back to the generated item SVG instead of a random pet
          // background.  See https://github.com/lucasmoviesstudios24/flex
          // for details on petType usage.
          try {
            icon = getPetSvg(it.petType || it.name, Math.floor(Math.random() * 9999));
          } catch (e) {
            // As a fallback, generate a standard item SVG rather than using a pet icon
            icon = getItemSvg(name, it.baseIdx || 0, it.rarity);
          }
        } else {
          // Fallback to generated SVG
          icon = getItemSvg(name, it.baseIdx || 0, it.rarity);
        }
      }
      return {
        ...it,
        uid: it.uid,
        svg: icon,
        baseIdx: it.baseIdx || 0
      };
    });
    state.stands = dat.stands ?? state.stands;
    state.shop = dat.shop ?? state.shop;
    state.fastMode = dat.fastMode ?? state.fastMode;
    state.placed = {};
    // NEW Gear persistence
    multiplierLevel = dat.multiplierLevel ?? 1;
    multiplierActiveUntil = dat.multiplierActiveUntil ?? 0;
    multiplierCooldownUntil = dat.multiplierCooldownUntil ?? 0;
    backgroundPurchased = dat.backgroundPurchased ?? false;
    backgroundEnabled = dat.backgroundEnabled ?? false;

    // Red Money
    redMoneyPurchased = dat.redMoneyPurchased ?? false;
    redMoneyEnabled = dat.redMoneyEnabled ?? false;
    if(redMoneyEnabled){ document.body.classList.add('money-red'); }

    if (backgroundPurchased) {
       document.getElementById("buyBackground").style.display = "none";
      document.getElementById("toggleBackground").style.display = "inline-block";
    }
    if (backgroundEnabled) {
      document.body.classList.add("redblue");
    }

    if(dat.placed){
      try{
        // Restore morph flags for placed items.  Copy Hollywood, Aqua and Demon flags
        // onto the current inâ€‘memory placed items to keep their morph state across
        // sessions.  Guard against missing state.placed entries.
        for(const k in dat.placed){
          const r = dat.placed[k];
          if(r && state.placed[k]){
            if(r.hollywood) state.placed[k].hollywood = !!r.hollywood;
            if(r.aqua)      state.placed[k].aqua      = !!r.aqua;
            if(r.demon)     state.placed[k].demon     = !!r.demon;
          }
        }
      }catch(e){}

      for(const k in dat.placed){
        const it = dat.placed[k];
        {
          const name = it.name;
          let icon = it.svg;
          const isPng = (typeof icon === 'string' && /\.png($|\?)/i.test(icon));
          const looksInlineSvg = (typeof icon === 'string' && icon.trim().startsWith('<'));
          const nameKey = name ? name.trim().toLowerCase() : '';
          if (!icon || looksInlineSvg || !isPng) {
            if (window.ITEM_FILE_MAP && (ITEM_FILE_MAP[name] || ITEM_FILE_MAP[nameKey])) {
              icon = ITEM_FILE_MAP[name] || ITEM_FILE_MAP[nameKey];
            } else if (it.isEgg) {
              icon = getEggSvg(it.eggType || 'legendary', Math.floor(Math.random() * 9999));
            } else if (it.petType) {
              try {
                icon = getPetSvg(it.petType || name, Math.floor(Math.random() * 9999));
              } catch (e) {
                icon = getItemSvg(name, it.baseIdx || 0, it.rarity);
              }
            } else {
              icon = getItemSvg(name, it.baseIdx || 0, it.rarity);
            }
          }
          state.placed[k] = { ...it, uid: it.uid, svg: icon, baseIdx: it.baseIdx || 0 };
        }
      }
    }

    // load pet stuff
    state.petPedestalsPurchased = dat.petPedestalsPurchased ?? state.petPedestalsPurchased;
    if(dat.petStands){
      for(const k in dat.petStands){
        const p = dat.petStands[k];
        state.petStands[Number(k)] = {
          uid: p.uid,
          name: p.name,
          isEgg: !!p.isEgg,
          eggType: p.eggType || null,
          petType: p.petType || null,
          petEps: p.petEps || 0,
          svg: p.svg || (p.isEgg ? getEggSvg(p.eggType||'legendary', Number(k)+Math.floor(Math.random()*9999)) : getPetSvg(p.petType||p.name, Number(k)+Math.floor(Math.random()*9999))),
          baseIdx: p.baseIdx||0
        };
      }
    }
    state.petTimers = dat.petTimers ?? state.petTimers;
    state.permanentPetMultiplier = dat.permanentPetMultiplier ?? state.permanentPetMultiplier;
    state.rebirthLevel = dat.rebirthLevel || 0;
    // PetDex (owned pets across eggs)
    state.petDex = dat.petDex || state.petDex || {};
// --- Potion Brewer ownership + potion timers (persisted) ---
try {
  state.brewer = dat.brewer || state.brewer || { owned:false, active:null };
  // --- Promote local Brewer ownership to server if needed ---
  try {
    // Read sticky local flag (if present) and promote to runtime
    let __localOwned = false;
    try {
      if (typeof lsKey === 'function') { __localOwned = (localStorage.getItem(lsKey()) === '1'); }
    } catch(_) {}
    if (__localOwned && state.brewer && !state.brewer.owned) {
      state.brewer.owned = true;
      try{ if (typeof writeOwned === 'function') writeOwned(true);       try{ document.dispatchEvent(new CustomEvent('brewer:purchased')); }catch(_){}
}catch(_){}
      try{ if (typeof save === 'function') save(); }catch(_){}
    }
  } catch (_) {}

  state.activePotions = dat.activePotions || state.activePotions || { multiplier:{ until:0, factor:1 }, shopLuckUntil:0, fastHatchUntil:0 };
} catch (e) {}
// Reflect UI (disable purchase button / show open button) after load
try { if (state.brewer && state.brewer.owned){ try{ ensureBrewButtonVisible(); }catch(e){} try{ showBrewButton(); }catch(e){} } } catch (e) {}
try { if (typeof refreshBuyButton === 'function') refreshBuyButton(); } catch (e) {}

    state.unlockedBackgrounds = dat.unlockedBackgrounds || state.unlockedBackgrounds || { default:true };
    state.selectedBackground = dat.selectedBackground || state.selectedBackground || 'default';
// --- Winter Gifts (persisted) ---
(function ensureWG() {
  try {
    const DEF = {forge:0,hatch:0,legacyPurchases:0,uniquePurchases:0,gift:{},blizzardActive:false,pendingRewards:[]};
    if (dat && dat.winterGifts && typeof dat.winterGifts === 'object') {
      state.winterGifts = Object.assign({}, DEF, state.winterGifts||{}, dat.winterGifts);
    } else {
      state.winterGifts = Object.assign({}, DEF, state.winterGifts||{});
    }
  } catch (e) {}
})();

    // --- Flex Pass (persisted) ---
    try {
      state.flexPass = dat.flexPass || state.flexPass || { level: 1, xp: 0, claimed: {} };
    } catch (e) {}

    state.pedestalSkins = dat.pedestalSkins || state.pedestalSkins || { default:true, red: !!((state.ach||{}).redPedestalUnlocked), aqua: !!((state.ach||{}).aquaPedestalUnlocked) };
    state.selectedPedestalSkin = dat.selectedPedestalSkin || state.selectedPedestalSkin || 'default';
    state.upsideDown = dat.upsideDown || state.upsideDown || { purchases:0, earned:0, hatchedDemo:false, completed:false };
// Merge achievements/quests from the remote save.  Previously, quest completions were
    // only stored locally via the addon, so merge them carefully to preserve any existing
    // progress in state.ach.  Include flags such as pet pedestal and pet unlocks when present.
    if (dat.ach) {
      state.ach = state.ach || { questsDone: {} };
      state.ach.questsDone = { ...(state.ach.questsDone || {}), ...(dat.ach.questsDone || {}) };
      if (dat.ach.petPedestalGranted) state.ach.petPedestalGranted = dat.ach.petPedestalGranted;
      if (dat.ach.petThirdUnlocked) state.ach.petThirdUnlocked = dat.ach.petThirdUnlocked;
      if (dat.ach.petFourthUnlocked) state.ach.petFourthUnlocked = dat.ach.petFourthUnlocked;
    }
    // Update local backup with the chosen data so rapid refresh can't regress
    try { localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify({ ts: dat.__ts || Date.now(), data: dat })); } catch (e) {}
  } catch (e) {
    console.warn("load failed", e);
  }
    // Mark load complete so future saves can hit the server safely
    __loadComplete = true;

    // If a brewer purchase happened before load completed, flush to server now
    try{
      const __pendingKey = 'flex_brewer_pending_server_save__' + (typeof getPlayerId==='function' ? getPlayerId() : (state.username||state.userName||'default'));
      if (localStorage.getItem(__pendingKey) === '1'){
        try{ if (readOwned && readOwned()) state.brewer = state.brewer || {}, state.brewer.owned = true; }catch(_){}
        try{ if (typeof save==='function') save(); }catch(_){}
        try{ localStorage.removeItem(__pendingKey); }catch(_){}
      }
    }catch(_){}


    try{ window.__flexRefresh && window.__flexRefresh(); }catch(e){}

}
  function fmt(n){ return n.toLocaleString(undefined,{maximumFractionDigits:0}); }
// Safely update the top-of-screen money and EPS displays.  Each DOM element
// lookup is guarded so that missing elements won't throw errors and freeze
// the game loop.  The multiplier badge update is also optional.
function updateTop(){
try{
  if (typeof window.updateTop === 'function' && !window.updateTop.__moneyEventPatched){
    const __origUT = window.updateTop;
    window.updateTop = function(){
      const r = __origUT.apply(this, arguments);
      try{ document.dispatchEvent(new CustomEvent('money:update')); }catch(e){}
      return r;
    };
    window.updateTop.__moneyEventPatched = true;
  }
}catch(e){}

  try{
    const cashEl = $('#cash');
    if (cashEl) {
      cashEl.textContent = '$' + fmt(Math.max(0, Math.floor(state.money)));
    }
    const epsEl = $('#eps');
    if (epsEl) {
      epsEl.textContent = '+ $' + fmt(state.eps) + ' / sec';
    }
    if (typeof updateMultiplierBadge === 'function') {
      updateMultiplierBadge();
    }
  }catch(e){
    console.error('updateTop caught error:', e);
  }
}
function recalcEPS(){
  // Recalculate base EPS without multiplier; tolerant to uppercase/missing rarities
  let baseTotal = 0;

  state.stands.forEach(uid => {
    if(!uid) return;
    const it = state.placed[uid] || state.inventory.find(x => x.uid === uid);
    if(!it) return;
    
    console.log('EPS item check:', it.name, it.rarity);  // <--- ADD THIS
    
    const key = String(it.rarity || 'common').toLowerCase();
    const incomeVal = (RARITY[key] && Number(RARITY[key].income)) ? Number(RARITY[key].income) : 0;
    if(!RARITY[key]) console.warn('recalcEPS: unknown rarity for item', it.name, 'rarity:', it.rarity);
    baseTotal += incomeVal;
  try{ if(it && it.hollywood){ baseTotal += 35000; } }catch(e){} });

  // Sum pet EPS (unchanged but coerced to number)
  let petTotal = 0;
  state.petStands.forEach(ps => {
    if(!ps) return;
    if(ps.petEps) petTotal += Number(ps.petEps) || 0;
  });

  // Combine and apply multipliers safely
  let combined = (Number(baseTotal) || 0) + (Number(petTotal) || 0);
  combined = combined * (Number(multiplierLevel) || 1) * (typeof getActivePedestalMultiplier==='function' ? getActivePedestalMultiplier() : 1);

  baseEPS = baseTotal; // keep base for reference
  state.eps = Math.floor(combined) || 0;
  updateTop();
  save();
}
  let lastTick = performance.now();
  // Main game loop.  We wrap all of the logic in a try/finally so that
  // unexpected errors never stop the requestAnimationFrame from firing.  This
  // prevents the game from "freezing" if a DOM element is missing or a
  // function throws.
  function tick(now){
    // Always schedule the next frame, even if an error occurs.  Use a
    // finally block to guarantee that requestAnimationFrame is called.
    try {
      // Make sure the stands array has the correct length.  Without this
      // check players could lose a pedestal and earnings would stop.
      if (typeof ensureStandsLength === 'function') {
        ensureStandsLength();
      }
      const dt = (now - lastTick) / 1000;
      lastTick = now;
      if (state.eps > 0) {
        // Update player money based on earnings per second and time delta
        state.money += state.eps * dt;
        // Update top bar values if possible
        try {
          updateTop();
        } catch (err) {
          console.error('updateTop error:', err);
        }
      }
      // Check pet timers (hatch) safely
      try {
        checkPetHatches();
      } catch (err) {
        console.error('checkPetHatches error:', err);
      }
    } catch (err) {
      // Catch any unexpected error so it doesn't kill the loop
      console.error('tick error:', err);
    } finally {
      requestAnimationFrame(tick);
    }
  }

function downloadSave() {
  try {
    const blob = new Blob([JSON.stringify(state)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "my-save.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    alert("Error saving file: " + err.message);
  }
}

function handleSaveUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      state = data; // overwrite game state

      // re-render everything
      renderStands();
      renderInventory();
      recalcEPS();
      save();

      alert("Save file loaded successfully!");
    } catch (err) {
      alert("Invalid save file.");
      console.error(err);
    }
  };
  reader.readAsText(file);
}

function rarityBadge(r){
  // normalize to lowercase key used in RARITY object
  const key = String(r || 'common').toLowerCase();
  const label = (RARITY[key] && RARITY[key].label) ? RARITY[key].label : String(r || 'COMMON');
  return `<span class="rar t-${key}">${label}</span>`;
}
  
  function renderInventory(){
    const wrap = $('#inventory');
    wrap.innerHTML='';
    state.inventory.forEach(it=>{
      const el = document.createElement('div');
      el.className = 'slot' + ((it.isEgg||it.petType)?' is-pet':'') + (state.selectedItemUid===it.uid?' selected':'');
      el.setAttribute('data-uid', String(it.uid||''));
      // badge: EGG or PET or rarity
      let badgeHtml = '';
      if(it.isEgg) badgeHtml = `<div class="rar" style="right:8px;bottom:8px;background:rgba(255,255,255,.12);color:#fff;">EGG</div>`;
      else badgeHtml = rarityBadge(it.rarity || 'common');

      el.innerHTML = `<img src='${(it.svg || ((it.name||'').toLowerCase()==='dodger world series champions' ? 'la_dodgers_items/dodger_world_series_champions.png' : getItemSvg(it.name, it.baseIdx||0, it.rarity||'common')))}' alt='${escapeXml(displayName(it.name))}'/><div style="position:absolute;top:6px;left:8px;font-size:12px;color:#fff;font-weight:700;text-shadow:0 1px 0 #000">${escapeXml(displayName(it.name))}</div>${badgeHtml}`;
      // Wrap the item image so we can overlay special effects (e.g., crypto ring)
      (function(){
        const img = el.querySelector('img');
        if (img && !img.closest('.img-wrap')) {
          const wrap = document.createElement('div');
          wrap.className = 'img-wrap';
          img.parentNode.insertBefore(wrap, img);
          wrap.appendChild(img);
          const rk = String(it.rarity||'').toLowerCase();
          if (rk === 'crypto') {
            const ring = document.createElement('span');
            ring.className = 'crypto-ring';
            wrap.appendChild(ring);
          }
         try{
            if (it && it.hollywood) {
              const hr = document.createElement('span');
              hr.className = 'hollywood-ring';
              wrap.appendChild(hr);
            }
            if (it && it.aqua) {
              const ar = document.createElement('span');
              ar.className = 'aqua-ring';
              wrap.appendChild(ar);
            }
            // If the item has the demon morph, overlay a crimson ring
            if (it && it.demon) {
              const dr = document.createElement('span');
              dr.className = 'demon-ring';
              wrap.appendChild(dr);
            }
         }catch(e){} }
      })();
    
      el.style.setProperty('--rcolor', RARITY[it.rarity]?.color || 'var(--c-common)');
      const badge = el.querySelector('.rar');
      if(badge) {
        badge.style.border = '2px solid rgba(255,255,255,.25)';
        badge.style.color = '#111';
      }
      el.addEventListener('click',()=>{
        state.selectedItemUid = (state.selectedItemUid===it.uid?null:it.uid);
        renderInventory();
      });
      wrap.appendChild(el);
    });
  }

  function checkExoticForge() {
  const allLegacy = state.stands.every(uid => {
    if (!uid) return false;
    const it = state.placed[uid] || state.inventory.find(x => x.uid === uid);
    return it && it.rarity && it.rarity.toLowerCase() === 'legacy';
  });

  let btn = document.getElementById('exoticForgeBtn');
  if (allLegacy) {
    if (!btn) {
      btn = document.createElement('button');
      btn.id = 'exoticForgeBtn';
      btn.textContent = 'FORGE EXOTIC';
      btn.style.cssText = 'margin-top:6px;padding:10px 18px;border-radius:14px;background:linear-gradient(45deg, #7fefff, #4fd9ff);border:4px solid rgba(0,0,0,.35);color:#000;font-weight:900;box-shadow:0 8px 30px rgba(127,239,255,0.4);cursor:pointer;';
      btn.addEventListener('click', () => {
  // remove the 4 legacy items from stands
  for (const uid of state.stands) {
    if (uid) delete state.placed[uid];
  }
  state.stands = [null, null, null, null];

  // create new exotic item and place it on stand 0
  const newItem = (typeof _randomExotic==='function') ? _randomExotic() : (function(){ 
    const real = (typeof _getRealItemNames==='function') ? _getRealItemNames() : (Array.isArray(window.ITEM_NAMES)?window.ITEM_NAMES.slice():[]);
    const idx  = Math.floor(Math.random() * (real.length || 20));
    const name = real[idx] || '24 King Crown';
    const svg  = (typeof window.getItemSvg==='function') ? getItemSvg(name, idx, 'exotic') : '';
    return { uid: uid(), name, rarity:'exotic', price:0, baseIdx:idx, svg };
  })();

  state.placed[newItem.uid] = newItem;
  state.stands[0] = newItem.uid;  // place on first stand

  recalcEPS();
  renderInventory();
  renderStands();
  save();
});
      document.querySelector('.game').insertBefore(btn, document.querySelector('.inventory-wrap'));
    }
    btn.style.display = 'inline-block';
  } else if (btn) {
    btn.style.display = 'none';
  }
}

  
  function renderStands() {
  const area = document.getElementById('stands');
  area.innerHTML = '';
  for (let i = 0; i < STAND_COUNT; i++) {
    const box = document.createElement('div');
    box.className = 'stand';

    // The UID of the item placed on this stand (or null)
    const placed = state.stands[i];

    // Create the pedestal (always present)
    const ped = document.createElement('div');
    ped.className = 'pedestal';
    box.appendChild(ped);

    // If there is an item placed on this stand...
    if (placed) {
      // Find the item object (from placed or inventory)
      const it = state.placed[placed] || state.inventory.find(x => x.uid === placed);
      if (it) {
        // Create the div for the placed item
        const p = document.createElement('div');
        p.className = 'placed';
        // Apply morph-specific classes for animations
        if(it && it.aqua){ p.classList.add('aqua-morph'); }
        if(it && it.demon){ p.classList.add('demonized'); }
        // Build morph tags based on item properties.  Multiple morph tags stack vertically.
        const tags = [];
        if(it && it.hollywood) tags.push(`<span class="hollywood-tag">Hollywood</span>`);
        if(it && it.aqua) tags.push(`<span class="aqua-tag">Aqua</span>`);
        if(it && it.demon) tags.push(`<span class="demon-tag">Demon</span>`);
        const tagsHtml = tags.length ? `<br>` + tags.join('<br>') : '';
        // Build the inner HTML with the optional morph tags appended after the rarity badge
        p.innerHTML =
          `<img src='${it.svg}' style='width:64px;height:64px;border-radius:8px;margin-right:8px;' alt='${escapeXml(displayName(it.name))}'/>
           <div style="text-align:left">
             <strong>${escapeXml(displayName(it.name))}</strong><br>
             <span class="rar t-${it.rarity}">${RARITY[it.rarity].label}</span>${tagsHtml}
           </div>`;
        // Wrap the placed item image to overlay a crypto ring for CRYPTO rarity
        (function(){
          const img = p.querySelector('img');
          if (img && !img.closest('.img-wrap')) {
            const wrap = document.createElement('div');
            wrap.className = 'img-wrap';
            img.parentNode.insertBefore(wrap, img);
            wrap.appendChild(img);
            const rkey = String(it.rarity || '').toLowerCase();
            // Add a colorful ring for crypto rarity
            if (rkey === 'crypto') {
              const ring = document.createElement('span');
              ring.className = 'crypto-ring';
              wrap.appendChild(ring);
            }
            // Add morph rings.  Hollywood ring is golden, aqua ring is teal.
            try {
              if (it && it.hollywood) {
                const hr = document.createElement('span');
                hr.className = 'hollywood-ring';
                wrap.appendChild(hr);
              }
              if (it && it.aqua) {
                const ar = document.createElement('span');
                ar.className = 'aqua-ring';
                wrap.appendChild(ar);
              }
            } catch(e){}
          }
        })();
    

        p.style.border = '4px solid rgba(0,0,0,.45)';
        p.style.color = '#fff';

        // --- BADGE ANIMATION LOGIC ---
        // Select the badge element (the rarity label)
        const badge = p.querySelector('.rar');

const rkey = String(it.rarity || '').toLowerCase();

// birthday
if (rkey === 'birthday') {
  badge.classList.add('t-birthday');
}

// legacy (rainbow)
if (rkey === 'legacy') {
  badge.style.color = 'transparent';
  badge.style.background = 'linear-gradient(90deg, #ff004c, #ff7a00, #ffd400, #18e300, #00e7ff, #3a31ff, #ff31ff, #ff004c)';
  badge.style.backgroundSize = '400% 100%';
  badge.style.webkitBackgroundClip = 'text';
  badge.style.backgroundClip = 'text';
  badge.style.animation = 'rainbowShift 4s linear infinite';
}

// mythic (gold shimmer)
if (rkey === 'mythic') {
  badge.classList.add('t-mythic');
  p.classList.add('glow');
}

// unique: sparkle-ish badge + glow
if (rkey === 'unique') {
  badge.classList.add('t-unique');
  // no glow
}

// exotic: cyan glow + badge
if (rkey === 'exotic') {
  badge.classList.add('t-exotic');
  p.classList.add('glow-exotic');  // apply to the <p> element with the SVG
}

        box.appendChild(p);
      }
    }

    // Add click listener for placing/removing items
    box.addEventListener('click', () => {
      // If no item selected, remove placed item (if any)
      if (!state.selectedItemUid) {
        if (state.stands[i]) {
          const oldUid = state.stands[i];
          const oldItem = state.placed[oldUid] || null;
          if (oldItem) {
            state.inventory.push(oldItem);
            delete state.placed[oldUid];
          }
          state.stands[i] = null;
          recalcEPS();
          renderInventory();
          renderStands();
          save();
        }
        return;
      }

      // Remove old placed item if there is one
      if (state.stands[i]) {
        const oldUid = state.stands[i];
        const oldItem = state.placed[oldUid] || null;
        if (oldItem) {
          state.inventory.push(oldItem);
          delete state.placed[oldUid];
        }
        state.stands[i] = null;
      }

      // Place new item
      const newItem = state.inventory.find(it => it.uid === state.selectedItemUid);
      if (!newItem) return;

      state.placed[newItem.uid] = newItem;
      state.stands[i] = newItem.uid;

      state.inventory = state.inventory.filter(it => it.uid !== newItem.uid);
      state.selectedItemUid = null;

      recalcEPS();
      renderInventory();
      renderStands();

      // Glow animation for mythic
      const placedDiv = box.querySelector('.placed');
      if (placedDiv) {
        placedDiv.classList.add('glow');
        setTimeout(() => placedDiv.classList.remove('glow'), 700);
      }
      save();
    });

    area.appendChild(box);
  }

  // --- PET ROW (below main pedestals) ---
  let petRow = document.querySelector('.pet-row');
  if(!petRow){
    petRow = document.createElement('div');
    petRow.className = 'pet-row';
  } else {
    petRow.innerHTML = '';
  }

  // We want pet pedestals aligned so that pet0 is under main stand #2 (index 1),
  // and pet1 is under main stand #3 (index 2). We'll render four columns and
  // only place pedestals in columns 2 and 3 when purchased.
  for(let col=0; col<4; col++){
    const pbox = document.createElement('div');
    pbox.className = 'pet-stand';
    // If column matches where pet pedestals go:
    let placeIndex = null;
    if(col === 1 && state.petPedestalsPurchased >= 1) placeIndex = 0;
    if(col === 2 && state.petPedestalsPurchased >= 2) placeIndex = 1;

    if(placeIndex !== null){
      const pPed = document.createElement('div');
      pPed.className = 'pet-pedestal';
      pbox.appendChild(pPed);

      const placed = state.petStands[placeIndex];
      if(placed){
        const p = document.createElement('div');
        p.className = 'pet-placed';
        // If it's an egg, show egg image and name; if pet, show pet and badge
        const nameLabel = escapeXml(displayName(placed.name || (placed.petType || 'Pet')));
        p.innerHTML = `<img src='${placed.svg}' alt='${nameLabel}'/><div style="text-align:left"><strong>${nameLabel}</strong><br><span style="font-size:12px;color:#fff;opacity:.9">${placed.isEgg ? (placed.eggType || 'Egg') : (placed.petType || '')}</span></div>`;
        pbox.appendChild(p);

        // If egg incubating show timer badge
        if(placed.isEgg && state.petTimers[placeIndex]){
          const timer = document.createElement('div');
          timer.className = 'pet-timer';
          timer.dataset.index = placeIndex;
          pbox.appendChild(timer);
        }

        // Add special glow for Flex T-Rex pet
        if(!placed.isEgg && placed.petType === 'Flex T-Rex'){
          p.classList.add('glow');
        }
      }

      // Click handling for pet pedestal
pbox.addEventListener('click', () => {
  // If no selected item: remove placed item back to inventory
  if (!state.selectedItemUid) {
    const existing = state.petStands[placeIndex];
    if (existing) {
      state.inventory.push(existing);
      state.petStands[placeIndex] = null;
      delete state.petTimers[placeIndex];
      recalcEPS();
      renderInventory();
      renderStands();
      save();
    }
    return;
  }

  const newItem = state.inventory.find(it => it.uid === state.selectedItemUid);
  if (!newItem) return;
  // If a pet/egg is already here, return it to inventory before placing the new one
  const existingHere = state.petStands[placeIndex];
  if (existingHere) {
    state.inventory.push(existingHere);
    state.petStands[placeIndex] = null;
    delete state.petTimers[placeIndex];
  }

  // âœ… Allow eggs or pets here
  if (!(newItem.isEgg || newItem.petType)) {
    alert('Only eggs or pets can be placed on pet pedestals.');
    return;
  }

  // If placing an egg, start hatch timer
  if (newItem.isEgg) {
    state.petStands[placeIndex] = newItem;
            if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
    state.petTimers[placeIndex] = Date.now() + ((placeIndex===2 ? (window.THIRD_HATCH_DURATION||HATCH_DURATION) : (window.HATCH_DURATION||HATCH_DURATION)));
  } else {
    // If placing a pet, no timer needed
    state.petStands[placeIndex] = newItem;
            if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
  }

  // Remove from inventory
  state.inventory = state.inventory.filter(it => it.uid !== newItem.uid);
  state.selectedItemUid = null;

  recalcEPS();
  renderInventory();
  renderStands();
  save();
});

    }
    petRow.appendChild(pbox);
  }

  // Insert or reinsert petRow after main stands
  area.parentNode.insertBefore(petRow, area.nextSibling);

  checkForge();
  checkExoticForge();
}

function weightedPick(){
  const r = Math.random();
  if (r < 0.003) return 'unique';                       // 0.3%
  if (r < 0.003 + 0.005) return 'legacy';               // 0.5%
  if (r < 0.003 + 0.005 + 0.01) return 'legendary';     // 1% (cumulative)
  if (r < 0.003 + 0.005 + 0.01 + 0.08) return 'epic';    // 8%
  if (r < 0.003 + 0.005 + 0.01 + 0.08 + 0.10) return 'rare'; // 10%
  return 'common';
}
  function priceFor(rarity){ const [a,b] = RARITY[rarity].price; return Math.floor(a + Math.random()*(b-a)); }
  function makeShopItems(){
    const items = [];
    const pool = ITEM_NAMES.slice();
    for(let i=0;i<SHOP_SLOTS;i++){
      const idx = Math.floor(Math.random()*pool.length);
      const name = pool.splice(idx,1)[0];
      const rarity = weightedPick();
      const baseIdx = idx;
      items.push({ uid: uid(), name, rarity, price: priceFor(rarity), svg: getItemSvg(name, baseIdx, rarity), baseIdx, purchased:false });
    }
    return items;
  }
  function ensureShop() {
  const now = Date.now();
  const REFRESH_INTERVAL = 90_000; // 1:30

  // Fix old saves or weird drift
  if (!state.shop.nextRefreshAt || state.shop.nextRefreshAt - now > REFRESH_INTERVAL) {
    state.shop.nextRefreshAt = now + REFRESH_INTERVAL;
  }

  // Refresh if needed
  if (now >= state.shop.nextRefreshAt || !state.shop.items?.length) {
    state.shop.items = makeShopItems();
    state.shop.nextRefreshAt = now + REFRESH_INTERVAL;
    save();
  }

  renderShop();
}

// Force-refresh the shop immediately and reset the 1:30 timer (90s)
function refreshShopNow(){
  try{
    const REFRESH_INTERVAL = 90_000; // 1:30
    // generate a brand new set of items
    if (typeof makeShopItems === 'function') {
      state.shop.items = makeShopItems();
    }
    // reset the countdown
    state.shop.nextRefreshAt = Date.now() + REFRESH_INTERVAL;
    // persist + redraw
    if (typeof save === 'function') save();
    if (typeof renderShop === 'function') renderShop();
  }catch(e){ /* no-op */ }
}

  function msToClock(ms){ ms = Math.max(0, ms); const s = Math.floor(ms/1000); const m = Math.floor(s/60); const sec = s%60; return `${m}:${String(sec).padStart(2,'0')}`; }
  let refreshTimer;
  function renderShop(){
    const grid = $('#shopGrid');
    grid.innerHTML='';
    state.shop.items.forEach((it, i)=>{
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `<div style='display:flex;gap:12px;align-items:center'>
        <img src='${it.svg}' style='width:72px;height:72px;border-radius:10px;flex:0 0 72px' alt='${escapeXml(displayName(it.name))}' />
        <div>
          <h3>${escapeXml(displayName(it.name))}</h3>
          <div class="tag t-${it.rarity}">${RARITY[it.rarity].label}</div>
        </div>
      </div>
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div class="price">$${fmt(it.price)}</div>
        <button class="buy">${it.purchased ? "Purchased!" : "Purchase"}</button>
      </div>`;
      const btn = card.querySelector('.buy');

      function setBtn(){
        if(it.purchased){
          btn.disabled = true;
          btn.textContent = 'Purchased!';
          btn.style.background = 'linear-gradient(#2ecc71,#1da85b)';
        } else {
          btn.disabled = state.money < it.price;
          btn.textContent = 'Purchase';
          btn.style.background = '';
        }
      }
      setBtn();

      btn.addEventListener('click',()=>{
        if(it.purchased) return;
        if(state.money < it.price) return;
        state.money -= it.price;
        const inv = { uid: uid(), name: it.name, rarity: it.rarity, price: it.price, svg: it.svg, baseIdx: it.baseIdx };
        state.inventory.push(inv);
        try{ state.flexwood = state.flexwood || {top1:{purchases:0},bot1:{rarePurchases:0}}; state.flexwood.top1.purchases = (state.flexwood.top1.purchases||0)+1; if(String(it.rarity||'').toLowerCase()==='rare'){ state.flexwood.bot1.rarePurchases = (state.flexwood.bot1.rarePurchases||0)+1; } if(typeof save==='function') save(); if(typeof renderFlexwood==='function') renderFlexwood(); }catch(e){}
        it.purchased = true;
        updateTop();
        renderInventory();
        save();
        setBtn();
      });
      grid.appendChild(card);
    });
    if(refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(()=>{
      const left = state.shop.nextRefreshAt - Date.now();
      $('#refreshNote').textContent = `Shop refreshes every ${msToClock(left)}`;
      if(left<=0){
        ensureShop();
      }
    }, 200);
  }

  let audioCtx, masterGain, musicOn=false;
  function initMusic(){ if(audioCtx) return; audioCtx = new (window.AudioContext || window.webkitAudioContext)(); masterGain = audioCtx.createGain(); masterGain.gain.value = 0.16; masterGain.connect(audioCtx.destination); const tempo = 90; const beat = 60/tempo; const pattern = [0,3,7,10,7,3]; const baseFreq = 220; function scheduleLoop(startTime){ for(let i=0;i<pattern.length;i++){ const t = startTime + i*beat*0.5; const freq = baseFreq * Math.pow(2, pattern[i]/12); const osc = audioCtx.createOscillator(); const g = audioCtx.createGain(); osc.type = 'square'; osc.frequency.value = freq; g.gain.value = 0; osc.connect(g); g.connect(masterGain); osc.start(t); g.gain.setValueAtTime(0.0, t); g.gain.linearRampToValueAtTime(0.08, t + 0.02); g.gain.linearRampToValueAtTime(0.0, t + beat*0.45); osc.stop(t + beat*0.5); } const pad = audioCtx.createOscillator(); const pg = audioCtx.createGain(); pad.type='sine'; pad.frequency.value = baseFreq*0.5; pg.gain.value=0.0; pad.connect(pg); pg.connect(masterGain); pad.start(startTime); pad.stop(startTime + pattern.length*beat*0.5); pg.gain.setValueAtTime(0.0, startTime); pg.gain.linearRampToValueAtTime(0.05, startTime + 0.1); pg.gain.linearRampToValueAtTime(0.0, startTime + pattern.length*beat*0.5); } function loop(){ const now = audioCtx.currentTime + 0.05; scheduleLoop(now); setTimeout(loop, (pattern.length*beat*0.5)*1000 - 40); } loop(); }
  function toggleMusic(){ if(!audioCtx){ initMusic(); } if(audioCtx.state === 'suspended') audioCtx.resume(); musicOn = !musicOn; masterGain.gain.value = musicOn ? 0.16 : 0.0; $('#musicBtn').style.filter = musicOn ? 'saturate(1.2)' : 'grayscale(1)'; }
  $('#musicBtn').addEventListener('click', ()=>{ toggleMusic(); });

  function checkForge(){
    const allLegendary = state.stands.every(uid=>{
      if(!uid) return false;
      const it = state.placed[uid] || state.inventory.find(x=>x.uid===uid);
      return it && it.rarity === 'legendary';
    });
    const btn = $('#forgeBtn');
    if(!btn) return;
    btn.style.display = allLegendary ? 'inline-block' : 'none';
  }
  function createMythicItem(){
    const idx = Math.floor(Math.random()*ITEM_NAMES.length);
    const name = ITEM_NAMES[idx] || ('Mythic Item');
    const baseIdx = idx;
    return { uid: uid(), name, rarity: 'mythic', price: 0, svg: getItemSvg(name, baseIdx, 'mythic'), baseIdx };
  }
  $('#forgeBtn').addEventListener('click', ()=>{
    if(!state.stands.every(uid => uid && (state.placed[uid]||state.inventory.find(x=>x.uid===uid)) && ((state.placed[uid]||state.inventory.find(x=>x.uid===uid)).rarity === 'legendary'))){
      return;
    }
    state.stands.forEach(uid => {
      if(uid && state.placed[uid]) delete state.placed[uid];
    });
    state.stands = Array(STAND_COUNT).fill(null);
    const mythic = createMythicItem();
    state.placed[mythic.uid] = mythic;
    state.stands[0] = mythic.uid;
    recalcEPS();
    renderInventory();
    renderStands();
    save();
  });
    
  

  $('#openShop').addEventListener('click',()=>{
    $('#shopOverlay').classList.add('show');
    ensureShop();
    $('#shopOverlay').setAttribute('aria-hidden','false');
  });
  $('#closeShop').addEventListener('click',()=>{
    $('#shopOverlay').classList.remove('show');
    $('#shopOverlay').setAttribute('aria-hidden','true');
  });
  $('#toolsBtn').addEventListener('click',()=>{
    state.fastMode = !state.fastMode;
    ensureShop();
    const msg = state.fastMode? 'Fast refresh: 15s' : 'Normal refresh: 5 min';
    $('#toolsBtn').title = 'Tools ('+msg+')';
    save();
  });

/* -------------------
   GEAR FEATURES
------------------- */
const MULTIPLIER_COST = 3_000_000;
const MULTIPLIER_DURATION = 20 * 60 * 1000; // 20 minutes
const MULTIPLIER_COOLDOWN = 30 * 60 * 1000; // 30 minutes
const BACKGROUND_COST = 4_000_000;

const RED_MONEY_COST = 1_000_000_000_000;
// === Rebirth Multiplier System ===
const REBIRTH_LEVEL_MULTS = [2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20];
const REBIRTH_LEVEL_COSTS = [1_000_000_000,20_000_000_000,40_000_000_000,75_000_000_000,125_000_000_000,400_000_000_000,700_000_000_000,1_000_000_000_000,10_000_000_000_000,15_000_000_000_000,25_000_000_000_000,28_000_000_000_000,30_000_000_000_000,35_000_000_000_000,50_000_000_000_000,55_000_000_000_000,65_000_000_000_000,80_000_000_000_000,100_000_000_000_000];

function getRebirthMultiplier(){ 
  const lvl = state.rebirthLevel || 0;
  if(lvl<=0) return 1;
  return REBIRTH_LEVEL_MULTS[Math.min(lvl-1, REBIRTH_LEVEL_MULTS.length-1)] || 1;
}
function nextRebirthCost(){
  const lvl = state.rebirthLevel || 0;
  if(lvl >= REBIRTH_LEVEL_MULTS.length) return null;
  return REBIRTH_LEVEL_COSTS[lvl];
}
function updateRebirthUI(){
  const lvl = state.rebirthLevel || 0;
  const mult = getRebirthMultiplier();
  const priceEl = document.getElementById("rebirthPrice");
  const levelTag = document.getElementById("rebirthLevelTag");
  const status = document.getElementById("rebirthStatus");
  const btn = document.getElementById("rebirthUpgrade");
  if(levelTag) levelTag.textContent = `(Level ${lvl})`;
  if(status) status.textContent = `Current Rebirth Multiplier: x${mult}`;
  const cost = nextRebirthCost();
  if(priceEl) priceEl.textContent = cost ? `$${fmt(cost)}` : 'MAXED';
  if(btn){
        if(document.body.classList.contains('upside-down')){ btn.style.display='none'; return; }
    if(cost===null){ btn.disabled = true; btn.textContent = 'Maxed'; }
    else { btn.disabled = state.money < cost; btn.textContent = 'Upgrade'; }
  }
}
function doRebirthUpgrade(){
  const cost = nextRebirthCost();
  if(cost===null) return;
  if(state.money < cost) return;
  state.rebirthLevel = (state.rebirthLevel||0) + 1;
  state.money = 1_000_000; // reset money only
  recalcEPS();
  updateTop();
  updateRebirthUI();
  save();
}

function updateMultiplierBadge(){
  const badge = document.getElementById('multBadge');
  if(!badge) return;
  const petMult = (typeof getActivePedestalMultiplier==='function' ? getActivePedestalMultiplier() : 1);
  const rebirthMult = getRebirthMultiplier();
  const hasAny = (petMult>1) || (rebirthMult>1);
  if(!hasAny){ badge.style.display='none'; badge.textContent=''; return; }
  // Display style rule per request: show as sum (e.g., x15 for pet x5 + rebirth x10)
  const displayVal = (petMult>1?petMult:0) + (rebirthMult>1?rebirthMult:0) || 1;
  badge.textContent = 'x' + displayVal;
  badge.style.display = 'inline-block';
}

let redMoneyPurchased = false;
let redMoneyEnabled = false;

let multiplierActiveUntil = 0;
let multiplierCooldownUntil = 0;
let multiplierLevel = 1; // 1x, 2x, 4x max

function applyMultiplier(eps) {
  return eps * multiplierLevel;
}

let multiplierTimer;

function updateMultiplierStatus() {
  const status = document.getElementById("multiplierStatus");
  const btn = document.getElementById("buyMultiplier");
  if (!status || !btn) return;

  if (multiplierTimer) clearInterval(multiplierTimer);

  function refresh() {
    const now = Date.now();

    // ðŸŸ¢ Case: 2x Active (allow upgrading to 4x)
    if (multiplierLevel === 2 && now < multiplierActiveUntil) {
      const left = Math.ceil((multiplierActiveUntil - now) / 1000);
      const min = Math.floor(left / 60);
      const sec = left % 60;
      status.textContent = `Active: 2x (${min}:${String(sec).padStart(2,"0")} left)`;

      btn.disabled = state.money < MULTIPLIER_COST;
      btn.textContent = "Upgrade to 4x";
      btn.style.background = "linear-gradient(#2ecc71,#1da85b)";

    // ðŸŸ¢ Case: 4x Active (fully maxed)
    } else if (multiplierLevel === 4 && now < multiplierActiveUntil) {
      const left = Math.ceil((multiplierActiveUntil - now) / 1000);
      const min = Math.floor(left / 60);
      const sec = left % 60;
      status.textContent = `Active: 4x (${min}:${String(sec).padStart(2,"0")} left)`;

      btn.disabled = true;
      btn.textContent = "4x Active";
      btn.style.background = "linear-gradient(#2ecc71,#1da85b)";

    // Cooldown
    } else if (now < multiplierCooldownUntil) {
      const left = Math.ceil((multiplierCooldownUntil - now) / 1000);
      const min = Math.floor(left / 60);
      const sec = left % 60;
      status.textContent = `Cooldown: ${min}:${String(sec).padStart(2,"0")}`;

      btn.disabled = true;
      btn.textContent = "Cooldown";
      btn.style.background = "";

    // Ready to buy again (no active, no cooldown)
    } else {
      status.textContent = "";
      btn.disabled = state.money < MULTIPLIER_COST;
      btn.textContent = "Purchase";
      btn.style.background = "";
    }
  }

  refresh();
  multiplierTimer = setInterval(refresh, 1000);
}

function buyMultiplier() {
  const now = Date.now();
  if (state.money < MULTIPLIER_COST) return;

  // If already at 4x, stop
  if (multiplierLevel >= 4) return;

  // If no multiplier active yet
  if (multiplierLevel < 2) {
    // Block cooldown if one is still running
    if (now < multiplierCooldownUntil) return;

    multiplierLevel = 2;
    multiplierActiveUntil = now + MULTIPLIER_DURATION;
    multiplierCooldownUntil = now + MULTIPLIER_COOLDOWN;

  // If already at 2x, upgrade to 4x without resetting timers
  } else if (multiplierLevel === 2) {
    multiplierLevel = 4;
    // Do NOT change multiplierActiveUntil or multiplierCooldownUntil
  }

  state.money -= MULTIPLIER_COST;

  // ðŸŸ¢ Apply EPS boost immediately
  recalcEPS();
  updateTop();
  updateRebirthUI();
  save();
}

// Background feature
let backgroundPurchased = false;
let backgroundEnabled = false;

function buyBackground() {
  if (backgroundPurchased) return;
  if (state.money < BACKGROUND_COST) return;
  state.money -= BACKGROUND_COST;
  backgroundPurchased = true;
  backgroundEnabled = true;
  document.body.classList.add("redblue");
  updateTop();
  document.getElementById("buyBackground").style.display = "none";
  document.getElementById("toggleBackground").style.display = "inline-block";
  save();
}

function toggleBackground() {
  if (!backgroundPurchased) return;
  backgroundEnabled = !backgroundEnabled;

  if (backgroundEnabled) {
    document.body.classList.add("redblue");
    document.getElementById("toggleBackground").textContent = "Disable";
  } else {
    document.body.classList.remove("redblue");
    document.getElementById("toggleBackground").textContent = "Enable";
  }

  save();
}

function updateRedMoneyUI(){
  const buy = document.getElementById("buyRedMoney");
  const tog = document.getElementById("toggleRedMoney");
  if(!buy || !tog) return;
  if(redMoneyPurchased){
    buy.style.display = "none";
    tog.style.display = "inline-block";
    tog.textContent = redMoneyEnabled ? "Disable" : "Enable";
    tog.disabled = false;
  }else{
    buy.style.display = "inline-block";
    tog.style.display = "none";
    buy.disabled = (state.money||0) < RED_MONEY_COST;
  }
  document.body.classList.toggle("money-red", !!redMoneyEnabled);
}

function buyRedMoney(){
  if(redMoneyPurchased) return;
  if((state.money||0) < RED_MONEY_COST) return;
  state.money -= RED_MONEY_COST;
  redMoneyPurchased = true;
  redMoneyEnabled = true;
  updateTop();
  updateRedMoneyUI();
  save();
}

function toggleRedMoney(){
  if(!redMoneyPurchased) return;
  redMoneyEnabled = !redMoneyEnabled;
  updateRedMoneyUI();
  save();
}

// Open/close Gear overlay
document.getElementById("toolsBtn").addEventListener("click", () => {
  document.getElementById("gearOverlay").classList.add("show");
  document.getElementById("gearOverlay").setAttribute("aria-hidden", "false");
  updateRebirthUI();
  updateRedMoneyUI();
});
document.getElementById("closeGear").addEventListener("click", () => {
  document.getElementById("gearOverlay").classList.remove("show");
  document.getElementById("gearOverlay").setAttribute("aria-hidden", "true");
});

// Gear button actions
document.getElementById("rebirthUpgrade")?.addEventListener("click", doRebirthUpgrade);
document.getElementById("buyBackground").addEventListener("click", buyBackground);
document.getElementById("toggleBackground").addEventListener("click", toggleBackground);
document.getElementById("buyRedMoney")?.addEventListener("click", buyRedMoney);
document.getElementById("toggleRedMoney")?.addEventListener("click", toggleRedMoney);

// Hook multiplier into EPS calculation
// --- Multiplier-aware EPS calculation ---
let baseEPS = 0;

const _recalcEPS = recalcEPS;
recalcEPS = function() {
  // Recalculate base EPS without multiplier
  let total = 0;
  state.stands.forEach(uid => {
    if (!uid) return;
    const it = state.placed[uid] || state.inventory.find(x => x.uid === uid);
    if (!it) return;
    total += RARITY[it.rarity].income;
  });
  baseEPS = total;

  // Sum pet EPS
  let petTotal = 0;
  state.petStands.forEach(ps => {
    if(!ps) return;
    if(ps.petEps) petTotal += ps.petEps;
  });

  let combined = baseEPS + petTotal;
  combined = combined * getRebirthMultiplier() * (typeof getActivePedestalMultiplier==='function' ? getActivePedestalMultiplier() : 1);
  state.eps = Math.floor(combined);

  updateTop();
  save();
};

/* -----------------------
   PET SHOP LOGIC
   ----------------------- */

const PET_PEDESTAL_COST = 15_000_000;
const EGG_COSTS = {legendary: 10_000_000, mythical: 15_000_000, enchanted: 25_000_000, universal: 1_000_000_000, magical: 2_000_000_000};
const HATCH_DURATION = 10 * 60 * 1000;
const FOURTH_HATCH_DURATION = 2 * 60 * 1000; // 10 minutes (ms)

// pet outcome tables & EPS values

// === PetDex tracking & counts ===
function ensurePetDex(){ if(!state.petDex) state.petDex = {}; return state.petDex; }
function registerPetOwned(name){ const dex = ensurePetDex(); if(name) dex[name]=true; }
function petCountsByEgg(){
  const totals={}, owned={};
  const dex = ensurePetDex();
  for(const [egg, list] of Object.entries(PET_TABLES)){
    const key = String(egg).toLowerCase();
    if(key === 'galaxy' || key === 'demoegg') continue; // Exclude Galaxy + Demoegg from Pet Quests tallies
    const names=[];
    list.forEach(e => { if(e.name==='IRL' && Array.isArray(e.subset)) names.push(...e.subset); else names.push(e.name); });
    totals[egg]=names.length; owned[egg]=names.filter(n => !!dex[n]).length;
  }
  return {totals, owned};
}
function hasAllPets(){ const pc = petCountsByEgg(); return Object.keys(pc.totals).every(k => pc.owned[k]===pc.totals[k]); }
const PET_TABLES = { legendary: [
    { name: 'Dog',    chance: 0.70, eps: 300 },
    { name: 'Cat',    chance: 0.20, eps: 1200 },
    { name: 'Gold Dog', chance: 0.10, eps: 4000 }
  ],
  mythical: [
    { name: 'Lion', chance: 0.80, eps: 2000 },
    { name: 'Bear', chance: 0.15, eps: 6000 },
    { name: 'Dino', chance: 0.05, eps: 15000 }
  ],
  enchanted: [
    { name: 'Owl', chance: 0.94, eps: 1000 },
    { name: 'Rainbow Panda', chance: 0.05, eps: 12000 },
    { name: 'Flex T-Rex', chance: 0.01, eps: 50000 } // special: grants permanent 5x
  ]
  , universal: [
    { name: 'Lizard', chance: 0.52, eps: 10_000 },
    { name: 'Alien', chance: 0.44, eps: 15_000 },
    { name: 'IRL', subset: ['Hudson','Drake','Molly'], chance: 0.03, eps: 45_000 },
    { name: 'Flex Dragon', chance: 0.01, eps: 65_000 } // grants permanent 5x
  ]

  , magical: [
    { name: 'Frog', chance: 0.45, eps: 15_000 },
    { name: 'Tiger', chance: 0.32, eps: 20_000 },
    { name: 'Deer', chance: 0.19, eps: 25_000 },
    { name: 'IRL', subset: ['Nella','Ozzy','Chloe'], chance: 0.03, eps: 45_000 },
    { name: 'Flexicorn', chance: 0.005, eps: 80_000 } // x5 multiplier + Luck Boost (on pedestal)
  ]
};

function weightedPetPick(eggType){
  const list = PET_TABLES[eggType];
  const r = Math.random();
  let acc = 0;
  for(const p of list){
    acc += p.chance;
    if(r <= acc) return p;
  }
  return list[list.length-1];
}

function updatePetButtonsUI(){
  const btn = document.getElementById('buyPetPedestal');
  const status = document.getElementById('petPedestalStatus');
  if(!btn || !status) return;
  btn.disabled = state.petPedestalsPurchased >= 2 || state.money < PET_PEDESTAL_COST;
  if(state.petPedestalsPurchased >= 2){
    status.textContent = 'Max pedestals purchased';
    btn.textContent = 'Purchased';
    btn.style.background = 'linear-gradient(#2ecc71,#1da85b)';
  } else {
    status.textContent = `Purchased: ${state.petPedestalsPurchased}/2`;
    btn.textContent = 'Purchase';
    btn.style.background = '';
  }

  // egg buttons enable based on money
  document.getElementById('buyLegendEgg').disabled = state.money < EGG_COSTS.legendary;
  document.getElementById('buyMythEgg').disabled = state.money < EGG_COSTS.mythical;
  document.getElementById('buyEnchantedEgg').disabled = state.money < EGG_COSTS.enchanted;
}

// buy pedestal
function buyPetPedestal(){
  if(state.petPedestalsPurchased >= 2) return;
  if(state.money < PET_PEDESTAL_COST) return;
  state.money -= PET_PEDESTAL_COST;
  state.petPedestalsPurchased++;
  updateTop();
  updatePetButtonsUI();
  renderStands();
  save();
}

// buy egg functions: create egg inventory item
function buyEgg(type){
  const cost = EGG_COSTS[type];
  if(state.money < cost) return;
  state.money -= cost;
  const inv = {
    uid: uid(),
    name: (type.charAt(0).toUpperCase() + type.slice(1)) + ' Egg',
    isEgg: true,
    eggType: type,
    svg: getEggSvg(type, Math.floor(Math.random()*99999)),
    baseIdx: 0
  };
  state.inventory.push(inv);
  updateTop();
  renderInventory();
  save();
}

// Check pet timers and hatch if needed
function checkPetHatches(){
  const now = Date.now();
  let changed=false;
  for(const idxStr in state.petTimers){
    const idx = Number(idxStr);
    const t = state.petTimers[idx];
    if(!t) continue;
    // update timer UI elements (if any)
    const timerEl = document.querySelector(`.pet-timer[data-index='${idx}']`);
    if(timerEl){
      const left = Math.max(0, t - now);
      const s = Math.floor(left/1000);
      const m = Math.floor(s/60);
      const sec = s%60;
      timerEl.textContent = `${m}:${String(sec).padStart(2,'0')}`;
    }
    if(now >= t){
      // hatch
      const placed = state.petStands[idx];
      if(placed && placed.isEgg){
        // determine result
        const result = weightedPetPick(placed.eggType || 'legendary');
        let hatchName = result.name;
        if (result.name === 'IRL' && Array.isArray(result.subset)) {
          hatchName = result.subset[Math.floor(Math.random()*result.subset.length)];
        }
        registerPetOwned(hatchName);
        const petObj = {
          uid: uid(),
          name: hatchName,
          isEgg: false,
          eggType: null,
          petType: hatchName,
          petEps: result.eps,
          svg: getPetSvg(hatchName, Math.floor(Math.random()*99999))
        };
        // apply Flex T-Rex permanent multiplier if hatched
        if(result.name === 'Flex T-Rex' || result.name === 'Flex Dragon' || result.name === 'Flexicorn'){
          /* pedestal-based now; legacy flag neutralized */ state.permanentPetMultiplier = 1;
        }
        state.petStands[idx] = petObj; window.__udOnPetHatch && window.__udOnPetHatch(petObj);
        delete state.petTimers[idx];
        changed=true;
        if(hasAllPets()){
          state.ach = state.ach || {};
          if(!state.ach.petFourthUnlocked){ state.ach.petFourthUnlocked = true; }
        }
      } else {
        delete state.petTimers[idx];
      }
    }
  }
  if(changed){
    recalcEPS();
    renderInventory();
    renderStands();
    save();
  }
}

// Hook up pet UI open/close
$('#openPetShop').addEventListener('click', ()=>{
  $('#petOverlay').classList.add('show');
  $('#petOverlay').setAttribute('aria-hidden','false');
  updatePetButtonsUI();
});
$('#closePetShop').addEventListener('click', ()=>{
  $('#petOverlay').classList.remove('show');
  $('#petOverlay').setAttribute('aria-hidden','true');
});

document.getElementById('buyPetPedestal').addEventListener('click', buyPetPedestal);
document.getElementById('buyLegendEgg').addEventListener('click', ()=>buyEgg('legendary'));
document.getElementById('buyMythEgg').addEventListener('click', ()=>buyEgg('mythical'));
document.getElementById('buyEnchantedEgg').addEventListener('click', ()=>buyEgg('enchanted'));
document.getElementById('buyUniversalEgg').addEventListener('click', ()=>buyEgg('universal'));

/* -----------------------
   BOOT
----------------------- */

function reconcilePetDex(){
  try{
    if(!state.petDex) state.petDex = {};
    const add = (n)=>{ if(n) state.petDex[n]=true; };
    // from inventory
    (state.inventory||[]).forEach(it=>{ if(it && !it.isEgg){ add(it.petType || it.name); } });
    // from placed main pedestals
    Object.values(state.placed||{}).forEach(it=>{ if(it && !it.isEgg){ add(it.petType || it.name); } });
    // from pet pedestals
    (state.petStands||[]).forEach(p=>{ if(p && !p.isEgg){ add(p.petType || p.name); } });
  }catch(e){}
}
async function boot(){
  await load();
  // Apply the player's selected background and update quest completions after loading.
  try {
    if (state && state.selectedBackground && typeof applyBG === 'function') {
      applyBG(state.selectedBackground);
    }
  } catch (e) {}
  
  try {
    // Apply selected pedestal skin on load (red, aqua, strange)
    if (state && state.selectedPedestalSkin === 'red') {
      document.body.classList.add('red-pedestals');
      document.body.classList.remove('aqua-pedestals');
      document.body.classList.remove('strange-pedestals');
    } else if (state && state.selectedPedestalSkin === 'aqua') {
      document.body.classList.add('aqua-pedestals');
      document.body.classList.remove('red-pedestals');
      document.body.classList.remove('strange-pedestals');
    } else if (state && state.selectedPedestalSkin === 'strange') {
      document.body.classList.add('strange-pedestals');
      document.body.classList.remove('red-pedestals');
      document.body.classList.remove('aqua-pedestals');
    } else if (state && state.selectedPedestalSkin === 'sandy') { document.body.classList.add('sandy-pedestals'); document.body.classList.remove('red-pedestals'); document.body.classList.remove('aqua-pedestals'); document.body.classList.remove('strange-pedestals'); } else {
      document.body.classList.remove('red-pedestals');
      document.body.classList.remove('aqua-pedestals');
      document.body.classList.remove('strange-pedestals');
    }
  } catch (e) {}
try {
    if (typeof persistAllCompletions === 'function') {
      persistAllCompletions();
    }
  } catch (e) {}
  reconcilePetDex();
  if(!state.money) state.money = MONEY_START;
  if(!state.stands || state.stands.length!==STAND_COUNT){
    state.stands = Array(STAND_COUNT).fill(null);
  }
  if(!state.placed) state.placed = {};
  updateTop();
  renderInventory();
  renderStands();
  recalcEPS();
  ensureShop();
  updateRebirthUI();

  requestAnimationFrame(tick);
}
/**
 * Initialize the game only after verifying the login state.
 * If a login request is pending, we wait for the owner to approve before proceeding.
 * When approved, the owner writes a key of the form "flex_login_approved_<username>" in localStorage.
 * This function checks for that approval and sets USER_ID accordingly. If there is no approval yet,
 * it displays an informational alert and aborts the boot process (the player can refresh later).
 */
async function initLoginAndBoot() {
  // If USER_ID is not set (null/undefined), we may need to handle pending login requests.
  if (!USER_ID) {
    // When the user menu is active and no pending request exists, wait for input.
    if (!localStorage.getItem('flex_login_pending') && window.__loginChoiceShown) {
      return;
    }
    const pending = localStorage.getItem('flex_login_pending');
    if (pending) {
      // If a pending overlay is visible, don't interrupt with an alert; the overlay handles cancel/refresh messaging.
      if (window.__pendingOverlayShown) {
        return;
      }
      // Check the server for approval of this username.
      const approved = await checkApproval(pending);
      if (approved) {
        // Assign the user, update localStorage and clean up server records.
        USER_ID = pending;
        localStorage.setItem('flex-userid', USER_ID);
        localStorage.removeItem('flex_login_pending');
        try { await removeLoginRequest(pending); } catch (e) {}
        try { await clearApproval(pending); } catch (e) {}
        // Update display
        const ud = document.getElementById('userDisplay');
        if (ud) ud.textContent = USER_ID ? `User: ${USER_ID}` : 'No user';
      } else {
        // Still waiting for approval. Inform the player and abort loading.
        alert('Your login request is still awaiting approval.\n\nPlease ask the owner to approve your request, then refresh this page.');
        return;
      }
    } else {
      // No USER_ID and no pending login: user may have cancelled; wait for them to choose again.
      return;
    }
  }
  // If we reach here, USER_ID is available; proceed to boot the game.
  await boot();

  // After loading, refresh achievements to reflect any quest completions/background unlocks.
  try {
    if (typeof window !== 'undefined' && typeof window.__achRefresh === 'function') {
      window.__achRefresh();
    }
  } catch (e) {}
}

// Kick off the initialization routine instead of calling boot() directly.
initLoginAndBoot();

// Replace the legacy resetUser handler with a Log Out handler.  This logs the user out
// by clearing the stored username and pending login request, then reloads the page
// so the login/create account menu is shown again.
// Re-purpose the existing reset user button as a Log Out button.  If the button
// exists, update its label and attach a handler that clears the stored username
// and pending login request.  When confirmed, the page reloads to show the login
// menu again.  If no reset user button is present, nothing happens.
{ const resetBtn = document.getElementById("resetUserBtn");
  if (resetBtn) {
    resetBtn.textContent = 'Log Out';
    // Make the handler asynchronous so we can await a save if needed.  In addition to
    // removing the username and pending request from localStorage, also clear any
    // sessionStorage flag used during account creation.  After clearing these, trigger
    // a full page reload so the game reâ€‘enters the login flow.  Without clearing
    // sessionStorage.flex-userid-just-set the USER_ID variable may be repopulated
    // immediately on reload, leaving the player logged in despite the reload.
    resetBtn.addEventListener("click", async function() {
      // If there is no current user we don't need to log out.  Simply return.
      if (!USER_ID) return;
      if (confirm("Are you sure you want to log out? You can log back in with your username later.")) {
        try {
          // Ensure any pending save completes before logging out.  Wrap in a
          // try/catch so a save failure doesn't prevent logout.
          if (typeof save === 'function' && __loadComplete) { await save(); }
        } catch (e) {}
        try { localStorage.removeItem("flex-userid"); } catch(e){}
        try { localStorage.removeItem("flex_login_pending"); } catch(e){}
        try { sessionStorage.removeItem('flex-userid-just-set'); } catch(e){}
        // Reset the inâ€‘memory USER_ID so subsequent code won't assume a player is logged in.
        USER_ID = null;
        // Immediately reload the page to reâ€‘run the login flow.  Using replace()
        // avoids creating a new history entry.
        location.replace(location.href);
      }
    });
  }
}

  

  window.addEventListener("beforeunload", save);
  window.addEventListener("pagehide", save);
  document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState === "hidden") try{ save(); }catch(e){} });

// Ensure Pet Shop opens scrolled to the top so the X is visible
(function(){
  const btn = document.getElementById('openPetShop');
  if (btn) {
    btn.addEventListener('click', () => {
      const overlay = document.getElementById('petOverlay');
      const sheet = overlay ? overlay.querySelector('.shop') : null;
      if (sheet) sheet.scrollTop = 0;
      if (overlay) overlay.scrollTop = 0;
    });
  }
})();

</script>
<!-- Right-side buttons -->
<div class="right-rail">

<!-- FLEX PASS (Rising Tides) -->
<button class="flexpass-btn" id="openFlexPass" title="FLEX PASS">
  <img alt="Flex Pass" src="icons/flex_pass_icon.png"/>
</button>
<!-- Achievements -->
<button class="icon-achievements" id="openAchievements" onclick="document.getElementById('achOverlay').classList.add('show'); window.__achRefresh &amp;&amp; window.__achRefresh();" title="Achievements">
<svg fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" viewbox="0 0 24 24">
<circle cx="12" cy="8" r="6"></circle><path d="M8 14v6l4-2 4 2v-6"></path>
</svg>
</button>
<!-- Background Changer (middle) -->
<button class="bg-selector-btn" id="openBgSelector" onclick="document.getElementById('bgOverlay').classList.add('show'); window.__renderBgGrid &amp;&amp; window.__renderBgGrid();" title="Backgrounds">
<svg fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" viewbox="0 0 24 24">
<path d="M21 21H3V3h18zM7 17l3-4 2 3 3-5 2 6H7z"></path>
</svg>
</button>
<!-- Delete Mode (bottom) -->
<button aria-pressed="false" class="delete-toggle-btn" id="deleteToggleBtn" title="Toggle deletion mode">
<svg aria-hidden="true" fill="none" height="40" stroke="#e84545" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2" viewbox="0 0 24 24" width="40">
<polyline points="3 6 5 6 21 6"></polyline>
<path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
<line x1="10" x2="10" y1="11" y2="17"></line>
<line x1="14" x2="14" y1="11" y2="17"></line>
</svg>
<!-- Inventory Filters (under Trash) -->
<button aria-controls="invFilterSheet" aria-expanded="false" class="inv-filter-toggle" id="invFilterToggle" title="Quick inventory filters">
<svg aria-hidden="true" fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24">
<polyline points="6 9 12 15 18 9"></polyline>
</svg>
</button>
</button></div>

<!-- FLEX PASS Overlay -->
<div aria-hidden="true" class="overlay" id="flexPassOverlay">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="flexPassTitle">
    <button class="closeX" id="closeFlexPass">âœ•</button>
    <div id="flexPassHeader">
      <div>
        <div class="season">SEASON 1 | RISING TIDES</div>
        <h2 id="flexPassTitle">FLEX PASS</h2>
      </div>
      <div id="flexLevelBox">
        <div id="flexLevelNum">LVL 1</div>
        <div style="display:flex; align-items:center; gap:10px; min-width:420px;">
          <div id="flexXPBar" style="flex:1"><div id="flexXPFill"></div></div>
          <div id="flexXPCap">0 / 100 XP</div>
        </div>
      </div>
    </div>
    <div class="flex-rows">
      <div class="row-label" style="font-weight:1000; font-size:22px; letter-spacing:.5px;">REWARDS</div>
      <div class="flex-row" id="flexRow1"></div>
      <div class="row-label" style="font-weight:1000; font-size:22px; letter-spacing:.5px; margin-top:6px;">REWARDS</div>
      <div class="flex-row row2" id="flexRow2"></div>
    </div>
  </div>
</div>
<!-- Achievements Overlay -->
<div aria-hidden="true" class="overlay" id="achOverlay">
<div aria-labelledby="achTitle" aria-modal="true" class="sheet" role="dialog">
<button aria-label="Close" class="closeX" id="closeAchievements" onclick="document.getElementById('achOverlay').classList.remove('show')">âœ•</button>
<h2 id="achTitle">Achievements</h2>
<div class="achv-wrap">
<div class="rarity-rail" id="rarityRail">
<div class="rail-btn" data-tab="quests"><span>QUESTS</span><span class="badge-dot" id="questsDot"></span></div>
<div class="rail-btn" data-tab="quests2" id="btn-quests2" style="display:none;"><span>QUESTS 2</span><span class="badge-dot" id="dot-quests2"></span></div>
<div class="rail-btn" data-tab="quests3" id="btn-quests3" style="display:none;"><span>QUESTS 3</span><span class="badge-dot" id="dot-quests3"></span></div>
<div class="rail-btn" data-tab="petquests"><span>PET QUESTS</span><span class="badge-dot" id="dot-petquests"></span></div>
<div class="rail-btn" data-tab="common"><span>COMMON</span><span class="badge-dot" id="dot-common"></span></div>
<div class="rail-btn" data-tab="rare"><span>RARE</span><span class="badge-dot" id="dot-rare"></span></div>
<div class="rail-btn" data-tab="epic"><span>EPIC</span><span class="badge-dot" id="dot-epic"></span></div>
<div class="rail-btn" data-tab="legendary"><span>LEGENDARY</span><span class="badge-dot" id="dot-legendary"></span></div>
<div class="rail-btn" data-tab="legacy"><span>LEGACY</span><span class="badge-dot" id="dot-legacy"></span></div>
<div class="rail-btn" data-tab="unique"><span>UNIQUE</span><span class="badge-dot" id="dot-unique"></span></div>
<div class="rail-btn" data-tab="exotic"><span>EXOTIC</span><span class="badge-dot" id="dot-exotic"></span></div>
<div class="rail-btn" data-tab="mythic"><span>MYTHIC</span><span class="badge-dot" id="dot-mythic"></span></div>
<div class="rail-btn" data-tab="crypto"><span>CRYPTO</span><span class="badge-dot" id="dot-crypto"></span></div>
</div>
<div id="achContent"></div>
</div>
</div>
</div>
<!-- Background Selector Overlay -->
<div aria-hidden="true" class="overlay" id="bgOverlay">
<div aria-labelledby="bgTitle" aria-modal="true" class="sheet" role="dialog">
<button aria-label="Close" class="closeX" id="closeBg" onclick="document.getElementById('bgOverlay').classList.remove('show')">âœ•</button>
<h2 id="bgTitle">Backgrounds</h2>
<div aria-label="Background sections" class="bg-side-tabs" id="bgSideTabs">
<button aria-controls="bgGrid" aria-selected="true" class="bg-tab active" data-target="bgGrid">BACKGROUNDS</button>
<button aria-controls="pedestalPage" aria-selected="false" class="bg-tab" data-target="pedestalPage">PEDESTALS</button>
</div>
<div class="bg-grid" id="bgGrid"></div>
<div class="pedestal-page" id="pedestalPage" style="display:none;"></div>
</div>
</div>
<script>
(function(){
  const RLIST=['common','rare','epic','legendary','legacy','unique','exotic','mythic','crypto'];
  const R2BG={common:'green',rare:'blue',epic:'purple',legendary:'orange',legacy:'legacy',unique:'unique',exotic:'exotic',mythic:'mythic',crypto:'crypto'};
  // Extend the background definitions to include the Beach Vibes reward.  This new
  // entry associates the reward ID `beachvibes` with the CSS class
  // `bg-beachvibes` and a humanâ€‘readable label.  Without this, applyBG would
  // ignore the reward entirely because it only recognizes keys defined here.
  const BG={green:{c:'bg-green',l:'GREEN'},blue:{c:'bg-blue',l:'BLUE'},purple:{c:'bg-purple',l:'PURPLE'},orange:{c:'bg-orange',l:'ORANGE'},legacy:{c:'bg-legacy',l:'LEGACY'},unique:{c:'bg-unique',l:'UNIQUE'},exotic:{c:'bg-exotic',l:'EXOTIC'},mythic:{c:'bg-mythic',l:'MYTHIC'},crypto:{c:'bg-crypto',l:'CRYPTO'},redblue:{c:'redblue',l:'RED/BLUE'},rainbow:{c:'bg-rainbow',l:'RAINBOW'},beachvibes:{c:'bg-beachvibes',l:'BEACH VIBES'}};

  window.state=window.state||{};
  state.ach=state.ach||{questsDone:{},petPedestalGranted:false};
  state.unlockedBackgrounds=state.unlockedBackgrounds||{default:true};
  state.selectedBackground=state.selectedBackground||'default';

  const $=s=>document.querySelector(s);
  const $$=s=>Array.from(document.querySelectorAll(s));
  const keyOf=r=>String(r||'').toLowerCase();

  function countAll(fn){let n=0;(state.inventory||[]).forEach(i=>{try{if(fn(i))n++;}catch{}});Object.values(state.placed||{}).forEach(i=>{try{if(fn(i))n++;}catch{}});return n;}
  function countR(r){return countAll(i=>keyOf(i.rarity)===r);}
  function hasPlaced(r){return Object.values(state.placed||{}).some(i=>keyOf(i.rarity)===r);}
  function eggs(){return countAll(i=>!!i.isEgg);}

  function unlockBG(k){state.unlockedBackgrounds[k]=true;__renderBgGrid&&__renderBgGrid(); if(typeof save==='function') save();}
  function applyBG(k){
    // Always remove any previously applied background classes, including the new
    // Beach Vibes class, before adding the selected one.  Without removing
    // `bg-beachvibes` here the class would persist and override other
    // backgrounds when switching away.
    document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-rainbow','redblue','bg-crypto','bg-beachvibes');
    if(k==='default'){state.selectedBackground='default';return;}
    const d=BG[k]; if(!d) return;
    document.body.classList.add(d.c); state.selectedBackground=k;
  }

  const GLOBAL=[
    {id:'g_c15',label:'Purchase 15 Common',check:()=>countR('common')>=15},
    {id:'g_r15',label:'Purchase 15 Rare',check:()=>countR('rare')>=15},
    {id:'g_e5', label:'Own 5 Epic',check:()=>countR('epic')>=5},
    {id:'g_l2', label:'Own 2 Legendary',check:()=>countR('legendary')>=2},
    {id:'g_eg5',label:'Purchase 5 Eggs',check:()=>eggs()>=5},
    {id:'g_pl4',label:'Fill all 4 pedestals',check:()=>Array.isArray(state.stands)&&state.stands.every(Boolean)},
    {id:'g_maxpet',label:'Max Pet Pedestals',check:()=>(state.petPedestalsPurchased||0)>=2},
    {id:'g_u1', label:'Own a Unique',check:()=>countR('unique')>=1},
    {id:'g_ex1',label:'Own an Exotic',check:()=>countR('exotic')>=1},
    {id:'g_my1',label:'Own a Mythic',check:()=>countR('mythic')>=1}
  ];
  
  
  const ELITE=[    {id:'h_u15',      label:'Own 15 Unique',                     check:()=> countR('unique') >= 15},
    {id:'h_x5',       label:'Own 5 Exotic',                      check:()=> countR('exotic') >= 5},
    {id:'h_m4',       label:'Own 4 Mythic',                      check:()=> countR('mythic') >= 4},
    {id:'h_cr1',      label:'Own 1 Crypto',                      check:()=> countR('crypto') >= 1},
    {id:'h_cr3',      label:'Own 3 Crypto',                      check:()=> countR('crypto') >= 3},
    {id:'h_bg',       label:'Apply a custom Background',         check:()=> String(state.selectedBackground||'default') !== 'default'},
    {id:'h_pets15',   label:'Own 15 different pets',             check:()=> Object.keys(state.petDex||{}).length >= 15},
    {id:'h_c65',  label:'Own 65 Common items',            check:()=> countR('common') >= 65},
    {id:'h_place_x',  label:'Place an Exotic',                   check:()=> hasPlaced('exotic')},
    {id:'h_rebirth5', label:'Rebirth five times',                check:()=> (state.rebirthLevel||0) >= 5}
  ];

  const ULTIMATE=[{id:'u3_c100',   label:'Own 100 Common items',           check:()=> countR('common') >= 100},
    {id:'u3_r40',    label:'Own 40 Rare items',              check:()=> countR('rare') >= 40},
    {id:'u3_e20',    label:'Own 20 Epic items',              check:()=> countR('epic') >= 20},
    {id:'u3_l8',     label:'Own 8 Legendary items',          check:()=> countR('legendary') >= 8},
    {id:'u3_m6',     label:'Own 6 Mythic items',             check:()=> countR('mythic') >= 6},
    {id:'u3_x7',     label:'Own 7 Exotic items',             check:()=> countR('exotic') >= 7},
    {id:'u3_cr5',    label:'Own 5 Crypto items',             check:()=> countR('crypto') >= 5},
    {id:'u3_place_m',label:'Place a Mythic',                 check:()=> hasPlaced('mythic')},
    {id:'u3_rebirth10',label:'Reach level 9 rebirth',check:()=> (state.rebirthLevel||0) >= 9}];

  function __isDone(q){ return (state.ach && state.ach.questsDone && !!state.ach.questsDone[q.id]) || (!!q.check && q.check()); }

  const RQ={
    common:[
      {id:'c_own15',label:'Own 15 Common',check:()=>countR('common')>=15},
      {id:'c_place',label:'Place a Common',check:()=>hasPlaced('common')},
      {id:'c_own30',label:'Own 30 Common',check:()=>countR('common')>=30}
    ],
    rare:[
      {id:'r_own15',label:'Own 15 Rare',check:()=>countR('rare')>=15},
      {id:'r_place',label:'Place a Rare',check:()=>hasPlaced('rare')},
      {id:'r_own25',label:'Own 25 Rare',check:()=>countR('rare')>=25}
    ],
    epic:[
      {id:'e_own5',label:'Own 5 Epic',check:()=>countR('epic')>=5},
      {id:'e_place',label:'Place an Epic',check:()=>hasPlaced('epic')},
      {id:'e_own10',label:'Own 10 Epic',check:()=>countR('epic')>=10}
    ],
    legendary:[
      {id:'l_own2',label:'Own 2 Legendary',check:()=>countR('legendary')>=2},
      {id:'l_place',label:'Place a Legendary',check:()=>hasPlaced('legendary')},
      {id:'l_own4',label:'Own 4 Legendary',check:()=>countR('legendary')>=4}
    ],
    legacy:[
      {id:'lc_own1',label:'Own 1 Legacy',check:()=>countR('legacy')>=1},
      {id:'lc_place',label:'Place a Legacy',check:()=>hasPlaced('legacy')},
      {id:'lc_own2',label:'Own 2 Legacy',check:()=>countR('legacy')>=2}
    ],
    unique:[
      {id:'u_own1',label:'Own 1 Unique',check:()=>countR('unique')>=1},
      {id:'u_place',label:'Place a Unique',check:()=>hasPlaced('unique')},
      {id:'u_own2',label:'Own 2 Unique',check:()=>countR('unique')>=2}
    ],
    exotic:[
      {id:'x_own1',label:'Own 1 Exotic',check:()=>countR('exotic')>=1},
      {id:'x_place',label:'Place an Exotic',check:()=>hasPlaced('exotic')},
      {id:'x_own2',label:'Own 2 Exotic',check:()=>countR('exotic')>=2}
    ],
    mythic:[
      {id:'m_own1',label:'Own 1 Mythic',check:()=>countR('mythic')>=1},
      {id:'m_place',label:'Place a Mythic',check:()=>hasPlaced('mythic')},
      {id:'m_own2',label:'Own 2 Mythic',check:()=>countR('mythic')>=2}
    ]
  ,
crypto:[
  {id:'cr_own1',label:'Own 1 Crypto',check:()=>countR('crypto')>=1},
  {id:'cr_place',label:'Place a Crypto',check:()=>hasPlaced('crypto')},
  {id:'cr_own2',label:'Own 2 Crypto',check:()=>countR('crypto')>=2}
]};

  // Persist completions for ANY quest that is currently true (runs even when overlay is closed)
  function persistAllCompletions(){
    let changed=false;
    GLOBAL.forEach(q=>{ if(q.check && q.check() && !(state.ach.questsDone||{})[q.id]){ state.ach.questsDone[q.id]=true; changed=true; } });
    RLIST.forEach(r=>{ (RQ[r]||[]).forEach(q=>{ if(q.check && q.check() && !(state.ach.questsDone||{})[q.id]){ state.ach.questsDone[q.id]=true; changed=true; } }); });
    
    try{ (ELITE||[]).forEach(q=>{ if(q.check && q.check() && !(state.ach.questsDone||{})[q.id]){ state.ach.questsDone[q.id]=true; changed=true; } }); }catch(e){}
    if(changed){ window.__addonSave&&__addonSave(); if(typeof save==='function') save(); }
  }

  function qRow(q){
    const now = !!(q.check && q.check());
    if(now){ state.ach.questsDone[q.id]=true; window.__addonSave&&__addonSave(); if(typeof save==='function') save(); }
    const ok = __isDone(q);
    const d=document.createElement('div');
    d.className='quest-card';
    d.innerHTML='<div class=\"q-left\">'
      + '<div class=\"q-check '+(ok?'ok':'')+'\">'+(ok?'âœ“':'')+'</div>'
      + '<div style=\"font-size:20px;font-weight:900;\">'+q.label+'</div>'
      + '</div>';
    return d;
  }

  function gDone(){ return GLOBAL.every(q => __isDone(q)); }

  function refresh(){
    // First, persist any newly-true quests permanently
    persistAllCompletions();

    const md=(id,done)=>{const el=document.getElementById(id); if(el) el.classList.toggle('done',!!done);};
    md('questsDot', gDone());
    RLIST.forEach(r=>{ const all=(RQ[r]||[]).every(q=>__isDone(q)); md('dot-'+r, all); });

    // Pet Quests overall completion dot (persists across refresh via achievement flag)
    try{
      const dotPet = document.getElementById('dot-petquests');
      if(dotPet && window.state){
        const donePet = !!(state.ach && state.ach.petFourthUnlocked);
        // If the 4th pedestal has ever been unlocked, keep the Pet Quests dot green.
        dotPet.classList.toggle('done', donePet);
      }
    }catch(e){}

    // Reveal second quest page once first page is complete
    try{
      const q2 = document.getElementById('btn-quests2');
      if(q2) q2.style.display = gDone() ? '' : 'none';
    }catch(e){}

    // Elite page progress + dot
    let eliteAll = false;
    try{
      eliteAll = (ELITE||[]).every(q=>__isDone(q));
      const d2 = document.getElementById('dot-quests2');
      if(d2) d2.classList.toggle('done', !!eliteAll);
    }catch(e){}

    
    // Reveal third quest page once second page is complete
    try{
      const q3 = document.getElementById('btn-quests3');
      if(q3) q3.style.display = eliteAll ? '' : 'none';
    }catch(e){}

    // Master page progress + dot
    let ultimateAll = false;
    try{
      ultimateAll = (ULTIMATE||[]).every(q=>__isDone(q));
      const d3 = document.getElementById('dot-quests3');
      if(d3) d3.classList.toggle('done', !!ultimateAll);
    }catch(e){}

    // Reward: unlock Aqua Pedestal when all 10 are complete
    try{
      if(ultimateAll){
        state.ach = state.ach || {questsDone:{}};
        if(!state.ach.aquaPedestalUnlocked){
          state.ach.aquaPedestalUnlocked = true;
          state.pedestalSkins = Object.assign({default:true}, state.pedestalSkins||{}, {aqua:true});
          window.__addonSave && __addonSave();
        }
      }
    }catch(e){}  
// Reward: unlock Red Pedestal when all 12 are complete
    try{
      if(eliteAll){
        state.ach = state.ach || {questsDone:{}};
        if(!state.ach.redPedestalUnlocked){
          state.ach.redPedestalUnlocked = true;
          state.pedestalSkins = Object.assign({default:true}, state.pedestalSkins||{}, {red:true});
          window.__addonSave && __addonSave();
        }
      }
    }catch(e){}    

    if(gDone() && !state.ach.petPedestalGranted){
  state.ach.petPedestalGranted=true;
  state.ach.petThirdUnlocked=true;
  if(!Array.isArray(state.petStands)) state.petStands=[null,null,null];
  if(!Array.isArray(state.petTimers)) state.petTimers=[null,null,null];
  if(typeof renderStands==='function') renderStands();
  if(typeof recalcEPS==='function') recalcEPS();
 window.__addonSave&&__addonSave();}

    Object.entries(R2BG).forEach(([r,b])=>{ if((RQ[r]||[]).every(q=>__isDone(q))) unlockBG(b); window.__addonSave&&__addonSave(); });
    if(RLIST.every(r => (RQ[r]||[]).every(q=>__isDone(q)))) unlockBG('rainbow'); window.__addonSave&&__addonSave();

    const active=document.querySelector('.rail-btn.active');
    if(active) renderTab(active.dataset.tab);

    if(typeof save==='function') save();
  }
  window.__achRefresh=refresh;

  function renderTab(tab){
    const host=document.getElementById('achContent'); if(!host) return;
    host.innerHTML='';
    if(tab==='quests'){
      const head=document.createElement('div');
      head.innerHTML='<h3 style=\"margin:8px 0 10px;font-family:Bungee;letter-spacing:1px;\">Quests</h3>'
        + '<div style=\"opacity:.85;margin-bottom:10px\">Complete the 10 quests to earn <span class=\"reward-pill\">+1 Pet Pedestal</span>.</div>';
      host.appendChild(head);
      GLOBAL.forEach(q=>host.appendChild(qRow(q)));
      const done=GLOBAL.filter(q=>__isDone(q)).length;
      const f=document.createElement('div'); f.style.cssText='margin-top:12px;font-weight:900;opacity:.9;';
      f.textContent='Progress: '+done+' / '+GLOBAL.length; host.appendChild(f);
      return;
    }

    if(tab==='quests2'){
      const host=document.getElementById('achContent'); if(!host) return;
      const head=document.createElement('div');
      head.innerHTML='<h3 style="margin:8px 0 10px;font-family:Bungee;letter-spacing:1px;">Elite Quests</h3>'
        + '<div style="opacity:.85;margin-bottom:10px">12 tougher quests that pull from more game systems. Complete them all to unlock a <span class="reward-pill">Red Pedestal</span>.</div>';
      host.appendChild(head);
      (ELITE||[]).forEach(q=>host.appendChild(qRow(q)));
      const done=(ELITE||[]).filter(q=>__isDone(q)).length;
      const f=document.createElement('div'); f.style.cssText='margin-top:12px;font-weight:900;opacity:.9;';
      f.textContent='Progress: '+done+' / '+(ELITE||[]).length; host.appendChild(f);
      if((state.ach||{}).redPedestalUnlocked){
        const ok=document.createElement('div'); ok.style.cssText='margin-top:10px;font-weight:900;color:#73ff81;';
        ok.textContent='Reward unlocked: Red Pedestal (equip it from Backgrounds â†’ Pedestals).';
        host.appendChild(ok);
      }
      return;
    }

    
    
    if(tab==='quests3'){
      const host=document.getElementById('achContent'); if(!host) return;
      const head=document.createElement('div');
      head.innerHTML='<h3 style="margin:8px 0 10px;font-family:Bungee;letter-spacing:1px;">Master Quests</h3>'
        + '<div style="opacity:.85;margin-bottom:10px">The hardest quests. Complete them all to unlock a <span class="reward-pill">Light/Dark Blue Pedestal</span>.</div>';
      host.appendChild(head);
      (ULTIMATE||[]).forEach(q=>host.appendChild(qRow(q)));
      const done=(ULTIMATE||[]).filter(q=>__isDone(q)).length;
      const f=document.createElement('div'); f.style.cssText='margin-top:12px;font-weight:900;opacity:.9;';
      f.textContent='Progress: '+done+' / '+(ULTIMATE||[]).length; host.appendChild(f);
      if((state.ach||{}).aquaPedestalUnlocked){
        const ok=document.createElement('div'); ok.style.cssText='margin-top:10px;font-weight:900;color:#73ff81;';
        ok.textContent='Reward unlocked: Light/Dark Blue Pedestal (equip it from Backgrounds â†’ Pedestals).';
        host.appendChild(ok);
      }
      return;
    }
if(tab==='quests3'){
      const host=document.getElementById('achContent'); if(!host) return;
      const head=document.createElement('div');
      head.innerHTML='<h3 style="margin:8px 0 10px;font-family:Bungee;letter-spacing:1px;">Master Quests</h3>'
        + '<div style="opacity:.85;margin-bottom:10px">The hardest quests. Complete them all to unlock a <span class="reward-pill">Light/Dark Blue Pedestal</span>.</div>';
      host.appendChild(head);
      (ULTIMATE||[]).forEach(q=>host.appendChild(qRow(q)));
      const done=(ULTIMATE||[]).filter(q=>__isDone(q)).length;
      const f=document.createElement('div'); f.style.cssText='margin-top:12px;font-weight:900;opacity:.9;';
      f.textContent='Progress: '+done+' / '+(ULTIMATE||[]).length; host.appendChild(f);
      if((state.ach||{}).aquaPedestalUnlocked){
        const ok=document.createElement('div'); ok.style.cssText='margin-top:10px;font-weight:900;color:#73ff81;';
        ok.textContent='Reward unlocked: Light/Dark Blue Pedestal (equip it from Backgrounds â†’ Pedestals).';
        host.appendChild(ok);
      }
      return;
    }
if(tab!=='petquests'){
    const hdr=document.createElement('div');
    hdr.innerHTML='<h3 style=\"margin:8px 0 10px;font-family:Bungee;letter-spacing:1px;\">'+tab.toUpperCase()+'</h3>'
      + '<div style=\"opacity:.85;margin-bottom:10px\">Complete these to unlock a themed background '+(R2BG[tab]?'for this rarity':'')+'.</div>';
    host.appendChild(hdr);
    (RQ[tab]||[]).forEach(q=>host.appendChild(qRow(q)));
    const c=(RQ[tab]||[]).filter(q=>__isDone(q)).length;
    const f=document.createElement('div'); f.style.cssText='margin-top:12px;font-weight:900;opacity:.9;';
    f.textContent='Progress: '+c+' / '+(RQ[tab]||[]).length; host.appendChild(f);
    }
  
    if(tab==='petquests'){
      const head=document.createElement('div');
      head.innerHTML='<h3 style="margin:8px 0 10px;font-family:Bungee;letter-spacing:1px;">Pet Quests</h3>'
        + '<div style="opacity:.85;margin-bottom:10px">Collect pets from each egg. Complete them all to unlock a <span class="reward-pill">4th Pet Pedestal</span> (2â€‘minute hatch).</div>';
      host.appendChild(head);

      const pc = petCountsByEgg();
      Object.keys(PET_TABLES)
        // Hide Galaxy Egg from the Pet Quests UI and remove the Demoegg which
        // is only used for the Stranger Things event.  Without filtering out
        // 'demoegg', players see a quest for a pet that doesn't exist in the normal game.
        .filter(k => k !== 'galaxy' && k.toLowerCase() !== 'demoegg')
        .forEach(egg=>{
          const row=document.createElement('div');
        const owned = pc.owned[egg]||0, total = pc.totals[egg]||0;
        const pct = total? Math.floor((owned/total)*100) : 0;
        row.className='quest-card';
        row.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;width:100%;">'
          + '<div style="font-size:20px;font-weight:900;text-transform:capitalize;">'+egg+' Egg</div>'
          + '<div style="font-weight:900;">'+owned+' / '+total+'</div>'
          + '</div>'
          + '<div style="height:10px;background:rgba(0,0,0,.25);border-radius:8px;margin-top:6px;overflow:hidden;">'
          +   '<div style="height:100%;width:'+pct+'%;background:linear-gradient(90deg,#6dff79,#3ad0ff);"></div>'
          + '</div>';
        host.appendChild(row);
      });

      const all = hasAllPets();
      const f=document.createElement('div'); f.style.cssText='margin-top:12px;font-weight:900;opacity:.9;';
      f.textContent='Complete sets: '+ (all?'ALL DONE âœ…':'In progress');
      host.appendChild(f);
      const dot=document.getElementById('dot-petquests'); if(dot) dot.classList.toggle('done', all);
      if(all){ state.ach = state.ach || {}; state.ach.petFourthUnlocked = true; }
      return;
    }
}

  const rail=document.getElementById('rarityRail');
  if(rail){
    rail.addEventListener('click',e=>{
      const b=e.target.closest('.rail-btn'); if(!b) return;
      $$('.rail-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); renderTab(b.dataset.tab);
    });
    const first=rail.querySelector('[data-tab=\"quests\"]'); if(first){ first.classList.add('active'); renderTab('quests'); }
  }

  function __renderBgGrid(){
    const g=document.getElementById('bgGrid'); if(!g) return; g.innerHTML='';
    const tiles=[
      {k:'default',l:'DEFAULT',css:'background:linear-gradient(to bottom,#89CFF0,#90EE90);'},
      {k:'green',l:'GREEN',css:'background:linear-gradient(#3edc64,#1e6f2b);'},
      {k:'blue',l:'BLUE',css:'background:linear-gradient(#4aa3ff,#0b2e6e);'},
      {k:'purple',l:'PURPLE',css:'background:linear-gradient(#a76bff,#ff72c6);'},
      {k:'orange',l:'ORANGE',css:'background:linear-gradient(#ff9b3d,#b98200);'},
      {k:'legacy',l:'LEGACY',css:'background:linear-gradient(135deg,#ff7eb3,#ff2a68);'},
      {k:'unique',l:'UNIQUE',css:'background:linear-gradient(135deg,#0a1a4b,#123a8c);'},
      {k:'exotic',l:'EXOTIC',css:'background:linear-gradient(135deg,#cfefff,#a0a9b8);'},
      {k:'mythic',l:'MYTHIC',css:'background:linear-gradient(135deg,#FFD700,#B8860B);'},
      {k:'crypto',l:'CRYPTO',css:'background:linear-gradient(135deg,#ff62d5,#ffd84a);'},
      {k:'redblue',l:'RED/BLUE',css:'background:linear-gradient(#ff4b5c,#4b6aff);'},
      {k:'rainbow',l:'RAINBOW',css:'background:linear-gradient(135deg,#ff004c,#ff7a00,#ffd400,#18e300,#00e7ff,#3a31ff,#ff31ff);background-size:300% 300%;'},
      // Insert a tile for the Beach Vibes background.  The style uses the
      // custom image bundled with the game and centres it.  This entry must
      // appear before the closing bracket so that it's part of the array.
      {k:'beachvibes',l:'BEACH VIBES',css:"background:url('background_files/beach_vibes.png') center/cover no-repeat;"}
    ];
    tiles.forEach(t=>{
      const el=document.createElement('div');
      el.className='bg-tile'+(!state.unlockedBackgrounds[t.k]?' locked':'');
      el.style.cssText+=t.css;
      el.innerHTML='<div style=\"font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)\">'+t.l+'</div>'
        + '<button class=\"buy bg-apply\" '+(!state.unlockedBackgrounds[t.k]?'disabled':'')+'>Apply</button>';
      el.querySelector('.bg-apply').onclick=()=>{ if(!state.unlockedBackgrounds[t.k])return; applyBG(t.k); if(typeof save==='function') save(); };
      g.appendChild(el);
    });
  }
  window.__renderBgGrid=__renderBgGrid;

  const tbtn=document.getElementById('toggleBackground');
  if(tbtn){ tbtn.addEventListener('click', ()=>{ state.unlockedBackgrounds.redblue=true; if(typeof save==='function') save(); }); }

  // Wrap lifecycle methods to ensure refresh runs on any major state change
  const _ri=window.renderInventory||function(){}; window.renderInventory=function(){ _ri(); refresh(); };
  const _rs=window.renderStands||function(){}; window.renderStands=function(){ _rs(); refresh(); };
  const _re=window.recalcEPS||function(){}; window.recalcEPS=function(){ _re(); refresh(); };

  // Initial sweep to persist any already-true quests
  setTimeout(()=>{ persistAllCompletions(); refresh(); },0);
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>
<script>
// --- Add-on: Third Pet Pedestal renderer (non-destructive) ---
(function(){
  const HATCH_DURATION = window.THIRD_HATCH_DURATION || window.HATCH_DURATION || (60*1000*5); // fallback 5 min if not defined

  function ensureArrays(){
    if(!Array.isArray(state.petStands)) state.petStands=[];
    if(!Array.isArray(state.petTimers)) state.petTimers=[];
    while(state.petStands.length<3) state.petStands.push(null);
    while(state.petTimers.length<3) state.petTimers.push(null);
  }

  function renderThirdPetSlot(){
    if(!(state.ach && state.ach.petThirdUnlocked)) return;
    ensureArrays();
    const row = document.querySelector('.pet-row');
    if(!row) return;

    // If we already drew the second row once, clear it to avoid duplicates
    const old = row.querySelectorAll('.pet-stand.addon-second-row');
    old.forEach(n=>n.remove());

    // Create 4 boxes for the second row, but only col=1 gets the pedestal (index 2)
    for(let col=0; col<4; col++){
      const pbox=document.createElement('div');
      pbox.className='pet-stand addon-second-row';
      if(col===1){ // centered under the first two
        const placeIndex = 2;
        const pPed = document.createElement('div');
        pPed.className='pet-pedestal';
        pbox.appendChild(pPed);

        const placed = state.petStands[placeIndex];
        if(placed){
          const p = document.createElement('div');
          p.className='pet-placed';
          const nameLabel = (placed.name && placed.name.trim()) ? placed.name : (placed.petType||placed.eggType||'Pet');
          p.innerHTML = `<img src='${placed.svg}' alt='${nameLabel}' style="width:64px;height:64px;border-radius:12px;">`
                       + `<div class="name-badge"><span>${nameLabel}</span></div>`;
          pbox.appendChild(p);

          if(placed.isEgg && state.petTimers[placeIndex]){
            const timer=document.createElement('div');
            timer.className='pet-timer';
            timer.dataset.index=placeIndex;
            pbox.appendChild(timer);
          }
        }

        pbox.addEventListener('click', ()=>{
          // Remove if nothing selected
          if(!state.selectedItemUid){
            if(state.petStands[placeIndex]){
              state.inventory.push(state.petStands[placeIndex]);
              state.petStands[placeIndex]=null;
              state.petTimers[placeIndex]=null;
              if(typeof recalcEPS==='function') recalcEPS();
              if(typeof renderInventory==='function') renderInventory();
              if(typeof renderStands==='function') renderStands();
              if(typeof save==='function') save();
            }
            return;
          }

          const newItem = state.inventory.find(it => it.uid === state.selectedItemUid);
          if(!newItem) return;
  // If a pet/egg is already here, return it to inventory before placing the new one
  const existingHere = state.petStands[placeIndex];
  if (existingHere) {
    state.inventory.push(existingHere);
    state.petStands[placeIndex] = null;
    delete state.petTimers[placeIndex];
  }

          if(!(newItem.isEgg || newItem.petType)){
            alert('Only eggs or pets can be placed on pet pedestals.');
            return;
          }
          if(newItem.isEgg){
            state.petStands[placeIndex]=newItem;
            if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
            state.petTimers[placeIndex]=Date.now() + ((placeIndex===2 ? (window.THIRD_HATCH_DURATION||HATCH_DURATION) : (window.HATCH_DURATION||HATCH_DURATION)));
          }else{
            state.petStands[placeIndex]=newItem;
            if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
          }
          state.inventory = state.inventory.filter(it => it.uid !== newItem.uid);
          state.selectedItemUid = null;
          if(typeof recalcEPS==='function') recalcEPS();
          if(typeof renderInventory==='function') renderInventory();
          if(typeof renderStands==='function') renderStands();
          if(typeof save==='function') save();
        });
      }
      row.appendChild(pbox);
    }
  }

  // Wrap original renderStands safely
  const __origRenderStands = window.renderStands;
  if(typeof __origRenderStands==='function'){
    window.renderStands = function(){
      __origRenderStands.apply(this, arguments);
      try{ renderThirdPetSlot(); }catch(e){ /* no-op */ }
    };
  }

  // On load
  setTimeout(()=>{ try{ renderThirdPetSlot(); }catch(e){} }, 0);

  
function renderFourthPetSlot(){
  if(!(state.ach && state.ach.petFourthUnlocked)) return;

  // Ensure arrays have a 4th slot (index 3)
  if(!Array.isArray(state.petStands)) state.petStands = [null,null,null,null];
  while(state.petStands.length < 4) state.petStands.push(null);
  if(!Array.isArray(state.petTimers)) state.petTimers = [null,null,null,null];
  while(state.petTimers.length < 4) state.petTimers.push(null);

  const row = document.querySelector('.pet-row'); if(!row) return;

  // Ensure the "second row" placeholders (addon-second-row) exist and contain 4 boxes.
  let secondRow = Array.from(row.querySelectorAll('.pet-stand.addon-second-row'));
  if(secondRow.length !== 4){
    // Clear any partial second rows and rebuild them exactly once.
    row.querySelectorAll('.pet-stand.addon-second-row').forEach(n=>n.remove());
    for(let col=0; col<4; col++){
      const pbox=document.createElement('div');
      pbox.className='pet-stand addon-second-row';
      row.appendChild(pbox);
    }
    secondRow = Array.from(row.querySelectorAll('.pet-stand.addon-second-row'));
  }

  // The 3rd pedestal uses col===1, so place the 4th at col===2 within the SAME row.
  const placeIndex = 3; // fourth pet slot index in state
  const pbox = secondRow[2]; // column 2 (0-based) of the second row
  if(!pbox) return;

  // Clear prior content to prevent duplicates, then build pedestal + placed item if any.
  pbox.innerHTML = '';
  const pPed = document.createElement('div');
  pPed.className = 'pet-pedestal';
  pbox.appendChild(pPed);

  const placed = state.petStands[placeIndex];
  if(placed){
    const p = document.createElement('div');
    p.className='pet-placed';
    const nameLabel = (placed.name && placed.name.trim()) ? placed.name : (placed.petType||placed.eggType||'Pet');
    p.innerHTML = `<img src='${placed.svg}' alt='${nameLabel}' style="width:64px;height:64px;border-radius:12px;">`
                + `<div class="name-badge"><span>${nameLabel}</span></div>`;
    pbox.appendChild(p);

    if(placed.isEgg && state.petTimers[placeIndex]){
      const timer=document.createElement('div');
      timer.className='pet-timer';
      timer.dataset.index=placeIndex;
      pbox.appendChild(timer);
    }
  } else { /* no placeholder */ }

  // Click behavior (swap-in/out and 2-minute hatch for eggs)
  pbox.addEventListener('click', ()=>{
    // If nothing selected, remove current pet/egg back to inventory
    if(!state.selectedItemUid){
      if(state.petStands[placeIndex]){
        state.inventory.push(state.petStands[placeIndex]);
        state.petStands[placeIndex] = null;
        state.petTimers[placeIndex] = null;
        if(typeof recalcEPS==='function') recalcEPS();
        if(typeof renderInventory==='function') renderInventory();
        if(typeof renderStands==='function') renderStands();
        if(typeof save==='function') save();
      }
      return;
    }
    const newItem = state.inventory.find(it => it.uid === state.selectedItemUid);
    if(!newItem) return;

    // If a pet/egg is already here, return it to inventory before placing the new one
    const existingHere = state.petStands[placeIndex];
    if (existingHere) {
      state.inventory.push(existingHere);
      state.petStands[placeIndex] = null;
      delete state.petTimers[placeIndex];
    }

    if(!(newItem.isEgg || newItem.petType)){
      alert('Only eggs or pets can be placed on pet pedestals.');
      return;
    }
    if(newItem.isEgg){
      state.petStands[placeIndex] = newItem;
      // 2-minute timer for the 4th pedestal
      const TWO_MIN = 2*60*1000;
      state.petTimers[placeIndex] = Date.now() + (window.FOURTH_HATCH_DURATION||2*60*1000);
    }else{
      state.petStands[placeIndex] = newItem;
      if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
    }
    state.inventory = state.inventory.filter(it => it.uid !== newItem.uid);
    state.selectedItemUid = null;
    if(typeof recalcEPS==='function') recalcEPS();
    if(typeof renderInventory==='function') renderInventory();
    if(typeof renderStands==='function') renderStands();
    if(typeof save==='function') save();
  });
}

  (function(){
    const __rs = window.renderStands;
    if(typeof __rs==='function'){
      window.renderStands = function(){
        __rs.apply(this, arguments);
        try{ renderThirdPetSlot(); }catch(e){}
        try{ renderFourthPetSlot(); }catch(e){}
      };
    }
    setTimeout(()=>{ try{ renderFourthPetSlot(); }catch(e){} }, 0);
  })();
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>
<script>
// --- Add-on persistence for achievements + backgrounds ---
(function(){
  const KEY='flex_addon_persist_v1';
  function saveAddon(){
    try{
      const data={ach:state.ach, ubg:state.unlockedBackgrounds, sel:state.selectedBackground, pdx:(state.petDex||{})};
      localStorage.setItem(KEY, JSON.stringify(data));
    }catch(e){}
  }
  function loadAddon(){
    try{
      const raw=localStorage.getItem(KEY); if(!raw) return;
      const d=JSON.parse(raw);
      if(d.ach){
        state.ach=state.ach||{questsDone:{}};
        state.ach.questsDone={...(state.ach.questsDone||{}), ...(d.ach.questsDone||{})};
        state.ach.petPedestalGranted = state.ach.petPedestalGranted || !!d.ach.petPedestalGranted;
        state.ach.petThirdUnlocked = state.ach.petThirdUnlocked || !!d.ach.petThirdUnlocked;
      }
      if(d.ubg) state.unlockedBackgrounds={...(state.unlockedBackgrounds||{}), ...d.ubg};
      if(d.sel) { state.selectedBackground=d.sel; try{ if(state.selectedBackground!=='default'){ document.body.classList.add(state.selectedBackground.startsWith('bg-')?state.selectedBackground:({bg:'bg-'}) ); } }catch(e){} }
      if(d.pdx){ state.petDex = { ...(state.petDex||{}), ...d.pdx }; }
    }catch(e){}
  }
  // load immediately
  loadAddon();
  try{ if(state.selectedBackground && state.selectedBackground!=='default' && typeof applyBG==='function'){ applyBG(state.selectedBackground); } }catch(e){}

  // wrap global save to include addon data and persist locally
  const __save = window.save;
  window.save = async function(){
    try{ saveAddon(); }catch(e){}
    if(typeof __save === 'function'){ try{ return await __save.apply(this, arguments); }catch(e){ return; } }
  };
  window.addEventListener('beforeunload', saveAddon);
  window.__addonSave = saveAddon;
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>
<script>
(function(){
  // toggle button -> deletion mode
  window.state = window.state || {};
  state.deletionMode = false; // default OFF

  function reflectDeleteMode(){
    const on = !!state.deletionMode;
    document.body.classList.toggle('deleting', on);
    const btn = document.getElementById('deleteToggleBtn');
    if(btn){
        if(document.body.classList.contains('upside-down')){ btn.style.display='none'; return; } btn.classList.toggle('active', on); btn.setAttribute('aria-pressed', on ? 'true' : 'false'); }
  }

  function augmentInventorySlots(){
    try{
      const slots = Array.from(document.querySelectorAll('#inventory .slot'));
      slots.forEach((slot, idx)=>{
        let del = slot.querySelector('.del-x');
        if(!del){
          del = document.createElement('button');
          del.className = 'del-x';
          del.type = 'button';
          del.title = 'Delete item';
          del.textContent = 'Ã—';
          slot.appendChild(del);
          del.addEventListener('click', (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            if(!state.deletionMode) return;
            if(!Array.isArray(state.inventory)) return;
            const item = state.inventory[idx];
            if(!item) return;
            state.inventory.splice(idx,1);
            if(typeof save==='function') try{ save(); }catch(e){}
            if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
          });
        }
      });
    }catch(e){}
  }

  // Initial reflect + augment once DOM is ready
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=>{
    try{ ensureBrewButtonVisible(); }catch(e){}
 reflectDeleteMode(); augmentInventorySlots(); });
  }else{
    reflectDeleteMode(); augmentInventorySlots();
  }

  // Robust: delegate click to handle dynamic re-renders
  document.addEventListener('click', function(e){
    const btn = e.target.closest && e.target.closest('#deleteToggleBtn');
    if(!btn) return;
    e.preventDefault();
    state.deletionMode = !state.deletionMode;
    reflectDeleteMode();
    augmentInventorySlots();
    if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
  });

  // After every inventory render, augment again to ensure buttons exist
  const __ri_hook = window.renderInventory;
  if(typeof __ri_hook === 'function'){
    window.renderInventory = function(){
      try{ ensureBrewButtonVisible(); }catch(_){}

      __ri_hook.apply(this, arguments);
      try{ augmentInventorySlots(); reflectDeleteMode(); }catch(e){}
    };
  }

  // Wrap renderInventory to add delete badges mapped by index
  const __ri = window.renderInventory;
  if(typeof __ri==='function'){
    window.renderInventory = function(){
      __ri.apply(this, arguments);
      try{
        const list = Array.from(document.querySelectorAll('#inventory .slot'));
        list.forEach((el, idx)=>{
          let del = el.querySelector('.del-x');
          if(!del){
            del = document.createElement('button');
            del.className='del-x'; del.textContent='Ã—';
            el.appendChild(del);
            del.addEventListener('click', (ev)=>{
              ev.stopPropagation();
              if(!state.deletionMode) return;
              if(!Array.isArray(state.inventory)) return;
              const item = state.inventory[idx];
              if(!item) return;
              // remove item permanently
              state.inventory.splice(idx,1);
              if(typeof save==='function') save();
              if(window.__addonSave) __addonSave();
              renderInventory();
            });
          }
        });
      }catch(e){}
    };
  }

  // (Deletion mode does not add delete buttons to pedestals.)
</script>
<script>
(function(){
  window.state = window.state || {};
  state.deletionMode = false; // default OFF

  function addDeleteBadgesToInventory(){
    try{
      const slots = Array.from(document.querySelectorAll('#inventory .slot'));
      slots.forEach((slot, idx)=>{
        let del = slot.querySelector('.del-x');
        if(!del){
          del = document.createElement('button');
          del.className = 'del-x';
          del.type = 'button';
          del.title = 'Delete item';
          del.textContent = 'Ã—';
          slot.appendChild(del);
          del.addEventListener('click', (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            if(!state.deletionMode) return;
            if(!Array.isArray(state.inventory)) return;
            const item = state.inventory[idx];
            if(!item) return;
            // Delete item from inventory
            state.inventory.splice(idx,1);
            if(typeof save==='function') try{ save(); }catch(e){}
            if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
          });
        }
      });
    }catch(e){ /* no-op */ }
  }

  function removeDeleteBadgesFromInventory(){
    document.querySelectorAll('#inventory .slot .del-x').forEach(el=>el.remove());
  }

  function reflectDelete(){
    const on = !!state.deletionMode;
    const btn = document.getElementById('deleteToggleBtn');
    document.body.classList.toggle('deleting', on);
    if(btn){
        if(document.body.classList.contains('upside-down')){ btn.style.display='none'; return; } btn.classList.toggle('active', on); btn.setAttribute('aria-pressed', on?'true':'false'); }
    if(on){ addDeleteBadgesToInventory(); } else { removeDeleteBadgesFromInventory(); }
  }

  // Hook into renderInventory so badges sync with current mode after any render
  const __ri = window.renderInventory;
  if(typeof __ri === 'function'){
    window.renderInventory = function(){
      __ri.apply(this, arguments);
      reflectDelete();
    };
  }

  function init(){
    // always start OFF on load
    state.deletionMode = false;
    reflectDelete();
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();

  // Toggle button wiring
  document.addEventListener('click', function(e){
    const btn = e.target.closest && e.target.closest('#deleteToggleBtn');
    if(!btn) return;
    e.preventDefault();
    state.deletionMode = !state.deletionMode;
    reflectDelete();
  });

  // Safety: ensure OFF on reload
  window.addEventListener('beforeunload', ()=>{ state.deletionMode=false; });
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>
<!-- Quick reward reveal -->
<img alt="reward" id="revealImg"/>
<div id="revealName" style="font-weight:900;margin-top:6px;"></div>
<div class="rar" id="revealRarity" style="margin:8px auto 0;padding:6px 12px;border-radius:12px;"></div>
<!-- LA Dodgers Event Overlay -->
<div aria-hidden="true" class="overlay" id="dodgerOverlay">
<div aria-labelledby="dodgerTitle" aria-modal="true" class="sheet" role="dialog">
<button aria-label="Close" class="closeX" id="closeDodger">âœ•</button>
<h2 id="dodgerTitle">LA DODGERS EVENT</h2>
<div class="dodger-grid">
<div class="dodger-card" id="cardLAPack">
<h3>LA Pack <span class="cosmic-badge t-legendary">LIMITED</span></h3>
<p class="dodger-desc">Open to receive a random LA item in EPIC/LEGENDARY/LEGACY/UNIQUE/MYTHIC/DODGER. Dodger is rarest and adds blueâ€“white waves. Reward autoâ€‘adds to inventory.</p>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
<div class="dodger-price">$2,000,000,000</div>
<button class="dodger-buy" id="buyLAPack">Purchase</button>
</div>
</div>
<div class="dodger-card" id="cardDodgerStyle">
<h3>Dodger Stadium Style</h3>
<p class="dodger-desc">A themed stadium background. After purchase, apply it from Backgrounds.</p>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
<div class="dodger-price">$10,000,000,000,000</div>
<button class="dodger-buy" id="buyDodgerStyle">Purchase</button>
</div>
</div>
<div class="dodger-card">
<h3>Dodger Info</h3>
<div class="dodger-desc">Event items are limitedâ€‘time. When the event ends the button goes away, but your rewards stay forever. Dodger rarity gives +40,000 EPS with animated waves.</div>
</div>
<div class="dodger-card" style="display:grid;place-items:center;">
<img alt="LA" id="dodgerShopLogo" style="height:120px;filter:drop-shadow(0 8px 30px rgba(30,144,255,.35));opacity:.95;">
</img></div>
</div>
</div>
</div>
<!-- Dodgers Reward Reveal -->
<div class="cosmic-reveal" id="dodgerReveal">
<div class="card" style="background:#0e1628;border-color:#0a0f1a;">
<div style="font-family:'Bungee';font-size:28px;letter-spacing:1px;">You received</div>
<img alt="reward" id="dodgerRevealImg"/>
<div id="dodgerRevealName" style="font-weight:900;margin-top:6px;"></div>
<div class="rar" id="dodgerRevealRarity" style="margin:8px auto 0;padding:6px 12px;border-radius:12px;"></div>
</div>
</div>
<script>

// Helper to resolve assets by trying multiple extensions.
// Use base folder and a file *stem* (no extension), like ('la_dodgers_files','event')
function resolveAsset(base, stem, cb){
  const exts = ['.png', '.webp', '.jpg', ''];
  let i = 0;
  function tryNext(){
    const url = base + '/' + stem + exts[i];
    const img = new Image();
    img.onload = ()=>cb(url);
    img.onerror = ()=>{
      i++;
      if(i < exts.length) tryNext();
      else cb(base + '/' + stem + '.png'); // fall back
    };
  }
  tryNext();
}

// Set the event icon image in the shop card and left-rail button
function setDodgerEventIcons(btnEl){
  // If a specific button element is passed, use that; else search.
  const setBtnBg = function(url){
    try{
      const btn = btnEl || document.getElementById('openDodger');
      if(btn){
        if(document.body.classList.contains('upside-down')){ btn.style.display='none'; return; }
        btn.style.setProperty('--dodger-icon', "url('"+url+"')");
        const ft = btn.querySelector('.fallback-text');
        if(ft) ft.style.opacity = '0';
      }
    }catch(e){}
  };

  
  
  (function(){
    const candidates = [
      'la_dodgers_files/event.png',
      'la_dodgers_filesevent.png',
      'event.png'
    ];
    (function tryNext(i){
      if(i >= candidates.length){
        // final fallback: show "LA" text, leave CSS var unset
        const shopImg = document.getElementById('dodgerShopLogo');
        if(shopImg){
          shopImg.classList.add('fallback');
          shopImg.removeAttribute('src');
          shopImg.textContent = 'LA';
        }
        return;
      }
      const test = new Image();
      test.onload = function(){
        const url = candidates[i];
        const shopImg = document.getElementById('dodgerShopLogo');
        if(shopImg){
          shopImg.classList.remove('fallback');
          shopImg.src = url;
        }
        setBtnBg(url);
      };
      test.onerror = function(){ tryNext(i+1); };
      test.src = candidates[i];
    })(0);
  })();
}
// Prepare and cache the stadium background URL, update CSS and BG grid tile
var __dodgerBgURL = null;
function ensureDodgerBgURL(cb){
  if(__dodgerBgURL){ cb(__dodgerBgURL); return; }
  resolveAsset('la_dodgers_style_files','la_dodgers_style', function(url){
    __dodgerBgURL = url;
    // write/update CSS rule dynamically
    let st = document.getElementById('dodgerBgStyle');
    if(!st){
      st = document.createElement('style');
      st.id = 'dodgerBgStyle';
      document.head.appendChild(st);
    }
    st.textContent = "body.bg-dodger{background:url('"+url+"') center center / cover no-repeat fixed !important;}";
    cb(url);
  });
}

// === LA Dodgers Event bootstrap ===
(function(){
  // Add event icon button to left rail (uses provided PNG)
  try{
    const rail = document.querySelector('.left-rail');
    if(rail && !document.getElementById('openDodger')){
      const btn = document.createElement('button');
      btn.className = 'icon-btn icon-dodger';
      btn.id = 'openDodger';
      btn.title = 'LA Dodgers Event';
      btn.innerHTML = '<span class="fallback-text">LA</span>';
      setDodgerEventIcons(btn);
      (function(){ 
  var row = document.querySelector('.event-row') || document.getElementById('eventRow');
  if(!row){
    row = document.createElement('div');
    row.className = 'event-row';
    document.body.appendChild(row);
  }
  row.appendChild(btn);
})();
btn.addEventListener('click', ()=>{
        document.getElementById('dodgerOverlay').classList.add('show');
        document.getElementById('dodgerOverlay').setAttribute('aria-hidden','false');
        updateDodgerStyleUI();
        setDodgerEventIcons();
      });
    }
  }catch(e){}

  document.getElementById('closeDodger')?.addEventListener('click', ()=>{
    document.getElementById('dodgerOverlay').classList.remove('show');
    document.getElementById('dodgerOverlay').setAttribute('aria-hidden','true');
  });

  // Extend rarity table with DODGER (40,000 EPS)
  try{
    window.RARITY = window.RARITY || {};
    if(!RARITY.dodger){
      RARITY.dodger = { label:'DODGER', color:'#1e90ff', income: 40000, price:[0,0], prob: 0 };
    }
  }catch(e){}

  // After every stand render, add the wave aura to any placed item with t-dodger badge
  (function hookDodgerWaves(){
    const orig = window.renderStands;
    window.renderStands = function(){
      if(typeof orig === 'function') orig.apply(this, arguments);
      try{
        document.querySelectorAll('.placed').forEach(el=>{
          const hasDodger = !!el.querySelector('.rar.t-dodger');
          el.classList.toggle('dodger-waves', hasDodger);
        });
      }catch(e){}
    };
    setTimeout(()=>{
      try{
        document.querySelectorAll('.placed').forEach(el=>{
          const hasDodger = !!el.querySelector('.rar.t-dodger');
          el.classList.toggle('dodger-waves', hasDodger);
        });
      }catch(e){}
    },0);
  })();


  // After every stand render, add the wave aura to any placed item with t-coastal badge
  (function hookCoastalWaves(){
    const orig = window.renderStands;
    window.renderStands = function(){
      if(typeof orig === 'function') orig.apply(this, arguments);
      try{
        document.querySelectorAll('.placed').forEach(el=>{
          const hasCoastal = !!el.querySelector('.rar.t-coastal');
          el.classList.toggle('coastal-waves', hasCoastal);
        });
      }catch(e){}
    };
    setTimeout(()=>{
      try{
        document.querySelectorAll('.placed').forEach(el=>{
          const hasCoastal = !!el.querySelector('.rar.t-coastal');
          el.classList.toggle('coastal-waves', hasCoastal);
        });
      }catch(e){}
    },0);
  })();


  // Reward reveal helper
  function showDodgerReveal(name, rarity, imgPath){
    const host = document.getElementById('dodgerReveal');
    const rn = document.getElementById('dodgerRevealName');
    const rr = document.getElementById('dodgerRevealRarity');
    const ri = document.getElementById('dodgerRevealImg');
    ri.src = imgPath;
    rn.textContent = name;
    rr.textContent = (RARITY[String(rarity).toLowerCase()]?.label || String(rarity||'').toUpperCase());
    rr.className = 'rar t-' + String(rarity).toLowerCase();
    host.classList.add('show');
    setTimeout(()=>{ host.classList.remove('show'); }, 3000);
  }

  // LA Pack purchase logic
  const LA_PACK_COST = 2_000_000_000;
  const LA_ITEMS = [
    ['Dodger Hat','dodger_hat.png'],
    ['Dodger Stadium','dodger_stadium.png'],
    ['World Series','world_series.png'],
    ['Shohei Ohtani','shohei_ohtani.png'],
    ['Will Smith','will_smith.png'],
    ['Freddie Freeman','freddie_freeman.png'],
    ['Mookie Betts','mookie_betts.png'],
    ['Dodger Baseball','dodger_baseball.png'],
    ['Dodger Welcome','dodger_welcome.png']
  ];
  // EPIC/LEGENDARY/LEGACY/UNIQUE/MYTHIC/DODGER (Dodger rarest)
  const LA_RARITY_BUCKETS = [
    ['epic',48], ['legendary',25], ['legacy',10], ['unique',8], ['mythic',5], ['dodger',4]
  ];
  function pickWeighted(bucket){
    const total = bucket.reduce((s, r)=>s+r[1], 0);
    let roll = Math.random() * total;
    for(const [val,w] of bucket){
      roll -= w;
      if(roll <= 0) return val;
    }
    return bucket[bucket.length-1][0];
  }
  function buyLAPack(){
    if((state.money||0) < LA_PACK_COST) return;
    state.money -= LA_PACK_COST;
    const [name, file] = LA_ITEMS[Math.floor(Math.random()*LA_ITEMS.length)];
    const rar = pickWeighted(LA_RARITY_BUCKETS);
    const inv = {
      uid: (Math.random().toString(36).slice(2)+Date.now().toString(36)),
      name,
      rarity: rar,
      price: 0,
      baseIdx: 0,
      svg: 'la_dodgers_items/' + file
    };
    state.inventory.push(inv);
    if(typeof updateTop==='function') updateTop();
    if(typeof renderInventory==='function') renderInventory();
    if(typeof save==='function') save();
    showDodgerReveal(name, rar, inv.svg);
  }
  document.getElementById('buyLAPack')?.addEventListener('click', buyLAPack);

  // Dodger Stadium Style background purchase
  const DODGER_STYLE_COST = 10_000_000_000_000;
  function updateDodgerStyleUI(){
    const btn = document.getElementById('buyDodgerStyle');
    if(!btn) return;
    const owned = !!(state.unlockedBackgrounds && state.unlockedBackgrounds.dodger);
    if(owned){
      btn.disabled = true;
      btn.textContent = 'Purchased';
      btn.style.background = 'linear-gradient(#2ecc71,#1da85b)';
    }else{
      btn.disabled = (state.money||0) < DODGER_STYLE_COST;
      btn.textContent = 'Purchase';
      btn.style.background = '';
    }
  }
  function buyDodgerStyle(){
    if((state.unlockedBackgrounds||{}).dodger) return;
    if((state.money||0) < DODGER_STYLE_COST) return;
    state.money -= DODGER_STYLE_COST;
    state.unlockedBackgrounds = state.unlockedBackgrounds || {};
    state.unlockedBackgrounds.dodger = true;
    updateDodgerStyleUI();
        setDodgerEventIcons();
    if(typeof window.__renderBgGrid==='function') window.__renderBgGrid();
    if(typeof updateTop==='function') updateTop();
    if(typeof save==='function') save();
  }
  document.getElementById('buyDodgerStyle')?.addEventListener('click', buyDodgerStyle);

  // Extend Background grid with Dodger style
  (function extendBgGrid(){
    const orig = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if(typeof orig === 'function') orig();
      try{
        const g=document.getElementById('bgGrid');
        if(!g) return;
        if(!g.querySelector('[data-dodgerbg]')){
          const el=document.createElement('div');
          el.setAttribute('data-dodgerbg','1');
          el.className='bg-tile'+(!(state.unlockedBackgrounds||{}).dodger?' locked':'');
          el.style.cssText='background-image:url("la_dodgers_style_files/la_dodgers_style.png");background-size:cover;background-position:center;';
          el.innerHTML='<div style="font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)">DODGER STADIUM STYLE</div><button class="buy bg-apply" '+(!(state.unlockedBackgrounds||{}).dodger?'disabled':'')+'>Apply</button>';
          el.querySelector('.bg-apply').onclick=()=>{
            if(!(state.unlockedBackgrounds||{}).dodger) return;
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-rainbow','redblue','bg-spaceview','bg-crypto');
            document.body.classList.add('bg-dodger');
            state.selectedBackground='dodger';
            if(typeof save==='function') save();
          };
          g.appendChild(el);
        }
      }catch(e){}
    };
  })();
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>
<script>
(function(){
  const btn = document.getElementById('openBgSelector');
  if(btn){
        if(document.body.classList.contains('upside-down')){ btn.style.display='none'; return; }
    btn.addEventListener('click', ()=>{
      const overlay = document.getElementById('bgOverlay');
      const sheet = overlay ? overlay.querySelector('.sheet') : null;
      const grid = document.getElementById('bgGrid');
      if (overlay) overlay.scrollTop = 0;
      if (sheet) sheet.scrollTop = 0;
      if (grid) grid.scrollTop = 0;
    }, { passive: true });
  }
})();
</script>
<script>
// ===== Admin broadcast listener + auto-update =====
(function(){
  const CLIENT_BUILD = 'v48-msgs1';
  let _queue = [];
  let _showing = false;
  let lastG = Number(localStorage.getItem('flex_msg_lastG')||0);
  let lastU = Number(localStorage.getItem('flex_msg_lastU')||0);

  
  // Prime baselines so only players with the tab open at send-time see admin messages or forced reloads.
  let __MSG_PRIMED__ = false;
  let _latestSeenTs = Number(localStorage.getItem('flex_latest_seenTs')||0);
  async function primeBaselines(){
    try{
      // Snapshot current last message timestamps so we won't replay older broadcasts or inbox messages
      const g0 = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__broadcast')}&t=${Date.now()}`) || {};
      if (typeof g0.last === 'number') { lastG = g0.last; } else if (Array.isArray(g0.list) && g0.list.length){ lastG = Math.max(0, g0.list.map(m=>m && m.ts || 0)); }
      const u0 = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__inbox_'+USER_ID)}&t=${Date.now()}`) || {};
      if (typeof u0.last === 'number') { lastU = u0.last; } else if (Array.isArray(u0.list) && u0.list.length){ lastU = Math.max(0, u0.list.map(m=>m && m.ts || 0)); }
      localStorage.setItem('flex_msg_lastG', String(lastG||0));
      localStorage.setItem('flex_msg_lastU', String(lastU||0));
      // Snapshot the latest force reload timestamp so new tabs opened later won't auto-refresh from old requests
      const cfg0 = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__flex_latest')}&t=${Date.now()}`) || {};
      if (cfg0 && typeof cfg0.forceTs === 'number') {
        _latestSeenTs = cfg0.forceTs;
      } else {
        // Use "now" as a floor so existing forced reloads from the past won't trigger on late joiners
        _latestSeenTs = Date.now();
      }
      localStorage.setItem('flex_latest_seenTs', String(_latestSeenTs||0));
    }catch(e){ /* ignore priming errors */ }
    __MSG_PRIMED__ = true;
  window.addEventListener('load', ()=>{ try{ setInterval(pollOnce, 15000); }catch(e){} });

  }
function ensureBanner(){
    if(document.getElementById('adminMsgBanner')) return;
    const el = document.createElement('div');
    el.id = 'adminMsgBanner';
    el.innerHTML = '<div class="msg"></div><button class="close" aria-label="Close">Ã—</button>';
    document.body.appendChild(el);
    el.querySelector('.close').addEventListener('click', ()=>{ hideBanner(); _queue=[]; });
  }

  function showBanner(msg){
    ensureBanner();
    const el = document.getElementById('adminMsgBanner');
    el.classList.remove('info','warn','success');
    el.classList.add(msg.style||'info');
    el.querySelector('.msg').textContent = String(msg.text||'');
    el.classList.add('show');
    _showing = true;
    const lifetime = 5000 + Math.min(5000, (String(msg.text||'').length * 15));
    setTimeout(()=>hideBanner(), lifetime);
  }
  function hideBanner(){
    const el = document.getElementById('adminMsgBanner');
    if(!el) return;
    el.classList.remove('show');
    _showing = false;
    setTimeout(()=>maybeNext(), 250);
  }
  function enqueue(msg){
    _queue.push(msg);
    maybeNext();
  }
  function maybeNext(){
    if(_showing) return;
    const msg = _queue.shift();
    if(!msg) return;
    showBanner(msg);
  }

  async function fetchJson(u){
    try{
      const r = await fetch(u, { cache:'no-store' });
      if(!r.ok) return null;
      return await r.json();
    }catch(e){ return null; }
  }

  async function pollOnce(){
    if(!__MSG_PRIMED__) await primeBaselines();

    try{
      // global
      const g = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__broadcast')}&t=${Date.now()}`) || {};
      const glist = Array.isArray(g.list) ? g.list : [];
      glist.forEach(m=>{ if((m.ts||0) > lastG){ if(m && m.op === 'freeze'){ activateHardFreeze(m.text); } else { enqueue(m); } lastG = Math.max(lastG, m.ts||0); } });
// user inbox
      const u = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__inbox_'+USER_ID)}&t=${Date.now()}`) || {};
      const ulist = Array.isArray(u.list) ? u.list : [];
      ulist.forEach(m=>{ if((m.ts||0) > lastU){ if(m && m.op === 'freeze'){ activateHardFreeze(m.text); } else { enqueue(m); } lastU = Math.max(lastU, m.ts||0); } });
localStorage.setItem('flex_msg_lastG', String(lastG));
      localStorage.setItem('flex_msg_lastU', String(lastU));
    }catch(e){ /* ignore */ }

    // auto-update: check the "latest" pointer
    try{
      const cfg = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__flex_latest')}&t=${Date.now()}`) || null;
      if(cfg && cfg.url){
        const forced = (typeof cfg.forceTs === 'number') && (cfg.forceTs > Number(localStorage.getItem('flex_latest_seenTs')||0));
        const should = forced || (cfg.v && String(cfg.v)!==String(CLIENT_BUILD));
        if (forced) { localStorage.setItem('flex_latest_seenTs', String(cfg.forceTs)); }
        if (should) {
  // Only allow updates that keep us on the SAME ORIGIN to preserve localStorage/state.
  // - Relative URLs are allowed (auto-resolve to same origin).
  // - Absolute URLs must match location.origin exactly.
  let nextUrl;
  try {
    // Resolve cfg.url relative to the current page (handles relative & absolute inputs)
    const resolved = new URL(cfg.url, location.href);

    // Same-origin required
    if (resolved.origin !== location.origin) {
      // Ignore cross-origin "latest" URLs to avoid losing origin-scoped data
      console.warn('[auto-update] Ignored cross-origin latest url:', resolved.href);
    } else {
      // Cache-bust so we definitely get the new client
      resolved.searchParams.set('cb', String(Date.now()));
      nextUrl = resolved.toString();
    }
  } catch (e) {
    console.warn('[auto-update] Bad latest url:', cfg.url, e);
  }

  if (nextUrl) {
    window.location.href = nextUrl;
    return;
  }
}
      }
    }catch(e){ /* ignore */ }

    
  // ===== Hard Freeze (admin-triggered) =====
  function __escapeHtml_(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function activateHardFreeze(msgText){
    if(window.__HARD_FREEZE_ACTIVE__) return;
    window.__HARD_FREEZE_ACTIVE__ = true;
    try{ window.__origRAF = window.requestAnimationFrame; window.requestAnimationFrame = function(){}; }catch(e){}
    var st = document.getElementById('hardFreezeStyle');
    if(!st){
      st = document.createElement('style'); st.id = 'hardFreezeStyle';
      st.textContent = [
        '#hardFreezeOverlay{position:fixed;inset:0;background:#000;color:#fff;z-index:2147483647;display:flex;align-items:center;justify-content:center;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}',
        '#hardFreezeOverlay .inner{max-width:880px;padding:28px;text-align:center;}',
        '#hardFreezeOverlay h1{margin:0 0 12px;font-size:clamp(24px,5vw,48px);font-weight:900;letter-spacing:.4px;}',
        '#hardFreezeOverlay p{margin:8px 0;font-size:clamp(14px,2.2vw,22px);opacity:.9;}'
      ].join('\n');
      document.head.appendChild(st);
    }
    var ov = document.getElementById('hardFreezeOverlay');
    if(!ov){
      ov = document.createElement('div'); ov.id = 'hardFreezeOverlay';
      ov.innerHTML = '<div class="inner"><h1>Update Required</h1><p>'+__escapeHtml_(msgText||'Admin paused the game for an update.')+'</p><p><strong>Use your browser\'s Reload button to continue.</strong></p></div>';
      document.body.appendChild(ov);
    }
    var trap = function(e){ try{ e.preventDefault(); e.stopImmediatePropagation(); e.stopPropagation(); }catch(_){} return false; };
    ['keydown','keyup','keypress','pointerdown','pointerup','click','dblclick','contextmenu','wheel','touchstart','touchend'].forEach(function(ev){
      window.addEventListener(ev, trap, true);
    });
  }
setTimeout(pollOnce, 1500);
  }

  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(pollOnce, 100); });
  window.addEventListener('load', ()=>{
    // Inject banner CSS if not present
    if(!document.getElementById('adminMsgBannerStyle')){
      const st = document.createElement('style'); st.id='adminMsgBannerStyle';
      st.textContent = '"\\n/* ===== admin broadcast banner ===== */\\n#adminMsgBanner{\\n  position:fixed; left:0; right:0; top:-120px; z-index:9999;\\n  display:flex; gap:12px; align-items:center; justify-content:center;\\n  min-height:56px; padding:10px 16px;\\n  font-weight:800; letter-spacing:.2px;\\n  color:#000; text-shadow:0 1px 0 rgba(255,255,255,.4);\\n  border-bottom:4px solid rgba(0,0,0,.35);\\n  box-shadow:0 10px 30px rgba(0,0,0,.35);\\n  transition: transform .35s ease, top .35s ease, background .25s;\\n  transform: translateY(-100%);\\n}\\n#adminMsgBanner.show{ top:0; transform: translateY(0); }\\n#adminMsgBanner .msg{ max-width:1100px; text-align:center; }\\n#adminMsgBanner .close{ margin-left:auto; cursor:pointer; font-weight:900; }\\n#adminMsgBanner.info{ background: #79ffe1; }\\n#adminMsgBanner.warn{ background: #ffd86a; }\\n#adminMsgBanner.success{ background: #a7ff83; }\\n"';
      document.head.appendChild(st);
    }
    ensureBanner();
    pollOnce();
  });
})();
</script>
<script>
// --- Pet Quest: Unlock 4th Pet Pedestal when ALL pets owned (2-minute hatch slot) ---
(function(){
  function unlockFourthIfAllPets(){
    try{
      if (typeof hasAllPets !== 'function') return;
      if (!hasAllPets()) return;
      window.state = window.state || {};
      state.ach = state.ach || {};
      if (!state.ach.petFourthUnlocked) {
        state.ach.petFourthUnlocked = true;
        // Ensure arrays have 4 slots
        if (!Array.isArray(state.petStands)) state.petStands = [null,null,null,null];
        while (state.petStands.length < 4) state.petStands.push(null);
        if (!Array.isArray(state.petTimers)) state.petTimers = [null,null,null,null];
        while (state.petTimers.length < 4) state.petTimers.push(null);
        // Re-render UI
        try { if (typeof renderStands === 'function') renderStands(); } catch(e){}
        try { if (typeof recalcEPS === 'function') recalcEPS(); } catch(e){}
        try { if (window.__addonSave) __addonSave(); } catch(e){}
      }
    } catch(e){}
  }

  // Run once after load (ensures PET_TABLES/hasAllPets exist)
  window.addEventListener('load', function(){ setTimeout(unlockFourthIfAllPets, 0); });

  // Also check on visibility regain (common after tab switching)
  document.addEventListener('visibilitychange', function(){
    if (!document.hidden) setTimeout(unlockFourthIfAllPets, 50);
  });

  // Wrap global save() so any state change re-checks the quest
  const __save = window.save;
  window.save = async function(){
    try { unlockFourthIfAllPets(); } catch(e){}
    if (typeof __save === 'function') {
      try { return await __save.apply(this, arguments); } catch (e) { return; }
    }
  };
})();
</script>
<style>
/* === Dodger Quests background === */
body.bg-dodgerquests{ background:url('la_dodgers_style_files/la_dodgers_quests_style.png') center center / cover no-repeat fixed !important; }
.dq-box .dq-row{display:flex;align-items:center;gap:10px;margin:10px 0;font-weight:900;letter-spacing:.3px;}
.dq-box .dq-check{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;border:2px solid #111;background:#555;font-weight:900;color:#111;}
.dq-box .dq-check.ok{background:#58e36c;color:#111;}
.dq-box .dq-sub{font-size:14px;opacity:.85;font-weight:800;margin-top:-6px;margin-left:38px;}
.dq-claim{margin-top:8px;}
</style>
<script>
// === Dodger Quests (LA Event) ===
(function(){
  const DQ_KEY = 'flex_dodger_quests_v1';
  const EARN_GOAL = 10_000_000_000; // $10B
  const OWN_GOAL = 15;              // lowered to 15 Dodger-rarity items
  const EXOTIC_LA_GOAL = 6;         // 6 exotics forged from only LA items

  // load / init
  window.state = window.state || {};
  state.dodgerQuests = (function(){
    try{ const d = JSON.parse(localStorage.getItem(DQ_KEY)||'null'); if(d) return d; }catch(e){}
    return { earned: 0, exoticsLA: 0, unlocked: false };
  })();

  function saveDQ(){
    try{ localStorage.setItem(DQ_KEY, JSON.stringify(state.dodgerQuests)); }catch(e){}
    try{ if(typeof save==='function') save(); }catch(e){}
  }

  function countDodgerRarityOwned(){
    let n = 0;
    try{
      (state.inventory||[]).forEach(i=>{ if(i && String(i.rarity).toLowerCase()==='dodger') n++; });
      Object.values(state.placed||{}).forEach(i=>{ if(i && String(i.rarity).toLowerCase()==='dodger') n++; });
    }catch(e){}
    return n;
  }

  function currentDodgerEPS(){
    let base = 0;
    try{
      (state.stands||[]).forEach(uid=>{
        if(!uid) return;
        const it = (state.placed||{})[uid] || (state.inventory||[]).find(x=>x.uid===uid);
        if(!it) return;
        if(String(it.rarity).toLowerCase()==='dodger'){
          const key='dodger';
          const inc = (window.RARITY && RARITY[key] && +RARITY[key].income) ? +RARITY[key].income : 0;
          base += inc;
        }
      });
    }catch(e){}
    const mult = (window.multiplierLevel||1) * ((typeof getActivePedestalMultiplier==='function' ? getActivePedestalMultiplier() : 1));
    return base * mult;
  }

  function isLAItem(it){
    if(!it) return false;
    if(it.la === true) return true;
    const s = String(it.svg||'');
    return /la_dodgers/i.test(s) || /dodger_/i.test(s);
  }

  // ===== Forge Output: use only REAL items (present in ICON_PATHS), Exotic rarity =====
  function getRealItemNames(){
    try{
      const ks = Object.keys(ICON_PATHS||{});
      if(Array.isArray(ks) && ks.length) return ks;
    }catch(e){}
    try{
      return (ITEM_NAMES||[]).filter(n => ICON_PATHS && Object.prototype.hasOwnProperty.call(ICON_PATHS, n));
    }catch(e){}
    return [];
  }
  function createRandomNormalExotic(){
    const real = getRealItemNames();
    const name = real.length ? real[Math.floor(Math.random()*real.length)] : '24 King Crown';
    const baseIdx = Math.floor(Math.random()*20);
    const svg = (typeof getItemSvg==='function') ? getItemSvg(name, baseIdx, 'exotic') : '';
    return { uid: (Math.random().toString(36).slice(2)+Date.now().toString(36)), name, rarity:'exotic', price:0, baseIdx, svg };
  }

  // Hook Exotic Forge button so output is normal Exotic and LA-only inputs count for quest
  function hookExoticForgeBtn(){
    const btn = document.getElementById('exoticForgeBtn');
    if(!btn || btn.dataset.dqHooked==='1') return;
    const clone = btn.cloneNode(true);
    btn.replaceWith(clone);
    clone.dataset.dqHooked = '1';
    clone.addEventListener('click', function(){
      // Validate all 4 stands are legacy (any type)
      const ok = (state.stands||[]).every(uid=>{
        if(!uid) return false;
        const it = state.placed[uid] || (state.inventory||[]).find(x=>x.uid===uid);
        return it && String(it.rarity).toLowerCase()==='legacy';
      });
      if(!ok) return;

      // Check LA-only inputs for quest 3
      const allLA = (state.stands||[]).every(uid=>{
        const it = state.placed[uid] || (state.inventory||[]).find(x=>x.uid===uid);
        return isLAItem(it);
      });

      // Consume 4 inputs
      (state.stands||[]).forEach(uid=>{ if(uid && state.placed[uid]) delete state.placed[uid]; });
      state.stands = [null,null,null,null];

      // Create a proper random exotic from REAL items only
      const ex = createRandomNormalExotic();
      state.placed[ex.uid] = ex;
      state.stands[0] = ex.uid;

      if(typeof recalcEPS==='function') recalcEPS();
      if(typeof renderInventory==='function') renderInventory();
      if(typeof renderStands==='function') renderStands();
      saveDQ();
      if(allLA){
        state.dodgerQuests.exoticsLA = (state.dodgerQuests.exoticsLA||0) + 1;
        saveDQ();
        updateDodgerQuestsUI();
      }
    });
  }
  setInterval(hookExoticForgeBtn, 1200);

  // Mark LA items when bought from LA Pack (best-effort)
  (function tryWrapBuyLAPack(){
    if(window.__wrappedBuyLAPack) return;
    const pol = setInterval(()=>{
      const btn = document.getElementById('buyLAPack');
      if(btn){
        if(document.body.classList.contains('upside-down')){ btn.style.display='none'; return; }
        btn.addEventListener('click', ()=>{
          setTimeout(()=>{
            try{
              const inv = state.inventory||[];
              for(let i=inv.length-1;i>=0;i--){
                const it = inv[i];
                if(isLAItem(it)){ it.la = true; break; }
              }
              saveDQ();
            }catch(e){}
          }, 10);
        });
        window.__wrappedBuyLAPack = true;
        clearInterval(pol);
      }
    }, 600);
  })();

  // Inject Dodger Quests card (takes over logo box)
  function injectDodgerQuestsCard(){
    const overlay = document.getElementById('dodgerOverlay');
    if(!overlay) return;
    const logoImg = overlay.querySelector('#dodgerShopLogo');
    let hostCard = logoImg ? logoImg.closest('.dodger-card') : overlay.querySelector('.dodger-card:last-child');
    if(!hostCard) return;
    hostCard.id = 'cardDodgerQuests';
    hostCard.style.display = 'block';
    hostCard.style.placeItems = 'initial';
    hostCard.innerHTML = '<h3>Dodger Quests</h3>'
      + '<div class="dq-box">'
      +   '<div class="dq-row"><div class="dq-check" id="dqEarnChk"></div>'
      +   '<div style="flex:1">Earn $10,000,000,000 from Dodger rarity</div></div>'
      +   '<div class="dq-sub" id="dqEarnSub"></div>'
      +   '<div class="dq-row"><div class="dq-check" id="dqOwnChk"></div>'
      +   '<div style="flex:1">Own 15 items that are a Dodger rarity</div></div>'
      +   '<div class="dq-sub" id="dqOwnSub"></div>'
      +   '<div class="dq-row"><div class="dq-check" id="dqForgeChk"></div>'
      +   '<div style="flex:1">Forge 6 EXOTICS from only LA Pack items</div></div>'
      +   '<div class="dq-sub" id="dqForgeSub"></div>'
      +   '<button class="dodger-buy dq-claim" id="dqClaimBtn" disabled>Claim Background</button>'
      +   '<div class="dq-sub" id="dqClaimNote">Reward: LA Dodgers Quests background (apply via Backgrounds)</div>'
      + '</div>';
    document.getElementById('dqClaimBtn').addEventListener('click', claimReward);
    updateDodgerQuestsUI();
  }

  function fmt(n){ try{return (n||0).toLocaleString(undefined,{maximumFractionDigits:0});}catch(e){ return String(n); } }
  function updateDodgerQuestsUI(){
    const earned = Math.floor(state.dodgerQuests.earned||0);
    const own = countDodgerRarityOwned();
    const forged = Math.floor(state.dodgerQuests.exoticsLA||0);

    const earnOk = earned >= EARN_GOAL;
    const ownOk = own >= OWN_GOAL;
    const forgeOk = forged >= EXOTIC_LA_GOAL;

    const earnPct = Math.min(100, Math.floor(earned/EARN_GOAL*100));
    const ownPct = Math.min(100, Math.floor(own/OWN_GOAL*100));
    const forgePct = Math.min(100, Math.floor(forged/EXOTIC_LA_GOAL*100));

    const E = document.getElementById('dqEarnChk'); if(E){ E.classList.toggle('ok', earnOk); E.textContent = earnOk?'âœ“':''; }
    const O = document.getElementById('dqOwnChk'); if(O){ O.classList.toggle('ok', ownOk); O.textContent = ownOk?'âœ“':''; }
    const F = document.getElementById('dqForgeChk'); if(F){ F.classList.toggle('ok', forgeOk); F.textContent = forgeOk?'âœ“':''; }

    const Es = document.getElementById('dqEarnSub'); if(Es){ Es.textContent = fmt(earned) + ' / ' + fmt(EARN_GOAL) + ' ('+earnPct+'%)'; }
    const Os = document.getElementById('dqOwnSub'); if(Os){ Os.textContent = own + ' / ' + OWN_GOAL + ' ('+ownPct+'%)'; }
    const Fs = document.getElementById('dqForgeSub'); if(Fs){ Fs.textContent = forged + ' / ' + EXOTIC_LA_GOAL + ' ('+forgePct+'%)'; }

    const all = earnOk && ownOk && forgeOk;
    const btn = document.getElementById('dqClaimBtn');
    if(btn){
        if(document.body.classList.contains('upside-down')){ btn.style.display='none'; return; }
      btn.disabled = !(all && !state.dodgerQuests.unlocked);
      btn.textContent = state.dodgerQuests.unlocked ? 'Unlocked' : (all ? 'Claim Background' : 'Locked');
    }
  }

  // Reward: unlock BG tile
  let __dqBgURL = null;
  function ensureDodgerQuestBgURL(cb){
    if(__dqBgURL){ cb(__dqBgURL); return; }
    const img = new Image();
    const url = 'la_dodgers_style_files/la_dodgers_quests_style.png';
    img.onload = ()=>{ __dqBgURL = url; cb(url); };
    img.onerror = ()=>{ __dqBgURL = url; cb(url); };
    img.src = url;
  }

  function claimReward(){
    // +50 XP for completing Dodger Quests (only once)
    try{ if(!state.dodgerQuests.unlocked){ addXP(50,'quest'); } }catch(e){}
    state.dodgerQuests.unlocked = true;
    state.unlockedBackgrounds = state.unlockedBackgrounds || {};
    state.unlockedBackgrounds.dodgerquests = true;
    saveDQ();
    ensureDodgerQuestBgURL(function(url){
      try{
        var st = document.getElementById('dqBgStyle');
        if(!st){ st = document.createElement('style'); st.id='dqBgStyle'; document.head.appendChild(st); }
        st.textContent = "body.bg-dodgerquests{background:url('"+url+"') center center / cover no-repeat fixed !important;}";
      }catch(e){}
      if(typeof window.__renderBgGrid==='function') window.__renderBgGrid();
      updateDodgerQuestsUI();
      alert('Dodger Quests background unlocked! Apply it from Backgrounds.');
    });
  }

  // Add tile to Background selector
  (function extendBgGrid(){
    const orig = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if(typeof orig === 'function') orig();
      try{
        const g = document.getElementById('bgGrid'); if(!g) return;
        if(!g.querySelector('[data-dodgerquests]')){
          const el = document.createElement('div');
          el.setAttribute('data-dodgerquests','1');
          el.className = 'bg-tile' + (!((state.unlockedBackgrounds||{}).dodgerquests)?' locked':'');
          ensureDodgerQuestBgURL(function(url){
            el.style.cssText = "background:url('"+url+"') center/cover no-repeat;border-color:#0b2e6e;";
          });
          el.innerHTML = '<div style="font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)">DODGER QUESTS</div><button class="buy bg-apply" '+(!((state.unlockedBackgrounds||{}).dodgerquests)?'disabled':'')+'>Apply</button>';
          el.querySelector('.bg-apply').onclick = function(){
            if(!((state.unlockedBackgrounds||{}).dodgerquests)) return;
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-rainbow','bg-spaceview','bg-dodger','redblue','bg-crypto');
            document.body.classList.add('bg-dodgerquests');
            state.selectedBackground = 'dodgerquests';
            saveDQ();
          };
          g.appendChild(el);
        }else{
          const el = g.querySelector('[data-dodgerquests]');
          el.classList.toggle('locked', !((state.unlockedBackgrounds||{}).dodgerquests));
          const btn = el.querySelector('.bg-apply'); if(btn) btn.disabled = !((state.unlockedBackgrounds||{}).dodgerquests);
        }
      }catch(e){}
    };
  })();

  // When Dodgers overlay opens, inject the card
  (function hookOpenDodgers(){
    const poll = setInterval(()=>{
      const btn = document.getElementById('openDodger');
      if(btn){
        if(document.body.classList.contains('upside-down')){ btn.style.display='none'; return; }
        btn.addEventListener('click', ()=> setTimeout(injectDodgerQuestsCard, 0));
        clearInterval(poll);
      }
    }, 500);
  })();

  // Continuous earnings tracker
  let last = performance.now();
  function dqLoop(ts){
    const dt = Math.max(0, (ts - last) / 1000);
    last = ts;
    const eps = currentDodgerEPS();
    if(eps > 0){
      state.dodgerQuests.earned = (state.dodgerQuests.earned||0) + eps * dt;
      if((Math.random()<0.05)) saveDQ();
    }
    const ov = document.getElementById('dodgerOverlay');
    if(ov && ov.classList.contains('show')) updateDodgerQuestsUI();
    requestAnimationFrame(dqLoop);
  }
  requestAnimationFrame(dqLoop);

  const _ri = window.renderInventory;
  window.renderInventory = function(){ if(_ri) _ri.apply(this, arguments); updateDodgerQuestsUI(); };
  const _rs = window.renderStands;
  window.renderStands = function(){ if(_rs) _rs.apply(this, arguments); updateDodgerQuestsUI(); };

})();
</script>
<script>
// === Cosmic Event: turned off (UI/page removed). Preserve existing content. ===
(function(){
  try {
    window.RARITY = window.RARITY || {};
    if (!RARITY.cosmic) {
      // Keep COSMIC rarity so existing items still earn EPS and display correctly.
      RARITY.cosmic = { label: 'COSMIC', color: '#8fd0ff', income: 35000, price:[0,0], prob: 0 };
    }
  } catch(e){}

  // Keep Space View usable if previously unlocked; do not expose purchase.
  
  (function extendBgGridForSunrise(){
    const orig = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if (typeof orig === 'function') orig();
      try{
        const g = document.getElementById('bgGrid'); if(!g) return;
        if ((state.unlockedBackgrounds||{}).sunrise && !g.querySelector('[data-sunrise]')){
          const el = document.createElement('div');
          el.setAttribute('data-sunrise','1');
          el.className = 'bg-tile';
          el.style.cssText = "background-image:url('background_files/sunrise_style.png');background-size:cover;background-position:center;border:4px solid rgba(255,255,255,.4)";
          el.innerHTML = '<div style="font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)">SUNRISE</div><button class=\"buy bg-apply\">Apply</button>';
          el.querySelector('.bg-apply').onclick = function(){
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-legendary','bg-unique','bg-exotic','bg-mythic','bg-rainbow','bg-crypto','bg-dodger','bg-spaceview','bg-dodgerquests','redblue');
            document.body.classList.add('bg-sunrise');
            state.selectedBackground = 'sunrise';
            try{ if(typeof save==='function') save(); }catch(e){}
          };
          g.appendChild(el);
        }
      }catch(e){}
    };
  })();

  (function extendBgGridForGreatWave(){
    const orig = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if (typeof orig === 'function') orig();
      try{
        const g = document.getElementById('bgGrid'); if(!g) return;
        if ((state.unlockedBackgrounds||{}).greatwave && !g.querySelector('[data-greatwave]')){
          const el = document.createElement('div');
          el.setAttribute('data-greatwave','1');
          el.className = 'bg-tile';
          el.style.cssText = "background-image:url('background_files/the_great_wave.png');background-size:cover;background-position:center;border:4px solid rgba(255,255,255,.4)";
          el.innerHTML = '<div style="font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)">THE GREAT WAVE</div><button class="buy bg-apply">Apply</button>';
          el.querySelector('.bg-apply').onclick = function(){
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-legendary','bg-unique','bg-exotic','bg-mythic','bg-rainbow','bg-crypto','bg-dodger','bg-spaceview','bg-dodgerquests','redblue','bg-sunrise','bg-hawkins','bg-winter');
            document.body.classList.add('bg-greatwave');
            state.selectedBackground = 'greatwave';
            try{ if(typeof save==='function') save(); }catch(e){}
          };
          g.appendChild(el);
        }
      }catch(e){}
    };
  })();
(function extendBgGridForSpaceView(){
    const orig = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if (typeof orig === 'function') orig();
      try{
        const g = document.getElementById('bgGrid'); if(!g) return;
        // Only add tile if the player already owns it.
        if ((state.unlockedBackgrounds||{}).spaceview && !g.querySelector('[data-spaceview]')){
          const el = document.createElement('div');
          el.setAttribute('data-spaceview','1');
          el.className = 'bg-tile';
          el.style.cssText = 'background:radial-gradient(1200px 600px at 50% -200px,#091225,#04060c)';
          el.innerHTML = '<div style="font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)">SPACE VIEW</div>'
                       + '<button class="buy bg-apply">Apply</button>';
          el.querySelector('.bg-apply').onclick = function(){
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-rainbow','bg-dodger','bg-dodgerquests','redblue','bg-crypto');
            document.body.classList.add('bg-spaceview');
            state.selectedBackground = 'spaceview';
            try{ if(typeof save==='function') save(); }catch(e){}
          };
          g.appendChild(el);
        }
      }catch(e){}
    };
  })();
})();
</script>
<script>
// === CRYPTO rarity + forge (2 Mythic + 2 Exotic => 1 random CRYPTO, 50,000 EPS) ===
(function(){
  try{
    // Ensure rarity entry exists
    window.RARITY = window.RARITY || {};
    if(!RARITY.crypto){
      RARITY.crypto = { label:'CRYPTO', color:'#ff62d5', income: 50000, price:[0,0], prob: 0 };
    }

    
function _getRealItemNames(){
  try{
    // Prefer the in-scope ICON_PATHS; fall back to window if exported
    const map = (typeof ICON_PATHS !== 'undefined') ? ICON_PATHS : (window.ICON_PATHS || {});
    const ks = Object.keys(map || {});
    if (Array.isArray(ks) && ks.length) return ks;
  }catch(e){}
  try{
    // Fall back to ITEM_NAMES and keep only those that have icons available
    const list = (typeof ITEM_NAMES !== 'undefined') ? ITEM_NAMES : (window.ITEM_NAMES || []);
    const map = (typeof ICON_PATHS !== 'undefined') ? ICON_PATHS : (window.ICON_PATHS || {});
    if (Array.isArray(list) && list.length) {
      return list.filter(n => Object.prototype.hasOwnProperty.call(map, n));
    }
  }catch(e){}
  // Last resort: return whatever list is available (may still be empty)
  try{
    return (typeof ITEM_NAMES !== 'undefined') ? ITEM_NAMES.slice() : (window.ITEM_NAMES || []);
  }catch(e){}
  return [];
}
function _randomCrypto(){
  // Build a loot pool strictly from icon-backed items
  const names=(function(){
    try{
      if(typeof ICON_PATHS!=='undefined' && ICON_PATHS) return Object.keys(ICON_PATHS);
      if(typeof window!=='undefined' && window.ICON_PATHS) return Object.keys(window.ICON_PATHS);
    }catch(e){}
    try{
      const list=(typeof ITEM_NAMES!=='undefined')?ITEM_NAMES:(window.ITEM_NAMES||[]);
      const map =(typeof ICON_PATHS!=='undefined')?ICON_PATHS:(window.ICON_PATHS||{});
      if(Array.isArray(list) && list.length) return list.filter(n=>Object.prototype.hasOwnProperty.call(map,n));
    }catch(e){}
    return [];
  })();
  const n = names.length;
  // Robust RNG independent of Math.random()
  let t=0;
  try{ t=(typeof performance!=='undefined' && performance.now)?performance.now():Date.now(); }catch(e){ t=Date.now(); }
  try{ window.__rngCounter=(window.__rngCounter|0)+1; t+=window.__rngCounter; }catch(e){}
  let x = Math.floor(t*1000003) ^ (Date.now()<<13);
  x ^= (x<<13); x ^= (x>>>17); x ^= (x<<5);
  const idx = n>0 ? Math.abs(x)%n : 0;
  const name = n>0 ? names[idx] : '24 King Crown';

  // Create the same kind of icon URL as other forges do
  let svg = '';
  if(typeof getItemSvg==='function'){
    try{ svg = getItemSvg(name, idx, 'crypto') || ''; }catch(e){ svg=''; }
  }
  if(!svg){
    // Fallback: build minimal SVG and encode as a data URI so <img src="..."> works
    const map  = (typeof ICON_PATHS!=='undefined') ? ICON_PATHS : (window.ICON_PATHS || {});
    const path = (map && map[name]) ? String(map[name]) : '';
    const raw  = path ? (
      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96">'+
      '<defs><linearGradient id="gCrypto" x1="0%" y1="0%" x2="100%" y2="0%">'+
      '<stop offset="0%" stop-color="#ff62d5"/><stop offset="100%" stop-color="#ffd84a"/></linearGradient></defs>'+
      '<rect x="4" y="4" width="88" height="88" rx="14" ry="14" fill="url(#gCrypto)" opacity="0.10"/>'+
      '<g stroke="url(#gCrypto)" stroke-width="3.5" fill="none">'+ path +'</g>'+
      '</svg>'
    ) : (
      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96">'+
      '<rect x="6" y="6" width="84" height="84" rx="12" fill="#1a1a1a"/>'+
      '<text x="48" y="52" text-anchor="middle" fill="#ff62d5" font-size="10" font-weight="700">'+(name||'Item')+'</text>'+
      '</svg>'
    );
    try{ svg = 'data:image/svg+xml;utf8,' + encodeURIComponent(raw); }catch(e){ svg=''; }
  }
  return { uid:(Math.random().toString(36).slice(2)+Date.now().toString(36)), name, rarity:'crypto', price:0, baseIdx:idx, svg };
})();
const n = names.length;
// Robust RNG even if Math.random is patched to a constant: use a mixed time-based seed
let t = 0;
try{ t = (typeof performance!=='undefined' && performance.now) ? performance.now() : Date.now(); }catch(e){ t = Date.now(); }
try{ window.__rngCounter = (window.__rngCounter|0) + 1; t += window.__rngCounter; }catch(e){}
let x = Math.floor(t*1000003) ^ (Date.now()<<13);
x ^= (x << 13); x ^= (x >>> 17); x ^= (x << 5);
const idx = n>0 ? Math.abs(x) % n : 0;
const name = n>0 ? names[idx] : '24 King Crown';
const svg  = (typeof getItemSvg==='function') ? getItemSvg(name, idx, 'crypto') : '';
return { uid: (Math.random().toString(36).slice(2) + Date.now().toString(36)), name, rarity:'crypto', price:0, baseIdx:idx, svg };
}

    function checkCryptoForge(){
      try{
        const stands = (window.state && Array.isArray(state.stands)) ? state.stands.slice() : [];
        if(stands.length !== 4) return hideBtn();
        // Must be all 4 filled, only mythic/exotic, and counts = 2 + 2
        let myth=0, exo=0, ok=true;
        for(const uid of stands){
          if(!uid){ ok=false; break; }
          const it = (state.placed||{})[uid] || (state.inventory||[]).find(x=>x.uid===uid);
          if(!it || !it.rarity){ ok=false; break; }
          const r = String(it.rarity).toLowerCase();
          if(r==='mythic') myth++;
          else if(r==='exotic') exo++;
          else { ok=false; break; }
        }
        if(!(ok && myth===2 && exo===2)) return hideBtn();

        // show / create button
        let btn = document.getElementById('cryptoForgeBtn');
        if(!btn){
          btn = document.createElement('button');
          btn.id = 'cryptoForgeBtn';
          btn.textContent = 'FORGE CRYPTO';
          btn.style.cssText = 'margin-top:6px;padding:10px 18px;border-radius:14px;background:linear-gradient(45deg,#ff62d5,#ffd84a);border:4px solid rgba(0,0,0,.35);color:#000;font-weight:900;box-shadow:0 8px 30px rgba(255,120,220,.35);cursor:pointer;';
          btn.addEventListener('click', function(){
            // consume the 4 inputs
            (state.stands||[]).forEach(uid=>{ if(uid && (state.placed||{})[uid]) delete state.placed[uid]; });
            state.stands = [null,null,null,null];
            // create CRYPTO and place on stand 0
            const c = _randomCrypto();
            (state.placed||(state.placed={}))[c.uid] = c;
            state.stands[0] = c.uid;
            if(typeof recalcEPS==='function') recalcEPS();
            if(typeof renderInventory==='function') renderInventory();
            if(typeof renderStands==='function') renderStands();
            if(typeof save==='function') save();
          });
          const host = document.querySelector('.game') || document.body;
          const before = document.querySelector('.inventory-wrap') || null;
          if(before) host.insertBefore(btn, before); else host.appendChild(btn);
        }
        btn.style.display = 'inline-block';
        return;

        function hideBtn(){ const b = document.getElementById('cryptoForgeBtn'); if(b) b.style.display='none'; }
      }catch(e){ /* no-op */ }
      function hideBtn(){ const b = document.getElementById('cryptoForgeBtn'); if(b) b.style.display='none'; }
    }

    // Hook renderStands: run our forge check and add glow to placed CRYPTO items
    (function hookCrypto(){
      const orig = window.renderStands;
      window.renderStands = function(){
        if(typeof orig === 'function') orig.apply(this, arguments);
        try{ checkCryptoForge(); }catch(e){}
        // apply glow if a placed element has a CRYPTO badge
        try{
          document.querySelectorAll('.placed').forEach(el=>{
            const has = !!el.querySelector('.rar.t-crypto');
            el.classList.toggle('crypto-glow', has);
          });
        }catch(e){}
      };
      // initial run
      setTimeout(()=>{ try{ checkCryptoForge(); }catch(e){}; try{
        document.querySelectorAll('.placed').forEach(el=>{
          const has = !!el.querySelector('.rar.t-crypto');
          el.classList.toggle('crypto-glow', has);
        });
      }catch(e){}; }, 0);
    })();
  }catch(e){}
})();
</script>
<script>
/* LA_DODGER_FETCH_HOOK v2: gate on baseline so it only triggers after admin starts */
(function(){
  try{
    const _fetch = window.fetch;
    // Establish baseline at load: any messages at or before these are ignored
    const baselineG = Number(localStorage.getItem('flex_msg_lastG')||0);
    const baselineU = Number(localStorage.getItem('flex_msg_lastU')||0);
    let lastSeen = Math.max(baselineG, baselineU);
    try{ localStorage.setItem('la_dodgers_event_baseline', String(lastSeen)); }catch(e){}
    window.fetch = function(input, init){
      const p = _fetch.apply(this, arguments);
      try{
        const url = (typeof input === 'string') ? input : (input && input.url) || '';
        if(/\/rawsave\?user=/.test(url) && (/__broadcast/.test(url) || /__inbox_/.test(url))){
          p.then(r => r.clone().json().then(data => {
            const list = (data && Array.isArray(data.list)) ? data.list : [];
            for (const m of list){
              const ts = (m && m.ts) || 0;
              if((m && (m.op === 'dodger_event' || m.op === 'LA_DODGER_EVENT')) && ts > lastSeen){
                lastSeen = ts;
                try{ localStorage.setItem('la_dodgers_event_last_ts', String(lastSeen)); }catch(e){}
                if(typeof window.startDodgerLiveEvent === 'function' && !window.__laEventRunning){
                  window.__laEventRunning = true;
                  try{ window.startDodgerLiveEvent(m); }catch(e){}
                }
              }
            }
          }).catch(()=>{})).catch(()=>{});
        }
      }catch(e){}
      return p;
    };
  }catch(e){}
})();
</script>
<script>
// LA_DODGER_LATE_HOOK: ensure enqueue is hooked even if defined later
(function(){
  if(window.__laLateHookInstalled) return; window.__laLateHookInstalled = true;
  let tries = 0, maxTries = 60; // ~60s
  const install = () => {
    if(typeof window.enqueue === 'function' && !window.__laEnqueueWrapped){
      const orig = window.enqueue;
      window.enqueue = function(msg){
        try{
          const gateG = Number(localStorage.getItem('flex_msg_lastG')||0);
          const gateU = Number(localStorage.getItem('flex_msg_lastU')||0);
          const gate = Math.max(gateG, gateU);
          if(msg && (msg.op==='dodger_event' || msg.op==='LA_DODGER_EVENT' || /(la\s*dodger).*event/i.test(String(msg.text||'')))){
            if((msg.ts||0) > gate && typeof window.startDodgerLiveEvent==='function' && !window.__laEventRunning){
              window.__laEventRunning = true;
              try{ window.startDodgerLiveEvent(msg); }catch(e){}
            }
          }
        }catch(e){}
        return orig.apply(this, arguments); // still show the banner
      };
      window.__laEnqueueWrapped = true;
      return true;
    }
    return false;
  };
  if(!install()){
    const t = setInterval(()=>{
      tries++;
      if(install() || tries>=maxTries) clearInterval(t);
    }, 1000);
  }
})();
</script>
<audio id="ziteMusic" preload="auto" src="flex_music/dodger_event_music.mp3" style="display:none"></audio>
<script>

// === Zite Event Music (autoplay with graceful fallback) ===
(function(){
  const audioEl = document.getElementById('ziteMusic');
  let uiShown = false;
  function showEnableButton(){
    if(uiShown) return; uiShown = true;
    const btn = document.createElement('button');
    btn.id = 'enableSoundBtn';
    btn.textContent = 'Enable sound';
    btn.style.position = 'fixed';
    btn.style.zIndex = '2147483647';
    btn.style.bottom = '16px';
    btn.style.right = '16px';
    btn.style.padding = '10px 14px';
    btn.style.borderRadius = '10px';
    btn.style.border = 'none';
    btn.style.background = 'white';
    btn.style.boxShadow = '0 6px 18px rgba(0,0,0,.2)';
    btn.style.fontWeight = '600';
    btn.style.cursor = 'pointer';
    btn.addEventListener('click', async ()=>{
      try{
        await audioEl.play();
        btn.remove();
        window.removeEventListener('pointerdown', tryUnlock, true);
        window.removeEventListener('keydown', tryUnlock, true);
      }catch(e){}
    });
    document.body.appendChild(btn);
  }
  async function tryUnlock(){
    try{
      await audioEl.play();
      const btn = document.getElementById('enableSoundBtn');
      if(btn) btn.remove();
      window.removeEventListener('pointerdown', tryUnlock, true);
      window.removeEventListener('keydown', tryUnlock, true);
    }catch(e){}
  }
  window.playZiteMusic = async function(){
    if(!audioEl) return;
    audioEl.currentTime = 0;
    audioEl.loop = false;
    try{
      await audioEl.play();
    }catch(e){
      // Autoplay likely blocked; ask for a gesture
    }
    if(audioEl.paused){
      showEnableButton();
      window.addEventListener('pointerdown', tryUnlock, true);
      window.addEventListener('keydown', tryUnlock, true);
    }
  };
})();

</script>
<!-- Inventory Filter Mini Sheet -->
<div aria-hidden="true" aria-labelledby="invFilterTitle" class="inv-filter-sheet" id="invFilterSheet" role="dialog">
<header>
<div id="invFilterTitle">Show in inventory</div>
<button aria-label="Close inventory filters" id="invFilterClose">Close</button>
</header>
<div class="opts" id="invFilterOptions">
<!-- checkboxes will be injected by script -->
</div>
<div class="actions">
<button class="all" id="invFilterAll">Select all</button>
<button class="clear" id="invFilterClear">Clear</button>
</div>
</div>
<script>
(function(){
  const CATS = [
    {key:'common', label:'Common'},
    {key:'rare', label:'Rare'},
    {key:'epic', label:'Epic'},
    {key:'legendary', label:'Legendary'},
    {key:'legacy', label:'Legacy'},
    {key:'unique', label:'Unique'},
    {key:'exotic', label:'Exotic'},
    {key:'mythic', label:'Mythic'},
    {key:'crypto', label:'Crypto'},
    {key:'pets', label:'Pets'},
    {key:'eggs', label:'Eggs'},
    {key:'event', label:'Event'}
  ];
  const STORAGE_KEY = 'invFilterPrefsV1';

  function getPrefs(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
    catch(e){ return {}; }
  }
  function setPrefs(p){ localStorage.setItem(STORAGE_KEY, JSON.stringify(p)); }
  function activePrefs(){
    const p = getPrefs();
    const out = {};
    CATS.forEach(c => out[c.key] = (p[c.key] !== false)); // default true
    return out;
  }

  // UI creation
  const host = document.getElementById('invFilterOptions');
  if(host){
    const p = activePrefs();
    host.innerHTML = CATS.map(c => `
      <label class="opt opt-${c.key}">
        <input type="checkbox" data-key="${c.key}" ${p[c.key] ? 'checked' : ''}/>
        <span>${c.label}</span>
      </label>
    `).join('');
  }

  const toggle = document.getElementById('invFilterToggle');
  const sheet  = document.getElementById('invFilterSheet');
  const close  = document.getElementById('invFilterClose');
  const btnAll = document.getElementById('invFilterAll');
  const btnClr = document.getElementById('invFilterClear');

  function openSheet(){
    sheet.classList.add('show');
    sheet.setAttribute('aria-hidden', 'false');
    toggle.setAttribute('aria-expanded', 'true');
  }
  function closeSheet(){
    sheet.classList.remove('show');
    sheet.setAttribute('aria-hidden', 'true');
    toggle.setAttribute('aria-expanded', 'false');
  }

  if(toggle){
    toggle.addEventListener('click', ()=>{
      if(sheet.classList.contains('show')) closeSheet();
      else openSheet();
    });
  }
  if(close) close.addEventListener('click', closeSheet);
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && sheet.classList.contains('show')) closeSheet();
  });
  document.addEventListener('click', (e)=>{
    if(sheet.classList.contains('show')){
      const within = e.target.closest('#invFilterSheet') || e.target.closest('#invFilterToggle');
      if(!within) closeSheet();
    }
  });

  // Preference changes
  host?.addEventListener('change', (e)=>{
    if(e.target && e.target.matches('input[type="checkbox"][data-key]')){
      const p = getPrefs();
      const k = e.target.getAttribute('data-key');
      p[k] = e.target.checked;
      setPrefs(p);
      try { applyInventoryFilters(); } catch(err){ console.warn(err); }
    }
  });
  btnAll?.addEventListener('click', ()=>{
    const p = getPrefs();
    CATS.forEach(c => p[c.key] = true);
    setPrefs(p);
    host.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    try { applyInventoryFilters(); } catch(err){ console.warn(err); }
  });
  btnClr?.addEventListener('click', ()=>{
    const p = getPrefs();
    CATS.forEach(c => p[c.key] = false);
    setPrefs(p);
    host.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    try { applyInventoryFilters(); } catch(err){ console.warn(err); }
  });

  function annotateInventorySlots(){
    const inv = (window.state && state.inventory) ? state.inventory : [];
    const slots = document.querySelectorAll('#inventory .slot');
    slots.forEach((el, i)=>{
      const it = inv[i];
      if(it){
        el.dataset.rarity = String(it.rarity||'').toLowerCase();
        el.dataset.isEgg  = it.isEgg ? '1' : '';
        el.dataset.isPet  = (it.petType && !it.isEgg) ? '1' : '';
        const nm = String(it.name||'').toLowerCase();
        el.dataset.isEvent = (it.event || /dodger|event|zite|coastal/.test(nm) || String(it.rarity||'').toLowerCase()==='coastal') ? '1' : '';
      }else{
        const rarEl = el.querySelector('.rar');
        if(rarEl){
          const m = /t-([a-z]+)/i.exec(rarEl.className || '');
          if(m) el.dataset.rarity = m[1].toLowerCase();
        }
      }
    });
  }

  window.applyInventoryFilters = function applyInventoryFilters(){
    annotateInventorySlots();
    const prefs = activePrefs();
    const slots = document.querySelectorAll('#inventory .slot');
    slots.forEach(el => {
      const rar = (el.dataset.rarity||'').toLowerCase();
      const isEgg = el.dataset.isEgg === '1';
      const isPet = el.dataset.isPet === '1';
      const isEvent = el.dataset.isEvent === '1';
      let show = true;
      if(isEgg) show = prefs.eggs;
      else if(isPet) show = prefs.pets;
      else if(rar && rar in prefs) show = prefs[rar];
      if(isEvent) show = show && prefs.event;
      el.style.display = show ? '' : 'none';
    });
  };

  // Patch renderInventory to auto-apply filters (while preserving any previous patches)
  (function(){
    const prev = window.renderInventory;
    window.renderInventory = function(){
      if(typeof prev === 'function') prev.apply(this, arguments);
      try { window.applyInventoryFilters(); } catch(e){ console.warn('filter apply failed', e); }
    };
  
  // --- Keyboard shortcuts: s+<letter> to show, h+<letter> to hide; s+a show all, h+a hide all ---
  (function(){
    const PRESSED = new Set();
    let lastFired = null;

    // Group categories by the FIRST LETTER of their label (e.g., 'c' => ['common','crypto'])
    const groups = (()=>{
      const g = {};
      CATS.forEach(c=>{
        const first = String(c.label || c.key).trim().charAt(0).toLowerCase();
        if(!first) return;
        if(!g[first]) g[first] = new Set();
        g[first].add(c.key);
      });
      return g;
    })();

    function isTypingTarget(el){
      el = el || document.activeElement;
      return !!(el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable || el.tagName === 'SELECT'));
    }

    function applyByLetter(letter, show){
      // 'a' controls ALL
      const p = getPrefs();
      if(letter === 'a'){
        CATS.forEach(c => p[c.key] = show);
        setPrefs(p);
        try{
          host?.querySelectorAll('input[type="checkbox"][data-key]').forEach(cb => cb.checked = show);
        }catch(e){}
        try{ applyInventoryFilters(); }catch(e){}
        return (show ? 'Show' : 'Hide') + ' ALL';
      }
      const keys = Array.from(groups[letter] || []);
      if(!keys.length) return null;
      keys.forEach(k => p[k] = show);
      setPrefs(p);
      try{
        host?.querySelectorAll('input[type="checkbox"][data-key]').forEach(cb=>{
          const kk = cb.getAttribute('data-key');
          if(keys.includes(kk)) cb.checked = show;
        });
      }catch(e){}
      try{ applyInventoryFilters(); }catch(e){}
      return (show ? 'Show' : 'Hide') + ': ' + keys.join(', ');
    }

    function handleChord(){
      if(isTypingTarget(document.activeElement)) return;
      const hasS = PRESSED.has('s');
      const hasH = PRESSED.has('h');
      if(!(hasS || hasH)) return;

      // Check for any active letter chord; include 'a' for all
      const letters = Object.keys(groups).concat('a');
      for(const letter of letters){
        if(PRESSED.has(letter)){
          const combo = (hasS ? 's' : 'h') + '+' + letter;
          if(combo === lastFired) return; // don't retrigger while keys held
          const msg = applyByLetter(letter, !!hasS);
          if(msg){
            lastFired = combo;
            try{ window.__queue && window.__queue({ t: msg, style: hasS ? 'success' : 'warn' }); }catch(e){}
          }
          return;
        }
      }
    }

    document.addEventListener('keydown', (e)=>{
      // Only look at single-character keys
      const k = String(e.key || '').toLowerCase();
      if(k.length !== 1) return;
      PRESSED.add(k);
      // Avoid stealing focus shortcuts like Ctrl/Cmd combos
      if(e.ctrlKey || e.metaKey || e.altKey) return;
      handleChord();
    }, true);

    document.addEventListener('keyup', (e)=>{
      const k = String(e.key || '').toLowerCase();
      PRESSED.delete(k);
      if(k === 's' || k === 'h') lastFired = null;
    }, true);
  })();
})();

  // Apply once at start (after initial render)
  document.addEventListener('DOMContentLoaded', ()=>{
    setTimeout(()=>{ try { applyInventoryFilters(); } catch(e){} }, 0);
  });
})();
</script>
<script>
// Remove Dodgers Event UI while preserving data/items
(function(){
  function nukeDodgerUI(){
    try{
      const row = document.querySelector('.event-row') || document.getElementById('eventRow');
      if(row && row.parentNode) row.parentNode.removeChild(row);
      const ov = document.getElementById('dodgerOverlay');
      if(ov && ov.parentNode) ov.parentNode.removeChild(ov);
    }catch(e){}
    // hard-disable any global open functions if present
    try{ window.openDodger = function(){}; }catch(e){}
    try{ window.showDodger = function(){}; }catch(e){}
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', nukeDodgerUI);
  else nukeDodgerUI();
})();

/* ===== In-Game Redeem Codes ===== */
(function(){
  const BUCKET_USER = '__redeem_codes__';
  // Prevent double-redeem race from rapid clicks/presses
  let __redeemBusy = false;

  function show(el){ el?.classList?.add('show'); el?.setAttribute('aria-hidden','false'); }
  function hide(el){ el?.classList?.remove('show'); el?.setAttribute('aria-hidden','true'); }
  function banner(msg){ try{ window.__queue && window.__queue({ t: msg, style:'success' }); }catch(e){} }

  async function fetchJson(u){
    try{ const r = await fetch(u, { cache:'no-store' }); if(!r.ok) return null; return await r.json(); }catch(e){ return null; }
  }

  function normalizeCode(s){
    return String(s||'').replace(/[^0-9]/g,'').slice(0,12);
  }

  function applySunriseUnlock(){
    try{
      window.state = window.state || {};
      state.unlockedBackgrounds = state.unlockedBackgrounds || { default:true };
      state.unlockedBackgrounds.sunrise = true;
      state.selectedBackground = state.selectedBackground || 'default';
      try{ if(typeof window.__renderBgGrid === 'function') window.__renderBgGrid(); }catch(e){}
      if(typeof save === 'function') save();
    }catch(e){}
  }

  async function doRedeemNow(){
    // Spam-proof: lock + disable UI while processing
    if (typeof __redeemBusy !== 'undefined' && __redeemBusy) { return; }
    if (typeof __redeemBusy !== 'undefined') __redeemBusy = true;
    const btn = document.getElementById('doRedeem');try {
      if (btn) { btn.disabled = true; btn.setAttribute('aria-busy','1'); btn.dataset._label = btn.textContent || 'Redeem'; btn.textContent = 'Redeemingâ€¦'; }

    const inp = document.getElementById('redeemInput');
    const msg = document.getElementById('redeemMsg');
    const raw = normalizeCode(inp?.value||'');
    if(raw.length !== 12){ msg.textContent = 'Please enter a 12â€‘digit code.'; return; }
    msg.textContent = 'Checkingâ€¦';
    const data = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent(BUCKET_USER)}&t=${Date.now()}`) || {};
    const codes = Array.isArray(data.codes) ? data.codes : [];
    const hit = codes.find(c => (c && c.active !== false && String(c.code) === raw));
    if(!hit){ msg.textContent = 'Invalid or inactive code.'; return; }

    if(hit.type === 'item'){
      try{
        const name = String(hit.itemName||'').trim(); const rarity = String(hit.rarity||'common').toLowerCase();
        if(!name){ msg.textContent = 'Code is missing item data.'; return; }
        const baseIdx = Math.max(0, (Array.isArray(ITEM_NAMES)?ITEM_NAMES.indexOf(name):-1));
        const svg = (typeof window.getItemSvg==='function') ? getItemSvg(name, baseIdx<0?0:baseIdx, rarity) : '';
        const newItem = { uid: (Math.random().toString(36).slice(2)+Date.now().toString(36)), name, rarity, price:0, baseIdx: baseIdx<0?0:baseIdx, svg };
        window.state = window.state || {}; state.inventory = state.inventory || []; state.inventory.push(newItem);
        if(typeof save === 'function') await save();
        if (typeof renderInventory === 'function') try { renderInventory(); } catch(e){}
        banner('Redeemed! Item added to inventory.');
        // Mark this code as used by removing it from the codes list on the server
        try {
          const nextCodes = codes.filter(x => String(x.code) !== String(raw));
          await fetch(`${SERVER_BASE}/rawsave?user=${encodeURIComponent(BUCKET_USER)}`, {
            method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ __ts: Date.now(), codes: nextCodes })
          });
        } catch(e) { console.warn(e); }
      }catch(e){
        console.warn(e); msg.textContent = 'Could not add item.'; return;
      }
    } else if(hit.type === 'pet'){
      try{
        const petName = String(hit.petName || hit.itemName || hit.petType || '').trim();
        if(!petName){ msg.textContent = 'Code is missing pet data.'; return; }
        // Determine pet EPS: prefer petEps stored in the redeem code; fallback to PET_TABLES lookup
        let eps = 0;
        if(hit && typeof hit.petEps !== 'undefined' && hit.petEps !== null){
          eps = Number(hit.petEps) || 0;
        }
        if(!eps){
          outer: for(const [egg, list] of Object.entries(PET_TABLES || {})){
            if(!Array.isArray(list)) continue;
            for(const p of list){
              if(!p) continue;
              if(p.name === petName){ eps = Number(p.eps) || 0; break outer; }
              if(p.name === 'IRL' && Array.isArray(p.subset) && p.subset.includes(petName)){ eps = Number(p.eps) || 0; break outer; }
            }
          }
        }
        const newPet = {
          uid: uid(),
          name: petName,
          isEgg: false,
          eggType: null,
          petType: petName,
          petEps: eps,
          svg: getPetSvg(petName, Math.floor(Math.random()*99999))
        };
        window.state = window.state || {};
        state.inventory = state.inventory || [];
        state.inventory.push(newPet);
        try{ registerPetOwned(petName); }catch(e){}
        // Apply permanent multiplier flag for legacy pets if needed
        if(petName === 'Flex T-Rex' || petName === 'Flex Dragon' || petName === 'Flexicorn'){ state.permanentPetMultiplier = 1; }
        if(typeof save === 'function') await save();
        if (typeof renderInventory === 'function') try { renderInventory(); } catch(e){}
        banner('Redeemed! Pet added to inventory.');
        // Mark this code as used by removing it from the codes list on the server
        try {
          const nextCodes = codes.filter(x => String(x.code) !== String(raw));
          await fetch(`${SERVER_BASE}/rawsave?user=${encodeURIComponent(BUCKET_USER)}`, {
            method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ __ts: Date.now(), codes: nextCodes })
          });
        } catch(e) { console.warn(e); }
      }catch(e){
        console.warn(e);
        msg.textContent = 'Could not add pet.';
        return;
      }
    }
    else if(hit.type === 'background'){
      try{
        const key = String(hit.backgroundKey||'').toLowerCase();
        const name = String(hit.backgroundName||'Background');
        const asset = String(hit.asset||'');
        if(key === 'sunrise'){
          applySunriseUnlock();
        } else {
          window.state = window.state || {};
          state.unlockedBackgrounds = state.unlockedBackgrounds || {};
          state.unlockedBackgrounds[key] = true;
          if(asset){
            var st = document.getElementById('bg_'+key+'_style');
            if(!st){
              st = document.createElement('style');
              st.id = 'bg_'+key+'_style';
              st.textContent = "body.bg-"+key+"{background:url('"+asset+"') center center / cover no-repeat fixed !important;}";
              document.head.appendChild(st);
            }
          }
          try{ if(typeof window.__renderBgGrid==='function') window.__renderBgGrid(); }catch(e){}
          try{ if(typeof save==='function') await save(); }catch(e){}
        }
        banner('Redeemed! '+name+' background unlocked.');
        try {
          const nextCodes = codes.filter(x => String(x.code) !== String(raw));
          await fetch(`${SERVER_BASE}/rawsave?user=${encodeURIComponent(BUCKET_USER)}`, {
            method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ __ts: Date.now(), codes: nextCodes })
          });
        } catch(e) { console.warn(e); }
      }catch(e){ console.warn(e); msg.textContent='Could not unlock background.'; return; }
    } else {
      msg.textContent = 'Unknown reward type.'; return;
    }

    hide(document.getElementById('redeemOverlay'));
    msg.textContent = '';
    if(inp) inp.value = '';
  } finally {
    if (btn) { btn.disabled = false; btn.removeAttribute('aria-busy'); if (btn.dataset._label) btn.textContent = btn.dataset._label; }
    if (typeof __redeemBusy !== 'undefined') __redeemBusy = false;
  }
}
document.addEventListener('DOMContentLoaded', ()=>{
    const openBtn = document.getElementById('openRedeemOverlay');
    const closeBtn = document.getElementById('closeRedeem');
    const overlay = document.getElementById('redeemOverlay');
    const goBtn = document.getElementById('doRedeem');
    if(openBtn){ openBtn.addEventListener('click', ()=>{ if (typeof __redeemBusy !== 'undefined') __redeemBusy = false; const m=document.getElementById('redeemMsg'); if(m) m.textContent=''; const b=document.getElementById('doRedeem'); if(b){ b.disabled=false; b.removeAttribute('aria-busy'); b.textContent=b.dataset._label||'Redeem'; } show(overlay); }); }
    if(closeBtn){ closeBtn.addEventListener('click', ()=> hide(overlay)); }
    if(goBtn){
      goBtn.addEventListener('click', function(ev){
        if (typeof __redeemBusy !== 'undefined' && __redeemBusy) { ev.preventDefault(); return; }
        doRedeemNow();
      });
    }
  });
})();
</script>
<script>
(function(){
  try{
    const __origGetEggSvg = window.getEggSvg;
    window.getEggSvg = function(eggType, seed){
      if(eggType !== 'magical'){ return __origGetEggSvg.apply(this, arguments); }
      const size = 96;
      const gradId = 'magGrad' + seed;
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 96 96">
        <defs>
          <filter id="eg${seed}" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.35"/>
          </filter>
          <linearGradient id="${gradId}" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#ff004c"/>
            <stop offset="20%" stop-color="#ff7a00"/>
            <stop offset="40%" stop-color="#ffd400"/>
            <stop offset="60%" stop-color="#18e300"/>
            <stop offset="80%" stop-color="#00e7ff"/>
            <stop offset="100%" stop-color="#3a31ff"/>
          </linearGradient>
        </defs>
        <rect x="4" y="4" width="88" height="88" rx="14" fill="#333" />
        <g filter="url(#eg${seed})">
          <ellipse cx="48" cy="52" rx="22" ry="28" fill="url(#${gradId})" />
          <ellipse cx="40" cy="40" rx="6" ry="4" fill="#fff" opacity="0.65"/>
          <g>
            <circle cx="28" cy="30" r="1.6" fill="#fff">
              <animate attributeName="opacity" values="0;1;0" dur="2.2s" repeatCount="indefinite"/>
            </circle>
            <circle cx="68" cy="28" r="1.2" fill="#fff">
              <animate attributeName="opacity" values="0;1;0" dur="1.8s" begin="0.4s" repeatCount="indefinite"/>
            </circle>
            <circle cx="60" cy="68" r="1.4" fill="#fff">
              <animate attributeName="opacity" values="0;1;0" dur="2.6s" begin="0.8s" repeatCount="indefinite"/>
            </circle>
            <circle cx="32" cy="66" r="1.3" fill="#fff">
              <animate attributeName="opacity" values="0;1;0" dur="2.0s" begin="0.2s" repeatCount="indefinite"/>
            </circle>
          </g>
        </g>
      </svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    };
  }catch(e){}
})();
</script>
<script>
(function(){
  try{
    function flexicornCountOnPedestals(){
      try{
        const stands = (window.state && Array.isArray(state.petStands)) ? state.petStands : [];
        let n = 0;
        for(const p of stands){
          if(p && !p.isEgg && ((p.petType||p.name) === 'Flexicorn')) n++;
        }
        return n;
      }catch(e){ return 0; }
    }
    function currentShopWeights(){
      const base = { unique:0.3, legacy:0.5, legendary:1, epic:8, rare:10, common:100 - (0.3+0.5+1+8+10) };
      const count = flexicornCountOnPedestals();
      if(count <= 0) return base;
      const w = { common:50, rare:12, epic:23, legendary:6, legacy:5, unique:4 };
      for(let i=1;i<count;i++){
        w.common = Math.max(0, w.common - 5);
        w.rare += 1; w.epic += 1; w.legendary += 1; w.legacy += 1; w.unique += 1;
      }
      const sum = w.common + w.rare + w.epic + w.legendary + w.legacy + w.unique;
      if(Math.abs(sum - 100) > 0.0001){
        const k = 100/sum;
        w.common*=k; w.rare*=k; w.epic*=k; w.legendary*=k; w.legacy*=k; w.unique*=k;
      }
      return w;
    }
    const __origWeightedPick = window.weightedPick;
    window.weightedPick = function(){
      try{
        const w = currentShopWeights();
        const r = Math.random()*100;
        let acc = 0;
        const order = ['unique','legacy','legendary','epic','rare','common'];
        for(const k of order){
          acc += (w[k]||0);
          if(r < acc) return k;
        }
        return 'common';
      }catch(e){
        return typeof __origWeightedPick === 'function' ? __origWeightedPick() : 'common';
      }
    };
  }catch(e){}
})();
</script>
<script>
// Single-binding for Magical Egg purchase to avoid double hatches
(function(){
  if (window.__bindMagicalEggOnce) return;
  window.__bindMagicalEggOnce = true;
  function bind(){
    var btn = document.getElementById('buyMagicalEgg');
    if(!btn) return;
    // Replace node to drop any listeners added elsewhere
    var newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    var busy = false;
    newBtn.addEventListener('click', function(){
      if (busy) return;
      busy = true;
      try { if (typeof buyEgg === 'function') buyEgg('magical'); }
      finally {
        setTimeout(function(){
          busy = false;
          if (typeof updatePetButtonsUI === 'function') updatePetButtonsUI();
        }, 0);
      }
    });
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind);
  else bind();
})();
</script>
<script>
// Active pedestal multiplier: counts Flex T-Rex, Flex Dragon, Flexicorn on pedestals
(function(){
  try{
    window.getActivePedestalMultiplier = function(){
      try{
        const stands = (window.state && Array.isArray(state.petStands)) ? state.petStands : [];
        let total = 0;
        for(const ps of stands){
          if(!ps || ps.isEgg) continue;
          const nm = String((ps.petType||ps.name)||'').toLowerCase();
          if(nm === 'flex t-rex' || nm === 'flex dragon' || nm === 'flexicorn'){
            total += 5;
          } else if(nm === 'rainbow flex t-rex' || nm === 'rainbow flex dragon'){
            total += 10;
          }
        }
        return total > 0 ? total : 1;
      }catch(e){ return 1; }
    };
  }catch(e){ /* no-op */ }
})();
</script>
<!-- ===== Forge Page (overlay) â€“ added by update v92 ===== -->
<style>
  /* Vertical tool bar anchored to inventory (will be positioned by JS) */
  #toolBarArea{
    position:fixed; z-index:12;
    display:flex; flex-direction:column-reverse; gap:12px;
    align-items:center; justify-content:flex-end;
  }
  #forgeOpenBtn{
    width:64px; height:64px; border-radius:18px;
    display:grid; place-items:center;
    background:#ffd24a; border:4px solid rgba(0,0,0,.4);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    cursor:pointer;
  }
  #forgeOpenBtn img{ width:70%; height:70%; object-fit:contain; }

  /* Forge overlay base */
  #forgeOverlay{ display:none !important; background:transparent !important; backdrop-filter:none !important; -webkit-backdrop-filter:none !important; pointer-events:none; }
  #forgeOverlay.show{ display:flex !important; }
  #forgeOverlay .sheet{ pointer-events:auto; }

  #forgeOverlay .sheet{
    width:min(1120px,96%);
    background:linear-gradient(#f6b374,#f4946a);
    border-radius:30px; border:6px solid #212127; color:#111;
    position:relative; overflow:hidden;
    margin-bottom:160px; /* keep clear of bottom inventory */
  }
  #forgeOverlay h2{
    margin:0 0 6px; font-family:"Russo One"; font-size:52px;
    text-align:center; color:#fff; text-shadow:0 2px 0 rgba(0,0,0,.45);
    letter-spacing:1px;
  }

  .forge-wrap{ display:grid; grid-template-columns:260px 1fr; gap:18px; }
  .forge-left{
    background:#25252b; border:4px solid #111; border-radius:24px; padding:18px; color:#e8e8ee;
  }
  .forge-left h3{ margin:0 0 6px; color:#ffd24a; font-size:32px; font-family:"Russo One"; }
  .forge-left .rule{ margin:16px 0; font-weight:900; }
  .forge-left .rule span{ display:block; opacity:.85; font-weight:700; }

  .forge-grid{
    display:grid; grid-template-columns:1fr auto 1fr; gap:18px; align-items:center;
  }
  .grid-4{
    display:grid; grid-template-columns:repeat(2, 200px); grid-template-rows:repeat(2, 180px); gap:18px;
    background:rgba(255,255,255,.08); padding:16px; border-radius:24px; border:6px solid #f8c24a;
  }
  .forge-slot,.result-slot{
    background:#4b4b52; border-radius:22px; border:6px solid #2b2b31;
    display:grid; place-items:center; position:relative; color:#fff; font-weight:800;
  }
  .forge-slot::after{ content:attr(data-idx); position:absolute; bottom:10px; right:12px; font-weight:900; font-size:28px; color:#ffd24a; text-shadow:0 2px 0 rgba(0,0,0,.35); }
  .forge-slot img, .result-slot img{ width:96px; height:96px; border-radius:14px; }
  .result-wrap{ display:grid; grid-template-rows:180px auto; gap:14px; }
  .result-slot{ width:220px; height:180px; border-color:#7c4cff; box-shadow:inset 0 0 0 6px rgba(124,76,255,.35); }
  #forgeGo{
    padding:16px 24px; font-weight:900; border-radius:16px;
    background:linear-gradient(45deg,#ffd86a,#ffb200); border:4px solid rgba(0,0,0,.35); cursor:pointer;
  }
  #forgeGo:disabled{ filter:grayscale(1) brightness(.7); cursor:not-allowed; }
  .closeForge{ position:absolute; right:12px; top:8px; font-size:28px; background:#222; color:#fff; border:none; border-radius:14px; width:44px; height:44px; cursor:pointer; }
  @media (max-width: 860px){
    .grid-4{ grid-template-columns:repeat(2, min(46vw,200px)); grid-template-rows:repeat(2, 42vw); }
    .result-slot{ width:min(50vw,240px); height:min(40vw,180px); }
  }
</style>
<!-- Tool Bar rail (positioned by JS to kiss the inventory edge) -->
<div id="toolBarArea">
<button id="forgeOpenBtn" title="Forge">
<img alt="Forge" src="icons/forge_icon.png"/>
</button>
</div>
<script>

// Re-ensure Brew button on toolbar mutations (in case something rebuilds the rail)
(function(){
  try{
    const rail = document.getElementById('toolBarArea');
    if(!rail) return;
    const mo = new MutationObserver(()=>{ try{ ensureBrewButtonVisible(); }catch(e){} });
    mo.observe(rail, { childList:true, subtree:false });
    // initial ensure in case this runs after load
    ensureBrewButtonVisible();
  }catch(e){}
})();

</script>

<!-- Forge Overlay -->
<div aria-hidden="true" class="overlay" id="forgeOverlay">
<div aria-labelledby="forgeTitle" aria-modal="true" class="sheet" role="dialog">
<button aria-label="Close Forge" class="closeX closeForge">âœ•</button>
<h2 id="forgeTitle">FORGE</h2>
<div class="forge-wrap">
<div class="forge-left">
<h3>MYTHIC</h3>
<div class="rule">4 LEGENDARY = <span>1 RANDOM MYTHIC</span></div>
<h3 style="color:#7fefff">EXOTIC</h3>
<div class="rule">4 LEGACY = <span>1 RANDOM EXOTIC</span></div>
<h3 style="color:#ff62d5">CRYPTO</h3>
<div class="rule">2 MYTHIC + 2 EXOTIC = <span>1 RANDOM CRYPTO</span></div>
<div style="opacity:.7;margin-top:10px">Tip: click an inventory item, then click a slot to place it.</div>
</div>
<div class="forge-grid">
<div class="grid-4">
<div class="forge-slot" data-idx="1"></div>
<div class="forge-slot" data-idx="2"></div>
<div class="forge-slot" data-idx="3"></div>
<div class="forge-slot" data-idx="4"></div>
</div>
<div>
<button disabled="" id="forgeGo">FORGE</button>
</div>
<div class="result-wrap">
<div class="result-slot" id="forgeResult"></div>
<div style="text-align:center;font-weight:900;opacity:.85">RESULT</div>
</div>
</div>
</div>
</div>
</div>
<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));

  // Has to be *hidden* until opened
  function openForge(){ const o = $('#forgeOverlay'); o.classList.add('show'); o.setAttribute('aria-hidden','false'); }
  function closeForge(){ const o = $('#forgeOverlay'); o.classList.remove('show'); o.setAttribute('aria-hidden','true'); }
  window.openForgePage = openForge; window.closeForgePage = closeForge;

  // Slots
  const forgeSlots = [null,null,null,null];

  function renderForgeSlots(){
    $$('.forge-slot').forEach((el, i)=>{
      const it = forgeSlots[i];
      el.innerHTML = it ? `<img src="${it.svg}" alt="${(it.name||'Item')}"/>` : '';
    });
    (function(){var r=document.getElementById('forgeResult'); if(r && !r.dataset.hold){ r.innerHTML=''; }})();
    updateForgeButton();
  }

  function canForge(){
    const items = forgeSlots.filter(Boolean);
    if(items.length !== 4) return false;
    const rar = items.map(i => String(i.rarity||'').toLowerCase());
    rar.sort();
    const rarKey = rar.join(',');
    if(rarKey === 'legendary,legendary,legendary,legendary') return 'mythic';
    if(rarKey === 'legacy,legacy,legacy,legacy') return 'exotic';
    const counts = items.reduce((m,i)=>{const r=String(i.rarity||'').toLowerCase(); m[r]=(m[r]||0)+1; return m;},{});
    if(counts.mythic===2 && counts.exotic===2) return 'crypto';
    return false;
  }

  function updateForgeButton(){
    const r = canForge();
    const btn = $('#forgeGo');
    btn.disabled = !r;
    btn.title = r ? ('Create ' + r.toUpperCase()) : 'Select a valid recipe';
  }

  function takeFromInventoryByUid(uid){
    try{
      const idx = (state.inventory||[]).findIndex(x=>x && x.uid===uid);
      if(idx>=0) return (state.inventory.splice(idx,1)[0]);
    }catch(e){}
    return null;
  }

  function getRealNames(){
    try{ if(typeof getRealItemNames==='function') return getRealItemNames(); }catch(e){}
    try{ if(typeof _getRealItemNames==='function') return _getRealItemNames(); }catch(e){}
    return Array.isArray(window.ITEM_NAMES)? window.ITEM_NAMES.slice() : [];
  }

  function makeRandomMythic(){
    try{ if(typeof createMythicItem==='function'){ const r=createMythicItem(); if(r && r.svg) return r; } }catch(e){}
    const real = getRealNames();
    const idx = Math.floor(Math.random()*(real.length||20));
    const name = real[idx] || 'Mythic Item';
    const svg  = (typeof getItemSvg==='function') ? getItemSvg(name, idx, 'mythic') : '';
    return { uid: (Math.random().toString(36).slice(2)+Date.now().toString(36)), name, rarity:'mythic', price:0, baseIdx:idx, svg };
  }
  function makeRandomExotic(){
  try{ if(typeof createRandomNormalExotic==='function'){ const r=createRandomNormalExotic(); if(r && r.svg) return r; } }catch(e){}
  if(typeof _randomExotic==='function') return _randomExotic();
    const real = (typeof _getRealItemNames==='function') ? _getRealItemNames() : (Array.isArray(window.ITEM_NAMES)?window.ITEM_NAMES.slice():[]);
  const idx  = Math.floor(Math.random() * (real.length || 20));
  const name = real[idx] || '24 King Crown';
  const svg  = (typeof window.getItemSvg==='function') ? getItemSvg(name, idx, 'exotic') : '';
  return { uid: (Math.random().toString(36).slice(2) + Date.now().toString(36)), name, rarity:'exotic', price:0, baseIdx:idx, svg };
}
  function makeRandomCrypto(){
  try{
    if(typeof _randomCrypto==='function'){
      const r=_randomCrypto();
      if(r && r.svg) return r;
    }
  }catch(e){}
  // Absolute fallback (should rarely run)
  const names=(function(){
    try{
      if(typeof ICON_PATHS!=='undefined' && ICON_PATHS) return Object.keys(ICON_PATHS);
      if(typeof window!=='undefined' && window.ICON_PATHS) return Object.keys(window.ICON_PATHS);
    }catch(e){}
    try{
      const list=(typeof ITEM_NAMES!=='undefined')?ITEM_NAMES:(window.ITEM_NAMES||[]);
      const map =(typeof ICON_PATHS!=='undefined')?ICON_PATHS:(window.ICON_PATHS||{});
      if(Array.isArray(list) && list.length) return list.filter(n=>Object.prototype.hasOwnProperty.call(map,n));
    }catch(e){}
    return [];
  })();
  const n = names.length;
  let t=0; try{ t=(typeof performance!=='undefined' && performance.now)?performance.now():Date.now(); }catch(e){ t=Date.now(); }
  try{ window.__rngCounter=(window.__rngCounter|0)+1; t+=window.__rngCounter; }catch(e){}
  let x = Math.floor(t*1000003) ^ (Date.now()<<13); x ^= (x<<13); x ^= (x>>>17); x ^= (x<<5);
  const idx = n>0 ? Math.abs(x)%n : 0;
  const name = n>0 ? names[idx] : '24 King Crown';

  let svg='';
  if(typeof getItemSvg==='function'){
    try{ svg = getItemSvg(name, idx, 'crypto') || ''; }catch(e){ svg=''; }
  }
  if(!svg){
    const map  = (typeof ICON_PATHS!=='undefined') ? ICON_PATHS : (window.ICON_PATHS || {});
    const path = (map && map[name]) ? String(map[name]) : '';
    const raw  = path ? (
      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96">'+
      '<defs><linearGradient id="gCrypto" x1="0%" y1="0%" x2="100%" y2="0%">'+
      '<stop offset="0%" stop-color="#ff62d5"/><stop offset="100%" stop-color="#ffd84a"/></linearGradient></defs>'+
      '<rect x="4" y="4" width="88" height="88" rx="14" ry="14" fill="url(#gCrypto)" opacity="0.10"/>'+
      '<g stroke="url(#gCrypto)" stroke-width="3.5" fill="none">'+ path +'</g>'+
      '</svg>'
    ) : (
      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96">'+
      '<rect x="6" y="6" width="84" height="84" rx="12" fill="#1a1a1a"/>'+
      '<text x="48" y="52" text-anchor="middle" fill="#ff62d5" font-size="10" font-weight="700">'+(name||'Item')+'</text>'+
      '</svg>'
    );
    try{ svg = 'data:image/svg+xml;utf8,' + encodeURIComponent(raw); }catch(e){ svg=''; }
  }
  return { uid:(Math.random().toString(36).slice(2)+Date.now().toString(36)), name, rarity:'crypto', price:0, baseIdx:idx, svg };
}

  function _randomExotic(){
// Build a loot pool strictly from icon-backed items
const names = (function(){
  try{
    if (typeof ICON_PATHS !== 'undefined' && ICON_PATHS) return Object.keys(ICON_PATHS);
    if (typeof window !== 'undefined' && window.ICON_PATHS) return Object.keys(window.ICON_PATHS);
  }catch(e){}
  try{
    const list = (typeof ITEM_NAMES!=='undefined') ? ITEM_NAMES : (window.ITEM_NAMES || []);
    const map  = (typeof ICON_PATHS!=='undefined') ? ICON_PATHS : (window.ICON_PATHS || {});
    if (Array.isArray(list) && list.length) return list.filter(n => Object.prototype.hasOwnProperty.call(map, n));
  }catch(e){}
  return [];
})();
const n = names.length;
const idx = n>0 ? Math.floor(Math.random()*n) : 0;
const name = n>0 ? names[idx] : '24 King Crown';const svg  = (typeof getItemSvg==='function') ? getItemSvg(name, idx, 'exotic') : '';
return { uid: (Math.random().toString(36).slice(2) + Date.now().toString(36)), name, rarity:'exotic', price:0, baseIdx:idx, svg };
}

function doForge(){
    const outType = canForge();
    if(!outType) return;
    // consume inputs
    forgeSlots.forEach((it, i)=> forgeSlots[i]=null);
    // create result
    let res=null;
    if(outType==='mythic') res = makeRandomMythic();
    else if(outType==='exotic') res = makeRandomExotic();
    else if(outType==='crypto') res = makeRandomCrypto();

    if(res){
      const slot = document.getElementById('forgeResult');
      if(slot){
        try{ slot.dataset.hold = '1'; }catch(e){}
        // Show the icon + name for 3 seconds
        slot.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;gap:6px;">'
          + '<img src=\"' + (res.svg||'') + '\" alt=\"' + (res.name||'Item') + '\" style=\"width:96px;height:96px;border-radius:14px;\"/>'
          + '<div style=\"font-weight:800;font-size:14px;opacity:.9;\">' + String(res.name||'ITEM').toUpperCase() + '</div>'
          + '</div>';
      }

      // Add to inventory and persist
      window.state = window.state || {};
      state.inventory = state.inventory || [];
      state.inventory.push(res);
      if(typeof recalcEPS==='function') try{ recalcEPS(); }catch(e){}
      if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
      if(typeof save==='function') try{ save(); }catch(e){}

      // Clear the preview after 3 seconds, keep item in inventory
      try{
        if(window.__forgeResultTimer) clearTimeout(window.__forgeResultTimer);
        window.__forgeResultTimer = setTimeout(function(){
          var s = document.getElementById('forgeResult');
          if(s){ s.innerHTML = ''; try{ delete s.dataset.hold; }catch(e){} }
        }, 3000);
      }catch(e){}
    }
    renderForgeSlots();
}

  function attachSlotHandlers(){
    $$('.forge-slot').forEach((el, i)=>{
      el.addEventListener('click', ()=>{
        const sel = window.state && state.selectedItemUid;
        if(sel){
          const obj = (state.inventory||[]).find(x=>x && x.uid===sel);
          if(!obj) return;
          if(forgeSlots[i]) state.inventory.push(forgeSlots[i]); // return to inv
          forgeSlots[i] = takeFromInventoryByUid(sel) || obj;
          state.selectedItemUid = null;
          if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
          renderForgeSlots();
          return;
        }
        if(forgeSlots[i]){ // no selection: remove from slot
          state.inventory.push(forgeSlots[i]); forgeSlots[i]=null;
          if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
          renderForgeSlots();
        }
      });
    });
  }

  // Position the tool rail so it kisses the inventory's right edge
  function getInventoryEl(){
    return document.querySelector('.inventory') ||
           document.querySelector('#inventory') ||
           document.querySelector('.inventory-wrap');
  }
  function positionToolbar(){
    const rail = document.getElementById('toolBarArea');
    const inv  = getInventoryEl();
    if(!rail || !inv) return;
    const r = inv.getBoundingClientRect();
    const gap = -2; // negative so it visually touches even with shadows
    rail.style.left   = (r.right + gap) + 'px';
    rail.style.right  = '';
    rail.style.top    = '';
    rail.style.bottom = (window.innerHeight - r.bottom) + 'px';
    rail.style.maxHeight = Math.max(0, r.top - 8) + 'px';
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // open/close wiring
    document.getElementById('forgeOpenBtn')?.addEventListener('click', ()=>{
      if(typeof openPage==='function'){ try{ openPage('forge'); }catch(e){} }
      openForge();
    });
    document.querySelector('#forgeOverlay .closeForge')?.addEventListener('click', closeForge);
    document.getElementById('forgeGo')?.addEventListener('click', doForge);
    attachSlotHandlers();
    renderForgeSlots();
    // Place toolbar correctly
    positionToolbar();
    window.addEventListener('resize', positionToolbar);
    if(typeof window.renderInventory === 'function'){
      const orig = window.renderInventory;
      window.renderInventory = function(){
        try{ return orig.apply(this, arguments); }
        finally{ try{ positionToolbar(); }catch(e){} }
      }
    }
    const obs = new MutationObserver(positionToolbar);
    obs.observe(document.body, { childList:true, subtree:true });
  });
})();
</script>
<!-- ===== end Forge Page addition v92 ===== -->
<script>
(function(){
  // Never show these specific forge buttons
  var BLOCK_IDS = ['exoticForgeBtn','cryptoForgeBtn','mythicForgeBtn'];
  function nuke(root){
    root = root || document;
    // Remove by ID
    BLOCK_IDS.forEach(function(id){
      var el = root.getElementById ? root.getElementById(id) : document.getElementById(id);
      if(el){ try{ el.remove(); }catch(e){ el.style.display='none'; } }
      // also querySelectorAll in case of duplicates
      try{
        root.querySelectorAll('#'+id).forEach(function(n){ try{ n.remove(); }catch(e){ n.style.display='none'; } });
      }catch(e){}
    });
    // Remove by text content: "FORGE", "FORGE MYTHIC", "FORGE EXOTIC", "FORGE CRYPTO"
    var rx = /^(forge(\s+(mythic|exotic|crypto))?)$/i;
    try{
      root.querySelectorAll('button').forEach(function(b){
        var t = (b.innerText||'').trim();
        // avoid removing "Forge Page" or the main overlay action buttons inside the Forge Page
        if (/forge\s*page/i.test(t)) return;
        if (rx.test(t) || /forge\s+mythic|forge\s+exotic|forge\s+crypto/i.test(t)) {
          // If this button lives inside the Forge overlay, keep it
          var keep = false;
          var p = b.parentElement;
          while(p){
            if (p.id === 'forgeOverlay') { keep = true; break; }
            p = p.parentElement;
          }
          if(!keep){
            try{ b.remove(); }catch(e){ b.style.display='none'; }
          }
        }
      });
    }catch(e){}
  }

  function neutralizeFns(){
    // Neutralize pedestal-related forge checks only (do NOT touch forge page functions)
    ['checkExoticForge','checkCryptoForge','checkForge'].forEach(function(name){
      try{
        if (typeof window[name] === 'function'){
          window[name] = function(){ /* disabled to enforce forge via Forge Page only */ };
        }
      }catch(e){}
    });
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      neutralizeFns();
      nuke(document);
    });
  } else {
    neutralizeFns();
    nuke(document);
  }

  // Keep future dynamic insertions removed
  try{
    var mo = new MutationObserver(function(muts){
      for (var i=0;i<muts.length;i++){
        var m = muts[i];
        if (m.addedNodes && m.addedNodes.length){
          for (var j=0;j<m.addedNodes.length;j++){
            var n = m.addedNodes[j];
            if (n.nodeType === 1){ nuke(n); }
          }
        }
      }
    });
    mo.observe(document.documentElement, {childList:true, subtree:true});
  }catch(e){}
})();
</script>
<!-- Stranger Things Event Overlay -->
<div aria-hidden="true" class="overlay" id="strangerOverlay">
<div aria-labelledby="strangerTitle" aria-modal="true" class="sheet" role="dialog">
<button aria-label="Close" class="closeX" id="closeStranger">âœ•</button>
<h2 id="strangerTitle">STRANGER THINGS</h2>
<div class="stranger-grid">
<div class="stranger-card" id="cardHawkinsPack">
<h3>Hawkins Pack <span class="cosmic-badge t-legendary">LIMITED</span></h3>
<div class="stranger-desc">Open the pack to receive a random item in EPIC/LEGENDARY/UNIQUE/MYTHIC from the Hawkins set.</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
<div class="stranger-price">$2,000,000,000</div>
<button class="stranger-buy" id="buyHawkinsPack">Purchase</button>
</div>
</div>
<div class="stranger-card" id="cardHawkinsBG">
<h3>Welcome to Hawkins</h3>
<div class="stranger-desc">Themed background; appears in Backgrounds after purchase.</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
<div class="stranger-price">$10,000,000,000,000</div>
<button class="stranger-buy" id="buyHawkinsStyle">Purchase</button>
</div>
</div>
<div class="stranger-card">
<h3>Demoegg</h3>
<div class="stranger-desc">Hatches: Dart (68% / 25,000 EPS), Demobat (30% / 45,000 EPS), Demodog (2% / 65,000 EPS). Demodog every 20 minutes 50% morph of a placed item adds DEMON badge + red pulse +15,000 EPS to that item.</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
<div class="stranger-price">$3,000,000,000</div>
<button class="stranger-buy" id="buyDemoEgg">Purchase</button>
</div>
</div>
<div class="stranger-card" id="cardStrangePedestals"><h3>Strange Pedestals</h3><div class="stranger-desc">Unlocks a redâ€“yellow glowing pedestal with white polka dots. Equip it from Backgrounds â†’ Pedestals.</div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;"><div class="stranger-price">$15,000,000,000,000</div><button class="stranger-buy" id="buyStrangePedestals">Purchase</button></div></div>
</div>
</div>
</div>
<div class="cosmic-reveal" id="strangerReveal">
<div class="card">
<div style="font-family:'Bungee';font-size:28px;letter-spacing:1px;">You received</div>
<img alt="reward" id="strangerRevealImg"/>
<div id="strangerRevealName" style="font-weight:900;margin-top:6px;"></div>
<div class="rar" id="strangerRevealRarity" style="margin:8px auto 0;padding:6px 12px;border-radius:12px;"></div>
</div>
</div>
<script>
(function(){
  function setStrangerEventIcon(btnEl){
    const candidate = 'icons/stranger_things_icon.png';
    const img = new Image();
    img.onload = function(){
      try{
        const btn = btnEl || document.getElementById('openStranger');
        if(btn) btn.style.setProperty('--stranger-icon', "url('"+candidate+"')");
        const shop = document.getElementById('strangerShopLogo'); if(shop){ shop.src = candidate; }
      }catch(e){}
    };
    img.onerror = function(){};
    img.src = candidate;
  }

  var __hawkinsBgURL = null;
  function ensureHawkinsBgURL(cb){
    if(__hawkinsBgURL){ cb(__hawkinsBgURL); return; }
    const url = 'background_files/hawkins_style.png';
    const test = new Image();
    test.onload = function(){ __hawkinsBgURL = url; writeCss(); cb(url); };
    test.onerror = function(){ __hawkinsBgURL = url; writeCss(); cb(url); };
    test.src = url;
    function writeCss(){
      try{
        let st = document.getElementById('hawkinsBgStyle');
        if(!st){ st = document.createElement('style'); st.id = 'hawkinsBgStyle'; document.head.appendChild(st); }
        st.textContent = "body.bg-hawkins{background:url('"+url+"') center/cover no-repeat fixed !important;}";
      }catch(e){}
    }
  }

  function ensureEventButton(){
    if(document.getElementById('openStranger')) return;
    const row = document.querySelector('.event-row') || document.getElementById('eventRow');
    if(row){
      const btn = document.createElement('button');
      btn.className = 'icon-btn icon-stranger';
      btn.id = 'openStranger';
      btn.title = 'Stranger Things Event';
      btn.innerHTML = '<span class="fallback-text">ST</span>';
      row.appendChild(btn);
      btn.addEventListener('click', openOverlay);
      setStrangerEventIcon(btn);
    } else {
      const b = document.createElement('button');
      b.className = 'icon-btn icon-stranger';
      b.id = 'openStranger';
      b.title = 'Stranger Things Event';
      b.style.position = 'fixed';
      b.style.left = '16px';
      b.style.top = '28px';
      b.style.width = '72px';
      b.style.height = '72px';
      b.style.borderRadius = '18px';
      b.style.zIndex = '20';
      b.innerHTML = '<span class="fallback-text">ST</span>';
      document.body.appendChild(b);
      b.addEventListener('click', openOverlay);
      setStrangerEventIcon(b);
    }
  }

  function openOverlay(){
    document.getElementById('strangerOverlay').classList.add('show');
    document.getElementById('strangerOverlay').setAttribute('aria-hidden','false');
    setStrangerEventIcon();
    updateHawkinsStyleUI();
  updateStrangePedestalUI && updateStrangePedestalUI(); }

  document.getElementById('closeStranger')?.addEventListener('click', ()=>{
    document.getElementById('strangerOverlay').classList.remove('show');
    document.getElementById('strangerOverlay').setAttribute('aria-hidden','true');
  });

  const HAWKINS_PACK_COST = 2_000_000_000;
  
// --- MIGRATION HELPERS ---
function __isInlineSvgString(v){
  return typeof v === 'string' && v.trim().startsWith('<svg');
}
function __hawkinsFileForName(n){
  try{
    const hit = (typeof hawkinsItems!=='undefined' ? hawkinsItems : []).find(x=>x.name===n);
    return hit ? ('stranger_things_items/'+hit.file) : null;
  }catch(e){ return null; }
}
function __petPngFor(it, seed){
  try{
    return getPetSvg(it.petType || it.name, seed);
  }catch(e){ return null; }
}

// === FILE-BASED ICON LOOKUP ===
// Maintain a single object mapping item names to the PNG file path that should be used for its icon.
// Hawkins (Stranger Things) pack items are registered here.  Each entry maps
// the humanâ€‘friendly item name to the corresponding file in the
// `stranger_things_items/` folder.  This list should stay in sync with
// the files under that directory.  If you add or remove items from the
// Build a static mapping from item names to their PNG file paths.  Do not rely
// on dynamically defined arrays (hawkinsItems, LA_ITEMS) because they may not
// yet exist when this code runs.  Instead, explicitly define the mapping here
// so legacy saves and unobtainable event items always pick up their proper
// icons.  If you add more items or folders in the future, extend this map.
window.ITEM_FILE_MAP = window.ITEM_FILE_MAP || {};
Object.assign(ITEM_FILE_MAP, {
  'Delightful Derrick': 'stranger_things_items/delightful_derrick.png',
  // Stranger Things items
  'Bat': 'stranger_things_items/bat.png',
  'Bike': 'stranger_things_items/bike.png',
  'Code Red': 'stranger_things_items/code_red.png',
  'Demogorgon': 'stranger_things_items/demogorgon.png',
  'Dustin Henderson': 'stranger_things_items/dustin_henderson.png',
  'Hawkins Lab': 'stranger_things_items/hawkins_lab.png',
  'Jane 11': 'stranger_things_items/jane_11.png',
  'Jim Hopper': 'stranger_things_items/jim_hopper.png',
  'Lucas Sinclair': 'stranger_things_items/lucas_sinclair.png',
  'Max Mayfield': 'stranger_things_items/max_mayfield.png',
  'Mike Wheeler': 'stranger_things_items/mike_wheeler.png',
  'Nancy Wheeler': 'stranger_things_items/nancy_wheeler.png',
  'Scoops Ahoy': 'stranger_things_items/scoops_ahoy.png',
  'Steve Harrington': 'stranger_things_items/steve_harrington.png',
  'Vecna': 'stranger_things_items/vecna.png',
  'Will Byers': 'stranger_things_items/will_byers.png',
  // LA Dodgers items
  'Dodger Hat': 'la_dodgers_items/dodger_hat.png',
  'Dodger Stadium': 'la_dodgers_items/dodger_stadium.png',
  'World Series': 'la_dodgers_items/world_series.png',
  'Shohei Ohtani': 'la_dodgers_items/shohei_ohtani.png',
  'Will Smith': 'la_dodgers_items/will_smith.png',
  'Freddie Freeman': 'la_dodgers_items/freddie_freeman.png',
  'Mookie Betts': 'la_dodgers_items/mookie_betts.png',
  'Dodger Baseball': 'la_dodgers_items/dodger_baseball.png',
  'Dodger Welcome': 'la_dodgers_items/dodger_welcome.png',
  // Space Pack items
  'Asteroid': 'space_pack_items/asteroid.png',
  'Black Hole': 'space_pack_items/black_hole.png',
  'Earth': 'space_pack_items/earth.png',
  'Mars': 'space_pack_items/mars.png',
  'Moon': 'space_pack_items/moon.png',
  'Space Ship': 'space_pack_items/space_ship.png',
  'Space Suit': 'space_pack_items/space_suit.png',
  'Sun': 'space_pack_items/sun.png'
});
// Ensure Aqua Egg pets have file icons
try{ window.ITEM_FILE_MAP = window.ITEM_FILE_MAP || {}; Object.assign(ITEM_FILE_MAP, {
  'Fish':'pets/fish.png', 'Seahorse':'pets/seahorse.png', 'Dolphin':'pets/dolphin.png', 'Flex Shark':'pets/flex_shark.png'
}); }catch(e){}

// Ensure Aqua Egg uses file-based icon
try{ window.ITEM_FILE_MAP = window.ITEM_FILE_MAP || {}; Object.assign(ITEM_FILE_MAP, { 'Aqua Egg':'icons/eggs/aqua_egg.png', 'aqua egg':'icons/eggs/aqua_egg.png' }); }catch(e){}


// Also register lowercase/trimmed variants of each key so lookups with
// inconsistent casing or stray whitespace will still resolve to the correct
// PNG.  We loop over the current keys and add a lowerâ€‘cased entry if it
// doesn't already exist.  This is wrapped in a try/catch to avoid
// interfering with other parts of the page in case of errors.
try {
  (function() {
    const map = ITEM_FILE_MAP;
    Object.keys(map).forEach(function(key) {
      const lower = key.trim().toLowerCase();
      if (!map[lower]) {
        map[lower] = map[key];
      }
    });
  })();
} catch (_e) {}
const hawkinsItems = [
    {name:'Bat', file:'bat.png'},
    {name:'Bike', file:'bike.png'},
    {name:'Code Red', file:'code_red.png'},
    {name:'Demogorgon', file:'demogorgon.png'},
    {name:'Dustin Henderson', file:'dustin_henderson.png'},
    {name:'Hawkins Lab', file:'hawkins_lab.png'},
    {name:'Jane 11', file:'jane_11.png'},
    {name:'Jim Hopper', file:'jim_hopper.png'},
    {name:'Lucas Sinclair', file:'lucas_sinclair.png'},
    {name:'Max Mayfield', file:'max_mayfield.png'},
    {name:'Mike Wheeler', file:'mike_wheeler.png'},
    {name:'Nancy Wheeler', file:'nancy_wheeler.png'},
    {name:'Scoops Ahoy', file:'scoops_ahoy.png'},
    {name:'Steve Harrington', file:'steve_harrington.png'},
    {name:'Vecna', file:'vecna.png'},
    {name:'Will Byers', file:'will_byers.png'}
  ];
  function pickHawkinsRarity(){
    const table = [['epic',25],['legendary',10],['unique',4],['mythic',1]];
    const total = table.reduce((s,t)=>s+t[1],0);
    let r = Math.random()*total;
    for(const t of table){ if((r -= t[1]) <= 0) return t[0]; }
    return 'rare';
  }
  function revealStrangerReward(obj){
    try{
      const ov = document.getElementById('strangerReveal');
      if(!ov) return;
      document.getElementById('strangerRevealImg').src = obj.svg;
      document.getElementById('strangerRevealName').textContent = obj.name;
      const rr = document.getElementById('strangerRevealRarity');
      rr.className = 'rar t-'+(String(obj.rarity||'common').toLowerCase());
      rr.textContent = (window.RARITY && RARITY[String(obj.rarity).toLowerCase()] ? RARITY[String(obj.rarity).toLowerCase()].label : String(obj.rarity||'COMMON').toUpperCase());
      ov.classList.add('show');
      setTimeout(()=>{ ov.classList.remove('show'); }, 2400);
    }catch(e){}
  }
  function buyHawkinsPack(){
    try{
      if(state.money < HAWKINS_PACK_COST){ alert('Not enough money.'); return; }
      state.money -= HAWKINS_PACK_COST;
      const it = hawkinsItems[Math.floor(Math.random()*hawkinsItems.length)];
      const rar = pickHawkinsRarity();
      const obj = { uid: uid(), name: it.name, rarity: rar, price:[0,0], baseIdx: Math.floor(Math.random()*9999), svg: 'stranger_things_items/'+it.file };
      state.inventory.push(obj);
      revealStrangerReward(obj);
      if(typeof renderInventory==='function') renderInventory();
      if(typeof recalcEPS==='function') recalcEPS();
      if(typeof save==='function') save();
    }catch(e){ console.error(e); }
  }
  document.getElementById('buyHawkinsPack')?.addEventListener('click', buyHawkinsPack);

  const HAWKINS_BG_COST = 10_000_000_000_000;
  function updateHawkinsStyleUI(){
    try{
      const btn = document.getElementById('buyHawkinsStyle');
      if(!btn) return;
      const owned = !!((state.unlockedBackgrounds||{}).hawkins);
      btn.disabled = owned;
      btn.textContent = owned ? 'Owned' : 'Purchase';
    }catch(e){}
  }
  function buyHawkinsStyle(){
    try{
      if((state.unlockedBackgrounds||{}).hawkins) return;
      if(state.money < HAWKINS_BG_COST){ alert('Not enough money.'); return; }
      state.money -= HAWKINS_BG_COST;
      state.unlockedBackgrounds = state.unlockedBackgrounds || {};
      state.unlockedBackgrounds.hawkins = true;
      ensureHawkinsBgURL(function(){ 
        try{ if(typeof window.__renderBgGrid === 'function') window.__renderBgGrid(); }catch(e){}
        updateHawkinsStyleUI();
        alert('Hawkins background unlocked! Apply it from Backgrounds.');
        if(typeof save==='function') save();
      });
    }catch(e){}
  }
  document.getElementById('buyHawkinsStyle')?.addEventListener('click', buyHawkinsStyle);

  const STRANGE_PEDESTAL_COST = 15_000_000_000_000;
function updateStrangePedestalUI(){
  try{
    const btn = document.getElementById('buyStrangePedestals');
    if(!btn) return;
    const owned = !!((state.pedestalSkins||{}).strange);
    btn.disabled = owned;
    btn.textContent = owned ? 'Owned' : 'Purchase';
  }catch(e){}
}
function buyStrangePedestals(){
  try{
    if((state.pedestalSkins||{}).strange){ updateStrangePedestalUI(); return; }
    if(state.money < STRANGE_PEDESTAL_COST){ alert('Not enough money.'); return; }
    state.money -= STRANGE_PEDESTAL_COST;
    state.pedestalSkins = state.pedestalSkins || { default:true };
    state.pedestalSkins.strange = true;
    alert('Strange Pedestals unlocked! Equip it from Backgrounds â†’ Pedestals.');
    try{ updateStrangePedestalUI(); }catch(e){}
    try{ if(typeof window.__renderPedestalPage==='function') window.__renderPedestalPage(); }catch(e){}
    if(typeof save==='function') save();
  }catch(e){}
}
document.getElementById('buyStrangePedestals')?.addEventListener('click', buyStrangePedestals);
(function extendBgGridForHawkins(){
    const orig = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if(typeof orig === 'function') orig();
      try{
        const g = document.getElementById('bgGrid'); if(!g) return;
        if(!g.querySelector('[data-hawkinsbg]')){
          const el = document.createElement('div');
          el.setAttribute('data-hawkinsbg','1');
          el.className = 'bg-tile' + (!((state.unlockedBackgrounds||{}).hawkins)?' locked':'');
          ensureHawkinsBgURL(function(url){ el.style.cssText = "background:url('"+url+"') center/cover no-repeat;border-color:#5b0f12;"; });
          el.innerHTML = '<div style="font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)">HAWKINS</div><button class="buy bg-apply" '+(!((state.unlockedBackgrounds||{}).hawkins)?'disabled':'')+'>Apply</button>';
          el.querySelector('.bg-apply').onclick = function(){
            if(!((state.unlockedBackgrounds||{}).hawkins)) return;
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-rainbow','bg-spaceview','bg-dodger','redblue','bg-crypto','bg-dodgerquests');
            document.body.classList.add('bg-hawkins');
            state.selectedBackground = 'hawkins';
            if(typeof save==='function') save();
          };
          g.appendChild(el);
        }else{
          const el = g.querySelector('[data-hawkinsbg]');
          el.classList.toggle('locked', !((state.unlockedBackgrounds||{}).hawkins));
          const btn = el.querySelector('.bg-apply'); if(btn) btn.disabled = !((state.unlockedBackgrounds||{}).hawkins);
        }
      }catch(e){}
    };
  })();

  // Demoegg chances
  try{ window.EGG_COSTS = window.EGG_COSTS || {}; EGG_COSTS.demoegg = 3_000_000_000; }catch(e){}
  try{
    window.PET_TABLES = window.PET_TABLES || {};
    PET_TABLES.demoegg = [
      { name:'Dart',    chance:0.68, eps:25000 },
      { name:'Demobat', chance:0.30, eps:45000 },
      { name:'Demodog', chance:0.02, eps:65000 }
    ];
  }catch(e){}

  (function extendPetArt(){
    const g = window.getPetSvg;
    window.getPetSvg = function(petName, seed){
      const map = { "Dart":"dart.png", "Demobat":"demobat.png", "Demodog":"demodog.png" };
      if(map[petName]) return 'pets/'+map[petName];
      return typeof g === 'function' ? g(petName, seed) : ('pets/unknown.png');
    };
  })();

  document.getElementById('buyDemoEgg')?.addEventListener('click', function(){
    try{ if(typeof buyEgg === 'function') buyEgg('demoegg'); else alert('Egg shop not available here.'); }catch(e){}
  });

  (function demodogMorphLoop(){
    window.state = window.state || {};
    state.demonTimers = state.demonTimers || {};
    function step(){
      try{
        (state.petStands||[]).forEach((ps, idx)=>{
          if(!ps || (ps.petType!=='Demodog')){ delete state.demonTimers[idx]; return; }
          const now = Date.now();
          if(!state.demonTimers[idx]){
            state.demonTimers[idx] = now + 20*60*1000;
          }else if(now >= state.demonTimers[idx]){
            state.demonTimers[idx] = now + 20*60*1000;
            if(Math.random() < 0.50){
              const placedIds = (state.stands||[]).filter(Boolean);
              if(placedIds.length){
                const uidPick = placedIds[Math.floor(Math.random()*placedIds.length)];
                const it = state.placed[uidPick];
                if(it){
                  it.demon = true;
                  if(typeof renderStands==='function') renderStands();
                  if(typeof recalcEPS==='function') recalcEPS();
                  if(typeof save==='function') save();
                }
              }
            }
          }
        });
      }catch(e){}
      setTimeout(step, 1000);
    }
    setTimeout(step, 1500);
  })();

  (function hookDemonUI(){
    const orig = window.renderStands;
    window.renderStands = function(){
      if(typeof orig === 'function') orig.apply(this, arguments);
      try{
        const standEls = Array.from(document.querySelectorAll('.stands .stand'));
        (state.stands||[]).forEach((uid, i)=>{
          if(!uid) return;
          const it = state.placed[uid]; if(!it) return;
          const host = standEls[i]; if(!host) return;
          const p = host.querySelector('.placed'); if(!p) return;
          if(it.demon){
            // Apply demon morph animation class; tag is handled by base renderStands
            p.classList.add('demonized');
          }else{
            // Remove demon animation class when not applicable
            p.classList.remove('demonized');
          }
        });
      }catch(e){}
    };
    setTimeout(()=>{ try{ renderStands(); }catch(e){} }, 0);
  })();

  (function patchEPS(){
    const orig = window.recalcEPS;
    window.recalcEPS = function(){
      if(typeof orig === 'function') orig.apply(this, arguments);
      try{
        const extra = Object.values(state.placed||{}).reduce((s,it)=> s + (it&&it.demon ? 15000 : 0), 0);
        state.eps = Math.floor((state.eps||0) + extra);
        const el=document.getElementById('eps'); if(el){ el.textContent = '+ $' + ((state.eps||0).toLocaleString(undefined,{maximumFractionDigits:0})) + ' / sec'; }
      }catch(e){}
    };
  })();

  document.addEventListener('DOMContentLoaded', ()=> { ensureEventButton(); setStrangerEventIcon(); });
  new MutationObserver(()=> ensureEventButton()).observe(document.body, {childList:true, subtree:true});
})();
</script>
<!-- ===== end v109 update ===== -->
<!-- Added script to fix the nonâ€‘functional Log Out button
     When the player clicks the button they are prompted for confirmation.
     If they confirm, the user ID and any pending login state are removed
     from storage and the page is reloaded so the login menu appears.
     This runs after the main game logic to ensure the button exists. -->
<script>
  // Immediately attach a click handler to the Log Out button.  This script runs
  // after the DOM has been parsed so the button should already exist.  We avoid
  // waiting on the DOMContentLoaded event because it may have already fired by
  // the time this script executes.
  (function() {
    const logoutBtn = document.getElementById('resetUserBtn');
    if (!logoutBtn) return;
    logoutBtn.addEventListener('click', function(ev) {
      // Stop other listeners from triggering unintended behaviors (e.g. new account prompt)
      ev.stopPropagation();
      ev.preventDefault();
      // Confirm the user's intention to log out
      if (confirm('Do you really want to log out?')) {
        try {
          localStorage.removeItem('flex-userid');
          localStorage.removeItem('flex_login_pending');
          sessionStorage.removeItem('flex-userid-just-set');
        } catch (e) {
          /* ignore storage errors */
        }
        // Clear the inâ€‘memory user ID if it exists
        try { window.USER_ID = null; } catch (e) {}
        // Reload to show the login menu; replace() avoids creating a new history entry
        window.location.replace(window.location.href);
      }
    }, true);
  })();
</script>
<!-- v132 pedestal-guard: keep all 4 pedestals visible at all times -->
<script>
(function(){
  // Make sure state.stands exists and has STAND_COUNT entries
  function ensureStandsLength(){
    try{
      const n = (typeof STAND_COUNT === 'number' && STAND_COUNT>0) ? STAND_COUNT : 4;
      if(!window.state) window.state = {};
      if(!Array.isArray(state.stands)) state.stands = Array(n).fill(null);
      while(state.stands.length < n) state.stands.push(null);
      if(state.stands.length > n) state.stands.length = n;
    }catch(e){}
  }

  function fallbackRender(){
    try{
      const n = (typeof STAND_COUNT === 'number' && STAND_COUNT>0) ? STAND_COUNT : 4;
      const area = document.getElementById('stands');
      if(!area) return;
      area.innerHTML = '';
      for(let i=0;i<n;i++){
        const box = document.createElement('div');
        box.className = 'stand';
        const ped = document.createElement('div');
        ped.className = 'pedestal';
        box.appendChild(ped);
        area.appendChild(box);
      }
    }catch(e){}
  }

  function restoreIfMissing(){
    try{
      ensureStandsLength();
      const host = document.getElementById('stands');
      if(!host) return;
      const n = (typeof STAND_COUNT === 'number' && STAND_COUNT>0) ? STAND_COUNT : 4;
      const standCount = host.querySelectorAll('.stand').length;
      const pedCount = host.querySelectorAll('.stand .pedestal').length;
      if(standCount !== n || pedCount < n){
        if(typeof window.renderStands === 'function'){
          try{ window.renderStands(); }catch(e){ fallbackRender(); }
        }else{
          fallbackRender();
        }
      }
    }catch(e){}
  }

  // Kick once DOM is ready
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', restoreIfMissing, {once:true});
  }else{
    restoreIfMissing();
  }

  // Re-check on common lifecycle events
  ['visibilitychange','pageshow','focus','resize'].forEach(ev=>{
    window.addEventListener(ev, restoreIfMissing, {passive:true});
  });

  // Watch for DOM removals inside #stands
  (function attachObserver(){
    const attach = ()=>{
      const host = document.getElementById('stands');
      if(!host) return false;
      const mo = new MutationObserver(()=> restoreIfMissing());
      mo.observe(host, {childList:true, subtree:true});
      window.__standGuardObserver = mo;
      return true;
    };
    if(!attach()){
      // If #stands not yet present, observe the document until it appears
      const boot = new MutationObserver(()=>{
        if(attach()){
          boot.disconnect();
        }
      });
      boot.observe(document.documentElement, {childList:true, subtree:true});
      window.__standGuardBoot = boot;
    }
  })();

  // Periodic safety net
  setInterval(restoreIfMissing, 3000);
})();
</script>
<script>
(function(){
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const overlay = $('#bgOverlay');
  if(!overlay) return;
  const title = $('#bgTitle', overlay);
  const grid = $('#bgGrid', overlay);
  const ped = $('#pedestalPage', overlay);
  const tabs = overlay.querySelectorAll('.bg-tab');

  function setActive(which){
    if(which === 'bg'){
      title.textContent = 'Backgrounds';
      grid.style.display = '';
      ped.style.display = 'none';
    }else{
      title.textContent = 'PEDESTALS';
      grid.style.display = 'none';
      ped.style.display = '';
    }
    tabs.forEach(btn => {
      const t = btn.getAttribute('data-target');
      const isActive = (which === 'bg' && t === 'bgGrid') || (which === 'ped' && t === 'pedestalPage');
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-selected', isActive ? 'true':'false');
    });
  }

  tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      setActive(btn.dataset.target === 'bgGrid' ? 'bg' : 'ped');
    });
  });

  // When opening from the main button, default to Backgrounds
  const openBtn = document.getElementById('openBgSelector');
  if(openBtn){
    openBtn.addEventListener('click', () => setActive('bg'));
  }

  // Expose small helper in case other code wants to flip
  window.__bg_setActivePage = setActive;
})();
</script>
<style>
/* Strange Pedestal cosmetic (applies to item pedestals only) */
body.strange-pedestals .pedestal{
  background:
    radial-gradient(circle at 28% 32%, rgba(255,255,255,.92) 0 3px, transparent 4px),
    radial-gradient(circle at 62% 68%, rgba(255,255,255,.92) 0 3px, transparent 4px),
    radial-gradient(circle at 78% 40%, rgba(255,255,255,.92) 0 3px, transparent 4px),
    linear-gradient(180deg,#ffd84a,#ff2b2b) !important;
  background-size: 18px 18px, 20px 20px, 22px 22px, auto !important;
  background-blend-mode: screen, screen, screen, normal !important;
  box-shadow: inset 0 6px 0 rgba(255,255,255,.25), 0 10px 0 #8b1a00, 0 14px 20px rgba(0,0,0,.45), 0 0 18px rgba(255,200,0,.45) !important;
}
</style>
<div aria-live="polite" id="toast" role="status"></div>
<!-- Upside Down runtime UI -->
<div aria-live="polite" id="udTimerBadge">5:00</div>
<div id="udSpinOverlay"><div class="spinner"></div></div>
<script>
(function(){
  // --- Persistent progress for Save Hawkins (only progresses while in upside-down) ---
  window.state = window.state || {};
  state.upsideDown = state.upsideDown || { purchases:0, earned:0, hatchedDemo:false, completed:false };

  // Util
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  function hasFourMythicsOnStands(){
    try{
      let n=0;
      (state.stands||[]).forEach(uid=>{
        if(!uid) return;
        const it = state.placed[uid] || (state.inventory||[]).find(x=>x.uid===uid);
        if(it && String(it.rarity).toLowerCase()==='mythic') n++;
      });
      return n>=4;
    }catch(e){return false;}
  }

  // Build the QUESTS tab dynamically so we don't have to hard-edit older files.
  function augmentStrangerOverlay(){
    const ov = $('#strangerOverlay'); if(!ov) return;
    const sheet = ov.querySelector('.sheet'); if(!sheet) return;
    const grid = ov.querySelector('.stranger-grid');
    if(grid && !grid.id) grid.id = 'strangerShopPage';

    // Side tabs
    if(!$('#strangerSideTabs')){
      const tabs = document.createElement('div');
      tabs.id = 'strangerSideTabs';
      tabs.innerHTML = '<button class="st-tab active" data-t="shop">SHOP</button><button class="st-tab" data-t="quests">QUESTS</button>';
      try{ const grid = sheet.querySelector('#strangerShopPage') || sheet.querySelector('.stranger-grid'); if(grid){ sheet.insertBefore(tabs, grid); } else { sheet.appendChild(tabs); } }catch(e){ sheet.appendChild(tabs); }
      tabs.addEventListener('click', (e)=>{
        const b = e.target.closest('.st-tab'); if(!b) return;
        tabs.querySelectorAll('.st-tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const isQ = b.dataset.t==='quests';
        $('#strangerShopPage').style.display = isQ ? 'none':'grid';
        $('#strangerQuestsPage').style.display = isQ ? 'block':'none';
        updateUdQuestUI();
      });
    }
    // Quests page
    if(!$('#strangerQuestsPage')){
      const qp = document.createElement('div');
      qp.id = 'strangerQuestsPage';
      qp.innerHTML = ''
        + '<div class="save-hawkins-title">SAVE HAWKINS</div>'
        + '<div class="ud-quest-wrap">'
        +   '<div class="ud-quest-box">'
        +     '<h4>UPSIDE DOWN QUESTS</h4>'
        +     '<div style="opacity:.85;font-weight:800;margin-bottom:8px">COMPLETE ALL QUESTS IN THE UPSIDE DOWN</div>'
        +     '<div class="ud-q" id="q-purchase"><div class="check"></div><div>Purchase <span id="udQBuyNum">0</span>/15 items in the Item Shop</div></div>'
        +     '<div class="ud-q" id="q-earn"><div class="check"></div><div>Earn <span>$5,000,000,000</span> <span class="meta" id="udQEarntxt"></span></div></div>'
        +     '<div class="ud-q" id="q-demo"><div class="check"></div><div>Hatch a <b>Demodog</b></div></div>'
        +     '<div style="margin-top:10px;font-weight:900;color:#aaffaa">REWARD: ?????</div>'
        +   '</div>'
        +   '<div class="ud-portal">'
        +      '<div class="stack"></div><div class="stack"></div><div class="stack"></div>'
        +      '<button id="enterUpsideDownBtn">ENTER UPSIDE DOWN</button>'
        +      '<div class="ud-note" id="udPortalNote"></div>'
        +   '</div>'
        + '</div>'
        + '<div class="ud-note">UPSIDE DOWN OPENS FOR 5 MINUTES</div>';
      sheet.appendChild(qp);
      // add yellow hanging decorations around portal
      try{
        const portal = qp.querySelector('.ud-portal');
        if(portal && !portal.querySelector('.hangs')){
          const hangs = document.createElement('div');
          hangs.className = 'hangs';
          const positions = [
            ['2%','-6px'],['10%','-10px'],['18%','-8px'],['28%','-12px'],['36%','-10px'],['44%','-14px'],
            ['56%','-10px'],['64%','-8px'],['74%','-10px'],['84%','-8px'],['92%','-6px'],
            ['-8px','10%'],['-8px','22%'],['-8px','34%'],['-8px','46%'],['-8px','58%'],['-8px','70%'],['-8px','82%'],
            ['calc(100% -  -8px)','16%'],['calc(100% -  -8px)','30%'],['calc(100% -  -8px)','44%'],['calc(100% -  -8px)','58%'],['calc(100% -  -8px)','72%']
          ];
          positions.forEach((x,y,i)=>{
            const s = document.createElement('span'); s.className='hang';
            if(i<11){ s.style.left = x; s.style.top = y; }
            else if(i<18){ s.style.left = y; s.style.top = x; s.style.transform = 'rotate(90deg)'; }
            else { s.style.right = ' -8px'; s.style.top = y; s.style.transform = 'rotate(-90deg)'; }
            s.style.animationDelay = (i*0.15)+'s';
            hangs.appendChild(s);
          });
          portal.appendChild(hangs);
        }
      }catch(e){}

      // Button behavior
      qp.querySelector('#enterUpsideDownBtn').addEventListener('click', ()=>{
        if(!hasFourMythicsOnStands()) return;
        // Consume the 4 mythics (fuel)
        try{
          const mythicUIDs = (state.stands||[]).filter(Boolean).filter(uid=>{
            const it = state.placed[uid] || (state.inventory||[]).find(x=>x.uid===uid);
            return it && String(it.rarity).toLowerCase()==='mythic';
          });
          // remove the placed items
          (state.stands||[]).forEach(uid=>{
            const it = uid && (state.placed[uid] || (state.inventory||[]).find(x=>x.uid===uid));
            if(it && String(it.rarity).toLowerCase()==='mythic'){
              if(state.placed[uid]) delete state.placed[uid];
            }
          });
          // clear stands entirely
          state.stands = Array((window.STAND_COUNT||4)).fill(null);
          if(typeof renderStands==='function') renderStands();
          if(typeof recalcEPS==='function') recalcEPS();
          if(typeof save==='function') save();
        }catch(e){}
        startUpsideDown();
      });
    }
    updateUdQuestUI();
  }

  // Update button states & quest checks
  function updateUdQuestUI(){
    try{
      const qp = $('#strangerQuestsPage'); if(!qp) return;
      const p = state.upsideDown || {};
      // Quests progress
      qp.querySelector('#udQBuyNum').textContent = Math.min(15, Number(p.purchases||0));
      const eTxt = '$' + (Math.floor(Number(p.earned||0))).toLocaleString();
      qp.querySelector('#udQEarntxt').textContent = '(' + eTxt + ' earned)';
      qp.querySelector('#q-purchase').classList.toggle('done', Number(p.purchases||0) >= 15);
      qp.querySelector('#q-earn').classList.toggle('done', Number(p.earned||0) >= 5_000_000_000);
      qp.querySelector('#q-demo').classList.toggle('done', !!p.hatchedDemo);

      // Completed?
      const allDone = (Number(p.purchases||0) >= 15) && (Number(p.earned||0) >= 5_000_000_000) && !!p.hatchedDemo;
      if(allDone && !p.completed){
        p.completed = true;
        // Reward: unlock Upside Down background
        state.unlockedBackgrounds = state.unlockedBackgrounds || { default:true };
        state.unlockedBackgrounds.upsidedown = true;
        if(typeof save==='function') save();
        // Hide portal button forever
      }
      // Button state
      const btn = $('#enterUpsideDownBtn');
      const note = $('#udPortalNote');
      if(btn){
        if(document.body.classList.contains('upside-down')){ btn.style.display='none'; return; }
        if((state.upsideDown||{}).completed){
          btn.style.display = 'none';
          note.textContent = 'Portal fully closed.';
        }else{
          btn.style.display = 'inline-block';
          btn.disabled = !hasFourMythicsOnStands();
          note.textContent = btn.disabled ? 'Place 4 MYTHICS on the pedestals to open the portal.' : 'Use your 4 MYTHICS as fuel to open the portal.';
        }
      }
    }catch(e){}
  }

  // Enter/Exit logic
  let udEndAt = 0, udTimer = null, earnPoll = null, moneyPrev = 0;

  function applyUpsideDownUI(on){
    document.body.classList.toggle('upside-down', !!on);
    const tBadge = $('#udTimerBadge');
    if(on){
      // swap icons
      try{
        const gear = $('#toolsBtn img'); if(gear) gear.src = 'icons/red_gear.png';
      }catch(e){}
      try{
        const forge = $('#forgeOpenBtn img'); if(forge) forge.src = 'icons/red_forge.png';
      }catch(e){}
      if(tBadge){ tBadge.style.display='block'; }
      try{ const btn=document.getElementById('enterUpsideDownBtn'); if(btn) btn.style.display='none'; }catch(e){}
      document.body.classList.add('ud-default-bg');
      window.__UD_LOCK_BG = true;
      const bgs = document.getElementById('openBgSelector'); if(bgs){ bgs.setAttribute('aria-disabled','true'); }
    }else{
      // restore
      try{
        const gear = $('#toolsBtn img'); if(gear) gear.src = 'icons/gear_shop_icon.png';
      }catch(e){}
      try{
        const forge = $('#forgeOpenBtn img'); if(forge) forge.src = 'icons/forge_icon.png';
      }catch(e){}
      if(tBadge){ tBadge.style.display='none'; }
      try{ const btn=document.getElementById('enterUpsideDownBtn'); if(btn) btn.style.display=''; }catch(e){}
      try{ updateUdQuestUI && updateUdQuestUI(); }catch(e){}
      document.body.classList.remove('ud-default-bg');
      window.__UD_LOCK_BG = false;
      const bgs2 = document.getElementById('openBgSelector'); if(bgs2){ bgs2.removeAttribute('aria-disabled'); }
    }
  }

  function startUpsideDown(){
    if((state.upsideDown||{}).completed) return;
    // spinner
    const spin = $('#udSpinOverlay'); if(spin){ spin.style.display='grid'; }
    // flip whole page
    try{ document.body.classList.add('ud-flip'); setTimeout(()=>document.body.classList.remove('ud-flip'), 950); }catch(e){}
    setTimeout(()=>{
      if(spin){ spin.style.display='none'; }
      // Activate
      udEndAt = Date.now() + 5*60*1000;
      moneyPrev = Number(state.money||0);
      applyUpsideDownUI(true);
      // Timer update loop
      updateTimer();
      udTimer = setInterval(updateTimer, 250);
      // Earnings poller (no code injection into tick required)
      earnPoll = setInterval(()=>{
        try{
          if(!document.body.classList.contains('upside-down')) return;
          const m = Number(state.money||0);
          const delta = m - moneyPrev;
          if(delta > 0){
            state.upsideDown.earned = Number(state.upsideDown.earned||0) + delta;
            moneyPrev = m;
            updateUdQuestUI();
            window.__saveHawkinsProgress && window.__saveHawkinsProgress();
          }else{
            moneyPrev = m;
          }
        }catch(e){}
      }, 300);
    }, 900); // brief spin
  }

  function updateTimer(){
    const el = $('#udTimerBadge'); if(!el) return;
    const left = Math.max(0, udEndAt - Date.now());
    const s = Math.floor(left/1000), m = Math.floor(s/60), sec = s%60;
    el.textContent = m + ':' + String(sec).padStart(2,'0');
    if(left <= 0){
      exitUpsideDown();
    }
  }

  function exitUpsideDown(){
    if(udTimer){ clearInterval(udTimer); udTimer=null; }
    if(earnPoll){ clearInterval(earnPoll); earnPoll=null; }
    udEndAt = 0;
    applyUpsideDownUI(false);
  }

  // Shop purchase hook: after renderShop runs, attach listeners for counting purchases
  (function hookRenderShop(){
    const orig = window.renderShop;
    window.renderShop = function(){
      try{ if(typeof orig==='function') orig.apply(this, arguments); }catch(e){}
      try{
        $$('#shopGrid .buy').forEach(btn=>{
          if(btn.__udHooked) return;
          btn.__udHooked = true;
          btn.addEventListener('click', ()=>{
            // If we're in upside down, wait a tick, then check if the button turned into Purchased!
            setTimeout(()=>{
              try{
                if(document.body.classList.contains('upside-down')){
                  const ok = btn.disabled || /Purchased/i.test(btn.textContent);
                  if(ok){
                    state.upsideDown.purchases = Number(state.upsideDown.purchases||0) + 1;
                    updateUdQuestUI();
                    window.__saveHawkinsProgress && window.__saveHawkinsProgress();
                  }
                }
              }catch(e){}
            }, 100);
          });
        });
      }catch(e){}
    };
  })();

  // Pet hatch hook called from patched checkPetHatches()
  window.__udOnPetHatch = function(petObj){
    try{
      if(document.body.classList.contains('upside-down')){
        const n = String((petObj && (petObj.petType || petObj.name)) || '').toLowerCase();
        if(n === 'demodog'){
          state.upsideDown.hatchedDemo = true;
          updateUdQuestUI();
          window.__saveHawkinsProgress && window.__saveHawkinsProgress();
        }
      }
    }catch(e){}
  };

  // Extend Backgrounds overlay with Upside Down reward tile
  (function extendBgGridForUpsideDown(){
    const render = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if(typeof render === 'function') render();
      try{
        const g = document.getElementById('bgGrid'); if(!g) return;
        if(!g.querySelector('[data-upsidedownbg]')){
          const el = document.createElement('div');
          el.setAttribute('data-upsidedownbg','1');
          el.className = 'bg-tile' + (!((state.unlockedBackgrounds||{}).upsidedown)?' locked':'');
          el.style.cssText = "background:url('background_files/stranger_things_quests_style.png') center/cover no-repeat;border-color:#300307;";
          el.innerHTML = '<div style=\"font-weight:900;text-shadow:0 2px 0 #000\">Upside Down</div>'
            + '<button class=\"buy bg-apply\" '+(!((state.unlockedBackgrounds||{}).upsidedown)?'disabled':'')+'>Apply</button>';
          el.querySelector('.bg-apply').onclick = function(){
            if(!((state.unlockedBackgrounds||{}).upsidedown)) return;
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-legendary','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-crypto','bg-dodger','redblue','bg-hawkins','bg-sunrise');
            document.body.style.background = '';
            document.body.classList.add('bg-upsidedown');
            try{ state.selectedBackground = 'upsidedown'; }catch(e){}
            try{ save(); }catch(e){}
          };
          g.appendChild(el);
        }else{
          const el = g.querySelector('[data-upsidedownbg]');
          el.classList.toggle('locked', !((state.unlockedBackgrounds||{}).upsidedown));
          const btn = el.querySelector('.bg-apply'); if(btn) btn.disabled = !((state.unlockedBackgrounds||{}).upsidedown);
        }
      }catch(e){}
    };
  })();

  // Run when the Stranger overlay opens
  document.getElementById('openStranger')?.addEventListener('click', augmentStrangerOverlay);
  // Also patch when overlay is already open via other triggers
  document.getElementById('strangerOverlay')?.addEventListener('transitionend', augmentStrangerOverlay);
  // Ensure once on load (in case overlay auto-opens)
  setTimeout(augmentStrangerOverlay, 1500);

  // --- Live-enable portal button when pedestals change (no refresh needed) ---
  (function hookRenderStandsForUpsideDown(){
    try{
      const orig = window.renderStands;
      if(!orig || orig.__udHooked) return;
      function safeUpdate(){ try{ if(typeof updateUdQuestUI==='function') updateUdQuestUI(); }catch(e){} }
      const wrapped = function(){
        try{ return orig.apply(this, arguments); }
        finally { safeUpdate(); }
      };
      wrapped.__udHooked = true;
      window.renderStands = wrapped;

      // Fallback: observe #stands DOM for changes (in case something edits DOM directly)
      const stands = document.getElementById('stands');
      if(stands && window.MutationObserver){
        const mo = new MutationObserver(()=>safeUpdate());
        try{ mo.observe(stands, { childList:true, subtree:true, attributes:true }); }catch(e){}
        stands.__udObserve = mo;
      }
    }catch(e){}
  })();

  // Clean up on reload (refresh/tab close -> back to normal)
  window.addEventListener('beforeunload', ()=>{ try{ applyUpsideDownUI(false); }catch(e){} });
})();
</script>
<script>
// Minimal helper to trigger a save when quests progress changes

<script>
// Immediate local backup to prevent progress loss on refresh/navigation.
// Updates only the Upside Down quest portion and timestamp, merging with existing backup.
window.__backupNow = function(){
  try{
    const __nowTs = Date.now();
    const raw = localStorage.getItem(LOCAL_BACKUP_KEY);
    let cur = null;
    if (raw) {
      try {
        const o = JSON.parse(raw);
        cur = (o && o.data) ? o.data : null;
      } catch(e){ cur = null; }
    }
    if (!cur || typeof cur !== 'object') cur = {};
    // Ensure we don't blow away unrelated state: only update upsideDown + ts
    cur.upsideDown = (window.state && state.upsideDown) ? {
      purchases: Number(state.upsideDown.purchases||0),
      earned: Number(state.upsideDown.earned||0),
      hatchedDemo: !!state.upsideDown.hatchedDemo,
      completed: !!state.upsideDown.completed
    } : (cur.upsideDown || { purchases:0, earned:0, hatchedDemo:false, completed:false });
    cur.__ts = __nowTs;
    // Maintain previous snapshot for safety
    try{
      const curRaw = localStorage.getItem(LOCAL_BACKUP_KEY);
      if(curRaw){ localStorage.setItem(LOCAL_BACKUP_PREV, curRaw); }
    }catch(e){}
    localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify({ ts: __nowTs, data: cur }));
  }catch(e){}
};
</script>
<script>
window.__saveHawkinsProgress = function(){
  try { window.__backupNow && window.__backupNow(); } catch(e) {}
  try { window.__addonSave && __addonSave(); } catch(e) {}
  try { typeof save==='function' && save(); } catch(e) {}
};
</script>
<script>
(function(){
  const _applyBG = window.applyBG;
  window.applyBG = function(name){
    if(document.body.classList.contains('upside-down')){ return; }
    return typeof _applyBG === 'function' ? _applyBG.apply(this, arguments) : undefined;
  };
})();
</script>

<!-- v138.1 Pedestal hardening & auto-repair -->
<script>
(function(){
  try {
    // 1) Safe RARITY: provide a fallback entry so rendering never crashes on missing/unknown rarities (e.g., pets/eggs).
    if (window.RARITY && !window.__rarityHardened) {
      const base = window.RARITY;
      const FALLBACK = { label:'PET', color:'#9aa', income:0, price:[0,0], prob:0 };
      window.RARITY = new Proxy(base, {
        get(t, p) {
          try {
            return (p in t) ? t[p] : FALLBACK;
          } catch (e) {
            return FALLBACK;
          }
        }
      });
      window.__rarityHardened = true;
    }
  } catch(e) { /* no-op */ }

  // 2) Auto-repair: keep stands consistent and move invalid entries back to inventory.
  function sanitizeStands() {
    try {
      if (!window.state) return;
      if (!Array.isArray(state.stands)) state.stands = Array((window.STAND_COUNT||4)).fill(null);
      if (!state.placed) state.placed = {};
      if (!Array.isArray(state.inventory)) state.inventory = [];

      let changed = false;

      // Fix main stands: only items with a known rarity belong here
      for (let i=0; i<state.stands.length; i++) {
        const uid = state.stands[i];
        if (!uid) continue;
        const it = state.placed[uid] || state.inventory.find(x => x && x.uid === uid);
        if (!it) { state.stands[i] = null; changed = true; continue; }

        const rkey = String(it.rarity || '').toLowerCase();
        const isValidItem = !!rkey && !!(window.RARITY && RARITY[rkey] && typeof RARITY[rkey].income !== 'undefined');
        const isPetOrEgg = (!!it.isEgg) || (!!it.petType);

        if (!isValidItem || isPetOrEgg) {
          // Return anything invalid (e.g., pets/eggs) to inventory
          try { if (state.placed[uid]) delete state.placed[uid]; } catch(e){}
          try { if (!state.inventory.find(x => x && x.uid === (it.uid||uid))) state.inventory.push(it); } catch(e){}
          state.stands[i] = null;
          changed = true;
        }
      }

      // Fix pet pedestals: only eggs/pets belong here
      if (Array.isArray(state.petStands)) {
        for (let j=0; j<state.petStands.length; j++) {
          const p = state.petStands[j];
          if (!p) continue;
          const isPetOrEgg = (!!p.isEgg) || (!!p.petType);
          if (!isPetOrEgg) {
            try { state.inventory.push(p); } catch(e){}
            state.petStands[j] = null;
            if (state.petTimers) try { delete state.petTimers[j]; } catch(e){}
            changed = true;
          }
        }
      }

      if (changed) {
        try { if (typeof recalcEPS === 'function') recalcEPS(); } catch(e){}
        try { if (typeof renderInventory === 'function') renderInventory(); } catch(e){}
        try { if (typeof renderStands === 'function') renderStands(); } catch(e){}
        try { if (typeof save === 'function') save(); } catch(e){}
      }
    } catch(e) { /* swallow */ }
  }

  // 3) Place-guard: prevent placing pets/eggs on main pedestals without disturbing existing logic.
  //    We intercept clicks on stands in the capture phase and enforce "items only".
  function interceptMainStandClicks(){
    document.addEventListener('click', function(ev){
      const stand = ev.target && ev.target.closest && ev.target.closest('.stands .stand');
      if (!stand) return;
      // Identify index of the stand box
      const parent = stand.parentNode;
      if (!parent) return;
      const i = Array.prototype.indexOf.call(parent.children, stand);
      if (i < 0) return;

      // If nothing is selected, let original handler run (removal) by not blocking
      if (!window.state || !state.selectedItemUid) return;

      const sel = (state.inventory||[]).find(it => it && it.uid === state.selectedItemUid);
      if (!sel) return;

      const rkey = String(sel.rarity || '').toLowerCase();
      const isItem = !!rkey && !!(window.RARITY && RARITY[rkey] && typeof RARITY[rkey].income !== 'undefined');
      const isPetOrEgg = (!!sel.isEgg) || (!!sel.petType);

      if (!isItem || isPetOrEgg) {
        // Block the original place logic and route the player to pet pedestals
        ev.stopImmediatePropagation();
        ev.preventDefault();
        try { if (typeof banner === 'function') banner('Use the PET pedestals for pets/eggs.'); } catch(e){}
      }
      // else: let the original handler run
    }, true); // capture=true
  }

  // Run once the DOM is ready and also on load (covers slow CSS/asset scenarios)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){ try{ sanitizeStands(); interceptMainStandClicks(); }catch(e){} });
  } else {
    try{ sanitizeStands(); interceptMainStandClicks(); }catch(e){}
  }
  window.addEventListener('load', function(){ setTimeout(function(){ try{ sanitizeStands(); }catch(e){} }, 50); });
  // Periodic safety (handles rare mid-session corruption on very large accounts)
  setInterval(function(){ try{ sanitizeStands(); }catch(e){} }, 5000);
})();
</script>

<!-- v138.2 Pedestal auto-repair + normalization -->
<script>
(function(){
  'use strict';
  // Fallback rarity object used only when we can't resolve to a known key
  var __FALLBACK_RARITY = { label:'COMMON', color:'var(--c-common)', income:0, price:[0,0], prob:0 };

  // Normalize a single item: ensure a valid, lowercase rarity key
  function normItem(it){
    try{
      if(!it || typeof it !== 'object') return;
      // Pets/eggs can have any "rarity"; we just make sure it's a known key for UI stability
      if(typeof it.rarity !== 'string') it.rarity = 'common';
      var key = String(it.rarity||'common').toLowerCase();
      if(!window.RARITY || !RARITY[key]) key = 'common';
      it.rarity = key;
      // Ensure a uid
      if(!it.uid) it.uid = Math.random().toString(36).slice(2)+Date.now().toString(36);
    }catch(e){}
  }

  function isPetLike(it){
    return !!(it && (it.isEgg || it.petType));
  }

  // Auto-repair all major collections so renderers never crash on big/legacy accounts
  function sanitizeAll(){
    try{
      if(!window.state) window.state = {};
      var n = (typeof window.STAND_COUNT==='number' && STAND_COUNT>0) ? STAND_COUNT : 4;
      if(!Array.isArray(state.stands)) state.stands = Array(n).fill(null);
      while(state.stands.length<n) state.stands.push(null);
      if(state.stands.length>n) state.stands.length = n;

      if(!Array.isArray(state.inventory)) state.inventory = [];
      if(!state.placed || typeof state.placed!=='object') state.placed = {};

      // Normalize everything up-front
      try{ state.inventory.forEach(normItem); }catch(e){}
      try{ Object.keys(state.placed).forEach(function(u){ normItem(state.placed[u]); }); }catch(e){}

      var changed = false;

      // Ensure each stand points to a valid placed item (move from inventory if needed)
      for(var i=0;i<state.stands.length;i++){
        var uid = state.stands[i];
        if(!uid){ continue; }
        var it = state.placed[uid];
        if(!it){
          // Maybe it's still in inventory â€” adopt it into placed
          var idx = -1;
          for(var k=0;k<state.inventory.length;k++){
            if(state.inventory[k] && state.inventory[k].uid===uid){ idx=k; break; }
          }
          if(idx>=0){
            it = state.inventory[idx];
            state.placed[uid] = it;
            // keep it in inventory until placed by the real handler? No, remove to avoid dupes
            state.inventory.splice(idx,1);
            changed = true;
          }
        }
        // After adoption, if still missing OR item belongs to pet pedestals â†’ return to inventory
        if(!it || isPetLike(it)){
          if(it && !state.inventory.find(function(x){return x && x.uid===it.uid;})){
            state.inventory.push(it);
          }
          state.stands[i] = null;
          try{ delete state.placed[uid]; }catch(e){}
          changed = true;
        }else{
          // Final safety: normalize rarity in case old saves had uppercase keys
          var before = it.rarity;
          normItem(it);
          if(before!==it.rarity) changed = true;
        }
      }

      // Pet pedestals: must contain pet-like objects; wrong things go back to inventory
      if(!Array.isArray(state.petStands)) state.petStands = [null,null];
      for(var j=0;j<state.petStands.length;j++){
        var p = state.petStands[j];
        if(!p) continue;
        if(!isPetLike(p)){
          state.inventory.push(p);
          state.petStands[j] = null;
          if(state.petTimers) try{ delete state.petTimers[j]; }catch(e){}
          changed = true;
        }else{
          normItem(p); // normalize rarity/key too for UI
        }
      }

      if(changed){
        try{ if(typeof recalcEPS==='function') recalcEPS(); }catch(e){}
        try{ if(typeof renderInventory==='function') renderInventory(); }catch(e){}
        try{ if(typeof renderStands==='function') renderStands(); }catch(e){}
        try{ if(typeof save==='function') save(); }catch(e){}
      }
    }catch(e){}
  }

  // Guard clicks on MAIN pedestals to allow only items (not pets/eggs)
  function interceptMainStandClicks(){
    document.addEventListener('click', function(ev){
      var stand = ev.target && ev.target.closest && ev.target.closest('#stands .stand');
      if(!stand) return;

      // Find stand index
      var parent = stand.parentNode;
      if(!parent) return;
      var idx = Array.prototype.indexOf.call(parent.children, stand);
      if(idx<0) return;

      if(!window.state || !state.selectedItemUid) return; // let original handler remove if no selection

      // Lookup selected object from inventory
      var sel = null;
      for(var i=0;i<(state.inventory||[]).length;i++){
        var it = state.inventory[i];
        if(it && it.uid===state.selectedItemUid){ sel = it; break; }
      }
      if(!sel) return;

      if(isPetLike(sel)){
        ev.stopImmediatePropagation();
        ev.preventDefault();
        try{ if(typeof banner==='function') banner('Use the PET pedestals for pets/eggs.'); }catch(e){}
        return;
      }
      // Normalize rarity of the selected item before place handler runs,
      // so expressions like RARITY[sel.rarity] always resolve.
      normItem(sel);
    }, true); // capture phase
  }

  // Run when DOM is ready; also re-run periodically for big accounts
  function boot(){
    try{ sanitizeAll(); }catch(e){}
    try{ interceptMainStandClicks(); }catch(e){}
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot, {once:true}); }
  else { boot(); }
  window.addEventListener('load', function(){ setTimeout(function(){ try{ sanitizeAll(); }catch(e){} }, 60); });
  setInterval(function(){ try{ sanitizeAll(); }catch(e){} }, 5000);
})();
</script>

<style id="dragdrop-styles">
  #dragGhost{
    position:fixed; left:0; top:0;
    width:96px; height:96px;
    border-radius:16px;
    pointer-events:none; z-index:10000;
    display:grid; place-items:center;
    box-shadow:0 14px 30px rgba(0,0,0,.35);
    background:rgba(0,0,0,.20);
    backdrop-filter: blur(4px) saturate(120%);
  }
  #dragGhost img{ width:80px; height:80px; border-radius:14px; display:block; }
  #dragGhost .label{ position:absolute; bottom:-18px; left:0; right:0; text-align:center; font-weight:800; font-size:12px; color:#fff; text-shadow:0 1px 0 #000; }
  body.dragging { cursor:grabbing; }
  .drag-target{ outline: 4px dashed #ffd24a; outline-offset: 4px; }
</style>


<script id="dragdrop-logic">
(function(){
  const $ = s => document.querySelector(s);

  let drag = null;
  let active = false;
  let lastTarget = null;

  function getItemByUid(uid){
    try{
      uid = String(uid);
      const inv = (window.state && state.inventory) ? state.inventory : [];
      for(let i=0;i<inv.length;i++){ if(inv[i] && String(inv[i].uid)===uid) return inv[i]; }
    }catch(e){}
    return null;
  }

  function startDragFromSlot(slotEl, startEv){
    if(!slotEl) return;
    if(slotEl.querySelector('.del-x')){
      // If user grabbed the tiny delete button, don't initiate drag.
      const rect = slotEl.querySelector('.del-x').getBoundingClientRect();
      const x = startEv.clientX, y = startEv.clientY;
      if(x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) return;
    }
    const uid = slotEl.getAttribute('data-uid');
    if(!uid) return;
    const item = getItemByUid(uid);
    if(!item) return;

    drag = { uid: String(uid), item, origin: slotEl, ghost:null };
    // Create ghost
    const g = document.createElement('div');
    g.id = 'dragGhost';
    const label = (item.name || item.petType || item.eggType || 'Item');
    const imgSrc = item.svg || '';
    g.innerHTML = '<img src="'+imgSrc+'" alt="'+label+'"/><div class="label">'+label+'</div>';
    document.body.appendChild(g);
    drag.ghost = g;
    document.body.classList.add('dragging');
  }

  function updateHoverHighlight(x, y){
    const el = document.elementFromPoint(x, y);
    const t = el ? el.closest('.forge-slot, #stands .stand, .pet-row .pet-stand') : null;
    if(lastTarget && lastTarget !== t){ try{ lastTarget.classList.remove('drag-target'); }catch(e){} }
    if(t && t !== lastTarget){ try{ t.classList.add('drag-target'); }catch(e){} }
    lastTarget = t || null;
  }

  function moveGhost(x, y){
    if(drag && drag.ghost){
      drag.ghost.style.transform = 'translate(' + (x - 48) + 'px,' + (y - 48) + 'px)';
      updateHoverHighlight(x, y);
    }
  }

  function cleanup(){
    if(lastTarget){ try{ lastTarget.classList.remove('drag-target'); }catch(e){} lastTarget=null; }
    document.body.classList.remove('dragging');
    if(drag && drag.ghost && drag.ghost.parentNode) drag.ghost.parentNode.removeChild(drag.ghost);
    drag = null;
  }

  function dropAt(clientX, clientY){
    const el = document.elementFromPoint(clientX, clientY);
    const target = el ? el.closest('.forge-slot, #stands .stand, .pet-row .pet-stand') : null;
    if(!drag){ cleanup(); return; }

    if(target){
      const prevSel = state.selectedItemUid;
      state.selectedItemUid = drag.uid;

      // Simulate a click on the existing handlers â€” they already do all the swapping logic.
      target.click();

      // Clear selection to match the usual UX after placing
      state.selectedItemUid = null;

      // Renders are handled by the original handler, but just in case:
      try{ if(typeof renderInventory==='function') renderInventory(); }catch(e){}
      try{ if(typeof renderStands==='function') renderStands(); }catch(e){}
    }
    // If target is null, we simply do nothing: item remains in original slot (auto-revert).
    cleanup();
  }

  // Delegated pointer events
  document.addEventListener('pointerdown', (e)=>{
    const slot = e.target && e.target.closest && e.target.closest('#inventory .slot');
    if(!slot) return;
    if(e.button !== 0) return;
    e.preventDefault();
    active = true;
    startDragFromSlot(slot, e);
    moveGhost(e.clientX, e.clientY);
  });

  document.addEventListener('pointermove', (e)=>{
    if(!active || !drag) return;
    moveGhost(e.clientX, e.clientY);
  });

  document.addEventListener('pointerup', (e)=>{
    if(!active) return;
    active = false;
    dropAt(e.clientX, e.clientY);
  });
  document.addEventListener('pointercancel', ()=>{ active=false; cleanup(); });

  // Ensure slots have data-uid after each render
  const __ri = window.renderInventory;
  if(typeof __ri === 'function'){
    window.renderInventory = function(){
      const r = __ri.apply(this, arguments);
      try{
        const slots = document.querySelectorAll('#inventory .slot');
        const inv = (state && state.inventory) ? state.inventory : [];
        slots.forEach((el, i)=>{
          const it = inv[i];
          if(it && !el.getAttribute('data-uid')) el.setAttribute('data-uid', String(it.uid||''));
        });
      }catch(e){}
      return r;
    };
  }
})();
</script>


<!-- Injected Winter Gifts (from AGUK v10) start -->
<!-- ========= WINTER GIFTS EVENT (revised button placement) ========= -->
<style>
  .icon-winter{position:relative;display:grid;place-items:center;background:#185a7a;overflow:hidden;width:72px;height:72px;border-radius:18px;border:4px solid rgba(0,0,0,.35);box-shadow:0 6px 16px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.06);}
  .icon-winter::after{content:'';position:absolute;inset:0;background-image:url('icons/winter_gifts_icon.png');background-repeat:no-repeat;background-position:center;background-size:64% 64%;filter:drop-shadow(0 2px 6px rgba(0,0,0,.4));}
  .rar.t-jolly{background:linear-gradient(135deg,#e50039,#0fbf65);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 10px rgba(255,255,255,.85),0 0 18px rgba(21,255,126,.55)}
  #winterOverlay{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:80}
  #winterOverlay.show{display:flex}
  #winterOverlay .sheet{width:min(980px,96vw);max-height:90vh;overflow:auto;border-radius:26px;border:5px solid #8fe7ff;background:linear-gradient(180deg,#eaffff,#bff0ff 45%,#a9e4ff 75%);box-shadow:0 18px 50px rgba(0,90,120,.35);padding:18px;color:#06364f;position:relative;}
  #winterOverlay h2{font-family:'Russo One';margin:8px 0 6px;color:#0a76a8;text-align:center;text-shadow:0 1px 0 rgba(255,255,255,.7)}
  #closeWinter{position:absolute;right:12px;top:8px;font-size:24px;background:#0b5068;color:#fff;border:none;border-radius:14px;width:44px;height:44px;cursor:pointer}
  .winter-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:12px 0}
  .gift-card{position:relative;border-radius:18px;border:4px solid #0aa3c4;background:#0c6b88;padding:0;min-height:190px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;box-shadow:0 14px 28px rgba(0,120,160,.25)}
  .gift-card .top{width:100%;height:140px;background:#0c9ec4;border-bottom:4px solid rgba(0,0,0,.25);display:grid;place-items:center;border-top-left-radius:14px;border-top-right-radius:14px}
  .gift-card .top img{image-rendering:auto;width:96px;height:96px}
  .gift-card .label{font-family:'Russo One';font-size:20px;color:#fff;margin-top:6px;text-shadow:0 2px 0 rgba(0,0,0,.35)}
  .gift-card .quest{margin:8px 10px 12px;background:#083a4e;color:#c5f3ff;border:3px solid #0aa3c4;border-radius:12px;padding:8px 10px;width:calc(100% - 26px);font-weight:900;font-size:14px;letter-spacing:.2px}
  .gift-card.locked{filter:grayscale(1) brightness(.75)}
  .gift-card .check{position:absolute;right:10px;top:10px;width:28px;height:28px;border-radius:50%;background:#2ecc71;color:#052;display:none;align-items:center;justify-content:center;font-weight:900}
  .gift-card.claimed .check{display:flex}
  #giftOpenOverlay{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:90}
  #giftOpenOverlay.show{display:flex}
  #giftOpenOverlay .open-card{background:radial-gradient(800px 400px at 50% -160px,#ffffff,#dff6ff);border:6px solid #a5e7ff;border-radius:28px;box-shadow:0 18px 90px rgba(0,0,0,.45);padding:24px;display:grid;place-items:center;min-width:min(680px,94vw);min-height:420px;color:#083a4e;position:relative}
  #giftOpenOverlay img.gift-big{width:220px;height:220px;transition:transform .08s ease;will-change:transform;image-rendering:auto}
  #giftOpenOverlay .tap{margin-top:10px;font-weight:900}
  #giftOpenOverlay .xbtn{position:absolute;right:12px;top:8px;font-size:24px;background:#0b5068;color:#fff;border:none;border-radius:14px;width:44px;height:44px;cursor:pointer;display:none}
  #giftOpenOverlay.opened .xbtn{display:block}
  #giftReward{display:none;text-align:center}
  #giftOpenOverlay.opened #giftReward{display:block}
  #giftOpenOverlay.opened .tap{display:none}
  #blizzard{position:fixed;inset:0;pointer-events:none;display:none;z-index:75}
  #blizzard.show{display:block;pointer-events:auto}
  .snowflake{position:fixed;top:-40px;left:0;width:36px;height:36px;background-image:url('icons/winter_gifts_icon.png');background-size:contain;background-repeat:no-repeat;opacity:.9;cursor:pointer;}
</style>

<div id="winterOverlay" aria-hidden="true" class="overlay">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="winterTitle">
    <button class="closeX" id="closeWinter">âœ•</button>
    <div style="display:flex;justify-content:center;align-items:center;gap:10px;">
      <img src="icons/winter_gifts_icon.png" alt="Winter" style="width:42px;height:42px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,.2);background:#0c6b88">
      <h2 id="winterTitle">WINTER GIFTS</h2>
    </div>
    <div class="winter-grid" id="winterGrid"></div>
    <div style="text-align:center;color:#083a4e;font-weight:900">Complete the quests to open gifts</div>
  </div>
</div>

<div id="giftOpenOverlay" aria-hidden="true">
  <div class="open-card">
    <button class="xbtn" id="giftClose">âœ•</button>
    <img class="gift-big" id="giftBig" src="" alt="Gift">
    <div class="tap" id="giftTap">Tap to openâ€¦</div>
    <div id="giftReward"></div>
  </div>
</div>

<div id="blizzard"></div>

<script>
(function(){
  /* === state & rarity === */
  window.state = window.state || {};
  state.winterGifts = state.winterGifts || { forge:0, hatch:0, legacyPurchases:0, uniquePurchases:0, gift:{}, blizzardActive:false };
  try{ window.RARITY = window.RARITY || {}; if(!RARITY.jolly){ RARITY.jolly = { label:'JOLLY', color:'#0fbf65', income:45000, price:[0,0], prob:0 }; } }catch(e){}

  /* === Button placement: next to Stranger button (upper-left) === */
  function addWinterButton(){
    const stranger = document.getElementById('openStranger');
    const row = document.querySelector('.event-row') || document.getElementById('eventRow');
    const rowVisible = row && getComputedStyle(row).display !== 'none';
    if(rowVisible){
      // Put our button right after Stranger in the row
      if(!document.getElementById('openWinterGifts')){
        const btn = document.createElement('button');
        btn.className = 'icon-btn icon-winter'; btn.id = 'openWinterGifts'; btn.title = 'Winter Gifts';
        row.appendChild(btn);
        btn.addEventListener('click', openWinterOverlay);
      }
    }else{
      // Fallback: fixed position next to Stranger's fixed left/top
      if(!document.getElementById('openWinterGifts')){
        const b = document.createElement('button');
        b.className = 'icon-winter'; b.id = 'openWinterGifts'; b.title = 'Winter Gifts';
        const s = stranger;
        const sLeft = s ? parseInt((s.style.left||'16px'),10) : 16;
        const sTop  = s ? parseInt((s.style.top||'28px'),10) : 28;
        const gap = 12, size = 72;
        b.style.position='fixed'; b.style.left = (sLeft + size + gap) + 'px'; b.style.top = sTop + 'px'; b.style.zIndex='20';
        document.body.appendChild(b);
        b.addEventListener('click', openWinterOverlay);
      }
    }
  }

  /* === Page === */
  const gifts = [
    { id:'g1', img:'icons/gifts/gift_1.png', label:'GIFT 1', quest:()=>`Quest: forge 3 times ( ${state.winterGifts.forge||0} / 3 )`, ready:()=> (state.winterGifts.forge||0) >= 3, reward: gift1Reward },
    { id:'g2', img:'icons/gifts/gift_2.png', label:'GIFT 2', quest:()=>`Quest: hatch 10 pets ( ${state.winterGifts.hatch||0} / 10 )`, ready:()=> (state.winterGifts.hatch||0) >= 10, reward: gift2Reward },
    { id:'g3', img:'icons/gifts/gift_3.png', label:'GIFT 3', quest:()=>`Quest: purchase 4 legacy items ( ${state.winterGifts.legacyPurchases||0} / 4 )`, ready:()=> (state.winterGifts.legacyPurchases||0) >= 4, reward: gift3Reward },
    { id:'g4', img:'icons/gifts/gift_4.png', label:'GIFT 4', quest:()=>`Quest: purchase 8 unique items ( ${state.winterGifts.uniquePurchases||0} / 8 )`, ready:()=> (state.winterGifts.uniquePurchases||0) >= 8, reward: gift4Reward },
    { id:'g5', img:'icons/gifts/gift_5.png', label:'GIFT 5', quest:()=>`Quest: hatch a Golden Dog`, ready:()=> !!state.winterGifts.hatchedGoldDog, reward: gift5Reward },
    { id:'g6', img:'icons/gifts/gift_6.png', label:'GIFT 6', quest:()=>`Quest: own 45 rare items ( ${countRares()} / 45 )`, ready:()=> countRares() >= 45, reward: gift6Reward },
  ];

  function fmt(n){ try{return (n||0).toLocaleString();}catch(e){return String(n);} }
  function countRares(){ try{ const all=(state.inventory||[]).concat(Object.values(state.placed||{})); return all.filter(x=>String(x.rarity).toLowerCase()==='rare').length; }catch(e){ return 0; } }

  function openWinterOverlay(){ const o=document.getElementById('winterOverlay'); renderWinterGrid(); o.classList.add('show'); o.setAttribute('aria-hidden','false'); }
  function closeWinterOverlay(){ const o=document.getElementById('winterOverlay'); o.classList.remove('show'); o.setAttribute('aria-hidden','true'); }
  document.getElementById('closeWinter').addEventListener('click', closeWinterOverlay);

  function renderWinterGrid(){
    const g = document.getElementById('winterGrid'); if(!g) return; g.innerHTML='';
    gifts.forEach(gf=>{
      const card = document.createElement('div'); card.className='gift-card';
      if(state.winterGifts.gift[gf.id]==='claimed') card.classList.add('claimed');
      const ready = gf.ready(); if(!ready) card.classList.add('locked');
      card.innerHTML = '<div class="top"><img src="'+gf.img+'" alt="gift"></div>'
                     + '<div class="label">'+gf.label+'</div>'
                     + '<div class="quest">'+gf.quest()+'</div>'
                     + '<div class="check">âœ“</div>';
      card.addEventListener('click', ()=>{ if(ready && state.winterGifts.gift[gf.id]!=='claimed'){ startGiftOpen(gf); } });
      g.appendChild(card);
    });
  }

  let openingGift=null, openClicks=0;
  function startGiftOpen(gf){
    openingGift = gf; openClicks = 0;
    const ov = document.getElementById('giftOpenOverlay');
    document.getElementById('giftBig').src = gf.img;
    document.getElementById('giftReward').innerHTML = '';
    ov.classList.remove('opened'); ov.classList.add('show');
    const big = document.getElementById('giftBig');
    function tap(){ if(!openingGift) return; openClicks++; big.style.transform = 'scale('+(1 + openClicks*0.03)+') rotate('+(Math.random()*2-1)+'deg)'; if(openClicks>=12){ finishOpen(); big.removeEventListener('click', tap);} }
    big.addEventListener('click', tap);
    document.getElementById('giftTap').textContent = 'Tap the gift to open!';
  }
  function finishOpen(){
    const ov = document.getElementById('giftOpenOverlay');
    ov.classList.add('opened');
    try{ if(openingGift && typeof openingGift.reward==='function'){ openingGift.reward(); } }catch(e){}
    document.getElementById('giftClose').onclick = ()=>{ ov.classList.remove('show','opened'); openingGift=null; renderWinterGrid(); };
  }
  document.getElementById('giftClose').addEventListener('click', ()=>{ const ov=document.getElementById('giftOpenOverlay'); ov.classList.remove('show','opened'); openingGift=null; renderWinterGrid(); });

  function pushItem(name, rarity, filePath, eps){
    const it={ uid:(Math.random().toString(36).slice(2)+Date.now().toString(36)), name, rarity, price:0, baseIdx:0, svg:filePath };
    if(eps){ it.price=[0,0]; }
    state.inventory = state.inventory || [];
    state.inventory.push(it); if(typeof renderInventory==='function') renderInventory(); if(typeof recalcEPS==='function') recalcEPS(); if(typeof save==='function') save();
    return it;
  }
  function showReward(html){ const box=document.getElementById('giftReward'); box.innerHTML = html + '<div style="margin-top:10px;font-weight:900">Tap âœ• to close</div>'; }
  function markClaimed(id){ state.winterGifts.gift[id] = 'claimed'; if(typeof save==='function') save(); }

  function gift1Reward(){ const it = pushItem('Candy Cane','jolly','winter_items/candy_cane.png',45000); showReward("<div style='font-size:22px;font-weight:900'>Candy Cane</div><div class='rar t-jolly'>JOLLY Â· +$"+fmt(45000)+" EPS</div><img src='"+it.svg+"' style='width:128px;height:128px;margin-top:12px;border-radius:16px'>"); markClaimed('g1'); }
  function gift2Reward(){ state.pedestalSkins = state.pedestalSkins || { default:true }; state.pedestalSkins.snowy = true; try{ window.__renderPedestalPage && window.__renderPedestalPage(); }catch(e){} showReward("<div style='font-size:22px;font-weight:900'>Snowy Pedestal</div><div>Equip from Backgrounds â†’ Pedestals.</div>"); markClaimed('g2'); }
  function gift3Reward(){ const it = pushItem('Hanukkah Menorah','jolly','winter_items/hanukkah_menorah.png',45000); showReward("<div style='font-size:22px;font-weight:900'>Hanukkah Menorah</div><div class='rar t-jolly'>JOLLY Â· +$"+fmt(45000)+" EPS</div><img src='"+it.svg+"' style='width:128px;height:128px;margin-top:12px;border-radius:16px'>"); markClaimed('g3'); }
  function gift4Reward(){ state.unlockedBackgrounds = state.unlockedBackgrounds || { default:true }; state.unlockedBackgrounds.winter_wonderland = true; try{ window.__renderBgGrid && window.__renderBgGrid(); }catch(e){} showReward("<div style='font-size:22px;font-weight:900'>Winter Wonderland Background</div><div>Apply from Backgrounds.</div><img src='background_files/winter_wonderland.png' style='width:240px;height:auto;margin-top:12px;border-radius:16px'>"); markClaimed('g4'); }
  function gift5Reward(){ const r=Math.random(); const gotAll=(r<0.05); const picks=[]; function add(nm,file){ picks.push(pushItem(nm,'jolly','winter_items/'+file,45000)); } if(gotAll){ add('Item Shop Ornament','item_shop_ornament.png'); add('Gear Shop Ornament','gear_shop_ornament.png'); add('Pet Ornament','pet_ornament.png'); } else if(r<0.45){ add('Item Shop Ornament','item_shop_ornament.png'); } else if(r<0.80){ add('Gear Shop Ornament','gear_shop_ornament.png'); } else { add('Pet Ornament','pet_ornament.png'); } const names=picks.map(p=>p.name).join(', '); showReward("<div style='font-size:22px;font-weight:900'>"+names+"</div><div class='rar t-jolly'>JOLLY Â· +$"+fmt(45000)+" EPS each</div>"); markClaimed('g5'); }
  function gift6Reward(){ const p={ uid:(Math.random().toString(36).slice(2)+Date.now().toString(36)), name:'Snowman', isEgg:false, eggType:null, petType:'Snowman', petEps:30000, svg:'pets/snowman.png' }; state.inventory=state.inventory||[]; state.inventory.push(p); renderInventory && renderInventory(); save && save(); showReward("<div style='font-size:22px;font-weight:900'>Snowman</div><div>Pet Â· +$"+fmt(30000)+" EPS</div><img src='pets/snowman.png' style='width:140px;height:140px;margin-top:12px;border-radius:16px'>"); markClaimed('g6'); maybeStartSnowmanWatcher(); }

  /* === Hook into existing quest mechanics === */
  (function hookForge(){ const check=()=>{ const f=window.doForge; if(typeof f==='function' && !f.__winterWrapped){ window.doForge=function(){ const r=f.apply(this,arguments); try{ state.winterGifts.forge=(state.winterGifts.forge||0)+1; save&&save(); }catch(e){} return r; }; window.doForge.__winterWrapped=true; } else { setTimeout(check,600); } }; check(); })();
  (function hookShop(){ const orig=window.renderShop; window.renderShop=function(){ if(typeof orig==='function') orig.apply(this,arguments); try{ document.querySelectorAll('#shopGrid .buy').forEach(btn=>{ if(btn.__winterHooked) return; btn.__winterHooked=true; btn.addEventListener('click',()=>{ setTimeout(()=>{ try{ const ok=btn.disabled||/Purchased/i.test(btn.textContent); if(!ok) return; const card=btn.closest('.card'); if(!card) return; const tag=card.querySelector('.tag'); if(!tag) return; const cls=Array.from(tag.classList).find(c=>/^t-/.test(c)); const rar=(cls||'').replace('t-',''); if(rar==='legacy'){ state.winterGifts.legacyPurchases=(state.winterGifts.legacyPurchases||0)+1; } if(rar==='unique'){ state.winterGifts.uniquePurchases=(state.winterGifts.uniquePurchases||0)+1; } save&&save(); }catch(e){} },120); }); }); }catch(e){} }; })();
  (function hookPetHatch(){ const prev=window.__udOnPetHatch; window.__udOnPetHatch=function(petObj){ try{ if(typeof prev==='function') prev.apply(this,arguments); }catch(e){} try{ state.winterGifts.hatch=(state.winterGifts.hatch||0)+1; const n=String((petObj&&(petObj.petType||petObj.name))||'').toLowerCase(); if(n.includes('gold')&&n.includes('dog')){ state.winterGifts.hatchedGoldDog=true; } save&&save(); }catch(e){} }; })();

  /* === Background/Pedestal availability rendering === */
  (function extendBg(){ 
  const orig=window.__renderBgGrid; 
  window.__renderBgGrid=function(){ 
    if(typeof orig==='function') orig(); 
    try{ 
      const g=document.getElementById('bgGrid'); 
      if(!g) return; 
      // Add or update the Winter Wonderland tile so it is ALWAYS visible
      let el=g.querySelector('[data-winterbg]');
      if(!el){
        el=document.createElement('div');
        el.setAttribute('data-winterbg','1');
        el.className='bg-tile';
        el.style.cssText='background-image:url("background_files/winter_wonderland.png");background-size:cover;background-position:center;border-color:#8fe7ff;';
        el.innerHTML='<div style="font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)">WINTER WONDERLAND</div><button class="buy bg-apply">Apply</button>';
        g.appendChild(el);
      }
      // lock state if not unlocked yet
      const unlocked = !!((state.unlockedBackgrounds||{}).winter_wonderland);
      el.classList.toggle('locked', !unlocked);
      const btn = el.querySelector('.bg-apply');
      if(btn){
        btn.disabled = !unlocked;
        btn.onclick = function(){
          if(!((state.unlockedBackgrounds||{}).winter_wonderland)) return;
          document.body.classList.remove("bg-green","bg-blue","bg-purple","bg-orange","bg-legacy","bg-unique","bg-exotic","bg-mythic","bg-rainbow","bg-crypto","bg-dodger","bg-dodgerquests","bg-spaceview","redblue","bg-hawkins","bg-sunrise");
          // also remove winter if present before re-adding (to mirror others)
          document.body.classList.remove("bg-winter");
          document.body.style.background='';
          document.body.classList.add('bg-winter');
          state.selectedBackground='winter_wonderland';
          if(typeof save==='function') save();
        };
      }
    }catch(e){} 
  }; 
})(); 
(function extendPed(){ const orig=window.__renderPedestalPage; window.__renderPedestalPage=function(){
    try{
      state = state || {};
      state.pedestalSkins = state.pedestalSkins || { default:true };
      if (typeof state.pedestalSkins.snowy === 'undefined') state.pedestalSkins.snowy = !!state.pedestalSkins.snowy;
      state.selectedPedestalSkin = state.selectedPedestalSkin || 'default';
    }catch(e){} 
     if(typeof orig==='function') orig(); try{ const host=document.getElementById('pedestalPage'); if(!host) return; if(!host.querySelector('[data-snowyped]')){ const grid=host.querySelector('.ped-grid')||host; const el=document.createElement('div'); el.setAttribute('data-snowyped','1'); el.className='ped-tile'+(!(state.pedestalSkins||{}).snowy?' locked':''); el.style.background='linear-gradient(180deg,#ffffff,#dff6ff)'; el.innerHTML='<div style="font-weight:900">Snowy Pedestal</div><button class="buy ped-apply" '+(!((state.pedestalSkins||{}).snowy)?'disabled':'')+'>Equip</button>'; el.querySelector('.ped-apply').onclick=function(){ if(!((state.pedestalSkins||{}).snowy)) return; state.selectedPedestalSkin='snowy'; document.body.classList.add('snowy-pedestals'); document.body.classList.remove('red-pedestals','aqua-pedestals','strange-pedestals'); save&&save(); }; grid.appendChild(el);} }catch(e){} }; })();
  try{ var st2=document.createElement('style'); st2.textContent = '.snowy-pedestals .pedestal{background:linear-gradient(#f0fbff,#cfeeff);box-shadow:inset 0 6px 0 rgba(255,255,255,.8),inset 0 -6px 0 rgba(0,0,0,.15),0 10px 28px rgba(0,120,160,.25);position:relative} .snowy-pedestals .pedestal::after{content:"";position:absolute;inset:0;background-image:radial-gradient(#fff 1px, transparent 1px);background-size:10px 10px;opacity:.28;border-radius:inherit;pointer-events:none}'; document.head.appendChild(st2);}catch(e){}

  /* === Snowman Blizzard === */
  function isSnowmanPlaced(){ try{ return Object.values(state.petStands||{}).concat(Object.values(state.placed||{})).some(p=>p && !p.isEgg && (String(p.petType||p.name).toLowerCase()==='snowman')); }catch(e){ return false; } }
  let blizTimer=null, flakeTimer=null, blizEnds=0;
  function maybeStartSnowmanWatcher(){ setTimeout(()=>{ try{ if(isSnowmanPlaced()){ scheduleBlizzard(); } }catch(e){} }, 0); }
  function scheduleBlizzard(){ if(blizTimer) clearInterval(blizTimer); blizTimer = setInterval(()=>{ if(!isSnowmanPlaced()) return; if(Math.random() <= 0.05){ startBlizzard(); } }, 15*60*1000); }
  function startBlizzard(){ if(state.winterGifts.blizzardActive) return; state.winterGifts.blizzardActive = true; blizEnds = Date.now() + 90*1000; showBlizzard(); recalcEPS && recalcEPS(); save&&save();
    const t = setInterval(()=>{ if(Date.now()>=blizEnds){ clearInterval(t); endBlizzard(); } }, 500);
  }
  function endBlizzard(){ hideBlizzard(); state.winterGifts.blizzardActive=false; recalcEPS && recalcEPS(); save&&save(); }
  function showBlizzard(){ const layer=document.getElementById('blizzard'); layer.classList.add('show');
    function spawn(){ if(!state.winterGifts.blizzardActive) return; const s=document.createElement('div'); s.className='snowflake'; const x=Math.random()*(window.innerWidth-40); const dur=4000+Math.random()*3000; s.style.left=x+'px'; document.body.appendChild(s); s.style.top='-40px'; let y=-40; const vy=(window.innerHeight+80)/(dur/16); let tick=setInterval(()=>{ y+=vy; s.style.top=y+'px'; if(y>window.innerHeight+60){ clearInterval(tick); s.remove(); } },16); s.addEventListener('click',()=>{ try{ state.money=(state.money||0)+5000000; updateTop && updateTop(); save&&save(); }catch(e){} s.remove(); }); }
    if(flakeTimer) clearInterval(flakeTimer); flakeTimer=setInterval(()=>{ if(!state.winterGifts.blizzardActive){ clearInterval(flakeTimer); return; } for(let i=0;i<4;i++) spawn(); },800);
  }
  function hideBlizzard(){ const layer=document.getElementById('blizzard'); layer.classList.remove('show'); try{ if(flakeTimer) clearInterval(flakeTimer); }catch(e){} document.querySelectorAll('.snowflake').forEach(n=>n.remove()); }
  (function patchMultiplier(){ const orig = window.getActivePedestalMultiplier || function(){return 1}; window.getActivePedestalMultiplier=function(){ const m=orig.apply(this,arguments); return m * (state.winterGifts && state.winterGifts.blizzardActive ? 3 : 1); }; })();

  // Make sure we place the button even if Stranger is injected later
  function tryAdd(){ addWinterButton(); }
  document.addEventListener('DOMContentLoaded', tryAdd);
  new MutationObserver(tryAdd).observe(document.body, {childList:true,subtree:true});
})();
</script>

<!-- ========= WINTER GIFTS PATCH v1.40g (robust forge + persistent claims + snowman blizzard) ========= -->
<script>
(function(){
  const WG_KEY = 'WG_WINTER_GIFTS_V1';

  // ------- Load persisted WG state early
  try{
    const raw = localStorage.getItem(WG_KEY);
    if(raw){
      window.state = window.state || {};
      const dat = JSON.parse(raw);
      state.winterGifts = Object.assign({forge:0,hatch:0,legacyPurchases:0,uniquePurchases:0,gift:{},blizzardActive:false,pendingRewards:[]}, state.winterGifts||{}, dat);
    }
  }catch(e){}

  // ------- Ensure state shape
  window.state = window.state || {};
  state.winterGifts = state.winterGifts || {forge:0,hatch:0,legacyPurchases:0,uniquePurchases:0,gift:{},blizzardActive:false,pendingRewards:[]};

  function saveWG(){ try{ localStorage.setItem(WG_KEY, JSON.stringify(state.winterGifts)); }catch(e){} }

  // Persist any markClaimed calls from the event code
  (function persistMarkClaimed(){
    const orig = window.markClaimed;
    window.markClaimed = function(id){
      try{ state.winterGifts.gift = state.winterGifts.gift || {}; state.winterGifts.gift[id] = 'claimed'; saveWG(); }catch(e){}
      if(typeof orig === 'function'){ try{ return orig.apply(this, arguments); }catch(e){} }
    };
  })();

  // ------- Update Winter overlay live if open
  function refreshWinterIfOpen(){
    const o = document.getElementById('winterOverlay');
    if(o && o.classList.contains('show') && typeof renderWinterGrid==='function'){ try{ renderWinterGrid(); }catch(e){} }
  }

  // ------- Robust FORGE hooking
  (function hookForge(){
    function attachToBtn(){
      const btn = document.getElementById('forgeBtn');
      if(!btn || btn.__wgForgeHooked) return;
      btn.__wgForgeHooked = true;
      btn.addEventListener('click', ()=>{
        const before = JSON.stringify(state.stands)+JSON.stringify(state.placed);
        setTimeout(()=>{
          try{
            // Only count if a mythic is present after click (means forge succeeded)
            const mythicPresent = Object.values(state.placed||{}).some(it=>it && it.rarity === 'mythic');
            if(mythicPresent){
              state.winterGifts.forge = (state.winterGifts.forge||0) + 1;
              saveWG(); save && save();
              refreshWinterIfOpen();
            }
          }catch(e){}
        }, 60);
      }, true);
    }
    // Also wrap createMythicItem for belt-and-suspenders
    function wrapCreate(){
      const f = window.createMythicItem;
      if(typeof f === 'function' && !f.__wgWrapped){
        window.createMythicItem = function(){
          const r = f.apply(this, arguments);
          try{ state.winterGifts.forge = (state.winterGifts.forge||0) + 1; saveWG(); save&&save(); refreshWinterIfOpen(); }catch(e){}
          return r;
        };
        window.createMythicItem.__wgWrapped = true;
      }
    }
    // Try now and keep trying as DOM/script loads
    const poll = setInterval(()=>{ attachToBtn(); wrapCreate(); }, 300);
    document.addEventListener('DOMContentLoaded', ()=>{ attachToBtn(); wrapCreate(); });
  })();

  // ------- Hatch persist (if event added earlier)
  (function rehookHatch(){
    const prev = window.__udOnPetHatch;
    window.__udOnPetHatch = function(petObj){ try{ if(typeof prev==='function') prev.apply(this, arguments); }catch(e){} try{
      state.winterGifts.hatch = (state.winterGifts.hatch||0) + 1;
      const n = String((petObj && (petObj.petType||petObj.name))||'').toLowerCase();
      if(n.includes('gold') && n.includes('dog')) state.winterGifts.hatchedGoldDog = true;
      saveWG(); save&&save(); refreshWinterIfOpen();
    }catch(e){} };
  })();

  // ======== Snowman Blizzard system ========
  function isSnowmanPlaced(){
    try{
      return (state.petStands||[]).some(p=>p && !p.isEgg && String(p.petType||p.name).toLowerCase()==='snowman');
    }catch(e){ return false; }
  }
  let blizTimer=null, flakeTimer=null, blizEnds=0;

  function scheduleBlizzard(){
    if(blizTimer) clearInterval(blizTimer);
    const interval = 15*60*1000;  // fast mode: 15s for testing, otherwise 15 min
    blizTimer = setInterval(()=>{
      if(!isSnowmanPlaced()) return;
      if(Math.random() <= 0.05){ startBlizzard(); }
    }, interval);
  }

  function startBlizzard(){
    if(state.winterGifts.blizzardActive) return;
    state.winterGifts.blizzardActive = true;
    saveWG(); save && save();
    blizEnds = Date.now() + 90*1000;

    // Visual layer
    let layer = document.getElementById('blizzard');
    if(!layer){
      layer = document.createElement('div'); layer.id='blizzard';
      layer.style.cssText = 'position:fixed;inset:0;pointer-events:none;display:none;z-index:75';
      document.body.appendChild(layer);
    }
    layer.classList.add('show'); layer.style.display='block';

    function spawn(){
      if(!state.winterGifts.blizzardActive) return;
      const s = document.createElement('div');
      s.className = 'snowflake';
      s.style.cssText = 'position:fixed;top:-40px;left:0;width:36px;height:36px;background-image:url(icons/winter_gifts_icon.png);background-size:contain;background-repeat:no-repeat;opacity:.9;cursor:pointer;pointer-events:auto;z-index:76;';
      const x = Math.random() * (window.innerWidth - 40);
      const dur = 4000 + Math.random()*3000;
      s.style.left = x + 'px';
      document.body.appendChild(s);
      s.style.top = '-40px';
      let y = -40;
      const vy = (window.innerHeight + 80) / (dur/16);
      const tick = setInterval(()=>{
        y += vy; s.style.top = y + 'px';
        if(y > window.innerHeight + 60){ clearInterval(tick); s.remove(); }
      }, 16);
      s.addEventListener('click', ()=>{
        try{ state.money = (state.money||0) + 5000000; if(typeof updateTop==='function') updateTop(); save && save(); }catch(e){}
        s.remove();
      });
    }
    if(flakeTimer) clearInterval(flakeTimer);
    flakeTimer = setInterval(()=>{ if(!state.winterGifts.blizzardActive){ clearInterval(flakeTimer); return; } for(let i=0;i<4;i++) spawn(); }, 800);

    // Stop timer for the event
    const chk = setInterval(()=>{ if(Date.now() >= blizEnds){ clearInterval(chk); endBlizzard(); } }, 400);
  }

  function endBlizzard(){
    state.winterGifts.blizzardActive = false;
    saveWG(); save && save();
    try{ clearInterval(flakeTimer); }catch(e){}
    document.querySelectorAll('.snowflake').forEach(n=>n.remove());
    const layer = document.getElementById('blizzard');
    if(layer){ layer.classList.remove('show'); layer.style.display='none'; }
  }

  // Multiplier: x3 during blizzard only
  (function patchMultiplier(){
    const orig = window.getActivePedestalMultiplier || function(){ return 1; };
    window.getActivePedestalMultiplier = function(){
      const m = orig.apply(this, arguments);
      return m * (state.winterGifts && state.winterGifts.blizzardActive ? 3 : 1);
    };
  })();

  // Start watcher on load, and whenever pets UI changes
  function ensureWatcher(){ if(isSnowmanPlaced()) scheduleBlizzard(); }
  document.addEventListener('DOMContentLoaded', ensureWatcher);
  new MutationObserver(ensureWatcher).observe(document.body, {childList:true,subtree:true});

  // Optional quick test: press Shift+B to trigger blizzard immediately (handy for QA)
  document.addEventListener('keydown', (e)=>{ if(e.shiftKey && (e.key==='B' || e.key==='b')){ startBlizzard(); } });

})();
</script>

<!-- Injected Winter Gifts end -->

<script>
// Grant +50 XP when a quest is completed/claimed (UI-level hook)
(function hookQuestXP(){
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.quest .claim, .quest-claim, .quest .complete, .quest-complete, #questsOverlay .claim, #questsOverlay .complete');
    if(!btn) return;
    try{ addXP(50,'quest'); }catch(_){}
  });
})();
</script>


<script>
// Added by Flex v1.59: Mermaid pet definition
window.FLEX_PETS = window.FLEX_PETS || [];
(function(){
  // Avoid duplicate
  if (!window.FLEX_PETS.find(p => p.id === "mermaid")) {
    window.FLEX_PETS.push({
      id: "mermaid",
      name: "Mermaid",
      icon: "pets/mermaid.png",
      eps: 60000,
      multiplier: 3,
      rarity: "legacy",
      special: true
    });
  }
})();
</script>


<script>
// Added by Flex v1.59: Legacy Crate with guaranteed Mermaid
(function(){
  window.FLEX_CRATES = window.FLEX_CRATES || [];
  if (!window.FLEX_CRATES.find(c => c.id === "legacy")) {
    window.FLEX_CRATES.push({
      id: "legacy",
      name: "Legacy Crate",
      icon: "icons/legacy_crate.png",
      description: "Guaranteed special pet: Mermaid (60,000 EPS, x3 multiplier).",
      open: function(ctx){
        const pet = { id: "mermaid", name: "Mermaid", icon: "pets/mermaid.png", eps: 60000, multiplier: 3, rarity: "legacy", special: true };
        if (ctx && typeof ctx.onReward === "function") ctx.onReward(pet);
        window.dispatchEvent(new CustomEvent("flex:crateOpened", { detail: { crateId: "legacy", rewards: [pet] }}));
        return [pet];
      }
    });
  }
})();
</script>


<script>
// Ensure permanent pet multiplier (e.g., Mermaid x3) applies globally
(function(){
  const prev = window.getActivePedestalMultiplier || function(){ return 1; };
  window.getActivePedestalMultiplier = function(){
    var base = 1;
    try{ base = prev.apply(this, arguments) || 1; }catch(e){ base = 1; }
    var petMult = 1;
    try{ petMult = Math.max(1, Number((window.state||{}).permanentPetMultiplier)||1); }catch(_){ petMult = 1; }
    return base * petMult;
  };
})();
</script>


<!-- robust pedestal state fix -->
<script>
// Force-refresh pedestal classes and UI when swapping (especially from Sandy Shores)
(function(){
  const KNOWN = ['red-pedestals','aqua-pedestals','strange-pedestals','sandy-pedestals','snowy-pedestals'];
  function forcePedestalClasses(){
    try{
      KNOWN.forEach(cls => document.body.classList.remove(cls));
      const map = { default:'', red:'red-pedestals', aqua:'aqua-pedestals', strange:'strange-pedestals', sandy:'sandy-pedestals', snowy:'snowy-pedestals' };
      const sel = String(((window.state||{}).selectedPedestalSkin)||'default');
      const cls = map[sel];
      if (cls) document.body.classList.add(cls);
    }catch(e){}
  }
  const prevApply = window.applyPedestalSkin;
  window.applyPedestalSkin = function(){
    try{ if (typeof prevApply === 'function') prevApply.apply(this, arguments); }catch(e){}
    forcePedestalClasses();
    // keep Equip buttons states fresh without reload
    try{ if (typeof window.__renderPedestalPage === 'function') window.__renderPedestalPage(); }catch(e){}
  };
  // Also ensure clicks that change skins trigger the refresh immediately
  document.addEventListener('click', function(ev){
    const btn = ev.target && ev.target.closest && ev.target.closest('.ped-apply');
    if(!btn) return;
    // let the original handler mutate state first, then sync classes
    setTimeout(function(){ try{ if(window.applyPedestalSkin) window.applyPedestalSkin(); }catch(e){} }, 0);
  }, true);
  // initial correction after load
  setTimeout(function(){ try{ if(window.applyPedestalSkin) window.applyPedestalSkin(); }catch(e){} }, 0);
})();
</script>


<script>
(function(){
  // ===== Rising Tides XP Events =====
  const ICON_BASE = "icons/rising_tides_xp/";
  const EVENTS = [
    { key:"anchor", name:"Anchor Drop", icon: ICON_BASE + "anchor.png", xp: 5 },
    { key:"coral", name:"Coral Cascade", icon: ICON_BASE + "coral.png", xp: 10 },
    { key:"turtle", name:"Turtle Tumble", icon: ICON_BASE + "turtle.png", xp: 15 }
  ];
  const DURATION_MS = 60_000;       // 1 minute
  const COOLDOWN_MS = 10 * 60_000;  // 10 minutes
  const SPAWN_EVERY_MS = 450;       // spawn cadence

  const hud   = document.getElementById('rtxp-hud');
  const nameEl= document.getElementById('rtxp-name');
  const etaEl = document.getElementById('rtxp-eta');
  const layer = document.getElementById('rtxp-layer');

  let active = false;
  let endAt = 0;
  let spawnTimer = 0;
  let countdownTimer = 0;

  function getAddXP(){
    return (window.__flexAddXP || window.addXP || function(){});
  }

  function rand(min,max){ return Math.random()*(max-min)+min; }

  function spawnOne(cfg){
    const img = new Image();
    img.src = cfg.icon;
    img.className = 'rtxp-item';
    img.style.left = `${Math.floor(rand(0, window.innerWidth - 64))}px`;
    img.style.animation = `rtxp-fall ${rand(5.5, 8.5)}s linear forwards`;
    img.style.transform = `translateY(-80px) rotate(${Math.floor(rand(-30,30))}deg)`;
    img.setAttribute('alt', cfg.name);
    img.addEventListener('click', (e)=>{
      e.stopPropagation();
      // grant XP
      try{ getAddXP()(cfg.xp, 'rtxp'); }catch(err){}
      // pop + remove
      img.style.transition = 'transform .12s ease, opacity .12s ease';
      img.style.transform = 'scale(1.15)';
      img.style.opacity = '0';
      setTimeout(()=> img.remove(), 120);
    }, { passive:false });
    // auto remove after animation
    img.addEventListener('animationend', ()=> img.remove());
    layer.appendChild(img);
  }

  function startEvent(){
    if(active) return;
    active = true;
    const cfg = EVENTS[Math.floor(Math.random()*EVENTS.length)];
    nameEl.textContent = cfg.name;
    endAt = Date.now() + DURATION_MS;
    hud.style.display = 'block';
    layer.style.pointerEvents = 'none'; // items enable their own
    // spawn loop
    spawnTimer = setInterval(()=> spawnOne(cfg), SPAWN_EVERY_MS);
    // countdown UI
    function updateCountdown(){
      const remain = Math.max(0, Math.ceil((endAt - Date.now())/1000));
      etaEl.textContent = String(remain);
      if(remain <= 0){ stopEvent(); }
    }
    updateCountdown();
    countdownTimer = setInterval(updateCountdown, 250);
  }

  function stopEvent(){
    clearInterval(spawnTimer);
    clearInterval(countdownTimer);
    spawnTimer = countdownTimer = 0;
    hud.style.display = 'none';
    // clean items
    Array.from(layer.querySelectorAll('.rtxp-item')).forEach(n=> n.remove());
    active = false;
  }

  // Kickoff: schedule an event every 10 minutes (first one after 10 minutes)
  setInterval(()=> { if(!active) { startEvent(); } }, COOLDOWN_MS);// Responsive cleanup
  window.addEventListener('blur', ()=>{
    // if tab hidden long enough to surpass duration, end event
    if(active && Date.now() > endAt) stopEvent();
  });
})();
</script>


<script>
// === MAX LEVEL RED CRAZY ANIMATION ===
function showMaxLevelAnimation(){
  try{
    // avoid stacking if already visible
    if(document.querySelector('.max-level-overlay')) return;
    const wrap = document.createElement('div');
    wrap.className = 'max-level-overlay';
    const txt = document.createElement('div');
    txt.className = 'max-text';
    txt.textContent = 'MAX LEVEL!';
    wrap.appendChild(txt);
    document.body.appendChild(wrap);
    // Auto remove after 3 seconds
    setTimeout(()=>{ try{ wrap.remove(); }catch(e){} }, 3000);
  }catch(e){}
}
</script>

<script>
function MaxLevelAnimation(){
  try{
    if(document.querySelector('.max-level-overlay')) return;
    const wrap = document.createElement('div');
    wrap.className = 'max-level-overlay';
    const txt = document.createElement('div');
    txt.className = 'max-text';
    txt.textContent = 'MAX LEVEL!';
    wrap.appendChild(txt);
    document.body.appendChild(wrap);
    setTimeout(()=>{ try{ wrap.remove(); }catch(e){} }, 3000);
  }catch(e){}
}
</script>


<script>
// PATCH: ensure winter background apply + persistence
(function() {
  try {
    // Utility to remove all known bg classes (safe no-ops if missing)
    function __removeAllBGs() {
      document.body.classList.remove(
        'bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-crypto',
        'redblue','bg-rainbow','bg-hawkins','bg-sunrise','bg-greatwave','bg-upsidedown','bg-spaceview','bg-beachvibes','bg-winter','bg-dodger','bg-dodgerquests'
      );
      // Also clear any direct body background that may block image classes
      document.body.style.background = '';
    }

    // Apply selected background to body based on state.selectedBackground
    function __applySelectedBG() {
      try {
        if(!window.state) return;
        const sel = state.selectedBackground || 'default';
        __removeAllBGs();
        switch(sel) {
          case 'beachvibes': document.body.classList.add('bg-beachvibes'); break;
          case 'greatwave': document.body.classList.add('bg-greatwave'); break;
          case 'upsidedown': document.body.classList.add('bg-upsidedown'); break;
          case 'hawkins': document.body.classList.add('bg-hawkins'); break;
          case 'winter_wonderland': document.body.classList.add('bg-winter'); break;
          // add other named keys here if necessary
          default: /* default bg uses gradient via CSS or gameplay */ break;
        }
      } catch(e) { /* no-op */ }
    }

    // Run once on DOM ready (covers Backgrounds page and main view)
    if(document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', __applySelectedBG, { once:true });
    } else {
      setTimeout(__applySelectedBG, 0);
    }

    // Delegated handler for the Winter Wonderland tile Apply button, in case
    // the original click binding fails in some renders.
    document.addEventListener('click', function(ev) {
      const btn = ev.target && ev.target.closest('[data-winterbg] .bg-apply');
      if(!btn) return;
      try {
        if(!((window.state||{}).unlockedBackgrounds||{}).winter_wonderland) return;
        __removeAllBGs();
        document.body.classList.add('bg-winter');
        try { state.selectedBackground = 'winter_wonderland'; } catch(e) {}
        try { if(typeof window.save === 'function') window.save(); } catch(e) {}
      } catch(e) { /* ignore */ }
    }, true);

    // Re-apply selection any time the bg grid is re-rendered
    // (helps keep visual in sync after unlocking)
    const _orig = window.__renderBgGrid;
    window.__renderBgGrid = function() {
      if(typeof _orig === 'function') try { _orig(); } catch(e) { }
      try { __applySelectedBG(); } catch(e) { }
    };
  } catch(e) { /* ignore top-level */ }
})();
</script>

<!-- ===== Centering fix for Potion Brewer overlay (no blur) ===== -->
<style id="brewCenterFix">
  /* Force the brewer overlay to center to the viewport and remove blur. 
     Also allow dragging from outside by passing pointer events through, except on the panel. */
  #brewOverlay{
    position: fixed !important;
    inset: 0 !important;
    display: none !important;
    background: transparent !important;
    -webkit-backdrop-filter: none !important;
    backdrop-filter: none !important;
    pointer-events: none !important;
    z-index: 9999 !important;
  }
  #brewOverlay.show{
    display: grid !important;
    place-items: center !important;
  }
  /* Make the sheet a no-op so the panel can be grid-centered */
  #brewOverlay .sheet{
    position: static !important;
    inset: auto !important;
    display: contents !important;
    background: transparent !important;
    -webkit-backdrop-filter: none !important;
    backdrop-filter: none !important;
    pointer-events: none !important;
  }
  /* Panel itself is interactive and centered by overlay grid */
  #brewOverlay .panel{
    pointer-events: auto !important;
    margin: 0 !important;
  }
</style>

<!-- ===== Drag & Drop styles for Brewer ===== -->
<style id="brewDragStyles">
  #inventory .slot{ cursor: grab; }
  #inventory .slot:active{ cursor: grabbing; }
  .brew-slot.drop-ok{ outline: 4px dashed rgba(109,255,121,.95); outline-offset: 3px; }
  .brew-slot.drop-no{ outline: 4px dashed rgba(255,90,90,.95); outline-offset: 3px; }
</style>




<!-- ===== Drag & Drop (v4) styles for Brewer (full-slot dotted outline) ===== -->
<style id="brewDragStylesV4">
  #inventory .slot, #inventory .slot *{ cursor: grab; }
  #inventory .slot:active{ cursor: grabbing; }

  /* Ensure target slots can host a pseudo-element overlay */
  #brewFuel, #brewUnique, #brewOther, .brew-slot{
    position: relative !important;
  }

  /* Reset any prior outlines */
  #brewFuel, #brewUnique, #brewOther, .brew-slot{
    outline: none !important;
    box-shadow: none;
  }

  /* Pseudo-element that exactly matches the slot's box */
  #brewFuel::after, #brewUnique::after, #brewOther::after, .brew-slot::after{
    content: none;
    position: absolute;
    inset: 0;
    border-radius: inherit;
    pointer-events: none;
  }

  /* Valid hover = dotted yellow full-frame */
  #brewFuel.drop-ok::after, #brewUnique.drop-ok::after, #brewOther.drop-ok::after, .brew-slot.drop-ok::after{
    content: "";
    border: 4px dotted #FFD400;
    box-shadow: 0 0 0 3px rgba(255,212,0,0.35);
  }

  /* Invalid hover = dotted red full-frame */
  #brewFuel.drop-no::after, #brewUnique.drop-no::after, #brewOther.drop-no::after, .brew-slot.drop-no::after{
    content: "";
    border: 4px dotted rgba(255,72,72,.95);
  }

  /* Pending/unknown = subtle dotted neutral */
  #brewFuel.drop-pending::after, #brewUnique.drop-pending::after, #brewOther.drop-pending::after, .brew-slot.drop-pending::after{
    content: "";
    border: 4px dotted rgba(255,255,255,.5);
  }
</style>

<!-- ===== Drag & Drop logic for Brewer v4 (same logic, full-slot visual) ===== -->
<script id="brewDragLogicV4">
(function(){
  if (window.__brewDragInitV4) return; window.__brewDragInitV4 = true;

  function itemByUid(uid){
    uid = String(uid||"");
    try{ return (window.state?.inventory||[]).find(x=>x && String(x.uid)===uid) || null; }catch(e){ return null; }
  }

  function acceptForOther(obj){
    const rk = String(obj?.rarity||'').toLowerCase();
    return rk==='legendary' || rk==='legacy' || rk==='exotic' || rk==='crypto' ||
           (rk==='potion' && /multiplier x[24] potion/i.test(String(obj?.name||'')));
  }

  function ensureDraggable(el){
    if (!el || el.__dragEnabled) return;
    el.__dragEnabled = true;
    (el.closest('.slot') || el).setAttribute('draggable','true');
    el.addEventListener('dragstart', (e)=>{
      const root = el.closest('.slot') || el;
      const uid = root.getAttribute('data-uid');
      if(!uid || !e.dataTransfer) return;
      e.dataTransfer.setData('text/flex-uid', uid);
      e.dataTransfer.setData('text/plain', uid);
      e.dataTransfer.effectAllowed = 'move';
      const img = root.querySelector('img');
      if (img && e.dataTransfer.setDragImage){
        e.dataTransfer.setDragImage(img, img.width/2, img.height/2);
      }
    });
  }

  function enableInventoryDrag(){
    try{
      document.querySelectorAll('#inventory .slot, #inventory .slot *').forEach(ensureDraggable);
    }catch(_){}
  }

  function getDraggedUid(dt){ return dt ? (dt.getData('text/flex-uid') || dt.getData('text/plain') || null) : null; }
  function getDraggedItem(dt){ const uid = getDraggedUid(dt); return uid ? itemByUid(uid) : null; }

  function slotAttach(el, acceptFn){
    if(!el || el.__dndAttachedV4) return;
    el.__dndAttachedV4 = true;
    el.classList.add('brew-slot'); // styling hook

    function clear(){ el.classList.remove('drop-ok','drop-no','drop-pending'); }

    el.addEventListener('dragenter', (e)=>{
      e.preventDefault();
      const it = getDraggedItem(e.dataTransfer);
      if (!it){ el.classList.add('drop-pending'); return; }
      if (acceptFn(it)){ el.classList.add('drop-ok'); el.classList.remove('drop-no','drop-pending'); }
      else { el.classList.add('drop-no'); el.classList.remove('drop-ok','drop-pending'); }
    });

    el.addEventListener('dragover', (e)=>{
      e.preventDefault();
      if (e.dataTransfer) e.dataTransfer.dropEffect = 'move';
      const it = getDraggedItem(e.dataTransfer);
      if (!it){ el.classList.add('drop-pending'); el.classList.remove('drop-ok','drop-no'); return; }
      if (acceptFn(it)){ el.classList.add('drop-ok'); el.classList.remove('drop-no','drop-pending'); }
      else { el.classList.add('drop-no'); el.classList.remove('drop-ok','drop-pending'); }
    });

    el.addEventListener('dragleave', clear);

    el.addEventListener('drop', (e)=>{
      e.preventDefault();
      const it = getDraggedItem(e.dataTransfer);
      clear();
      if(!it || !acceptFn(it)) return;
      try{ window.state.selectedItemUid = it.uid; }catch(_){}
      try{ el.click(); }catch(_){}
      setTimeout(enableInventoryDrag, 0);
    });
  }

  function attachBrewerDnD(){
    const fuelAccept   = (it)=> String(it?.rarity||'').toLowerCase()==='fuel';
    const uniqueAccept = (it)=> String(it?.rarity||'').toLowerCase()==='unique';
    const otherAccept  = (it)=> acceptForOther(it);

    slotAttach(document.getElementById('brewFuel'),   fuelAccept);
    slotAttach(document.getElementById('brewUnique'), uniqueAccept);
    slotAttach(document.getElementById('brewOther'),  otherAccept);
  }

  try{
    if (typeof window.renderInventory === 'function' && !window.renderInventory.__patchedForBrewDnDV4){
      const _orig = window.renderInventory;
      window.renderInventory = function(){
        const r = _orig.apply(this, arguments);
        try{ enableInventoryDrag(); attachBrewerDnD(); }catch(_){}
        return r;
      };
      window.renderInventory.__patchedForBrewDnDV4 = true;
    }
  }catch(_){}

  setTimeout(()=>{ enableInventoryDrag(); attachBrewerDnD(); }, 0);
})();
</script>

<!-- ===== POTION BREWER: Ownership Stabilizer (stickiness) ===== -->
<script>
(function(){
  try{
    function safeGetPlayerId(){
      try{ return typeof getPlayerId==='function' ? getPlayerId() : (window.state && (state.username||state.userName||state.player?.name||state.player?.username)) || 'default'; }catch(e){ return 'default'; }
    }
    function lsKey(){ return 'flex_brewer_owned__' + String(safeGetPlayerId()).toLowerCase(); }
    function readOwned(){ try{ return localStorage.getItem(lsKey())==='1'; }catch(e){ return false; } }
    function applyLS(){
      try{
        window.state = window.state || {};
        state.brewer = state.brewer || { owned:false, active:null };
        if (readOwned()) state.brewer.owned = true;
        if (typeof ensureBrewButtonVisible==='function') ensureBrewButtonVisible();
      }catch(e){}
    }
    // Early + late phases
    let n=0; const t=setInterval(()=>{ n++; applyLS(); if(n>24) clearInterval(t); }, 250);
    window.addEventListener('focus', applyLS);
    window.addEventListener('pageshow', applyLS);
    window.addEventListener('storage', (e)=>{ try{ if(e.key===lsKey()) applyLS(); }catch(_){} });
  }catch(e){}
})();
</script>

<!-- ===== POTION BREWER: Autosave Hooks ===== -->
<script>
(function(){
  try{
    let _saveInFlight = false;
    function safeSave(){
      try{
        if (typeof save !== 'function') return;
        if (_saveInFlight) return;
        _saveInFlight = true;
        Promise.resolve(save()).catch(()=>{}).finally(()=>{ _saveInFlight=false; });
      }catch(_){}
    }
    // Save on critical lifecycle moments
    window.addEventListener('pagehide', safeSave);
    window.addEventListener('visibilitychange', function(){
      if (document.visibilityState === 'hidden') safeSave();
    });
    // Also save shortly after purchase in case networking is delayed (belt & suspenders)
    document.addEventListener('brewer:purchased', safeSave);
  }catch(_){}
})();
</script>

<!-- ===== POTION BREWER: Ownership Autosave + Migration Hardener (2026-01-04) ===== -->
<script>
(function(){
  try{
    // Safely pull a player id (username) if possible
    function safeGetPlayerId(){
      try{
        if (typeof getPlayerId === 'function') return String(getPlayerId()).trim();
      }catch(_){}
      try{
        const u = (window.state && (state.username || state.userName || (state.player && state.player.username))) || '';
        if (u && String(u).trim()) return String(u).trim();
      }catch(_){}
      return 'default';
    }

    // New, player-scoped key (primary)
    function scopedKey(id){ return 'flex_brewer_owned__' + String(id||safeGetPlayerId()).toLowerCase(); }
    // Legacy global keys we may need to read/migrate
    const LEGACY_KEYS = ['flex_brewer_owned', 'flex_brewer_owned__default'];

    // Read "owned" from any known place
    function readAnyOwned(){
      try{
        const id = safeGetPlayerId();
        const keys = [scopedKey(id), ...LEGACY_KEYS];
        for (const k of keys){
          try{ if (localStorage.getItem(k) === '1') return true; }catch(_){}
        }
      }catch(_){}
      return false;
    }

    // Write "owned" back to all relevant keys (id-aware + legacy) to guarantee stickiness
    function writeAllOwned(v){
      const flag = v ? '1' : '0';
      try{
        const id = safeGetPlayerId();
        const keys = [scopedKey(id), ...LEGACY_KEYS, scopedKey('default')];
        for (const k of keys){
          try{ localStorage.setItem(k, flag); }catch(_){}
        }
      }catch(_){}
    }

    // Ensure runtime + UI reflect ownership
    function assertOwnedUI(){
      try{
        window.state = window.state || {};
        state.brewer = state.brewer || { owned:false, active:null };
        if (!state.brewer.owned) state.brewer.owned = true;
        // create/show the toolbar button if available
        try{ if (typeof ensureBrewButtonVisible === 'function') ensureBrewButtonVisible(); }catch(_){}
        try{ if (typeof showBrewButton === 'function') showBrewButton(); }catch(_){}
        // refresh the shop card purchase state, if present
        try{ if (typeof refreshBuyButton === 'function') refreshBuyButton(); }catch(_){}
      }catch(_){}
    }

    // Promote ownership to runtime & persist in every layer
    function promoteOwnedEverywhere(){
      try{
        writeAllOwned(true);
        assertOwnedUI();
        // Try to persist to the canonical save as well
        try{ if (typeof save === 'function') save(); }catch(_){}
        // Fire a signal for any listeners
        try{ document.dispatchEvent(new CustomEvent('brewer:purchased')); }catch(_){}
      }catch(_){}
    }

    // 1) On startup, if any key says we own it, make sure it's mirrored everywhere
    function applyOnStart(){
      try{
        if (readAnyOwned()){
          promoteOwnedEverywhere();
        }
      }catch(_){}
    }

    // 2) Wrap/augment existing save & payload-building to guarantee "brewer" is included
    (function hardenSavePipeline(){
      try{
        const _build = window.buildSavePayload;
        window.buildSavePayload = function(ts){
          const p = _build ? _build.apply(this, arguments) : {};
          try{
            window.state = window.state || {};
            const brewer = state.brewer || { owned:false, active:null };
            // Only write minimal + stable data
            p.brewer = { owned: !!brewer.owned, active: brewer.active || null };
          }catch(_){}
          return p;
        };
      }catch(_){}
      try{
        const _save = window.save;
        // Ensure any call to save also refreshes localStorage stickiness for the current user
        window.save = function(){
          try{
            const owned = !!(window.state && state.brewer && state.brewer.owned);
            writeAllOwned(owned);
          }catch(_){}
          return _save ? _save.apply(this, arguments) : undefined;
        };
      }catch(_){}
    })();

    // 3) Listen for purchase signals (from our code or any other flows) and promote immediately
    try{
      document.addEventListener('brewer:purchased', promoteOwnedEverywhere);
    }catch(_){}
    // Fallback: if the shop button exists and is clicked, force the promotion immediately
    try{
      const shopClickPromoter = function(ev){
        const el = ev && ev.target ? ev.target : null;
        if (!el) return;
        if (el.id === 'buyBrewer' || (el.closest && el.closest('#buyBrewer'))) {
          // Next tick to allow the normal handler to run first
          setTimeout(promoteOwnedEverywhere, 0);
        }
      };
      document.addEventListener('click', shopClickPromoter, true);
    }catch(_){}

    // 4) Apply at multiple lifecycle points to beat any race with UI boot
    applyOnStart();
    // early and late retries
    let n=0; const t=setInterval(()=>{ n++; applyOnStart(); if(n>32) clearInterval(t); }, 200);
    window.addEventListener('pageshow', applyOnStart);
    window.addEventListener('focus', applyOnStart);
    window.addEventListener('storage', function(e){
      try{
        if (!e || !e.key) return;
        const id = safeGetPlayerId();
        if (e.key === scopedKey(id) || LEGACY_KEYS.includes(e.key)) applyOnStart();
      }catch(_){}
    });

    // 5) On unload, mirror the final flag one last time
    try{ window.addEventListener('beforeunload', function(){ try{
      const owned = !!(window.state && state.brewer && state.brewer.owned);
      writeAllOwned(owned);
    }catch(_){} }); }catch(_){}
  }catch(_){/* No-op to avoid breaking the game if anything here fails */}
})();
</script>



<script>
// === Injected: Advanced Announcement UI wire-up (v2.1) ===
(function(){
  // Fonts for nicer headings if available
  const g1=document.createElement('link'); g1.rel='preconnect'; g1.href='https://fonts.googleapis.com';
  const g2=document.createElement('link'); g2.rel='stylesheet';
  g2.href='https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Poppins:wght@600;700;800&family=Bebas+Neue&display=swap';
  document.head.appendChild(g1); document.head.appendChild(g2);

  // Element
  function ensureEl(){
    let el = document.getElementById('flexRichAnn');
    if (el) return el;
    el = document.createElement('div');
    el.id = 'flexRichAnn';
    el.innerHTML = '<div class="inner"><span class="icon"></span><span class="text"></span></div>';
    document.body.appendChild(el);
    return el;
  }

  // Gradient presets
  const GRADS = {
    blueGold: ['#3b82f6','#f59e0b'],
    ocean: ['#2563eb','#06b6d4'],
    sunset: ['#f97316','#f43f5e'],
    grape: ['#7c3aed','#ec4899'],
    emerald: ['#10b981','#22d3ee'],
    steel: ['#64748b','#0f172a']
  };

  function applyShadow(el, type){
    const map = {
      none: 'none',
      soft: '0 12px 28px rgba(0,0,0,.35)',
      hard: '0 16px 0 rgba(0,0,0,.25)',
      glow: '0 0 36px rgba(255,255,255,.25), 0 12px 28px rgba(0,0,0,.35)'
    };
    el.style.boxShadow = map[type] || map.soft;
  }

  function setBG(el, ui){
    // Prefer gradient preset if provided
    if (ui.gradient && ui.gradient !== 'none' && GRADS[ui.gradient]){
      const [a,b] = GRADS[ui.gradient];
      el.style.background = `linear-gradient(90deg, ${a}, ${b})`;
      return;
    }
    // solid color fallback
    el.style.background = ui.bg || '#111';
  }

  function showAdvanced(msg){
    if (!msg || !msg.ui) return false;
    const ui = msg.ui || {};
    const el = ensureEl();
    document.body.classList.add('flex-hide-legacy-banner');

    // Variant + position
    el.className = '';
    el.classList.add(ui.variant||'toast');
    el.classList.add(ui.position||'top');
    el.classList.add('show');
    // animation
    el.classList.remove('fade','slide','pop');
    if (ui.anim && ui.anim !== 'none') el.classList.add(ui.anim);

    // Styles
    el.style.borderRadius = (ui.radius!=null?ui.radius:14) + 'px';
    el.style.padding = (ui.padding!=null?ui.padding:14) + 'px';
    setBG(el, ui);
    applyShadow(el, ui.shadow||'soft');

    const inner = el.querySelector('.inner');
    inner.style.fontFamily = ui.fontFamily || "'Inter',system-ui,sans-serif";
    inner.style.fontWeight = String(ui.fontWeight||800);
    inner.style.fontSize = (ui.fontSize!=null?ui.fontSize:28) + 'px';
    inner.style.textTransform = (ui.case==='upper') ? 'uppercase' : 'none';
    inner.style.letterSpacing = (ui.letterSpacing!=null?ui.letterSpacing:0) + 'px';
    inner.style.lineHeight = String(ui.lineHeight || 1.15);
    inner.style.textAlign = ui.align || 'center';
    inner.style.color = ui.color || '#fff';
    inner.style.webkitTextStroke = (ui.strokePx? (ui.strokePx+'px rgba(0,0,0,.65)') : '0');

    const icon = el.querySelector('.icon');
    const text = el.querySelector('.text');
    icon.textContent = ui.icon || '';
    text.textContent = String(msg.text||'');

    const ms = Math.max(1500, Math.min(30000, Math.round((ui.duration!=null?ui.duration:6)*1000)));
    clearTimeout(el._hideTimer);
    el._hideTimer = setTimeout(()=>{
      el.classList.remove('show');
      document.body.classList.remove('flex-hide-legacy-banner');
    }, ms);
    return true;
  }

  // --- Poll the same server feed the legacy banner uses, but only consume messages with `ui` ---
  let uiLastG = Number(localStorage.getItem('flex_ui_lastG')||0);
  let uiLastU = Number(localStorage.getItem('flex_ui_lastU')||0);
  let USER_ID = (window.USER_ID || localStorage.getItem('USER_ID') || 'guest');

  async function fetchJson(u){
    try{ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) return null; return await r.json(); }
    catch(e){ return null; }
  }
  async function prime(){
    try{
      const g0 = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__broadcast')}&t=${Date.now()}`) || {};
      const gl = Array.isArray(g0.list) ? g0.list : [];
      if (gl.length) uiLastG = Math.max(0, ...gl.map(m=>m&&m.ts||0));
      const u0 = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__inbox_'+USER_ID)}&t=${Date.now()}`) || {};
      const ul = Array.isArray(u0.list) ? u0.list : [];
      if (ul.length) uiLastU = Math.max(0, ...ul.map(m=>m&&m.ts||0));
      localStorage.setItem('flex_ui_lastG', String(uiLastG||0));
      localStorage.setItem('flex_ui_lastU', String(uiLastU||0));
    }catch(e){/*no-op*/}
  }

  async function poll(){
    try{
      const g = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__broadcast')}&t=${Date.now()}`) || {};
      const gl = Array.isArray(g.list) ? g.list : [];
      for (const m of gl){
        if ((m.ts||0) > uiLastG){
          if (m && m.ui && showAdvanced(m)){
            // mark also for the legacy poller to avoid duplicate
            localStorage.setItem('flex_msg_lastG', String(m.ts||0));
          }
          uiLastG = Math.max(uiLastG, m.ts||0);
        }
      }
      const u = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__inbox_'+USER_ID)}&t=${Date.now()}`) || {};
      const ul = Array.isArray(u.list) ? u.list : [];
      for (const m of ul){
        if ((m.ts||0) > uiLastU){
          if (m && m.ui && showAdvanced(m)){
            localStorage.setItem('flex_msg_lastU', String(m.ts||0));
          }
          uiLastU = Math.max(uiLastU, m.ts||0);
        }
      }
      localStorage.setItem('flex_ui_lastG', String(uiLastG||0));
      localStorage.setItem('flex_ui_lastU', String(uiLastU||0));
    }catch(e){/*no-op*/}
  }

  // BroadcastChannel for instant local test
  try{
    if ('BroadcastChannel' in window){
      const ch = new BroadcastChannel('flex:announcements:v2');
      ch.addEventListener('message', (ev)=>{
        const m = ev.data||{};
        if (m && m.ui) showAdvanced(m);
      });
    }
  }catch(e){/*no-op*/}

  // localStorage fallback trigger
  window.addEventListener('storage', (ev)=>{
    if (ev && ev.key === 'flex:announcement:v2' && ev.newValue){
      try{ const obj = JSON.parse(ev.newValue); if (obj && obj.msg) showAdvanced(obj.msg); }catch(e){}
    }
  });

  // Boot
  (async function(){
    await prime();
    poll();
    setInterval(poll, 2500);
  })();

  // Expose for debugging})();
// === /Injected ===
</script>


<!-- Flexwood Event Overlay -->
<div id="flexwoodOverlay" aria-hidden="true">
  <div class="sheet">
    <!-- Add an inline onclick handler so the close button works reliably even if
         the JavaScript event listener fails to attach.  The handler calls
         the globally exposed closeFlexwood() function defined below. -->
    <!-- Use an inline-styled button for the close control to avoid relying on
         external CSS that might be overridden.  We explicitly set
         positioning, z-index and cursor so the element remains
         interactive even when the overlay layering changes.  The
         onclick handler hides the overlay by removing the .show class and
         updating aria-hidden. -->
    <button class="flexwood-close" id="closeFlexwood"
            style="position:absolute; right:12px; top:12px; z-index:10001; background:#000; color:#fff; border:2px solid rgba(255,255,255,.25); border-radius:10px; padding:6px 10px; font-weight:800; cursor:pointer;"
            onclick="document.getElementById('flexwoodOverlay').classList.remove('show');document.getElementById('flexwoodOverlay').setAttribute('aria-hidden','true');return false;">Close âœ•</button>
    <!-- The Flexwood title includes an icon on the left. The icon originally had a dark
         background which blends into the card. Give it a bright yellow gradient
         background (similar to the event button) so the icon stands out against
         the red themed header. -->
    <div class="title">
      <img src="icons/flexwood_icon.png" alt="Flexwood"
           style="width:36px;height:36px;border-radius:8px;border:2px solid rgba(0,0,0,.35);
                  background:linear-gradient(180deg,#ffd54f,#ffb300)">
      FLEXWOOD â€” Hollywood Event
    </div>
    <div id="flexwoodGrid"></div>
  </div>
</div>


<script>
(function(){
  function $(sel){ return document.querySelector(sel); }
  window.state = window.state || {};
  state.flexwood = state.flexwood || {
    top1:{purchases:0,claimed:false},
    top2:{x6Brewed:0,claimed:false},
    top3:{claimed:false,unlocked:false},
    bot1:{rarePurchases:0,claimed:false},
    bot2:{levelReached:false,claimed:false},
    bot3:{claimed:false,unlocked:false}
  };
  state.pedestalSkins = state.pedestalSkins || { default:true };
  state.unlockedBackgrounds = state.unlockedBackgrounds || {};

  /**
   * Create the Flexwood event button and position it in the upperâ€‘left corner of the screen.
   *
   * Previously the button was appended to whatever "event row" or anchor element was
   * available, which caused it to float near the middle of the HUD and sometimes
   * obstruct other UI elements.  To ensure the button never blocks important
   * interface components, we render it as a fixedâ€‘position element attached to
   * the body.  It is always placed a small offset from the topâ€‘left edge of the
   * viewport.  If the button already exists it is not recreated.
   */
  function addFlexwoodButton(){
    // If a Flexwood button already exists, simply reposition it and
    // increase its z-index so it is always clickable.  This avoids
    // duplicate buttons if the observer fires multiple times.
    const existing = document.getElementById('openFlexwood');
    if(existing){
      existing.style.position = 'fixed';
      existing.style.left = '12px';
      // Move the button down slightly from the very top of the page.  Setting
      // a nonâ€‘zero top offset prevents it from hugging the page edge and
      // ensures it doesnâ€™t overlap the scoreboard or other HUD elements.
      // Position the button near the top of the page without letting it
      // touch the top edge.  This offset keeps the button away from the
      // very top while still sitting above other HUD elements like the
      // scoreboard.  Adjust this value to tweak its vertical placement.
      // Raise the Flexwood button so it sits just above the user name but
      // still leaves a small gap from the very top of the page.  A
      // shorter top offset lifts the button upward without letting it touch
      // the top edge.
      // Lift the Flexwood button higher while maintaining a slight gap from
      // the very top edge of the page.  This minimal offset ensures the
      // button stays clear of the top border but sits as high as possible.
      existing.style.top = '24px';
      existing.style.zIndex = '9999';
      // Ensure the existing button has the icon-btn class for consistent sizing and hover styles.
      if(!existing.classList.contains('icon-btn')) existing.classList.add('icon-btn');
      return;
    }
    // Otherwise, create a new button.
    const btn = document.createElement('button');
    // Use the same icon styling as before.  We omit the iconâ€‘btn class here because
    // the standalone class already includes the correct sizing; adding iconâ€‘btn on
    // top of iconâ€‘flexwood causes no harm but is unnecessary.
    // Include icon-btn to inherit common sizing and hover styles used by other HUD buttons.
    btn.className = 'icon-flexwood icon-btn';
    btn.id = 'openFlexwood';
    btn.title = 'Flexwood Event';
    btn.style.position = 'fixed';
    // Position near the topâ€‘left corner.  The offsets mirror other HUD
    // buttons to keep consistent spacing.  Adjust these values if the button
    // should move farther down or inward from the edge.
    btn.style.left = '12px';
    // Move the button down slightly from the very top of the page.  This offset
    // ensures the button does not crowd the page edge or obscure other
    // interface elements.  Adjust this value to fineâ€‘tune the vertical
    // placement of the Flexwood button.
    // Set a modest top offset so the Flexwood button sits below the page
    // edge but doesnâ€™t drift too far down the screen.  This keeps it
    // visible without interfering with other HUD elements.
    // Raise the Flexwood button so it sits just above the user name but
    // still leaves a small gap from the very top of the page.  A
    // shorter top offset lifts the button upward without letting it touch
    // the top edge.
    // Lift the Flexwood button higher while maintaining a slight gap from
    // the very top edge of the page.  This minimal offset ensures the
    // button stays clear of the top border but sits as high as possible.
    btn.style.top = '24px';
    // Place on top of other HUD elements to ensure it is clickable.  Use a
    // high z-index so the button is not hidden behind the scoreboard or
    // other fixed elements.
    btn.style.zIndex = '9999';
    btn.addEventListener('click', openFlexwood);
    document.body.appendChild(btn);
  }
  function openFlexwood(){
    const o = document.getElementById('flexwoodOverlay');
    if(!o) return;
    // Toggle the overlay: if it is already visible, hide it instead of
    // re-rendering.  This makes the Flexwood button act as a toggle and
    // simplifies closing the overlay when the explicit close button fails.
    if(o.classList.contains('show')){
      o.classList.remove('show');
      o.setAttribute('aria-hidden','true');
      return;
    }
    o.classList.add('show');
    o.setAttribute('aria-hidden','false');
    try{ renderFlexwood(); }catch(e){}
  }
  function closeFlexwood(){ const o=$('#flexwoodOverlay'); if(o){ o.classList.remove('show'); o.setAttribute('aria-hidden','true'); } }
  // Expose open and close functions on the global window so they can be
  // invoked from inline onclick attributes.  Without this, functions defined
  // inside this closure would not be available to HTML elements using
  // onclick="closeFlexwood()".
  window.openFlexwood = openFlexwood;
  window.closeFlexwood = closeFlexwood;
  document.getElementById('closeFlexwood')?.addEventListener('click', closeFlexwood);

  // As a safety net, delegate close behaviour on the document body.  This ensures
  // that clicking the .flexwood-close button will hide the overlay even if
  // other event listeners fail to bind or the element is re-rendered.  We
  // listen at the document level to capture events from dynamically created
  // Flexwood overlays.  When a click event bubbles from any element with
  // class 'flexwood-close', we hide the overlay and prevent the default action.
  document.addEventListener('click', function(ev){
    const target = ev.target;
    if(target && target.classList && target.classList.contains('flexwood-close')){
      const overlay = document.getElementById('flexwoodOverlay');
      if(overlay){
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden','true');
        ev.preventDefault();
        ev.stopPropagation();
      }
    }
  });

  function fmt(n){ try{return Number(n||0).toLocaleString();}catch(e){return String(n);} }
  function progressTop1(){ return Math.min(30, (state.flexwood.top1.purchases||0)); }
  function progressTop2(){ return Math.min(4, (state.flexwood.top2.x6Brewed||0)); }
  function progressBot1(){ return Math.min(35, (state.flexwood.bot1.rarePurchases||0)); }
  function progressBot2(){ try{ return (state.flexPass && (state.flexPass.level||0) >= 150) ? 1 : 0; }catch(e){ return 0; } }

  function grantHollywoodItem(name, file){
    const it = { uid:(Math.random().toString(36).slice(2)+Date.now().toString(36)), name, rarity:'crypto', price:0, baseIdx:0, svg:'flexwood_items/'+file, hollywood:true };
    state.inventory = state.inventory || [];
    state.inventory.push(it);
    try{ renderInventory && renderInventory(); }catch(e){}
    try{ recalcEPS && recalcEPS(); }catch(e){}
    try{ save && save(); }catch(e){}
  }

  // Grant an Aqua morph item.  Creates a 24â€¯Kingâ€¯Crown legendary item with the aqua morph
  // flag set.  Uses getItemSvg to generate the item art if available.  Updates
  // inventory, recalculates EPS and persists the save.
  

  // Grant a Demon morph item.  Creates a 24â€¯Kingâ€¯Crown legendary item with the demon
  // morph flag set.  Uses getItemSvg to generate the item art if available.  Updates
  // inventory, recalculates EPS and persists the save.
  

  // Expose the grant functions on the window so debug helpers can call them
  try{

  }catch(e){}
  function claimTop1(){
  try{
    window.state = window.state || {};
    state.flexwood = state.flexwood || {};
    state.flexwood.top1 = state.flexwood.top1 || { purchases:0, claimed:false };
    if(state.flexwood.top1.claimed) return;
    if(typeof progressTop1 === 'function' ? progressTop1() < 30 : ((state.flexwood.top1.purchases||0) < 30)) return;
    // Grant the Crypto item with Hollywood morph (Clapper Board)
    grantHollywoodItem('Clapper Board','clapper_board.png');
    // Mark as claimed and persist
    state.flexwood.top1.claimed = true;
    try{ if(typeof checkUnlocks === 'function') checkUnlocks(); }catch(e){}
    try{ if(typeof save === 'function') save(); }catch(e){}
    try{ if(typeof window.renderFlexwood === 'function') window.renderFlexwood(); }catch(e){}
  }catch(e){}
}
  function claimTop2(){
  try{
    window.state = window.state || {};
    state.flexwood = state.flexwood || {};
    state.flexwood.top2 = state.flexwood.top2 || { x6Brewed:0, claimed:false };
    if(state.flexwood.top2.claimed) return;
    if(typeof progressTop2 === 'function' ? progressTop2() < 4 : ((state.flexwood.top2.x6Brewed||0) < 4)) return;
    // Grant the Crypto item with Hollywood morph (Hollywood Sign)
    grantHollywoodItem('Hollywood Sign','hollywood_sign.png');
    // Mark as claimed and persist
    state.flexwood.top2.claimed = true;
    try{ if(typeof checkUnlocks === 'function') checkUnlocks(); }catch(e){}
    try{ if(typeof save === 'function') save(); }catch(e){}
    try{ if(typeof window.renderFlexwood === 'function') window.renderFlexwood(); }catch(e){}
  }catch(e){}
}
  function claimTop3(){
  try{
    window.state = window.state || {};
    state.flexwood = state.flexwood || {};
    state.flexwood.top3 = state.flexwood.top3 || { unlocked:false, claimed:false };

    // Only proceed if unlocked and not already claimed
    if(!state.flexwood.top3.unlocked) return;
    if(state.flexwood.top3.claimed) return;

    // Mark as claimed
    state.flexwood.top3.claimed = true;

    // Unlock Flexwood background in the Backgrounds selector
    state.unlockedBackgrounds = state.unlockedBackgrounds || {};
    state.unlockedBackgrounds.flexwood = true;

    // Persist
    try{ if(typeof save === 'function') save(); }catch(e){}

    // Re-render Flexwood event grid safely
    try{ if(typeof window.renderFlexwood === 'function') window.renderFlexwood(); }catch(e){}

    // Refresh backgrounds grid and open overlay so player can apply it
    try{ if(typeof window.__renderBgGrid === 'function') window.__renderBgGrid(); }catch(e){}
    try{
      const bgOverlay = document.getElementById('bgOverlay');
      if(bgOverlay && !bgOverlay.classList.contains('show')) bgOverlay.classList.add('show');
    }catch(e){}

    // Let the player know
    try{ alert('Flexwood Background unlocked! Apply it from the Backgrounds page.'); }catch(e){}
  }catch(e){}
}
  /**
   * Claim the bottomâ€‘left quest reward (Movie Premier).  This method now
   * persists the claim status so the reward can only be collected once per
   * save file.  It also checks unlock conditions and reâ€‘renders the event
   * UI after saving.
   */
  function claimBot1(){
    // Already claimed or not enough progress â€“ bail early
    if(state.flexwood.bot1.claimed) return;
    if(progressBot1() < 35) return;
    // Grant the reward item
    grantHollywoodItem('Movie Premier','movie_premier.png');
    // Mark as claimed and persist
    state.flexwood.bot1.claimed = true;
    // Update unlocks and UI
    try{ if(typeof checkUnlocks === 'function') checkUnlocks(); }catch(e){}
    try{ if(typeof save === 'function') save(); }catch(e){}
    try{ renderFlexwood(); }catch(e){}
  }

  /**
   * Claim the bottomâ€‘middle quest reward (Flex Fame).  Like claimBot1, this
   * function now saves the claim state immediately after awarding the item.
   */
  function claimBot2(){
    if(state.flexwood.bot2.claimed) return;
    if(progressBot2() < 1) return;
    // Grant the reward item
    grantHollywoodItem('Flex Fame','flex_fame.png');
    state.flexwood.bot2.claimed = true;
    try{ if(typeof checkUnlocks === 'function') checkUnlocks(); }catch(e){}
    try{ if(typeof save === 'function') save(); }catch(e){}
    try{ renderFlexwood(); }catch(e){}
  }
  function claimBot3(){ if(!state.flexwood.bot3.unlocked || state.flexwood.bot3.claimed) return; state.pedestalSkins.redcarpet=true; state.flexwood.bot3.claimed=true; try{ save && save(); }catch(e){} try{ window.__renderPedestalPage && window.__renderPedestalPage(); }catch(e){} alert('Red Carpet Pedestals unlocked! Equip it from Backgrounds â†’ Pedestals.'); renderFlexwood(); }
function checkUnlocks(){
    // Update unlocked flags based on claimed status
    state.flexwood.top3.unlocked = !!(state.flexwood.top1.claimed && state.flexwood.top2.claimed);
    state.flexwood.bot3.unlocked = !!(state.flexwood.bot1.claimed && state.flexwood.bot2.claimed);
    // Persist unlock state so it is retained across reloads
    try{ if(typeof save === 'function') save(); }catch(e){}
}

  /**
   * Build a Flexwood reward card.  Cards now include a progress bar beneath
   * the quest description to give players a clear visual sense of how far
   * along they are toward unlocking a reward.  The progress value must be
   * passed as a decimal between 0 and 1.  When undefined or out of range
   * the bar will be empty.  See renderFlexwood() for examples.
   *
   * @param {string} img       â€“ path to the reward icon
   * @param {string} label     â€“ reward label text
   * @param {string} quest     â€“ humanâ€‘friendly quest description
   * @param {boolean} canClaim â€“ true if the reward can be claimed
   * @param {boolean} isClaimed â€“ true if the reward has already been claimed
   * @param {string|null} bigLabel â€“ optional badge (e.g. BIG REWARD)
   * @param {number} progress  â€“ progress toward completion, between 0 and 1
   */
  function cardHTML(img, label, quest, canClaim, isClaimed, bigLabel, progress){
    // Constrain progress into [0,1]
    let pct = 0;
    if (typeof progress === 'number' && progress > 0){ pct = Math.max(0, Math.min(1, progress)); }
    const pctStr = (pct * 100).toFixed(0) + '%';
    // Always render a `.claim` button for consistent indexing in bindClaims.
    const btnHtml = (function(){
      if(isClaimed){
        // Disabled button with "Claimed" label
        return '<button class="buy claim" disabled data-action="claim" style="pointer-events:none;color:#2ecc71">Claimed âœ“</button>';
      }
      // Enabled or disabled claim button based on quest progress
      return '<button class="buy claim" '+(canClaim?'':'disabled')+' data-action="claim">'+(canClaim?'Claim':'Locked')+'</button>';
    })();
    // Progress bar markup: always include container even if progress is zero so
    // layout remains consistent.
    const progressBar = '<div class="progress"><div class="progress-bar" style="width:'+pctStr+';"></div></div>';
    return '<div class="flexwood-card'+(canClaim?'':' locked')+'">'
      +(bigLabel?'<div class="big">'+bigLabel+'</div>':'')
      +'<div class="top"><img src="'+img+'" alt=""><div class="label">'+label+'</div></div>'
      +'<div class="quest">'+quest+'</div>'
      + progressBar
      + btnHtml
      +'</div>';
  }
  function bindClaims(g){
    g.querySelectorAll('.flexwood-card .claim').forEach(function(btn, i){
      btn.addEventListener('click', function(){
        [claimTop1, claimTop2, claimTop3, claimBot1, claimBot2, claimBot3][i]();
      });
    });
  }
  window.renderFlexwood = function(){
    const g = document.getElementById('flexwoodGrid'); if(!g) return;
    const t1 = progressTop1(), t2 = progressTop2(), b1 = progressBot1(), b2 = progressBot2();
    const canTop3 = !!(state.flexwood.top3.unlocked && !state.flexwood.top3.claimed);
    const canBot3 = !!(state.flexwood.bot3.unlocked && !state.flexwood.bot3.claimed);
    // Compute fractional progress values for progress bars.  These values are
    // clamped in cardHTML() so negative or >1 will be handled gracefully.
    const p1 = 30 ? (t1 / 30) : 0;
    const p2 = 4 ? (t2 / 4) : 0;
    // For the top3 and bot3 rewards we treat progress as 1 when they can be claimed
    // (i.e. both prerequisite slots claimed) and 0 otherwise.
    const pTop3 = canTop3 ? 1 : 0;
    const p3 = 35 ? (b1 / 35) : 0;
    const p4 = (b2 >= 1) ? 1 : 0;
    const pBot3 = canBot3 ? 1 : 0;
    g.innerHTML = ''
      + cardHTML('flexwood_items/clapper_board.png', 'Clapper Board (Crypto â€¢ Hollywood Morph)', 'Quest: Purchase 30 items from the Shop â€” ' + t1 + ' / 30', t1>=30 && !state.flexwood.top1.claimed, state.flexwood.top1.claimed, null, p1)
      + cardHTML('flexwood_items/hollywood_sign.png', 'Hollywood Sign (Crypto â€¢ Hollywood Morph)', 'Quest: Brew 4 Ã—6 Multiplier Potions â€” ' + t2 + ' / 4', t2>=4 && !state.flexwood.top2.claimed, state.flexwood.top2.claimed, null, p2)
      + cardHTML('background_files/flexwood.png', 'Flexwood Background (Big Reward)', 'Unlocks after claiming top slots 1 & 2', canTop3, state.flexwood.top3.claimed, 'BIG REWARD', pTop3)
      + cardHTML('flexwood_items/movie_premier.png', 'Movie Premier (Crypto â€¢ Hollywood Morph)', 'Quest: Purchase 35 RARE items â€” ' + b1 + ' / 35', b1>=35 && !state.flexwood.bot1.claimed, state.flexwood.bot1.claimed, null, p3)
      + cardHTML('flexwood_items/flex_fame.png', 'Flex Fame (Crypto â€¢ Hollywood Morph)', 'Quest: Reach Flex Pass Level 150 â€” ' + ((state.flexPass&&state.flexPass.level)||1), b2>=1 && !state.flexwood.bot2.claimed, state.flexwood.bot2.claimed, null, p4)
      + cardHTML('icons/pedestals/redcarpet_icon.png', 'Red Carpet Pedestals (Big Reward)', 'Unlocks after claiming bottom slots 1 & 2', canBot3, state.flexwood.bot3.claimed, 'BIG REWARD', pBot3);
    bindClaims(g);
  };

  // Extend background grid (Flexwood)
  (function(){
    const orig = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if(typeof orig === 'function') orig();
      try{
        const g = document.getElementById('bgGrid'); if(!g) return;
        if(!g.querySelector('[data-flexwoodbg]')){
          const el = document.createElement('div');
          el.setAttribute('data-flexwoodbg','1');
          el.className = 'bg-tile' + (!((state.unlockedBackgrounds||{}).flexwood)?' locked':'');
          el.style.background = "url('background_files/flexwood.png') center/cover no-repeat";
          el.style.borderColor = '#b8860b';
          el.innerHTML = '<div style="font-weight:900">Flexwood</div><button class="buy bg-apply" '+(!((state.unlockedBackgrounds||{}).flexwood)?'disabled':'')+'>Apply</button>';
          el.querySelector('.bg-apply').onclick = function(){
            if(!((state.unlockedBackgrounds||{}).flexwood)) return;
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-crypto','bg-dodger','redblue','bg-hawkins','bg-upsidedown','bg-sunrise');
            document.body.style.background=''; document.body.classList.add('bg-flexwood');
            try{ state.selectedBackground='flexwood'; }catch(e){} try{ save && save(); }catch(e){}
          };
          g.appendChild(el);
        }else{
          const el = g.querySelector('[data-flexwoodbg]');
          el.classList.toggle('locked', !((state.unlockedBackgrounds||{}).flexwood));
          const btn = el.querySelector('.bg-apply'); if(btn) btn.disabled = !((state.unlockedBackgrounds||{}).flexwood);
        }
      }catch(e){}
    };
    // CSS hook for bg-flexwood
    try{
      let st = document.getElementById('flexwoodBgStyle');
      if(!st){ st = document.createElement('style'); st.id='flexwoodBgStyle'; document.head.appendChild(st); }
      st.textContent = "body.bg-flexwood{background:url('background_files/flexwood.png') center/cover no-repeat fixed !important;}";
    }catch(e){}
  })();

  /* Red Carpet pedestal injection moved below; see extendRedCarpetPedestal() for details */

  // Watch Flex Pass level to auto-flag bot2
  (function(){
    let last = 0;
    setInterval(function(){
      try{
        const lvl = (state.flexPass && state.flexPass.level) || 0;
        if(lvl !== last){ last = lvl; if(lvl >= 150){ state.flexwood.bot2.levelReached = true; try{ save && save(); }catch(e){} try{ renderFlexwood && renderFlexwood(); }catch(e){} } }
      }catch(e){}
    }, 1000);
  })();

  addFlexwoodButton();
  new MutationObserver(()=> addFlexwoodButton()).observe(document.body,{childList:true,subtree:true});
})();
</script>





<!-- ===== HOLLYWOOD MORPH EPS PATCH (+35,000 per Hollywood item, potion-aware) ===== -->
<script>
(function(){
  try{
    const orig = window.recalcEPS;
    window.recalcEPS = function(){
      if (typeof orig === 'function') orig.apply(this, arguments);
      try{
        // Sum +35,000 for each placed Hollywood-morph item
        const list = Object.values(window.state && state.placed || {});
        const baseExtra = list.reduce((s,it)=> s + (it && it.hollywood ? 35000 : 0), 0);
        // If a potion multiplier is active, match existing pipeline behavior by multiplying the bonus
        const m = (typeof getActivePotionMultiplier === 'function') ? (Number(getActivePotionMultiplier()) || 1) : 1;
        state.eps = Math.floor((state.eps||0) + Math.floor(baseExtra * m));
        try{
          const el = document.getElementById('eps');
          if (el) el.textContent = '+ $' + ((state.eps||0).toLocaleString(undefined,{maximumFractionDigits:0})) + ' / sec';
        }catch(e){}
      }catch(e){}
    };
  }catch(e){}
})();
</script>

<!-- v2.10 Update Notes (Flexwood) - show once for returning players -->
<style id="v210UpdateNotesStyle">
  #v210UpdateNotesOverlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:2147483600;display:none;align-items:center;justify-content:center;}
  #v210UpdateNotesOverlay.show{display:flex;}
  #v210UpdateNotes{max-width:min(720px,92vw);background:#111;color:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.6);overflow:hidden;font-family:'Lexend',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  #v210UpdateNotes header{padding:18px 20px;background:linear-gradient(135deg,#c62828,#d84315);display:flex;align-items:center;gap:12px;}
  #v210UpdateNotes header img{width:28px;height:28px;object-fit:contain;filter:drop-shadow(0 2px 2px rgba(0,0,0,.35));}
  #v210UpdateNotes header h2{margin:0;font-size:20px;letter-spacing:.4px;font-weight:800;}
  #v210UpdateNotes .body{padding:18px 20px;line-height:1.45;font-size:15px;}
  #v210UpdateNotes .body ul{margin:10px 0 0 0;padding-left:18px;}
  #v210UpdateNotes .body li{margin:6px 0;}
  #v210UpdateNotes footer{display:flex;justify-content:flex-end;gap:12px;padding:16px 20px;background:#0c0c0c;}
  #v210UpdateNotes button{padding:10px 16px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
  #v210UpdateNotes .btn-close{background:#fff;color:#111}
</style>
<script>
(function(){
  // Ensure only added once
  if(window.__v210UpdateNotesInstalled) return; window.__v210UpdateNotesInstalled = true;

  const VERSION_TAG = 'v2_10'; // used in localStorage key
  function keyFor(user){ return 'flex_patchnotes_seen__' + VERSION_TAG + '__' + (user || 'nouser'); }

  function buildOverlay(){
    const ov = document.createElement('div');
    ov.id = 'v210UpdateNotesOverlay';
    ov.innerHTML = [
      '<div id="v210UpdateNotes">',
        '<header>',
          '<img alt="Flexwood" src="icons/flexwood_icon.png"/>',
          '<h2>Flexwood Update â€” Flex_v2.10</h2>',
        '</header>',
        '<div class="body">',
          '<p>Welcome back! Here\'s what\'s new:</p>',
          '<ul>',
            '<li>Flexwood event now Live &amp; ready (6 slots incl. Clapper Board, Hollywood Sign, Flexwood Background).</li>',
            '<li>New Hollywood morph adds +$35,000 EPS when applied to an item.</li>',
            '<li>Flexwood Background &amp; Red Carpet Pedestal.</li>',
            '<li>General stability &amp; saving hardening.</li>',
          '</ul>',
        '</div>',
        '<footer>',
          '<button class="btn-close" id="v210Close">Close</button>',
        '</footer>',
      '</div>'
    ].join('');
    document.body.appendChild(ov);
    ov.addEventListener('click', (e)=>{ if(e.target === ov){ hideAndRemember(); } });
    document.getElementById('v210Close').addEventListener('click', hideAndRemember);
    document.addEventListener('keydown', function esc(e){ if(e.key === 'Escape'){ hideAndRemember(); }});
    return ov;
  }

  function showFor(user){
    const ov = document.getElementById('v210UpdateNotesOverlay') || buildOverlay();
    ov.classList.add('show');
    // Prevent background scroll while open
    try{ document.documentElement.style.overflow = 'hidden'; }catch(_){}
  }
  function hideAndRemember(){
    try{ document.getElementById('v210UpdateNotesOverlay')?.classList.remove('show'); }catch(_){}
    try{ document.documentElement.style.overflow = ''; }catch(_){}
    try{
      const u = (window.USER_ID || localStorage.getItem('flex-userid') || localStorage.getItem('userid') || 'nouser');
      localStorage.setItem(keyFor(u), '1');
    }catch(_){}
  }

  function maybeShow(){
    try{
      const user = (window.USER_ID || localStorage.getItem('flex-userid') || localStorage.getItem('userid') || '');
      if(!user) return; // not logged in yet
      // Skip if player is brand new this session
      if(window.__isFirstTimePlayer === true) return;
      const k = keyFor(user);
      if(localStorage.getItem(k) === '1') return; // already dismissed
      showFor(user);
    }catch(_){}
  }

  // Wait until the game has finished loading: USER_ID + __loadComplete
  
  function readyNow(){
    try{
      const hasUser = !!(window.USER_ID || localStorage.getItem('flex-userid') || localStorage.getItem('userid'));
      const loaded = (typeof window.__loadComplete === 'undefined') ? true : !!window.__loadComplete;
      return hasUser && loaded;
    }catch(_){ return false; }
  }

  function boot(){ 
    // Try repeatedly until ready, then attempt once.
    const tick = setInterval(()=>{
      if(readyNow()){
        clearInterval(tick);
        setTimeout(maybeShow, 250);
      }
    }, 250);

    // Safety: after 60s, if user exists but load flag never flips, still try once.
    setTimeout(()=>{
      try{
        if(!readyNow() && (window.USER_ID || localStorage.getItem('flex-userid') || localStorage.getItem('userid'))){
          maybeShow();
        }
      }catch(_){}
    }, 60000);
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot, { once:true });
  }else{
    boot();
  }
})();
</script>
</body>
<!-- Inventory Redesign Override -->
<style id="inventory-redesign-final">
  /* --- Glassy, see-through inventory bar --- */
  .inventory-wrap{
    /* keep position from existing, we only nudge visuals if needed */
    padding-bottom: 0;
  }
  .inventory{
    background: linear-gradient(180deg, rgba(120, 226, 220, .45), rgba(100, 208, 206, .40));
    backdrop-filter: blur(12px) saturate(120%);
    -webkit-backdrop-filter: blur(12px) saturate(120%);
    border-radius: 28px;
    border: 6px solid #22272b;
    box-shadow:
      inset 0 6px 0 rgba(255,255,255,.35),
      inset 0 -8px 0 rgba(0,0,0,.20),
      0 14px 30px rgba(0,0,0,.45);
  }
  /* --- 3D inventory slots resembling the reference --- */
  .slot{
    min-width: 128px;
    height: 106px;
    border-radius: 22px;
    position: relative;
    cursor: pointer;
    background:
      linear-gradient(180deg, #aeb3b8 5%, #9ba0a6 45%, #8c9197 100%) padding-box,
      linear-gradient(#272b30, #272b30) border-box;
    border: 6px solid transparent; /* border rendered by the second gradient */
    box-shadow:
      inset 0 7px 0 rgba(255,255,255,.38),   /* top bevel */
      inset 0 -10px 0 rgba(0,0,0,.22),      /* bottom bevel */
      0 6px 0 #1b1e22,                       /* base ledge */
      0 12px 16px rgba(0,0,0,.45);           /* soft drop */
  }
  /* deeper drop shadow behind each slot */
  .slot::after{
    content:"";
    position:absolute;
    left:0; right:0; bottom:-10px; top:auto;
    height: 12px;
    border-radius: 18px;
    background: rgba(0,0,0,.65);
    filter: blur(4px);
    opacity:.75;
    z-index:-1;
  }
  /* inner rim highlight */
  .slot::before{
    content:"";
    position:absolute;
    inset: 3px;
    border-radius: 16px;
    box-shadow:
      inset 0 3px 0 rgba(255,255,255,.35),
      inset 0 -4px 0 rgba(0,0,0,.18);
    pointer-events:none;
  }
  .slot img{ width:72px; height:72px; border-radius:12px; }
  .slot.is-pet { height: 126px; }
  .slot.is-pet img { width: 96px; height: 96px; }

  /* selection state unchanged but make sure it sits above bevels */
  .slot.selected{ outline:6px solid var(--ui-blue); outline-offset:2px; }

  /* tighter spacing like the screenshot */
  .inventory{ gap: 24px; }
</style>
</html>
<script>
// --- Pedestal Skins & Changer Page (non-destructive add-on) ---
(function(){
  function ensurePedestalState(){
    window.state = window.state || {};
    state.ach = state.ach || { questsDone:{} };
    // Initialise pedestal skin unlocks. Include redcarpet so it persists across sessions.
    state.pedestalSkins = state.pedestalSkins || { default:true, red: !!(state.ach.redPedestalUnlocked), aqua: !!(state.ach.aquaPedestalUnlocked) };
    // Preserve existing unlock flags for special skins
    state.pedestalSkins.strange = !!state.pedestalSkins.strange;
    state.pedestalSkins.snowy = !!state.pedestalSkins.snowy;
    state.pedestalSkins.sandy = !!state.pedestalSkins.sandy;
    // Add redcarpet unlock flag (default false until big reward claimed)
    state.pedestalSkins.redcarpet = !!state.pedestalSkins.redcarpet;
    state.selectedPedestalSkin = state.selectedPedestalSkin || 'default';
    applyPedestalSkin();
  }
  function applyPedestalSkin(){
    try{
      document.body.classList.toggle('red-pedestals', String(state.selectedPedestalSkin)==='red');
      document.body.classList.toggle('aqua-pedestals', String(state.selectedPedestalSkin)==='aqua');
      document.body.classList.toggle('strange-pedestals', String(state.selectedPedestalSkin)==='strange');
      // Additional special skins
      try{
        document.body.classList.toggle('snowy-pedestals', String(state.selectedPedestalSkin)==='snowy');
        document.body.classList.toggle('sandy-pedestals', String(state.selectedPedestalSkin)==='sandy');
        document.body.classList.toggle('redcarpet-pedestals', String(state.selectedPedestalSkin)==='redcarpet');
      }catch(e){}
    }catch(e){}
  }
  window.__renderPedestalPage = function(){
    ensurePedestalState();
    const host = document.getElementById('pedestalPage'); if(!host) return;
    host.innerHTML = '';
    const grid = document.createElement('div'); grid.className='ped-grid';
    // Default (Gold)
    const def = document.createElement('div');
    def.className = 'ped-tile';
    def.innerHTML = '<div style="font-weight:900">Default (Gold)</div>'
                  + '<button class="buy ped-apply" '+('default'===(state.selectedPedestalSkin||'default')?'disabled':'')+'>Equip</button>';
    def.querySelector('.ped-apply').onclick = ()=>{ state.selectedPedestalSkin='default'; applyPedestalSkin(); if(typeof save==='function') save(); __renderPedestalPage(); };
    grid.appendChild(def);
    // Red (Reward)
    const unlocked = !!((state.ach||{}).redPedestalUnlocked);
    const red = document.createElement('div');
    red.className = 'ped-tile'+(unlocked?'':' locked');
    red.style.background = 'linear-gradient(180deg,#ff5a5a,#8b0000)';
    red.innerHTML = '<div style="font-weight:900">Red Pedestal</div>'
                  + '<button class="buy ped-apply" '+(!unlocked || (state.selectedPedestalSkin==='red')?'disabled':'')+'>Equip</button>';
    if(unlocked){
      red.querySelector('.ped-apply').onclick = ()=>{ state.selectedPedestalSkin='red'; applyPedestalSkin(); if(typeof save==='function') save(); __renderPedestalPage(); };
    }
    
    // Aqua (Reward for Quests 3)
    const unlockedA = !!((state.ach||{}).aquaPedestalUnlocked);
    const aqua = document.createElement('div');
    aqua.className = 'ped-tile'+(unlockedA?'':' locked');
    aqua.style.background = 'linear-gradient(180deg,#a8deff,#0a4cbf)';
    aqua.innerHTML = '<div style="font-weight:900">Light/Dark Blue</div>'
                   + '<button class="buy ped-apply" '+(!unlockedA || (state.selectedPedestalSkin==='aqua')?'disabled':'')+'>Equip</button>';
    if(unlockedA){
      aqua.querySelector('.ped-apply').onclick = ()=>{ state.selectedPedestalSkin='aqua'; applyPedestalSkin(); if(typeof save==='function') save(); __renderPedestalPage(); };
    }
    
    // Strange (Purchased from Stranger Things)
    const unlockedS = !!((state.pedestalSkins||{}).strange);
    const strange = document.createElement('div');
    strange.className = 'ped-tile' + (unlockedS ? '' : ' locked');
    strange.style.background = 'radial-gradient(circle at 30% 30%, rgba(255,255,255,.9) 0 6px, transparent 7px), radial-gradient(circle at 65% 70%, rgba(255,255,255,.9) 0 6px, transparent 7px), linear-gradient(180deg,#ffd84a,#ff2b2b)';
    strange.style.backgroundSize = '22px 22px, 26px 26px, auto';
    strange.style.backgroundBlendMode = 'screen, screen, normal';
    strange.innerHTML = '<div style="font-weight:900">Strange Pedestals</div>'
                      + '<button class="buy ped-apply" ' + ((!unlockedS || (state.selectedPedestalSkin === 'strange')) ? 'disabled' : '') + '>Equip</button>';
    if (unlockedS) {
      strange.querySelector('.ped-apply').onclick = () => { state.selectedPedestalSkin = 'strange'; try{ applyPedestalSkin(); }catch(e){} if (typeof save === 'function') save(); __renderPedestalPage(); };
    }
    grid.appendChild(red);
    // Second row layout
    try { aqua.style.gridRow = '2'; aqua.style.gridColumn = '1'; } catch(e) {}
    grid.appendChild(aqua);
    try { strange.style.gridRow = '2'; strange.style.gridColumn = '2'; } catch(e) {}
    grid.appendChild(strange);

    
// --- Snowy (Winter Gift 2) â€” always visible, locked until earned; place under Blue (Aqua) ---
(function(){
  try{
    const unlockedSnow = !!((state.pedestalSkins||{}).snowy);
    const selSnow = String(state.selectedPedestalSkin)==='snowy';
    const snowy = document.createElement('div');
    snowy.className = 'ped-tile' + (unlockedSnow ? '' : ' locked');
    snowy.style.background = 'linear-gradient(180deg,#ffffff,#dff6ff)';
    snowy.innerHTML = '<div style="font-weight:900;display:flex;align-items:center;gap:8px;">Snowy Pedestal</div>' +
                      '<button class="buy ped-apply" ' + ((unlockedSnow && !selSnow) ? '' : 'disabled') + '>Equip</button>';
    try { snowy.style.gridRow = '3'; snowy.style.gridColumn = '1'; } catch(e){}
    const btn = snowy.querySelector('.ped-apply');
    btn.onclick = function(){
      if(!((state.pedestalSkins||{}).snowy)) return;
      state.selectedPedestalSkin = 'snowy';
      try { applyPedestalSkin && applyPedestalSkin(); } catch(e){}
      if (typeof save === 'function') save();
      window.__renderPedestalPage && window.__renderPedestalPage();
    };
    grid.appendChild(snowy);
    /* OCEAN PEDESTAL (Flex Pass) â€” always visible; unlock via pass; sits below Snowy on row 4 left */
    (function(){
      try{
        const unlockedOcean = !!((state.pedestalSkins||{}).aqua || (state.pedestalSkins||{}).ocean);
        const selOcean = String(state.selectedPedestalSkin)==='aqua';
        const ocean = document.createElement('div');
        ocean.setAttribute('data-ocean','1');
        ocean.className = 'ped-tile' + (unlockedOcean ? '' : ' locked');
        /* tile art */
        ocean.style.background = "radial-gradient(60% 180% at 15% 120%, rgba(255,255,255,0.60) 12%, rgba(255,255,255,0) 13%)," +
"radial-gradient(60% 180% at 45% 120%, rgba(255,255,255,0.50) 12%, rgba(255,255,255,0) 13%)," +
"radial-gradient(60% 180% at 75% 120%, rgba(255,255,255,0.55) 12%, rgba(255,255,255,0) 13%)," +
"repeating-linear-gradient(-12deg, rgba(255,255,255,0.18) 0 6px, rgba(255,255,255,0.00) 6px 26px)," +
"linear-gradient(180deg,#34d2e8 0%, #9be9ff 28%, #53bfff 60%, #0a4cbf 100%)";
        ocean.innerHTML = '<div style="font-weight:900">Ocean Pedestal</div>'
                        + '<button class="buy ped-apply" ' + ((!unlockedOcean || selOcean) ? 'disabled' : '') + '>Equip</button>';
        try{ ocean.style.gridRow = '4'; ocean.style.gridColumn = '1'; }catch(e){}
        const btn = ocean.querySelector('.ped-apply');
        btn.onclick = function(){ try{ this.disabled=true; }catch(e){};
          if(!((state.pedestalSkins||{}).aqua || (state.pedestalSkins||{}).ocean)) return;
          state.selectedPedestalSkin = 'aqua';
          try { applyPedestalSkin && applyPedestalSkin(); } catch(e){}
          if (typeof save === 'function') save();
          window.__renderPedestalPage && window.__renderPedestalPage();
        };
        grid.appendChild(ocean);
      }catch(e){}
    })();
    /* RED CARPET PEDESTAL (Flexwood big reward) â€” locked until earned; sits below Snowy on row 4 right */
    (function(){
      try{
        const unlockedRC = !!((state.pedestalSkins||{}).redcarpet);
        const selRC = String(state.selectedPedestalSkin)==='redcarpet';
        const rc = document.createElement('div');
        rc.setAttribute('data-redcarpet','1');
        rc.className = 'ped-tile' + (unlockedRC ? '' : ' locked');
        // Fabric-like appearance: diagonal stripes over rich red gradient
        rc.style.background =
          'repeating-linear-gradient(135deg, rgba(255,255,255,0.10) 0 4px, rgba(255,255,255,0.00) 4px 8px),' +
          'linear-gradient(180deg,#a80f1f,#6e0712)';
        rc.innerHTML = '<div style="font-weight:900">Red Carpet</div>' +
                       '<button class="buy ped-apply" ' + ((unlockedRC && !selRC) ? '' : 'disabled') + '>Equip</button>';
        try{ rc.style.gridRow = '4'; rc.style.gridColumn = '2'; }catch(e){}
        const btnRC = rc.querySelector('.ped-apply');
        btnRC.onclick = function(){
          // Only equip if the Red Carpet pedestal has been unlocked
          if(!((state.pedestalSkins||{}).redcarpet)) return;
          state.selectedPedestalSkin = 'redcarpet';
          try{ applyPedestalSkin && applyPedestalSkin(); }catch(e){}
          if(typeof save === 'function') save();
          window.__renderPedestalPage && window.__renderPedestalPage();
        };
        grid.appendChild(rc);
      }catch(e){}
    })();

  }catch(e){}
})();
host.appendChild(grid);
  };
  // Delegated fallback: make sure any Equip click always switches skins
  (function ensurePedestalEquipDelegate(){
    try{
      const page = document.getElementById('pedestalPage');
      if(!page || page.__equipDelegate) return;
      page.__equipDelegate = true;
      page.addEventListener('click', function(e){
        const btn = e.target.closest && e.target.closest('.ped-apply');
        if(!btn || btn.disabled) return;
        const tile = btn.closest('.ped-tile'); if(!tile) return;
        const label = (tile.textContent||'').toLowerCase();
        let sel = null;
        if(label.includes('default')) sel = 'default';
        else if(label.includes('red')) sel = 'red';
        else if(label.includes('light/dark') || label.includes('blue')) sel = 'aqua';
        else if(label.includes('strange')) sel = 'strange';
        else if(label.includes('snowy')) sel = 'snowy';
        else if(label.includes('sandy')) sel = 'sandy';
        else if(label.includes('ocean')) sel = 'aqua';
        else if(label.includes('red carpet')) sel = 'redcarpet';
        if(!sel) return;
        try{ state.selectedPedestalSkin = sel; applyPedestalSkin && applyPedestalSkin(); }catch(_){}
        try{ typeof save==='function' && save(); }catch(_){}
        try{ window.__renderPedestalPage && window.__renderPedestalPage(); }catch(_){}
      }, true); // capture to run even if other handlers fail
    }catch(_){}
  })();

  // Hook the side tabs to render the page when PEDESTALS is shown
  document.addEventListener('DOMContentLoaded', function(){
    ensurePedestalState();
    const tabs = document.getElementById('bgSideTabs');
    if(tabs){
      tabs.addEventListener('click', function(e){
        const t = e.target.closest('.bg-tab'); if(!t) return;
        const tgt = t.getAttribute('data-target');
        if(tgt==='pedestalPage'){ setTimeout(()=>{ try{ __renderPedestalPage(); }catch(e){} }, 0); }
      });
    }
    // In case the Pedestals tab starts active
    try{
      const active = document.querySelector('#bgSideTabs .bg-tab.active');
      if(active && active.getAttribute('data-target')==='pedestalPage'){
        __renderPedestalPage();
      }
    }catch(e){}
  });
})();
</script>
<script>
(function(){
  function __udVisBackup(){
    try{
      if(document.visibilityState === 'hidden'){
        if(window.__backupNow) { window.__backupNow(); }
        if(window.__saveHawkinsProgress) { try{ window.__saveHawkinsProgress(); }catch(e){} }
      }
    }catch(e){}
  }
  document.addEventListener('visibilitychange', __udVisBackup);
})();
</script>
<script>
try{
  window.addEventListener('pagehide', function(){
    try{ if(window.__backupNow){ window.__backupNow(); } }catch(e){}
  });
}catch(e){}
</script>

<script>
// === Winter Gifts persistence hardening (final patch) ===
(function(){
  try {
    const WG_KEY = 'WG_WINTER_GIFTS_V1';
    function saveWG(){ try{ localStorage.setItem(WG_KEY, JSON.stringify(state.winterGifts||{forge:0,hatch:0,legacyPurchases:0,uniquePurchases:0,gift:{},blizzardActive:false,pendingRewards:[]})); }catch(e){} }
    // Re-wrap markClaimed safely and idempotently
    const prev = window.markClaimed;
    if(!prev || !prev.__wgWrapped){
      function wrapper(id){
        try{ 
          window.state = window.state || {};
          state.winterGifts = state.winterGifts || {forge:0,hatch:0,legacyPurchases:0,uniquePurchases:0,gift:{},blizzardActive:false,pendingRewards:[]};
          state.winterGifts.gift = state.winterGifts.gift || {};
          state.winterGifts.gift[id] = 'claimed';
          saveWG();
        }catch(e){}
        if(typeof prev === 'function') try{ return prev.apply(this, arguments); }catch(e){}
      }
      wrapper.__wgWrapped = true;
      window.markClaimed = wrapper;
    }
    // On DOM ready, refresh the grid if open so claimed state sticks visually
    document.addEventListener('DOMContentLoaded', function(){
      try{ const o = document.getElementById('winterOverlay'); if(o && o.classList.contains('show') && typeof renderWinterGrid==='function') renderWinterGrid(); }catch(e){}
    });
    // Ensure save() pushes WG to remote/local backups as well (if our earlier patch didn't run)
    try{
      const __save = window.save;
      if (__save && !__save.__wgAugmented) {
        window.save = async function(){
          try{ state.winterGifts = state.winterGifts || {forge:0,hatch:0,legacyPurchases:0,uniquePurchases:0,gift:{},blizzardActive:false,pendingRewards:[]}; }catch(e){}
          return await __save.apply(this, arguments);
        };
        window.save.__wgAugmented = true;
      }
    }catch(e){}
  } catch (e) {}
})();
</script>


<script>
// ===== FLEX PASS: Rising Tides (Season 1) =====
(function(){
  const MAX_LEVEL = 524;
  const XP_PER_LEVEL = 100;

  // Ensure state bucket
  window.state = window.state || {};
  state.flexPass = state.flexPass || { level: 1, xp: 0, claimed: {} };

  // Rarity add: Coastal
  (function ensureCoastal(){
    try{
      window.RARITY = window.RARITY || {};
      if(!RARITY.coastal){
        RARITY.coastal = { label:'COASTAL', color:'var(--c-coastal)', income:60000, price:[0,0], prob:0 };
      }
    }catch(e){}
  })();

  // Aqua egg & pets
  (function addAquaEgg(){
    try{
      window.PET_TABLES = window.PET_TABLES || {};
      if(!PET_TABLES.aqua){
        PET_TABLES.aqua = [
          { name:'Fish', chance: 0.54, eps: 25000 },
          { name:'Seahorse', chance: 0.41, eps: 35000 },
          { name:'Dolphin', chance: 0.04, eps: 40000, mult: 2 },
          { name:'Flex Shark', chance: 0.01, eps: 50000, aquaMorpher:true }
        ];
      }
    }catch(e){}
  })();

  // Extend recalcEPS with Aqua morph bonus (+20,000 per aqua item)
  (function patchEPSForAqua(){
    const orig = window.recalcEPS;
    window.recalcEPS = function(){
      if(typeof orig === 'function') orig.apply(this, arguments);
      try{
        const extra = Object.values(state.placed||{}).reduce((s,it)=> s + (it && it.aqua ? 20000 : 0), 0);
        state.eps = Math.floor((state.eps||0) + extra);
        const el=document.getElementById('eps'); if(el){ el.textContent = '+ $' + ((state.eps||0).toLocaleString(undefined,{maximumFractionDigits:0})) + ' / sec'; }
      }catch(e){}
    };
  })();

  // UI helpers
  function $(sel){ return document.querySelector(sel); }
  function fmt(n){ try{ return Number(n).toLocaleString(); }catch(e){ return String(n);} }
  function pushItem(name, rarity, filePath, eps){
    const it = { uid:(Math.random().toString(36).slice(2)+Date.now().toString(36)), name, rarity, price:0, baseIdx:0, svg:filePath };
    if(eps){ it.price=[0,0]; }
    state.inventory = state.inventory || [];
    state.inventory.push(it);
    try{ renderInventory(); recalcEPS(); save(); }catch(e){}
    return it;
  }

  // --- Flex Pass XP & Levels ---
  function addXP(amount, reason){
  if(!amount) return;
  // Ensure state exists
  try{
    window.state = window.state || {};
    state.flexPass = state.flexPass || { level: 1, xp: 0, claimed: {} };
    if(typeof state.flexPass._maxShown === 'undefined') state.flexPass._maxShown = false;
  }catch(e){}
  // Guard: if already at max, do not replay animation; just keep UI in MAX state
  try{
    if(typeof MAX_LEVEL !== 'undefined' && state.flexPass.level >= MAX_LEVEL){
      state.flexPass.level = MAX_LEVEL;
      state.flexPass.xp = 0;
      try{ if (typeof updateHeader === 'function') updateHeader(); }catch(e){}
      try{ if (typeof updateRows === 'function') updateRows(); }catch(e){}
      return;
    }
  }catch(e){}
  const __prevLevel = (state && state.flexPass ? (state.flexPass.level||1) : 1);
  state.flexPass.xp = Math.max(0, (state.flexPass.xp||0) + amount);
  while(state.flexPass.xp >= XP_PER_LEVEL && state.flexPass.level < MAX_LEVEL){
    state.flexPass.xp -= XP_PER_LEVEL;
    state.flexPass.level++;
  }
  // If we just hit max, zero XP and fire animation exactly once
  if(__prevLevel < MAX_LEVEL && state.flexPass.level >= MAX_LEVEL){
    state.flexPass.level = MAX_LEVEL;
    state.flexPass.xp = 0;
    if(!state.flexPass._maxShown){
      try{ MaxLevelAnimation(); }catch(e){}
      state.flexPass._maxShown = true;
    }
  }
  try{ save(); }catch(e){}
  updateHeader();
  updateRows();
}
  window.__flexAddXP = addXP; // expose for other systems

  function updateHeader(){
    const lvl = state.flexPass.level||1;
    const xp = state.flexPass.xp||0;
    const fill = Math.min(100, Math.floor((xp / XP_PER_LEVEL) * 100));
    const lvlEl = $('#flexLevelNum'); if(lvlEl) lvlEl.textContent = 'LVL ' + lvl;
    const cap = $('#flexXPCap'); if(cap) cap.textContent = (lvl>=MAX_LEVEL ? 'MAX' : (xp)+' / '+XP_PER_LEVEL+' XP');
    const f = $('#flexXPFill'); if(f) f.style.width = (lvl>=MAX_LEVEL ? '100%' : (fill + '%'));
  }

  // --- Rewards config ---
  const ITEM_LIST = [
    ['Surfer','rising_tides_items/surfer.png'],
    ['Life Guard','rising_tides_items/life_guard.png'],
    ['Beach','rising_tides_items/beach.png'],
    ['Tsunami','rising_tides_items/tsunami.png'],
    ['Ice Cream','rising_tides_items/ice_cream.png'],
    ['Sand Castle','rising_tides_items/sand_castle.png'],
    ['JGâ€™S','rising_tides_items/jgs.png'],
    ['Buoy Swim','rising_tides_items/buoy_swim.png'],
    ['Umbrella','rising_tides_items/umbrella.png'],
    ['Rocks','rising_tides_items/rocks.png'],
    ['Seagull','rising_tides_items/seagull.png'],
    ['Shell','rising_tides_items/shell.png'],
    ['Palm Tree','rising_tides_items/palm_tree.png'],
    ['Packed Sandwich','rising_tides_items/packed_sandwich.png'],
    ['Shovel','rising_tides_items/shovel.png']
  ];

  function pickItemByRarity(rarArr){
    const pick = ITEM_LIST[Math.floor(Math.random()*ITEM_LIST.length)];
    const rar = rarArr[Math.floor(Math.random()*rarArr.length)];
    return pushItem(pick[0], rar.toLowerCase(), pick[1]);
  }

  // Inserted: weighted rarity picker for crate item rewards
  function pickItemByWeightedRarity(weights){
  try{
    const pick = ITEM_LIST[Math.floor(Math.random()*ITEM_LIST.length)];
    const entries = Object.entries(weights);
    let total = 0;
    for(const [,w] of entries){ total += Number(w)||0; }
    let r = Math.random() * total;
    for(const [rar, w] of entries){
      r -= Number(w)||0;
      if(r <= 0){
        return pushItem(pick[0], String(rar).toLowerCase(), pick[1]);
      }
    }
    return pushItem(pick[0], String(entries[0][0]).toLowerCase(), pick[1]);
  }catch(e){
    return pickItemByRarity(Object.keys(weights));
  }
}

  // Crate open logic
  function openCrate(kind){
    let result = null;
    if(kind==='rare'){
      const r = Math.random();
      if(r < 0.50){ result = pickItemByWeightedRarity({Common:45, Rare:30, Epic:25}); }
      else if(r < 0.75){ grantEggs( (Math.random()<0.5)?1:2 ); result = {type:'eggs', n:(Math.random()<0.5)?1:2, label:'Aqua Egg'}; }
      else{ const money = (100_000_000 + Math.floor(Math.random()*400_000_000)); state.money += money; result = {type:'money', amount:money}; }
    } else if(kind==='epic'){
      const r = Math.random();
      if(r < 0.50){ result = pickItemByWeightedRarity({Legendary:25, Exotic:25, Crypto:35, Coastal:15}); }
      else if(r < 0.75){ const n = 2 + Math.floor(Math.random()*2); grantEggs(n); result = {type:'eggs', n, label:'Aqua Egg'}; }
      else{ const money = (1_000_000_000 + Math.floor(Math.random()*4_000_000_000)); state.money += money; result = {type:'money', amount:money}; }
    } else if(kind==='legendary'){
      const r = Math.random();
      if(r < 0.50){
        result = pickItemByWeightedRarity({Coastal:100});
      } else if(r < 0.75){ const n = 2 + Math.floor(Math.random()*2); grantEggs(n); result = {type:'eggs', n, label:'Aqua Egg'}; }
      else{ const money = (3_000_000_000 + Math.floor(Math.random()*7_000_000_000)); state.money += money; result = {type:'money', amount:money}; }
    } else if(kind==='legacy'){
      // Guaranteed special pet: Mermaid (60,000 EPS, x3 multiplier)
      try{
        // Ensure state structures
        window.state = window.state || {};
        state.inventory = state.inventory || [];
        state.petStands = state.petStands || [null,null];
        state.petTimers = state.petTimers || {};
        // Create Mermaid pet object
        const petObj = {
          uid: (typeof uid==='function' ? uid() : (Math.random().toString(36).slice(2)+Date.now().toString(36))),
          name: 'Mermaid',
          isEgg: false,
          eggType: null,
          petType: 'Mermaid',
          petEps: 60000,
          svg: 'pets/mermaid.png'
        };
        // Add to inventory
        state.inventory.push(petObj);
        // Auto-place into first empty pet stand if available
        try{
          const n = Array.isArray(state.petStands) ? state.petStands.length : 2;
          for(let i=0;i<n;i++){
            if(!state.petStands[i]){ state.petStands[i] = petObj; break; }
          }
        }catch(_){}
        // Track ownership in PetDex if available
        try{ if(typeof registerPetOwned==='function') registerPetOwned('Mermaid'); }catch(_){}
        // Apply permanent 3x multiplier
        try{ state.permanentPetMultiplier = Math.max( (state.permanentPetMultiplier||1), 3 ); }catch(_){}
        // Recalc + save
        try{ if(typeof recalcEPS==='function') recalcEPS(); }catch(_){}
        try{ if(typeof updateTop==='function') updateTop(); }catch(_){}
        try{ if(typeof save==='function') save(); }catch(_){}
        result = petObj;
      }catch(e){
        console.error('Legacy crate award error:', e);
        result = { name:'Mermaid', svg:'pets/mermaid.png' };
      }
    }
    try{ renderInventory(); updateTop(); save(); }catch(e){}
    return result;
  }


  // Visual crate animation + reward toast
  function showCrateReward(kind, res){
    try{
      const iconMap = { rare:'icons/crates/rare_crate.png', epic:'icons/crates/epic_crate.png', legendary:'icons/crates/legendary_crate.png', legacy:'icons/crates/legacy_crate.png' };
      const crateIcon = iconMap[kind] || iconMap.rare;
      // Compute reward label + icon
      let rewardLabel = 'Reward';
      let rewardIcon = 'icons/unknown.png';
      if(res){
        if(res.type==='money'){ rewardLabel = '$' + fmt(res.amount); rewardIcon='icons/coin_stack.png'; }
        else if(res.type==='eggs'){ rewardLabel = (res.label||'Egg') + (res.n>1?(' x'+res.n):''); rewardIcon='icons/eggs/aqua_egg.png'; }
        else if(res.name || res.svg){ rewardLabel = res.name || 'Item'; rewardIcon = res.svg || 'icons/item_random.png'; }
      }
      const host = document.createElement('div'); host.id='crateAnim';
      host.innerHTML = '<div class="burst"></div>'
        + '<img class="crate" alt="Crate" src="'+crateIcon+'">'
        + '<div class="reward"><img alt="Reward" src="'+rewardIcon+'"><div>'+rewardLabel+'</div></div>';
      document.body.appendChild(host);
      // auto remove after a moment
      setTimeout(()=> { host.classList.add('fade-out'); }, 1400);
      setTimeout(()=> { host.remove(); }, 2050);
    }catch(e){}
  }

  // grant eggs to inventory
  function grantEggs(n){
    for(let i=0;i<n;i++){
      const inv = {
        uid: (Math.random().toString(36).slice(2)+Date.now().toString(36)),
        name: 'Aqua Egg',
        isEgg: true,
        eggType: 'aqua',
        svg: getEggSvg ? getEggSvg('aqua', Math.floor(Math.random()*99999)) : 'icons/eggs/aqua_egg.png',
        baseIdx: 0
      };
      state.inventory.push(inv);
    }
    try{ renderInventory(); save(); }catch(e){}
  }

  function rewardIconFor(r){
    if(r.type==='crate'){
      const map = { rare:'icons/crates/rare_crate.png', epic:'icons/crates/epic_crate.png', legendary:'icons/crates/legendary_crate.png', legacy:'icons/crates/legacy_crate.png' };
      return map[r.kind]||map.rare;
    }
    if(r.type==='money') return 'icons/pass_money_icon.png';
    if(r.type==='aquaegg') return 'icons/eggs/aqua_egg.png';
    if(r.type==='randomItem') return 'icons/item_random.png';
    if(r.type==='pedestal') return 'icons/pedestal.png';
    if(r.type==='background') return 'icons/wallpaper.png';
    return 'icons/unknown.png';
  }

  const ROW1 = [
    {level:5,  type:'crate',   kind:'epic'},
    {level:10, type:'money',   amount:20_000_000},
    {level:15, type:'aquaegg', count:1},
    {level:20, type:'crate',   kind:'rare'},
    {level:25, type:'randomItem', rarity:['Exotic']},
    {level:30, type:'money',   amount:25_000_000},
    {level:35, type:'money',   amount:25_000_000},
    {level:40, type:'crate',   kind:'epic'},
    {level:45, type:'money',   amount:50_000_000},
    {level:50, type:'aquaegg', count:1},
    {level:55, type:'money',   amount:100_000_000},
    {level:60, type:'crate',   kind:'rare'},
    {level:65, type:'aquaegg', count:1},
    {level:70, type:'pedestal', id:'ocean' },
    {level:75, type:'crate',   kind:'legendary'},
    {level:80, type:'crate',   kind:'epic'},
    {level:85, type:'money',   amount:500_000_000},
    {level:90, type:'money',   amount:1_000_000_000},
    {level:95, type:'aquaegg', count:2},
    {level:100, type:'crate',  kind:'legacy'}
  ];

  const ROW2 = [
    {level:110, type:'money', amount:10_000_000_000},
    {level:120, type:'crate',  kind:'rare'},
    {level:130, type:'money', amount:15_000_000_000},
    {level:140, type:'money', amount:20_000_000_000},
    {level:150, type:'pedestal', id:'sandy'},
    {level:160, type:'money', amount:25_000_000_000},
    {level:170, type:'money', amount:50_000_000_000},
    {level:180, type:'crate',  kind:'rare'},
    {level:190, type:'crate',  kind:'epic'},

    /* moved skipped rewards to extend past 200 */
    {level:200, type:'crate',  kind:'legendary'},       /* from 105 */
    {level:210, type:'randomItem', rarity:['Unique']},  /* from 115 */
    {level:220, type:'aquaegg', count:2},               /* from 125 */
    {level:230, type:'crate',  kind:'epic'},            /* from 135 */
    {level:240, type:'crate',  kind:'rare'},            /* from 145 */
    {level:250, type:'crate',  kind:'epic'},            /* from 155 */
    {level:260, type:'crate',  kind:'legendary'},       /* from 165 */
    {level:270, type:'aquaegg', count:1},               /* from 175 */
    {level:280, type:'money',  amount:100_000_000_000}, /* from 185 */
    {level:290, type:'randomItem', rarity:['Crypto']},  /* from 195 */

    /* Beach Vibes background moved from 200 -> 300 */
    {level:300, type:'background', id:'beachvibes'}
  ];

  function labelFor(r){
    if(r.type==='crate') return (r.kind.charAt(0).toUpperCase()+r.kind.slice(1)) + ' Crate';
    if(r.type==='money') return '$' + fmt(r.amount);
    if(r.type==='aquaegg') return 'Aqua Egg' + (r.count>1?` (x${r.count})`:'');
    if(r.type==='randomItem') return 'Random ' + r.rarity[0] + ' Item';
    if(r.type==='pedestal') return r.id==='sandy' ? 'Sandy Shores Pedestal' : 'Ocean Pedestal';
    if(r.type==='background') return 'Beach Vibes Background';
    return 'Reward';
  }

  function canClaim(r){
    const lvl = state.flexPass.level||1;
    if(r.level>100 && lvl<101) return false; // lock row2 until >100
    return lvl >= r.level && !state.flexPass.claimed['L'+r.level];
  }

  function claimReward(r){
    // mark first to avoid double-claim race
    state.flexPass.claimed['L'+r.level] = true;
    try{ save(); }catch(e){}
    // grant
    if(r.type==='crate'){ var _res = openCrate(r.kind); try{ showCrateReward(r.kind, _res); }catch(e){} }
    else if(r.type==='money'){ state.money += r.amount; try{ updateTop(); save(); }catch(e){} }
    else if(r.type==='aquaegg'){ grantEggs(r.count||1); }
    else if(r.type==='randomItem'){ pickItemByRarity(r.rarity||['Exotic']); }
    else if(r.type==='pedestal'){
      state.pedestalSkins = state.pedestalSkins || { default:true };
      if(r.id==='ocean'){ state.pedestalSkins.aqua = true; state.ach = state.ach || { questsDone:{} }; state.ach.aquaPedestalUnlocked = true; }
      if(r.id==='sandy'){ state.pedestalSkins.sandy = true; }
      try{ save(); }catch(e){}
    } else if(r.type==='background'){
      state.unlockedBackgrounds = state.unlockedBackgrounds || {};
      state.unlockedBackgrounds.beachvibes = true;
      try{ save(); }catch(e){}
    }
    // add XP for claiming
    updateRows();
  }

  function renderRow(host, list){
    host.innerHTML = '';
    const lvlNow = state.flexPass.level||1;
    for(const r of list){
      const el = document.createElement('div');
      el.className = 'flex-reward';
      if(r.level>100 && lvlNow<101) el.classList.add('locked');
      const img = rewardIconFor(r);
      el.innerHTML = ''
        + '<div class="img"><img src="'+img+'" alt=""></div>'
        + '<div style="font-weight:900; font-size:18px; text-shadow:0 1px 0 rgba(0,0,0,.2)">'+labelFor(r)+'</div>'
        + '<div class="lvl">'+r.level+'</div>';
      const b = document.createElement('button');
b.className = 'claim';
var __claimed = !!(state.flexPass && state.flexPass.claimed && state.flexPass.claimed['L'+r.level]);
if(__claimed){
  b.className += ' claimed';
  b.textContent = 'Claimed';
  b.disabled = true;
} else {
  b.textContent = canClaim(r) ? 'Claim' : ((r.level>100 && (state.flexPass.level||1) < 101) ? 'Locked' : 'Unreached');
  b.disabled = !canClaim(r);
}

      b.addEventListener('click', ()=>{
        try{ if(r && r.type==='money'){ var __imgEl = el && el.querySelector ? el.querySelector('.img img') : null; if(__imgEl){ __imgEl.classList.add('money-spin'); setTimeout(function(){ __imgEl.classList.remove('money-spin'); }, 1200); }} }catch(_){ } el.classList.add('crate-pop');
        setTimeout(()=>{
          claimReward(r);
        }, 500);
      });
      el.appendChild(b);
      host.appendChild(el);
    }
  }

  function updateRows(){ const r1=$('#flexRow1'), r2=$('#flexRow2'); if(r1) renderRow(r1, ROW1); if(r2) renderRow(r2, ROW2); }
  function openOverlay(){ $('#flexPassOverlay')?.classList.add('show'); updateHeader(); updateRows(); }
  function closeOverlay(){ $('#flexPassOverlay')?.classList.remove('show'); }

  // Button hookups
  document.addEventListener('click', (e)=>{
    const b = e.target.closest('#openFlexPass'); if(b){ openOverlay(); }
  });
  document.getElementById('closeFlexPass')?.addEventListener('click', closeOverlay);

  ;


  // Add XP hooks: buyEgg, pet hatch, shop purchases, quest completion marker
  (function hookPetHatchXP(){
    window.__udOnPetHatch = (function(prev){
      return function(petObj){
        try{ addXP(20,'hatch'); }catch(e){}
        if(typeof prev==='function') try{ prev(petObj); }catch(e){}
        // Dolphin multiplier special
        try{
          if(petObj && (petObj.petType==='Dolphin' || petObj.name==='Dolphin')){
            state.permanentPetMultiplier = Math.max( (state.permanentPetMultiplier||1), 2 );
            if(typeof recalcEPS==='function') recalcEPS();
          }
        }catch(e){}
      };
    })(window.__udOnPetHatch);
  })();

  // Try to give XP when clicking "Purchase" in shop
  (function hookShopClicks(){
    document.addEventListener('click', function(e){
      const b = e.target.closest('.shop .buy');
      if(!b) return;
      // Only award XP for purchases in the main Shop overlay, not the Pet Shop
      if (b.closest('#petOverlay')) return;
      if (!b.closest('#shopOverlay')) return;
      setTimeout(()=>{ try{ addXP(5,'buyItem'); }catch(_){} }, 0);
    });
  })();

  // Flex Shark morph loop: every 30 minutes, 50% to morph a random placed item (non-pet) with aqua
  ;(function aquaMorphLoop(){
    state.__aquaMorphTimers = state.__aquaMorphTimers || {};
    function step(){
      try{
        (state.petStands||[]).forEach((ps, idx)=>{
          if(!ps || (ps.petType!=='Flex Shark' && ps.name!=='Flex Shark')){ delete state.__aquaMorphTimers[idx]; return; }
          const now = Date.now();
          if(!state.__aquaMorphTimers[idx]){
            state.__aquaMorphTimers[idx] = now + (30*60*1000);
          }else if(now >= state.__aquaMorphTimers[idx]){
            state.__aquaMorphTimers[idx] = now + (30*60*1000);
            if(Math.random() < 0.50){
              const placedIds = (state.stands||[]).filter(Boolean);
              if(placedIds.length){
                const uidPick = placedIds[Math.floor(Math.random()*placedIds.length)];
                const it = state.placed[uidPick];
                if(it){
                  it.aqua = true;
                  if(typeof renderStands==='function') renderStands();
                  if(typeof recalcEPS==='function') recalcEPS();
                  if(typeof save==='function') save();
                }
              }
            }
          }
        });
      }catch(e){}
      setTimeout(step, 1000);
    }
    setTimeout(step, 1500);
  })();

  // Add AQUA tag + visuals to placed items
  (function tagAquaUI(){
    const orig = window.renderStands;
    window.renderStands = function(){
      if(typeof orig === 'function') orig.apply(this, arguments);
      try{
        const els = Array.from(document.querySelectorAll('.stands .stand'));
        (state.stands||[]).forEach((uid,i)=>{
          const host = els[i]; if(!host) return;
          const it = uid && state.placed[uid] || null; if(!it) return;
          const p = host.querySelector('.placed'); if(!p) return;
          if(it.aqua){
            // Ensure the aqua morph animation class is present
            p.classList.add('aqua-morph');
            // Add aqua ring to the item image if missing
            const wrap = p.querySelector('.img-wrap');
            if(wrap && !wrap.querySelector('.aqua-ring')){
              const aq = document.createElement('span');
              aq.className = 'aqua-ring';
              wrap.appendChild(aq);
            }
          } else {
            // Remove the aqua morph animation class and ring when not aqua
            p.classList.remove('aqua-morph');
            const ring = p.querySelector('.aqua-ring'); if(ring) ring.remove();
          }
        });
      }catch(e){}
    };
    setTimeout(()=>{ try{ renderStands(); }catch(e){} }, 0);
  })();

  // Pedestal overlay extension: add Sandy Shores when unlocked
  (function extendPedestals(){
    const injectTile = function(){
      try{
        const grid = document.querySelector('.ped-grid'); if(!grid) return;
        if(grid.querySelector('[data-sandy]')) return;
        const unlocked = !!((state.pedestalSkins||{}).sandy);
        const sel = String(state.selectedPedestalSkin)==='sandy';
        const el = document.createElement('div');
        el.setAttribute('data-sandy','1');
        el.className='ped-tile' + (unlocked?'':' locked');
        el.style.background = "radial-gradient(1.5px 1.5px at 10% 20%, rgba(140,110,60,0.20) 0 40%, transparent 45%)," +
"radial-gradient(1.2px 1.2px at 22% 38%, rgba(120,95,55,0.20) 0 40%, transparent 45%)," +
"radial-gradient(1.4px 1.4px at 35% 52%, rgba(150,120,75,0.20) 0 40%, transparent 45%)," +
"radial-gradient(1.2px 1.2px at 64% 28%, rgba(100,80,50,0.20) 0 40%, transparent 45%)," +
"radial-gradient(1.4px 1.4px at 74% 48%, rgba(130,100,60,0.20) 0 40%, transparent 45%)," +
"radial-gradient(1.3px 1.3px at 86% 36%, rgba(110,90,55,0.20) 0 40%, transparent 45%)," +
"radial-gradient(10px 7px at 20% 78%, rgba(110,90,70,0.35) 0 60%, rgba(110,90,70,0.00) 65%)," +
"radial-gradient(8px 6px at 44% 74%, rgba(95,80,60,0.32) 0 60%, rgba(95,80,60,0.00) 65%)," +
"radial-gradient(9px 7px at 71% 82%, rgba(125,105,85,0.35) 0 60%, rgba(125,105,85,0.00) 65%)," +
"radial-gradient(7px 5px at 83% 70%, rgba(80,70,60,0.32) 0 60%, rgba(80,70,60,0.00) 65%)," +
"linear-gradient(6deg, rgba(255,255,255,0.10) 20%, rgba(255,255,255,0.00) 22% 78%, rgba(0,0,0,0.05) 80%)," +
"linear-gradient(180deg,#ffe6a1 0%, #ffd788 55%, #e6bb62 100%)";
        el.innerHTML = '<div style="font-weight:900">Sandy Shores</div>'
                     + '<button class="buy ped-apply" '+((!unlocked||sel)?'disabled':'')+'>Equip</button>';
        if(unlocked){
          el.querySelector('.ped-apply').onclick = function(){ state.selectedPedestalSkin='sandy'; try{ applyPedestalSkin(); save(); }catch(e){}; try{ this.disabled=true; }catch(e){}; try{ window.__renderPedestalPage && window.__renderPedestalPage(); }catch(e){}; };
        }
        grid.appendChild(el);
      }catch(e){}
    };
    // Hook to the render function if available
    window.__renderPedestalPage = (function(prev){
      return function(){ if(typeof prev==='function') prev(); injectTile(); };
    })(window.__renderPedestalPage);
    // Fallback observer
    new MutationObserver(()=> injectTile()).observe(document.body,{childList:true,subtree:true});
    // Extend apply
    const prevApply = window.applyPedestalSkin;
    window.applyPedestalSkin = function(){
      if(typeof prevApply === 'function') prevApply.apply(this, arguments);
      try{ document.body.classList.toggle('sandy-pedestals', String(state.selectedPedestalSkin)==='sandy'); }catch(e){}
    };
  })()
  // Pedestal overlay extension: add Ocean pedestal when unlocked
  (function extendOceanPedestal(){
    const injectTile = function(){
      try{
        const grid = document.querySelector('.ped-grid'); if(!grid) return;
        if(grid.querySelector('[data-ocean]')) return;
        const unlocked = !!((state.pedestalSkins||{}).aqua || (state.pedestalSkins||{}).ocean);
        const sel = String(state.selectedPedestalSkin)==='aqua';
        const el = document.createElement('div');
        el.setAttribute('data-ocean','1');
        el.className='ped-tile' + (unlocked?'':' locked');
        // Ocean wave look
        el.style.background = "radial-gradient(60% 180% at 15% 120%, rgba(255,255,255,0.60) 12%, rgba(255,255,255,0) 13%)," +
"radial-gradient(60% 180% at 45% 120%, rgba(255,255,255,0.50) 12%, rgba(255,255,255,0) 13%)," +
"radial-gradient(60% 180% at 75% 120%, rgba(255,255,255,0.55) 12%, rgba(255,255,255,0) 13%)," +
"repeating-linear-gradient(-12deg, rgba(255,255,255,0.18) 0 6px, rgba(255,255,255,0.00) 6px 26px)," +
"linear-gradient(180deg,#34d2e8 0%, #9be9ff 28%, #53bfff 60%, #0a4cbf 100%)";
        el.innerHTML = '<div style="font-weight:900">Ocean Pedestal</div>'
                     + '<button class="buy ped-apply" '+((!unlocked||sel)?'disabled':'')+'>Equip</button>';
        if(unlocked){
          el.querySelector('.ped-apply').onclick = function(){ state.selectedPedestalSkin='aqua'; try{ applyPedestalSkin(); save(); }catch(e){}; try{ this.disabled=true; }catch(e){}; try{ window.__renderPedestalPage && window.__renderPedestalPage(); }catch(e){}; };
        }
        grid.appendChild(el);
      }catch(e){}
    };
    // Hook to the render function if available
    window.__renderPedestalPage = (function(prev){
      return function(){ if(typeof prev==='function') prev(); injectTile(); };
    })(window.__renderPedestalPage);
    // Also try once on load
    setTimeout(()=>{ try{ injectTile(); }catch(e){} }, 0);
  })()
  // Reorder pedestal tiles into a consistent 2-per-row layout and desired order
  (function ensurePedestalOrder(){
    function titleMatch(el, text){
      try{ return el && String(el.textContent||'').toLowerCase().indexOf(text.toLowerCase())>=0; }catch(e){ return false; }
    }
    function reorder(){
      function setPos(el,row,col){ try{ el.style.gridRow=String(row); el.style.gridColumn=String(col); }catch(e){} }

      try{
        const grid = document.querySelector('.ped-grid'); if(!grid) return;
        const tiles = Array.from(grid.children);
        const find = (label)=> tiles.find(t=>titleMatch(t,label)) || grid.querySelector('[data-'+label.toLowerCase().replace(/\s+/g,'')+']');
        const orderLabels = [
          'Default (Gold)','Red Pedestal',
          'Light/Dark Blue','Strange Pedestals',
          'Snowy Pedestal','Sandy Shores',
          'Ocean Pedestal','Red Carpet'
        ];
        const desired = [];
        orderLabels.forEach(l=>{
          let el = tiles.find(t=>titleMatch(t,l));
          if(!el){
            if(l==='Sandy Shores') el = grid.querySelector('[data-sandy]');
            if(l==='Ocean Pedestal') el = grid.querySelector('[data-ocean]');
            if(l==='Snowy Pedestal') el = grid.querySelector('[data-snowyped], [data-snowy]');
          }
          if(el) desired.push(el);
        });
        // Append desired in order
        desired.forEach((el,idx)=>{
          // compute row/col for first 4 rows
          const map = {
            'Default (Gold)': [1,1], 'Red Pedestal':[1,2],
            'Light/Dark Blue':[2,1], 'Strange Pedestals':[2,2],
            'Snowy Pedestal':[3,1], 'Sandy Shores':[3,2],
            'Ocean Pedestal':[4,1], 'Red Carpet':[4,2]
          };
          const label = (el.textContent||'').trim();
          if(map[label]) setPos(el, map[label][0], map[label][1]);
          grid.appendChild(el);
        });
      }catch(e){}
    }
    window.__renderPedestalPage = (function(prev){
      return function(){ if(typeof prev==='function') prev(); reorder(); };
    })(window.__renderPedestalPage);
    document.addEventListener('DOMContentLoaded', ()=> setTimeout(reorder, 0));
  })()
  // Strict ordering for pedestals grid (2 per row)
  (function strictPedestalOrder(){
    function textOf(el){ try{ return (el && (el.textContent||'')).trim(); }catch(e){ return ''; } }
    function matches(el, label){ return textOf(el).toLowerCase().indexOf(label.toLowerCase())>=0; }
    function reorder(){
      function setPos(el,row,col){ try{ el.style.gridRow=String(row); el.style.gridColumn=String(col); }catch(e){} }

      try{
        const grid = document.querySelector('.ped-grid'); if(!grid) return;
        const tiles = Array.from(grid.children);
        const findByLabel = (label)=> tiles.find(t=>matches(t,label));
        const order = [
          'Default (Gold)','Red Pedestal',
          'Light/Dark Blue','Strange Pedestals',
          'Snowy Pedestal','Sandy Shores',
          'Ocean Pedestal','Red Carpet'
        ];
        const desired = [];
        order.forEach(l=>{
          let el = tiles.find(t=>matches(t,l));
          if(!el){
            if(l==='Sandy Shores') el = grid.querySelector('[data-sandy]');
            if(l==='Ocean Pedestal') el = grid.querySelector('[data-ocean]');
          }
          if(el) desired.push(el);
        });
        // Append in the desired sequence, then anything else afterwards
        desired.forEach((el,idx)=>{
          // compute row/col for first 4 rows
          const map = {
            'Default (Gold)': [1,1], 'Red Pedestal':[1,2],
            'Light/Dark Blue':[2,1], 'Strange Pedestals':[2,2],
            'Snowy Pedestal':[3,1], 'Sandy Shores':[3,2],
            'Ocean Pedestal':[4,1], 'Red Carpet':[4,2]
          };
          const label = (el.textContent||'').trim();
          if(map[label]) setPos(el, map[label][0], map[label][1]);
          grid.appendChild(el);
        });
        tiles.forEach(el=>{ if(!desired.includes(el)) grid.appendChild(el); });
      }catch(e){}
    }
    window.__renderPedestalPage = (function(prev){
      return function(){ if(typeof prev==='function') prev(); reorder(); };
    })(window.__renderPedestalPage);
    document.addEventListener('DOMContentLoaded', ()=> setTimeout(reorder, 0));
  })();
;
;
;


  // Backgrounds overlay: Beach Vibes tile
  (function extendBgGridForBeach(){
    const render = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if(typeof render === 'function') render();
      try{
        const g = document.querySelector('.bg-tiles'); if(!g) return;
        if(g.querySelector('[data-beachvibes]')) return;
        const el = document.createElement('div');
        el.setAttribute('data-beachvibes','1');
        const unlocked = !!((state.unlockedBackgrounds||{}).beachvibes);
        el.className = 'bg-tile' + (!unlocked ? ' locked' : '');
        el.style.cssText = "background:url('background_files/beach_vibes.png') center/cover no-repeat;border-color:#006c91;";
        el.innerHTML = '<div style=\"font-weight:900;text-shadow:0 2px 0 #000\">Beach Vibes</div>'
          + '<button class=\"buy bg-apply\" '+(!unlocked?'disabled':'')+'>Apply</button>';
        el.querySelector('.bg-apply').onclick = function(){
          if(!((state.unlockedBackgrounds||{}).beachvibes)) return;
          document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-crypto','bg-dodger','redblue','bg-hawkins','bg-sunrise','bg-greatwave','bg-upsidedown','bg-winter');
          document.body.style.background = '';
          document.body.classList.add('bg-beachvibes');
          try{ state.selectedBackground = 'beachvibes'; save(); }catch(e){}
        };
        g.appendChild(el);
      }catch(e){}
    };
    setTimeout(()=>{ try{ window.__renderBgGrid && window.__renderBgGrid(); }catch(e){} }, 0);
  })()
  // Ensure Beach Vibes appears by forcing a background grid refresh on open
  (function bgOverlayRefresh(){
    const open = document.getElementById('openBackgrounds');
    if(open){
      open.addEventListener('click', function(){
        setTimeout(()=>{ try{ window.__renderBgGrid && window.__renderBgGrid(); }catch(e){} }, 50);
      });
    }
  })();
;

  // Render the pass rows on open
  function onOpen(){ updateHeader(); updateRows(); }
  document.getElementById('openFlexPass')?.addEventListener('click', function(){
    document.getElementById('flexPassOverlay')?.classList.add('show');
    onOpen();
  });
  document.getElementById('closeFlexPass')?.addEventListener('click', function(){
    document.getElementById('flexPassOverlay')?.classList.remove('show');
  });

  // Initial update
  setTimeout(updateHeader, 0);
})();
</script>

<!-- ===== POTION BREWER: UI + LOGIC (Flex v1.90) ===== -->
<style>
  /* Brewer toolbar button */
  #brewOpenBtn{
    width:64px; height:64px; border-radius:18px;
    display:grid; place-items:center;
    background:#a78bfa; border:4px solid rgba(0,0,0,.4);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    cursor:pointer; display:none;
  }
  #brewOpenBtn img{ width:70%; height:70%; object-fit:contain; }

  /* Brewer overlay */
  #brewOverlay{ display:none !important; background:transparent !important; -webkit-backdrop-filter:none !important; pointer-events:none; }
  #brewOverlay.show{ display:block !important; pointer-events:auto; }

  #brewOverlay .sheet{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background: rgba(0,0,0,.35); backdrop-filter: blur(8px);
  }
  #brewOverlay .panel{
    width:min(1100px, 92vw); height:min(640px, 88vh);
    border-radius: 28px;
    border: 6px solid rgba(0,0,0,.35);
    background: linear-gradient(180deg, #9b5de5 0%, #6a00f4 40%, #ea8ded 88%);
    padding: 20px 22px; color: #fff; position:relative;
    box-shadow: 0 20px 60px rgba(0,0,0,.45);
  }
  #brewOverlay h2{
    text-align:center; font-family:'Bungee', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    font-size: clamp(24px, 3.6vw, 44px); letter-spacing: 1px; margin: 6px 0 10px 0;
    text-shadow: 0 2px 0 rgba(0,0,0,.35);
  }
  .brew-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 22px; align-items:stretch; }
  .brew-left{ display:flex; flex-direction:column; gap: 12px; }
  .brew-right{ display:flex; flex-direction:column; gap: 12px; }

  .slotTitle{ font-weight:900; font-size:18px; letter-spacing:1px; opacity:.95; }
  .brew-slot{
    width: 160px; height: 160px; border-radius: 20px;
    border: 6px solid rgba(255,255,255,.85);
    background: linear-gradient(180deg, #f4a742, #7a3e00);
    display:grid; place-items:center; overflow:hidden;
    box-shadow: inset 0 0 0 4px rgba(0,0,0,.18);
    cursor: pointer;
  }
  .brew-slot img{ width: 100%; height: 100%; object-fit: contain; }

  .slot-unique{ background: linear-gradient(180deg, #043d7a, #000c28); }
  .slot-rarity{ background: linear-gradient(180deg, #ffd86a, #7a4d00); }
  .brew-mid-arrow{ align-self:center; width: 140px; height: 10px; border-radius:6px; background: repeating-linear-gradient(90deg, rgba(255,0,0,.7) 0 16px, rgba(255,0,0,.3) 16px 32px); filter: blur(.25px); }

  .brew-progress{
    display:flex; align-items:center; gap:10px; margin-top: 8px;
  }
  #brewBar{
    width: 100%; height: 18px; border-radius: 12px;
    background: rgba(255,255,255,.25); overflow:hidden; border: 4px solid rgba(0,0,0,.35);
  }
  #brewBar > span{ display:block; height:100%; width:0%; background: linear-gradient(90deg,#50fa7b,#20c997); transition: width .2s linear; }

  #brewTimer{ font-weight:900; letter-spacing:1px; font-size:16px; background:rgba(0,0,0,.25); padding:4px 10px; border-radius:10px; }

  .brew-actions{ display:flex; gap:12px; align-items:center; }
  #brewStart{
    padding: 14px 22px; font-weight:900; letter-spacing:1px; border-radius:16px; border:0;
    background: linear-gradient(#3ad178,#1ba75a); color:#062e16; cursor:pointer;
    box-shadow: var(--shadow, 0 10px 30px rgba(0,0,0,.35));
  }
  #brewStart:disabled{ filter:grayscale(1) brightness(.7); cursor:not-allowed; }
  .closeBrew{ position:absolute; right:16px; top:16px; width:44px; height:44px; border-radius:50%; border:0; cursor:pointer; font-weight:900; }

  /* Badges next to multiplier for active potions */
  #potionBadges{ display:flex; gap:8px; align-items:center; }
  .pBadge{
    padding:2px 8px; border-radius:12px; border:2px solid rgba(0,0,0,.35);
    background:#fff; color:#111; font-weight:900; letter-spacing:.5px; font-size:14px;
  }
</style>

<!-- Toolbar button is injected via JS if brewer purchased -->

<!-- Brewer Overlay Markup -->
<div aria-hidden="true" class="overlay" id="brewOverlay">
  <!-- The sheet container uses flexbox to align the brewer panel near the top,
       mirroring the forge overlay layout.  We explicitly set display, justify
       and align properties here so that inline styles override any prior CSS. -->
  <div class="sheet" style="display:flex; justify-content:center; align-items:flex-start;">
    <!-- The panel itself adopts the same width and bottom margin as the forge
         window.  Height is allowed to autoâ€‘size based on content.  Setting
         position:relative and removing transforms ensures the panel sits
         directly beneath the money banner instead of being vertically
         centered. -->
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="brewTitle"
         style="/* Reduce overall width significantly so the brewer fits on narrower screens */
                width:min(860px,90%);
                /* Allow the brewer to grow vertically to fit its contents and remove internal scrolling */
                height:auto;
                /* Raise the brewer to sit just below the money banner */
                /* Reduced from 100px to bring the panel closer to the money banner */
                margin-top:60px;
                margin-bottom:160px;
                position:relative;
                top:0;
                left:0;
                transform:none;">
      <button class="closeX closeBrew" aria-label="Close Brewer">âœ•</button>
      <h2 id="brewTitle">POTION BREWER</h2>
      <div class="brew-grid">
        <!-- === Brewer Recipes Panel (left-side) === -->
        <aside class="brew-recipes" id="brewRecipes" aria-label="Potion Recipes">
          <div class="recipes-title">RECIPES</div>

          <div class="recipe-card">
            <div class="recipe-head">
              <img class="recipe-icon" src="potions/multiplier_x2_potion.png" alt="Multiplier x2 Potion">
              <div class="recipe-name">Multiplier x2</div>
            </div>
            <div class="recipe-steps">
              <span class="chip fuel">Fuel</span>
              <span class="plus">+</span>
              <span class="chip unique">Unique</span>
              <span class="plus">+</span>
              <span class="chip other legendary">Legendary item</span>
            </div>
            <div class="recipe-note">Duration: 5 min</div>
          </div>

          <div class="recipe-card">
            <div class="recipe-head">
              <img class="recipe-icon" src="potions/multiplier_x4_potion.png" alt="Multiplier x4 Potion">
              <div class="recipe-name">Multiplier x4</div>
            </div>
            <div class="recipe-steps">
              <span class="chip fuel">Fuel</span>
              <span class="plus">+</span>
              <span class="chip unique">Unique</span>
              <span class="plus">+</span>
              <span class="chip other potion">Potion: Multiplier x2</span>
            </div>
            <div class="recipe-note">Duration: 7 min</div>
          </div>

          <div class="recipe-card">
            <div class="recipe-head">
              <img class="recipe-icon" src="potions/multiplier_x6_potion.png" alt="Multiplier x6 Potion">
              <div class="recipe-name">Multiplier x6</div>
            </div>
            <div class="recipe-steps">
              <span class="chip fuel">Fuel</span>
              <span class="plus">+</span>
              <span class="chip unique">Unique</span>
              <span class="plus">+</span>
              <span class="chip other potion">Potion: Multiplier x4</span>
            </div>
            <div class="recipe-note">Duration: 10 min</div>
          </div>

          <div class="recipe-card">
            <div class="recipe-head">
              <img class="recipe-icon" src="potions/shop_luck_potion.png" alt="Shop Luck Potion">
              <div class="recipe-name">Shop Luck</div>
            </div>
            <div class="recipe-steps">
              <span class="chip fuel">Fuel</span>
              <span class="plus">+</span>
              <span class="chip unique">Unique</span>
              <span class="plus">+</span>
              <span class="chip other legacy">Legacy item</span>
            </div>
            <div class="recipe-note">Duration: 5 min</div>
          </div>

          <div class="recipe-card">
            <div class="recipe-head">
              <img class="recipe-icon" src="potions/fast_hatch_potion.png" alt="Fast Hatch Potion">
              <div class="recipe-name">Fast Hatch</div>
            </div>
            <div class="recipe-steps">
              <span class="chip fuel">Fuel</span>
              <span class="plus">+</span>
              <span class="chip unique">Unique</span>
              <span class="plus">+</span>
              <span class="chip other exotic">Exotic item</span>
            </div>
            <div class="recipe-note">Duration: 15 min</div>
          </div>

          <div class="recipe-card">
            <div class="recipe-head">
              <img class="recipe-icon" src="potions/shop_refresh_potion.png" alt="Shop Refresh Potion">
              <div class="recipe-name">Shop Refresh</div>
            </div>
            <div class="recipe-steps">
              <span class="chip fuel">Fuel</span>
              <span class="plus">+</span>
              <span class="chip unique">Unique</span>
              <span class="plus">+</span>
              <span class="chip other crypto">Crypto item</span>
            </div>
            <div class="recipe-note">Instant effect</div>
          </div>

          <div class="fuels-key">
            <img src="potions/fuels/coal.png" alt="Coal">
            <img src="potions/fuels/flame.png" alt="Flame">
            <img src="potions/fuels/gunpowder.png" alt="Gunpowder">
            <span>Any fuel works</span>
          </div>
        </aside>
        <!-- === End Brewer Recipes Panel === -->
        
        <div class="brew-left">
          <div class="slotTitle">FUEL</div>
          <div class="brew-slot" id="brewFuel"></div>

          <div class="slotTitle">PROGRESS</div>
          <div class="brew-progress">
            <div id="brewBar"><span></span></div>
            <div id="brewTimer">0:00</div>
          </div>
        </div>

        <div class="brew-right">
          <div class="slotTitle">UNIQUE</div>
          <div class="brew-slot slot-unique" id="brewUnique"></div>

          <div class="slotTitle">RARITY / SPECIAL</div>
          <div class="brew-slot slot-rarity" id="brewOther"></div>

          <div class="brew-actions" style="margin-top:12px;">
            <button id="brewStart">START BREW</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // Utilities
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmt = (n)=>{
    try{ return Number(n).toLocaleString('en-US'); }catch(e){ return String(n); }
  };

  // ---- Extend rarities for fuels and potions (for inventory badges) ----
  try{
    if (window.RARITY) {
      RARITY.fuel   = RARITY.fuel   || { label:'FUEL',   color:'#ffb454', income:0, price:[2_500_000,3_500_000], prob:0 };
      RARITY.potion = RARITY.potion || { label:'POTION', color:'#d76eff', income:0, price:[0,0], prob:0 };
    }
  }catch(e){}

  // ---- Global Brewer / Potion state ----
  window.state = window.state || {};
  state.brewer = state.brewer || { owned:false, active:null }; // active: {name, icon, endsAt, startedAt, duration}
  state.activePotions = state.activePotions || { // timers (ms since epoch)
    multiplier: { until:0, factor:1 },
    shopLuckUntil: 0,
    fastHatchUntil: 0
  };

  // Ensure save carries our new fields
  try{
    const _save = window.save;
    window.save = function(){
      try{
        state.brewer = state.brewer || { owned:false, active:null };
        state.activePotions = state.activePotions || { multiplier:{until:0,factor:1}, shopLuckUntil:0, fastHatchUntil:0 };
      }catch(e){}
      return _save.apply(this, arguments);
    };
  }catch(e){}

  // ---- Add Potion Brewer card to Gear overlay ----
  function insertBrewerCard(){
    const gear = $('#gearOverlay .grid');
    if(!gear || $('#brewerCard')) return;
    const card = document.createElement('div');
    card.className = 'card';
    card.id = 'brewerCard';
    card.innerHTML = `
      <h3>Potion Brewer</h3>
      <div style="font-size:18px; opacity:0.9;">Craft potions using a Fuel + UNIQUE + another rarity.<br/>Requires Rebirth Level 5.</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
        <div class="price">$100,000,000,000</div>
        <button class="buy" id="buyBrewer">Purchase</button>
      </div>
      <div id="brewerReq" style="margin-top:6px;font-weight:800;">
        <span id="brewLvlCheck" style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#e74c3c;color:#fff;text-align:center;line-height:18px;margin-right:8px;">âœ–</span>
        Requires Level 5 Rebirth
      </div>
    `;
    gear.appendChild(card);
    const btn = card.querySelector('#buyBrewer');
    function refresh(){
      const hasLvl = (state.rebirthLevel||0) >= 5;
      const cost = 100_000_000_000;
      $('#brewLvlCheck').textContent = hasLvl ? 'âœ“' : 'âœ–';
      $('#brewLvlCheck').style.background = hasLvl ? '#2ecc71' : '#e74c3c';
      if (state.brewer.owned){
        btn.disabled = true; btn.textContent = 'Purchased!'; btn.style.background = 'linear-gradient(#2ecc71,#1da85b)';
      } else {
        btn.disabled = !(hasLvl && state.money >= cost);
        btn.textContent = 'Purchase';
        btn.style.background = '';
      }
    }
    btn.addEventListener('click', ()=>{
      const cost = 100_000_000_000;
      if (state.brewer.owned) return;
      if ((state.rebirthLevel||0) < 5) return;
      if (state.money < cost) return;
      state.money -= cost;
      state.brewer.owned = true;
      try{ writeOwned(true); }catch(e){}
      try{ __writeBackupNow(); 
      try{
        const __pendingKey = 'flex_brewer_pending_server_save__' + (typeof getPlayerId==='function' ? getPlayerId() : (state.username||state.userName||'default'));
        if (typeof __loadComplete === 'boolean' && !__loadComplete) localStorage.setItem(__pendingKey, '1');
        else localStorage.removeItem(__pendingKey);
      }catch(e){}       
}catch(e){}
      showBrewButton();
      if (typeof updateTop==='function') updateTop();
      if (typeof save==='function') save();
      refresh();
    });
    // keep in sync when opening
    refresh();
  }

  
// --- Keep Brewer purchase card eligibility in sync with Rebirth changes ---
(function(){
  function refreshBrewerCard(){
    try{
      const btn = document.getElementById('buyBrewer');
      const chk = document.getElementById('brewLvlCheck');
      if (!btn || !chk) return;
      const hasLvl = (state.rebirthLevel||0) >= 5;
      const cost = 100_000_000_000;
      chk.textContent = hasLvl ? 'âœ“' : 'âœ–';
      chk.style.background = hasLvl ? '#2ecc71' : '#e74c3c';
      if (state.brewer && state.brewer.owned) {
        btn.disabled = true; btn.textContent = 'Purchased!'; btn.style.background = 'linear-gradient(#2ecc71,#1da85b)';
      } else {
        btn.disabled = !(hasLvl && (state.money||0) >= cost);
        btn.textContent = 'Purchase';
        btn.style.background = '';
      }
    }catch(e){}
  }
  try{
    // Patch updateRebirthUI to also refresh the brewer card
    if (typeof window.updateRebirthUI === 'function' && !window.updateRebirthUI.__brewerRefreshPatched){
      const _u = window.updateRebirthUI;
      window.updateRebirthUI = function(){ const r = _u.apply(this, arguments); try{ refreshBrewerCard(); }catch(_){} return r; };
      window.updateRebirthUI.__brewerRefreshPatched = true;
    }
  }catch(e){}
  // Also refresh once after load and on money updates
  window.addEventListener('load', ()=>{ setTimeout(refreshBrewerCard, 0); });
  document.addEventListener('money:update', refreshBrewerCard);
})();// ---- Toolbar button (above Forge) ----
  
// --- Ensure the toolbar Brewer button exists & is visible when owned ---
function ensureBrewButtonVisible(){
  try{
    window.state = window.state || {};
    state.brewer = state.brewer || { owned:false, active:null };
    if (!state.brewer.owned) return;
    if (typeof showBrewButton === 'function') showBrewButton();
  }catch(e){}
}
function showBrewButton(){
    const bar = document.getElementById('toolBarArea');
    if(!bar) return;
    let btn = document.getElementById('brewOpenBtn');
    if(!btn){
      btn = document.createElement('button');
      btn.id = 'brewOpenBtn';
      btn.title = 'Potion Brewer';
      btn.innerHTML = "<img alt='Brew' src='icons/potion_brewer_icon.png'/>";
      // Insert *after* forge so with column-reverse it appears above
      bar.appendChild(btn);
      btn.addEventListener('click', openBrew);
    }
    btn.style.display = state.brewer.owned ? 'grid' : 'none';
  }

  // ---- Overlay open/close ----
  function openBrew(){ const o = $('#brewOverlay'); o.classList.add('show'); o.setAttribute('aria-hidden','false'); renderBrew(); }
  function closeBrew(){ const o = $('#brewOverlay'); o.classList.remove('show'); o.setAttribute('aria-hidden','true'); }
  $('.closeBrew')?.addEventListener('click', closeBrew);

  // ---- Slots ----
  let brewSlots = { fuel:null, unique:null, other:null }; // inventory objects

  function isFuel(it){
    const n = String(it?.name||'').toLowerCase();
    if (String(it?.rarity||'').toLowerCase()==='fuel') return true;
    return n==='coal' || n==='gunpowder' || n==='flame';
  }
  function isUnique(it){ return String(it?.rarity||'').toLowerCase()==='unique'; }
  function isPotion(it){ return String(it?.rarity||'').toLowerCase()==='potion'; }

  function renderBrewSlots(){
    $('#brewFuel').innerHTML   = brewSlots.fuel   ? `<img src="${brewSlots.fuel.svg}" alt="${brewSlots.fuel.name}">` : '';
    $('#brewUnique').innerHTML = brewSlots.unique ? `<img src="${brewSlots.unique.svg}" alt="${brewSlots.unique.name}">` : '';
    $('#brewOther').innerHTML  = brewSlots.other  ? `<img src="${brewSlots.other.svg}" alt="${brewSlots.other.name}">` : '';
    updateBrewButton();
  }

  // Clicking a slot either places currently selected inventory item OR returns item to inventory
  function attachSlotHandlers(){
    function grab(uid){
      try{
        const idx = (state.inventory||[]).findIndex(x=>x && x.uid===uid);
        if(idx>=0) return state.inventory.splice(idx,1)[0];
      }catch(e){}
      return null;
    }
    $('#brewFuel').onclick = ()=>{
      const sel = state.selectedItemUid;
      if (sel){
        const obj = (state.inventory||[]).find(x=>x && x.uid===sel);
        if (obj && isFuel(obj)){
          if (brewSlots.fuel) state.inventory.push(brewSlots.fuel);
          brewSlots.fuel = grab(sel) || obj;
          state.selectedItemUid = null;
          if(typeof renderInventory==='function') renderInventory();
          renderBrewSlots();
        }
      }else if(brewSlots.fuel){
        state.inventory.push(brewSlots.fuel); brewSlots.fuel=null; renderInventory(); renderBrewSlots();
      }
    };
    $('#brewUnique').onclick = ()=>{
      const sel = state.selectedItemUid;
      if (sel){
        const obj = (state.inventory||[]).find(x=>x && x.uid===sel);
        if (obj && isUnique(obj)){
          if (brewSlots.unique) state.inventory.push(brewSlots.unique);
          brewSlots.unique = grab(sel) || obj;
          state.selectedItemUid = null;
          if(typeof renderInventory==='function') renderInventory();
          renderBrewSlots();
        }
      }else if(brewSlots.unique){
        state.inventory.push(brewSlots.unique); brewSlots.unique=null; renderInventory(); renderBrewSlots();
      }
    };
    $('#brewOther').onclick = ()=>{
      const sel = state.selectedItemUid;
      if (sel){
        const obj = (state.inventory||[]).find(x=>x && x.uid===sel);
        const rk = String(obj?.rarity||'').toLowerCase();
        const ok = rk==='legendary' || rk==='legacy' || rk==='exotic' || rk==='crypto' || (rk==='potion' && /multiplier x[24] potion/i.test(String(obj?.name||'')));
        if (obj && ok){
          if (brewSlots.other) state.inventory.push(brewSlots.other);
          brewSlots.other = grab(sel) || obj;
          state.selectedItemUid = null;
          if(typeof renderInventory==='function') renderInventory();
          renderBrewSlots();
        }
      }else if(brewSlots.other){
        state.inventory.push(brewSlots.other); brewSlots.other=null; renderInventory(); renderBrewSlots();
      }
    };
  }

  function brewResultFor(fuel, unique, other){
    if(!fuel || !unique || !other) return null;
    const rk = String(other.rarity||'').toLowerCase();
    const name = String(other.name||'');
    if (rk==='legendary') return { name:'Multiplier x2 Potion', icon:'potions/multiplier_x2_potion.png', type:'potion', minutes:5, kind:'mult', factor:2 };
    if (rk==='potion' && /multiplier x2 potion/i.test(name)) return { name:'Multiplier x4 Potion', icon:'potions/multiplier_x4_potion.png', type:'potion', minutes:7, kind:'mult', factor:4 };
    if (rk==='potion' && /multiplier x4 potion/i.test(name)) return { name:'Multiplier x6 Potion', icon:'potions/multiplier_x6_potion.png', type:'potion', minutes:10, kind:'mult', factor:6 };
    if (rk==='legacy') return { name:'Shop Luck Potion', icon:'potions/shop_luck_potion.png', type:'potion', minutes:5, kind:'luck' };
    if (rk==='exotic') return { name:'Fast Hatch Potion', icon:'potions/fast_hatch_potion.png', type:'potion', minutes:15, kind:'hatch' };
    if (rk==='crypto') return { name:'Shop Refresh Potion', icon:'potions/shop_refresh_potion.png', type:'potion', minutes:0, kind:'refresh' };
    return null;
  }

  const FUEL_TIME = {
    'coal': 2*60 + 30,      // 2:30
    'gunpowder': 2*60,      // 2:00
    'flame': 60             // 1:00
  };
  function getFuelSeconds(f){
    const k = String((f?.name||'').toLowerCase());
    return FUEL_TIME[k] || 120;
  }

  function updateBrewButton(){
    const r = brewResultFor(brewSlots.fuel, brewSlots.unique, brewSlots.other);
    const btn = $('#brewStart');
    btn.disabled = !r || !!state.brewer.active;
    btn.title = r ? ('Brew ' + r.name) : 'Select a valid recipe';
  }

  function renderBrew(){
    attachSlotHandlers();
    renderBrewSlots();
    renderBrewProgress();
  }

  function startBrew(){
    const res = brewResultFor(brewSlots.fuel, brewSlots.unique, brewSlots.other);
    if(!res) return;
    const sec = getFuelSeconds(brewSlots.fuel);
    // consume inputs
    brewSlots = { fuel:null, unique:null, other:null };
    // create active brew
    const now = Date.now();
    state.brewer.active = {
      result: res,
      startedAt: now,
      endsAt: now + sec*1000,
      duration: sec*1000
    };
    if(typeof renderInventory==='function') renderInventory();
    if(typeof save==='function') save();
    renderBrewProgress();
  }
  $('#brewStart').addEventListener('click', startBrew);

  function renderBrewProgress(){
    const prog = $('#brewBar > span');
    const timer = $('#brewTimer');
    const act = state.brewer.active;
    if(!act){
      prog.style.width = '0%';
      timer.textContent = '0:00';
      updateBrewButton();
      return;
    }
    const now = Date.now();
    const left = Math.max(0, act.endsAt - now);
    const pct = Math.min(100, Math.round(100 * (1 - left / act.duration)));
    prog.style.width = pct + '%';
    const s = Math.ceil(left/1000); const m = Math.floor(s/60); const ss = String(s%60).padStart(2,'0');
    timer.textContent = `${m}:${ss}`;
    updateBrewButton();
  }

  // Global tick for brewer + potions
  setInterval(()=>{
    try{
      // Brewer tick
      if(state.brewer && state.brewer.active){
        if(Date.now() >= state.brewer.active.endsAt){
          const res = state.brewer.active.result;
          state.brewer.active = null;
          // give item
          state.inventory.push({ uid: (Math.random().toString(36).slice(2)+Date.now().toString(36)), name: res.name, rarity:'potion', price:0, baseIdx:-1, svg: res.icon });
          if(typeof renderInventory==='function') renderInventory();
          if(typeof save==='function') save();
          try{
  if (/^Multiplier x6 Potion/i.test(res.name)){
    window.state = window.state || {};
    state.flexwood = state.flexwood || {};
    state.flexwood.top2 = state.flexwood.top2 || {};
    state.flexwood.top2.x6Brewed = (state.flexwood.top2.x6Brewed||0) + 1;
    if(typeof save==='function') save();
    if(typeof renderFlexwood==='function') renderFlexwood();
  }
}catch(e){}
showToast(`${res.name} is complete!`);
        }
      }
      renderBrewProgress();

      // Potion timers HUD
      updatePotionBadges();

      // Hatch speed hook
if (typeof window !== 'undefined') {
  const fast = (typeof isFastHatchActive === 'function') ? isFastHatchActive() : false;

  // Base durations (when no potion is active)
  const base = (typeof HATCH_DURATION !== 'undefined') ? HATCH_DURATION : (10*60*1000);
  const base3 = (typeof THIRD_HATCH_DURATION !== 'undefined') ? THIRD_HATCH_DURATION : (5*60*1000);
  const base4 = (typeof FOURTH_HATCH_DURATION !== 'undefined') ? FOURTH_HATCH_DURATION : (2*60*1000);

  // Only when the Fast Hatch potion is active:
  // - Pedestals 1 & 2 use 5:00
  // - Pedestal 3 uses 2:50
  // - Pedestal 4 uses 1:00
  window.HATCH_DURATION = Math.floor(fast ? (5*60*1000) : base);
  window.THIRD_HATCH_DURATION = Math.floor(fast ? (170*1000) : base3);
  window.FOURTH_HATCH_DURATION = Math.floor(fast ? (60*1000) : base4);
}

    }catch(e){ /* no-op */ }
  }, 200);

  // ---- HUD next to multiplier ----
  function ensurePotionBadgesHost(){
    if(!$('#potionBadges')){
      const mult = $('#multBadge');
      const host = document.createElement('div');
      host.id = 'potionBadges';
      mult?.parentNode?.insertBefore(host, mult.nextSibling);
    }
  }
  function updatePotionBadges(){
    ensurePotionBadgesHost();
    const host = $('#potionBadges');
    if(!host) return;
    const parts = [];
    // multiplier
    const mm = getActivePotionMultiplier();
    if (mm > 1){
      const left = Math.max(0, (state.activePotions?.multiplier?.until||0) - Date.now());
      const s = Math.ceil(left/1000); const m = Math.floor(s/60); const ss = String(s%60).padStart(2,'0');
      parts.push(`<span class="pBadge">x${mm} ${m}:${ss}</span>`);
    }
    if (isShopLuckActive()){
      const left = Math.max(0, (state.activePotions.shopLuckUntil||0) - Date.now());
      const s = Math.ceil(left/1000); const m = Math.floor(s/60); const ss = String(s%60).padStart(2,'0');
      parts.push(`<span class="pBadge">Luck ${m}:${ss}</span>`);
    }
    if (isFastHatchActive()){
      const left = Math.max(0, (state.activePotions.fastHatchUntil||0) - Date.now());
      const s = Math.ceil(left/1000); const m = Math.floor(s/60); const ss = String(s%60).padStart(2,'0');
      parts.push(`<span class="pBadge">Hatch ${m}:${ss}</span>`);
    }
    host.innerHTML = parts.join('');
  }

  function showToast(msg){
    try{
      let el = document.getElementById('toast');
      if(!el){
        el = document.createElement('div'); el.id='toast'; el.setAttribute('aria-live','polite'); document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.cssText = 'position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111;color:#fff;padding:10px 16px;border-radius:12px;z-index:9999;box-shadow:0 10px 30px rgba(0,0,0,.35)';
      el.style.opacity = '1';
      setTimeout(()=>{ el.style.transition='opacity .6s ease'; el.style.opacity='0'; }, 1200);
    }catch(e){}
  }

  // ---- Use potions from inventory (double-click) ----
  function usePotion(obj){
    if(!obj || String(obj.rarity).toLowerCase()!=='potion') return;
    const name = String(obj.name||'');
    const now = Date.now();
    if (/^Multiplier x2 Potion/i.test(name)){ state.activePotions.multiplier = { until: now + 5*60*1000, factor: 2 }; }
    else if (/^Multiplier x4 Potion/i.test(name)){ state.activePotions.multiplier = { until: now + 7*60*1000, factor: 4 }; }
    else if (/^Multiplier x6 Potion/i.test(name)){ state.activePotions.multiplier = { until: now + 10*60*1000, factor: 6 }; try{ state.flexwood = state.flexwood || {}; state.flexwood.top2 = state.flexwood.top2 || {}; state.flexwood.top2.x6Brewed = (state.flexwood.top2.x6Brewed||0)+1; if(typeof save==='function') save(); if(typeof renderFlexwood==='function') renderFlexwood(); }catch(e){} }
    else if (/^Shop Luck Potion/i.test(name)){ state.activePotions.shopLuckUntil = now + 5*60*1000; }
    else if (/^Fast Hatch Potion/i.test(name)){
  const wasActive = (state.activePotions?.fastHatchUntil||0) > now;
  state.activePotions.fastHatchUntil = now + 15*60*1000;
  try{
    if (!wasActive && Array.isArray(state.petTimers)){
      for (let i=0;i<state.petTimers.length;i++){
        const end = state.petTimers[i];
        if (typeof end === 'number' && end > now){
          const remaining = end - now;
          state.petTimers[i] = now + Math.ceil(remaining / 2);
        }
      }
      if (typeof renderStands==='function') renderStands();
    }
  }catch(e){}
}
    else if (/^Shop Refresh Potion/i.test(name)){ try{ if(typeof refreshShopNow==='function') refreshShopNow(); }catch(e){} try{ showToast && showToast('Shop refreshed! Timer reset to 1:30'); }catch(_e){} }
    // consume the potion
    state.inventory = state.inventory.filter(x => x.uid !== obj.uid);
    if(typeof renderInventory==='function') renderInventory();
    if(typeof save==='function') save();
    updatePotionBadges();
  }

  // Patch renderInventory to attach dblclick handler for potions
  try{
    const _ri = window.renderInventory;
    window.renderInventory = function(){
      _ri.apply(this, arguments);
      try{
        $$('#inventory .slot').forEach(el => {
          const uid = el.getAttribute('data-uid');
          const it = (state.inventory||[]).find(x=>x && String(x.uid)===String(uid));
          if(it && String(it.rarity||'').toLowerCase()==='potion'){
            el.addEventListener('dblclick', ()=>usePotion(it));
            el.title = 'Doubleâ€‘click to use';
          }
        });
      }catch(e){}
    };
  }catch(e){}

  // Multiplier hook for potions
  window.getActivePotionMultiplier = function(){
    try{
      const m = state.activePotions?.multiplier;
      if(m && (m.until||0) > Date.now()) return Number(m.factor||1) || 1;
    }catch(e){}
    return 1;
  };

  // Adjust EPS pipeline to include potion multiplier
  try{
    if (typeof recalcEPS === 'function'){
      const _re = recalcEPS;
      window.recalcEPS = function(){
        _re.apply(this, arguments);
        try{
          // Recompute with potion multiplier applied (non-destructive)
          state.eps = Math.floor(state.eps * getActivePotionMultiplier());
          if (typeof updateTop==='function') updateTop();
        }catch(e){}
      };
    }
  }catch(e){}

  // Shop luck hook: override weightedPick slightly while active
  try{
    if (typeof weightedPick === 'function'){
      const _wp = weightedPick;
      window.isShopLuckActive = function(){ return (state.activePotions?.shopLuckUntil||0) > Date.now(); };
window.weightedPick = function(){
  if (!isShopLuckActive()) return _wp();
  // When Shop Luck is active, match the same luck as having ONE Flexicorn on a pedestal.
  // We mimic currentShopWeights() with count=1: { common:50, rare:12, epic:23, legendary:6, legacy:5, unique:4 }
  const w = { common:50, rare:12, epic:23, legendary:6, legacy:5, unique:4 };
  const order = ['unique','legacy','legendary','epic','rare','common'];
  const r = Math.random() * 100;
  let acc = 0;
  for (const k of order){
    acc += (w[k]||0);
    if (r < acc) return k;
  }
  return 'common';
};
    }
  }catch(e){}

  // Fast hatch helpers
  window.isFastHatchActive = function(){ return (state.activePotions?.fastHatchUntil||0) > Date.now(); };

  // ---- Fuels appear in Shop (occupy one of the 4 slots) ----
  try{
    if (typeof makeShopItems === 'function'){
      const _mk = makeShopItems;
      window.makeShopItems = function(){
        const items = _mk();
        try{
          // 35% chance to replace a random slot with a fuel (Coal / Gunpowder / Flame)
          if (Math.random() < 0.35){
            const i = Math.floor(Math.random()*items.length);
            const fuels = [
              { name:'Coal', svg:'potions/fuels/coal.png' },
              { name:'Gunpowder', svg:'potions/fuels/gunpowder.png' },
              { name:'Flame', svg:'potions/fuels/flame.png' }
            ];
            const f = fuels[Math.floor(Math.random()*fuels.length)];
            items[i] = { uid: (Math.random().toString(36).slice(2)+Date.now().toString(36)), name: f.name, rarity:'fuel', price: Math.floor(2_500_000 + Math.random() * (3_500_000 - 2_500_000)), svg: f.svg, baseIdx:-1, purchased:false };
          }
        }catch(e){}
        return items;
      };
    }
  }catch(e){}

  // ---- Mount on load ----
  window.addEventListener('load', ()=>{
    insertBrewerCard();
    showBrewButton();
    ensurePotionBadgesHost();
  });
})();
</script>

<!-- ===== POTION BREWER: Overlay Centering + No Blur + Drag & Drop (v1.91) ===== -->
<style>
  /* Transparent background, no blur, and non-interactive backdrop so you can drag from inventory */
  #brewOverlay{ background:transparent !important; -webkit-backdrop-filter:none !important; backdrop-filter:none !important; pointer-events:none !important; }
  #brewOverlay.show{ display:block !important; }
  #brewOverlay .sheet{ background:transparent !important; pointer-events:none !important; }
  /* Hard center the panel and keep it interactive */
  #brewOverlay .panel{
    position:fixed !important; top:50% !important; left:50% !important; transform:translate(-50%,-50%) !important;
    pointer-events:auto !important;
  }
  /* Drag-over highlight */
  .brew-slot.drop-ok{ outline: 6px dashed rgba(255,255,255,.9); outline-offset: -6px; }
  .brew-slot.drop-bad{ outline: 6px dashed rgba(255,77,77,.95); outline-offset: -6px; }
</style>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  function enableInventoryDragging(){
    try{
      $$('#inventory .slot').forEach(el => {
        const uid = el.getAttribute('data-uid');
        if (!uid) return;
        el.setAttribute('draggable','true');
        if (!el._dragInit){
          el.addEventListener('dragstart', ev => {
            ev.dataTransfer.setData('text/flex-uid', uid);
            ev.dataTransfer.setData('text/plain', uid);
            ev.dataTransfer.effectAllowed = 'copyMove';
          });
          el._dragInit = true;
        }
      });
    }catch(e){}
  }

  function setupDropZone(el, acceptFn, assign){
    if (!el) return;
    ['dragenter','dragover'].forEach(type => {
      el.addEventListener(type, ev => {
        const uid = ev.dataTransfer?.getData('text/flex-uid') || ev.dataTransfer?.getData('text/plain');
        if (!uid){ el.classList.remove('drop-ok','drop-bad'); return; }
        const it = (state.inventory||[]).find(x=>x && String(x.uid)===String(uid));
        if (acceptFn(it)){
          ev.preventDefault(); ev.dataTransfer.dropEffect = 'copy';
          el.classList.add('drop-ok'); el.classList.remove('drop-bad');
        } else {
          el.classList.remove('drop-ok'); el.classList.add('drop-bad');
        }
      });
    });
    ['dragleave','drop'].forEach(type => {
      el.addEventListener(type, ev => { el.classList.remove('drop-ok','drop-bad'); });
    });
    el.addEventListener('drop', ev => {
      const uid = ev.dataTransfer?.getData('text/flex-uid') || ev.dataTransfer?.getData('text/plain');
      const idx = (state.inventory||[]).findIndex(x=>x && String(x.uid)===String(uid));
      if (idx<0) return;
      const it = state.inventory[idx];
      if (!acceptFn(it)) return;
      // Remove + assign
      state.inventory.splice(idx,1);
      window.brewSlots = window.brewSlots || { fuel:null, unique:null, other:null };
      assign(it);
      if (typeof renderInventory==='function') renderInventory();
      if (typeof renderBrewSlots==='function') renderBrewSlots();
    });
  }

  function isFuel(it){
    if(!it) return false;
    const n = String(it.name||'').toLowerCase();
    const r = String(it.rarity||'').toLowerCase();
    return r==='fuel' || n==='coal' || n==='gunpowder' || n==='flame';
  }
  function isUnique(it){ return it && String(it.rarity||'').toLowerCase()==='unique'; }
  function acceptOther(it){
    if(!it) return false;
    const rk = String(it.rarity||'').toLowerCase();
    const nm = String(it.name||'');
    return rk==='legendary' || rk==='legacy' || rk==='exotic' || rk==='crypto' ||
      (rk==='potion' && /multiplier x[24] potion/i.test(nm));
  }

  function attachDrops(){
    setupDropZone(document.getElementById('brewFuel'), isFuel, it => { window.brewSlots.fuel = it; });
    setupDropZone(document.getElementById('brewUnique'), isUnique, it => { window.brewSlots.unique = it; });
    setupDropZone(document.getElementById('brewOther'), acceptOther, it => { window.brewSlots.other = it; });
  }

  // Hook inventory renderer to ensure draggable
  try{
    const _ri = window.renderInventory;
    window.renderInventory = function(){
      _ri.apply(this, arguments);
      enableInventoryDragging();
    };
  }catch(e){}

  window.addEventListener('load', () => {
    enableInventoryDragging();
    attachDrops();
    document.getElementById('brewOpenBtn')?.addEventListener('click', () => setTimeout(attachDrops, 0));
  });
})();
</script>

<!-- ===== POTION BREWER: Persistent Ownership Save (v1.92) ===== -->
<script>
(function(){
  const LS_KEY = 'flex_brewer_owned';
  function readOwned(){
    try{ return localStorage.getItem(LS_KEY) === '1'; }catch(e){ return false; }
  }
  
  function __writeBackupNow(){
    try{
      const __now = Date.now();
      const payload = (typeof buildSavePayload==='function') ? buildSavePayload(__now) : (function(){
        // fallback: build minimal payload for backup that includes brewer
        const p = {};
        try{
          p.money = state.money;
          p.eps = state.eps;
          p.inventory = Array.isArray(state.inventory) ? state.inventory : [];
          p.stands = state.stands;
          p.shop = state.shop;
          p.fastMode = state.fastMode;
          p.placed = state.placed || {};
          p.petPedestalsPurchased = state.petPedestalsPurchased;
          p.petStands = state.petStands || {};
          p.petTimers = state.petTimers || {};
          p.permanentPetMultiplier = state.permanentPetMultiplier || 1;
          p.petDex = state.petDex || {};
          p.rebirthLevel = state.rebirthLevel || 0;
          p.unlockedBackgrounds = state.unlockedBackgrounds || {};
          p.selectedBackground = state.selectedBackground || 'default';
          p.ach = state.ach || { questsDone:{} };
          p.pedestalSkins = state.pedestalSkins || { default:true };
          p.selectedPedestalSkin = state.selectedPedestalSkin || 'default';
          p.upsideDown = !!state.upsideDown;
          p.inventoryFilters = state.inventoryFilters || {};
          p.centerGifts = state.centerGifts || {};
          p.brewer = state.brewer || { owned:false, active:null };
          p.__ts = __now;
        }catch(e){}
        return p;
      })();
      try {
        const cur = localStorage.getItem(LOCAL_BACKUP_KEY);
        if (cur) { try { localStorage.setItem(LOCAL_BACKUP_PREV, cur); } catch(e){} }
      } catch(e){}
      localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify({ ts: payload.__ts, data: payload }));
    }catch(_){}
  }
function writeOwned(forceTrue){
    try{
      const prev = localStorage.getItem(lsKey());
      const nowFlag = !!(window.state && state.brewer && state.brewer.owned);
      const owned = forceTrue ? true : (nowFlag || prev === '1');
      localStorage.setItem(lsKey(), owned ? '1' : '0');
    }catch(e){}
  }

  function refreshBuyButton(){
    const btn = document.getElementById('buyBrewer');
    const check = document.getElementById('brewLvlCheck');
    const hasLvl = (state.rebirthLevel||0) >= 5;
    const hasMoney = (state.money||0) >= COST;

    if (check){
      check.textContent = hasLvl ? 'âœ“' : 'âœ–';
      check.style.background = hasLvl ? '#2ecc71' : '#e74c3c';
    }
    if (!btn) return;
    if (state.brewer?.owned){
      btn.disabled = true;
      btn.textContent = 'Purchased!';
      btn.style.background = 'linear-gradient(#2ecc71,#1da85b)';
    } else {
      btn.disabled = !(hasLvl && hasMoney);
      btn.textContent = 'Purchase';
      btn.style.background = '';
    }
  }

  function ensureGearPolling(){
    if (window.__brewGearPoll) return;
    window.__brewGearPoll = setInterval(()=>{
      try{ refreshBuyButton(); }catch(e){}
    }, 200);
  }

  window.addEventListener('load', ()=>{
    window.state = window.state || {};
    state.brewer = state.brewer || { owned:false, active:null };
    if (readOwned()) state.brewer.owned = true;
    try{ if (typeof showBrewButton==='function') showBrewButton(); }catch(e){}
    ensureGearPolling();
    refreshBuyButton();
  });

  document.addEventListener('click', (ev)=>{
    if (ev.target && ev.target.id === 'buyBrewer'){
      setTimeout(()=>{
        writeOwned();
        refreshBuyButton();
        try{ if (typeof showBrewButton==='function') showBrewButton(); }catch(e){}
        try{ if (typeof save==='function') save(); }catch(e){}
      }, 0);
    }
  });

  try{
    const _save = window.save;
    window.save = function(){
      try{ writeOwned(); }catch(e){}
      return _save ? _save.apply(this, arguments) : undefined;
    };
  }catch(e){}

  window.addEventListener('beforeunload', ()=>writeOwned());
})();
</script>
