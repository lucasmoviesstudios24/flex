<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Flex â€” Shop &amp; Flex Game (Inventory at Bottom)</title>
<link href="https://fonts.googleapis.com/css2?family=Bungee:wght@400&amp;family=Russo+One&amp;family=Rajdhani:wght@600;700&amp;display=swap" rel="stylesheet"/>
<style>
:root{
  --ui-blue:#59a7ff;
  --ui-blue-dark:#2973e3;
  --ink:#0a0f1a;
  --panel:#3a3a42;
  --panel-2:#2b2b31;
  --slot:#9aa0a6;
  --success:#2ecc71;
  --danger:#e74c3c;
  --gold:#ffb200;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --radius:28px;
  --c-common:#6dff79;
  --c-rare:#4cc4ff;
  --c-epic:#b66bff;
  --c-legendary:#ffd84a;
  --c-legacy:#ffffff;
  --c-mythic:#ffd700;
}

/* page / backdrop */
html,body{ height:100%; margin:0; background: linear-gradient(to bottom, #89CFF0 0%, #90EE90 100%); overscroll-behavior:none; color:#fff; font-family:"Rajdhani", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; user-select:none; }
body::before{
  content:"";
  position:fixed;
  inset:0;
  background-image: linear-gradient(0deg, rgba(0,0,0,.06), rgba(255,255,255,.06)), repeating-linear-gradient(45deg, #1aa69e 0 12px, #1ca3d8 12px 24px, #1f7fb8 24px 36px), repeating-linear-gradient(-45deg, #1dc79d 0 12px, #1ea9d0 12px 24px, #2b6ab8 24px 36px);
  filter:contrast(115%) saturate(120%);
  image-rendering:pixelated;
  background-size: 100% 100%, 24px 24px, 24px 24px;
  mix-blend-mode: normal;
  z-index:-2;
}
body::after{
  content:"";
  position:fixed;
  inset:0;
  z-index:-1;
  background:linear-gradient(90deg, rgba(255,255,255,.05), rgba(0,0,0,.05));
  image-rendering: pixelated;
  background-size: 8px 8px;
  opacity:.45;
}
/* ðŸ”´ðŸ”µ Red/Blue override */
body.redblue::before {
  content: "";
  position: fixed;
  inset: 0;
  z-index: -2;
  background: linear-gradient(to bottom, #ff4b5c 0%, #4b6aff 100%) !important;
}

body.redblue::after {
  content: "";
  position: fixed;
  inset: 0;
  z-index: -1;
  background: none !important;
}



/* game container */
.game{
  position:relative;
  min-height:100%;
  padding:20px;
  /* make space at bottom so fixed inventory doesn't overlap other content */
  padding-bottom:220px;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  gap:24px;
}

/* topbar */
.cash{
  font-family:"Bungee", sans-serif;
  font-size: clamp(28px, 5vw, 54px);
  background: var(--ui-blue);
  color:#000;
  border:6px solid #0e2a4c;
  border-radius: 28px;
  padding: 6px 28px 8px;
  box-shadow: var(--shadow);
  letter-spacing:2px;
  text-shadow: 0 2px 0 rgba(255,255,255,.35);
}
.topbar{ display:flex; gap:14px; align-items:center; justify-content:center; flex-wrap:wrap; }
.eps{ padding:6px 12px; border-radius:12px; background:rgba(0,0,0,.35); font-weight:800; }

/* left rail */
.left-rail{
  position:fixed;
  left:16px;
  top:120px;
  display:flex;
  flex-direction:column;
  gap:16px;
  z-index:7;
}
.icon-btn{
  width:96px;
  height:96px;
  border-radius:20px;
  display:grid;
  place-items:center;
  cursor:pointer;
  box-shadow:var(--shadow);
  border:4px solid rgba(0,0,0,.4);
}
.icon-shop{ background:#57d85a; }
.icon-tools{ background:#8c8f95; }
.icon-music{ background: linear-gradient(45deg,#ffd86a,#ff7ac7); }
.icon-pets{ background: #ffb6e6; } /* paw button style */
.icon-btn svg{ width:64%; height:64%; }
.icon-btn img{ width:80%; height:80%; }

/* stands / pedestals area (keeps visually centered above inventory) */
.stands{
  margin-top:24px;
  margin-bottom:12px; /* small gap before the visual area above the inventory */
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:40px;
  width:min(100%,1000px);
  z-index:3;
}
.stand{
  position:relative;
  /* taller so pedestals sit well above the bottom inventory bar */
  height:160px;
  display:flex;
  align-items:flex-end;
  justify-content:center;
}
.pedestal{
  width: 200px;
  height: 48px;
  background: linear-gradient(#ffda66, #f0a800);
  border-radius: 12px;
  box-shadow: inset 0 6px 0 rgba(255,255,255,.35), 0 10px 0 #bb7a00, 0 14px 18px rgba(0,0,0,.4);
}
.placed{
  position:absolute;
  /* position above pedestal; increased so it reads nicely above the bottom inventory */
  bottom:110px;
  display:flex;
  align-items:center;
  justify-content:center;
  width:160px;
  height:80px;
  border-radius:16px;
  background:rgba(0,0,0,.18);
  backdrop-filter: blur(1px);
  outline:4px solid rgba(0,0,0,.35);
  transition:transform .15s ease, box-shadow .2s;
  z-index:4;
}
.placed:hover{ transform:translateY(-3px) scale(1.02); }
.placed.glow{ box-shadow:0 8px 30px rgba(255,220,120,.9); transform:translateY(-6px) scale(1.06); }

/* PET ROW */
.pet-row{
  margin-top:8px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:40px;
  width:min(100%,1000px);
  z-index:3;
}
.pet-stand{
  position:relative;
  height:120px;
  display:flex;
  align-items:flex-end;
  justify-content:center;
}
.pet-pedestal{
  width: 140px;
  height: 40px;
  background: linear-gradient(#c3c3c3, #8e8e8e);
  border-radius: 10px;
  box-shadow: inset 0 4px 0 rgba(255,255,255,.35), 0 6px 0 rgba(0,0,0,.25);
}
.pet-placed{
  position:absolute;
  bottom:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  width:120px;
  height:64px;
  border-radius:12px;
  background:rgba(0,0,0,.14);
  outline:3px solid rgba(0,0,0,.35);
  z-index:4;
}
.pet-placed img{ width:56px; height:56px; border-radius:8px; margin-right:6px; }

/* timer badge on pet placed */
.pet-timer{
  position:absolute;
  bottom:58px;
  left:6px;
  font-size:12px;
  padding:4px 8px;
  border-radius:10px;
  background:rgba(0,0,0,.6);
  color:#fff;
  z-index:6;
}

/* === INVENTORY FIXED TO BOTTOM (MAIN CHANGES) === */
.inventory-wrap{
  /* make the inventory a fixed bottom bar centered horizontally */
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:18px;
  width: min(1100px, 96%);
  z-index:8;
  display:flex;
  justify-content:center;
  pointer-events:auto;
}

/* inventory container styled to match the concept art: big rounded rectangle with thick outline */
.inventory{
  display:flex;
  gap:16px;
  overflow-x:auto;
  padding:20px;
  background: linear-gradient(180deg, #d0d2d6, #a9adaf); /* subtle metallic grey like the concept */
  border-radius:28px;
  box-shadow: 0 18px 50px rgba(0,0,0,.6), var(--shadow);
  border:8px solid #111; /* thick dark outline similar to concept */
  align-items:center;
  /* ensure the inventory bar doesn't shrink too small on tiny screens */
  min-width: 320px;
}

/* larger slot sizes to match concept visuals */
.slot{
  min-width:140px;
  height:112px;
  background: #b4b8bd;
  border-radius:20px;
  display:grid;
  place-items:center;
  color:#111;
  font-weight:700;
  border:6px solid #262a2f;
  position:relative;
  cursor:pointer;
  flex: 0 0 auto;
  box-shadow: 0 6px 18px rgba(0,0,0,.35) inset;
}
.slot.selected{ outline:6px solid var(--ui-blue);}
.slot .rar{
  position:absolute;
  right:8px;
  bottom:8px;
  font-size:12px;
  padding:3px 8px;
  border-radius:12px;
  background:rgba(0,0,0,.4);
  color:#fff;
}
.slot img{ width:72px; height:72px; border-radius:10px; }

/* === Pet image size upgrade === */
.slot.is-pet { height: 132px; }
.slot.is-pet img { width: 96px; height: 96px; }

.pet-stand { height: 150px; }
.pet-placed { height: 80px; }
.pet-placed img { width: 72px; height: 72px; border-radius: 10px; }


/* shop overlay and other UI left mostly unchanged */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}
.overlay.show{ display:flex; }
.shop{
  width:min(1000px, 92%);
  background:#4a4a52;
  border-radius:30px;
  border:6px solid #212127;
  box-shadow:var(--shadow);
  padding:24px;
  position:relative;
  color:#e8e8ee;
}
.shop h2{ text-align:center; margin:0 0 18px 0; font-family:"Russo One"; font-size:42px; letter-spacing:1px; color:#8aff8f; text-shadow:0 2px 0 #0f0f0f; }
.refresh-note{ text-align:center; font-weight:700; opacity:.85; margin-top:10px; }
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }
.card{ background:#33333b; border-radius:22px; border:4px solid #1a1a1f; padding:18px; display:flex; flex-direction:column; gap:8px; justify-content:space-between; min-height:160px; }
.card h3{ margin:0; font-size:30px; font-family:"Russo One"; letter-spacing:1px; color:#d7d9dd; }
.tag{ font-size:26px; font-family:"Bungee"; letter-spacing:1px; -webkit-text-stroke:2px #000; color:transparent; filter:drop-shadow(0 2px 0 rgba(0,0,0,.5)); }
.t-common{ color:var(--c-common); }
.t-rare{ color:var(--c-rare); }
.t-epic{ color:var(--c-epic); }
.t-legendary{ color:var(--c-legendary); }
.t-birthday {
  background: linear-gradient(90deg, #ff62d5, #ffd700, #ff62d5);
  background-size: 200% auto;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  animation: birthdayAnim 1.2s linear infinite;
  font-weight:900;
}
@keyframes birthdayAnim {
  0% { background-position: 0% 50%; letter-spacing: 2px; }
  50% { background-position: 100% 50%; letter-spacing: 6px; }
  100% { background-position: 0% 50%; letter-spacing: 2px; }
}
.t-legacy{
  background: linear-gradient(90deg, #ff004c, #ff7a00, #ffd400, #18e300, #00e7ff, #3a31ff, #ff31ff, #ff004c);
  background-size: 400% 100%;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  animation: rainbowShift 4s linear infinite;
}
.t-mythic{
  background: linear-gradient(90deg, #ffd700, #fff8b0, #ffcc00);
  background-size: 200% auto;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  animation: goldShimmer 2.5s linear infinite;
  font-weight:900;
}

.t-unique {
  color: navy;
  text-shadow: 0 0 6px rgba(0,0,128,.6);
  animation: uniqueSparkle 2s linear infinite;
}
@keyframes uniqueSparkle {
  0%,100% { text-shadow: 0 0 6px rgba(255,255,255,.2); }
  50%     { text-shadow: 0 0 10px rgba(255,255,255,.7); }
}

.t-exotic {
  color: cyan;
  text-shadow: 0 0 8px rgba(0,255,255,.7);
  animation: exoticPulse 2.5s ease-in-out infinite;
}
@keyframes exoticPulse {
  0%,100% { text-shadow: 0 0 8px rgba(0,255,255,.3); }
  50%     { text-shadow: 0 0 16px rgba(0,255,255,1); }
}

/* apply on the <p> wrapper holding the item image */
.glow-exotic {
  filter: drop-shadow(0 0 8px rgba(0,255,255,.8))
          drop-shadow(0 0 16px rgba(0,255,255,.5));
}


.t-unique {
  color: navy;
  position: relative;
  text-shadow: 0 0 3px rgba(255,255,255,0.3);
}

/* Sparkle effect overlay */
.t-unique::after {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  width: calc(100% + 4px);
  height: calc(100% + 4px);
  pointer-events: none;
  background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,0.5) 50%, transparent 100%);
  background-size: 200% 100%;
  animation: uniqueSparkle 2.5s linear infinite;
  mix-blend-mode: screen;
  border-radius: 4px;
}

@keyframes uniqueSparkle {
  0%   { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}


@keyframes rainbowShift{ 0%{ background-position: 0% 50%; } 100%{ background-position: 100% 50%; } }
@keyframes goldShimmer{ 0%{ background-position: 0% 50%; } 100%{ background-position: 200% 50%; } }

.price{ font-weight:900; font-size:22px; }
.buy{ align-self:flex-end; padding:10px 16px; font-weight:900; border:none; border-radius:14px; cursor:pointer; background:linear-gradient(var(--ui-blue), var(--ui-blue-dark)); color:#fff; box-shadow:var(--shadow); }
.upgrade{ align-self:flex-end; padding:10px 16px; font-weight:900; border:none; border-radius:14px; cursor:pointer;
  background:linear-gradient(45deg,#ffd86a,#ff7a00); color:#111; box-shadow:var(--shadow); }
.upgrade:disabled{ filter:grayscale(1) brightness(.7); cursor:not-allowed; }

/* Badge above EPS for total multiplier (pet + rebirth) */
#multBadge{ padding:2px 10px; border-radius:12px; background:linear-gradient(45deg,#ffd86a,#ff7a00); color:#000;
  font-weight:900; display:none; margin-left:6px; }

.buy:disabled{ filter:grayscale(1) brightness(.7); cursor:not-allowed; }
.closeX{ position:absolute; right:12px; top:8px; font-size:28px; background:#222; color:#fff; border:none; border-radius:14px; width:44px; height:44px; cursor:pointer; }

/* forge button */
#forgeBtn{
  margin-top:6px;
  padding:10px 18px;
  border-radius:14px;
  background: linear-gradient(45deg, #ffd86a, #ffb200);
  border:4px solid rgba(0,0,0,.35);
  color:#000;
  font-weight:900;
  box-shadow: 0 8px 30px rgba(255,200,60,0.18);
  cursor:pointer;
  display:none;
}

/* responsive tweaks */
@media (max-width:800px){
  .stands{ gap:22px; }
  .pedestal{ width:150px;}
  .placed{ width:130px; bottom:90px; }
  .icon-btn{ width:76px; height:76px; }
  .slot{ min-width:100px; height:88px; }
  .inventory{ padding:12px; gap:8px; border-radius:18px; }
  .inventory-wrap{ bottom:12px; width: calc(100% - 30px); }
}

/* ðŸ”´ðŸ”µ Full background override for red/blue mode */
body.redblue {
  background: linear-gradient(to bottom, #ff4b5c 0%, #4b6aff 100%) !important;
}

body.redblue::before,
body.redblue::after {
  display: none !important; /* turn off the original pseudo-element layers */
}




// === Universal PNG resolver for any item name ===
window.ITEM_FILE_MAP = window.ITEM_FILE_MAP || {};
window.ITEM_FILENAME_MAP = window.ITEM_FILENAME_MAP || {};

function __normalizeFileNameFromName(n){
  return String(n||'').toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'') + '.png';
}

// Folders we will try in order for file-backed items
window.__ICON_FOLDERS = [
  'icons/',
  'stranger_things_items/',
  'hawkins_items/',
  'cosmic_items/',
  'dodger_items/',
  'pets/'
];

// Build NAME -> filename map dynamically from any global arrays that look like [{name, file}]
(function buildDynamicItemFileMap(){
  try{
    for (const key in window){
      const val = window[key];
      if (Array.isArray(val) && val.length && typeof val[0]==='object'){
        val.forEach(x=>{
          if (x && typeof x.name==='string' && typeof x.file==='string' && /\.png$/i.test(x.file)){
            // try to infer folder from any code that sets obj.svg = 'folder/'+it.file
            // we can't parse code at runtime, so store filename; folder will be resolved below
            ITEM_FILENAME_MAP[x.name] = x.file;
          }
        });
      }
    }
  }catch(e){}
})();

function __tryResolvePathSync(name){
  // Highest priority: explicit map with full path
  if (ITEM_FILE_MAP[name]) return ITEM_FILE_MAP[name];
  const file = ITEM_FILENAME_MAP[name] || __normalizeFileNameFromName(name);
  for (const folder of __ICON_FOLDERS){
    // naive return; we'll verify with onerror/onload later
    return folder + file;
  }
  return null;
}

// Attach lazy fix-up on <img> elements for items that might need probing
function __attachImageFixups(img, it){
  if (!img) return;
  let tried = 0;
  const file = ITEM_FILENAME_MAP[it.name] || __normalizeFileNameFromName(it.name);
  const candidates = [];
  for (const folder of __ICON_FOLDERS){ candidates.push(folder + file); }

  function tryNext(){
    if (tried >= candidates.length){ return; }
    const next = candidates[tried++];
    img.src = next;
  }

  img.addEventListener('error', ()=>{
    tryNext();
  });

  img.addEventListener('load', ()=>{
    try{
      // if we loaded a PNG path, persist it
      const src = img.getAttribute('src')||'';
      if (src.endsWith('.png')){
        it.svg = src;
        if (typeof save === 'function'){ save(); }
      }
    }catch(e){}
  });

  // If current src is not a .png, start probing
  const cur = img.getAttribute('src')||'';
  if (!/\.png($|\?)/i.test(cur)){ tryNext(); }
}
/* === Add-on: Achievements + Background Selector === */
.right-rail{position:fixed;right:16px;top:180px;display:flex;flex-direction:column;gap:16px;z-index:8;}
.icon-achievements,.bg-selector-btn{width:76px;height:76px;border-radius:20px;display:grid;place-items:center;cursor:pointer;box-shadow:var(--shadow);border:4px solid rgba(0,0,0,.4);}
.icon-achievements{background:#ffd24a;}
.bg-selector-btn{position:fixed;right:120px;bottom:24px;z-index:9;background:linear-gradient(45deg,#222,#444);}
.icon-achievements svg,.bg-selector-btn svg{width:60%;height:60%;}

.sheet{width:min(1024px,94%);background:#4a4a52;border-radius:30px;border:6px solid #212127;box-shadow:var(--shadow);padding:24px;color:#e8e8ee;position:relative;}
.sheet h2{margin:0 0 18px;font-family:"Russo One";font-size:42px;letter-spacing:1px;text-align:center;}

.rarity-rail{width:220px;background:#25252b;border-radius:24px;border:4px solid #111;padding:16px;display:flex;flex-direction:column;gap:8px;align-self:flex-start;}
.achv-wrap{display:grid;grid-template-columns:220px 1fr;gap:18px;}
.rail-btn{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:14px;background:#33333b;border:2px solid #1a1a1f;font-weight:800;cursor:pointer;}
.rail-btn.active{outline:3px solid var(--ui-blue);}
.badge-dot{width:10px;height:10px;border-radius:999px;background:#666;}
.badge-dot.done{background:#58e36c;}

.quest-card{background:#33333b;border-radius:22px;border:4px solid #1a1a1f;padding:18px;display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:14px;}
.quest-card .q-left{display:flex;align-items:center;gap:12px;}
.q-check{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;border:2px solid #111;background:#555;font-weight:900;}
.q-check.ok{background:#58e36c;color:#111;}
.reward-pill{padding:6px 10px;border-radius:12px;background:#ffb200;color:#000;font-weight:900;}

.bg-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;}
.bg-tile{height:120px;border-radius:18px;border:4px solid #111;display:flex;flex-direction:column;justify-content:flex-end;padding:12px;box-shadow:var(--shadow);position:relative;overflow:hidden;}
.bg-tile.locked::after{content:"LOCKED";position:absolute;inset:auto 0 0 0;background:rgba(0,0,0,.55);color:#fff;text-align:center;padding:6px 0;font-weight:900;}
.bg-apply{align-self:flex-end;margin-top:6px;}

body.bg-green{background:linear-gradient(to bottom,#3edc64,#1e6f2b)!important;}
body.bg-blue{background:linear-gradient(to bottom,#4aa3ff,#0b2e6e)!important;}
body.bg-purple{background:linear-gradient(to bottom,#a76bff,#ff72c6)!important;}
body.bg-orange{background:linear-gradient(to bottom,#ff9b3d,#b98200)!important;}
body.bg-legacy{background:linear-gradient(135deg,#ff7eb3,#ff2a68)!important;}
body.bg-unique{background:linear-gradient(135deg,#0a1a4b,#123a8c)!important;}
body.bg-exotic{background:linear-gradient(135deg,#cfefff,#a0a9b8)!important;}
body.bg-mythic{background:linear-gradient(135deg,#FFD700,#B8860B)!important;}
body.bg-crypto{background:linear-gradient(135deg,#ff62d5,#ffd84a)!important;}
body.bg-rainbow{background:linear-gradient(135deg,#ff004c,#ff7a00,#ffd400,#18e300,#00e7ff,#3a31ff,#ff31ff);background-size:400% 400%;animation:rainbowFlow 14s linear infinite;}
@keyframes rainbowFlow{0%{background-position:0% 50%}100%{background-position:100% 50%}}


/* Deletion mode */
body.deleting .slot .del-x { display:block !important; }
.slot .del-x,
.pet-placed .del-x {
  display:none; position:absolute; right:-8px; top:-8px; width:26px; height:26px; border-radius:50%;
  background:#ff3b30; color:#fff; font-weight:900; box-shadow:0 2px 6px rgba(0,0,0,.4);
  border:2px solid #111; cursor:pointer; display:grid; place-items:center; z-index:3;
}
.slot { position:relative; }
/* Trash toggle visual state */
#deleteToggleBtn svg{filter:none;opacity:.95;}
#deleteToggleBtn.active svg{filter:drop-shadow(0 0 6px rgba(255,59,48,.6));stroke:#ff3b30;}


/* === Achievements overlay: size, scroll, and no-overlap (final) === */
#achOverlay .sheet{
  max-height: min(90vh, 820px);
  display: flex;
  flex-direction: column;
  overflow: hidden; /* keeps the sheet capped; inner area will scroll */
}

#achOverlay .achv-wrap{
  /* scrollable inner area */
  flex: 1 1 auto;
  min-height: 0;
  overflow: auto;

  /* lock the two columns so they don't overlap */
  display: grid !important;
  grid-template-columns: 220px minmax(0, 1fr) !important;
  gap: 16px;
  align-items: start;
}

#achOverlay .rarity-rail{
  grid-column: 1;
  width: 220px; min-width: 220px; max-width: 220px;
  position: sticky; top: 0;      /* rail stays visible while the right side scrolls */
  z-index: 1;
  float: none;                   /* neutralize any stray float rules */
}

#achOverlay #achContent{
  grid-column: 2;
  min-width: 0;                  /* CRITICAL: lets content shrink within its grid track */
}

/* safety so children don't force overflow */
#achOverlay .achv-wrap > *{
  min-width: 0;
  box-sizing: border-box;
}

/* Right-side vertical list under Achievements */
.right-rail{
  position: fixed;
  right: 16px;
  top: 180px;
  display: flex;
  flex-direction: column;  /* vertical list */
  gap: 16px;
  z-index: 8;
}

/* Use the rail footprint; ignore any old fixed/inset styles */
.right-rail #openBgSelector,
.right-rail #deleteToggleBtn{
  position: static !important;
  inset: auto !important;
  width: 76px; height: 76px;   /* same size as Achievements */
  margin: 0;
  display: grid; place-items: center;
}

/* Ensure the delete button is icon-only (no button background/border) */
#deleteToggleBtn.delete-toggle-btn{
  background: none !important;
  border: none !important;
  box-shadow: none !important;
}



/* === Red Money (top money banner override) === */
body.money-red .cash{
  background: linear-gradient(#ff4b5c, #8b0000) !important;
  border-color: #3a0a0a !important;
}

/* === Pet Shop: make overlay scrollable & keep the X reachable === */
#petOverlay{
  overflow: auto;
  padding: 24px 12px; /* breathing room so the dialog isn't flush to edges while scrolling */
}
#petOverlay .shop{
  max-height: min(92dvh, 840px); /* cap height so content fits on small screens */
  overflow: auto;                /* allow inner scrolling */
}
/* Keep the close button reachable while scrolling the Pet Shop */
/* Pet Shop close button: like before (absolute); reach it by scrolling to the top */
#petOverlay .shop .closeX{
  position: absolute;
  top: 8px;
  right: 12px;
  margin-left: 0;
  z-index: 20;
}
@media (max-width: 800px){
  #petOverlay .shop{ max-height: min(92dvh, 740px); }
}


/* ===== admin broadcast banner ===== */
#adminMsgBanner{
  position:fixed; left:0; right:0; top:-120px; z-index:9999;
  display:flex; gap:12px; align-items:center; justify-content:center;
  min-height:56px; padding:10px 16px;
  font-weight:800; letter-spacing:.2px;
  color:#000; text-shadow:0 1px 0 rgba(255,255,255,.4);
  border-bottom:4px solid rgba(0,0,0,.35);
  box-shadow:0 10px 30px rgba(0,0,0,.35);
  transition: transform .35s ease, top .35s ease, background .25s;
  transform: translateY(-100%);
}
#adminMsgBanner.show{ top:0; transform: translateY(0); }
#adminMsgBanner .msg{ max-width:1100px; text-align:center; }
#adminMsgBanner .close{ margin-left:auto; cursor:pointer; font-weight:900; }
#adminMsgBanner.info{ background: #79ffe1; }
#adminMsgBanner.warn{ background: #ffd86a; }
#adminMsgBanner.success{ background: #a7ff83; }


/* === Quick Inventory Filters (mini-sheet) === */
.inv-filter-toggle{
  position:fixed;
  right:16px;
  bottom: 90px; /* sits just above the bottom inventory bar */
  width:64px;height:64px;
  border-radius:18px;
  background:#2b2b31;
  border:4px solid rgba(0,0,0,.45);
  box-shadow: var(--shadow);
  display:grid;place-items:center;
  cursor:pointer;
  z-index:10;
}
.inv-filter-toggle svg{width:60%;height:60%}
.inv-filter-toggle:active{transform:translateY(1px)}

.inv-filter-sheet{
  position:fixed;
  right:16px;
  bottom: 146px; /* opens right above the toggle */
  width:260px;
  max-height:60vh;
  background:#3e3e46;
  color:#f1f1f5;
  border-radius:20px;
  border:3px solid rgba(0,0,0,.45);
  box-shadow: var(--shadow);
  transform: translateY(16px) scale(.98);
  opacity:0; pointer-events:none;
  transition: transform .18s ease, opacity .18s ease;
  z-index: 20;
}
.inv-filter-sheet.show{ opacity:1; pointer-events:auto; transform:none; }
.inv-filter-sheet header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px; font-weight:800; letter-spacing:.25px;
}
.inv-filter-sheet header button{ 
  background:#ff4b5c; color:#fff; border:none; border-radius:12px; 
  padding:6px 10px; font-weight:800; cursor:pointer;
}
.inv-filter-sheet .opts{ padding:6px 12px 12px; display:grid; grid-template-columns:1fr 1fr; gap:8px 12px; }
.inv-filter-sheet .opt{ display:flex; align-items:center; gap:8px; background:#494952; padding:8px 10px; border-radius:12px; }
.inv-filter-sheet .actions{ display:flex; gap:10px; padding:10px 12px 14px; }
.inv-filter-sheet .actions button{
  flex:1 1 auto; padding:10px 12px; border-radius:12px; border:none; font-weight:800; cursor:pointer;
}
.inv-filter-sheet .actions .all{ background:#1fb978; color:#fff; }
.inv-filter-sheet .actions .clear{ background:#2b2b31; color:#fff; border:2px solid #565660; }
@media (max-width: 900px){
  .inv-filter-toggle{ right:12px; bottom: 90px; width:56px; height:56px; }
  .inv-filter-sheet{ right:12px; bottom: 146px; width:238px; }
}


/* === Rarity-themed styles for filter options === */
:root{
  --c-common:#27c553;
  --c-rare:#2ea0ff;
  --c-epic:#b060ff;
  --c-legendary:#ffa21a;
  --c-legacy:#ffffff;
  --c-unique:#00c0ff;
  --c-exotic:#00d4a8;
  --c-mythic:#ffd400;
  --c-crypto:#ff7a5a;
  --c-pets:#f7a8d8;
  --c-eggs:#6cc24a;
  --c-event:#ff3b30;
}
@keyframes opt-glow { 0%,100%{ box-shadow:0 0 0 0 rgba(255,255,255,.08);} 50%{ box-shadow:0 0 0 6px rgba(255,255,255,0);} }
@keyframes opt-shine { 0%{ background-position:200% 0;} 100%{ background-position:-200% 0;} }
@keyframes opt-gradmove { 0%{background-position:0% 50%;} 100%{background-position:100% 50%;} }
@keyframes opt-rotate { to { transform: rotate(360deg);} }

.inv-filter-sheet .opt{
  position:relative;
  overflow:hidden;
}
.inv-filter-sheet .opt input{ accent-color: var(--c, #9aa0a6); }

/* Left color bar */
.inv-filter-sheet .opt::before{
  content:''; position:absolute; left:0; top:0; bottom:0; width:6px; background:var(--c,#888);
}

/* Common */
.inv-filter-sheet .opt-common{ --c: var(--c-common); }
.inv-filter-sheet .opt-common span{ color: var(--c-common); }

/* Rare */
.inv-filter-sheet .opt-rare{ --c: var(--c-rare); }
.inv-filter-sheet .opt-rare span{ color: var(--c-rare); }
.inv-filter-sheet .opt-rare{ box-shadow: inset 0 0 0 1px rgba(46,160,255,.25); }

/* Epic */
.inv-filter-sheet .opt-epic{ --c: var(--c-epic); }
.inv-filter-sheet .opt-epic span{ color: var(--c-epic); }
.inv-filter-sheet .opt-epic{ animation: opt-glow 2.2s ease-in-out infinite; }

/* Legendary (gold flicker + shine) */
.inv-filter-sheet .opt-legendary{ --c: var(--c-legendary);
  background-image: linear-gradient(90deg, rgba(255,255,255,.09), rgba(255,255,255,0) 40%, rgba(255,255,255,.09));
  background-size:200% 100%; animation: opt-shine 3.2s linear infinite;
  box-shadow: inset 0 0 0 1px rgba(255,162,26,.28);
}
.inv-filter-sheet .opt-legendary span{ color: var(--c-legendary); }

/* Legacy (rainbow text) */
.inv-filter-sheet .opt-legacy{ --c: var(--c-legacy); }
.inv-filter-sheet .opt-legacy span{
  background: linear-gradient(45deg,#ff004c,#ffb600,#00ff95,#00a2ff,#b400ff);
  background-size: 300% 100%;
  -webkit-background-clip: text; background-clip:text; color: transparent;
  animation: opt-gradmove 6s linear infinite;
}

/* Unique (cyan sparkle) */
.inv-filter-sheet .opt-unique{ --c: var(--c-unique); }
.inv-filter-sheet .opt-unique span{ color: var(--c-unique); }
.inv-filter-sheet .opt-unique{ box-shadow: inset 0 0 0 1px rgba(0,192,255,.28); }

/* Exotic (teal pulse) */
.inv-filter-sheet .opt-exotic{ --c: var(--c-exotic); }
.inv-filter-sheet .opt-exotic span{ color: var(--c-exotic); }
.inv-filter-sheet .opt-exotic{ animation: opt-glow 2.8s ease-in-out infinite; }

/* Mythic (golden shine) */
.inv-filter-sheet .opt-mythic{ --c: var(--c-mythic);
  background-image: linear-gradient(90deg, rgba(255,255,255,.1), rgba(255,255,255,0) 40%, rgba(255,255,255,.1));
  background-size:200% 100%; animation: opt-shine 2.4s linear infinite;
  box-shadow: inset 0 0 0 1px rgba(255,212,0,.3);
}
.inv-filter-sheet .opt-mythic span{ color: var(--c-mythic); }

/* Crypto (animated border ring vibe) */
.inv-filter-sheet .opt-crypto{ --c: var(--c-crypto); position:relative; }
.inv-filter-sheet .opt-crypto span{
  background: linear-gradient(45deg,#ff4bd1,#ffd54b,#ff4bd1);
  background-size:200% 100%; -webkit-background-clip:text; background-clip:text; color:transparent;
  animation: opt-gradmove 4.5s linear infinite;
}
.inv-filter-sheet .opt-crypto::after{
  content:''; position:absolute; inset:-2px; border-radius:12px;
  padding:2px;
  background: conic-gradient(from 0deg,#ff4bd1,#ffd54b,#ff4bd1);
  -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor; mask-composite: exclude;
  animation: opt-rotate 6s linear infinite;
}

/* Pets */
.inv-filter-sheet .opt-pets{ --c: var(--c-pets); }
.inv-filter-sheet .opt-pets span{ color: var(--c-pets); }

/* Eggs */
.inv-filter-sheet .opt-eggs{ --c: var(--c-eggs); }
.inv-filter-sheet .opt-eggs span{ color: var(--c-eggs); }

/* Event (red pulse) */
.inv-filter-sheet .opt-event{ --c: var(--c-event); }
.inv-filter-sheet .opt-event span{ color: var(--c-event); }
.inv-filter-sheet .opt-event{ animation: opt-glow 1.8s ease-in-out infinite; }


/* === Remove Dodgers Event UI (button & overlay only) â€” keep items/data intact === */
.event-row{ display:none !important; }
#dodgerOverlay{ display:none !important; }

</style>
<style>
/* === Cosmic Event (Limited Time) === */
.icon-cosmic{ background: radial-gradient(circle at 30% 30%, #1a2a6c, #000428); position:relative; }
.icon-cosmic::after{
  content:""; position:absolute; inset:0; border-radius:20px; pointer-events:auto;
  background: radial-gradient(2px 2px at 25% 35%, #ffd84a 0 60%, transparent 60%),
              radial-gradient(2.5px 2.5px at 68% 22%, #8fd3ff 0 60%, transparent 60%),
              radial-gradient(1.6px 1.6px at 70% 64%, #ffd84a 0 60%, transparent 60%),
              radial-gradient(1.8px 1.8px at 44% 76%, #8fd3ff 0 60%, transparent 60%);
  animation: cosmicBtnSparkle 3.5s linear infinite;
}
@keyframes cosmicBtnSparkle {
  0% { opacity: .7; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.02); }
  100% { opacity: .7; transform: scale(1); }
}

/* Event Sheet */
#cosmicOverlay .sheet{ background: radial-gradient(1200px 600px at 50% -200px, #0b1a35, #151823) #151823;
  color:#e6f3ff; border-color:#0b0f1a; }
#cosmicOverlay h2{ color:#7fd0ff; text-shadow:0 2px 0 rgba(0,0,0,.6); }
.cosmic-grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }
.cosmic-card{ background:#1f2433; border-radius:22px; border:4px solid #0d1222; padding:18px; min-height:170px;
  box-shadow: 0 12px 28px rgba(0,0,0,.45) }
.cosmic-card h3{ margin:0; font-family:"Russo One"; color:#d7ecff; }
.cosmic-desc{ opacity:.9; font-size:18px; }
.cosmic-price{ font-weight:900; font-size:20px; }
.cosmic-buy{ align-self:flex-end; padding:10px 16px; font-weight:900; border:none; border-radius:14px; cursor:pointer;
  background:linear-gradient(#59a7ff,#2973e3); color:#fff; }
.cosmic-badge{ font-family:"Bungee"; letter-spacing:1px; font-size:24px; -webkit-text-stroke:2px #000; }

/* Cosmic rarity label + sparkle */
.t-cosmic{
  color:#8fd0ff;
  text-shadow:0 0 8px rgba(0,180,255,.65), 0 0 16px rgba(0,120,255,.4);
  position:relative; font-weight:900;
}
.t-cosmic::after{
  content:""; position:absolute; left:-6px; top:-6px; right:-6px; bottom:-6px; pointer-events:auto;
  background: radial-gradient(1.5px 1.5px at 12% 30%, #ffd84a 0 60%, transparent 61%),
              radial-gradient(1.2px 1.2px at 72% 20%, #ffd84a 0 60%, transparent 61%),
              radial-gradient(1.8px 1.8px at 30% 78%, #ffd84a 0 60%, transparent 61%),
              radial-gradient(1.6px 1.6px at 86% 62%, #ffd84a 0 60%, transparent 61%);
  animation: cosmicSparkle 2.2s linear infinite;
}
@keyframes cosmicSparkle{
  0%{ background-position: 0 0, 0 0, 0 0, 0 0; opacity:.8; }
  50%{ background-position: 6px 6px, -4px 3px, 2px -5px, -6px -2px; opacity:1; }
  100%{ background-position: 0 0, 0 0, 0 0, 0 0; opacity:.8; }
}

/* Pull-up reward animation */
.cosmic-reveal{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1000;
  background: radial-gradient(800px 400px at 50% 50%, rgba(15,22,40,.86), rgba(0,0,0,.85));
}
.cosmic-reveal.show{ display:flex; }
.cosmic-reveal .card{
  background:#0e1628; border:5px solid #0a0f1a; border-radius:24px; padding:22px; text-align:center; color:#e6f3ff;
  box-shadow:0 0 80px rgba(80,180,255,.28), 0 20px 60px rgba(0,0,0,.65);
  animation: popin .25s ease-out;
}
@keyframes popin{ from{ transform: scale(.8); opacity:0; } to{ transform: scale(1); opacity:1; } }
.cosmic-reveal img{ width:110px; height:110px; border-radius:16px; display:block; margin:8px auto; }

/* Background: Space View */
body.bg-spaceview{background:url('space_view_files/space_view.png') center center / cover no-repeat fixed !important;}
body.bg-spaceview::before{
  content:""; position:fixed; inset:0; z-index:-2; background:#04060c;
  background-image:
    radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.9) 0 60%, transparent 61%),
    radial-gradient(1px 1px at 30% 80%, rgba(255,255,255,.8) 0 60%, transparent 61%),
    radial-gradient(2px 2px at 70% 10%, rgba(255,255,255,.9) 0 60%, transparent 61%),
    radial-gradient(1px 1px at 80% 70%, rgba(255,255,255,.9) 0 60%, transparent 61%);
  animation: starDrift 24s linear infinite;
}
@keyframes starDrift { 0%{ background-position: 0 0, 0 0, 0 0, 0 0; } 100%{ background-position: -500px 240px, -200px 160px, -600px 400px, -300px 260px; } }
</style>
<style>
/* === LA Dodgers Event === */

/* Improved icon rendering via CSS var (works even if <img> fails) */
.icon-dodger{ 
  background:linear-gradient(180deg, #ffffff 0%, #dff1ff 35%, #9fd5ff 100%); position:relative; overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  box-shadow: inset 0 0 0 2px #cfe9ff, 0 6px 16px rgba(0,84,164,.15);
}
.icon-dodger::after{
  content: ""; position:absolute; inset:14%; border-radius:12px;
  background: var(--dodger-icon, none) center/contain no-repeat;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.4));
}
.icon-dodger .fallback-text{
  font-family:"Bungee", system-ui; font-weight:900; font-size:22px; letter-spacing:1px;
  color:#0a5aa8; text-shadow:0 2px 0 rgba(255,255,255,.7);
}
#dodgerShopLogo{ width: 140px; height: 100px; object-fit: contain; }
#dodgerShopLogo.fallback{
  display:grid; place-items:center; background:linear-gradient(180deg,#ffffff,#e6f4ff); color:#0a5aa8; font-weight:900; 
  width: 140px; height: 100px; border-radius:14px; box-shadow: inset 0 0 0 2px #cfe9ff;
}

.icon-dodger{ background:#0b2e6e; position:relative; overflow:hidden; }
.icon-dodger img{ width:64%; height:64%; object-fit:contain; image-rendering:auto; filter:drop-shadow(0 2px 6px rgba(0,0,0,.4)); }

#dodgerOverlay .sheet{ background: radial-gradient(1200px 600px at 50% -200px,#ffffff,#e9f5ff 45%,#cfe9ff 75%); color:#0d2640; border-color:#d2ebff; }
#dodgerOverlay h2{ color:#0b74ff; text-shadow:0 1px 0 rgba(255,255,255,.9); }
.dodger-grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }
.dodger-card{ background:rgba(255,255,255,.96); border-radius:22px; border:3px solid #d8ecff; padding:18px; min-height:170px; box-shadow:0 12px 28px rgba(0,84,164,.12); }
.dodger-card h3{ margin:0; font-family:"Russo One"; color:#0d3b66; }
.dodger-desc{ opacity:.9; font-size:18px; color:#123b5f; }
.dodger-price{ font-weight:900; font-size:20px; }
.dodger-buy{ align-self:flex-end; padding:10px 16px; font-weight:900; border:none; border-radius:14px; cursor:pointer; background:linear-gradient(#a6d9ff,#65b9ff); color:#093054; }

/* Dodger rarity label */
.t-dodger{
  color:#0b74ff;
  text-shadow:0 0 10px rgba(255,255,255,.9), 0 0 18px rgba(11,116,255,.55);
  position:relative; font-weight:900;
}

/* Blue & white animated waves around the placed item when rarity=DODGER */
.placed.dodger-waves::before,
.placed.dodger-waves::after{
  content:""; position:absolute; inset:-6px; border-radius:16px; pointer-events:auto;
  background: conic-gradient(from 0deg, rgba(255,255,255,0), rgba(255,255,255,.35) 15%, rgba(30,144,255,.55) 30%, rgba(255,255,255,.35) 45%, rgba(255,255,255,0) 60%);
  animation:dodgerSpin 3.2s linear infinite; mix-blend-mode: screen;
}
.placed.dodger-waves::after{ filter: blur(4px); animation-duration:5s; opacity:.6; }
@keyframes dodgerSpin{ to{ transform: rotate(360deg); } }

/* Background: Dodger Stadium Style */
body.bg-dodger{ background:url('la_dodgers_style_files/la_dodgers_style.png') center center / cover no-repeat fixed !important; }

/* Background: Sunrise (redeemable) */
body.bg-sunrise{
  background: url('background_files/sunrise_style.png') center center / cover no-repeat fixed !important;
}
</style>
<style>
/* === Backgrounds overlay: scrollable grid === */
#bgOverlay .sheet{
  max-height: min(92vh, 860px);
  display: flex;
  flex-direction: column;
  overflow: hidden; /* cap the dialog; inner grid will scroll */
}
#bgOverlay h2{ margin: 0 0 12px 0; }
#bgOverlay #bgGrid{
  flex: 1 1 auto;
  min-height: 0;
  overflow-y: auto;
  padding-right: 6px;   /* avoid content under scrollbar */
  scroll-behavior: smooth;
}

/* Optional: subtle custom scrollbar */
#bgOverlay #bgGrid::-webkit-scrollbar{ width: 10px; }
#bgOverlay #bgGrid::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.15); border-radius: 8px; }
#bgOverlay #bgGrid::-webkit-scrollbar-track{ background: transparent; }

@media (max-width: 800px){
  #bgOverlay .sheet{ max-height: min(92vh, 720px); }
}
</style>
<style id="no-scroll-patch">
  /* Lock the main page from scrolling; overlays handle their own internal scroll */
  html, body { overflow: hidden !important; height: 100%; }
</style>
<style id="event-row-style">
  .event-row{
    position: fixed;
    top: 16px;
    left: 16px;
    display: flex;
    gap: 12px;
    z-index: 9;
  }
  .event-row .icon-btn{
    width: 72px;
    height: 72px;
    border-radius: 16px;
  }
  .event-row .icon-btn svg{
    width: 60%;
    height: 60%;
  }
  @media (max-width: 800px){
    .event-row{ top: 12px; left: 12px; gap: 10px; }
    .event-row .icon-btn{ width: 64px; height: 64px; }
  }
</style>
<style id="no-scroll-patch">
  /* Restore scrolling for the whole page */
  html, body { 
    overflow-y: auto !important; 
    overflow-x: hidden; 
    height: auto !important; 
  }
  body { min-height: 100%; }
</style>
<style>
/* === CRYPTO rarity === */
.t-crypto{
  background: linear-gradient(90deg, #ff62d5, #ffd84a, #ff62d5);
  background-size: 200% auto;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  font-weight: 900;
  animation: cryptoShimmer 2.5s linear infinite;
}
@keyframes cryptoShift {
  0%   { background-position: 0% 50%;   letter-spacing: 1px; }
  50%  { background-position: 100% 50%; letter-spacing: 3px; }
  100% { background-position: 0% 50%;   letter-spacing: 1px; }
}
/* Glow on placed container when CRYPTO is present */
.crypto-glow{
  filter: drop-shadow(0 0 10px rgba(255,120,220,.85))
          drop-shadow(0 0 18px rgba(255,216,74,.6));
}
</style>
<style>
/* === Crypto Ring Animation (no letter movement) === */
@keyframes cryptoShimmer {
  0%   { background-position: 0% 50%; }
  50%  { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

@keyframes cryptoRingSpin {
  to { transform: rotate(360deg); }
}

.img-wrap{
  position: relative;
  display: inline-block;
  line-height: 0; /* eliminate inline gaps */
}

.img-wrap > img{
  display: block;
}

.img-wrap .crypto-ring{
  position: absolute;
  inset: -6px;           /* ring slightly outside the image bounds */
  border-radius: 50%;
  pointer-events: none;
  /* Create a donut ring using mask */
  --ring: 4px;
  background: conic-gradient(from 0deg, #ff62d5, #ffd84a, #ff62d5);
  -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - var(--ring)), #000 calc(100% - var(--ring)));
  mask: radial-gradient(farthest-side, transparent calc(100% - var(--ring)), #000 calc(100% - var(--ring)));
  animation: cryptoRingSpin 2.4s linear infinite;
  filter: drop-shadow(0 0 8px rgba(255,98,213,.45)) drop-shadow(0 0 10px rgba(255,216,74,.35));
}
</style>
<style>
/* Disable pedestal forge buttons entirely */
#exoticForgeBtn, #cryptoForgeBtn, #mythicForgeBtn {
  display: none !important;
  visibility: hidden !important;
  pointer-events: none !important;
}
</style>
<!-- Stranger Things Event styles -->
<style>
.icon-stranger{
  position:relative;
  width:64px;height:64px;
  border-radius:18px;
  background:#0b0b0b;
  box-shadow:0 6px 16px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.06);
  overflow:hidden;
}
.icon-stranger::after{
  content:"";
  position:absolute; inset:14%;
  background: var(--stranger-icon) center/contain no-repeat;
  filter: drop-shadow(0 6px 14px rgba(0,0,0,.35));
  border-radius:14px;
}
.icon-stranger .fallback-text{
  position:absolute; inset:0; display:grid; place-items:center;
  font-family:'Bungee', system-ui, sans-serif; font-weight:900;
  color:#d21d1d; letter-spacing:1px;
}
#strangerOverlay .sheet{
  width:min(980px, 92vw);
  background: radial-gradient(1200px 600px at 50% -10%, #5b0f12 0%, #2b0a0b 46%, #160507 100%);
  border:4px solid #111; border-radius:22px;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
  color:#fff;
}
#strangerTitle{
  font-family:'Bungee', system-ui, sans-serif;
  text-align:center;
  color:#ffd200;
  text-shadow:0 4px 0 #5c0d0d, 0 10px 35px rgba(255,215,0,.25);
  letter-spacing:2px;
}
.stranger-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:18px; padding:6px 16px 16px; }
@media (max-width:860px){ .stranger-grid{ grid-template-columns:1fr; } }
.stranger-card{
  display:flex; flex-direction:column; gap:8px; padding:16px;
  background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.35));
  border:2px solid rgba(255,255,255,.06); border-radius:16px;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}
.stranger-desc{ font-weight:800; opacity:.9; line-height:1.2; }
.stranger-price{ font-weight:900; color:#ffd84a; text-shadow:0 2px 0 rgba(0,0,0,.35); }
.stranger-buy{ padding:9px 14px; font-weight:900; border-radius:12px; border:none; cursor:pointer;
  background:linear-gradient(180deg,#ffa600,#ff6a00); color:#111; box-shadow:0 6px 18px rgba(255,165,0,.25);
}
#strangerShopLogo{ height:120px; filter: drop-shadow(0 8px 30px rgba(255,216,74,.35)); opacity:.96; }
.rar.t-demon{
  background:linear-gradient(45deg,#ff2b2b,#ff7a7a);
  color:#300; border:2px solid rgba(255,255,255,.25); box-shadow:0 3px 10px rgba(255,0,0,.25);
}
.demonized{ animation: demonBeat 1.25s infinite; }
@keyframes demonBeat{
  0%{ transform:scale(1); box-shadow:0 0 0 0 rgba(255,0,0,.35); }
  50%{ transform:scale(1.045); box-shadow:0 0 24px 12px rgba(255,0,0,.20); }
  100%{ transform:scale(1); box-shadow:0 0 0 0 rgba(255,0,0,.35); }
}
.cosmic-reveal#strangerReveal .card{ background:#1a0a0c; border-color:#0f0405; }

/* Toolbar behind-overlay blur fix: drop below overlay so it dims/blur like the others */
#toolBarArea{ z-index: 8 !important; }
</style>


<!-- override: enlarge Stranger Things icon on button -->
<style>
  .icon-stranger::after{ inset:6% !important; }
</style>


<!-- override: max-size Stranger Things icon and hide fallback text -->
<style>
  /* Fill the button with the icon artwork */
  .icon-stranger::after{ inset:0% !important; }
  /* Remove the 'ST' letters behind the icon */
  .icon-stranger .fallback-text{ display:none !important; }
</style>


<!-- v112 demon-persist patch: include `demon` in save() for inventory and placed items -->
</head>
<body>
<div class="event-row" id="eventRow"></div>
<div class="game">
<div class="topbar">
<div class="cash" id="cash">$1,000,000</div>
<div class="eps" id="eps">+ $0 / sec</div>
<div class="eps" id="multBadge"></div>
</div>
<div class="left-rail">
<div id="userDisplay" style="margin-bottom:16px;text-align:center;font-weight:bold;font-size:1.2em;color:#222;background:#fff7e0;padding:8px 0;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.10);">
<!-- Username will appear here -->
</div>
<button aria-label="Open shop" class="icon-btn icon-shop" id="openShop" title="Shop">
<svg fill="none" stroke="#e40000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24">
<circle cx="9" cy="21" r="1.8"></circle>
<circle cx="20" cy="21" r="1.8"></circle>
<path d="M1 2h3l3.6 12.4a2 2 0 0 0 2 1.6h7.8a2 2 0 0 0 2-1.6L23 6H6"></path>
</svg>
</button>
<button aria-label="Tools" class="icon-btn icon-tools" id="toolsBtn" title="Tools (toggle fast refresh)">
  <img src="icons/gear_shop_icon.png" alt="Gear Shop">
</button>
<!-- NEW: Pet Shop button (paw) -->
<button aria-label="Pet Shop" class="icon-btn icon-pets" id="openPetShop" title="Pet Shop"> <svg aria-hidden="true" fill="none" stroke="#111" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" viewbox="0 0 24 24">
<!-- toes -->
<circle cx="7.5" cy="7.5" r="2"></circle>
<circle cx="12" cy="6" r="2"></circle>
<circle cx="16.5" cy="7.5" r="2"></circle>
<circle cx="10" cy="10.5" r="1.8" style="display:none"></circle> <!-- (optional hidden) -->
<!-- main pad outline -->
<path d="M12 13c-2.8 0-6 2.2-6 5 0 2.2 3 3.5 6 3.5s6-1.3 6-3.5c0-2.8-3.2-5-6-5z"></path>
</svg>
</button>
<button aria-label="Toggle music" class="icon-btn icon-music" id="musicBtn" title="Toggle music">
<svg fill="none" stroke="#111" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" viewbox="0 0 24 24"><path d="M9 17V5l11-2v12"></path><circle cx="6" cy="18" r="2"></circle><circle cx="17" cy="16" r="2"></circle></svg>
</button>
</div>
<div class="stands" id="stands"></div>
<!-- Pet row will be rendered directly under stands inside renderStands -->
<!-- Forge button -->
<button id="forgeBtn" title="Forge 4 Legendaries into 1 Mythic">FORGE</button>
<!-- inventory is now fixed to bottom via CSS -->
<div class="inventory-wrap">
<div class="inventory" id="inventory"></div>
</div>
</div>
<div aria-hidden="true" class="overlay" id="shopOverlay">
<div aria-labelledby="shopTitle" aria-modal="true" class="shop" role="dialog">
<button aria-label="Close" class="closeX" id="closeShop">âœ•</button>
<h2 id="shopTitle">Shop</h2>
<div class="grid" id="shopGrid"></div>
<div class="refresh-note" id="refreshNote">Shop refreshes every 1:30</div>
</div>
</div>
<!-- Pet Shop Overlay -->
<div aria-hidden="true" class="overlay" id="petOverlay">
<div aria-labelledby="petTitle" aria-modal="true" class="shop" role="dialog">
<button aria-label="Close" class="closeX" id="closePetShop">âœ•</button>
<h2 id="petTitle">Pet Shop</h2>
<div class="grid">
<div class="card">
<h3>Pet Pedestal</h3>
<div style="font-size:18px; opacity:0.9;">Adds a pet pedestal below the pedestals. Max 2. Place eggs here to incubate.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$15,000,000</div>
<button class="buy" id="buyPetPedestal">Purchase</button>
</div>
<div id="petPedestalStatus" style="margin-top:6px;font-weight:700;color:#6dff79;"></div>
</div>
<div class="card">
<h3>Legendary Egg</h3>
<div style="font-size:18px; opacity:0.9;">Hatch into Dog / Cat / Gold Dog.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$10,000,000</div>
<button class="buy" id="buyLegendEgg">Purchase</button>
</div>
</div>
<div class="card">
<h3>Mythical Egg</h3>
<div style="font-size:18px; opacity:0.9;">Hatch into Lion / Bear / Dino.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$15,000,000</div>
<button class="buy" id="buyMythEgg">Purchase</button>
</div>
</div>
<div class="card">
<h3>Enchanted Egg</h3>
<div style="font-size:18px; opacity:0.9;">Hatch into Owl / Rainbow Panda / Flex T-Rex.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$25,000,000</div>
<button class="buy" id="buyEnchantedEgg">Purchase</button>
</div>
</div>
<div class="card">
<h3>Universal Egg</h3>
<div style="font-size:18px; opacity:0.9;">Hatch into Lizard / Alien / Hudsonâ€“Drakeâ€“Molly / Flex Dragon.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$1,000,000,000</div>
<button class="buy" id="buyUniversalEgg">Purchase</button>
</div>
</div>
<div class="card">
<h3>Magical Egg</h3>
<div style="font-size:18px; opacity:0.9;">Rainbow gradient + sparkles. Hatches: Frog / Tiger / Deer / Nellaâ€“Ozzyâ€“Chloe / Flexicorn.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$2,000,000,000</div>
<button class="buy" id="buyMagicalEgg">Purchase</button>
</div>
</div>
</div>
<div class="refresh-note" id="petNote">Pets hatch in 10 minutes</div>
</div>
</div>
<!-- Gear Overlay -->
<div aria-hidden="true" class="overlay" id="gearOverlay">
<div aria-labelledby="gearTitle" aria-modal="true" class="shop" role="dialog">
<button aria-label="Close" class="closeX" id="closeGear">âœ•</button>
<h2 id="gearTitle" style="color:#ff5050;text-align:center;">Gear</h2>
<div class="grid">
<!-- Rebirth Multiplier -->
<div class="card" id="rebirthCard">
<h3>Rebirth X <span id="rebirthLevelTag" style="font-size:18px;opacity:.8;">(Level 0)</span></h3>
<div style="font-size:18px; opacity:0.85;">Resets money to $1,000,000, increases multiplier. Max level 10.</div>
<!-- Redeem Overlay (small white modal) -->
<div aria-hidden="true" class="overlay" id="redeemOverlay">
<div aria-labelledby="redeemTitle" aria-modal="true" class="shop" role="dialog" style="max-width:520px;background:#fff;color:#111">
<button aria-label="Close" class="closeX" id="closeRedeem" style="color:#111">âœ•</button>
<h2 id="redeemTitle" style="color:#111;text-align:center;">Redeem Code</h2>
<div style="display:flex;flex-direction:column;gap:10px;margin-top:8px">
<input id="redeemInput" inputmode="numeric" maxlength="12" pattern="[0-9]*" placeholder="Enter 12â€‘digit code" style="padding:10px;border-radius:10px;border:1px solid #ccc;font-size:18px"/>
<div style="display:flex;gap:8px;justify-content:flex-end;align-items:center;margin-top:6px">
<button class="upgrade" id="doRedeem" style="background:#111;color:#fff">Redeem</button>
</div>
<div class="small" id="redeemMsg" style="min-height:20px;color:#111;opacity:.9"></div>
</div>
</div>
</div>
<div id="rebirthStatus" style="margin-top:6px;font-weight:700;color:#6dff79;">Current Rebirth Multiplier: x1</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price" id="rebirthPrice">$1,000,000,000</div>
<button class="upgrade" id="rebirthUpgrade">Upgrade</button>
</div>
</div>
<!-- Redeem Codes -->
<div class="card" id="redeemCard">
<h3>Redeem</h3>
<div style="font-size:18px; opacity:0.85;">Enter a 12â€‘digit redeem code to unlock an item, background, or pet.</div>
<div style="display:flex;justify-content:flex-end;align-items:center;">
<button class="buy" id="openRedeemOverlay">Enter redeem code</button>
</div>
</div>
<!-- Background Tool -->
<div class="card" id="backgroundCard">
<h3>Background Red/Blue</h3>
<div style="font-size:18px; opacity:0.85;">Switch gradient to red/blue.<br/>One-time purchase.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$4,000,000</div>
<button class="buy" id="buyBackground">Purchase</button>
</div>
<button class="buy" id="toggleBackground" style="display:none;background:linear-gradient(#ff7a7a,#6aaaff);">Disable</button>
</div>
<!-- Red Money Tool -->
<div class="card" id="redMoneyCard">
<h3>Red Money</h3>
<div style="font-size:18px; opacity:0.85;">Changes the top money banner to red/dark red.<br/>One-time purchase.</div>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div class="price">$1,000,000,000,000</div>
<button class="buy" id="buyRedMoney">Purchase</button>
</div>
<button class="buy" id="toggleRedMoney" style="display:none;background:linear-gradient(#ff6b6b,#8b0000);">Disable</button>
</div>
<div class="overlay hidden" id="settingsOverlay">
<h2>Settings</h2>
<div>
<button onclick="toggleBackground()">Toggle Background</button>
</div>
<div style="margin-top: 10px;">
<button onclick="downloadSave()">Download Save</button>
</div>
<div style="margin-top: 10px;">
<input accept=".json" id="uploadSaveInput" onchange="handleSaveUpload(event)" style="display:none" type="file"/>
<button onclick="document.getElementById('uploadSaveInput').click()">Upload Save</button>
</div>
</div>
</div>
</div>
</div>
<!--
  NOTE:
  The JavaScript from your original file is compatible with these layout changes.
  I intentionally left the script logic intact (no changes) â€” only the styles and layout were updated so the
  inventory bar sits fixed at the bottom like your concept art, pedestals/placed items are raised above it,
  and slots have larger sizes and a thick outlined container matching the visual.
-->
<!-- Log Out button replaces the old reset game button. It remains fixed in the same location -->
<!-- Log Out button will appear here (replaces old reset/delete user button).  Hidden by default; the script will
     toggle display when a user is logged in. -->
<button id="resetUserBtn" style="margin-left:20px;background:#e74c3c;color:#fff;padding:6px 8px;border-radius:12px;border:none;font-weight:bold;cursor:pointer;font-size:14px;white-space:nowrap;">Log Out</button>
<script>
// Removed the reset game handler.  The button in this position now logs the user out via separate logic.
/* ---------------------------
   Paste your entire original JavaScript here (unchanged).
   For brevity in this example I am keeping the JS unchanged from your provided code.
   Make sure to copy the whole <script> contents from your original file into this spot.
   --------------------------- */

  /*****************
   * GAME CONSTANTS
   * (full JS from original file goes here)
   *****************/

  const MONEY_START = 1_000_000;
  const STAND_COUNT = 4;
  const SHOP_SLOTS = 4;

  // --------------------------------------------------------------------------
  // Helper: ensure the main stands array always has the correct length.
  // Occasionally other scripts or corrupted saves can accidentally shrink or
  // expand the `state.stands` array.  Losing a pedestal entirely breaks
  // earnings, so this guard keeps the array at `STAND_COUNT` length.  It
  // preserves existing entries and pads with `null` as needed.  If the array
  // somehow grows too long, extra entries are trimmed off the end.
  function ensureStandsLength(){
    try{
      // If state or stands is missing, initialize a fresh array
      if(!state || !Array.isArray(state.stands)){
        state.stands = Array(STAND_COUNT).fill(null);
      } else {
        // Pad with nulls if too short
        while(state.stands.length < STAND_COUNT){
          state.stands.push(null);
        }
        // Trim extra entries if too long
        if(state.stands.length > STAND_COUNT){
          state.stands = state.stands.slice(0, STAND_COUNT);
        }
      }
    } catch(e){
      // On any unexpected error, reset to a clean slate
      state.stands = Array(STAND_COUNT).fill(null);
    }
  }

  const RARITY = {
    common: { label:'COMMON', color:'var(--c-common)', income: 50, price:[8_000, 40_000], prob: 0.60 },
    rare: { label:'RARE', color:'var(--c-rare)', income: 200, price:[40_000, 150_000], prob: 0.25 },
    epic: { label:'EPIC', color:'var(--c-epic)', income: 800, price:[150_000, 420_000], prob: 0.12 },
    legendary:{ label:'LEGENDARY', color:'var(--c-legendary)', income: 3000, price:[420_000, 920_000], prob: 0.03 },
    legacy:{ label:'LEGACY', color:'var(--c-legacy)', income: 8000, price:[900_000, 2_500_000], prob: 0.005 },
    birthday: { label:'BIRTHDAY', color:'#ff62d5', income: 15000, price:[0,0], prob: 0 },
    mythic:{ label:'MYTHIC', color:'var(--c-mythic)', income: 20000, price:[0,0], prob: 0 },
    unique:  { label:'UNIQUE', color:'navy', income: 10000, price:[2_500_000,4_000_000], prob: 0.003 },
    exotic:  { label:'EXOTIC', color:'cyan', income: 15000, price:[0,0], prob: 0 },
     crypto:  { label:'CRYPTO', color:'#ff62d5', income: 50000, price:[0,0], prob: 0 }
  };

  const ITEM_NAMES = [
    '24 King Crown','Donut','3D Printer','Space Nathan','Candy Blossom',
    'Frog Sneakers','Snake','Harry Potter\'s Wand','Retro Gameboy','Crystal Cube',
    'Swat Night','Flashforge','Blue Walls','Golden Spatula','Rainbow Headphones',
    'Red Government','Vecna','Aqua Drone','Burning Bud','Espresso',
    'Pixel Panda','Sabrina','Nether Portal','Alt','Natan',
    'Apple Watch','Chicken Jockey','67','Nathan\'s Playstation','Stale Goldfish Bag',
    'Duolingo','Dillon\'s PC','Apple','Icon of the Seas','North America',
    'Sheldon','Old Fan','$$$','McFlex','Junior Lifeguards',
    'Carl','Supreme','Nike Guy','Puma Socks','Blue',
    'Barbie','','Golden Jacket','Lucas Movies','Movie Clip Reel','Leo\'s Ethernet','Ryan\'s Hat','Lebron','Pigs\'s Blanket','Lamborghini','Dean\'s PC','USA','China','Iron Man\'s Helmet','Hanging Tree'
  ];
  while (ITEM_NAMES.length < 50) ITEM_NAMES.push('Item #' + (ITEM_NAMES.length+1));

  const ICON_PATHS = {
    "24 King Crown": `<path d="M18 62h60v10H18z M20 62l10-22 18 20 18-20 10 22" fill="none" stroke-width="6" stroke-linejoin="round"/>`,
    "Donut": `<circle cx="48" cy="48" r="26" fill="none" stroke-width="6"/><circle cx="48" cy="48" r="10" fill="none" stroke-width="6"/>`,
    "3D Printer": `<rect x="18" y="18" width="60" height="48" rx="6" fill="none" stroke-width="6"/><path d="M26 26h44v16H26zM48 42v20" fill="none" stroke-width="6"/>`,
    "Space Nathan": `<circle cx="48" cy="38" r="14" fill="none" stroke-width="6"/><rect x="34" y="52" width="28" height="22" rx="6" fill="none" stroke-width="6"/>`,
    "Candy Blossom": `<path d="M48 20v24M48 44c-14 0-14 18 0 18s14-18 0-18z" fill="none" stroke-width="6"/><circle cx="48" cy="20" r="6" fill="none" stroke-width="6"/>`,
    "Frog Sneakers": `<rect x="20" y="54" width="56" height="16" rx="8" fill="none" stroke-width="6"/><path d="M24 54c6-12 24-12 30 0" fill="none" stroke-width="6"/>`,
    "Snake": `<path d="M20 58c10-18 26-18 36-8s20 10 20 2-8-12-16-12" fill="none" stroke-width="6" stroke-linecap="round"/>`,
    "Harry Potter's Wand": `<path d="M20 74L76 18" fill="none" stroke-width="6"/><circle cx="76" cy="18" r="4" />`,
    "Retro Gameboy": `<rect x="28" y="16" width="40" height="64" rx="8" fill="none" stroke-width="6"/><rect x="34" y="22" width="28" height="24" rx="4" fill="none" stroke-width="6"/><circle cx="46" cy="56" r="4"/><circle cx="54" cy="60" r="4"/>`,
    "Crystal Cube": `<rect x="28" y="28" width="40" height="40" rx="6" fill="none" stroke-width="6"/><path d="M28 48h40M48 28v40" fill="none" stroke-width="6"/>`,
    "Swat Night": `<path d="M22 60h52l8-20H30z" fill="none" stroke-width="6"/><circle cx="34" cy="64" r="4"/><circle cx="62" cy="64" r="4"/>`,
    "Flashforge": `<path d="M24 48l24-24 24 24-24 24z" fill="none" stroke-width="6"/>`,
    "Blue Walls": `<rect x="20" y="24" width="56" height="44" rx="4" fill="none" stroke-width="6"/><path d="M20 46h56" fill="none" stroke-width="6"/>`,
    "Golden Spatula": `<path d="M48 22v44" fill="none" stroke-width="6"/><rect x="36" y="22" width="24" height="12" rx="2" fill="none" stroke-width="6"/>`,
    "Rainbow Headphones": `<path d="M26 48a22 22 0 0 1 44 0" fill="none" stroke-width="6"/><rect x="18" y="44" width="14" height="24" rx="6" fill="none" stroke-width="6"/><rect x="64" y="44" width="14" height="24" rx="6" fill="none" stroke-width="6"/>`,
    "Red Government": `<rect x="24" y="40" width="48" height="28" rx="4" fill="none" stroke-width="6"/><path d="M24 40l24-16 24 16" fill="none" stroke-width="6"/>`,
    "Vecna": `<path d="M48 20c-10 8-10 16 0 24 10-8 10-16 0-24z" fill="none" stroke-width="6"/><circle cx="48" cy="58" r="10" fill="none" stroke-width="6"/>`,
    "Aqua Drone": `<circle cx="48" cy="48" r="12" fill="none" stroke-width="6"/><path d="M20 48h16M60 48h16M48 20v16M48 60v16" fill="none" stroke-width="6"/>`,
    "Burning Bud": `<path d="M48 24c-18 12-18 28 0 40 18-12 18-28 0-40z" fill="none" stroke-width="6"/><path d="M36 66h24" fill="none" stroke-width="6"/>`,
    "Espresso": `<rect x="28" y="38" width="40" height="24" rx="4" fill="none" stroke-width="6"/><path d="M68 40h10v10a6 6 0 0 1-10 0z" fill="none" stroke-width="6"/>`,
    "Pixel Panda": `<rect x="28" y="28" width="40" height="40" fill="none" stroke-width="6"/><rect x="36" y="36" width="8" height="8"/><rect x="52" y="36" width="8" height="8"/>`,
    "Sabrina": `<circle cx="48" cy="38" r="12" fill="none" stroke-width="6"/><path d="M34 54h28l6 18H28z" fill="none" stroke-width="6"/>`,
    "Nether Portal": `<rect x="28" y="18" width="40" height="60" rx="6" fill="none" stroke-width="6"/><rect x="36" y="26" width="24" height="44" rx="3" fill="none" stroke-width="6" />`,
    "Alt": `<path d="M24 60l24-36 24 36" fill="none" stroke-width="6"/>`,
    "Natan": `<path d="M24 64l24-24 24 24" fill="none" stroke-width="6"/><circle cx="48" cy="34" r="6" fill="none" stroke-width="6"/>`,
    "Apple Watch": `<rect x="28" y="28" width="40" height="40" rx="10" fill="none" stroke-width="6"/><rect x="36" y="36" width="24" height="24" rx="6" fill="none" stroke-width="6"/>`,
    "Chicken Jockey": `<circle cx="36" cy="44" r="10" fill="none" stroke-width="6"/><rect x="42" y="48" width="26" height="18" rx="6" fill="none" stroke-width="6"/>`,
    "67": `<path d="M30 36h36M30 36v36M66 36v36M30 54h24" fill="none" stroke-width="6"/>`,
    "Nathan's Playstation": `<rect x="24" y="56" width="48" height="10" rx="4" fill="none" stroke-width="6"/><path d="M28 56h40l-6-16H34z" fill="none" stroke-width="6"/>`,
    "Stale Goldfish Bag": `<rect x="30" y="24" width="36" height="48" rx="6" fill="none" stroke-width="6"/><path d="M30 32h36" fill="none" stroke-width="6"/>`,
    "Duolingo": `<path d="M30 44l18-12 18 12-18 12z" fill="none" stroke-width="6"/><circle cx="40" cy="44" r="3"/><circle cx="56" cy="44" r="3"/>`,
    "Dillon's PC": `<rect x="24" y="28" width="48" height="30" rx="6" fill="none" stroke-width="6"/><rect x="34" y="60" width="28" height="6" rx="3" fill="none" stroke-width="6"/>`,
    "Apple": `<circle cx="48" cy="44" r="16" fill="none" stroke-width="6"/><path d="M48 26c4 0 6 2 8 4" fill="none" stroke-width="6"/>`,
    "Icon of the Seas": `<path d="M24 58h48l8-10H32z" fill="none" stroke-width="6"/><rect x="36" y="42" width="24" height="8" rx="2" fill="none" stroke-width="6"/>`,
    "North America": `<path d="M28 40l10-8 12 6 10-8 8 10-8 10-12 4-10-6z" fill="none" stroke-width="6"/>`,
    "Sheldon": `<circle cx="48" cy="36" r="10" fill="none" stroke-width="6"/><rect x="36" y="48" width="24" height="20" rx="8" fill="none" stroke-width="6"/>`,
    "Old Fan": `<circle cx="48" cy="48" r="18" fill="none" stroke-width="6"/><path d="M48 30v36M30 48h36" fill="none" stroke-width="6"/>`,
    "$$$": `<path d="M48 24v48M34 38c0-8 28-8 28 0s-28 8-28 16 28 8 28 0" fill="none" stroke-width="6"/>`,
    "McFlex": `<rect x="24" y="40" width="48" height="24" rx="6" fill="none" stroke-width="6"/><path d="M28 40c8-12 32-12 40 0" fill="none" stroke-width="6"/>`,
    "Junior Lifeguards": `<circle cx="48" cy="48" r="18" fill="none" stroke-width="6"/><path d="M48 30v36M30 48h36" fill="none" stroke-width="6"/>`,
    "Carl": `<path d="M36 32h24v12H36zM34 50h28v14H34z" fill="none" stroke-width="6"/>`,
    "Supreme": `<rect x="22" y="42" width="52" height="14" rx="7" fill="none" stroke-width="6"/>`,
    "Nike Guy": `<path d="M24 62c24-4 40-14 48-24-6 14-22 24-48 24z" fill="none" stroke-width="6" stroke-linecap="round"/>`,
    "Puma Socks": `<rect x="28" y="46" width="18" height="20" rx="4" fill="none" stroke-width="6"/><path d="M46 64h22v-14" fill="none" stroke-width="6"/>`,
    "Blue": `<circle cx="48" cy="48" r="20" fill="none" stroke-width="6"/>`,
    "Barbie": `<path d="M30 62c6-12 24-12 36 0" fill="none" stroke-width="6"/><circle cx="48" cy="40" r="10" fill="none" stroke-width="6"/>`,
    "": `<path d="M48 26l18 36H30z" fill="none" stroke-width="6"/>`,
    "Golden Jacket": `<rect x="26" y="28" width="44" height="36" rx="8" fill="none" stroke-width="6"/><path d="M26 44h44" fill="none" stroke-width="6"/>`,
    "Lucas Movies": `<rect x="26" y="34" width="44" height="28" rx="4" fill="none" stroke-width="6"/><rect x="24" y="38" width="8" height="20"/><rect x="64" y="38" width="8" height="20"/>`,
    "Movie Clip Reel": `<circle cx="36" cy="48" r="12" fill="none" stroke-width="6"/><circle cx="60" cy="48" r="12" fill="none" stroke-width="6"/><path d="M24 48h12M60 48h12" fill="none" stroke-width="6"/>`,
    "Leo's Ethernet": `<rect x="24" y="52" width="48" height="10" rx="3" fill="none" stroke-width="6"/><path d="M30 52V42h36v10" fill="none" stroke-width="6"/>`,
    "Ryan's Hat": `<path d="M24 54c8-18 40-18 48 0" fill="none" stroke-width="6"/><rect x="24" y="54" width="48" height="10" rx="5" fill="none" stroke-width="6"/>`,
    "Lebron": `<circle cx="48" cy="40" r="10" fill="none" stroke-width="6"/><rect x="34" y="52" width="28" height="20" rx="6" fill="none" stroke-width="6"/>`,
    "Pigs's Blanket": `<rect x="26" y="40" width="44" height="22" rx="6" fill="none" stroke-width="6"/><circle cx="34" cy="52" r="4"/>`,
    "Lamborghini": `<path d="M22 56h52l8-12H30z" fill="none" stroke-width="6"/><circle cx="34" cy="62" r="4"/><circle cx="62" cy="62" r="4"/>`,
    "Dean's PC": `<rect x="24" y="28" width="48" height="30" rx="6" fill="none" stroke-width="6"/><rect x="34" y="60" width="28" height="6" rx="3" fill="none" stroke-width="6"/>`,
    "USA": `<path d="M26 42h44M26 50h44M26 58h44" fill="none" stroke-width="6"/><rect x="26" y="34" width="16" height="16" fill="none" stroke-width="6"/>`,
    "China": `<rect x="28" y="34" width="40" height="28" fill="none" stroke-width="6"/><path d="M32 40l4-2 2 4" fill="none" stroke-width="6"/>`,
    "Iron Man's Helmet": `<path d="M32 24h32l8 16v20l-8 12H32L24 60V40z" fill="none" stroke-width="6"/>`,
    "Hanging Tree": `<path d="M30 66V26M30 32h28M58 32v22" fill="none" stroke-width="6"/><path d="M30 26c8-4 16-4 24 0" fill="none" stroke-width="6"/>`
  };

  function getItemSvg(name, idx, rarity){
    // Prefer file-based icon if we have one for this name
    try {
      if (ITEM_FILE_MAP && ITEM_FILE_MAP[name]) { return ITEM_FILE_MAP[name]; }
    } catch (e) {}
    
    const size = 96;
    const accentByRarity = {
        common:'#8ee78e',
        rare:'#6ec8ff',
        epic:'#c28bff',
        legendary:'#ffd86a',
        legacy:'#ffffff',
        mythic:'#ffd86a',
        unique:'navy',
        exotic:'cyan',
        crypto:'#ff62d5'
    };
    const accent = accentByRarity[rarity] || '#cfd3d7';
    const hue = (idx*53 + (rarity==='legendary'?40:rarity==='epic'?20:0)) % 360;
    const bg = `hsl(${hue} 65% 24%)`;
    const body = ICON_PATHS.hasOwnProperty(name) ? ICON_PATHS[name] : `<circle cx="48" cy="48" r="20" fill="none" stroke-width="6"/>`;
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 96 96">
      <defs>
        <filter id="d${idx}" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.35"/>
        </filter>
      </defs>
      <rect x="4" y="4" width="88" height="88" rx="14" fill="${bg}" />
      <g transform="translate(0,0)" filter="url(#d${idx})" stroke="${accent}">
        ${body}
      </g>
    </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }

  /* Simple egg SVG generator */
  
  /* Simple egg SVG generator (with 'universal' red/blue gradient support) */
  function getEggSvg(eggType, seed){
    const size=96;
    const colorMap = { legendary: '#ffd86a', mythical:'#ff9900', enchanted:'#33cc33' };
    const gradId = `ueg${seed}`;

    const ellipseFill = (eggType==='universal')
      ? `url(#${gradId})`
      : (colorMap[eggType] || '#ddd');

    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 96 96">
      <defs>
        <filter id="eg${seed}" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.35"/>
        </filter>
        ${eggType==='universal' ? `<linearGradient id="${gradId}" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#ff4b5c"/>
          <stop offset="100%" stop-color="#4b6aff"/>
        </linearGradient>` : ``}
      </defs>
      <rect x="4" y="4" width="88" height="88" rx="14" fill="#333" />
      <g filter="url(#eg${seed})">
        <ellipse cx="48" cy="52" rx="22" ry="28" fill="${ellipseFill}" />
        <ellipse cx="40" cy="40" rx="6" ry="4" fill="#fff" opacity="0.65"/>
      </g>
    </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }


function getPetSvg(petName, seed){
  // Normalize filename
  const nameMap = { "Dog": "dog.png",
    "Cat": "cat.png",
    "Dino": "dino.png",
    "Bear": "bear.png",
    "Lion": "lion.png",
    "Gold Dog": "gold_dog.png",
    "Owl": "owl.png",
    "Rainbow Panda": "rainbow_panda.png",
    "Flex T-Rex": "flex_t_rex.png",
    "Lizard": "lizard.png",
    "Alien": "alien.png",
    "Hudson": "hudson.png",
    "Drake": "drake.png",
    "Molly": "molly.png",
    "Flex Dragon": "flex_dragon.png",
    
  
"Frog": "frog.png",
"Tiger": "tiger.png",
    // Added special redeem-only pet Weston
"Weston": "weston.png",
"Deer": "deer.png",
"Ozzy": "ozzy.png",
"Nella": "nella.png",
"Chloe": "chloe.png",
"Flexicorn": "flexicorn.png",
};

  const file = nameMap[petName] || null;

  if (file) {
    // âœ… return direct PNG path (adjust folder if needed)
    return `pets/${file}`;
  }

  // ðŸ©¶ fallback placeholder if not found
  const size = 96;
  const hue = (seed * 97) % 360;
  const bg = `hsl(${hue} 60% 35%)`;
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 96 96">
    <rect x="4" y="4" width="88" height="88" rx="14" fill="${bg}" />
    <text x="48" y="58" font-size="14" font-weight="700" text-anchor="middle" fill="#fff">${escapeXml(petName.slice(0,6))}</text>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

  function escapeXml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function displayName(n){ return (n && n.trim()) ? n : 'Mystery'; }

  const LS_KEY = 'flex-save-v1';
  const LOCAL_BACKUP_KEY = 'flex-main-save-v3';
  const LOCAL_BACKUP_PREV = 'flex-main-save-v3-prev';
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const state = {
    money: MONEY_START,
    eps: 0,
    inventory: [],
    stands: [null,null,null,null],
    placed: {},
    selectedItemUid: null,
    fastMode: false,
    shop: { items:[], nextRefreshAt:0 },

    // new pet-related state:
    petPedestalsPurchased: 0,           // 0..2
    petStands: [null,null],             // each entry: null or { uid,name,isEgg,eggType,petType,petEps,svg,baseIdx }
    petTimers: {},                      // map index -> timestamp (ms) when hatch will happen
    permanentPetMultiplier: 1,
    rebirthLevel: 0           // becomes 5 if Flex T-Rex hatched
  };
  // Guard: only allow saving after a full load
  let __loadComplete = false;
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
 const SERVER_BASE = (()=>{  const p=new URLSearchParams(location.search).get('api');  const s=localStorage.getItem('flex_api_base');  const d='https://flex-sdww.onrender.com/api/game';  return p||s||d;})();

// Identify user (for demo, use a prompt and store in localStorage)
// Enhanced username prompt: allow players to request logging into an existing account.
let USER_ID = localStorage.getItem('flex-userid');

  // Flag to track whether we've shown the login choice overlay.  If this is
  // true and no user/pending is set, initLoginAndBoot() will early return
  // until the player makes a selection.
  window.__loginChoiceShown = false;

  /**
   * Display a modal overlay prompting the player to either log in to an
   * existing account or create a new one.  The provided callback will be
   * invoked with either the string `'login'` or `'create'` depending on
   * which button the player clicks.  This helper also marks the
   * `__loginChoiceShown` flag so the boot routine knows to wait.
   *
   * @param {Function} onChoice callback invoked with `'login'` or `'create'`
   */
  function showLoginOptionDialog(onChoice) {
    window.__loginChoiceShown = true;
    const overlay = document.createElement('div');
    overlay.id = 'loginOptionOverlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.65);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;';
    const box = document.createElement('div');
    box.style.cssText = 'background:#fff;color:#222;padding:20px 30px;border-radius:8px;max-width:90%;text-align:center;font-family:Russo One, sans-serif;box-shadow:0 4px 10px rgba(0,0,0,0.3)';
    box.innerHTML = '<h2 style="margin-top:0">Welcome to Flex!</h2>' +
      '<p style="margin:10px 0 20px;font-family:Rajdhani, sans-serif;font-size:16px;">Do you already have an existing account?</p>';
    const btnContainer = document.createElement('div');
    btnContainer.style.cssText = 'display:flex;justify-content:center;gap:20px;';
    const loginBtn = document.createElement('button');
    loginBtn.textContent = 'Log In';
    loginBtn.style.cssText = 'padding:10px 20px;font-size:16px;border-radius:5px;border:none;cursor:pointer;background:#4CAF50;color:#fff;font-family:Russo One, sans-serif;';
    const createBtn = document.createElement('button');
    createBtn.textContent = 'New Account';
    createBtn.style.cssText = 'padding:10px 20px;font-size:16px;border-radius:5px;border:none;cursor:pointer;background:#2196F3;color:#fff;font-family:Russo One, sans-serif;';
    loginBtn.addEventListener('click', () => {
      document.body.removeChild(overlay);
      window.__loginChoiceShown = false;
      if (typeof onChoice === 'function') onChoice('login');
    });
    createBtn.addEventListener('click', () => {
      document.body.removeChild(overlay);
      window.__loginChoiceShown = false;
      if (typeof onChoice === 'function') onChoice('create');
    });
    btnContainer.appendChild(loginBtn);
    btnContainer.appendChild(createBtn);
    box.appendChild(btnContainer);
    overlay.appendChild(box);
    document.body.appendChild(overlay);
  }

  // Track whether a pending-login overlay is active. When true, initLoginAndBoot()
  // will not re-run its pending-check alert.
  window.__pendingOverlayShown = false;

  /* ====== Remote login-request helpers ======
   * These helpers use the same game API used for save/load to store login requests
   * and approvals on the server.  This avoids relying on localStorage across
   * different HTML files (file:/// origins), which can prevent admin pages from
   * seeing requests created by the game.  Requests are stored under the
   * pseudoâ€‘user "__login_requests__" as an array of usernames.  Individual
   * approvals are stored under "__login_approved_<username>" as an object
   * like { approved:true }.  When a request is approved or cancelled it is
   * removed from the list.
   */
  async function fetchLoginRequests() {
    try {
      const res = await fetch(`${SERVER_BASE}/load?user=${encodeURIComponent('__login_requests__')}`, { cache:'no-store' });
      if (res && res.ok) {
        const data = await res.json().catch(() => null);
        return Array.isArray(data) ? data : [];
      }
    } catch (e) {}
    return [];
  }
  async function addLoginRequest(name) {
    try {
      const list = await fetchLoginRequests();
      if (!list.includes(name)) list.push(name);
      await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent('__login_requests__')}`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(list)
      });
    } catch (e) {}
  }
  async function removeLoginRequest(name) {
    try {
      let list = await fetchLoginRequests();
      list = list.filter(u => u !== name);
      await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent('__login_requests__')}`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(list)
      });
    } catch (e) {}
  }
  async function checkApproval(name) {
    try {
      const res = await fetch(`${SERVER_BASE}/load?user=${encodeURIComponent('__login_approved_' + name)}`, { cache:'no-store' });
      if (res && res.ok) {
        const data = await res.json().catch(() => null);
        return data && data.approved;
      }
    } catch (e) {}
    return false;
  }
  async function setApproval(name) {
    try {
      await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent('__login_approved_' + name)}`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ approved:true })
      });
    } catch (e) {}
  }
  async function clearApproval(name) {
    try {
      await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent('__login_approved_' + name)}`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: '{}' // mark as empty object
      });
    } catch (e) {}
  }

  /**
   * Display an overlay informing the player that their login request has been
   * submitted.  Provides a Cancel button that removes the request from the
   * server and local storage, then re-displays the login/new-account menu.  A
   * manual refresh is still needed once the owner has approved.  The overlay
   * sets __pendingOverlayShown to true so the boot routine doesnâ€™t show an
   * additional alert.
   *
   * @param {string} username the pending username
   */
  function showPendingLoginOverlay(username) {
    window.__pendingOverlayShown = true;
    const overlay = document.createElement('div');
    overlay.id = 'loginPendingOverlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.65);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;';
    const box = document.createElement('div');
    box.style.cssText = 'background:#fff;color:#222;padding:20px 30px;border-radius:8px;max-width:90%;text-align:center;font-family:Russo One, sans-serif;box-shadow:0 4px 10px rgba(0,0,0,0.3)';
    box.innerHTML = '<h2 style="margin-top:0">Login Request Sent</h2>' +
      '<p style="margin:10px 0 20px;font-family:Rajdhani, sans-serif;font-size:16px;">Your request to log into <strong>' + username.replace(/</g,'&lt;') + '</strong> has been sent.\nAsk the owner to approve it.\n\nOnce approved, refresh this page.\n\nYou can also cancel the request below.</p>';
    const btnContainer = document.createElement('div');
    btnContainer.style.cssText = 'display:flex;justify-content:center;gap:20px;';
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancel Request';
    cancelBtn.style.cssText = 'padding:10px 20px;font-size:16px;border-radius:5px;border:none;cursor:pointer;background:#f44336;color:#fff;font-family:Russo One, sans-serif;';
    cancelBtn.addEventListener('click', async () => {
      document.body.removeChild(overlay);
      window.__pendingOverlayShown = false;
      // remove from server and local state
      try { await removeLoginRequest(username); } catch(e){}
      localStorage.removeItem('flex_login_pending');
      // show login/new-account menu again
      showLoginOptionDialog(async (choice) => {
        if (choice === 'login') {
          // re-run login flow
          while (true) {
            let input = prompt('Enter your exact username to request login:');
            if (input === null) { alert('You must enter your username to request login.'); continue; }
            input = String(input).trim();
            if (!input) { alert('Please enter a non-empty username.'); continue; }
            localStorage.setItem('flex_login_pending', input);
            try { await addLoginRequest(input); } catch(e){}
            // show this overlay again
            USER_ID = null;
            const ud = document.getElementById("userDisplay");
            if (ud) ud.textContent = 'No user';
            showPendingLoginOverlay(input);
            break;
          }
        } else {
          // handle new account creation on cancel
          while (true) {
            let input = prompt('Enter a username to play (required).');
            if (input === null) { alert('A username is required.'); continue; }
            input = String(input).trim();
            if (!input || input.toLowerCase() === 'guest') { alert('Please enter a non-empty username. "guest" is not allowed.'); continue; }
            USER_ID = input;
            localStorage.setItem('flex-userid', USER_ID);
            try { sessionStorage.setItem('flex-userid-just-set','1'); } catch(e){}
            const ud = document.getElementById("userDisplay");
            if (ud) ud.textContent = USER_ID ? `User: ${USER_ID}` : 'No user';
            // boot game normally
            if (typeof initLoginAndBoot === 'function') initLoginAndBoot();
            break;
          }
        }
      });
    });
    btnContainer.appendChild(cancelBtn);
    box.appendChild(btnContainer);
    overlay.appendChild(box);
    document.body.appendChild(overlay);
  }
/*
 * We support two flows when a user first visits the game:
 *  1. Create a brand new account by picking a unique username.
 *  2. Request to log into an existing account (for example, if the player reset their computer or browser).
 *
 * Login requests are stored in localStorage under "flex_login_requests" as a JSON array. The owner/Admin
 * uses a separate admin page to approve these requests. Once approved, the admin page writes a key of the
 * form "flex_login_approved_<username>" with value "1" back into localStorage. This page periodically
 * checks for approval and, once granted, assigns USER_ID and continues loading the player's data.
 *
 * If a login request has been submitted by this browser (key: "flex_login_pending"), we hold off on prompting
 * again and instead wait for approval.
 */
if (!USER_ID) {
  const pendingLogin = localStorage.getItem('flex_login_pending');
  if (!pendingLogin) {
    // Present a friendly overlay with buttons for login or account creation instead of using confirm().
    showLoginOptionDialog(async function(choice) {
      if (choice === 'login') {
        // Prompt for the exact username and register a login request via the server.
        while (true) {
          let input = prompt('Enter your exact username to request login:');
          if (input === null) {
            alert('You must enter your username to request login.');
            continue;
          }
          input = String(input).trim();
          if (!input) {
            alert('Please enter a non-empty username.');
            continue;
          }
          // Save the pending request for this browser and push the request to the remote list.
          localStorage.setItem('flex_login_pending', input);
          try { await addLoginRequest(input); } catch (e) {}
          // Clear current user and update display
          USER_ID = null;
          const ud = document.getElementById("userDisplay");
          if (ud) ud.textContent = 'No user';
          // Show a pending overlay with a cancel option; do not immediately boot.
          showPendingLoginOverlay(input);
          break;
        }
      } else {
        // Create a new username (no empty values or "guest").
        while (true) {
          let input = prompt('Enter a username to play (required).');
          if (input === null) {
            alert('A username is required.');
            continue;
          }
          input = String(input).trim();
          if (!input || input.toLowerCase() === 'guest') {
            alert('Please enter a non-empty username. "guest" is not allowed.');
            continue;
          }
          USER_ID = input;
          localStorage.setItem('flex-userid', USER_ID);
          // Mark that we just set a username this session so load() can check uniqueness once.
          try { sessionStorage.setItem('flex-userid-just-set', '1'); } catch (e) {}
          break;
        }
        // Update display and start the boot process now that we have a username
        const ud = document.getElementById("userDisplay");
        if (ud) ud.textContent = USER_ID ? `User: ${USER_ID}` : 'No user';
        if (typeof initLoginAndBoot === 'function') initLoginAndBoot();
      }
    });
  } else {
    // The player has already requested a login but it hasn't been approved yet.
    USER_ID = null;
  }
}
// Update user display. If USER_ID is null (pending login), show a placeholder.
document.getElementById("userDisplay").textContent = USER_ID ? `User: ${USER_ID}` : "No user";

let __saveTimer = null;
async function save(){
  // If we have not loaded a save yet, do not write anything (prevents reset if user spam-refreshes)
  if(!__loadComplete){ return; }
  if(__saveTimer){ clearTimeout(__saveTimer); }
  // Batch saves occurring within 400ms
  await new Promise(r=>{ __saveTimer = setTimeout(()=>{ __saveTimer=null; r(); }, 400); });


  // Write a fast local backup first so spam-refresh can't wipe state
  const __nowTs = Date.now();

  const payload = {
    money: state.money,
    eps: state.eps,
    inventory: state.inventory.map(it=>({svg: it.svg, uid:it.uid,name:it.name,rarity:it.rarity,price:it.price,baseIdx:it.baseIdx,isEgg:it.isEgg,eggType:it.eggType,petType:it.petType,petEps:it.petEps,})),
    stands: state.stands,
    shop: state.shop,
    fastMode: state.fastMode,
    multiplierLevel,
    multiplierActiveUntil,
    multiplierCooldownUntil,
    backgroundPurchased,
    backgroundEnabled,
    redMoneyPurchased,
    redMoneyEnabled,

    placed: {},
    petPedestalsPurchased: state.petPedestalsPurchased,
    petStands: {}, // serialized by index
    petTimers: state.petTimers,
    permanentPetMultiplier: state.permanentPetMultiplier,
    petDex: (state.petDex || {}),
    rebirthLevel: state.rebirthLevel || 0,
    // Persist unlocked backgrounds, selected background and achievements (quests) to the server.  These
    // were previously only stored in localStorage via the addon, but now we include them in the
    // remote save so they travel with the user across browsers.
    unlockedBackgrounds: state.unlockedBackgrounds || {},
    selectedBackground: state.selectedBackground || 'default',
    ach: state.ach || { questsDone: {} }
  };
  for(const k in state.placed){
    const it = state.placed[k];
    if(it) payload.placed[k] = { uid: it.uid, name: it.name, rarity: it.rarity, price: it.price, baseIdx: it.baseIdx, demon: !!it.demon, svg: it.svg };
  }
  // serialize pet stands
  state.petStands.forEach((ps, idx) => {
    if(ps) payload.petStands[idx] = { uid:ps.uid, name:ps.name, isEgg:!!ps.isEgg, eggType:ps.eggType||null, petType:ps.petType||null, petEps:ps.petEps||0, svg:ps.svg, baseIdx: ps.baseIdx||0 };
  });

  // add timestamp and local backup
  try {
    payload.__ts = __nowTs;
    try {
      const cur = localStorage.getItem(LOCAL_BACKUP_KEY);
      if (cur) { try { localStorage.setItem(LOCAL_BACKUP_PREV, cur); } catch(e){} }
      localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify({ ts: payload.__ts, data: payload }));
    } catch (e) {}
    // If we haven't finished loading yet, don't touch the server to avoid wiping with defaults
    if (!__loadComplete) { return; }
    await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent(USER_ID)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
  } catch (e) {
    console.error('Failed to save game:', e);
  }
  await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent(USER_ID)}`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(payload),
  keepalive: true
});
}

async function load() {
  // Local backup candidate (mirrors how achievements/backgrounds persist)
  let __localCandidate = null;
  try {
    if (sessionStorage.getItem('doGameReset') === '1') {
      try { localStorage.removeItem(LOCAL_BACKUP_KEY); } catch (e) {}
      sessionStorage.removeItem('doGameReset');
    } else {
      const raw = localStorage.getItem(LOCAL_BACKUP_KEY);
      if (raw) { const obj = JSON.parse(raw); __localCandidate = obj && (obj.data || null); }
      // Also check a previous backup for safety
      let __localPrev = null; try{ const p = localStorage.getItem(LOCAL_BACKUP_PREV); if(p){ const pobj = JSON.parse(p); __localPrev = pobj && (pobj.data || null); } }catch(e){}
    }
  } catch (e) {}

  try {
    let dat = null;
    let res = null;
    try {
  res = await fetch(`${SERVER_BASE}/load?user=${encodeURIComponent(USER_ID)}`, { cache: 'no-store' });
} catch (e) {
  res = null;
}
    if (res && res.ok) { dat = await res.json(); } else { dat = __localCandidate; }
    // If the server returns nothing/empty, prefer the local backup
const isEmpty = !dat || (typeof dat === 'object' && Object.keys(dat).length === 0);
if (isEmpty && __localCandidate) dat = __localCandidate;
    if (!dat) {
  // First-time player: create a brand new save on the server and locally
  const fresh = {
    money: (typeof state !== 'undefined' && typeof state.money === 'number') ? state.money : (typeof MONEY_START !== 'undefined' ? MONEY_START : 0),
    eps: 0,
    inventory: [],
    stands: (typeof STAND_COUNT !== 'undefined' && Number(STAND_COUNT)) ? Array(STAND_COUNT).fill(null) : [null,null,null,null],
    shop: { items: [], nextRefreshAt: 0 },
    fastMode: false,
    multiplierLevel: 1,
    multiplierActiveUntil: 0,
    multiplierCooldownUntil: 0,
    backgroundPurchased: false,
    backgroundEnabled: false,
    redMoneyPurchased: false,
    redMoneyEnabled: false,
    placed: {},
    petPedestalsPurchased: 0,
    petStands: {},
    petTimers: {},
    permanentPetMultiplier: 1,
    petDex: {},
    rebirthLevel: 0,
    __ts: Date.now()
  };
  dat = fresh;
  try {
    localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify({ ts: fresh.__ts, data: fresh }));
  } catch(e) {}
  try {
    await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent(USER_ID)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(fresh)
    });
  } catch (e) {
    console.warn('Initial save create failed', e);
  }
}
    // Prefer the best of: server, local current, local prev
    try {
      const ldat = __localCandidate;
      const pdat = __localPrev;
      const lts = (ldat && ldat.__ts) ? ldat.__ts : 0;
      const pts = (pdat && pdat.__ts) ? pdat.__ts : 0;
      const sts = (dat && dat.__ts) ? dat.__ts : 0;
      const richness = d => !d ? -1 : ((d.inventory||[]).length) + (Array.isArray(d.stands)? d.stands.filter(Boolean).length : 0) * 2 + (d.petStands ? Object.keys(d.petStands).length : 0);
      let cand = dat; let cts = sts;
      if (ldat && ((lts > cts) || (lts === cts && richness(ldat) > richness(cand)))) { cand = ldat; cts = lts; }
      if (pdat && ((pts > cts) || (pts === cts && richness(pdat) > richness(cand)))) { cand = pdat; cts = pts; }
      // Integrity check: if candidate looks empty while another has meaningful progress, choose the richer one
      const looksEmpty = d => !d || (((d.inventory||[]).length===0) && (!d.money || d.money <= 1000000) && (!d.stands || d.stands.filter(Boolean).length===0));
      if (looksEmpty(cand)){
        const opts = [dat, ldat, pdat].filter(Boolean);
        let best = cand;
        for (const o of opts){ if (richness(o) > richness(best)) best = o; }
        cand = best || cand;
      }
      dat = cand;
    } catch (e) {}
// If this is the very first time we set a username this session and it's already in use on the server,
            // re-prompt until they choose a free, non-empty name (no "guest").
            try {
              const justSet = sessionStorage.getItem('flex-userid-just-set') === '1';
              if (justSet && USER_ID) {
                const hasServerSave = dat && typeof dat === 'object' && Object.keys(dat).length > 0;
                if (hasServerSave) {
                  alert('That username is already taken. Please choose another.');
                  while (true) {
                    const input = prompt('Enter a different username (required).');
                    if (input === null) { alert('A username is required.'); continue; }
                    const trimmed = String(input).trim();
                    if (!trimmed || trimmed.toLowerCase() === 'guest') {
                      alert('Please enter a non-empty username. "guest" is not allowed.');
                      continue;
                    }
                    // Check the new name against the server (best effort)
                    try {
                      const chk = await fetch(`${SERVER_BASE}/load?user=${encodeURIComponent(trimmed)}`, { cache: 'no-store' });
                      const j = chk.ok ? await chk.json().catch(()=>null) : null;
                      if (j && Object.keys(j).length) {
                        alert('That username is already taken. Try again.');
                        continue;
                      }
                    } catch (e) {
                      // Network check failed; accept the name to keep the game playable
                    }
                    USER_ID = trimmed;
                    localStorage.setItem('flex-userid', USER_ID);
                    const ud = document.getElementById("userDisplay");
                    if (ud) ud.textContent = USER_ID ? `User: ${USER_ID}` : "No user";
                    sessionStorage.removeItem('flex-userid-just-set');
                    // Re-run load under the new USER_ID and stop processing the old data
                    return await load();
                  }
                }
              }
              // Either not first set this session or name wasn't taken; clear the marker.
              sessionStorage.removeItem('flex-userid-just-set');
            } catch (e) {
              // ignore
            }state.money = dat.money ?? state.money;
    state.eps = dat.eps ?? state.eps;
    // Rebuild the inventory array from the loaded data.  If an item lacks
    // a proper PNG path in its `svg` field (either missing, an inline
    // `<svg>` string from an older save, or a nonâ€‘PNG), override it using
    // our ITEM_FILE_MAP or the appropriate helper (egg/pet/item).  This
    // ensures legacy saves and unobtainable items show the correct icon
    // immediately on load.
    state.inventory = (dat.inventory || []).map(it => {
      const name = it.name;
      let icon = it.svg;
      // Normalize the saved svg: ignore inline SVG strings or nonâ€‘PNG
      const isPng = (typeof icon === 'string' && /\.png($|\?)/i.test(icon));
      const looksInlineSvg = (typeof icon === 'string' && icon.trim().startsWith('<'));
      // Use a normalized key for lookup (trim + lowercase) so we catch names
      // with different casing or stray whitespace.
      const nameKey = name ? name.trim().toLowerCase() : '';
      if (!icon || looksInlineSvg || !isPng) {
        // If we have an explicit file path mapping (case sensitive or lowercase), use it
        if (ITEM_FILE_MAP && (ITEM_FILE_MAP[name] || ITEM_FILE_MAP[nameKey])) {
          icon = ITEM_FILE_MAP[name] || ITEM_FILE_MAP[nameKey];
        } else if (it.isEgg) {
          // Eggs use the special egg SVG generator
          icon = getEggSvg(it.eggType || 'legendary', Math.floor(Math.random() * 9999));
        } else if (it.petType) {
          // Pets should be resolved via getPetSvg.  Only call getPetSvg
          // for true pet items; non-pet items without a mapping should
          // fall back to the generated item SVG instead of a random pet
          // background.  See https://github.com/lucasmoviesstudios24/flex
          // for details on petType usage.
          try {
            icon = getPetSvg(it.petType || it.name, Math.floor(Math.random() * 9999));
          } catch (e) {
            // As a fallback, generate a standard item SVG rather than using a pet icon
            icon = getItemSvg(name, it.baseIdx || 0, it.rarity);
          }
        } else {
          // Fallback to generated SVG
          icon = getItemSvg(name, it.baseIdx || 0, it.rarity);
        }
      }
      return {
        ...it,
        uid: it.uid,
        svg: icon,
        baseIdx: it.baseIdx || 0
      };
    });
    state.stands = dat.stands ?? state.stands;
    state.shop = dat.shop ?? state.shop;
    state.fastMode = dat.fastMode ?? state.fastMode;
    state.placed = {};
    // NEW Gear persistence
    multiplierLevel = dat.multiplierLevel ?? 1;
    multiplierActiveUntil = dat.multiplierActiveUntil ?? 0;
    multiplierCooldownUntil = dat.multiplierCooldownUntil ?? 0;
    backgroundPurchased = dat.backgroundPurchased ?? false;
    backgroundEnabled = dat.backgroundEnabled ?? false;

    // Red Money
    redMoneyPurchased = dat.redMoneyPurchased ?? false;
    redMoneyEnabled = dat.redMoneyEnabled ?? false;
    if(redMoneyEnabled){ document.body.classList.add('money-red'); }

    if (backgroundPurchased) {
       document.getElementById("buyBackground").style.display = "none";
      document.getElementById("toggleBackground").style.display = "inline-block";
    }
    if (backgroundEnabled) {
      document.body.classList.add("redblue");
    }

    if(dat.placed){
      for(const k in dat.placed){
        const it = dat.placed[k];
        {
          const name = it.name;
          let icon = it.svg;
          const isPng = (typeof icon === 'string' && /\.png($|\?)/i.test(icon));
          const looksInlineSvg = (typeof icon === 'string' && icon.trim().startsWith('<'));
          const nameKey = name ? name.trim().toLowerCase() : '';
          if (!icon || looksInlineSvg || !isPng) {
            if (window.ITEM_FILE_MAP && (ITEM_FILE_MAP[name] || ITEM_FILE_MAP[nameKey])) {
              icon = ITEM_FILE_MAP[name] || ITEM_FILE_MAP[nameKey];
            } else if (it.isEgg) {
              icon = getEggSvg(it.eggType || 'legendary', Math.floor(Math.random() * 9999));
            } else if (it.petType) {
              try {
                icon = getPetSvg(it.petType || name, Math.floor(Math.random() * 9999));
              } catch (e) {
                icon = getItemSvg(name, it.baseIdx || 0, it.rarity);
              }
            } else {
              icon = getItemSvg(name, it.baseIdx || 0, it.rarity);
            }
          }
          state.placed[k] = { ...it, uid: it.uid, svg: icon, baseIdx: it.baseIdx || 0 };
        }
      }
    }

    // load pet stuff
    state.petPedestalsPurchased = dat.petPedestalsPurchased ?? state.petPedestalsPurchased;
    if(dat.petStands){
      for(const k in dat.petStands){
        const p = dat.petStands[k];
        state.petStands[Number(k)] = {
          uid: p.uid,
          name: p.name,
          isEgg: !!p.isEgg,
          eggType: p.eggType || null,
          petType: p.petType || null,
          petEps: p.petEps || 0,
          svg: p.svg || (p.isEgg ? getEggSvg(p.eggType||'legendary', Number(k)+Math.floor(Math.random()*9999)) : getPetSvg(p.petType||p.name, Number(k)+Math.floor(Math.random()*9999))),
          baseIdx: p.baseIdx||0
        };
      }
    }
    state.petTimers = dat.petTimers ?? state.petTimers;
    state.permanentPetMultiplier = dat.permanentPetMultiplier ?? state.permanentPetMultiplier;
    state.rebirthLevel = dat.rebirthLevel || 0;
    // PetDex (owned pets across eggs)
    state.petDex = dat.petDex || state.petDex || {};
    state.unlockedBackgrounds = dat.unlockedBackgrounds || state.unlockedBackgrounds || { default:true };
    state.selectedBackground = dat.selectedBackground || state.selectedBackground || 'default';

    // Merge achievements/quests from the remote save.  Previously, quest completions were
    // only stored locally via the addon, so merge them carefully to preserve any existing
    // progress in state.ach.  Include flags such as pet pedestal and pet unlocks when present.
    if (dat.ach) {
      state.ach = state.ach || { questsDone: {} };
      state.ach.questsDone = { ...(state.ach.questsDone || {}), ...(dat.ach.questsDone || {}) };
      if (dat.ach.petPedestalGranted) state.ach.petPedestalGranted = dat.ach.petPedestalGranted;
      if (dat.ach.petThirdUnlocked) state.ach.petThirdUnlocked = dat.ach.petThirdUnlocked;
      if (dat.ach.petFourthUnlocked) state.ach.petFourthUnlocked = dat.ach.petFourthUnlocked;
    }
    // Update local backup with the chosen data so rapid refresh can't regress
    try { localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify({ ts: dat.__ts || Date.now(), data: dat })); } catch (e) {}
  } catch (e) {
    console.warn("load failed", e);
  }
    // Mark load complete so future saves can hit the server safely
    __loadComplete = true;

}
  function fmt(n){ return n.toLocaleString(undefined,{maximumFractionDigits:0}); }
// Safely update the top-of-screen money and EPS displays.  Each DOM element
// lookup is guarded so that missing elements won't throw errors and freeze
// the game loop.  The multiplier badge update is also optional.
function updateTop(){
  try{
    const cashEl = $('#cash');
    if (cashEl) {
      cashEl.textContent = '$' + fmt(Math.max(0, Math.floor(state.money)));
    }
    const epsEl = $('#eps');
    if (epsEl) {
      epsEl.textContent = '+ $' + fmt(state.eps) + ' / sec';
    }
    if (typeof updateMultiplierBadge === 'function') {
      updateMultiplierBadge();
    }
  }catch(e){
    console.error('updateTop caught error:', e);
  }
}
function recalcEPS(){
  // Recalculate base EPS without multiplier; tolerant to uppercase/missing rarities
  let baseTotal = 0;

  state.stands.forEach(uid => {
    if(!uid) return;
    const it = state.placed[uid] || state.inventory.find(x => x.uid === uid);
    if(!it) return;
    
    console.log('EPS item check:', it.name, it.rarity);  // <--- ADD THIS
    
    const key = String(it.rarity || 'common').toLowerCase();
    const incomeVal = (RARITY[key] && Number(RARITY[key].income)) ? Number(RARITY[key].income) : 0;
    if(!RARITY[key]) console.warn('recalcEPS: unknown rarity for item', it.name, 'rarity:', it.rarity);
    baseTotal += incomeVal;
  });

  // Sum pet EPS (unchanged but coerced to number)
  let petTotal = 0;
  state.petStands.forEach(ps => {
    if(!ps) return;
    if(ps.petEps) petTotal += Number(ps.petEps) || 0;
  });

  // Combine and apply multipliers safely
  let combined = (Number(baseTotal) || 0) + (Number(petTotal) || 0);
  combined = combined * (Number(multiplierLevel) || 1) * (typeof getActivePedestalMultiplier==='function' ? getActivePedestalMultiplier() : 1);

  baseEPS = baseTotal; // keep base for reference
  state.eps = Math.floor(combined) || 0;
  updateTop();
  save();
}
  let lastTick = performance.now();
  // Main game loop.  We wrap all of the logic in a try/finally so that
  // unexpected errors never stop the requestAnimationFrame from firing.  This
  // prevents the game from "freezing" if a DOM element is missing or a
  // function throws.
  function tick(now){
    // Always schedule the next frame, even if an error occurs.  Use a
    // finally block to guarantee that requestAnimationFrame is called.
    try {
      // Make sure the stands array has the correct length.  Without this
      // check players could lose a pedestal and earnings would stop.
      if (typeof ensureStandsLength === 'function') {
        ensureStandsLength();
      }
      const dt = (now - lastTick) / 1000;
      lastTick = now;
      if (state.eps > 0) {
        // Update player money based on earnings per second and time delta
        state.money += state.eps * dt;
        // Update top bar values if possible
        try {
          updateTop();
        } catch (err) {
          console.error('updateTop error:', err);
        }
      }
      // Check pet timers (hatch) safely
      try {
        checkPetHatches();
      } catch (err) {
        console.error('checkPetHatches error:', err);
      }
    } catch (err) {
      // Catch any unexpected error so it doesn't kill the loop
      console.error('tick error:', err);
    } finally {
      requestAnimationFrame(tick);
    }
  }

function downloadSave() {
  try {
    const blob = new Blob([JSON.stringify(state)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "my-save.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    alert("Error saving file: " + err.message);
  }
}

function handleSaveUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      state = data; // overwrite game state

      // re-render everything
      renderStands();
      renderInventory();
      recalcEPS();
      save();

      alert("Save file loaded successfully!");
    } catch (err) {
      alert("Invalid save file.");
      console.error(err);
    }
  };
  reader.readAsText(file);
}



function rarityBadge(r){
  // normalize to lowercase key used in RARITY object
  const key = String(r || 'common').toLowerCase();
  const label = (RARITY[key] && RARITY[key].label) ? RARITY[key].label : String(r || 'COMMON');
  return `<span class="rar t-${key}">${label}</span>`;
}
  
  function renderInventory(){
    const wrap = $('#inventory');
    wrap.innerHTML='';
    state.inventory.forEach(it=>{
      const el = document.createElement('div');
      el.className = 'slot' + ((it.isEgg||it.petType)?' is-pet':'') + (state.selectedItemUid===it.uid?' selected':'');
      // badge: EGG or PET or rarity
      let badgeHtml = '';
      if(it.isEgg) badgeHtml = `<div class="rar" style="right:8px;bottom:8px;background:rgba(255,255,255,.12);color:#fff;">EGG</div>`;
      else badgeHtml = rarityBadge(it.rarity || 'common');

      el.innerHTML = `<img src='${(it.svg || ((it.name||'').toLowerCase()==='dodger world series champions' ? 'la_dodgers_items/dodger_world_series_champions.png' : getItemSvg(it.name, it.baseIdx||0, it.rarity||'common')))}' alt='${escapeXml(displayName(it.name))}'/><div style="position:absolute;top:6px;left:8px;font-size:12px;color:#fff;font-weight:700;text-shadow:0 1px 0 #000">${escapeXml(displayName(it.name))}</div>${badgeHtml}`;
      // Wrap the item image so we can overlay special effects (e.g., crypto ring)
      (function(){
        const img = el.querySelector('img');
        if (img && !img.closest('.img-wrap')) {
          const wrap = document.createElement('div');
          wrap.className = 'img-wrap';
          img.parentNode.insertBefore(wrap, img);
          wrap.appendChild(img);
          const rk = String(it.rarity||'').toLowerCase();
          if (rk === 'crypto') {
            const ring = document.createElement('span');
            ring.className = 'crypto-ring';
            wrap.appendChild(ring);
          }
        }
      })();
    
      el.style.setProperty('--rcolor', RARITY[it.rarity]?.color || 'var(--c-common)');
      const badge = el.querySelector('.rar');
      if(badge) {
        badge.style.border = '2px solid rgba(255,255,255,.25)';
        badge.style.color = '#111';
      }
      el.addEventListener('click',()=>{
        state.selectedItemUid = (state.selectedItemUid===it.uid?null:it.uid);
        renderInventory();
      });
      wrap.appendChild(el);
    });
  }

  function checkExoticForge() {
  const allLegacy = state.stands.every(uid => {
    if (!uid) return false;
    const it = state.placed[uid] || state.inventory.find(x => x.uid === uid);
    return it && it.rarity && it.rarity.toLowerCase() === 'legacy';
  });

  let btn = document.getElementById('exoticForgeBtn');
  if (allLegacy) {
    if (!btn) {
      btn = document.createElement('button');
      btn.id = 'exoticForgeBtn';
      btn.textContent = 'FORGE EXOTIC';
      btn.style.cssText = 'margin-top:6px;padding:10px 18px;border-radius:14px;background:linear-gradient(45deg, #7fefff, #4fd9ff);border:4px solid rgba(0,0,0,.35);color:#000;font-weight:900;box-shadow:0 8px 30px rgba(127,239,255,0.4);cursor:pointer;';
      btn.addEventListener('click', () => {
  // remove the 4 legacy items from stands
  for (const uid of state.stands) {
    if (uid) delete state.placed[uid];
  }
  state.stands = [null, null, null, null];

  // create new exotic item and place it on stand 0
  const newItem = (typeof _randomExotic==='function') ? _randomExotic() : (function(){ 
    const real = (typeof _getRealItemNames==='function') ? _getRealItemNames() : (Array.isArray(window.ITEM_NAMES)?window.ITEM_NAMES.slice():[]);
    const idx  = Math.floor(Math.random() * (real.length || 20));
    const name = real[idx] || '24 King Crown';
    const svg  = (typeof window.getItemSvg==='function') ? getItemSvg(name, idx, 'exotic') : '';
    return { uid: uid(), name, rarity:'exotic', price:0, baseIdx:idx, svg };
  })();

  state.placed[newItem.uid] = newItem;
  state.stands[0] = newItem.uid;  // place on first stand

  recalcEPS();
  renderInventory();
  renderStands();
  save();
});
      document.querySelector('.game').insertBefore(btn, document.querySelector('.inventory-wrap'));
    }
    btn.style.display = 'inline-block';
  } else if (btn) {
    btn.style.display = 'none';
  }
}

  
  function renderStands() {
  const area = document.getElementById('stands');
  area.innerHTML = '';
  for (let i = 0; i < STAND_COUNT; i++) {
    const box = document.createElement('div');
    box.className = 'stand';

    // The UID of the item placed on this stand (or null)
    const placed = state.stands[i];

    // Create the pedestal (always present)
    const ped = document.createElement('div');
    ped.className = 'pedestal';
    box.appendChild(ped);

    // If there is an item placed on this stand...
    if (placed) {
      // Find the item object (from placed or inventory)
      const it = state.placed[placed] || state.inventory.find(x => x.uid === placed);
      if (it) {
        // Create the div for the placed item
        const p = document.createElement('div');
        p.className = 'placed';
        p.innerHTML =
          `<img src='${it.svg}' style='width:64px;height:64px;border-radius:8px;margin-right:8px;' alt='${escapeXml(displayName(it.name))}'/>
           <div style="text-align:left">
             <strong>${escapeXml(displayName(it.name))}</strong><br>
             <span class="rar t-${it.rarity}">${RARITY[it.rarity].label}</span>
           </div>`;
        // Wrap the placed item image to overlay a crypto ring for CRYPTO rarity
        (function(){
          const img = p.querySelector('img');
          if (img && !img.closest('.img-wrap')) {
            const wrap = document.createElement('div');
            wrap.className = 'img-wrap';
            img.parentNode.insertBefore(wrap, img);
            wrap.appendChild(img);
            const rkey = String(it.rarity || '').toLowerCase();
            if (rkey === 'crypto') {
              const ring = document.createElement('span');
              ring.className = 'crypto-ring';
              wrap.appendChild(ring);
            }
          }
        })();
    

        p.style.border = '4px solid rgba(0,0,0,.45)';
        p.style.color = '#fff';

        // --- BADGE ANIMATION LOGIC ---
        // Select the badge element (the rarity label)
        const badge = p.querySelector('.rar');

const rkey = String(it.rarity || '').toLowerCase();

// birthday
if (rkey === 'birthday') {
  badge.classList.add('t-birthday');
}

// legacy (rainbow)
if (rkey === 'legacy') {
  badge.style.color = 'transparent';
  badge.style.background = 'linear-gradient(90deg, #ff004c, #ff7a00, #ffd400, #18e300, #00e7ff, #3a31ff, #ff31ff, #ff004c)';
  badge.style.backgroundSize = '400% 100%';
  badge.style.webkitBackgroundClip = 'text';
  badge.style.backgroundClip = 'text';
  badge.style.animation = 'rainbowShift 4s linear infinite';
}

// mythic (gold shimmer)
if (rkey === 'mythic') {
  badge.classList.add('t-mythic');
  p.classList.add('glow');
}

// unique: sparkle-ish badge + glow
if (rkey === 'unique') {
  badge.classList.add('t-unique');
  // no glow
}

// exotic: cyan glow + badge
if (rkey === 'exotic') {
  badge.classList.add('t-exotic');
  p.classList.add('glow-exotic');  // apply to the <p> element with the SVG
}

        box.appendChild(p);
      }
    }

    // Add click listener for placing/removing items
    box.addEventListener('click', () => {
      // If no item selected, remove placed item (if any)
      if (!state.selectedItemUid) {
        if (state.stands[i]) {
          const oldUid = state.stands[i];
          const oldItem = state.placed[oldUid] || null;
          if (oldItem) {
            state.inventory.push(oldItem);
            delete state.placed[oldUid];
          }
          state.stands[i] = null;
          recalcEPS();
          renderInventory();
          renderStands();
          save();
        }
        return;
      }

      // Remove old placed item if there is one
      if (state.stands[i]) {
        const oldUid = state.stands[i];
        const oldItem = state.placed[oldUid] || null;
        if (oldItem) {
          state.inventory.push(oldItem);
          delete state.placed[oldUid];
        }
        state.stands[i] = null;
      }

      // Place new item
      const newItem = state.inventory.find(it => it.uid === state.selectedItemUid);
      if (!newItem) return;

      state.placed[newItem.uid] = newItem;
      state.stands[i] = newItem.uid;

      state.inventory = state.inventory.filter(it => it.uid !== newItem.uid);
      state.selectedItemUid = null;

      recalcEPS();
      renderInventory();
      renderStands();

      // Glow animation for mythic
      const placedDiv = box.querySelector('.placed');
      if (placedDiv) {
        placedDiv.classList.add('glow');
        setTimeout(() => placedDiv.classList.remove('glow'), 700);
      }
      save();
    });

    area.appendChild(box);
  }

  // --- PET ROW (below main pedestals) ---
  let petRow = document.querySelector('.pet-row');
  if(!petRow){
    petRow = document.createElement('div');
    petRow.className = 'pet-row';
  } else {
    petRow.innerHTML = '';
  }

  // We want pet pedestals aligned so that pet0 is under main stand #2 (index 1),
  // and pet1 is under main stand #3 (index 2). We'll render four columns and
  // only place pedestals in columns 2 and 3 when purchased.
  for(let col=0; col<4; col++){
    const pbox = document.createElement('div');
    pbox.className = 'pet-stand';
    // If column matches where pet pedestals go:
    let placeIndex = null;
    if(col === 1 && state.petPedestalsPurchased >= 1) placeIndex = 0;
    if(col === 2 && state.petPedestalsPurchased >= 2) placeIndex = 1;

    if(placeIndex !== null){
      const pPed = document.createElement('div');
      pPed.className = 'pet-pedestal';
      pbox.appendChild(pPed);

      const placed = state.petStands[placeIndex];
      if(placed){
        const p = document.createElement('div');
        p.className = 'pet-placed';
        // If it's an egg, show egg image and name; if pet, show pet and badge
        const nameLabel = escapeXml(displayName(placed.name || (placed.petType || 'Pet')));
        p.innerHTML = `<img src='${placed.svg}' alt='${nameLabel}'/><div style="text-align:left"><strong>${nameLabel}</strong><br><span style="font-size:12px;color:#fff;opacity:.9">${placed.isEgg ? (placed.eggType || 'Egg') : (placed.petType || '')}</span></div>`;
        pbox.appendChild(p);

        // If egg incubating show timer badge
        if(placed.isEgg && state.petTimers[placeIndex]){
          const timer = document.createElement('div');
          timer.className = 'pet-timer';
          timer.dataset.index = placeIndex;
          pbox.appendChild(timer);
        }

        // Add special glow for Flex T-Rex pet
        if(!placed.isEgg && placed.petType === 'Flex T-Rex'){
          p.classList.add('glow');
        }
      }

      // Click handling for pet pedestal
pbox.addEventListener('click', () => {
  // If no selected item: remove placed item back to inventory
  if (!state.selectedItemUid) {
    const existing = state.petStands[placeIndex];
    if (existing) {
      state.inventory.push(existing);
      state.petStands[placeIndex] = null;
      delete state.petTimers[placeIndex];
      recalcEPS();
      renderInventory();
      renderStands();
      save();
    }
    return;
  }

  const newItem = state.inventory.find(it => it.uid === state.selectedItemUid);
  if (!newItem) return;
  // If a pet/egg is already here, return it to inventory before placing the new one
  const existingHere = state.petStands[placeIndex];
  if (existingHere) {
    state.inventory.push(existingHere);
    state.petStands[placeIndex] = null;
    delete state.petTimers[placeIndex];
  }


  // âœ… Allow eggs or pets here
  if (!(newItem.isEgg || newItem.petType)) {
    alert('Only eggs or pets can be placed on pet pedestals.');
    return;
  }

  // If placing an egg, start hatch timer
  if (newItem.isEgg) {
    state.petStands[placeIndex] = newItem;
            if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
    state.petTimers[placeIndex] = Date.now() + HATCH_DURATION;
  } else {
    // If placing a pet, no timer needed
    state.petStands[placeIndex] = newItem;
            if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
  }

  // Remove from inventory
  state.inventory = state.inventory.filter(it => it.uid !== newItem.uid);
  state.selectedItemUid = null;

  recalcEPS();
  renderInventory();
  renderStands();
  save();
});

    }
    petRow.appendChild(pbox);
  }

  // Insert or reinsert petRow after main stands
  area.parentNode.insertBefore(petRow, area.nextSibling);

  checkForge();
  checkExoticForge();
}

function weightedPick(){
  const r = Math.random();
  if (r < 0.003) return 'unique';                       // 0.3%
  if (r < 0.003 + 0.005) return 'legacy';               // 0.5%
  if (r < 0.003 + 0.005 + 0.01) return 'legendary';     // 1% (cumulative)
  if (r < 0.003 + 0.005 + 0.01 + 0.08) return 'epic';    // 8%
  if (r < 0.003 + 0.005 + 0.01 + 0.08 + 0.10) return 'rare'; // 10%
  return 'common';
}
  function priceFor(rarity){ const [a,b] = RARITY[rarity].price; return Math.floor(a + Math.random()*(b-a)); }
  function makeShopItems(){
    const items = [];
    const pool = ITEM_NAMES.slice();
    for(let i=0;i<SHOP_SLOTS;i++){
      const idx = Math.floor(Math.random()*pool.length);
      const name = pool.splice(idx,1)[0];
      const rarity = weightedPick();
      const baseIdx = idx;
      items.push({ uid: uid(), name, rarity, price: priceFor(rarity), svg: getItemSvg(name, baseIdx, rarity), baseIdx, purchased:false });
    }
    return items;
  }
  function ensureShop() {
  const now = Date.now();
  const REFRESH_INTERVAL = 90_000; // 1:30

  // Fix old saves or weird drift
  if (!state.shop.nextRefreshAt || state.shop.nextRefreshAt - now > REFRESH_INTERVAL) {
    state.shop.nextRefreshAt = now + REFRESH_INTERVAL;
  }

  // Refresh if needed
  if (now >= state.shop.nextRefreshAt || !state.shop.items?.length) {
    state.shop.items = makeShopItems();
    state.shop.nextRefreshAt = now + REFRESH_INTERVAL;
    save();
  }

  renderShop();
}
  function msToClock(ms){ ms = Math.max(0, ms); const s = Math.floor(ms/1000); const m = Math.floor(s/60); const sec = s%60; return `${m}:${String(sec).padStart(2,'0')}`; }
  let refreshTimer;
  function renderShop(){
    const grid = $('#shopGrid');
    grid.innerHTML='';
    state.shop.items.forEach((it, i)=>{
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `<div style='display:flex;gap:12px;align-items:center'>
        <img src='${it.svg}' style='width:72px;height:72px;border-radius:10px;flex:0 0 72px' alt='${escapeXml(displayName(it.name))}' />
        <div>
          <h3>${escapeXml(displayName(it.name))}</h3>
          <div class="tag t-${it.rarity}">${RARITY[it.rarity].label}</div>
        </div>
      </div>
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div class="price">$${fmt(it.price)}</div>
        <button class="buy">${it.purchased ? "Purchased!" : "Purchase"}</button>
      </div>`;
      const btn = card.querySelector('.buy');

      function setBtn(){
        if(it.purchased){
          btn.disabled = true;
          btn.textContent = 'Purchased!';
          btn.style.background = 'linear-gradient(#2ecc71,#1da85b)';
        } else {
          btn.disabled = state.money < it.price;
          btn.textContent = 'Purchase';
          btn.style.background = '';
        }
      }
      setBtn();

      btn.addEventListener('click',()=>{
        if(it.purchased) return;
        if(state.money < it.price) return;
        state.money -= it.price;
        const inv = { uid: uid(), name: it.name, rarity: it.rarity, price: it.price, svg: it.svg, baseIdx: it.baseIdx };
        state.inventory.push(inv);
        it.purchased = true;
        updateTop();
        renderInventory();
        save();
        setBtn();
      });
      grid.appendChild(card);
    });
    if(refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(()=>{
      const left = state.shop.nextRefreshAt - Date.now();
      $('#refreshNote').textContent = `Shop refreshes every ${msToClock(left)}`;
      if(left<=0){
        ensureShop();
      }
    }, 200);
  }

  let audioCtx, masterGain, musicOn=false;
  function initMusic(){ if(audioCtx) return; audioCtx = new (window.AudioContext || window.webkitAudioContext)(); masterGain = audioCtx.createGain(); masterGain.gain.value = 0.16; masterGain.connect(audioCtx.destination); const tempo = 90; const beat = 60/tempo; const pattern = [0,3,7,10,7,3]; const baseFreq = 220; function scheduleLoop(startTime){ for(let i=0;i<pattern.length;i++){ const t = startTime + i*beat*0.5; const freq = baseFreq * Math.pow(2, pattern[i]/12); const osc = audioCtx.createOscillator(); const g = audioCtx.createGain(); osc.type = 'square'; osc.frequency.value = freq; g.gain.value = 0; osc.connect(g); g.connect(masterGain); osc.start(t); g.gain.setValueAtTime(0.0, t); g.gain.linearRampToValueAtTime(0.08, t + 0.02); g.gain.linearRampToValueAtTime(0.0, t + beat*0.45); osc.stop(t + beat*0.5); } const pad = audioCtx.createOscillator(); const pg = audioCtx.createGain(); pad.type='sine'; pad.frequency.value = baseFreq*0.5; pg.gain.value=0.0; pad.connect(pg); pg.connect(masterGain); pad.start(startTime); pad.stop(startTime + pattern.length*beat*0.5); pg.gain.setValueAtTime(0.0, startTime); pg.gain.linearRampToValueAtTime(0.05, startTime + 0.1); pg.gain.linearRampToValueAtTime(0.0, startTime + pattern.length*beat*0.5); } function loop(){ const now = audioCtx.currentTime + 0.05; scheduleLoop(now); setTimeout(loop, (pattern.length*beat*0.5)*1000 - 40); } loop(); }
  function toggleMusic(){ if(!audioCtx){ initMusic(); } if(audioCtx.state === 'suspended') audioCtx.resume(); musicOn = !musicOn; masterGain.gain.value = musicOn ? 0.16 : 0.0; $('#musicBtn').style.filter = musicOn ? 'saturate(1.2)' : 'grayscale(1)'; }
  $('#musicBtn').addEventListener('click', ()=>{ toggleMusic(); });

  function checkForge(){
    const allLegendary = state.stands.every(uid=>{
      if(!uid) return false;
      const it = state.placed[uid] || state.inventory.find(x=>x.uid===uid);
      return it && it.rarity === 'legendary';
    });
    const btn = $('#forgeBtn');
    if(!btn) return;
    btn.style.display = allLegendary ? 'inline-block' : 'none';
  }
  function createMythicItem(){
    const idx = Math.floor(Math.random()*ITEM_NAMES.length);
    const name = ITEM_NAMES[idx] || ('Mythic Item');
    const baseIdx = idx;
    return { uid: uid(), name, rarity: 'mythic', price: 0, svg: getItemSvg(name, baseIdx, 'mythic'), baseIdx };
  }
  $('#forgeBtn').addEventListener('click', ()=>{
    if(!state.stands.every(uid => uid && (state.placed[uid]||state.inventory.find(x=>x.uid===uid)) && ((state.placed[uid]||state.inventory.find(x=>x.uid===uid)).rarity === 'legendary'))){
      return;
    }
    state.stands.forEach(uid => {
      if(uid && state.placed[uid]) delete state.placed[uid];
    });
    state.stands = Array(STAND_COUNT).fill(null);
    const mythic = createMythicItem();
    state.placed[mythic.uid] = mythic;
    state.stands[0] = mythic.uid;
    recalcEPS();
    renderInventory();
    renderStands();
    save();
  });
    
  

  $('#openShop').addEventListener('click',()=>{
    $('#shopOverlay').classList.add('show');
    ensureShop();
    $('#shopOverlay').setAttribute('aria-hidden','false');
  });
  $('#closeShop').addEventListener('click',()=>{
    $('#shopOverlay').classList.remove('show');
    $('#shopOverlay').setAttribute('aria-hidden','true');
  });
  $('#toolsBtn').addEventListener('click',()=>{
    state.fastMode = !state.fastMode;
    ensureShop();
    const msg = state.fastMode? 'Fast refresh: 15s' : 'Normal refresh: 5 min';
    $('#toolsBtn').title = 'Tools ('+msg+')';
    save();
  });

/* -------------------
   GEAR FEATURES
------------------- */
const MULTIPLIER_COST = 3_000_000;
const MULTIPLIER_DURATION = 20 * 60 * 1000; // 20 minutes
const MULTIPLIER_COOLDOWN = 30 * 60 * 1000; // 30 minutes
const BACKGROUND_COST = 4_000_000;

const RED_MONEY_COST = 1_000_000_000_000;
// === Rebirth Multiplier System ===
const REBIRTH_LEVEL_MULTS = [2,3,4,5,6,7,8,9,10];
const REBIRTH_LEVEL_COSTS = [1_000_000_000,20_000_000_000,40_000_000_000,75_000_000_000,125_000_000_000,400_000_000_000,700_000_000_000,1_000_000_000_000,10_000_000_000_000];

function getRebirthMultiplier(){ 
  const lvl = state.rebirthLevel || 0;
  if(lvl<=0) return 1;
  return REBIRTH_LEVEL_MULTS[Math.min(lvl-1, REBIRTH_LEVEL_MULTS.length-1)] || 1;
}
function nextRebirthCost(){
  const lvl = state.rebirthLevel || 0;
  if(lvl >= REBIRTH_LEVEL_MULTS.length) return null;
  return REBIRTH_LEVEL_COSTS[lvl];
}
function updateRebirthUI(){
  const lvl = state.rebirthLevel || 0;
  const mult = getRebirthMultiplier();
  const priceEl = document.getElementById("rebirthPrice");
  const levelTag = document.getElementById("rebirthLevelTag");
  const status = document.getElementById("rebirthStatus");
  const btn = document.getElementById("rebirthUpgrade");
  if(levelTag) levelTag.textContent = `(Level ${lvl})`;
  if(status) status.textContent = `Current Rebirth Multiplier: x${mult}`;
  const cost = nextRebirthCost();
  if(priceEl) priceEl.textContent = cost ? `$${fmt(cost)}` : 'MAXED';
  if(btn){
    if(cost===null){ btn.disabled = true; btn.textContent = 'Maxed'; }
    else { btn.disabled = state.money < cost; btn.textContent = 'Upgrade'; }
  }
}
function doRebirthUpgrade(){
  const cost = nextRebirthCost();
  if(cost===null) return;
  if(state.money < cost) return;
  state.rebirthLevel = (state.rebirthLevel||0) + 1;
  state.money = 1_000_000; // reset money only
  recalcEPS();
  updateTop();
  updateRebirthUI();
  save();
}

function updateMultiplierBadge(){
  const badge = document.getElementById('multBadge');
  if(!badge) return;
  const petMult = (typeof getActivePedestalMultiplier==='function' ? getActivePedestalMultiplier() : 1);
  const rebirthMult = getRebirthMultiplier();
  const hasAny = (petMult>1) || (rebirthMult>1);
  if(!hasAny){ badge.style.display='none'; badge.textContent=''; return; }
  // Display style rule per request: show as sum (e.g., x15 for pet x5 + rebirth x10)
  const displayVal = (petMult>1?petMult:0) + (rebirthMult>1?rebirthMult:0) || 1;
  badge.textContent = 'x' + displayVal;
  badge.style.display = 'inline-block';
}

let redMoneyPurchased = false;
let redMoneyEnabled = false;

let multiplierActiveUntil = 0;
let multiplierCooldownUntil = 0;
let multiplierLevel = 1; // 1x, 2x, 4x max

function applyMultiplier(eps) {
  return eps * multiplierLevel;
}

let multiplierTimer;

function updateMultiplierStatus() {
  const status = document.getElementById("multiplierStatus");
  const btn = document.getElementById("buyMultiplier");
  if (!status || !btn) return;

  if (multiplierTimer) clearInterval(multiplierTimer);

  function refresh() {
    const now = Date.now();

    // ðŸŸ¢ Case: 2x Active (allow upgrading to 4x)
    if (multiplierLevel === 2 && now < multiplierActiveUntil) {
      const left = Math.ceil((multiplierActiveUntil - now) / 1000);
      const min = Math.floor(left / 60);
      const sec = left % 60;
      status.textContent = `Active: 2x (${min}:${String(sec).padStart(2,"0")} left)`;

      btn.disabled = state.money < MULTIPLIER_COST;
      btn.textContent = "Upgrade to 4x";
      btn.style.background = "linear-gradient(#2ecc71,#1da85b)";

    // ðŸŸ¢ Case: 4x Active (fully maxed)
    } else if (multiplierLevel === 4 && now < multiplierActiveUntil) {
      const left = Math.ceil((multiplierActiveUntil - now) / 1000);
      const min = Math.floor(left / 60);
      const sec = left % 60;
      status.textContent = `Active: 4x (${min}:${String(sec).padStart(2,"0")} left)`;

      btn.disabled = true;
      btn.textContent = "4x Active";
      btn.style.background = "linear-gradient(#2ecc71,#1da85b)";

    // Cooldown
    } else if (now < multiplierCooldownUntil) {
      const left = Math.ceil((multiplierCooldownUntil - now) / 1000);
      const min = Math.floor(left / 60);
      const sec = left % 60;
      status.textContent = `Cooldown: ${min}:${String(sec).padStart(2,"0")}`;

      btn.disabled = true;
      btn.textContent = "Cooldown";
      btn.style.background = "";

    // Ready to buy again (no active, no cooldown)
    } else {
      status.textContent = "";
      btn.disabled = state.money < MULTIPLIER_COST;
      btn.textContent = "Purchase";
      btn.style.background = "";
    }
  }

  refresh();
  multiplierTimer = setInterval(refresh, 1000);
}



function buyMultiplier() {
  const now = Date.now();
  if (state.money < MULTIPLIER_COST) return;

  // If already at 4x, stop
  if (multiplierLevel >= 4) return;

  // If no multiplier active yet
  if (multiplierLevel < 2) {
    // Block cooldown if one is still running
    if (now < multiplierCooldownUntil) return;

    multiplierLevel = 2;
    multiplierActiveUntil = now + MULTIPLIER_DURATION;
    multiplierCooldownUntil = now + MULTIPLIER_COOLDOWN;

  // If already at 2x, upgrade to 4x without resetting timers
  } else if (multiplierLevel === 2) {
    multiplierLevel = 4;
    // Do NOT change multiplierActiveUntil or multiplierCooldownUntil
  }

  state.money -= MULTIPLIER_COST;

  // ðŸŸ¢ Apply EPS boost immediately
  recalcEPS();
  updateTop();
  updateRebirthUI();
  save();
}

// Background feature
let backgroundPurchased = false;
let backgroundEnabled = false;

function buyBackground() {
  if (backgroundPurchased) return;
  if (state.money < BACKGROUND_COST) return;
  state.money -= BACKGROUND_COST;
  backgroundPurchased = true;
  backgroundEnabled = true;
  document.body.classList.add("redblue");
  updateTop();
  document.getElementById("buyBackground").style.display = "none";
  document.getElementById("toggleBackground").style.display = "inline-block";
  save();
}

function toggleBackground() {
  if (!backgroundPurchased) return;
  backgroundEnabled = !backgroundEnabled;

  if (backgroundEnabled) {
    document.body.classList.add("redblue");
    document.getElementById("toggleBackground").textContent = "Disable";
  } else {
    document.body.classList.remove("redblue");
    document.getElementById("toggleBackground").textContent = "Enable";
  }

  save();
}



function updateRedMoneyUI(){
  const buy = document.getElementById("buyRedMoney");
  const tog = document.getElementById("toggleRedMoney");
  if(!buy || !tog) return;
  if(redMoneyPurchased){
    buy.style.display = "none";
    tog.style.display = "inline-block";
    tog.textContent = redMoneyEnabled ? "Disable" : "Enable";
    tog.disabled = false;
  }else{
    buy.style.display = "inline-block";
    tog.style.display = "none";
    buy.disabled = (state.money||0) < RED_MONEY_COST;
  }
  document.body.classList.toggle("money-red", !!redMoneyEnabled);
}

function buyRedMoney(){
  if(redMoneyPurchased) return;
  if((state.money||0) < RED_MONEY_COST) return;
  state.money -= RED_MONEY_COST;
  redMoneyPurchased = true;
  redMoneyEnabled = true;
  updateTop();
  updateRedMoneyUI();
  save();
}

function toggleRedMoney(){
  if(!redMoneyPurchased) return;
  redMoneyEnabled = !redMoneyEnabled;
  updateRedMoneyUI();
  save();
}

// Open/close Gear overlay
document.getElementById("toolsBtn").addEventListener("click", () => {
  document.getElementById("gearOverlay").classList.add("show");
  document.getElementById("gearOverlay").setAttribute("aria-hidden", "false");
  updateRebirthUI();
  updateRedMoneyUI();
});
document.getElementById("closeGear").addEventListener("click", () => {
  document.getElementById("gearOverlay").classList.remove("show");
  document.getElementById("gearOverlay").setAttribute("aria-hidden", "true");
});

// Gear button actions
document.getElementById("rebirthUpgrade")?.addEventListener("click", doRebirthUpgrade);
document.getElementById("buyBackground").addEventListener("click", buyBackground);
document.getElementById("toggleBackground").addEventListener("click", toggleBackground);
document.getElementById("buyRedMoney")?.addEventListener("click", buyRedMoney);
document.getElementById("toggleRedMoney")?.addEventListener("click", toggleRedMoney);

// Hook multiplier into EPS calculation
// --- Multiplier-aware EPS calculation ---
let baseEPS = 0;

const _recalcEPS = recalcEPS;
recalcEPS = function() {
  // Recalculate base EPS without multiplier
  let total = 0;
  state.stands.forEach(uid => {
    if (!uid) return;
    const it = state.placed[uid] || state.inventory.find(x => x.uid === uid);
    if (!it) return;
    total += RARITY[it.rarity].income;
  });
  baseEPS = total;

  // Sum pet EPS
  let petTotal = 0;
  state.petStands.forEach(ps => {
    if(!ps) return;
    if(ps.petEps) petTotal += ps.petEps;
  });

  let combined = baseEPS + petTotal;
  combined = combined * getRebirthMultiplier() * (typeof getActivePedestalMultiplier==='function' ? getActivePedestalMultiplier() : 1);
  state.eps = Math.floor(combined);

  updateTop();
  save();
};



/* -----------------------
   PET SHOP LOGIC
   ----------------------- */

const PET_PEDESTAL_COST = 15_000_000;
const EGG_COSTS = {legendary: 10_000_000, mythical: 15_000_000, enchanted: 25_000_000, universal: 1_000_000_000, magical: 2_000_000_000};
const HATCH_DURATION = 10 * 60 * 1000;
const FOURTH_HATCH_DURATION = 2 * 60 * 1000; // 10 minutes (ms)

// pet outcome tables & EPS values

// === PetDex tracking & counts ===
function ensurePetDex(){ if(!state.petDex) state.petDex = {}; return state.petDex; }
function registerPetOwned(name){ const dex = ensurePetDex(); if(name) dex[name]=true; }
function petCountsByEgg(){
  const totals={}, owned={};
  const dex = ensurePetDex();
  for(const [egg, list] of Object.entries(PET_TABLES)){
    if(egg === 'galaxy') continue; // Exclude Galaxy Egg from Pet Quests tallies
    const names=[];
    list.forEach(e => { if(e.name==='IRL' && Array.isArray(e.subset)) names.push(...e.subset); else names.push(e.name); });
    totals[egg]=names.length; owned[egg]=names.filter(n => !!dex[n]).length;
  }
  return {totals, owned};
}
function hasAllPets(){ const pc = petCountsByEgg(); return Object.keys(pc.totals).every(k => pc.owned[k]===pc.totals[k]); }
const PET_TABLES = { legendary: [
    { name: 'Dog',    chance: 0.70, eps: 300 },
    { name: 'Cat',    chance: 0.20, eps: 1200 },
    { name: 'Gold Dog', chance: 0.10, eps: 4000 }
  ],
  mythical: [
    { name: 'Lion', chance: 0.80, eps: 2000 },
    { name: 'Bear', chance: 0.15, eps: 6000 },
    { name: 'Dino', chance: 0.05, eps: 15000 }
  ],
  enchanted: [
    { name: 'Owl', chance: 0.94, eps: 1000 },
    { name: 'Rainbow Panda', chance: 0.05, eps: 12000 },
    { name: 'Flex T-Rex', chance: 0.01, eps: 50000 } // special: grants permanent 5x
  ]
  , universal: [
    { name: 'Lizard', chance: 0.52, eps: 10_000 },
    { name: 'Alien', chance: 0.44, eps: 15_000 },
    { name: 'IRL', subset: ['Hudson','Drake','Molly'], chance: 0.03, eps: 45_000 },
    { name: 'Flex Dragon', chance: 0.01, eps: 65_000 } // grants permanent 5x
  ]

  , magical: [
    { name: 'Frog', chance: 0.45, eps: 15_000 },
    { name: 'Tiger', chance: 0.32, eps: 20_000 },
    { name: 'Deer', chance: 0.19, eps: 25_000 },
    { name: 'IRL', subset: ['Nella','Ozzy','Chloe'], chance: 0.03, eps: 45_000 },
    { name: 'Flexicorn', chance: 0.005, eps: 80_000 } // x5 multiplier + Luck Boost (on pedestal)
  ]
};

function weightedPetPick(eggType){
  const list = PET_TABLES[eggType];
  const r = Math.random();
  let acc = 0;
  for(const p of list){
    acc += p.chance;
    if(r <= acc) return p;
  }
  return list[list.length-1];
}

function updatePetButtonsUI(){
  const btn = document.getElementById('buyPetPedestal');
  const status = document.getElementById('petPedestalStatus');
  if(!btn || !status) return;
  btn.disabled = state.petPedestalsPurchased >= 2 || state.money < PET_PEDESTAL_COST;
  if(state.petPedestalsPurchased >= 2){
    status.textContent = 'Max pedestals purchased';
    btn.textContent = 'Purchased';
    btn.style.background = 'linear-gradient(#2ecc71,#1da85b)';
  } else {
    status.textContent = `Purchased: ${state.petPedestalsPurchased}/2`;
    btn.textContent = 'Purchase';
    btn.style.background = '';
  }

  // egg buttons enable based on money
  document.getElementById('buyLegendEgg').disabled = state.money < EGG_COSTS.legendary;
  document.getElementById('buyMythEgg').disabled = state.money < EGG_COSTS.mythical;
  document.getElementById('buyEnchantedEgg').disabled = state.money < EGG_COSTS.enchanted;
}

// buy pedestal
function buyPetPedestal(){
  if(state.petPedestalsPurchased >= 2) return;
  if(state.money < PET_PEDESTAL_COST) return;
  state.money -= PET_PEDESTAL_COST;
  state.petPedestalsPurchased++;
  updateTop();
  updatePetButtonsUI();
  renderStands();
  save();
}

// buy egg functions: create egg inventory item
function buyEgg(type){
  const cost = EGG_COSTS[type];
  if(state.money < cost) return;
  state.money -= cost;
  const inv = {
    uid: uid(),
    name: (type.charAt(0).toUpperCase() + type.slice(1)) + ' Egg',
    isEgg: true,
    eggType: type,
    svg: getEggSvg(type, Math.floor(Math.random()*99999)),
    baseIdx: 0
  };
  state.inventory.push(inv);
  updateTop();
  renderInventory();
  save();
}

// Check pet timers and hatch if needed
function checkPetHatches(){
  const now = Date.now();
  let changed=false;
  for(const idxStr in state.petTimers){
    const idx = Number(idxStr);
    const t = state.petTimers[idx];
    if(!t) continue;
    // update timer UI elements (if any)
    const timerEl = document.querySelector(`.pet-timer[data-index='${idx}']`);
    if(timerEl){
      const left = Math.max(0, t - now);
      const s = Math.floor(left/1000);
      const m = Math.floor(s/60);
      const sec = s%60;
      timerEl.textContent = `${m}:${String(sec).padStart(2,'0')}`;
    }
    if(now >= t){
      // hatch
      const placed = state.petStands[idx];
      if(placed && placed.isEgg){
        // determine result
        const result = weightedPetPick(placed.eggType || 'legendary');
        let hatchName = result.name;
        if (result.name === 'IRL' && Array.isArray(result.subset)) {
          hatchName = result.subset[Math.floor(Math.random()*result.subset.length)];
        }
        registerPetOwned(hatchName);
        const petObj = {
          uid: uid(),
          name: hatchName,
          isEgg: false,
          eggType: null,
          petType: hatchName,
          petEps: result.eps,
          svg: getPetSvg(hatchName, Math.floor(Math.random()*99999))
        };
        // apply Flex T-Rex permanent multiplier if hatched
        if(result.name === 'Flex T-Rex' || result.name === 'Flex Dragon' || result.name === 'Flexicorn'){
          /* pedestal-based now; legacy flag neutralized */ state.permanentPetMultiplier = 1;
        }
        state.petStands[idx] = petObj;
        delete state.petTimers[idx];
        changed=true;
        if(hasAllPets()){
          state.ach = state.ach || {};
          if(!state.ach.petFourthUnlocked){ state.ach.petFourthUnlocked = true; }
        }
      } else {
        delete state.petTimers[idx];
      }
    }
  }
  if(changed){
    recalcEPS();
    renderInventory();
    renderStands();
    save();
  }
}

// Hook up pet UI open/close
$('#openPetShop').addEventListener('click', ()=>{
  $('#petOverlay').classList.add('show');
  $('#petOverlay').setAttribute('aria-hidden','false');
  updatePetButtonsUI();
});
$('#closePetShop').addEventListener('click', ()=>{
  $('#petOverlay').classList.remove('show');
  $('#petOverlay').setAttribute('aria-hidden','true');
});

document.getElementById('buyPetPedestal').addEventListener('click', buyPetPedestal);
document.getElementById('buyLegendEgg').addEventListener('click', ()=>buyEgg('legendary'));
document.getElementById('buyMythEgg').addEventListener('click', ()=>buyEgg('mythical'));
document.getElementById('buyEnchantedEgg').addEventListener('click', ()=>buyEgg('enchanted'));
document.getElementById('buyUniversalEgg').addEventListener('click', ()=>buyEgg('universal'));

/* -----------------------
   BOOT
----------------------- */


function reconcilePetDex(){
  try{
    if(!state.petDex) state.petDex = {};
    const add = (n)=>{ if(n) state.petDex[n]=true; };
    // from inventory
    (state.inventory||[]).forEach(it=>{ if(it && !it.isEgg){ add(it.petType || it.name); } });
    // from placed main pedestals
    Object.values(state.placed||{}).forEach(it=>{ if(it && !it.isEgg){ add(it.petType || it.name); } });
    // from pet pedestals
    (state.petStands||[]).forEach(p=>{ if(p && !p.isEgg){ add(p.petType || p.name); } });
  }catch(e){}
}
async function boot(){
  await load();
  // Apply the player's selected background and update quest completions after loading.
  try {
    if (state && state.selectedBackground && typeof applyBG === 'function') {
      applyBG(state.selectedBackground);
    }
  } catch (e) {}
  try {
    if (typeof persistAllCompletions === 'function') {
      persistAllCompletions();
    }
  } catch (e) {}
  reconcilePetDex();
  if(!state.money) state.money = MONEY_START;
  if(!state.stands || state.stands.length!==STAND_COUNT){
    state.stands = Array(STAND_COUNT).fill(null);
  }
  if(!state.placed) state.placed = {};
  updateTop();
  renderInventory();
  renderStands();
  recalcEPS();
  ensureShop();
  updateRebirthUI();

  requestAnimationFrame(tick);
}
/**
 * Initialize the game only after verifying the login state.
 * If a login request is pending, we wait for the owner to approve before proceeding.
 * When approved, the owner writes a key of the form "flex_login_approved_<username>" in localStorage.
 * This function checks for that approval and sets USER_ID accordingly. If there is no approval yet,
 * it displays an informational alert and aborts the boot process (the player can refresh later).
 */
async function initLoginAndBoot() {
  // If USER_ID is not set (null/undefined), we may need to handle pending login requests.
  if (!USER_ID) {
    // When the user menu is active and no pending request exists, wait for input.
    if (!localStorage.getItem('flex_login_pending') && window.__loginChoiceShown) {
      return;
    }
    const pending = localStorage.getItem('flex_login_pending');
    if (pending) {
      // If a pending overlay is visible, don't interrupt with an alert; the overlay handles cancel/refresh messaging.
      if (window.__pendingOverlayShown) {
        return;
      }
      // Check the server for approval of this username.
      const approved = await checkApproval(pending);
      if (approved) {
        // Assign the user, update localStorage and clean up server records.
        USER_ID = pending;
        localStorage.setItem('flex-userid', USER_ID);
        localStorage.removeItem('flex_login_pending');
        try { await removeLoginRequest(pending); } catch (e) {}
        try { await clearApproval(pending); } catch (e) {}
        // Update display
        const ud = document.getElementById('userDisplay');
        if (ud) ud.textContent = USER_ID ? `User: ${USER_ID}` : 'No user';
      } else {
        // Still waiting for approval. Inform the player and abort loading.
        alert('Your login request is still awaiting approval.\n\nPlease ask the owner to approve your request, then refresh this page.');
        return;
      }
    } else {
      // No USER_ID and no pending login: user may have cancelled; wait for them to choose again.
      return;
    }
  }
  // If we reach here, USER_ID is available; proceed to boot the game.
  await boot();

  // After loading, refresh achievements to reflect any quest completions/background unlocks.
  try {
    if (typeof window !== 'undefined' && typeof window.__achRefresh === 'function') {
      window.__achRefresh();
    }
  } catch (e) {}
}

// Kick off the initialization routine instead of calling boot() directly.
initLoginAndBoot();

// Replace the legacy resetUser handler with a Log Out handler.  This logs the user out
// by clearing the stored username and pending login request, then reloads the page
// so the login/create account menu is shown again.
// Re-purpose the existing reset user button as a Log Out button.  If the button
// exists, update its label and attach a handler that clears the stored username
// and pending login request.  When confirmed, the page reloads to show the login
// menu again.  If no reset user button is present, nothing happens.
{ const resetBtn = document.getElementById("resetUserBtn");
  if (resetBtn) {
    resetBtn.textContent = 'Log Out';
    // Make the handler asynchronous so we can await a save if needed.  In addition to
    // removing the username and pending request from localStorage, also clear any
    // sessionStorage flag used during account creation.  After clearing these, trigger
    // a full page reload so the game reâ€‘enters the login flow.  Without clearing
    // sessionStorage.flex-userid-just-set the USER_ID variable may be repopulated
    // immediately on reload, leaving the player logged in despite the reload.
    resetBtn.addEventListener("click", async function() {
      // If there is no current user we don't need to log out.  Simply return.
      if (!USER_ID) return;
      if (confirm("Are you sure you want to log out? You can log back in with your username later.")) {
        try {
          // Ensure any pending save completes before logging out.  Wrap in a
          // try/catch so a save failure doesn't prevent logout.
          if (typeof save === 'function' && __loadComplete) { await save(); }
        } catch (e) {}
        try { localStorage.removeItem("flex-userid"); } catch(e){}
        try { localStorage.removeItem("flex_login_pending"); } catch(e){}
        try { sessionStorage.removeItem('flex-userid-just-set'); } catch(e){}
        // Reset the inâ€‘memory USER_ID so subsequent code won't assume a player is logged in.
        USER_ID = null;
        // Immediately reload the page to reâ€‘run the login flow.  Using replace()
        // avoids creating a new history entry.
        location.replace(location.href);
      }
    });
  }
}

  

  window.addEventListener("beforeunload", save);
  window.addEventListener("pagehide", save);
  document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState === "hidden") try{ save(); }catch(e){} });

// Ensure Pet Shop opens scrolled to the top so the X is visible
(function(){
  const btn = document.getElementById('openPetShop');
  if (btn) {
    btn.addEventListener('click', () => {
      const overlay = document.getElementById('petOverlay');
      const sheet = overlay ? overlay.querySelector('.shop') : null;
      if (sheet) sheet.scrollTop = 0;
      if (overlay) overlay.scrollTop = 0;
    });
  }
})();

</script>
<!-- Right-side buttons -->
<div class="right-rail">
<!-- Achievements -->
<button class="icon-achievements" id="openAchievements" onclick="document.getElementById('achOverlay').classList.add('show'); window.__achRefresh &amp;&amp; window.__achRefresh();" title="Achievements">
<svg fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" viewbox="0 0 24 24">
<circle cx="12" cy="8" r="6"></circle><path d="M8 14v6l4-2 4 2v-6"></path>
</svg>
</button>
<!-- Background Changer (middle) -->
<button class="bg-selector-btn" id="openBgSelector" onclick="document.getElementById('bgOverlay').classList.add('show'); window.__renderBgGrid &amp;&amp; window.__renderBgGrid();" title="Backgrounds">
<svg fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" viewbox="0 0 24 24">
<path d="M21 21H3V3h18zM7 17l3-4 2 3 3-5 2 6H7z"></path>
</svg>
</button>
<!-- Delete Mode (bottom) -->
<button aria-pressed="false" class="delete-toggle-btn" id="deleteToggleBtn" title="Toggle deletion mode">
<svg aria-hidden="true" fill="none" height="40" stroke="#e84545" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2" viewbox="0 0 24 24" width="40">
<polyline points="3 6 5 6 21 6"></polyline>
<path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
<line x1="10" x2="10" y1="11" y2="17"></line>
<line x1="14" x2="14" y1="11" y2="17"></line>
</svg>
<!-- Inventory Filters (under Trash) -->
<button aria-controls="invFilterSheet" aria-expanded="false" class="inv-filter-toggle" id="invFilterToggle" title="Quick inventory filters">
<svg aria-hidden="true" fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24">
<polyline points="6 9 12 15 18 9"></polyline>
</svg>
</button>
</button></div>
<!-- Achievements Overlay -->
<div aria-hidden="true" class="overlay" id="achOverlay">
<div aria-labelledby="achTitle" aria-modal="true" class="sheet" role="dialog">
<button aria-label="Close" class="closeX" id="closeAchievements" onclick="document.getElementById('achOverlay').classList.remove('show')">âœ•</button>
<h2 id="achTitle">Achievements</h2>
<div class="achv-wrap">
<div class="rarity-rail" id="rarityRail">
<div class="rail-btn" data-tab="quests"><span>QUESTS</span><span class="badge-dot" id="questsDot"></span></div>
<div class="rail-btn" data-tab="petquests"><span>PET QUESTS</span><span class="badge-dot" id="dot-petquests"></span></div>
<div class="rail-btn" data-tab="common"><span>COMMON</span><span class="badge-dot" id="dot-common"></span></div>
<div class="rail-btn" data-tab="rare"><span>RARE</span><span class="badge-dot" id="dot-rare"></span></div>
<div class="rail-btn" data-tab="epic"><span>EPIC</span><span class="badge-dot" id="dot-epic"></span></div>
<div class="rail-btn" data-tab="legendary"><span>LEGENDARY</span><span class="badge-dot" id="dot-legendary"></span></div>
<div class="rail-btn" data-tab="legacy"><span>LEGACY</span><span class="badge-dot" id="dot-legacy"></span></div>
<div class="rail-btn" data-tab="unique"><span>UNIQUE</span><span class="badge-dot" id="dot-unique"></span></div>
<div class="rail-btn" data-tab="exotic"><span>EXOTIC</span><span class="badge-dot" id="dot-exotic"></span></div>
<div class="rail-btn" data-tab="mythic"><span>MYTHIC</span><span class="badge-dot" id="dot-mythic"></span></div>
<div class="rail-btn" data-tab="crypto"><span>CRYPTO</span><span class="badge-dot" id="dot-crypto"></span></div>
</div>
<div id="achContent"></div>
</div>
</div>
</div>
<!-- Background Selector Overlay -->
<div aria-hidden="true" class="overlay" id="bgOverlay">
<div aria-labelledby="bgTitle" aria-modal="true" class="sheet" role="dialog">
<button aria-label="Close" class="closeX" id="closeBg" onclick="document.getElementById('bgOverlay').classList.remove('show')">âœ•</button>
<h2 id="bgTitle">Backgrounds</h2>
<div class="bg-grid" id="bgGrid"></div>
</div>
</div>
<script>
(function(){
  const RLIST=['common','rare','epic','legendary','legacy','unique','exotic','mythic','crypto'];
  const R2BG={common:'green',rare:'blue',epic:'purple',legendary:'orange',legacy:'legacy',unique:'unique',exotic:'exotic',mythic:'mythic',crypto:'crypto'};
  const BG={green:{c:'bg-green',l:'GREEN'},blue:{c:'bg-blue',l:'BLUE'},purple:{c:'bg-purple',l:'PURPLE'},orange:{c:'bg-orange',l:'ORANGE'},legacy:{c:'bg-legacy',l:'LEGACY'},unique:{c:'bg-unique',l:'UNIQUE'},exotic:{c:'bg-exotic',l:'EXOTIC'},mythic:{c:'bg-mythic',l:'MYTHIC'},crypto:{c:'bg-crypto',l:'CRYPTO'},redblue:{c:'redblue',l:'RED/BLUE'},rainbow:{c:'bg-rainbow',l:'RAINBOW'}};

  window.state=window.state||{};
  state.ach=state.ach||{questsDone:{},petPedestalGranted:false};
  state.unlockedBackgrounds=state.unlockedBackgrounds||{default:true};
  state.selectedBackground=state.selectedBackground||'default';

  const $=s=>document.querySelector(s);
  const $$=s=>Array.from(document.querySelectorAll(s));
  const keyOf=r=>String(r||'').toLowerCase();

  function countAll(fn){let n=0;(state.inventory||[]).forEach(i=>{try{if(fn(i))n++;}catch{}});Object.values(state.placed||{}).forEach(i=>{try{if(fn(i))n++;}catch{}});return n;}
  function countR(r){return countAll(i=>keyOf(i.rarity)===r);}
  function hasPlaced(r){return Object.values(state.placed||{}).some(i=>keyOf(i.rarity)===r);}
  function eggs(){return countAll(i=>!!i.isEgg);}

  function unlockBG(k){state.unlockedBackgrounds[k]=true;__renderBgGrid&&__renderBgGrid(); if(typeof save==='function') save();}
  function applyBG(k){
    document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-rainbow','redblue','bg-crypto');
    if(k==='default'){state.selectedBackground='default';return;}
    const d=BG[k]; if(!d) return;
    document.body.classList.add(d.c); state.selectedBackground=k;
  }

  const GLOBAL=[
    {id:'g_c15',label:'Purchase 15 Common',check:()=>countR('common')>=15},
    {id:'g_r15',label:'Purchase 15 Rare',check:()=>countR('rare')>=15},
    {id:'g_e5', label:'Own 5 Epic',check:()=>countR('epic')>=5},
    {id:'g_l2', label:'Own 2 Legendary',check:()=>countR('legendary')>=2},
    {id:'g_eg5',label:'Purchase 5 Eggs',check:()=>eggs()>=5},
    {id:'g_pl4',label:'Fill all 4 pedestals',check:()=>Array.isArray(state.stands)&&state.stands.every(Boolean)},
    {id:'g_maxpet',label:'Max Pet Pedestals',check:()=>(state.petPedestalsPurchased||0)>=2},
    {id:'g_u1', label:'Own a Unique',check:()=>countR('unique')>=1},
    {id:'g_ex1',label:'Own an Exotic',check:()=>countR('exotic')>=1},
    {id:'g_my1',label:'Own a Mythic',check:()=>countR('mythic')>=1}
  ];

  function __isDone(q){ return (state.ach && state.ach.questsDone && !!state.ach.questsDone[q.id]) || (!!q.check && q.check()); }

  const RQ={
    common:[
      {id:'c_own15',label:'Own 15 Common',check:()=>countR('common')>=15},
      {id:'c_place',label:'Place a Common',check:()=>hasPlaced('common')},
      {id:'c_own30',label:'Own 30 Common',check:()=>countR('common')>=30}
    ],
    rare:[
      {id:'r_own15',label:'Own 15 Rare',check:()=>countR('rare')>=15},
      {id:'r_place',label:'Place a Rare',check:()=>hasPlaced('rare')},
      {id:'r_own25',label:'Own 25 Rare',check:()=>countR('rare')>=25}
    ],
    epic:[
      {id:'e_own5',label:'Own 5 Epic',check:()=>countR('epic')>=5},
      {id:'e_place',label:'Place an Epic',check:()=>hasPlaced('epic')},
      {id:'e_own10',label:'Own 10 Epic',check:()=>countR('epic')>=10}
    ],
    legendary:[
      {id:'l_own2',label:'Own 2 Legendary',check:()=>countR('legendary')>=2},
      {id:'l_place',label:'Place a Legendary',check:()=>hasPlaced('legendary')},
      {id:'l_own4',label:'Own 4 Legendary',check:()=>countR('legendary')>=4}
    ],
    legacy:[
      {id:'lc_own1',label:'Own 1 Legacy',check:()=>countR('legacy')>=1},
      {id:'lc_place',label:'Place a Legacy',check:()=>hasPlaced('legacy')},
      {id:'lc_own2',label:'Own 2 Legacy',check:()=>countR('legacy')>=2}
    ],
    unique:[
      {id:'u_own1',label:'Own 1 Unique',check:()=>countR('unique')>=1},
      {id:'u_place',label:'Place a Unique',check:()=>hasPlaced('unique')},
      {id:'u_own2',label:'Own 2 Unique',check:()=>countR('unique')>=2}
    ],
    exotic:[
      {id:'x_own1',label:'Own 1 Exotic',check:()=>countR('exotic')>=1},
      {id:'x_place',label:'Place an Exotic',check:()=>hasPlaced('exotic')},
      {id:'x_own2',label:'Own 2 Exotic',check:()=>countR('exotic')>=2}
    ],
    mythic:[
      {id:'m_own1',label:'Own 1 Mythic',check:()=>countR('mythic')>=1},
      {id:'m_place',label:'Place a Mythic',check:()=>hasPlaced('mythic')},
      {id:'m_own2',label:'Own 2 Mythic',check:()=>countR('mythic')>=2}
    ]
  ,
crypto:[
  {id:'cr_own1',label:'Own 1 Crypto',check:()=>countR('crypto')>=1},
  {id:'cr_place',label:'Place a Crypto',check:()=>hasPlaced('crypto')},
  {id:'cr_own2',label:'Own 2 Crypto',check:()=>countR('crypto')>=2}
]};

  // Persist completions for ANY quest that is currently true (runs even when overlay is closed)
  function persistAllCompletions(){
    let changed=false;
    GLOBAL.forEach(q=>{ if(q.check && q.check() && !(state.ach.questsDone||{})[q.id]){ state.ach.questsDone[q.id]=true; changed=true; } });
    RLIST.forEach(r=>{ (RQ[r]||[]).forEach(q=>{ if(q.check && q.check() && !(state.ach.questsDone||{})[q.id]){ state.ach.questsDone[q.id]=true; changed=true; } }); });
    if(changed){ window.__addonSave&&__addonSave(); if(typeof save==='function') save(); }
  }

  function qRow(q){
    const now = !!(q.check && q.check());
    if(now){ state.ach.questsDone[q.id]=true; window.__addonSave&&__addonSave(); if(typeof save==='function') save(); }
    const ok = __isDone(q);
    const d=document.createElement('div');
    d.className='quest-card';
    d.innerHTML='<div class=\"q-left\">'
      + '<div class=\"q-check '+(ok?'ok':'')+'\">'+(ok?'âœ“':'')+'</div>'
      + '<div style=\"font-size:20px;font-weight:900;\">'+q.label+'</div>'
      + '</div>';
    return d;
  }

  function gDone(){ return GLOBAL.every(q => __isDone(q)); }

  function refresh(){
    // First, persist any newly-true quests permanently
    persistAllCompletions();

    const md=(id,done)=>{const el=document.getElementById(id); if(el) el.classList.toggle('done',!!done);};
    md('questsDot', gDone());
    RLIST.forEach(r=>{ const all=(RQ[r]||[]).every(q=>__isDone(q)); md('dot-'+r, all); });

    if(gDone() && !state.ach.petPedestalGranted){
  state.ach.petPedestalGranted=true;
  state.ach.petThirdUnlocked=true;
  if(!Array.isArray(state.petStands)) state.petStands=[null,null,null];
  if(!Array.isArray(state.petTimers)) state.petTimers=[null,null,null];
  if(typeof renderStands==='function') renderStands();
  if(typeof recalcEPS==='function') recalcEPS();
 window.__addonSave&&__addonSave();}

    Object.entries(R2BG).forEach(([r,b])=>{ if((RQ[r]||[]).every(q=>__isDone(q))) unlockBG(b); window.__addonSave&&__addonSave(); });
    if(RLIST.every(r => (RQ[r]||[]).every(q=>__isDone(q)))) unlockBG('rainbow'); window.__addonSave&&__addonSave();

    const active=document.querySelector('.rail-btn.active');
    if(active) renderTab(active.dataset.tab);

    if(typeof save==='function') save();
  }
  window.__achRefresh=refresh;

  function renderTab(tab){
    const host=document.getElementById('achContent'); if(!host) return;
    host.innerHTML='';
    if(tab==='quests'){
      const head=document.createElement('div');
      head.innerHTML='<h3 style=\"margin:8px 0 10px;font-family:Bungee;letter-spacing:1px;\">Quests</h3>'
        + '<div style=\"opacity:.85;margin-bottom:10px\">Complete the 10 quests to earn <span class=\"reward-pill\">+1 Pet Pedestal</span>.</div>';
      host.appendChild(head);
      GLOBAL.forEach(q=>host.appendChild(qRow(q)));
      const done=GLOBAL.filter(q=>__isDone(q)).length;
      const f=document.createElement('div'); f.style.cssText='margin-top:12px;font-weight:900;opacity:.9;';
      f.textContent='Progress: '+done+' / '+GLOBAL.length; host.appendChild(f);
      return;
    }
    if(tab!=='petquests'){
    const hdr=document.createElement('div');
    hdr.innerHTML='<h3 style=\"margin:8px 0 10px;font-family:Bungee;letter-spacing:1px;\">'+tab.toUpperCase()+'</h3>'
      + '<div style=\"opacity:.85;margin-bottom:10px\">Complete these to unlock a themed background '+(R2BG[tab]?'for this rarity':'')+'.</div>';
    host.appendChild(hdr);
    (RQ[tab]||[]).forEach(q=>host.appendChild(qRow(q)));
    const c=(RQ[tab]||[]).filter(q=>__isDone(q)).length;
    const f=document.createElement('div'); f.style.cssText='margin-top:12px;font-weight:900;opacity:.9;';
    f.textContent='Progress: '+c+' / '+(RQ[tab]||[]).length; host.appendChild(f);
    }
  
    if(tab==='petquests'){
      const head=document.createElement('div');
      head.innerHTML='<h3 style="margin:8px 0 10px;font-family:Bungee;letter-spacing:1px;">Pet Quests</h3>'
        + '<div style="opacity:.85;margin-bottom:10px">Collect pets from each egg. Complete them all to unlock a <span class="reward-pill">4th Pet Pedestal</span> (2â€‘minute hatch).</div>';
      host.appendChild(head);

      const pc = petCountsByEgg();
      Object.keys(PET_TABLES)
        // Hide Galaxy Egg from the Pet Quests UI and remove the Demoegg which
        // is only used for the Stranger Things event.  Without filtering out
        // 'demoegg', players see a quest for a pet that doesn't exist in the normal game.
        .filter(k => k !== 'galaxy' && k.toLowerCase() !== 'demoegg')
        .forEach(egg=>{
          const row=document.createElement('div');
        const owned = pc.owned[egg]||0, total = pc.totals[egg]||0;
        const pct = total? Math.floor((owned/total)*100) : 0;
        row.className='quest-card';
        row.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;width:100%;">'
          + '<div style="font-size:20px;font-weight:900;text-transform:capitalize;">'+egg+' Egg</div>'
          + '<div style="font-weight:900;">'+owned+' / '+total+'</div>'
          + '</div>'
          + '<div style="height:10px;background:rgba(0,0,0,.25);border-radius:8px;margin-top:6px;overflow:hidden;">'
          +   '<div style="height:100%;width:'+pct+'%;background:linear-gradient(90deg,#6dff79,#3ad0ff);"></div>'
          + '</div>';
        host.appendChild(row);
      });

      const all = hasAllPets();
      const f=document.createElement('div'); f.style.cssText='margin-top:12px;font-weight:900;opacity:.9;';
      f.textContent='Complete sets: '+ (all?'ALL DONE âœ…':'In progress');
      host.appendChild(f);
      const dot=document.getElementById('dot-petquests'); if(dot) dot.classList.toggle('done', all);
      if(all){ state.ach = state.ach || {}; state.ach.petFourthUnlocked = true; }
      return;
    }
}

  const rail=document.getElementById('rarityRail');
  if(rail){
    rail.addEventListener('click',e=>{
      const b=e.target.closest('.rail-btn'); if(!b) return;
      $$('.rail-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); renderTab(b.dataset.tab);
    });
    const first=rail.querySelector('[data-tab=\"quests\"]'); if(first){ first.classList.add('active'); renderTab('quests'); }
  }

  function __renderBgGrid(){
    const g=document.getElementById('bgGrid'); if(!g) return; g.innerHTML='';
    const tiles=[
      {k:'default',l:'DEFAULT',css:'background:linear-gradient(to bottom,#89CFF0,#90EE90);'},
      {k:'green',l:'GREEN',css:'background:linear-gradient(#3edc64,#1e6f2b);'},
      {k:'blue',l:'BLUE',css:'background:linear-gradient(#4aa3ff,#0b2e6e);'},
      {k:'purple',l:'PURPLE',css:'background:linear-gradient(#a76bff,#ff72c6);'},
      {k:'orange',l:'ORANGE',css:'background:linear-gradient(#ff9b3d,#b98200);'},
      {k:'legacy',l:'LEGACY',css:'background:linear-gradient(135deg,#ff7eb3,#ff2a68);'},
      {k:'unique',l:'UNIQUE',css:'background:linear-gradient(135deg,#0a1a4b,#123a8c);'},
      {k:'exotic',l:'EXOTIC',css:'background:linear-gradient(135deg,#cfefff,#a0a9b8);'},
      {k:'mythic',l:'MYTHIC',css:'background:linear-gradient(135deg,#FFD700,#B8860B);'},
      {k:'crypto',l:'CRYPTO',css:'background:linear-gradient(135deg,#ff62d5,#ffd84a);'},
      {k:'redblue',l:'RED/BLUE',css:'background:linear-gradient(#ff4b5c,#4b6aff);'},
      {k:'rainbow',l:'RAINBOW',css:'background:linear-gradient(135deg,#ff004c,#ff7a00,#ffd400,#18e300,#00e7ff,#3a31ff,#ff31ff);background-size:300% 300%;'}
    ];
    tiles.forEach(t=>{
      const el=document.createElement('div');
      el.className='bg-tile'+(!state.unlockedBackgrounds[t.k]?' locked':'');
      el.style.cssText+=t.css;
      el.innerHTML='<div style=\"font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)\">'+t.l+'</div>'
        + '<button class=\"buy bg-apply\" '+(!state.unlockedBackgrounds[t.k]?'disabled':'')+'>Apply</button>';
      el.querySelector('.bg-apply').onclick=()=>{ if(!state.unlockedBackgrounds[t.k])return; applyBG(t.k); if(typeof save==='function') save(); };
      g.appendChild(el);
    });
  }
  window.__renderBgGrid=__renderBgGrid;

  const tbtn=document.getElementById('toggleBackground');
  if(tbtn){ tbtn.addEventListener('click', ()=>{ state.unlockedBackgrounds.redblue=true; if(typeof save==='function') save(); }); }

  // Wrap lifecycle methods to ensure refresh runs on any major state change
  const _ri=window.renderInventory||function(){}; window.renderInventory=function(){ _ri(); refresh(); };
  const _rs=window.renderStands||function(){}; window.renderStands=function(){ _rs(); refresh(); };
  const _re=window.recalcEPS||function(){}; window.recalcEPS=function(){ _re(); refresh(); };

  // Initial sweep to persist any already-true quests
  setTimeout(()=>{ persistAllCompletions(); refresh(); },0);
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>
<script>
// --- Add-on: Third Pet Pedestal renderer (non-destructive) ---
(function(){
  const HATCH_DURATION = window.HATCH_DURATION || (60*1000*5); // fallback 5 min if not defined

  function ensureArrays(){
    if(!Array.isArray(state.petStands)) state.petStands=[];
    if(!Array.isArray(state.petTimers)) state.petTimers=[];
    while(state.petStands.length<3) state.petStands.push(null);
    while(state.petTimers.length<3) state.petTimers.push(null);
  }

  function renderThirdPetSlot(){
    if(!(state.ach && state.ach.petThirdUnlocked)) return;
    ensureArrays();
    const row = document.querySelector('.pet-row');
    if(!row) return;

    // If we already drew the second row once, clear it to avoid duplicates
    const old = row.querySelectorAll('.pet-stand.addon-second-row');
    old.forEach(n=>n.remove());

    // Create 4 boxes for the second row, but only col=1 gets the pedestal (index 2)
    for(let col=0; col<4; col++){
      const pbox=document.createElement('div');
      pbox.className='pet-stand addon-second-row';
      if(col===1){ // centered under the first two
        const placeIndex = 2;
        const pPed = document.createElement('div');
        pPed.className='pet-pedestal';
        pbox.appendChild(pPed);

        const placed = state.petStands[placeIndex];
        if(placed){
          const p = document.createElement('div');
          p.className='pet-placed';
          const nameLabel = (placed.name && placed.name.trim()) ? placed.name : (placed.petType||placed.eggType||'Pet');
          p.innerHTML = `<img src='${placed.svg}' alt='${nameLabel}' style="width:64px;height:64px;border-radius:12px;">`
                       + `<div class="name-badge"><span>${nameLabel}</span></div>`;
          pbox.appendChild(p);

          if(placed.isEgg && state.petTimers[placeIndex]){
            const timer=document.createElement('div');
            timer.className='pet-timer';
            timer.dataset.index=placeIndex;
            pbox.appendChild(timer);
          }
        }

        pbox.addEventListener('click', ()=>{
          // Remove if nothing selected
          if(!state.selectedItemUid){
            if(state.petStands[placeIndex]){
              state.inventory.push(state.petStands[placeIndex]);
              state.petStands[placeIndex]=null;
              state.petTimers[placeIndex]=null;
              if(typeof recalcEPS==='function') recalcEPS();
              if(typeof renderInventory==='function') renderInventory();
              if(typeof renderStands==='function') renderStands();
              if(typeof save==='function') save();
            }
            return;
          }

          const newItem = state.inventory.find(it => it.uid === state.selectedItemUid);
          if(!newItem) return;
  // If a pet/egg is already here, return it to inventory before placing the new one
  const existingHere = state.petStands[placeIndex];
  if (existingHere) {
    state.inventory.push(existingHere);
    state.petStands[placeIndex] = null;
    delete state.petTimers[placeIndex];
  }

          if(!(newItem.isEgg || newItem.petType)){
            alert('Only eggs or pets can be placed on pet pedestals.');
            return;
          }
          if(newItem.isEgg){
            state.petStands[placeIndex]=newItem;
            if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
            state.petTimers[placeIndex]=Date.now() + (window.HATCH_DURATION||HATCH_DURATION);
          }else{
            state.petStands[placeIndex]=newItem;
            if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
          }
          state.inventory = state.inventory.filter(it => it.uid !== newItem.uid);
          state.selectedItemUid = null;
          if(typeof recalcEPS==='function') recalcEPS();
          if(typeof renderInventory==='function') renderInventory();
          if(typeof renderStands==='function') renderStands();
          if(typeof save==='function') save();
        });
      }
      row.appendChild(pbox);
    }
  }

  // Wrap original renderStands safely
  const __origRenderStands = window.renderStands;
  if(typeof __origRenderStands==='function'){
    window.renderStands = function(){
      __origRenderStands.apply(this, arguments);
      try{ renderThirdPetSlot(); }catch(e){ /* no-op */ }
    };
  }

  // On load
  setTimeout(()=>{ try{ renderThirdPetSlot(); }catch(e){} }, 0);

  
function renderFourthPetSlot(){
  if(!(state.ach && state.ach.petFourthUnlocked)) return;

  // Ensure arrays have a 4th slot (index 3)
  if(!Array.isArray(state.petStands)) state.petStands = [null,null,null,null];
  while(state.petStands.length < 4) state.petStands.push(null);
  if(!Array.isArray(state.petTimers)) state.petTimers = [null,null,null,null];
  while(state.petTimers.length < 4) state.petTimers.push(null);

  const row = document.querySelector('.pet-row'); if(!row) return;

  // Ensure the "second row" placeholders (addon-second-row) exist and contain 4 boxes.
  let secondRow = Array.from(row.querySelectorAll('.pet-stand.addon-second-row'));
  if(secondRow.length !== 4){
    // Clear any partial second rows and rebuild them exactly once.
    row.querySelectorAll('.pet-stand.addon-second-row').forEach(n=>n.remove());
    for(let col=0; col<4; col++){
      const pbox=document.createElement('div');
      pbox.className='pet-stand addon-second-row';
      row.appendChild(pbox);
    }
    secondRow = Array.from(row.querySelectorAll('.pet-stand.addon-second-row'));
  }

  // The 3rd pedestal uses col===1, so place the 4th at col===2 within the SAME row.
  const placeIndex = 3; // fourth pet slot index in state
  const pbox = secondRow[2]; // column 2 (0-based) of the second row
  if(!pbox) return;

  // Clear prior content to prevent duplicates, then build pedestal + placed item if any.
  pbox.innerHTML = '';
  const pPed = document.createElement('div');
  pPed.className = 'pet-pedestal';
  pbox.appendChild(pPed);

  const placed = state.petStands[placeIndex];
  if(placed){
    const p = document.createElement('div');
    p.className='pet-placed';
    const nameLabel = (placed.name && placed.name.trim()) ? placed.name : (placed.petType||placed.eggType||'Pet');
    p.innerHTML = `<img src='${placed.svg}' alt='${nameLabel}' style="width:64px;height:64px;border-radius:12px;">`
                + `<div class="name-badge"><span>${nameLabel}</span></div>`;
    pbox.appendChild(p);

    if(placed.isEgg && state.petTimers[placeIndex]){
      const timer=document.createElement('div');
      timer.className='timer-badge';
      timer.textContent='â³';
      p.appendChild(timer);
    }
  } else { /* no placeholder */ }

  // Click behavior (swap-in/out and 2-minute hatch for eggs)
  pbox.addEventListener('click', ()=>{
    // If nothing selected, remove current pet/egg back to inventory
    if(!state.selectedItemUid){
      if(state.petStands[placeIndex]){
        state.inventory.push(state.petStands[placeIndex]);
        state.petStands[placeIndex] = null;
        state.petTimers[placeIndex] = null;
        if(typeof recalcEPS==='function') recalcEPS();
        if(typeof renderInventory==='function') renderInventory();
        if(typeof renderStands==='function') renderStands();
        if(typeof save==='function') save();
      }
      return;
    }
    const newItem = state.inventory.find(it => it.uid === state.selectedItemUid);
    if(!newItem) return;

    // If a pet/egg is already here, return it to inventory before placing the new one
    const existingHere = state.petStands[placeIndex];
    if (existingHere) {
      state.inventory.push(existingHere);
      state.petStands[placeIndex] = null;
      delete state.petTimers[placeIndex];
    }

    if(!(newItem.isEgg || newItem.petType)){
      alert('Only eggs or pets can be placed on pet pedestals.');
      return;
    }
    if(newItem.isEgg){
      state.petStands[placeIndex] = newItem;
      // 2-minute timer for the 4th pedestal
      const TWO_MIN = 2*60*1000;
      state.petTimers[placeIndex] = Date.now() + (window.FOURTH_HATCH_DURATION || TWO_MIN);
    }else{
      state.petStands[placeIndex] = newItem;
      if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
    }
    state.inventory = state.inventory.filter(it => it.uid !== newItem.uid);
    state.selectedItemUid = null;
    if(typeof recalcEPS==='function') recalcEPS();
    if(typeof renderInventory==='function') renderInventory();
    if(typeof renderStands==='function') renderStands();
    if(typeof save==='function') save();
  });
}


  (function(){
    const __rs = window.renderStands;
    if(typeof __rs==='function'){
      window.renderStands = function(){
        __rs.apply(this, arguments);
        try{ renderThirdPetSlot(); }catch(e){}
        try{ renderFourthPetSlot(); }catch(e){}
      };
    }
    setTimeout(()=>{ try{ renderFourthPetSlot(); }catch(e){} }, 0);
  })();
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>
<script>
// --- Add-on persistence for achievements + backgrounds ---
(function(){
  const KEY='flex_addon_persist_v1';
  function saveAddon(){
    try{
      const data={ach:state.ach, ubg:state.unlockedBackgrounds, sel:state.selectedBackground, pdx:(state.petDex||{})};
      localStorage.setItem(KEY, JSON.stringify(data));
    }catch(e){}
  }
  function loadAddon(){
    try{
      const raw=localStorage.getItem(KEY); if(!raw) return;
      const d=JSON.parse(raw);
      if(d.ach){
        state.ach=state.ach||{questsDone:{}};
        state.ach.questsDone={...(state.ach.questsDone||{}), ...(d.ach.questsDone||{})};
        state.ach.petPedestalGranted = state.ach.petPedestalGranted || !!d.ach.petPedestalGranted;
        state.ach.petThirdUnlocked = state.ach.petThirdUnlocked || !!d.ach.petThirdUnlocked;
      }
      if(d.ubg) state.unlockedBackgrounds={...(state.unlockedBackgrounds||{}), ...d.ubg};
      if(d.sel) { state.selectedBackground=d.sel; try{ if(state.selectedBackground!=='default'){ document.body.classList.add(state.selectedBackground.startsWith('bg-')?state.selectedBackground:({bg:'bg-'}) ); } }catch(e){} }
      if(d.pdx){ state.petDex = { ...(state.petDex||{}), ...d.pdx }; }
    }catch(e){}
  }
  // load immediately
  loadAddon();
  try{ if(state.selectedBackground && state.selectedBackground!=='default' && typeof applyBG==='function'){ applyBG(state.selectedBackground); } }catch(e){}

  // wrap global save to include addon data and persist locally
  const __save = window.save;
  window.save = async function(){
    try{ saveAddon(); }catch(e){}
    if(typeof __save === 'function'){ try{ return await __save.apply(this, arguments); }catch(e){ return; } }
  };
  window.addEventListener('beforeunload', saveAddon);
  window.__addonSave = saveAddon;
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>
<script>
(function(){
  // toggle button -> deletion mode
  window.state = window.state || {};
  state.deletionMode = false; // default OFF

  function reflectDeleteMode(){
    const on = !!state.deletionMode;
    document.body.classList.toggle('deleting', on);
    const btn = document.getElementById('deleteToggleBtn');
    if(btn){ btn.classList.toggle('active', on); btn.setAttribute('aria-pressed', on ? 'true' : 'false'); }
  }

  function augmentInventorySlots(){
    try{
      const slots = Array.from(document.querySelectorAll('#inventory .slot'));
      slots.forEach((slot, idx)=>{
        let del = slot.querySelector('.del-x');
        if(!del){
          del = document.createElement('button');
          del.className = 'del-x';
          del.type = 'button';
          del.title = 'Delete item';
          del.textContent = 'Ã—';
          slot.appendChild(del);
          del.addEventListener('click', (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            if(!state.deletionMode) return;
            if(!Array.isArray(state.inventory)) return;
            const item = state.inventory[idx];
            if(!item) return;
            state.inventory.splice(idx,1);
            if(typeof save==='function') try{ save(); }catch(e){}
            if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
          });
        }
      });
    }catch(e){}
  }

  // Initial reflect + augment once DOM is ready
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=>{ reflectDeleteMode(); augmentInventorySlots(); });
  }else{
    reflectDeleteMode(); augmentInventorySlots();
  }

  // Robust: delegate click to handle dynamic re-renders
  document.addEventListener('click', function(e){
    const btn = e.target.closest && e.target.closest('#deleteToggleBtn');
    if(!btn) return;
    e.preventDefault();
    state.deletionMode = !state.deletionMode;
    reflectDeleteMode();
    augmentInventorySlots();
    if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
  });

  // After every inventory render, augment again to ensure buttons exist
  const __ri_hook = window.renderInventory;
  if(typeof __ri_hook === 'function'){
    window.renderInventory = function(){
      __ri_hook.apply(this, arguments);
      try{ augmentInventorySlots(); reflectDeleteMode(); }catch(e){}
    };
  }

  // Wrap renderInventory to add delete badges mapped by index
  const __ri = window.renderInventory;
  if(typeof __ri==='function'){
    window.renderInventory = function(){
      __ri.apply(this, arguments);
      try{
        const list = Array.from(document.querySelectorAll('#inventory .slot'));
        list.forEach((el, idx)=>{
          let del = el.querySelector('.del-x');
          if(!del){
            del = document.createElement('button');
            del.className='del-x'; del.textContent='Ã—';
            el.appendChild(del);
            del.addEventListener('click', (ev)=>{
              ev.stopPropagation();
              if(!state.deletionMode) return;
              if(!Array.isArray(state.inventory)) return;
              const item = state.inventory[idx];
              if(!item) return;
              // remove item permanently
              state.inventory.splice(idx,1);
              if(typeof save==='function') save();
              if(window.__addonSave) __addonSave();
              renderInventory();
            });
          }
        });
      }catch(e){}
    };
  }

  // (Deletion mode does not add delete buttons to pedestals.)
</script>
<script>
(function(){
  window.state = window.state || {};
  state.deletionMode = false; // default OFF

  function addDeleteBadgesToInventory(){
    try{
      const slots = Array.from(document.querySelectorAll('#inventory .slot'));
      slots.forEach((slot, idx)=>{
        let del = slot.querySelector('.del-x');
        if(!del){
          del = document.createElement('button');
          del.className = 'del-x';
          del.type = 'button';
          del.title = 'Delete item';
          del.textContent = 'Ã—';
          slot.appendChild(del);
          del.addEventListener('click', (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            if(!state.deletionMode) return;
            if(!Array.isArray(state.inventory)) return;
            const item = state.inventory[idx];
            if(!item) return;
            // Delete item from inventory
            state.inventory.splice(idx,1);
            if(typeof save==='function') try{ save(); }catch(e){}
            if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
          });
        }
      });
    }catch(e){ /* no-op */ }
  }

  function removeDeleteBadgesFromInventory(){
    document.querySelectorAll('#inventory .slot .del-x').forEach(el=>el.remove());
  }

  function reflectDelete(){
    const on = !!state.deletionMode;
    const btn = document.getElementById('deleteToggleBtn');
    document.body.classList.toggle('deleting', on);
    if(btn){ btn.classList.toggle('active', on); btn.setAttribute('aria-pressed', on?'true':'false'); }
    if(on){ addDeleteBadgesToInventory(); } else { removeDeleteBadgesFromInventory(); }
  }

  // Hook into renderInventory so badges sync with current mode after any render
  const __ri = window.renderInventory;
  if(typeof __ri === 'function'){
    window.renderInventory = function(){
      __ri.apply(this, arguments);
      reflectDelete();
    };
  }

  function init(){
    // always start OFF on load
    state.deletionMode = false;
    reflectDelete();
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();

  // Toggle button wiring
  document.addEventListener('click', function(e){
    const btn = e.target.closest && e.target.closest('#deleteToggleBtn');
    if(!btn) return;
    e.preventDefault();
    state.deletionMode = !state.deletionMode;
    reflectDelete();
  });

  // Safety: ensure OFF on reload
  window.addEventListener('beforeunload', ()=>{ state.deletionMode=false; });
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>


<!-- Quick reward reveal -->
<img alt="reward" id="revealImg"/>
<div id="revealName" style="font-weight:900;margin-top:6px;"></div>
<div class="rar" id="revealRarity" style="margin:8px auto 0;padding:6px 12px;border-radius:12px;"></div>


<!-- LA Dodgers Event Overlay -->
<div aria-hidden="true" class="overlay" id="dodgerOverlay">
<div aria-labelledby="dodgerTitle" aria-modal="true" class="sheet" role="dialog">
<button aria-label="Close" class="closeX" id="closeDodger">âœ•</button>
<h2 id="dodgerTitle">LA DODGERS EVENT</h2>
<div class="dodger-grid">
<div class="dodger-card" id="cardLAPack">
<h3>LA Pack <span class="cosmic-badge t-legendary">LIMITED</span></h3>
<p class="dodger-desc">Open to receive a random LA item in EPIC/LEGENDARY/LEGACY/UNIQUE/MYTHIC/DODGER. Dodger is rarest and adds blueâ€“white waves. Reward autoâ€‘adds to inventory.</p>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
<div class="dodger-price">$2,000,000,000</div>
<button class="dodger-buy" id="buyLAPack">Purchase</button>
</div>
</div>
<div class="dodger-card" id="cardDodgerStyle">
<h3>Dodger Stadium Style</h3>
<p class="dodger-desc">A themed stadium background. After purchase, apply it from Backgrounds.</p>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
<div class="dodger-price">$10,000,000,000,000</div>
<button class="dodger-buy" id="buyDodgerStyle">Purchase</button>
</div>
</div>
<div class="dodger-card">
<h3>Dodger Info</h3>
<div class="dodger-desc">Event items are limitedâ€‘time. When the event ends the button goes away, but your rewards stay forever. Dodger rarity gives +40,000 EPS with animated waves.</div>
</div>
<div class="dodger-card" style="display:grid;place-items:center;">
<img alt="LA" id="dodgerShopLogo" style="height:120px;filter:drop-shadow(0 8px 30px rgba(30,144,255,.35));opacity:.95;"/>
</div>
</div>
</div>
</div>
<!-- Dodgers Reward Reveal -->
<div class="cosmic-reveal" id="dodgerReveal">
<div class="card" style="background:#0e1628;border-color:#0a0f1a;">
<div style="font-family:'Bungee';font-size:28px;letter-spacing:1px;">You received</div>
<img alt="reward" id="dodgerRevealImg"/>
<div id="dodgerRevealName" style="font-weight:900;margin-top:6px;"></div>
<div class="rar" id="dodgerRevealRarity" style="margin:8px auto 0;padding:6px 12px;border-radius:12px;"></div>
</div>
</div>
<script>

// Helper to resolve assets by trying multiple extensions.
// Use base folder and a file *stem* (no extension), like ('la_dodgers_files','event')
function resolveAsset(base, stem, cb){
  const exts = ['.png', '.webp', '.jpg', ''];
  let i = 0;
  function tryNext(){
    const url = base + '/' + stem + exts[i];
    const img = new Image();
    img.onload = ()=>cb(url);
    img.onerror = ()=>{
      i++;
      if(i < exts.length) tryNext();
      else cb(base + '/' + stem + '.png'); // fall back
    };
  }
  tryNext();
}

// Set the event icon image in the shop card and left-rail button
function setDodgerEventIcons(btnEl){
  // If a specific button element is passed, use that; else search.
  const setBtnBg = function(url){
    try{
      const btn = btnEl || document.getElementById('openDodger');
      if(btn){
        btn.style.setProperty('--dodger-icon', "url('"+url+"')");
        const ft = btn.querySelector('.fallback-text');
        if(ft) ft.style.opacity = '0';
      }
    }catch(e){}
  };

  
  
  (function(){
    const candidates = [
      'la_dodgers_files/event.png',
      'la_dodgers_filesevent.png',
      'event.png'
    ];
    (function tryNext(i){
      if(i >= candidates.length){
        // final fallback: show "LA" text, leave CSS var unset
        const shopImg = document.getElementById('dodgerShopLogo');
        if(shopImg){
          shopImg.classList.add('fallback');
          shopImg.removeAttribute('src');
          shopImg.textContent = 'LA';
        }
        return;
      }
      const test = new Image();
      test.onload = function(){
        const url = candidates[i];
        const shopImg = document.getElementById('dodgerShopLogo');
        if(shopImg){
          shopImg.classList.remove('fallback');
          shopImg.src = url;
        }
        setBtnBg(url);
      };
      test.onerror = function(){ tryNext(i+1); };
      test.src = candidates[i];
    })(0);
  })();
}
// Prepare and cache the stadium background URL, update CSS and BG grid tile
var __dodgerBgURL = null;
function ensureDodgerBgURL(cb){
  if(__dodgerBgURL){ cb(__dodgerBgURL); return; }
  resolveAsset('la_dodgers_style_files','la_dodgers_style', function(url){
    __dodgerBgURL = url;
    // write/update CSS rule dynamically
    let st = document.getElementById('dodgerBgStyle');
    if(!st){
      st = document.createElement('style');
      st.id = 'dodgerBgStyle';
      document.head.appendChild(st);
    }
    st.textContent = "body.bg-dodger{background:url('"+url+"') center center / cover no-repeat fixed !important;}";
    cb(url);
  });
}

// === LA Dodgers Event bootstrap ===
(function(){
  // Add event icon button to left rail (uses provided PNG)
  try{
    const rail = document.querySelector('.left-rail');
    if(rail && !document.getElementById('openDodger')){
      const btn = document.createElement('button');
      btn.className = 'icon-btn icon-dodger';
      btn.id = 'openDodger';
      btn.title = 'LA Dodgers Event';
      btn.innerHTML = '<span class="fallback-text">LA</span>';
      setDodgerEventIcons(btn);
      (function(){ 
  var row = document.querySelector('.event-row') || document.getElementById('eventRow');
  if(!row){
    row = document.createElement('div');
    row.className = 'event-row';
    document.body.appendChild(row);
  }
  row.appendChild(btn);
})();
btn.addEventListener('click', ()=>{
        document.getElementById('dodgerOverlay').classList.add('show');
        document.getElementById('dodgerOverlay').setAttribute('aria-hidden','false');
        updateDodgerStyleUI();
        setDodgerEventIcons();
      });
    }
  }catch(e){}

  document.getElementById('closeDodger')?.addEventListener('click', ()=>{
    document.getElementById('dodgerOverlay').classList.remove('show');
    document.getElementById('dodgerOverlay').setAttribute('aria-hidden','true');
  });

  // Extend rarity table with DODGER (40,000 EPS)
  try{
    window.RARITY = window.RARITY || {};
    if(!RARITY.dodger){
      RARITY.dodger = { label:'DODGER', color:'#1e90ff', income: 40000, price:[0,0], prob: 0 };
    }
  }catch(e){}

  // After every stand render, add the wave aura to any placed item with t-dodger badge
  (function hookDodgerWaves(){
    const orig = window.renderStands;
    window.renderStands = function(){
      if(typeof orig === 'function') orig.apply(this, arguments);
      try{
        document.querySelectorAll('.placed').forEach(el=>{
          const hasDodger = !!el.querySelector('.rar.t-dodger');
          el.classList.toggle('dodger-waves', hasDodger);
        });
      }catch(e){}
    };
    setTimeout(()=>{
      try{
        document.querySelectorAll('.placed').forEach(el=>{
          const hasDodger = !!el.querySelector('.rar.t-dodger');
          el.classList.toggle('dodger-waves', hasDodger);
        });
      }catch(e){}
    },0);
  })();

  // Reward reveal helper
  function showDodgerReveal(name, rarity, imgPath){
    const host = document.getElementById('dodgerReveal');
    const rn = document.getElementById('dodgerRevealName');
    const rr = document.getElementById('dodgerRevealRarity');
    const ri = document.getElementById('dodgerRevealImg');
    ri.src = imgPath;
    rn.textContent = name;
    rr.textContent = (RARITY[String(rarity).toLowerCase()]?.label || String(rarity||'').toUpperCase());
    rr.className = 'rar t-' + String(rarity).toLowerCase();
    host.classList.add('show');
    setTimeout(()=>{ host.classList.remove('show'); }, 3000);
  }

  // LA Pack purchase logic
  const LA_PACK_COST = 2_000_000_000;
  const LA_ITEMS = [
    ['Dodger Hat','dodger_hat.png'],
    ['Dodger Stadium','dodger_stadium.png'],
    ['World Series','world_series.png'],
    ['Shohei Ohtani','shohei_ohtani.png'],
    ['Will Smith','will_smith.png'],
    ['Freddie Freeman','freddie_freeman.png'],
    ['Mookie Betts','mookie_betts.png'],
    ['Dodger Baseball','dodger_baseball.png'],
    ['Dodger Welcome','dodger_welcome.png']
  ];
  // EPIC/LEGENDARY/LEGACY/UNIQUE/MYTHIC/DODGER (Dodger rarest)
  const LA_RARITY_BUCKETS = [
    ['epic',48], ['legendary',25], ['legacy',10], ['unique',8], ['mythic',5], ['dodger',4]
  ];
  function pickWeighted(bucket){
    const total = bucket.reduce((s, r)=>s+r[1], 0);
    let roll = Math.random() * total;
    for(const [val,w] of bucket){
      roll -= w;
      if(roll <= 0) return val;
    }
    return bucket[bucket.length-1][0];
  }
  function buyLAPack(){
    if((state.money||0) < LA_PACK_COST) return;
    state.money -= LA_PACK_COST;
    const [name, file] = LA_ITEMS[Math.floor(Math.random()*LA_ITEMS.length)];
    const rar = pickWeighted(LA_RARITY_BUCKETS);
    const inv = {
      uid: (Math.random().toString(36).slice(2)+Date.now().toString(36)),
      name,
      rarity: rar,
      price: 0,
      baseIdx: 0,
      svg: 'la_dodgers_items/' + file
    };
    state.inventory.push(inv);
    if(typeof updateTop==='function') updateTop();
    if(typeof renderInventory==='function') renderInventory();
    if(typeof save==='function') save();
    showDodgerReveal(name, rar, inv.svg);
  }
  document.getElementById('buyLAPack')?.addEventListener('click', buyLAPack);

  // Dodger Stadium Style background purchase
  const DODGER_STYLE_COST = 10_000_000_000_000;
  function updateDodgerStyleUI(){
    const btn = document.getElementById('buyDodgerStyle');
    if(!btn) return;
    const owned = !!(state.unlockedBackgrounds && state.unlockedBackgrounds.dodger);
    if(owned){
      btn.disabled = true;
      btn.textContent = 'Purchased';
      btn.style.background = 'linear-gradient(#2ecc71,#1da85b)';
    }else{
      btn.disabled = (state.money||0) < DODGER_STYLE_COST;
      btn.textContent = 'Purchase';
      btn.style.background = '';
    }
  }
  function buyDodgerStyle(){
    if((state.unlockedBackgrounds||{}).dodger) return;
    if((state.money||0) < DODGER_STYLE_COST) return;
    state.money -= DODGER_STYLE_COST;
    state.unlockedBackgrounds = state.unlockedBackgrounds || {};
    state.unlockedBackgrounds.dodger = true;
    updateDodgerStyleUI();
        setDodgerEventIcons();
    if(typeof window.__renderBgGrid==='function') window.__renderBgGrid();
    if(typeof updateTop==='function') updateTop();
    if(typeof save==='function') save();
  }
  document.getElementById('buyDodgerStyle')?.addEventListener('click', buyDodgerStyle);

  // Extend Background grid with Dodger style
  (function extendBgGrid(){
    const orig = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if(typeof orig === 'function') orig();
      try{
        const g=document.getElementById('bgGrid');
        if(!g) return;
        if(!g.querySelector('[data-dodgerbg]')){
          const el=document.createElement('div');
          el.setAttribute('data-dodgerbg','1');
          el.className='bg-tile'+(!(state.unlockedBackgrounds||{}).dodger?' locked':'');
          el.style.cssText='background-image:url("la_dodgers_style_files/la_dodgers_style.png");background-size:cover;background-position:center;';
          el.innerHTML='<div style="font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)">DODGER STADIUM STYLE</div><button class="buy bg-apply" '+(!(state.unlockedBackgrounds||{}).dodger?'disabled':'')+'>Apply</button>';
          el.querySelector('.bg-apply').onclick=()=>{
            if(!(state.unlockedBackgrounds||{}).dodger) return;
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-rainbow','redblue','bg-spaceview','bg-crypto');
            document.body.classList.add('bg-dodger');
            state.selectedBackground='dodger';
            if(typeof save==='function') save();
          };
          g.appendChild(el);
        }
      }catch(e){}
    };
  })();
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>
<script>
(function(){
  const btn = document.getElementById('openBgSelector');
  if(btn){
    btn.addEventListener('click', ()=>{
      const overlay = document.getElementById('bgOverlay');
      const sheet = overlay ? overlay.querySelector('.sheet') : null;
      const grid = document.getElementById('bgGrid');
      if (overlay) overlay.scrollTop = 0;
      if (sheet) sheet.scrollTop = 0;
      if (grid) grid.scrollTop = 0;
    }, { passive: true });
  }
})();
</script>
<script>
// ===== Admin broadcast listener + auto-update =====
(function(){
  const CLIENT_BUILD = 'v48-msgs1';
  let _queue = [];
  let _showing = false;
  let lastG = Number(localStorage.getItem('flex_msg_lastG')||0);
  let lastU = Number(localStorage.getItem('flex_msg_lastU')||0);

  
  // Prime baselines so only players with the tab open at send-time see admin messages or forced reloads.
  let __MSG_PRIMED__ = false;
  let _latestSeenTs = Number(localStorage.getItem('flex_latest_seenTs')||0);
  async function primeBaselines(){
    try{
      // Snapshot current last message timestamps so we won't replay older broadcasts or inbox messages
      const g0 = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__broadcast')}&t=${Date.now()}`) || {};
      if (typeof g0.last === 'number') { lastG = g0.last; } else if (Array.isArray(g0.list) && g0.list.length){ lastG = Math.max(0, g0.list.map(m=>m && m.ts || 0)); }
      const u0 = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__inbox_'+USER_ID)}&t=${Date.now()}`) || {};
      if (typeof u0.last === 'number') { lastU = u0.last; } else if (Array.isArray(u0.list) && u0.list.length){ lastU = Math.max(0, u0.list.map(m=>m && m.ts || 0)); }
      localStorage.setItem('flex_msg_lastG', String(lastG||0));
      localStorage.setItem('flex_msg_lastU', String(lastU||0));
      // Snapshot the latest force reload timestamp so new tabs opened later won't auto-refresh from old requests
      const cfg0 = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__flex_latest')}&t=${Date.now()}`) || {};
      if (cfg0 && typeof cfg0.forceTs === 'number') {
        _latestSeenTs = cfg0.forceTs;
      } else {
        // Use "now" as a floor so existing forced reloads from the past won't trigger on late joiners
        _latestSeenTs = Date.now();
      }
      localStorage.setItem('flex_latest_seenTs', String(_latestSeenTs||0));
    }catch(e){ /* ignore priming errors */ }
    __MSG_PRIMED__ = true;
  window.addEventListener('load', ()=>{ try{ setInterval(pollOnce, 15000); }catch(e){} });

  }
function ensureBanner(){
    if(document.getElementById('adminMsgBanner')) return;
    const el = document.createElement('div');
    el.id = 'adminMsgBanner';
    el.innerHTML = '<div class="msg"></div><button class="close" aria-label="Close">Ã—</button>';
    document.body.appendChild(el);
    el.querySelector('.close').addEventListener('click', ()=>{ hideBanner(); _queue=[]; });
  }

  function showBanner(msg){
    ensureBanner();
    const el = document.getElementById('adminMsgBanner');
    el.classList.remove('info','warn','success');
    el.classList.add(msg.style||'info');
    el.querySelector('.msg').textContent = String(msg.text||'');
    el.classList.add('show');
    _showing = true;
    const lifetime = 5000 + Math.min(5000, (String(msg.text||'').length * 15));
    setTimeout(()=>hideBanner(), lifetime);
  }
  function hideBanner(){
    const el = document.getElementById('adminMsgBanner');
    if(!el) return;
    el.classList.remove('show');
    _showing = false;
    setTimeout(()=>maybeNext(), 250);
  }
  function enqueue(msg){
    _queue.push(msg);
    maybeNext();
  }
  function maybeNext(){
    if(_showing) return;
    const msg = _queue.shift();
    if(!msg) return;
    showBanner(msg);
  }

  async function fetchJson(u){
    try{
      const r = await fetch(u, { cache:'no-store' });
      if(!r.ok) return null;
      return await r.json();
    }catch(e){ return null; }
  }

  async function pollOnce(){
    if(!__MSG_PRIMED__) await primeBaselines();

    try{
      // global
      const g = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__broadcast')}&t=${Date.now()}`) || {};
      const glist = Array.isArray(g.list) ? g.list : [];
      glist.forEach(m=>{ if((m.ts||0) > lastG){ if(m && m.op === 'freeze'){ activateHardFreeze(m.text); } else { enqueue(m); } lastG = Math.max(lastG, m.ts||0); } });
// user inbox
      const u = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__inbox_'+USER_ID)}&t=${Date.now()}`) || {};
      const ulist = Array.isArray(u.list) ? u.list : [];
      ulist.forEach(m=>{ if((m.ts||0) > lastU){ if(m && m.op === 'freeze'){ activateHardFreeze(m.text); } else { enqueue(m); } lastU = Math.max(lastU, m.ts||0); } });
localStorage.setItem('flex_msg_lastG', String(lastG));
      localStorage.setItem('flex_msg_lastU', String(lastU));
    }catch(e){ /* ignore */ }

    // auto-update: check the "latest" pointer
    try{
      const cfg = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent('__flex_latest')}&t=${Date.now()}`) || null;
      if(cfg && cfg.url){
        const forced = (typeof cfg.forceTs === 'number') && (cfg.forceTs > Number(localStorage.getItem('flex_latest_seenTs')||0));
        const should = forced || (cfg.v && String(cfg.v)!==String(CLIENT_BUILD));
        if (forced) { localStorage.setItem('flex_latest_seenTs', String(cfg.forceTs)); }
        if (should) {
  // Only allow updates that keep us on the SAME ORIGIN to preserve localStorage/state.
  // - Relative URLs are allowed (auto-resolve to same origin).
  // - Absolute URLs must match location.origin exactly.
  let nextUrl;
  try {
    // Resolve cfg.url relative to the current page (handles relative & absolute inputs)
    const resolved = new URL(cfg.url, location.href);

    // Same-origin required
    if (resolved.origin !== location.origin) {
      // Ignore cross-origin "latest" URLs to avoid losing origin-scoped data
      console.warn('[auto-update] Ignored cross-origin latest url:', resolved.href);
    } else {
      // Cache-bust so we definitely get the new client
      resolved.searchParams.set('cb', String(Date.now()));
      nextUrl = resolved.toString();
    }
  } catch (e) {
    console.warn('[auto-update] Bad latest url:', cfg.url, e);
  }

  if (nextUrl) {
    window.location.href = nextUrl;
    return;
  }
}
      }
    }catch(e){ /* ignore */ }

    
  // ===== Hard Freeze (admin-triggered) =====
  function __escapeHtml_(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function activateHardFreeze(msgText){
    if(window.__HARD_FREEZE_ACTIVE__) return;
    window.__HARD_FREEZE_ACTIVE__ = true;
    try{ window.__origRAF = window.requestAnimationFrame; window.requestAnimationFrame = function(){}; }catch(e){}
    var st = document.getElementById('hardFreezeStyle');
    if(!st){
      st = document.createElement('style'); st.id = 'hardFreezeStyle';
      st.textContent = [
        '#hardFreezeOverlay{position:fixed;inset:0;background:#000;color:#fff;z-index:2147483647;display:flex;align-items:center;justify-content:center;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}',
        '#hardFreezeOverlay .inner{max-width:880px;padding:28px;text-align:center;}',
        '#hardFreezeOverlay h1{margin:0 0 12px;font-size:clamp(24px,5vw,48px);font-weight:900;letter-spacing:.4px;}',
        '#hardFreezeOverlay p{margin:8px 0;font-size:clamp(14px,2.2vw,22px);opacity:.9;}'
      ].join('\n');
      document.head.appendChild(st);
    }
    var ov = document.getElementById('hardFreezeOverlay');
    if(!ov){
      ov = document.createElement('div'); ov.id = 'hardFreezeOverlay';
      ov.innerHTML = '<div class="inner"><h1>Update Required</h1><p>'+__escapeHtml_(msgText||'Admin paused the game for an update.')+'</p><p><strong>Use your browser\'s Reload button to continue.</strong></p></div>';
      document.body.appendChild(ov);
    }
    var trap = function(e){ try{ e.preventDefault(); e.stopImmediatePropagation(); e.stopPropagation(); }catch(_){} return false; };
    ['keydown','keyup','keypress','pointerdown','pointerup','click','dblclick','contextmenu','wheel','touchstart','touchend'].forEach(function(ev){
      window.addEventListener(ev, trap, true);
    });
  }
setTimeout(pollOnce, 1500);
  }

  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(pollOnce, 100); });
  window.addEventListener('load', ()=>{
    // Inject banner CSS if not present
    if(!document.getElementById('adminMsgBannerStyle')){
      const st = document.createElement('style'); st.id='adminMsgBannerStyle';
      st.textContent = '"\\n/* ===== admin broadcast banner ===== */\\n#adminMsgBanner{\\n  position:fixed; left:0; right:0; top:-120px; z-index:9999;\\n  display:flex; gap:12px; align-items:center; justify-content:center;\\n  min-height:56px; padding:10px 16px;\\n  font-weight:800; letter-spacing:.2px;\\n  color:#000; text-shadow:0 1px 0 rgba(255,255,255,.4);\\n  border-bottom:4px solid rgba(0,0,0,.35);\\n  box-shadow:0 10px 30px rgba(0,0,0,.35);\\n  transition: transform .35s ease, top .35s ease, background .25s;\\n  transform: translateY(-100%);\\n}\\n#adminMsgBanner.show{ top:0; transform: translateY(0); }\\n#adminMsgBanner .msg{ max-width:1100px; text-align:center; }\\n#adminMsgBanner .close{ margin-left:auto; cursor:pointer; font-weight:900; }\\n#adminMsgBanner.info{ background: #79ffe1; }\\n#adminMsgBanner.warn{ background: #ffd86a; }\\n#adminMsgBanner.success{ background: #a7ff83; }\\n"';
      document.head.appendChild(st);
    }
    ensureBanner();
    pollOnce();
  });
})();
</script>
<script>
// --- Pet Quest: Unlock 4th Pet Pedestal when ALL pets owned (2-minute hatch slot) ---
(function(){
  function unlockFourthIfAllPets(){
    try{
      if (typeof hasAllPets !== 'function') return;
      if (!hasAllPets()) return;
      window.state = window.state || {};
      state.ach = state.ach || {};
      if (!state.ach.petFourthUnlocked) {
        state.ach.petFourthUnlocked = true;
        // Ensure arrays have 4 slots
        if (!Array.isArray(state.petStands)) state.petStands = [null,null,null,null];
        while (state.petStands.length < 4) state.petStands.push(null);
        if (!Array.isArray(state.petTimers)) state.petTimers = [null,null,null,null];
        while (state.petTimers.length < 4) state.petTimers.push(null);
        // Re-render UI
        try { if (typeof renderStands === 'function') renderStands(); } catch(e){}
        try { if (typeof recalcEPS === 'function') recalcEPS(); } catch(e){}
        try { if (window.__addonSave) __addonSave(); } catch(e){}
      }
    } catch(e){}
  }

  // Run once after load (ensures PET_TABLES/hasAllPets exist)
  window.addEventListener('load', function(){ setTimeout(unlockFourthIfAllPets, 0); });

  // Also check on visibility regain (common after tab switching)
  document.addEventListener('visibilitychange', function(){
    if (!document.hidden) setTimeout(unlockFourthIfAllPets, 50);
  });

  // Wrap global save() so any state change re-checks the quest
  const __save = window.save;
  window.save = async function(){
    try { unlockFourthIfAllPets(); } catch(e){}
    if (typeof __save === 'function') {
      try { return await __save.apply(this, arguments); } catch (e) { return; }
    }
  };
})();
</script>
<style>
/* === Dodger Quests background === */
body.bg-dodgerquests{ background:url('la_dodgers_style_files/la_dodgers_quests_style.png') center center / cover no-repeat fixed !important; }
.dq-box .dq-row{display:flex;align-items:center;gap:10px;margin:10px 0;font-weight:900;letter-spacing:.3px;}
.dq-box .dq-check{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;border:2px solid #111;background:#555;font-weight:900;color:#111;}
.dq-box .dq-check.ok{background:#58e36c;color:#111;}
.dq-box .dq-sub{font-size:14px;opacity:.85;font-weight:800;margin-top:-6px;margin-left:38px;}
.dq-claim{margin-top:8px;}
</style>
<script>
// === Dodger Quests (LA Event) ===
(function(){
  const DQ_KEY = 'flex_dodger_quests_v1';
  const EARN_GOAL = 10_000_000_000; // $10B
  const OWN_GOAL = 15;              // lowered to 15 Dodger-rarity items
  const EXOTIC_LA_GOAL = 6;         // 6 exotics forged from only LA items

  // load / init
  window.state = window.state || {};
  state.dodgerQuests = (function(){
    try{ const d = JSON.parse(localStorage.getItem(DQ_KEY)||'null'); if(d) return d; }catch(e){}
    return { earned: 0, exoticsLA: 0, unlocked: false };
  })();

  function saveDQ(){
    try{ localStorage.setItem(DQ_KEY, JSON.stringify(state.dodgerQuests)); }catch(e){}
    try{ if(typeof save==='function') save(); }catch(e){}
  }

  function countDodgerRarityOwned(){
    let n = 0;
    try{
      (state.inventory||[]).forEach(i=>{ if(i && String(i.rarity).toLowerCase()==='dodger') n++; });
      Object.values(state.placed||{}).forEach(i=>{ if(i && String(i.rarity).toLowerCase()==='dodger') n++; });
    }catch(e){}
    return n;
  }

  function currentDodgerEPS(){
    let base = 0;
    try{
      (state.stands||[]).forEach(uid=>{
        if(!uid) return;
        const it = (state.placed||{})[uid] || (state.inventory||[]).find(x=>x.uid===uid);
        if(!it) return;
        if(String(it.rarity).toLowerCase()==='dodger'){
          const key='dodger';
          const inc = (window.RARITY && RARITY[key] && +RARITY[key].income) ? +RARITY[key].income : 0;
          base += inc;
        }
      });
    }catch(e){}
    const mult = (window.multiplierLevel||1) * ((typeof getActivePedestalMultiplier==='function' ? getActivePedestalMultiplier() : 1));
    return base * mult;
  }

  function isLAItem(it){
    if(!it) return false;
    if(it.la === true) return true;
    const s = String(it.svg||'');
    return /la_dodgers/i.test(s) || /dodger_/i.test(s);
  }

  // ===== Forge Output: use only REAL items (present in ICON_PATHS), Exotic rarity =====
  function getRealItemNames(){
    try{
      const ks = Object.keys(ICON_PATHS||{});
      if(Array.isArray(ks) && ks.length) return ks;
    }catch(e){}
    try{
      return (ITEM_NAMES||[]).filter(n => ICON_PATHS && Object.prototype.hasOwnProperty.call(ICON_PATHS, n));
    }catch(e){}
    return [];
  }
  function createRandomNormalExotic(){
    const real = getRealItemNames();
    const name = real.length ? real[Math.floor(Math.random()*real.length)] : '24 King Crown';
    const baseIdx = Math.floor(Math.random()*20);
    const svg = (typeof getItemSvg==='function') ? getItemSvg(name, baseIdx, 'exotic') : '';
    return { uid: (Math.random().toString(36).slice(2)+Date.now().toString(36)), name, rarity:'exotic', price:0, baseIdx, svg };
  }

  // Hook Exotic Forge button so output is normal Exotic and LA-only inputs count for quest
  function hookExoticForgeBtn(){
    const btn = document.getElementById('exoticForgeBtn');
    if(!btn || btn.dataset.dqHooked==='1') return;
    const clone = btn.cloneNode(true);
    btn.replaceWith(clone);
    clone.dataset.dqHooked = '1';
    clone.addEventListener('click', function(){
      // Validate all 4 stands are legacy (any type)
      const ok = (state.stands||[]).every(uid=>{
        if(!uid) return false;
        const it = state.placed[uid] || (state.inventory||[]).find(x=>x.uid===uid);
        return it && String(it.rarity).toLowerCase()==='legacy';
      });
      if(!ok) return;

      // Check LA-only inputs for quest 3
      const allLA = (state.stands||[]).every(uid=>{
        const it = state.placed[uid] || (state.inventory||[]).find(x=>x.uid===uid);
        return isLAItem(it);
      });

      // Consume 4 inputs
      (state.stands||[]).forEach(uid=>{ if(uid && state.placed[uid]) delete state.placed[uid]; });
      state.stands = [null,null,null,null];

      // Create a proper random exotic from REAL items only
      const ex = createRandomNormalExotic();
      state.placed[ex.uid] = ex;
      state.stands[0] = ex.uid;

      if(typeof recalcEPS==='function') recalcEPS();
      if(typeof renderInventory==='function') renderInventory();
      if(typeof renderStands==='function') renderStands();
      saveDQ();
      if(allLA){
        state.dodgerQuests.exoticsLA = (state.dodgerQuests.exoticsLA||0) + 1;
        saveDQ();
        updateDodgerQuestsUI();
      }
    });
  }
  setInterval(hookExoticForgeBtn, 1200);

  // Mark LA items when bought from LA Pack (best-effort)
  (function tryWrapBuyLAPack(){
    if(window.__wrappedBuyLAPack) return;
    const pol = setInterval(()=>{
      const btn = document.getElementById('buyLAPack');
      if(btn){
        btn.addEventListener('click', ()=>{
          setTimeout(()=>{
            try{
              const inv = state.inventory||[];
              for(let i=inv.length-1;i>=0;i--){
                const it = inv[i];
                if(isLAItem(it)){ it.la = true; break; }
              }
              saveDQ();
            }catch(e){}
          }, 10);
        });
        window.__wrappedBuyLAPack = true;
        clearInterval(pol);
      }
    }, 600);
  })();

  // Inject Dodger Quests card (takes over logo box)
  function injectDodgerQuestsCard(){
    const overlay = document.getElementById('dodgerOverlay');
    if(!overlay) return;
    const logoImg = overlay.querySelector('#dodgerShopLogo');
    let hostCard = logoImg ? logoImg.closest('.dodger-card') : overlay.querySelector('.dodger-card:last-child');
    if(!hostCard) return;
    hostCard.id = 'cardDodgerQuests';
    hostCard.style.display = 'block';
    hostCard.style.placeItems = 'initial';
    hostCard.innerHTML = '<h3>Dodger Quests</h3>'
      + '<div class="dq-box">'
      +   '<div class="dq-row"><div class="dq-check" id="dqEarnChk"></div>'
      +   '<div style="flex:1">Earn $10,000,000,000 from Dodger rarity</div></div>'
      +   '<div class="dq-sub" id="dqEarnSub"></div>'
      +   '<div class="dq-row"><div class="dq-check" id="dqOwnChk"></div>'
      +   '<div style="flex:1">Own 15 items that are a Dodger rarity</div></div>'
      +   '<div class="dq-sub" id="dqOwnSub"></div>'
      +   '<div class="dq-row"><div class="dq-check" id="dqForgeChk"></div>'
      +   '<div style="flex:1">Forge 6 EXOTICS from only LA Pack items</div></div>'
      +   '<div class="dq-sub" id="dqForgeSub"></div>'
      +   '<button class="dodger-buy dq-claim" id="dqClaimBtn" disabled>Claim Background</button>'
      +   '<div class="dq-sub" id="dqClaimNote">Reward: LA Dodgers Quests background (apply via Backgrounds)</div>'
      + '</div>';
    document.getElementById('dqClaimBtn').addEventListener('click', claimReward);
    updateDodgerQuestsUI();
  }

  function fmt(n){ try{return (n||0).toLocaleString(undefined,{maximumFractionDigits:0});}catch(e){ return String(n); } }
  function updateDodgerQuestsUI(){
    const earned = Math.floor(state.dodgerQuests.earned||0);
    const own = countDodgerRarityOwned();
    const forged = Math.floor(state.dodgerQuests.exoticsLA||0);

    const earnOk = earned >= EARN_GOAL;
    const ownOk = own >= OWN_GOAL;
    const forgeOk = forged >= EXOTIC_LA_GOAL;

    const earnPct = Math.min(100, Math.floor(earned/EARN_GOAL*100));
    const ownPct = Math.min(100, Math.floor(own/OWN_GOAL*100));
    const forgePct = Math.min(100, Math.floor(forged/EXOTIC_LA_GOAL*100));

    const E = document.getElementById('dqEarnChk'); if(E){ E.classList.toggle('ok', earnOk); E.textContent = earnOk?'âœ“':''; }
    const O = document.getElementById('dqOwnChk'); if(O){ O.classList.toggle('ok', ownOk); O.textContent = ownOk?'âœ“':''; }
    const F = document.getElementById('dqForgeChk'); if(F){ F.classList.toggle('ok', forgeOk); F.textContent = forgeOk?'âœ“':''; }

    const Es = document.getElementById('dqEarnSub'); if(Es){ Es.textContent = fmt(earned) + ' / ' + fmt(EARN_GOAL) + ' ('+earnPct+'%)'; }
    const Os = document.getElementById('dqOwnSub'); if(Os){ Os.textContent = own + ' / ' + OWN_GOAL + ' ('+ownPct+'%)'; }
    const Fs = document.getElementById('dqForgeSub'); if(Fs){ Fs.textContent = forged + ' / ' + EXOTIC_LA_GOAL + ' ('+forgePct+'%)'; }

    const all = earnOk && ownOk && forgeOk;
    const btn = document.getElementById('dqClaimBtn');
    if(btn){
      btn.disabled = !(all && !state.dodgerQuests.unlocked);
      btn.textContent = state.dodgerQuests.unlocked ? 'Unlocked' : (all ? 'Claim Background' : 'Locked');
    }
  }

  // Reward: unlock BG tile
  let __dqBgURL = null;
  function ensureDodgerQuestBgURL(cb){
    if(__dqBgURL){ cb(__dqBgURL); return; }
    const img = new Image();
    const url = 'la_dodgers_style_files/la_dodgers_quests_style.png';
    img.onload = ()=>{ __dqBgURL = url; cb(url); };
    img.onerror = ()=>{ __dqBgURL = url; cb(url); };
    img.src = url;
  }

  function claimReward(){
    state.dodgerQuests.unlocked = true;
    state.unlockedBackgrounds = state.unlockedBackgrounds || {};
    state.unlockedBackgrounds.dodgerquests = true;
    saveDQ();
    ensureDodgerQuestBgURL(function(url){
      try{
        var st = document.getElementById('dqBgStyle');
        if(!st){ st = document.createElement('style'); st.id='dqBgStyle'; document.head.appendChild(st); }
        st.textContent = "body.bg-dodgerquests{background:url('"+url+"') center center / cover no-repeat fixed !important;}";
      }catch(e){}
      if(typeof window.__renderBgGrid==='function') window.__renderBgGrid();
      updateDodgerQuestsUI();
      alert('Dodger Quests background unlocked! Apply it from Backgrounds.');
    });
  }

  // Add tile to Background selector
  (function extendBgGrid(){
    const orig = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if(typeof orig === 'function') orig();
      try{
        const g = document.getElementById('bgGrid'); if(!g) return;
        if(!g.querySelector('[data-dodgerquests]')){
          const el = document.createElement('div');
          el.setAttribute('data-dodgerquests','1');
          el.className = 'bg-tile' + (!((state.unlockedBackgrounds||{}).dodgerquests)?' locked':'');
          ensureDodgerQuestBgURL(function(url){
            el.style.cssText = "background:url('"+url+"') center/cover no-repeat;border-color:#0b2e6e;";
          });
          el.innerHTML = '<div style="font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)">DODGER QUESTS</div><button class="buy bg-apply" '+(!((state.unlockedBackgrounds||{}).dodgerquests)?'disabled':'')+'>Apply</button>';
          el.querySelector('.bg-apply').onclick = function(){
            if(!((state.unlockedBackgrounds||{}).dodgerquests)) return;
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-rainbow','bg-spaceview','bg-dodger','redblue','bg-crypto');
            document.body.classList.add('bg-dodgerquests');
            state.selectedBackground = 'dodgerquests';
            saveDQ();
          };
          g.appendChild(el);
        }else{
          const el = g.querySelector('[data-dodgerquests]');
          el.classList.toggle('locked', !((state.unlockedBackgrounds||{}).dodgerquests));
          const btn = el.querySelector('.bg-apply'); if(btn) btn.disabled = !((state.unlockedBackgrounds||{}).dodgerquests);
        }
      }catch(e){}
    };
  })();

  // When Dodgers overlay opens, inject the card
  (function hookOpenDodgers(){
    const poll = setInterval(()=>{
      const btn = document.getElementById('openDodger');
      if(btn){
        btn.addEventListener('click', ()=> setTimeout(injectDodgerQuestsCard, 0));
        clearInterval(poll);
      }
    }, 500);
  })();

  // Continuous earnings tracker
  let last = performance.now();
  function dqLoop(ts){
    const dt = Math.max(0, (ts - last) / 1000);
    last = ts;
    const eps = currentDodgerEPS();
    if(eps > 0){
      state.dodgerQuests.earned = (state.dodgerQuests.earned||0) + eps * dt;
      if((Math.random()<0.05)) saveDQ();
    }
    const ov = document.getElementById('dodgerOverlay');
    if(ov && ov.classList.contains('show')) updateDodgerQuestsUI();
    requestAnimationFrame(dqLoop);
  }
  requestAnimationFrame(dqLoop);

  const _ri = window.renderInventory;
  window.renderInventory = function(){ if(_ri) _ri.apply(this, arguments); updateDodgerQuestsUI(); };
  const _rs = window.renderStands;
  window.renderStands = function(){ if(_rs) _rs.apply(this, arguments); updateDodgerQuestsUI(); };

})();
</script>
<script>
// === Cosmic Event: turned off (UI/page removed). Preserve existing content. ===
(function(){
  try {
    window.RARITY = window.RARITY || {};
    if (!RARITY.cosmic) {
      // Keep COSMIC rarity so existing items still earn EPS and display correctly.
      RARITY.cosmic = { label: 'COSMIC', color: '#8fd0ff', income: 35000, price:[0,0], prob: 0 };
    }
  } catch(e){}

  // Keep Space View usable if previously unlocked; do not expose purchase.
  
  (function extendBgGridForSunrise(){
    const orig = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if (typeof orig === 'function') orig();
      try{
        const g = document.getElementById('bgGrid'); if(!g) return;
        if ((state.unlockedBackgrounds||{}).sunrise && !g.querySelector('[data-sunrise]')){
          const el = document.createElement('div');
          el.setAttribute('data-sunrise','1');
          el.className = 'bg-tile';
          el.style.cssText = "background-image:url('background_files/sunrise_style.png');background-size:cover;background-position:center;border:4px solid rgba(255,255,255,.4)";
          el.innerHTML = '<div style="font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)">SUNRISE</div><button class=\"buy bg-apply\">Apply</button>';
          el.querySelector('.bg-apply').onclick = function(){
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-legendary','bg-unique','bg-exotic','bg-mythic','bg-rainbow','bg-crypto','bg-dodger','bg-spaceview','bg-dodgerquests','redblue');
            document.body.classList.add('bg-sunrise');
            state.selectedBackground = 'sunrise';
            try{ if(typeof save==='function') save(); }catch(e){}
          };
          g.appendChild(el);
        }
      }catch(e){}
    };
  })();
(function extendBgGridForSpaceView(){
    const orig = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if (typeof orig === 'function') orig();
      try{
        const g = document.getElementById('bgGrid'); if(!g) return;
        // Only add tile if the player already owns it.
        if ((state.unlockedBackgrounds||{}).spaceview && !g.querySelector('[data-spaceview]')){
          const el = document.createElement('div');
          el.setAttribute('data-spaceview','1');
          el.className = 'bg-tile';
          el.style.cssText = 'background:radial-gradient(1200px 600px at 50% -200px,#091225,#04060c)';
          el.innerHTML = '<div style="font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)">SPACE VIEW</div>'
                       + '<button class="buy bg-apply">Apply</button>';
          el.querySelector('.bg-apply').onclick = function(){
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-rainbow','bg-dodger','bg-dodgerquests','redblue','bg-crypto');
            document.body.classList.add('bg-spaceview');
            state.selectedBackground = 'spaceview';
            try{ if(typeof save==='function') save(); }catch(e){}
          };
          g.appendChild(el);
        }
      }catch(e){}
    };
  })();
})();
</script>
<script>
// === CRYPTO rarity + forge (2 Mythic + 2 Exotic => 1 random CRYPTO, 50,000 EPS) ===
(function(){
  try{
    // Ensure rarity entry exists
    window.RARITY = window.RARITY || {};
    if(!RARITY.crypto){
      RARITY.crypto = { label:'CRYPTO', color:'#ff62d5', income: 50000, price:[0,0], prob: 0 };
    }

    
function _getRealItemNames(){
  try{
    // Prefer the in-scope ICON_PATHS; fall back to window if exported
    const map = (typeof ICON_PATHS !== 'undefined') ? ICON_PATHS : (window.ICON_PATHS || {});
    const ks = Object.keys(map || {});
    if (Array.isArray(ks) && ks.length) return ks;
  }catch(e){}
  try{
    // Fall back to ITEM_NAMES and keep only those that have icons available
    const list = (typeof ITEM_NAMES !== 'undefined') ? ITEM_NAMES : (window.ITEM_NAMES || []);
    const map = (typeof ICON_PATHS !== 'undefined') ? ICON_PATHS : (window.ICON_PATHS || {});
    if (Array.isArray(list) && list.length) {
      return list.filter(n => Object.prototype.hasOwnProperty.call(map, n));
    }
  }catch(e){}
  // Last resort: return whatever list is available (may still be empty)
  try{
    return (typeof ITEM_NAMES !== 'undefined') ? ITEM_NAMES.slice() : (window.ITEM_NAMES || []);
  }catch(e){}
  return [];
}
function _randomCrypto(){
  // Build a loot pool strictly from icon-backed items
  const names=(function(){
    try{
      if(typeof ICON_PATHS!=='undefined' && ICON_PATHS) return Object.keys(ICON_PATHS);
      if(typeof window!=='undefined' && window.ICON_PATHS) return Object.keys(window.ICON_PATHS);
    }catch(e){}
    try{
      const list=(typeof ITEM_NAMES!=='undefined')?ITEM_NAMES:(window.ITEM_NAMES||[]);
      const map =(typeof ICON_PATHS!=='undefined')?ICON_PATHS:(window.ICON_PATHS||{});
      if(Array.isArray(list) && list.length) return list.filter(n=>Object.prototype.hasOwnProperty.call(map,n));
    }catch(e){}
    return [];
  })();
  const n = names.length;
  // Robust RNG independent of Math.random()
  let t=0;
  try{ t=(typeof performance!=='undefined' && performance.now)?performance.now():Date.now(); }catch(e){ t=Date.now(); }
  try{ window.__rngCounter=(window.__rngCounter|0)+1; t+=window.__rngCounter; }catch(e){}
  let x = Math.floor(t*1000003) ^ (Date.now()<<13);
  x ^= (x<<13); x ^= (x>>>17); x ^= (x<<5);
  const idx = n>0 ? Math.abs(x)%n : 0;
  const name = n>0 ? names[idx] : '24 King Crown';

  // Create the same kind of icon URL as other forges do
  let svg = '';
  if(typeof getItemSvg==='function'){
    try{ svg = getItemSvg(name, idx, 'crypto') || ''; }catch(e){ svg=''; }
  }
  if(!svg){
    // Fallback: build minimal SVG and encode as a data URI so <img src="..."> works
    const map  = (typeof ICON_PATHS!=='undefined') ? ICON_PATHS : (window.ICON_PATHS || {});
    const path = (map && map[name]) ? String(map[name]) : '';
    const raw  = path ? (
      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96">'+
      '<defs><linearGradient id="gCrypto" x1="0%" y1="0%" x2="100%" y2="0%">'+
      '<stop offset="0%" stop-color="#ff62d5"/><stop offset="100%" stop-color="#ffd84a"/></linearGradient></defs>'+
      '<rect x="4" y="4" width="88" height="88" rx="14" ry="14" fill="url(#gCrypto)" opacity="0.10"/>'+
      '<g stroke="url(#gCrypto)" stroke-width="3.5" fill="none">'+ path +'</g>'+
      '</svg>'
    ) : (
      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96">'+
      '<rect x="6" y="6" width="84" height="84" rx="12" fill="#1a1a1a"/>'+
      '<text x="48" y="52" text-anchor="middle" fill="#ff62d5" font-size="10" font-weight="700">'+(name||'Item')+'</text>'+
      '</svg>'
    );
    try{ svg = 'data:image/svg+xml;utf8,' + encodeURIComponent(raw); }catch(e){ svg=''; }
  }
  return { uid:(Math.random().toString(36).slice(2)+Date.now().toString(36)), name, rarity:'crypto', price:0, baseIdx:idx, svg };
})();
const n = names.length;
// Robust RNG even if Math.random is patched to a constant: use a mixed time-based seed
let t = 0;
try{ t = (typeof performance!=='undefined' && performance.now) ? performance.now() : Date.now(); }catch(e){ t = Date.now(); }
try{ window.__rngCounter = (window.__rngCounter|0) + 1; t += window.__rngCounter; }catch(e){}
let x = Math.floor(t*1000003) ^ (Date.now()<<13);
x ^= (x << 13); x ^= (x >>> 17); x ^= (x << 5);
const idx = n>0 ? Math.abs(x) % n : 0;
const name = n>0 ? names[idx] : '24 King Crown';
const svg  = (typeof getItemSvg==='function') ? getItemSvg(name, idx, 'crypto') : '';
return { uid: (Math.random().toString(36).slice(2) + Date.now().toString(36)), name, rarity:'crypto', price:0, baseIdx:idx, svg };
}

    function checkCryptoForge(){
      try{
        const stands = (window.state && Array.isArray(state.stands)) ? state.stands.slice() : [];
        if(stands.length !== 4) return hideBtn();
        // Must be all 4 filled, only mythic/exotic, and counts = 2 + 2
        let myth=0, exo=0, ok=true;
        for(const uid of stands){
          if(!uid){ ok=false; break; }
          const it = (state.placed||{})[uid] || (state.inventory||[]).find(x=>x.uid===uid);
          if(!it || !it.rarity){ ok=false; break; }
          const r = String(it.rarity).toLowerCase();
          if(r==='mythic') myth++;
          else if(r==='exotic') exo++;
          else { ok=false; break; }
        }
        if(!(ok && myth===2 && exo===2)) return hideBtn();

        // show / create button
        let btn = document.getElementById('cryptoForgeBtn');
        if(!btn){
          btn = document.createElement('button');
          btn.id = 'cryptoForgeBtn';
          btn.textContent = 'FORGE CRYPTO';
          btn.style.cssText = 'margin-top:6px;padding:10px 18px;border-radius:14px;background:linear-gradient(45deg,#ff62d5,#ffd84a);border:4px solid rgba(0,0,0,.35);color:#000;font-weight:900;box-shadow:0 8px 30px rgba(255,120,220,.35);cursor:pointer;';
          btn.addEventListener('click', function(){
            // consume the 4 inputs
            (state.stands||[]).forEach(uid=>{ if(uid && (state.placed||{})[uid]) delete state.placed[uid]; });
            state.stands = [null,null,null,null];
            // create CRYPTO and place on stand 0
            const c = _randomCrypto();
            (state.placed||(state.placed={}))[c.uid] = c;
            state.stands[0] = c.uid;
            if(typeof recalcEPS==='function') recalcEPS();
            if(typeof renderInventory==='function') renderInventory();
            if(typeof renderStands==='function') renderStands();
            if(typeof save==='function') save();
          });
          const host = document.querySelector('.game') || document.body;
          const before = document.querySelector('.inventory-wrap') || null;
          if(before) host.insertBefore(btn, before); else host.appendChild(btn);
        }
        btn.style.display = 'inline-block';
        return;

        function hideBtn(){ const b = document.getElementById('cryptoForgeBtn'); if(b) b.style.display='none'; }
      }catch(e){ /* no-op */ }
      function hideBtn(){ const b = document.getElementById('cryptoForgeBtn'); if(b) b.style.display='none'; }
    }

    // Hook renderStands: run our forge check and add glow to placed CRYPTO items
    (function hookCrypto(){
      const orig = window.renderStands;
      window.renderStands = function(){
        if(typeof orig === 'function') orig.apply(this, arguments);
        try{ checkCryptoForge(); }catch(e){}
        // apply glow if a placed element has a CRYPTO badge
        try{
          document.querySelectorAll('.placed').forEach(el=>{
            const has = !!el.querySelector('.rar.t-crypto');
            el.classList.toggle('crypto-glow', has);
          });
        }catch(e){}
      };
      // initial run
      setTimeout(()=>{ try{ checkCryptoForge(); }catch(e){}; try{
        document.querySelectorAll('.placed').forEach(el=>{
          const has = !!el.querySelector('.rar.t-crypto');
          el.classList.toggle('crypto-glow', has);
        });
      }catch(e){}; }, 0);
    })();
  }catch(e){}
})();
</script>
<script>
/* LA_DODGER_FETCH_HOOK v2: gate on baseline so it only triggers after admin starts */
(function(){
  try{
    const _fetch = window.fetch;
    // Establish baseline at load: any messages at or before these are ignored
    const baselineG = Number(localStorage.getItem('flex_msg_lastG')||0);
    const baselineU = Number(localStorage.getItem('flex_msg_lastU')||0);
    let lastSeen = Math.max(baselineG, baselineU);
    try{ localStorage.setItem('la_dodgers_event_baseline', String(lastSeen)); }catch(e){}
    window.fetch = function(input, init){
      const p = _fetch.apply(this, arguments);
      try{
        const url = (typeof input === 'string') ? input : (input && input.url) || '';
        if(/\/rawsave\?user=/.test(url) && (/__broadcast/.test(url) || /__inbox_/.test(url))){
          p.then(r => r.clone().json().then(data => {
            const list = (data && Array.isArray(data.list)) ? data.list : [];
            for (const m of list){
              const ts = (m && m.ts) || 0;
              if((m && (m.op === 'dodger_event' || m.op === 'LA_DODGER_EVENT')) && ts > lastSeen){
                lastSeen = ts;
                try{ localStorage.setItem('la_dodgers_event_last_ts', String(lastSeen)); }catch(e){}
                if(typeof window.startDodgerLiveEvent === 'function' && !window.__laEventRunning){
                  window.__laEventRunning = true;
                  try{ window.startDodgerLiveEvent(m); }catch(e){}
                }
              }
            }
          }).catch(()=>{})).catch(()=>{});
        }
      }catch(e){}
      return p;
    };
  }catch(e){}
})();
</script>
<script>
// LA_DODGER_LATE_HOOK: ensure enqueue is hooked even if defined later
(function(){
  if(window.__laLateHookInstalled) return; window.__laLateHookInstalled = true;
  let tries = 0, maxTries = 60; // ~60s
  const install = () => {
    if(typeof window.enqueue === 'function' && !window.__laEnqueueWrapped){
      const orig = window.enqueue;
      window.enqueue = function(msg){
        try{
          const gateG = Number(localStorage.getItem('flex_msg_lastG')||0);
          const gateU = Number(localStorage.getItem('flex_msg_lastU')||0);
          const gate = Math.max(gateG, gateU);
          if(msg && (msg.op==='dodger_event' || msg.op==='LA_DODGER_EVENT' || /(la\s*dodger).*event/i.test(String(msg.text||'')))){
            if((msg.ts||0) > gate && typeof window.startDodgerLiveEvent==='function' && !window.__laEventRunning){
              window.__laEventRunning = true;
              try{ window.startDodgerLiveEvent(msg); }catch(e){}
            }
          }
        }catch(e){}
        return orig.apply(this, arguments); // still show the banner
      };
      window.__laEnqueueWrapped = true;
      return true;
    }
    return false;
  };
  if(!install()){
    const t = setInterval(()=>{
      tries++;
      if(install() || tries>=maxTries) clearInterval(t);
    }, 1000);
  }
})();
</script>
<audio id="ziteMusic" preload="auto" src="flex_music/dodger_event_music.mp3" style="display:none"></audio>
<script>

// === Zite Event Music (autoplay with graceful fallback) ===
(function(){
  const audioEl = document.getElementById('ziteMusic');
  let uiShown = false;
  function showEnableButton(){
    if(uiShown) return; uiShown = true;
    const btn = document.createElement('button');
    btn.id = 'enableSoundBtn';
    btn.textContent = 'Enable sound';
    btn.style.position = 'fixed';
    btn.style.zIndex = '2147483647';
    btn.style.bottom = '16px';
    btn.style.right = '16px';
    btn.style.padding = '10px 14px';
    btn.style.borderRadius = '10px';
    btn.style.border = 'none';
    btn.style.background = 'white';
    btn.style.boxShadow = '0 6px 18px rgba(0,0,0,.2)';
    btn.style.fontWeight = '600';
    btn.style.cursor = 'pointer';
    btn.addEventListener('click', async ()=>{
      try{
        await audioEl.play();
        btn.remove();
        window.removeEventListener('pointerdown', tryUnlock, true);
        window.removeEventListener('keydown', tryUnlock, true);
      }catch(e){}
    });
    document.body.appendChild(btn);
  }
  async function tryUnlock(){
    try{
      await audioEl.play();
      const btn = document.getElementById('enableSoundBtn');
      if(btn) btn.remove();
      window.removeEventListener('pointerdown', tryUnlock, true);
      window.removeEventListener('keydown', tryUnlock, true);
    }catch(e){}
  }
  window.playZiteMusic = async function(){
    if(!audioEl) return;
    audioEl.currentTime = 0;
    audioEl.loop = false;
    try{
      await audioEl.play();
    }catch(e){
      // Autoplay likely blocked; ask for a gesture
    }
    if(audioEl.paused){
      showEnableButton();
      window.addEventListener('pointerdown', tryUnlock, true);
      window.addEventListener('keydown', tryUnlock, true);
    }
  };
})();

</script>
<!-- Inventory Filter Mini Sheet -->
<div aria-hidden="true" aria-labelledby="invFilterTitle" class="inv-filter-sheet" id="invFilterSheet" role="dialog">
<header>
<div id="invFilterTitle">Show in inventory</div>
<button aria-label="Close inventory filters" id="invFilterClose">Close</button>
</header>
<div class="opts" id="invFilterOptions">
<!-- checkboxes will be injected by script -->
</div>
<div class="actions">
<button class="all" id="invFilterAll">Select all</button>
<button class="clear" id="invFilterClear">Clear</button>
</div>
</div>
<script>
(function(){
  const CATS = [
    {key:'common', label:'Common'},
    {key:'rare', label:'Rare'},
    {key:'epic', label:'Epic'},
    {key:'legendary', label:'Legendary'},
    {key:'legacy', label:'Legacy'},
    {key:'unique', label:'Unique'},
    {key:'exotic', label:'Exotic'},
    {key:'mythic', label:'Mythic'},
    {key:'crypto', label:'Crypto'},
    {key:'pets', label:'Pets'},
    {key:'eggs', label:'Eggs'},
    {key:'event', label:'Event'}
  ];
  const STORAGE_KEY = 'invFilterPrefsV1';

  function getPrefs(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
    catch(e){ return {}; }
  }
  function setPrefs(p){ localStorage.setItem(STORAGE_KEY, JSON.stringify(p)); }
  function activePrefs(){
    const p = getPrefs();
    const out = {};
    CATS.forEach(c => out[c.key] = (p[c.key] !== false)); // default true
    return out;
  }

  // UI creation
  const host = document.getElementById('invFilterOptions');
  if(host){
    const p = activePrefs();
    host.innerHTML = CATS.map(c => `
      <label class="opt opt-${c.key}">
        <input type="checkbox" data-key="${c.key}" ${p[c.key] ? 'checked' : ''}/>
        <span>${c.label}</span>
      </label>
    `).join('');
  }

  const toggle = document.getElementById('invFilterToggle');
  const sheet  = document.getElementById('invFilterSheet');
  const close  = document.getElementById('invFilterClose');
  const btnAll = document.getElementById('invFilterAll');
  const btnClr = document.getElementById('invFilterClear');

  function openSheet(){
    sheet.classList.add('show');
    sheet.setAttribute('aria-hidden', 'false');
    toggle.setAttribute('aria-expanded', 'true');
  }
  function closeSheet(){
    sheet.classList.remove('show');
    sheet.setAttribute('aria-hidden', 'true');
    toggle.setAttribute('aria-expanded', 'false');
  }

  if(toggle){
    toggle.addEventListener('click', ()=>{
      if(sheet.classList.contains('show')) closeSheet();
      else openSheet();
    });
  }
  if(close) close.addEventListener('click', closeSheet);
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && sheet.classList.contains('show')) closeSheet();
  });
  document.addEventListener('click', (e)=>{
    if(sheet.classList.contains('show')){
      const within = e.target.closest('#invFilterSheet') || e.target.closest('#invFilterToggle');
      if(!within) closeSheet();
    }
  });

  // Preference changes
  host?.addEventListener('change', (e)=>{
    if(e.target && e.target.matches('input[type="checkbox"][data-key]')){
      const p = getPrefs();
      const k = e.target.getAttribute('data-key');
      p[k] = e.target.checked;
      setPrefs(p);
      try { applyInventoryFilters(); } catch(err){ console.warn(err); }
    }
  });
  btnAll?.addEventListener('click', ()=>{
    const p = getPrefs();
    CATS.forEach(c => p[c.key] = true);
    setPrefs(p);
    host.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    try { applyInventoryFilters(); } catch(err){ console.warn(err); }
  });
  btnClr?.addEventListener('click', ()=>{
    const p = getPrefs();
    CATS.forEach(c => p[c.key] = false);
    setPrefs(p);
    host.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    try { applyInventoryFilters(); } catch(err){ console.warn(err); }
  });

  function annotateInventorySlots(){
    const inv = (window.state && state.inventory) ? state.inventory : [];
    const slots = document.querySelectorAll('#inventory .slot');
    slots.forEach((el, i)=>{
      const it = inv[i];
      if(it){
        el.dataset.rarity = String(it.rarity||'').toLowerCase();
        el.dataset.isEgg  = it.isEgg ? '1' : '';
        el.dataset.isPet  = (it.petType && !it.isEgg) ? '1' : '';
        const nm = String(it.name||'').toLowerCase();
        el.dataset.isEvent = (it.event || /dodger|event|zite/.test(nm)) ? '1' : '';
      }else{
        const rarEl = el.querySelector('.rar');
        if(rarEl){
          const m = /t-([a-z]+)/i.exec(rarEl.className || '');
          if(m) el.dataset.rarity = m[1].toLowerCase();
        }
      }
    });
  }

  window.applyInventoryFilters = function applyInventoryFilters(){
    annotateInventorySlots();
    const prefs = activePrefs();
    const slots = document.querySelectorAll('#inventory .slot');
    slots.forEach(el => {
      const rar = (el.dataset.rarity||'').toLowerCase();
      const isEgg = el.dataset.isEgg === '1';
      const isPet = el.dataset.isPet === '1';
      const isEvent = el.dataset.isEvent === '1';
      let show = true;
      if(isEgg) show = prefs.eggs;
      else if(isPet) show = prefs.pets;
      else if(rar && rar in prefs) show = prefs[rar];
      if(isEvent) show = show && prefs.event;
      el.style.display = show ? '' : 'none';
    });
  };

  // Patch renderInventory to auto-apply filters (while preserving any previous patches)
  (function(){
    const prev = window.renderInventory;
    window.renderInventory = function(){
      if(typeof prev === 'function') prev.apply(this, arguments);
      try { window.applyInventoryFilters(); } catch(e){ console.warn('filter apply failed', e); }
    };
  })();

  // Apply once at start (after initial render)
  document.addEventListener('DOMContentLoaded', ()=>{
    setTimeout(()=>{ try { applyInventoryFilters(); } catch(e){} }, 0);
  });
})();
</script>
<script>
// Remove Dodgers Event UI while preserving data/items
(function(){
  function nukeDodgerUI(){
    try{
      const row = document.querySelector('.event-row') || document.getElementById('eventRow');
      if(row && row.parentNode) row.parentNode.removeChild(row);
      const ov = document.getElementById('dodgerOverlay');
      if(ov && ov.parentNode) ov.parentNode.removeChild(ov);
    }catch(e){}
    // hard-disable any global open functions if present
    try{ window.openDodger = function(){}; }catch(e){}
    try{ window.showDodger = function(){}; }catch(e){}
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', nukeDodgerUI);
  else nukeDodgerUI();
})();

/* ===== In-Game Redeem Codes ===== */
(function(){
  const BUCKET_USER = '__redeem_codes__';
  function show(el){ el?.classList?.add('show'); el?.setAttribute('aria-hidden','false'); }
  function hide(el){ el?.classList?.remove('show'); el?.setAttribute('aria-hidden','true'); }
  function banner(msg){ try{ window.__queue && window.__queue({ t: msg, style:'success' }); }catch(e){} }

  async function fetchJson(u){
    try{ const r = await fetch(u, { cache:'no-store' }); if(!r.ok) return null; return await r.json(); }catch(e){ return null; }
  }

  function normalizeCode(s){
    return String(s||'').replace(/[^0-9]/g,'').slice(0,12);
  }

  function applySunriseUnlock(){
    try{
      window.state = window.state || {};
      state.unlockedBackgrounds = state.unlockedBackgrounds || { default:true };
      state.unlockedBackgrounds.sunrise = true;
      state.selectedBackground = state.selectedBackground || 'default';
      try{ if(typeof window.__renderBgGrid === 'function') window.__renderBgGrid(); }catch(e){}
      if(typeof save === 'function') save();
    }catch(e){}
  }

  async function doRedeemNow(){
    const inp = document.getElementById('redeemInput');
    const msg = document.getElementById('redeemMsg');
    const raw = normalizeCode(inp?.value||'');
    if(raw.length !== 12){
      msg.textContent = 'Please enter a 12â€‘digit code.';
      return;
    }
    msg.textContent = 'Checkingâ€¦';
    const data = await fetchJson(`${SERVER_BASE}/rawsave?user=${encodeURIComponent(BUCKET_USER)}&t=${Date.now()}`) || {};
    const codes = Array.isArray(data.codes) ? data.codes : [];
    const hit = codes.find(c => (c && c.active !== false && String(c.code) === raw));
    if(!hit){ msg.textContent = 'Invalid or inactive code.'; return; }

    if(hit.type === 'item'){
      try{
        const name = String(hit.itemName||'').trim(); const rarity = String(hit.rarity||'common').toLowerCase();
        if(!name){ msg.textContent = 'Code is missing item data.'; return; }
        const baseIdx = Math.max(0, (Array.isArray(ITEM_NAMES)?ITEM_NAMES.indexOf(name):-1));
        const svg = (typeof window.getItemSvg==='function') ? getItemSvg(name, baseIdx<0?0:baseIdx, rarity) : '';
        const newItem = { uid: (Math.random().toString(36).slice(2)+Date.now().toString(36)), name, rarity, price:0, baseIdx: baseIdx<0?0:baseIdx, svg };
        window.state = window.state || {}; state.inventory = state.inventory || []; state.inventory.push(newItem);
        if(typeof save === 'function') await save();
        if (typeof renderInventory === 'function') try { renderInventory(); } catch(e){}
        banner('Redeemed! Item added to inventory.');
        // Mark this code as used by removing it from the codes list on the server
        try {
          const nextCodes = codes.filter(x => String(x.code) !== String(raw));
          await fetch(`${SERVER_BASE}/rawsave?user=${encodeURIComponent(BUCKET_USER)}`, {
            method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ __ts: Date.now(), codes: nextCodes })
          });
        } catch(e) { console.warn(e); }
      }catch(e){
        console.warn(e); msg.textContent = 'Could not add item.'; return;
      }
    } else if(hit.type === 'pet'){
      try{
        const petName = String(hit.petName || hit.itemName || hit.petType || '').trim();
        if(!petName){ msg.textContent = 'Code is missing pet data.'; return; }
        // Determine pet EPS: prefer petEps stored in the redeem code; fallback to PET_TABLES lookup
        let eps = 0;
        if(hit && typeof hit.petEps !== 'undefined' && hit.petEps !== null){
          eps = Number(hit.petEps) || 0;
        }
        if(!eps){
          outer: for(const [egg, list] of Object.entries(PET_TABLES || {})){
            if(!Array.isArray(list)) continue;
            for(const p of list){
              if(!p) continue;
              if(p.name === petName){ eps = Number(p.eps) || 0; break outer; }
              if(p.name === 'IRL' && Array.isArray(p.subset) && p.subset.includes(petName)){ eps = Number(p.eps) || 0; break outer; }
            }
          }
        }
        const newPet = {
          uid: uid(),
          name: petName,
          isEgg: false,
          eggType: null,
          petType: petName,
          petEps: eps,
          svg: getPetSvg(petName, Math.floor(Math.random()*99999))
        };
        window.state = window.state || {};
        state.inventory = state.inventory || [];
        state.inventory.push(newPet);
        try{ registerPetOwned(petName); }catch(e){}
        // Apply permanent multiplier flag for legacy pets if needed
        if(petName === 'Flex T-Rex' || petName === 'Flex Dragon' || petName === 'Flexicorn'){ state.permanentPetMultiplier = 1; }
        if(typeof save === 'function') await save();
        if (typeof renderInventory === 'function') try { renderInventory(); } catch(e){}
        banner('Redeemed! Pet added to inventory.');
        // Mark this code as used by removing it from the codes list on the server
        try {
          const nextCodes = codes.filter(x => String(x.code) !== String(raw));
          await fetch(`${SERVER_BASE}/rawsave?user=${encodeURIComponent(BUCKET_USER)}`, {
            method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ __ts: Date.now(), codes: nextCodes })
          });
        } catch(e) { console.warn(e); }
      }catch(e){
        console.warn(e);
        msg.textContent = 'Could not add pet.';
        return;
      }
    } else if(hit.type === 'background' && (hit.backgroundKey||'') === 'sunrise'){
      applySunriseUnlock();
      banner('Redeemed! Sunrise background unlocked.');
      // Mark this code as used by removing it from the codes list on the server
      try {
        const nextCodes = codes.filter(x => String(x.code) !== String(raw));
        await fetch(`${SERVER_BASE}/rawsave?user=${encodeURIComponent(BUCKET_USER)}`, {
          method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ __ts: Date.now(), codes: nextCodes })
        });
      } catch(e) { console.warn(e); }
    } else {
      msg.textContent = 'Unknown reward type.'; return;
    }

    hide(document.getElementById('redeemOverlay'));
    msg.textContent = '';
    if(inp) inp.value = '';
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const openBtn = document.getElementById('openRedeemOverlay');
    const closeBtn = document.getElementById('closeRedeem');
    const overlay = document.getElementById('redeemOverlay');
    const goBtn = document.getElementById('doRedeem');
    if(openBtn){ openBtn.addEventListener('click', ()=> show(overlay)); }
    if(closeBtn){ closeBtn.addEventListener('click', ()=> hide(overlay)); }
    if(goBtn){ goBtn.addEventListener('click', doRedeemNow); }
  });
})();
</script>
<script>
(function(){
  try{
    const __origGetEggSvg = window.getEggSvg;
    window.getEggSvg = function(eggType, seed){
      if(eggType !== 'magical'){ return __origGetEggSvg.apply(this, arguments); }
      const size = 96;
      const gradId = 'magGrad' + seed;
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 96 96">
        <defs>
          <filter id="eg${seed}" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.35"/>
          </filter>
          <linearGradient id="${gradId}" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#ff004c"/>
            <stop offset="20%" stop-color="#ff7a00"/>
            <stop offset="40%" stop-color="#ffd400"/>
            <stop offset="60%" stop-color="#18e300"/>
            <stop offset="80%" stop-color="#00e7ff"/>
            <stop offset="100%" stop-color="#3a31ff"/>
          </linearGradient>
        </defs>
        <rect x="4" y="4" width="88" height="88" rx="14" fill="#333" />
        <g filter="url(#eg${seed})">
          <ellipse cx="48" cy="52" rx="22" ry="28" fill="url(#${gradId})" />
          <ellipse cx="40" cy="40" rx="6" ry="4" fill="#fff" opacity="0.65"/>
          <g>
            <circle cx="28" cy="30" r="1.6" fill="#fff">
              <animate attributeName="opacity" values="0;1;0" dur="2.2s" repeatCount="indefinite"/>
            </circle>
            <circle cx="68" cy="28" r="1.2" fill="#fff">
              <animate attributeName="opacity" values="0;1;0" dur="1.8s" begin="0.4s" repeatCount="indefinite"/>
            </circle>
            <circle cx="60" cy="68" r="1.4" fill="#fff">
              <animate attributeName="opacity" values="0;1;0" dur="2.6s" begin="0.8s" repeatCount="indefinite"/>
            </circle>
            <circle cx="32" cy="66" r="1.3" fill="#fff">
              <animate attributeName="opacity" values="0;1;0" dur="2.0s" begin="0.2s" repeatCount="indefinite"/>
            </circle>
          </g>
        </g>
      </svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    };
  }catch(e){}
})();
</script>
<script>
(function(){
  try{
    function flexicornCountOnPedestals(){
      try{
        const stands = (window.state && Array.isArray(state.petStands)) ? state.petStands : [];
        let n = 0;
        for(const p of stands){
          if(p && !p.isEgg && ((p.petType||p.name) === 'Flexicorn')) n++;
        }
        return n;
      }catch(e){ return 0; }
    }
    function currentShopWeights(){
      const base = { unique:0.3, legacy:0.5, legendary:1, epic:8, rare:10, common:100 - (0.3+0.5+1+8+10) };
      const count = flexicornCountOnPedestals();
      if(count <= 0) return base;
      const w = { common:50, rare:12, epic:23, legendary:6, legacy:5, unique:4 };
      for(let i=1;i<count;i++){
        w.common = Math.max(0, w.common - 5);
        w.rare += 1; w.epic += 1; w.legendary += 1; w.legacy += 1; w.unique += 1;
      }
      const sum = w.common + w.rare + w.epic + w.legendary + w.legacy + w.unique;
      if(Math.abs(sum - 100) > 0.0001){
        const k = 100/sum;
        w.common*=k; w.rare*=k; w.epic*=k; w.legendary*=k; w.legacy*=k; w.unique*=k;
      }
      return w;
    }
    const __origWeightedPick = window.weightedPick;
    window.weightedPick = function(){
      try{
        const w = currentShopWeights();
        const r = Math.random()*100;
        let acc = 0;
        const order = ['unique','legacy','legendary','epic','rare','common'];
        for(const k of order){
          acc += (w[k]||0);
          if(r < acc) return k;
        }
        return 'common';
      }catch(e){
        return typeof __origWeightedPick === 'function' ? __origWeightedPick() : 'common';
      }
    };
  }catch(e){}
})();
</script>
<script>
// Single-binding for Magical Egg purchase to avoid double hatches
(function(){
  if (window.__bindMagicalEggOnce) return;
  window.__bindMagicalEggOnce = true;
  function bind(){
    var btn = document.getElementById('buyMagicalEgg');
    if(!btn) return;
    // Replace node to drop any listeners added elsewhere
    var newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    var busy = false;
    newBtn.addEventListener('click', function(){
      if (busy) return;
      busy = true;
      try { if (typeof buyEgg === 'function') buyEgg('magical'); }
      finally {
        setTimeout(function(){
          busy = false;
          if (typeof updatePetButtonsUI === 'function') updatePetButtonsUI();
        }, 0);
      }
    });
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind);
  else bind();
})();
</script>
<script>
// Active pedestal multiplier: counts Flex T-Rex, Flex Dragon, Flexicorn on pedestals
(function(){
  try{
    window.getActivePedestalMultiplier = function(){
      try{
        const stands = (window.state && Array.isArray(state.petStands)) ? state.petStands : [];
        let count = 0;
        for(const ps of stands){
          if(!ps || ps.isEgg) continue;
          const nm = String((ps.petType||ps.name)||'').toLowerCase();
          if(nm === 'flex t-rex' || nm === 'flex dragon' || nm === 'flexicorn') count++;
        }
        return count > 0 ? (5 * count) : 1; // x5 per qualifying pet on pedestal
      }catch(e){ return 1; }
    };
  }catch(e){ /* no-op */ }
})();
</script>
<!-- ===== Forge Page (overlay) â€“ added by update v92 ===== -->
<style>
  /* Vertical tool bar anchored to inventory (will be positioned by JS) */
  #toolBarArea{
    position:fixed; z-index:12;
    display:flex; flex-direction:column-reverse; gap:12px;
    align-items:center; justify-content:flex-end;
  }
  #forgeOpenBtn{
    width:64px; height:64px; border-radius:18px;
    display:grid; place-items:center;
    background:#ffd24a; border:4px solid rgba(0,0,0,.4);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    cursor:pointer;
  }
  #forgeOpenBtn img{ width:70%; height:70%; object-fit:contain; }

  /* Forge overlay base */
  #forgeOverlay{ display:none !important; background:transparent !important; backdrop-filter:none !important; -webkit-backdrop-filter:none !important; pointer-events:none; }
  #forgeOverlay.show{ display:flex !important; }
  #forgeOverlay .sheet{ pointer-events:auto; }

  #forgeOverlay .sheet{
    width:min(1120px,96%);
    background:linear-gradient(#f6b374,#f4946a);
    border-radius:30px; border:6px solid #212127; color:#111;
    position:relative; overflow:hidden;
    margin-bottom:160px; /* keep clear of bottom inventory */
  }
  #forgeOverlay h2{
    margin:0 0 6px; font-family:"Russo One"; font-size:52px;
    text-align:center; color:#fff; text-shadow:0 2px 0 rgba(0,0,0,.45);
    letter-spacing:1px;
  }

  .forge-wrap{ display:grid; grid-template-columns:260px 1fr; gap:18px; }
  .forge-left{
    background:#25252b; border:4px solid #111; border-radius:24px; padding:18px; color:#e8e8ee;
  }
  .forge-left h3{ margin:0 0 6px; color:#ffd24a; font-size:32px; font-family:"Russo One"; }
  .forge-left .rule{ margin:16px 0; font-weight:900; }
  .forge-left .rule span{ display:block; opacity:.85; font-weight:700; }

  .forge-grid{
    display:grid; grid-template-columns:1fr auto 1fr; gap:18px; align-items:center;
  }
  .grid-4{
    display:grid; grid-template-columns:repeat(2, 200px); grid-template-rows:repeat(2, 180px); gap:18px;
    background:rgba(255,255,255,.08); padding:16px; border-radius:24px; border:6px solid #f8c24a;
  }
  .forge-slot,.result-slot{
    background:#4b4b52; border-radius:22px; border:6px solid #2b2b31;
    display:grid; place-items:center; position:relative; color:#fff; font-weight:800;
  }
  .forge-slot::after{ content:attr(data-idx); position:absolute; bottom:10px; right:12px; font-weight:900; font-size:28px; color:#ffd24a; text-shadow:0 2px 0 rgba(0,0,0,.35); }
  .forge-slot img, .result-slot img{ width:96px; height:96px; border-radius:14px; }
  .result-wrap{ display:grid; grid-template-rows:180px auto; gap:14px; }
  .result-slot{ width:220px; height:180px; border-color:#7c4cff; box-shadow:inset 0 0 0 6px rgba(124,76,255,.35); }
  #forgeGo{
    padding:16px 24px; font-weight:900; border-radius:16px;
    background:linear-gradient(45deg,#ffd86a,#ffb200); border:4px solid rgba(0,0,0,.35); cursor:pointer;
  }
  #forgeGo:disabled{ filter:grayscale(1) brightness(.7); cursor:not-allowed; }
  .closeForge{ position:absolute; right:12px; top:8px; font-size:28px; background:#222; color:#fff; border:none; border-radius:14px; width:44px; height:44px; cursor:pointer; }
  @media (max-width: 860px){
    .grid-4{ grid-template-columns:repeat(2, min(46vw,200px)); grid-template-rows:repeat(2, 42vw); }
    .result-slot{ width:min(50vw,240px); height:min(40vw,180px); }
  }
</style>
<!-- Tool Bar rail (positioned by JS to kiss the inventory edge) -->
<div id="toolBarArea">
<button id="forgeOpenBtn" title="Forge">
<img alt="Forge" src="icons/forge_icon.png">
</img></button>
</div>
<!-- Forge Overlay -->
<div aria-hidden="true" class="overlay" id="forgeOverlay">
<div aria-labelledby="forgeTitle" aria-modal="true" class="sheet" role="dialog">
<button aria-label="Close Forge" class="closeX closeForge">âœ•</button>
<h2 id="forgeTitle">FORGE</h2>
<div class="forge-wrap">
<div class="forge-left">
<h3>MYTHIC</h3>
<div class="rule">4 LEGENDARY = <span>1 RANDOM MYTHIC</span></div>
<h3 style="color:#7fefff">EXOTIC</h3>
<div class="rule">4 LEGACY = <span>1 RANDOM EXOTIC</span></div>
<h3 style="color:#ff62d5">CRYPTO</h3>
<div class="rule">2 MYTHIC + 2 EXOTIC = <span>1 RANDOM CRYPTO</span></div>
<div style="opacity:.7;margin-top:10px">Tip: click an inventory item, then click a slot to place it.</div>
</div>
<div class="forge-grid">
<div class="grid-4">
<div class="forge-slot" data-idx="1"></div>
<div class="forge-slot" data-idx="2"></div>
<div class="forge-slot" data-idx="3"></div>
<div class="forge-slot" data-idx="4"></div>
</div>
<div>
<button disabled="" id="forgeGo">FORGE</button>
</div>
<div class="result-wrap">
<div class="result-slot" id="forgeResult"></div>
<div style="text-align:center;font-weight:900;opacity:.85">RESULT</div>
</div>
</div>
</div>
</div>
</div>
<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));

  // Has to be *hidden* until opened
  function openForge(){ const o = $('#forgeOverlay'); o.classList.add('show'); o.setAttribute('aria-hidden','false'); }
  function closeForge(){ const o = $('#forgeOverlay'); o.classList.remove('show'); o.setAttribute('aria-hidden','true'); }
  window.openForgePage = openForge; window.closeForgePage = closeForge;

  // Slots
  const forgeSlots = [null,null,null,null];

  function renderForgeSlots(){
    $$('.forge-slot').forEach((el, i)=>{
      const it = forgeSlots[i];
      el.innerHTML = it ? `<img src="${it.svg}" alt="${(it.name||'Item')}"/>` : '';
    });
    (function(){var r=document.getElementById('forgeResult'); if(r && !r.dataset.hold){ r.innerHTML=''; }})();
    updateForgeButton();
  }

  function canForge(){
    const items = forgeSlots.filter(Boolean);
    if(items.length !== 4) return false;
    const rar = items.map(i => String(i.rarity||'').toLowerCase());
    rar.sort();
    const rarKey = rar.join(',');
    if(rarKey === 'legendary,legendary,legendary,legendary') return 'mythic';
    if(rarKey === 'legacy,legacy,legacy,legacy') return 'exotic';
    const counts = items.reduce((m,i)=>{const r=String(i.rarity||'').toLowerCase(); m[r]=(m[r]||0)+1; return m;},{});
    if(counts.mythic===2 && counts.exotic===2) return 'crypto';
    return false;
  }

  function updateForgeButton(){
    const r = canForge();
    const btn = $('#forgeGo');
    btn.disabled = !r;
    btn.title = r ? ('Create ' + r.toUpperCase()) : 'Select a valid recipe';
  }

  function takeFromInventoryByUid(uid){
    try{
      const idx = (state.inventory||[]).findIndex(x=>x && x.uid===uid);
      if(idx>=0) return (state.inventory.splice(idx,1)[0]);
    }catch(e){}
    return null;
  }

  function getRealNames(){
    try{ if(typeof getRealItemNames==='function') return getRealItemNames(); }catch(e){}
    try{ if(typeof _getRealItemNames==='function') return _getRealItemNames(); }catch(e){}
    return Array.isArray(window.ITEM_NAMES)? window.ITEM_NAMES.slice() : [];
  }

  function makeRandomMythic(){
    try{ if(typeof createMythicItem==='function'){ const r=createMythicItem(); if(r && r.svg) return r; } }catch(e){}
    const real = getRealNames();
    const idx = Math.floor(Math.random()*(real.length||20));
    const name = real[idx] || 'Mythic Item';
    const svg  = (typeof getItemSvg==='function') ? getItemSvg(name, idx, 'mythic') : '';
    return { uid: (Math.random().toString(36).slice(2)+Date.now().toString(36)), name, rarity:'mythic', price:0, baseIdx:idx, svg };
  }
  function makeRandomExotic(){
  try{ if(typeof createRandomNormalExotic==='function'){ const r=createRandomNormalExotic(); if(r && r.svg) return r; } }catch(e){}
  if(typeof _randomExotic==='function') return _randomExotic();
    const real = (typeof _getRealItemNames==='function') ? _getRealItemNames() : (Array.isArray(window.ITEM_NAMES)?window.ITEM_NAMES.slice():[]);
  const idx  = Math.floor(Math.random() * (real.length || 20));
  const name = real[idx] || '24 King Crown';
  const svg  = (typeof window.getItemSvg==='function') ? getItemSvg(name, idx, 'exotic') : '';
  return { uid: (Math.random().toString(36).slice(2) + Date.now().toString(36)), name, rarity:'exotic', price:0, baseIdx:idx, svg };
}
  function makeRandomCrypto(){
  try{
    if(typeof _randomCrypto==='function'){
      const r=_randomCrypto();
      if(r && r.svg) return r;
    }
  }catch(e){}
  // Absolute fallback (should rarely run)
  const names=(function(){
    try{
      if(typeof ICON_PATHS!=='undefined' && ICON_PATHS) return Object.keys(ICON_PATHS);
      if(typeof window!=='undefined' && window.ICON_PATHS) return Object.keys(window.ICON_PATHS);
    }catch(e){}
    try{
      const list=(typeof ITEM_NAMES!=='undefined')?ITEM_NAMES:(window.ITEM_NAMES||[]);
      const map =(typeof ICON_PATHS!=='undefined')?ICON_PATHS:(window.ICON_PATHS||{});
      if(Array.isArray(list) && list.length) return list.filter(n=>Object.prototype.hasOwnProperty.call(map,n));
    }catch(e){}
    return [];
  })();
  const n = names.length;
  let t=0; try{ t=(typeof performance!=='undefined' && performance.now)?performance.now():Date.now(); }catch(e){ t=Date.now(); }
  try{ window.__rngCounter=(window.__rngCounter|0)+1; t+=window.__rngCounter; }catch(e){}
  let x = Math.floor(t*1000003) ^ (Date.now()<<13); x ^= (x<<13); x ^= (x>>>17); x ^= (x<<5);
  const idx = n>0 ? Math.abs(x)%n : 0;
  const name = n>0 ? names[idx] : '24 King Crown';

  let svg='';
  if(typeof getItemSvg==='function'){
    try{ svg = getItemSvg(name, idx, 'crypto') || ''; }catch(e){ svg=''; }
  }
  if(!svg){
    const map  = (typeof ICON_PATHS!=='undefined') ? ICON_PATHS : (window.ICON_PATHS || {});
    const path = (map && map[name]) ? String(map[name]) : '';
    const raw  = path ? (
      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96">'+
      '<defs><linearGradient id="gCrypto" x1="0%" y1="0%" x2="100%" y2="0%">'+
      '<stop offset="0%" stop-color="#ff62d5"/><stop offset="100%" stop-color="#ffd84a"/></linearGradient></defs>'+
      '<rect x="4" y="4" width="88" height="88" rx="14" ry="14" fill="url(#gCrypto)" opacity="0.10"/>'+
      '<g stroke="url(#gCrypto)" stroke-width="3.5" fill="none">'+ path +'</g>'+
      '</svg>'
    ) : (
      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96">'+
      '<rect x="6" y="6" width="84" height="84" rx="12" fill="#1a1a1a"/>'+
      '<text x="48" y="52" text-anchor="middle" fill="#ff62d5" font-size="10" font-weight="700">'+(name||'Item')+'</text>'+
      '</svg>'
    );
    try{ svg = 'data:image/svg+xml;utf8,' + encodeURIComponent(raw); }catch(e){ svg=''; }
  }
  return { uid:(Math.random().toString(36).slice(2)+Date.now().toString(36)), name, rarity:'crypto', price:0, baseIdx:idx, svg };
}

  function _randomExotic(){
// Build a loot pool strictly from icon-backed items
const names = (function(){
  try{
    if (typeof ICON_PATHS !== 'undefined' && ICON_PATHS) return Object.keys(ICON_PATHS);
    if (typeof window !== 'undefined' && window.ICON_PATHS) return Object.keys(window.ICON_PATHS);
  }catch(e){}
  try{
    const list = (typeof ITEM_NAMES!=='undefined') ? ITEM_NAMES : (window.ITEM_NAMES || []);
    const map  = (typeof ICON_PATHS!=='undefined') ? ICON_PATHS : (window.ICON_PATHS || {});
    if (Array.isArray(list) && list.length) return list.filter(n => Object.prototype.hasOwnProperty.call(map, n));
  }catch(e){}
  return [];
})();
const n = names.length;
const idx = n>0 ? Math.floor(Math.random()*n) : 0;
const name = n>0 ? names[idx] : '24 King Crown';const svg  = (typeof getItemSvg==='function') ? getItemSvg(name, idx, 'exotic') : '';
return { uid: (Math.random().toString(36).slice(2) + Date.now().toString(36)), name, rarity:'exotic', price:0, baseIdx:idx, svg };
}

function doForge(){
    const outType = canForge();
    if(!outType) return;
    // consume inputs
    forgeSlots.forEach((it, i)=> forgeSlots[i]=null);
    // create result
    let res=null;
    if(outType==='mythic') res = makeRandomMythic();
    else if(outType==='exotic') res = makeRandomExotic();
    else if(outType==='crypto') res = makeRandomCrypto();

    if(res){
      const slot = document.getElementById('forgeResult');
      if(slot){
        try{ slot.dataset.hold = '1'; }catch(e){}
        // Show the icon + name for 3 seconds
        slot.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;gap:6px;">'
          + '<img src=\"' + (res.svg||'') + '\" alt=\"' + (res.name||'Item') + '\" style=\"width:96px;height:96px;border-radius:14px;\"/>'
          + '<div style=\"font-weight:800;font-size:14px;opacity:.9;\">' + String(res.name||'ITEM').toUpperCase() + '</div>'
          + '</div>';
      }

      // Add to inventory and persist
      window.state = window.state || {};
      state.inventory = state.inventory || [];
      state.inventory.push(res);
      if(typeof recalcEPS==='function') try{ recalcEPS(); }catch(e){}
      if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
      if(typeof save==='function') try{ save(); }catch(e){}

      // Clear the preview after 3 seconds, keep item in inventory
      try{
        if(window.__forgeResultTimer) clearTimeout(window.__forgeResultTimer);
        window.__forgeResultTimer = setTimeout(function(){
          var s = document.getElementById('forgeResult');
          if(s){ s.innerHTML = ''; try{ delete s.dataset.hold; }catch(e){} }
        }, 3000);
      }catch(e){}
    }
    renderForgeSlots();
}

  function attachSlotHandlers(){
    $$('.forge-slot').forEach((el, i)=>{
      el.addEventListener('click', ()=>{
        const sel = window.state && state.selectedItemUid;
        if(sel){
          const obj = (state.inventory||[]).find(x=>x && x.uid===sel);
          if(!obj) return;
          if(forgeSlots[i]) state.inventory.push(forgeSlots[i]); // return to inv
          forgeSlots[i] = takeFromInventoryByUid(sel) || obj;
          state.selectedItemUid = null;
          if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
          renderForgeSlots();
          return;
        }
        if(forgeSlots[i]){ // no selection: remove from slot
          state.inventory.push(forgeSlots[i]); forgeSlots[i]=null;
          if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
          renderForgeSlots();
        }
      });
    });
  }

  // Position the tool rail so it kisses the inventory's right edge
  function getInventoryEl(){
    return document.querySelector('.inventory') ||
           document.querySelector('#inventory') ||
           document.querySelector('.inventory-wrap');
  }
  function positionToolbar(){
    const rail = document.getElementById('toolBarArea');
    const inv  = getInventoryEl();
    if(!rail || !inv) return;
    const r = inv.getBoundingClientRect();
    const gap = -2; // negative so it visually touches even with shadows
    rail.style.left   = (r.right + gap) + 'px';
    rail.style.right  = '';
    rail.style.top    = '';
    rail.style.bottom = (window.innerHeight - r.bottom) + 'px';
    rail.style.maxHeight = Math.max(0, r.top - 8) + 'px';
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // open/close wiring
    document.getElementById('forgeOpenBtn')?.addEventListener('click', ()=>{
      if(typeof openPage==='function'){ try{ openPage('forge'); }catch(e){} }
      openForge();
    });
    document.querySelector('#forgeOverlay .closeForge')?.addEventListener('click', closeForge);
    document.getElementById('forgeGo')?.addEventListener('click', doForge);
    attachSlotHandlers();
    renderForgeSlots();
    // Place toolbar correctly
    positionToolbar();
    window.addEventListener('resize', positionToolbar);
    if(typeof window.renderInventory === 'function'){
      const orig = window.renderInventory;
      window.renderInventory = function(){
        try{ return orig.apply(this, arguments); }
        finally{ try{ positionToolbar(); }catch(e){} }
      }
    }
    const obs = new MutationObserver(positionToolbar);
    obs.observe(document.body, { childList:true, subtree:true });
  });
})();
</script>
<!-- ===== end Forge Page addition v92 ===== -->
<script>
(function(){
  // Never show these specific forge buttons
  var BLOCK_IDS = ['exoticForgeBtn','cryptoForgeBtn','mythicForgeBtn'];
  function nuke(root){
    root = root || document;
    // Remove by ID
    BLOCK_IDS.forEach(function(id){
      var el = root.getElementById ? root.getElementById(id) : document.getElementById(id);
      if(el){ try{ el.remove(); }catch(e){ el.style.display='none'; } }
      // also querySelectorAll in case of duplicates
      try{
        root.querySelectorAll('#'+id).forEach(function(n){ try{ n.remove(); }catch(e){ n.style.display='none'; } });
      }catch(e){}
    });
    // Remove by text content: "FORGE", "FORGE MYTHIC", "FORGE EXOTIC", "FORGE CRYPTO"
    var rx = /^(forge(\s+(mythic|exotic|crypto))?)$/i;
    try{
      root.querySelectorAll('button').forEach(function(b){
        var t = (b.innerText||'').trim();
        // avoid removing "Forge Page" or the main overlay action buttons inside the Forge Page
        if (/forge\s*page/i.test(t)) return;
        if (rx.test(t) || /forge\s+mythic|forge\s+exotic|forge\s+crypto/i.test(t)) {
          // If this button lives inside the Forge overlay, keep it
          var keep = false;
          var p = b.parentElement;
          while(p){
            if (p.id === 'forgeOverlay') { keep = true; break; }
            p = p.parentElement;
          }
          if(!keep){
            try{ b.remove(); }catch(e){ b.style.display='none'; }
          }
        }
      });
    }catch(e){}
  }

  function neutralizeFns(){
    // Neutralize pedestal-related forge checks only (do NOT touch forge page functions)
    ['checkExoticForge','checkCryptoForge','checkForge'].forEach(function(name){
      try{
        if (typeof window[name] === 'function'){
          window[name] = function(){ /* disabled to enforce forge via Forge Page only */ };
        }
      }catch(e){}
    });
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      neutralizeFns();
      nuke(document);
    });
  } else {
    neutralizeFns();
    nuke(document);
  }

  // Keep future dynamic insertions removed
  try{
    var mo = new MutationObserver(function(muts){
      for (var i=0;i<muts.length;i++){
        var m = muts[i];
        if (m.addedNodes && m.addedNodes.length){
          for (var j=0;j<m.addedNodes.length;j++){
            var n = m.addedNodes[j];
            if (n.nodeType === 1){ nuke(n); }
          }
        }
      }
    });
    mo.observe(document.documentElement, {childList:true, subtree:true});
  }catch(e){}
})();
</script>
<!-- Stranger Things Event Overlay -->
<div aria-hidden="true" class="overlay" id="strangerOverlay">
  <div aria-labelledby="strangerTitle" aria-modal="true" class="sheet" role="dialog">
    <button aria-label="Close" class="closeX" id="closeStranger">âœ•</button>
    <h2 id="strangerTitle">STRANGER THINGS</h2>
    <div class="stranger-grid">
      <div class="stranger-card" id="cardHawkinsPack">
        <h3>Hawkins Pack <span class="cosmic-badge t-legendary">LIMITED</span></h3>
        <div class="stranger-desc">Open the pack to receive a random item in EPIC/LEGENDARY/UNIQUE/MYTHIC from the Hawkins set.</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
          <div class="stranger-price">$2,000,000,000</div>
          <button class="stranger-buy" id="buyHawkinsPack">Purchase</button>
        </div>
      </div>
      <div class="stranger-card" id="cardHawkinsBG">
        <h3>Welcome to Hawkins</h3>
        <div class="stranger-desc">Themed background; appears in Backgrounds after purchase.</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
          <div class="stranger-price">$10,000,000,000,000</div>
          <button class="stranger-buy" id="buyHawkinsStyle">Purchase</button>
        </div>
      </div>
      <div class="stranger-card">
        <h3>Demoegg</h3>
        <div class="stranger-desc">Hatches: Dart (68% / 25,000 EPS), Demobat (30% / 45,000 EPS), Demodog (2% / 65,000 EPS). Demodog every 20 minutes 50% morph of a placed item adds DEMON badge + red pulse +15,000 EPS to that item.</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
          <div class="stranger-price">$3,000,000,000</div>
          <button class="stranger-buy" id="buyDemoEgg">Purchase</button>
        </div>
      </div>
      <div class="stranger-card" style="display:grid;place-items:center;">
        <img alt="Stranger Things" id="strangerShopLogo"/>
      </div>
    </div>
  </div>
</div>

<div class="cosmic-reveal" id="strangerReveal">
  <div class="card">
    <div style="font-family:'Bungee';font-size:28px;letter-spacing:1px;">You received</div>
    <img alt="reward" id="strangerRevealImg"/>
    <div id="strangerRevealName" style="font-weight:900;margin-top:6px;"></div>
    <div class="rar" id="strangerRevealRarity" style="margin:8px auto 0;padding:6px 12px;border-radius:12px;"></div>
  </div>
</div>


<script>
(function(){
  function setStrangerEventIcon(btnEl){
    const candidate = 'icons/stranger_things_icon.png';
    const img = new Image();
    img.onload = function(){
      try{
        const btn = btnEl || document.getElementById('openStranger');
        if(btn) btn.style.setProperty('--stranger-icon', "url('"+candidate+"')");
        const shop = document.getElementById('strangerShopLogo'); if(shop){ shop.src = candidate; }
      }catch(e){}
    };
    img.onerror = function(){};
    img.src = candidate;
  }

  var __hawkinsBgURL = null;
  function ensureHawkinsBgURL(cb){
    if(__hawkinsBgURL){ cb(__hawkinsBgURL); return; }
    const url = 'background_files/hawkins_style.png';
    const test = new Image();
    test.onload = function(){ __hawkinsBgURL = url; writeCss(); cb(url); };
    test.onerror = function(){ __hawkinsBgURL = url; writeCss(); cb(url); };
    test.src = url;
    function writeCss(){
      try{
        let st = document.getElementById('hawkinsBgStyle');
        if(!st){ st = document.createElement('style'); st.id = 'hawkinsBgStyle'; document.head.appendChild(st); }
        st.textContent = "body.bg-hawkins{background:url('"+url+"') center/cover no-repeat fixed !important;}";
      }catch(e){}
    }
  }

  function ensureEventButton(){
    if(document.getElementById('openStranger')) return;
    const row = document.querySelector('.event-row') || document.getElementById('eventRow');
    if(row){
      const btn = document.createElement('button');
      btn.className = 'icon-btn icon-stranger';
      btn.id = 'openStranger';
      btn.title = 'Stranger Things Event';
      btn.innerHTML = '<span class="fallback-text">ST</span>';
      row.appendChild(btn);
      btn.addEventListener('click', openOverlay);
      setStrangerEventIcon(btn);
    } else {
      const b = document.createElement('button');
      b.className = 'icon-btn icon-stranger';
      b.id = 'openStranger';
      b.title = 'Stranger Things Event';
      b.style.position = 'fixed';
      b.style.left = '16px';
      b.style.top = '28px';
      b.style.width = '72px';
      b.style.height = '72px';
      b.style.borderRadius = '18px';
      b.style.zIndex = '20';
      b.innerHTML = '<span class="fallback-text">ST</span>';
      document.body.appendChild(b);
      b.addEventListener('click', openOverlay);
      setStrangerEventIcon(b);
    }
  }

  function openOverlay(){
    document.getElementById('strangerOverlay').classList.add('show');
    document.getElementById('strangerOverlay').setAttribute('aria-hidden','false');
    setStrangerEventIcon();
    updateHawkinsStyleUI();
  }

  document.getElementById('closeStranger')?.addEventListener('click', ()=>{
    document.getElementById('strangerOverlay').classList.remove('show');
    document.getElementById('strangerOverlay').setAttribute('aria-hidden','true');
  });

  const HAWKINS_PACK_COST = 2_000_000_000;
  
// --- MIGRATION HELPERS ---
function __isInlineSvgString(v){
  return typeof v === 'string' && v.trim().startsWith('<svg');
}
function __hawkinsFileForName(n){
  try{
    const hit = (typeof hawkinsItems!=='undefined' ? hawkinsItems : []).find(x=>x.name===n);
    return hit ? ('stranger_things_items/'+hit.file) : null;
  }catch(e){ return null; }
}
function __petPngFor(it, seed){
  try{
    return getPetSvg(it.petType || it.name, seed);
  }catch(e){ return null; }
}

// === FILE-BASED ICON LOOKUP ===
// Maintain a single object mapping item names to the PNG file path that should be used for its icon.
// Hawkins (Stranger Things) pack items are registered here.  Each entry maps
// the humanâ€‘friendly item name to the corresponding file in the
// `stranger_things_items/` folder.  This list should stay in sync with
// the files under that directory.  If you add or remove items from the
// Build a static mapping from item names to their PNG file paths.  Do not rely
// on dynamically defined arrays (hawkinsItems, LA_ITEMS) because they may not
// yet exist when this code runs.  Instead, explicitly define the mapping here
// so legacy saves and unobtainable event items always pick up their proper
// icons.  If you add more items or folders in the future, extend this map.
window.ITEM_FILE_MAP = window.ITEM_FILE_MAP || {};
Object.assign(ITEM_FILE_MAP, {
  // Stranger Things items
  'Bat': 'stranger_things_items/bat.png',
  'Bike': 'stranger_things_items/bike.png',
  'Code Red': 'stranger_things_items/code_red.png',
  'Demogorgon': 'stranger_things_items/demogorgon.png',
  'Dustin Henderson': 'stranger_things_items/dustin_henderson.png',
  'Hawkins Lab': 'stranger_things_items/hawkins_lab.png',
  'Jane 11': 'stranger_things_items/jane_11.png',
  'Jim Hopper': 'stranger_things_items/jim_hopper.png',
  'Lucas Sinclair': 'stranger_things_items/lucas_sinclair.png',
  'Max Mayfield': 'stranger_things_items/max_mayfield.png',
  'Mike Wheeler': 'stranger_things_items/mike_wheeler.png',
  'Nancy Wheeler': 'stranger_things_items/nancy_wheeler.png',
  'Scoops Ahoy': 'stranger_things_items/scoops_ahoy.png',
  'Steve Harrington': 'stranger_things_items/steve_harrington.png',
  'Vecna': 'stranger_things_items/vecna.png',
  'Will Byers': 'stranger_things_items/will_byers.png',
  // LA Dodgers items
  'Dodger Hat': 'la_dodgers_items/dodger_hat.png',
  'Dodger Stadium': 'la_dodgers_items/dodger_stadium.png',
  'World Series': 'la_dodgers_items/world_series.png',
  'Shohei Ohtani': 'la_dodgers_items/shohei_ohtani.png',
  'Will Smith': 'la_dodgers_items/will_smith.png',
  'Freddie Freeman': 'la_dodgers_items/freddie_freeman.png',
  'Mookie Betts': 'la_dodgers_items/mookie_betts.png',
  'Dodger Baseball': 'la_dodgers_items/dodger_baseball.png',
  'Dodger Welcome': 'la_dodgers_items/dodger_welcome.png',
  // Space Pack items
  'Asteroid': 'space_pack_items/asteroid.png',
  'Black Hole': 'space_pack_items/black_hole.png',
  'Earth': 'space_pack_items/earth.png',
  'Mars': 'space_pack_items/mars.png',
  'Moon': 'space_pack_items/moon.png',
  'Space Ship': 'space_pack_items/space_ship.png',
  'Space Suit': 'space_pack_items/space_suit.png',
  'Sun': 'space_pack_items/sun.png'
});

// Also register lowercase/trimmed variants of each key so lookups with
// inconsistent casing or stray whitespace will still resolve to the correct
// PNG.  We loop over the current keys and add a lowerâ€‘cased entry if it
// doesn't already exist.  This is wrapped in a try/catch to avoid
// interfering with other parts of the page in case of errors.
try {
  (function() {
    const map = ITEM_FILE_MAP;
    Object.keys(map).forEach(function(key) {
      const lower = key.trim().toLowerCase();
      if (!map[lower]) {
        map[lower] = map[key];
      }
    });
  })();
} catch (_e) {}
const hawkinsItems = [
    {name:'Bat', file:'bat.png'},
    {name:'Bike', file:'bike.png'},
    {name:'Code Red', file:'code_red.png'},
    {name:'Demogorgon', file:'demogorgon.png'},
    {name:'Dustin Henderson', file:'dustin_henderson.png'},
    {name:'Hawkins Lab', file:'hawkins_lab.png'},
    {name:'Jane 11', file:'jane_11.png'},
    {name:'Jim Hopper', file:'jim_hopper.png'},
    {name:'Lucas Sinclair', file:'lucas_sinclair.png'},
    {name:'Max Mayfield', file:'max_mayfield.png'},
    {name:'Mike Wheeler', file:'mike_wheeler.png'},
    {name:'Nancy Wheeler', file:'nancy_wheeler.png'},
    {name:'Scoops Ahoy', file:'scoops_ahoy.png'},
    {name:'Steve Harrington', file:'steve_harrington.png'},
    {name:'Vecna', file:'vecna.png'},
    {name:'Will Byers', file:'will_byers.png'}
  ];
  function pickHawkinsRarity(){
    const table = [['epic',25],['legendary',10],['unique',4],['mythic',1]];
    const total = table.reduce((s,t)=>s+t[1],0);
    let r = Math.random()*total;
    for(const t of table){ if((r -= t[1]) <= 0) return t[0]; }
    return 'rare';
  }
  function revealStrangerReward(obj){
    try{
      const ov = document.getElementById('strangerReveal');
      if(!ov) return;
      document.getElementById('strangerRevealImg').src = obj.svg;
      document.getElementById('strangerRevealName').textContent = obj.name;
      const rr = document.getElementById('strangerRevealRarity');
      rr.className = 'rar t-'+(String(obj.rarity||'common').toLowerCase());
      rr.textContent = (window.RARITY && RARITY[String(obj.rarity).toLowerCase()] ? RARITY[String(obj.rarity).toLowerCase()].label : String(obj.rarity||'COMMON').toUpperCase());
      ov.classList.add('show');
      setTimeout(()=>{ ov.classList.remove('show'); }, 2400);
    }catch(e){}
  }
  function buyHawkinsPack(){
    try{
      if(state.money < HAWKINS_PACK_COST){ alert('Not enough money.'); return; }
      state.money -= HAWKINS_PACK_COST;
      const it = hawkinsItems[Math.floor(Math.random()*hawkinsItems.length)];
      const rar = pickHawkinsRarity();
      const obj = { uid: uid(), name: it.name, rarity: rar, price:[0,0], baseIdx: Math.floor(Math.random()*9999), svg: 'stranger_things_items/'+it.file };
      state.inventory.push(obj);
      revealStrangerReward(obj);
      if(typeof renderInventory==='function') renderInventory();
      if(typeof recalcEPS==='function') recalcEPS();
      if(typeof save==='function') save();
    }catch(e){ console.error(e); }
  }
  document.getElementById('buyHawkinsPack')?.addEventListener('click', buyHawkinsPack);

  const HAWKINS_BG_COST = 10_000_000_000_000;
  function updateHawkinsStyleUI(){
    try{
      const btn = document.getElementById('buyHawkinsStyle');
      if(!btn) return;
      const owned = !!((state.unlockedBackgrounds||{}).hawkins);
      btn.disabled = owned;
      btn.textContent = owned ? 'Owned' : 'Purchase';
    }catch(e){}
  }
  function buyHawkinsStyle(){
    try{
      if((state.unlockedBackgrounds||{}).hawkins) return;
      if(state.money < HAWKINS_BG_COST){ alert('Not enough money.'); return; }
      state.money -= HAWKINS_BG_COST;
      state.unlockedBackgrounds = state.unlockedBackgrounds || {};
      state.unlockedBackgrounds.hawkins = true;
      ensureHawkinsBgURL(function(){ 
        try{ if(typeof window.__renderBgGrid === 'function') window.__renderBgGrid(); }catch(e){}
        updateHawkinsStyleUI();
        alert('Hawkins background unlocked! Apply it from Backgrounds.');
        if(typeof save==='function') save();
      });
    }catch(e){}
  }
  document.getElementById('buyHawkinsStyle')?.addEventListener('click', buyHawkinsStyle);

  (function extendBgGridForHawkins(){
    const orig = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if(typeof orig === 'function') orig();
      try{
        const g = document.getElementById('bgGrid'); if(!g) return;
        if(!g.querySelector('[data-hawkinsbg]')){
          const el = document.createElement('div');
          el.setAttribute('data-hawkinsbg','1');
          el.className = 'bg-tile' + (!((state.unlockedBackgrounds||{}).hawkins)?' locked':'');
          ensureHawkinsBgURL(function(url){ el.style.cssText = "background:url('"+url+"') center/cover no-repeat;border-color:#5b0f12;"; });
          el.innerHTML = '<div style="font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)">HAWKINS</div><button class="buy bg-apply" '+(!((state.unlockedBackgrounds||{}).hawkins)?'disabled':'')+'>Apply</button>';
          el.querySelector('.bg-apply').onclick = function(){
            if(!((state.unlockedBackgrounds||{}).hawkins)) return;
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-rainbow','bg-spaceview','bg-dodger','redblue','bg-crypto','bg-dodgerquests');
            document.body.classList.add('bg-hawkins');
            state.selectedBackground = 'hawkins';
            if(typeof save==='function') save();
          };
          g.appendChild(el);
        }else{
          const el = g.querySelector('[data-hawkinsbg]');
          el.classList.toggle('locked', !((state.unlockedBackgrounds||{}).hawkins));
          const btn = el.querySelector('.bg-apply'); if(btn) btn.disabled = !((state.unlockedBackgrounds||{}).hawkins);
        }
      }catch(e){}
    };
  })();

  // Demoegg chances
  try{ window.EGG_COSTS = window.EGG_COSTS || {}; EGG_COSTS.demoegg = 3_000_000_000; }catch(e){}
  try{
    window.PET_TABLES = window.PET_TABLES || {};
    PET_TABLES.demoegg = [
      { name:'Dart',    chance:0.68, eps:25000 },
      { name:'Demobat', chance:0.30, eps:45000 },
      { name:'Demodog', chance:0.02, eps:65000 }
    ];
  }catch(e){}

  (function extendPetArt(){
    const g = window.getPetSvg;
    window.getPetSvg = function(petName, seed){
      const map = { "Dart":"dart.png", "Demobat":"demobat.png", "Demodog":"demodog.png" };
      if(map[petName]) return 'pets/'+map[petName];
      return typeof g === 'function' ? g(petName, seed) : ('pets/unknown.png');
    };
  })();

  document.getElementById('buyDemoEgg')?.addEventListener('click', function(){
    try{ if(typeof buyEgg === 'function') buyEgg('demoegg'); else alert('Egg shop not available here.'); }catch(e){}
  });

  (function demodogMorphLoop(){
    window.state = window.state || {};
    state.demonTimers = state.demonTimers || {};
    function step(){
      try{
        (state.petStands||[]).forEach((ps, idx)=>{
          if(!ps || (ps.petType!=='Demodog')){ delete state.demonTimers[idx]; return; }
          const now = Date.now();
          if(!state.demonTimers[idx]){
            state.demonTimers[idx] = now + 20*60*1000;
          }else if(now >= state.demonTimers[idx]){
            state.demonTimers[idx] = now + 20*60*1000;
            if(Math.random() < 0.50){
              const placedIds = (state.stands||[]).filter(Boolean);
              if(placedIds.length){
                const uidPick = placedIds[Math.floor(Math.random()*placedIds.length)];
                const it = state.placed[uidPick];
                if(it){
                  it.demon = true;
                  if(typeof renderStands==='function') renderStands();
                  if(typeof recalcEPS==='function') recalcEPS();
                  if(typeof save==='function') save();
                }
              }
            }
          }
        });
      }catch(e){}
      setTimeout(step, 1000);
    }
    setTimeout(step, 1500);
  })();

  (function hookDemonUI(){
    const orig = window.renderStands;
    window.renderStands = function(){
      if(typeof orig === 'function') orig.apply(this, arguments);
      try{
        const standEls = Array.from(document.querySelectorAll('.stands .stand'));
        (state.stands||[]).forEach((uid, i)=>{
          if(!uid) return;
          const it = state.placed[uid]; if(!it) return;
          const host = standEls[i]; if(!host) return;
          const p = host.querySelector('.placed'); if(!p) return;
          if(it.demon){
            p.classList.add('demonized');
            if(!p.querySelector('.rar.t-demon')){
              const s = document.createElement('span');
              s.className='rar t-demon';
              s.textContent='DEMON';
              const container = p.querySelector('div') || p;
              container.appendChild(s);
            }
          }else{
            p.classList.remove('demonized');
            const b = p.querySelector('.rar.t-demon'); if(b) b.remove();
          }
        });
      }catch(e){}
    };
    setTimeout(()=>{ try{ renderStands(); }catch(e){} }, 0);
  })();

  (function patchEPS(){
    const orig = window.recalcEPS;
    window.recalcEPS = function(){
      if(typeof orig === 'function') orig.apply(this, arguments);
      try{
        const extra = Object.values(state.placed||{}).reduce((s,it)=> s + (it&&it.demon ? 15000 : 0), 0);
        state.eps = Math.floor((state.eps||0) + extra);
        const el=document.getElementById('eps'); if(el){ el.textContent = '+ $' + ((state.eps||0).toLocaleString(undefined,{maximumFractionDigits:0})) + ' / sec'; }
      }catch(e){}
    };
  })();

  document.addEventListener('DOMContentLoaded', ()=> { ensureEventButton(); setStrangerEventIcon(); });
  new MutationObserver(()=> ensureEventButton()).observe(document.body, {childList:true, subtree:true});
})();
</script>


<!-- ===== Stranger Things: Hawkins Pack + Demon Potion update (v109) ===== -->
<style>
  /* More complex demon morph animation */
  .demonized{
    position: relative;
    animation: demonBeat 1.1s infinite ease-in-out, demonShake 3s infinite ease-in-out;
    filter: drop-shadow(0 0 6px rgba(255,0,0,.35)) drop-shadow(0 0 16px rgba(255,0,0,.22));
  }
  .demonized::before, .demonized::after{
    content:"";
    position:absolute;
    inset:-6px;
    border-radius:16px;
    pointer-events:none;
  }
  /* swirling red mist */
  .demonized::before{
    background: radial-gradient(60% 60% at 50% 45%, rgba(255,0,0,.28), transparent 60%);
    mix-blend-mode: screen;
    animation: demonMist 2.6s infinite ease-in-out;
  }
  /* crawling runes */
  .demonized::after{
    background: conic-gradient(from 0deg, rgba(255,80,80,.22), transparent 35%, rgba(255,0,0,.18), transparent 60%);
    -webkit-mask: radial-gradient(70% 70% at 50% 50%, transparent 58%, #000 60%);
    mask: radial-gradient(70% 70% at 50% 50%, transparent 58%, #000 60%);
    animation: demonRunes 4s linear infinite;
    filter: blur(1px);
  }
  @keyframes demonBeat{
    0%{ transform:translateY(0) scale(1); box-shadow:0 0 0 0 rgba(255,0,0,.35); }
    50%{ transform:translateY(-2px) scale(1.06); box-shadow:0 0 28px 14px rgba(255,0,0,.18); }
    100%{ transform:translateY(0) scale(1); box-shadow:0 0 0 0 rgba(255,0,0,.35); }
  }
  @keyframes demonShake{
    0%{ transform: translateX(0) rotate(0); }
    25%{ transform: translateX(0.6px) rotate(-0.2deg); }
    50%{ transform: translateX(0) rotate(0); }
    75%{ transform: translateX(-0.6px) rotate(0.2deg); }
    100%{ transform: translateX(0) rotate(0); }
  }
  @keyframes demonMist{
    0%{ opacity:.15; transform: scale(1); }
    50%{ opacity:.38; transform: scale(1.06); }
    100%{ opacity:.15; transform: scale(1); }
  }
  @keyframes demonRunes{
    to{ transform: rotate(360deg); }
  }

  /* Potion targeting mode: blur everything except pedestals and placed items */
  body.potion-targeting *:not(.stands):not(.stands *):not(#potionUseBtn){
    filter: blur(4px) brightness(.8);
    pointer-events: none !important;
    user-select: none !important;
  }
  body.potion-targeting .stands, 
  body.potion-targeting .stands *{
    filter: none !important;
    pointer-events: auto;
  }
  #potionUseBtn{
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: 180px; /* just above the bottom inventory bar */
    z-index: 99;
    padding: 8px 14px;
    border-radius: 12px;
    border: none;
    font-weight: 900;
    cursor: pointer;
    background: linear-gradient(180deg,#ff3b3b,#ff9a9a);
    color:#200;
    box-shadow: 0 8px 24px rgba(255,0,0,.35);
    display:none;
  }
  #potionCancel{
    position: fixed;
    left: calc(50% + 120px);
    transform: translateX(-50%);
    bottom: 180px;
    z-index: 99;
    padding: 8px 12px;
    border-radius: 12px;
    background:#333; color:#fff; border:none; font-weight:800; display:none;
    box-shadow: 0 6px 18px rgba(0,0,0,.35);
  }
</style>
<script>
(function(){
  window.state = window.state || {};

  // ==== Override Hawkins pack probabilities and add Demon Potion outcome ====
  function __pickHawkinsOutcome(){
    // base weights (keep existing epic/legendary), change unique/mythic, add crypto and potion
    const table = [
      {type:'rarity', key:'epic',      w:25},
      {type:'rarity', key:'legendary', w:10},
      {type:'rarity', key:'unique',    w:6},
      {type:'rarity', key:'mythic',    w:3},
      {type:'rarity', key:'crypto',    w:1},
      {type:'potion', key:'demon',     w:0.5}
    ];
    const total = table.reduce((s,t)=>s+t.w,0);
    let r = Math.random()*total;
    for(const t of table){ r -= t.w; if(r <= 0) return t; }
    return table[0];
  }

  // Replace buyHawkinsPack to honor the new table + potion drop
  (function overrideBuy(){
    const orig = window.buyHawkinsPack;
    const items = (function(){
      // try to access defined list
      try{ return (window.hawkinsItems || []).slice(); }catch(e){ return []; }
    })();
    window.buyHawkinsPack = function(){
      try{
        const cost = (typeof HAWKINS_PACK_COST!=='undefined' ? HAWKINS_PACK_COST : 2000000000);
        if(state.money < cost){ alert('Not enough money.'); return; }
        state.money -= cost;

        const outcome = __pickHawkinsOutcome();
        if(outcome.type === 'potion'){
          const obj = {
            uid: uid(),
            name: 'Demon Potion',
            // no rarity per request
            potionType: 'demon',
            isDemonPotion: true,
            price:[0,0],
            baseIdx: Math.floor(Math.random()*9999),
            svg: 'icons/demon_potion.png'
          };
          state.inventory.push(obj);
          // Reveal: show name + custom label
          try{
            const rr = { name: obj.name, svg: obj.svg, rarity: 'common' };
            if(typeof revealStrangerReward==='function') revealStrangerReward(rr);
          }catch(e){}
        }else{
          // normal item roll with requested rarity
          const list = items.length ? items : [
            {name:'Bat', file:'bat.png'},
            {name:'Bike', file:'bike.png'}
          ];
          const it = list[Math.floor(Math.random()*list.length)];
          const rar = outcome.key; // epic/legendary/unique/mythic/crypto
          const obj = { uid: uid(), name: it.name, rarity: rar, price:[0,0], baseIdx: Math.floor(Math.random()*9999), svg: 'stranger_things_items/'+it.file };
          state.inventory.push(obj);
          try{ if(typeof revealStrangerReward==='function') revealStrangerReward(obj); }catch(e){}
        }

        if(typeof renderInventory==='function') renderInventory();
        if(typeof recalcEPS==='function') recalcEPS();
        if(typeof save==='function') save();
      }catch(e){ console.error(e); }
    };
  })();

  // ==== "Use Potion" flow ====
  function getInventoryEl(){
    return document.querySelector('.inventory') ||
           document.querySelector('#inventory') ||
           document.querySelector('.inventory-wrap');
  }

  function currentSelection(){
    const uidSel = state.selectedItemUid;
    if(!uidSel) return null;
    return (state.inventory||[]).find(x=>x && x.uid===uidSel) || null;
  }

  function ensurePotionButtons(){
    let use = document.getElementById('potionUseBtn');
    if(!use){
      use = document.createElement('button');
      use.id = 'potionUseBtn';
      use.textContent = 'Use Potion';
      document.body.appendChild(use);
      use.addEventListener('click', beginTargeting);
    }
    let cancel = document.getElementById('potionCancel');
    if(!cancel){
      cancel = document.createElement('button');
      cancel.id = 'potionCancel';
      cancel.textContent = 'Cancel';
      document.body.appendChild(cancel);
      cancel.addEventListener('click', endTargeting);
    }

    // toggle visibility based on selection
    const sel = currentSelection();
    const show = !!(sel && sel.isDemonPotion);
    use.style.display = show ? 'inline-block' : 'none';
    cancel.style.display = (show && document.body.classList.contains('potion-targeting')) ? 'inline-block' : 'none';
    try{
      // place just above inventory
      const inv = getInventoryEl();
      if(inv){
        const r = inv.getBoundingClientRect();
        use.style.bottom = (window.innerHeight - r.top + 8) + 'px';
        cancel.style.bottom = use.style.bottom;
      }
    }catch(e){}
  }

  function beginTargeting(){
    if(document.body.classList.contains('potion-targeting')) return;
    const sel = currentSelection();
    if(!sel || !sel.isDemonPotion) return;
    document.body.classList.add('potion-targeting');
    ensurePotionButtons(); // show Cancel

    // one-shot handler: click a placed item to apply
    const handler = function(ev){
      const placed = ev.target.closest && ev.target.closest('.stands .placed');
      if(!placed) return;
      // find which stand index
      const all = Array.from(document.querySelectorAll('.stands .stand .placed'));
      const idx = all.indexOf(placed);
      if(idx === -1) return;
      // resolve the corresponding UID from state.stands by matching element order
      const standBoxes = Array.from(document.querySelectorAll('.stands .stand'));
      const standIndex = standBoxes.findIndex(b => b.querySelector('.placed') === placed);
      const uid = (state.stands||[])[standIndex];
      const it = (state.placed||{})[uid];
      if(!it){ endTargeting(); return; }

      // consume potion
      const invIdx = (state.inventory||[]).findIndex(x=>x && x.uid === state.selectedItemUid);
      if(invIdx !== -1){ state.inventory.splice(invIdx,1); }

      // apply demon morph
      it.demon = true;

      // visuals: quick burst
      try{
        placed.classList.add('demonized');
        const burst = document.createElement('div');
        burst.style.cssText = 'position:absolute;inset:-8px;border-radius:18px;pointer-events:none;background:radial-gradient(40% 40% at 50% 50%, rgba(255,0,0,.35), transparent 60%);animation:demonMist .9s ease-out;';
        placed.appendChild(burst);
        setTimeout(()=> burst.remove(), 900);
      }catch(e){}

      // clear selection and finish
      state.selectedItemUid = null;
      if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
      if(typeof renderStands==='function') try{ renderStands(); }catch(e){}
      if(typeof recalcEPS==='function') try{ recalcEPS(); }catch(e){}
      if(typeof save==='function') try{ save(); }catch(e){}

      endTargeting();
    };

    // register temporary listeners on the stands container
    document.addEventListener('click', handler, true);
    // store for cleanup
    window.__potionHandler = handler;
  }

  function endTargeting(){
    document.body.classList.remove('potion-targeting');
    if(window.__potionHandler){
      document.removeEventListener('click', window.__potionHandler, true);
      window.__potionHandler = null;
    }
    ensurePotionButtons();
  }

  // keep the Use Potion visibility in sync with inventory renders
  const __ri = window.renderInventory;
  if(typeof __ri === 'function'){
    window.renderInventory = function(){
      try{ __ri.apply(this, arguments); }finally{ ensurePotionButtons(); }
    };
  } else {
    document.addEventListener('DOMContentLoaded', ensurePotionButtons);
  }
  // also reflow button positions on resize
  window.addEventListener('resize', ensurePotionButtons);
})();
</script>
<!-- ===== end v109 update ===== -->

<!-- Added script to fix the nonâ€‘functional Log Out button
     When the player clicks the button they are prompted for confirmation.
     If they confirm, the user ID and any pending login state are removed
     from storage and the page is reloaded so the login menu appears.
     This runs after the main game logic to ensure the button exists. -->
<script>
  // Immediately attach a click handler to the Log Out button.  This script runs
  // after the DOM has been parsed so the button should already exist.  We avoid
  // waiting on the DOMContentLoaded event because it may have already fired by
  // the time this script executes.
  (function() {
    const logoutBtn = document.getElementById('resetUserBtn');
    if (!logoutBtn) return;
    logoutBtn.addEventListener('click', function(ev) {
      // Stop other listeners from triggering unintended behaviors (e.g. new account prompt)
      ev.stopPropagation();
      ev.preventDefault();
      // Confirm the user's intention to log out
      if (confirm('Do you really want to log out?')) {
        try {
          localStorage.removeItem('flex-userid');
          localStorage.removeItem('flex_login_pending');
          sessionStorage.removeItem('flex-userid-just-set');
        } catch (e) {
          /* ignore storage errors */
        }
        // Clear the inâ€‘memory user ID if it exists
        try { window.USER_ID = null; } catch (e) {}
        // Reload to show the login menu; replace() avoids creating a new history entry
        window.location.replace(window.location.href);
      }
    }, true);
  })();
</script>

</body>
</html>