<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flex â€” Shop & Flex Game (Inventory at Bottom)</title>
<link href="https://fonts.googleapis.com/css2?family=Bungee:wght@400&family=Russo+One&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
<style>
:root{
  --ui-blue:#59a7ff;
  --ui-blue-dark:#2973e3;
  --ink:#0a0f1a;
  --panel:#3a3a42;
  --panel-2:#2b2b31;
  --slot:#9aa0a6;
  --success:#2ecc71;
  --danger:#e74c3c;
  --gold:#ffb200;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --radius:28px;
  --c-common:#6dff79;
  --c-rare:#4cc4ff;
  --c-epic:#b66bff;
  --c-legendary:#ffd84a;
  --c-legacy:#ffffff;
  --c-mythic:#ffd700;
}

/* page / backdrop */
html,body{ height:100%; margin:0; background: linear-gradient(to bottom, #89CFF0 0%, #90EE90 100%); overscroll-behavior:none; color:#fff; font-family:"Rajdhani", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; user-select:none; }
body::before{
  content:"";
  position:fixed;
  inset:0;
  background-image: linear-gradient(0deg, rgba(0,0,0,.06), rgba(255,255,255,.06)), repeating-linear-gradient(45deg, #1aa69e 0 12px, #1ca3d8 12px 24px, #1f7fb8 24px 36px), repeating-linear-gradient(-45deg, #1dc79d 0 12px, #1ea9d0 12px 24px, #2b6ab8 24px 36px);
  filter:contrast(115%) saturate(120%);
  image-rendering:pixelated;
  background-size: 100% 100%, 24px 24px, 24px 24px;
  mix-blend-mode: normal;
  z-index:-2;
}
body::after{
  content:"";
  position:fixed;
  inset:0;
  z-index:-1;
  background:linear-gradient(90deg, rgba(255,255,255,.05), rgba(0,0,0,.05));
  image-rendering: pixelated;
  background-size: 8px 8px;
  opacity:.45;
}
/* ðŸ”´ðŸ”µ Red/Blue override */
body.redblue::before {
  content: "";
  position: fixed;
  inset: 0;
  z-index: -2;
  background: linear-gradient(to bottom, #ff4b5c 0%, #4b6aff 100%) !important;
}

body.redblue::after {
  content: "";
  position: fixed;
  inset: 0;
  z-index: -1;
  background: none !important;
}



/* game container */
.game{
  position:relative;
  min-height:100%;
  padding:20px;
  /* make space at bottom so fixed inventory doesn't overlap other content */
  padding-bottom:220px;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  gap:24px;
}

/* topbar */
.cash{
  font-family:"Bungee", sans-serif;
  font-size: clamp(28px, 5vw, 54px);
  background: var(--ui-blue);
  color:#000;
  border:6px solid #0e2a4c;
  border-radius: 28px;
  padding: 6px 28px 8px;
  box-shadow: var(--shadow);
  letter-spacing:2px;
  text-shadow: 0 2px 0 rgba(255,255,255,.35);
}
.topbar{ display:flex; gap:14px; align-items:center; justify-content:center; flex-wrap:wrap; }
.eps{ padding:6px 12px; border-radius:12px; background:rgba(0,0,0,.35); font-weight:800; }

/* left rail */
.left-rail{
  position:fixed;
  left:16px;
  top:120px;
  display:flex;
  flex-direction:column;
  gap:16px;
  z-index:7;
}
.icon-btn{
  width:96px;
  height:96px;
  border-radius:20px;
  display:grid;
  place-items:center;
  cursor:pointer;
  box-shadow:var(--shadow);
  border:4px solid rgba(0,0,0,.4);
}
.icon-shop{ background:#57d85a; }
.icon-tools{ background:#8c8f95; }
.icon-music{ background: linear-gradient(45deg,#ffd86a,#ff7ac7); }
.icon-pets{ background: #ffb6e6; } /* paw button style */
.icon-btn svg{ width:64%; height:64%; }

/* stands / pedestals area (keeps visually centered above inventory) */
.stands{
  margin-top:24px;
  margin-bottom:12px; /* small gap before the visual area above the inventory */
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:40px;
  width:min(100%,1000px);
  z-index:3;
}
.stand{
  position:relative;
  /* taller so pedestals sit well above the bottom inventory bar */
  height:160px;
  display:flex;
  align-items:flex-end;
  justify-content:center;
}
.pedestal{
  width: 200px;
  height: 48px;
  background: linear-gradient(#ffda66, #f0a800);
  border-radius: 12px;
  box-shadow: inset 0 6px 0 rgba(255,255,255,.35), 0 10px 0 #bb7a00, 0 14px 18px rgba(0,0,0,.4);
}
.placed{
  position:absolute;
  /* position above pedestal; increased so it reads nicely above the bottom inventory */
  bottom:110px;
  display:flex;
  align-items:center;
  justify-content:center;
  width:160px;
  height:80px;
  border-radius:16px;
  background:rgba(0,0,0,.18);
  backdrop-filter: blur(1px);
  outline:4px solid rgba(0,0,0,.35);
  transition:transform .15s ease, box-shadow .2s;
  z-index:4;
}
.placed:hover{ transform:translateY(-3px) scale(1.02); }
.placed.glow{ box-shadow:0 8px 30px rgba(255,220,120,.9); transform:translateY(-6px) scale(1.06); }

/* PET ROW */
.pet-row{
  margin-top:8px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:40px;
  width:min(100%,1000px);
  z-index:3;
}
.pet-stand{
  position:relative;
  height:120px;
  display:flex;
  align-items:flex-end;
  justify-content:center;
}
.pet-pedestal{
  width: 140px;
  height: 40px;
  background: linear-gradient(#c3c3c3, #8e8e8e);
  border-radius: 10px;
  box-shadow: inset 0 4px 0 rgba(255,255,255,.35), 0 6px 0 rgba(0,0,0,.25);
}
.pet-placed{
  position:absolute;
  bottom:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  width:120px;
  height:64px;
  border-radius:12px;
  background:rgba(0,0,0,.14);
  outline:3px solid rgba(0,0,0,.35);
  z-index:4;
}
.pet-placed img{ width:56px; height:56px; border-radius:8px; margin-right:6px; }

/* timer badge on pet placed */
.pet-timer{
  position:absolute;
  bottom:58px;
  left:6px;
  font-size:12px;
  padding:4px 8px;
  border-radius:10px;
  background:rgba(0,0,0,.6);
  color:#fff;
  z-index:6;
}

/* === INVENTORY FIXED TO BOTTOM (MAIN CHANGES) === */
.inventory-wrap{
  /* make the inventory a fixed bottom bar centered horizontally */
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:18px;
  width: min(1100px, 96%);
  z-index:8;
  display:flex;
  justify-content:center;
  pointer-events:auto;
}

/* inventory container styled to match the concept art: big rounded rectangle with thick outline */
.inventory{
  display:flex;
  gap:16px;
  overflow-x:auto;
  padding:20px;
  background: linear-gradient(180deg, #d0d2d6, #a9adaf); /* subtle metallic grey like the concept */
  border-radius:28px;
  box-shadow: 0 18px 50px rgba(0,0,0,.6), var(--shadow);
  border:8px solid #111; /* thick dark outline similar to concept */
  align-items:center;
  /* ensure the inventory bar doesn't shrink too small on tiny screens */
  min-width: 320px;
}

/* larger slot sizes to match concept visuals */
.slot{
  min-width:140px;
  height:112px;
  background: #b4b8bd;
  border-radius:20px;
  display:grid;
  place-items:center;
  color:#111;
  font-weight:700;
  border:6px solid #262a2f;
  position:relative;
  cursor:pointer;
  flex: 0 0 auto;
  box-shadow: 0 6px 18px rgba(0,0,0,.35) inset;
}
.slot.selected{ outline:6px solid var(--ui-blue);}
.slot .rar{
  position:absolute;
  right:8px;
  bottom:8px;
  font-size:12px;
  padding:3px 8px;
  border-radius:12px;
  background:rgba(0,0,0,.4);
  color:#fff;
}
.slot img{ width:72px; height:72px; border-radius:10px; }

/* === Pet image size upgrade === */
.slot.is-pet { height: 132px; }
.slot.is-pet img { width: 96px; height: 96px; }

.pet-stand { height: 150px; }
.pet-placed { height: 80px; }
.pet-placed img { width: 72px; height: 72px; border-radius: 10px; }


/* shop overlay and other UI left mostly unchanged */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}
.overlay.show{ display:flex; }
.shop{
  width:min(1000px, 92%);
  background:#4a4a52;
  border-radius:30px;
  border:6px solid #212127;
  box-shadow:var(--shadow);
  padding:24px;
  position:relative;
  color:#e8e8ee;
}
.shop h2{ text-align:center; margin:0 0 18px 0; font-family:"Russo One"; font-size:42px; letter-spacing:1px; color:#8aff8f; text-shadow:0 2px 0 #0f0f0f; }
.refresh-note{ text-align:center; font-weight:700; opacity:.85; margin-top:10px; }
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }
.card{ background:#33333b; border-radius:22px; border:4px solid #1a1a1f; padding:18px; display:flex; flex-direction:column; gap:8px; justify-content:space-between; min-height:160px; }
.card h3{ margin:0; font-size:30px; font-family:"Russo One"; letter-spacing:1px; color:#d7d9dd; }
.tag{ font-size:26px; font-family:"Bungee"; letter-spacing:1px; -webkit-text-stroke:2px #000; color:transparent; filter:drop-shadow(0 2px 0 rgba(0,0,0,.5)); }
.t-common{ color:var(--c-common); }
.t-rare{ color:var(--c-rare); }
.t-epic{ color:var(--c-epic); }
.t-legendary{ color:var(--c-legendary); }
.t-birthday {
  background: linear-gradient(90deg, #ff62d5, #ffd700, #ff62d5);
  background-size: 200% auto;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  animation: birthdayAnim 1.2s linear infinite;
  font-weight:900;
}
@keyframes birthdayAnim {
  0% { background-position: 0% 50%; letter-spacing: 2px; }
  50% { background-position: 100% 50%; letter-spacing: 6px; }
  100% { background-position: 0% 50%; letter-spacing: 2px; }
}
.t-legacy{
  background: linear-gradient(90deg, #ff004c, #ff7a00, #ffd400, #18e300, #00e7ff, #3a31ff, #ff31ff, #ff004c);
  background-size: 400% 100%;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  animation: rainbowShift 4s linear infinite;
}
.t-mythic{
  background: linear-gradient(90deg, #ffd700, #fff8b0, #ffcc00);
  background-size: 200% auto;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  animation: goldShimmer 2.5s linear infinite;
  font-weight:900;
}

.t-unique {
  color: navy;
  text-shadow: 0 0 6px rgba(0,0,128,.6);
  animation: uniqueSparkle 2s linear infinite;
}
@keyframes uniqueSparkle {
  0%,100% { text-shadow: 0 0 6px rgba(255,255,255,.2); }
  50%     { text-shadow: 0 0 10px rgba(255,255,255,.7); }
}

.t-exotic {
  color: cyan;
  text-shadow: 0 0 8px rgba(0,255,255,.7);
  animation: exoticPulse 2.5s ease-in-out infinite;
}
@keyframes exoticPulse {
  0%,100% { text-shadow: 0 0 8px rgba(0,255,255,.3); }
  50%     { text-shadow: 0 0 16px rgba(0,255,255,1); }
}

/* apply on the <p> wrapper holding the item image */
.glow-exotic {
  filter: drop-shadow(0 0 8px rgba(0,255,255,.8))
          drop-shadow(0 0 16px rgba(0,255,255,.5));
}


.t-unique {
  color: navy;
  position: relative;
  text-shadow: 0 0 3px rgba(255,255,255,0.3);
}

/* Sparkle effect overlay */
.t-unique::after {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  width: calc(100% + 4px);
  height: calc(100% + 4px);
  pointer-events: none;
  background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,0.5) 50%, transparent 100%);
  background-size: 200% 100%;
  animation: uniqueSparkle 2.5s linear infinite;
  mix-blend-mode: screen;
  border-radius: 4px;
}

@keyframes uniqueSparkle {
  0%   { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}


@keyframes rainbowShift{ 0%{ background-position: 0% 50%; } 100%{ background-position: 100% 50%; } }
@keyframes goldShimmer{ 0%{ background-position: 0% 50%; } 100%{ background-position: 200% 50%; } }

.price{ font-weight:900; font-size:22px; }
.buy{ align-self:flex-end; padding:10px 16px; font-weight:900; border:none; border-radius:14px; cursor:pointer; background:linear-gradient(var(--ui-blue), var(--ui-blue-dark)); color:#fff; box-shadow:var(--shadow); }
.buy:disabled{ filter:grayscale(1) brightness(.7); cursor:not-allowed; }
.closeX{ position:absolute; right:12px; top:8px; font-size:28px; background:#222; color:#fff; border:none; border-radius:14px; width:44px; height:44px; cursor:pointer; }

/* forge button */
#forgeBtn{
  margin-top:6px;
  padding:10px 18px;
  border-radius:14px;
  background: linear-gradient(45deg, #ffd86a, #ffb200);
  border:4px solid rgba(0,0,0,.35);
  color:#000;
  font-weight:900;
  box-shadow: 0 8px 30px rgba(255,200,60,0.18);
  cursor:pointer;
  display:none;
}

/* responsive tweaks */
@media (max-width:800px){
  .stands{ gap:22px; }
  .pedestal{ width:150px;}
  .placed{ width:130px; bottom:90px; }
  .icon-btn{ width:76px; height:76px; }
  .slot{ min-width:100px; height:88px; }
  .inventory{ padding:12px; gap:8px; border-radius:18px; }
  .inventory-wrap{ bottom:12px; width: calc(100% - 30px); }
}

/* ðŸ”´ðŸ”µ Full background override for red/blue mode */
body.redblue {
  background: linear-gradient(to bottom, #ff4b5c 0%, #4b6aff 100%) !important;
}

body.redblue::before,
body.redblue::after {
  display: none !important; /* turn off the original pseudo-element layers */
}



/* === Add-on: Achievements + Background Selector === */
.right-rail{position:fixed;right:16px;top:180px;display:flex;flex-direction:column;gap:16px;z-index:8;}
.icon-achievements,.bg-selector-btn{width:76px;height:76px;border-radius:20px;display:grid;place-items:center;cursor:pointer;box-shadow:var(--shadow);border:4px solid rgba(0,0,0,.4);}
.icon-achievements{background:#ffd24a;}
.bg-selector-btn{position:fixed;right:120px;bottom:24px;z-index:9;background:linear-gradient(45deg,#222,#444);}
.icon-achievements svg,.bg-selector-btn svg{width:60%;height:60%;}

.sheet{width:min(1024px,94%);background:#4a4a52;border-radius:30px;border:6px solid #212127;box-shadow:var(--shadow);padding:24px;color:#e8e8ee;position:relative;}
.sheet h2{margin:0 0 18px;font-family:"Russo One";font-size:42px;letter-spacing:1px;text-align:center;}

.rarity-rail{width:220px;background:#25252b;border-radius:24px;border:4px solid #111;padding:16px;display:flex;flex-direction:column;gap:8px;align-self:flex-start;}
.achv-wrap{display:grid;grid-template-columns:220px 1fr;gap:18px;}
.rail-btn{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:14px;background:#33333b;border:2px solid #1a1a1f;font-weight:800;cursor:pointer;}
.rail-btn.active{outline:3px solid var(--ui-blue);}
.badge-dot{width:10px;height:10px;border-radius:999px;background:#666;}
.badge-dot.done{background:#58e36c;}

.quest-card{background:#33333b;border-radius:22px;border:4px solid #1a1a1f;padding:18px;display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:14px;}
.quest-card .q-left{display:flex;align-items:center;gap:12px;}
.q-check{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;border:2px solid #111;background:#555;font-weight:900;}
.q-check.ok{background:#58e36c;color:#111;}
.reward-pill{padding:6px 10px;border-radius:12px;background:#ffb200;color:#000;font-weight:900;}

.bg-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;}
.bg-tile{height:120px;border-radius:18px;border:4px solid #111;display:flex;flex-direction:column;justify-content:flex-end;padding:12px;box-shadow:var(--shadow);position:relative;overflow:hidden;}
.bg-tile.locked::after{content:"LOCKED";position:absolute;inset:auto 0 0 0;background:rgba(0,0,0,.55);color:#fff;text-align:center;padding:6px 0;font-weight:900;}
.bg-apply{align-self:flex-end;margin-top:6px;}

body.bg-green{background:linear-gradient(to bottom,#3edc64,#1e6f2b)!important;}
body.bg-blue{background:linear-gradient(to bottom,#4aa3ff,#0b2e6e)!important;}
body.bg-purple{background:linear-gradient(to bottom,#a76bff,#ff72c6)!important;}
body.bg-orange{background:linear-gradient(to bottom,#ff9b3d,#b98200)!important;}
body.bg-legacy{background:linear-gradient(135deg,#ff7eb3,#ff2a68)!important;}
body.bg-unique{background:linear-gradient(135deg,#0a1a4b,#123a8c)!important;}
body.bg-exotic{background:linear-gradient(135deg,#cfefff,#a0a9b8)!important;}
body.bg-mythic{background:linear-gradient(135deg,#FFD700,#B8860B)!important;}
body.bg-rainbow{background:linear-gradient(135deg,#ff004c,#ff7a00,#ffd400,#18e300,#00e7ff,#3a31ff,#ff31ff);background-size:400% 400%;animation:rainbowFlow 14s linear infinite;}
@keyframes rainbowFlow{0%{background-position:0% 50%}100%{background-position:100% 50%}}


/* Deletion mode */
body.deleting .slot .del-x { display:block !important; }
.slot .del-x,
.pet-placed .del-x {
  display:none; position:absolute; right:-8px; top:-8px; width:26px; height:26px; border-radius:50%;
  background:#ff3b30; color:#fff; font-weight:900; box-shadow:0 2px 6px rgba(0,0,0,.4);
  border:2px solid #111; cursor:pointer; display:grid; place-items:center; z-index:3;
}
.slot { position:relative; }
/* Trash toggle visual state */
#deleteToggleBtn svg{filter:none;opacity:.95;}
#deleteToggleBtn.active svg{filter:drop-shadow(0 0 6px rgba(255,59,48,.6));stroke:#ff3b30;}


/* === Achievements overlay: size, scroll, and no-overlap (final) === */
#achOverlay .sheet{
  max-height: min(90vh, 820px);
  display: flex;
  flex-direction: column;
  overflow: hidden; /* keeps the sheet capped; inner area will scroll */
}

#achOverlay .achv-wrap{
  /* scrollable inner area */
  flex: 1 1 auto;
  min-height: 0;
  overflow: auto;

  /* lock the two columns so they don't overlap */
  display: grid !important;
  grid-template-columns: 220px minmax(0, 1fr) !important;
  gap: 16px;
  align-items: start;
}

#achOverlay .rarity-rail{
  grid-column: 1;
  width: 220px; min-width: 220px; max-width: 220px;
  position: sticky; top: 0;      /* rail stays visible while the right side scrolls */
  z-index: 1;
  float: none;                   /* neutralize any stray float rules */
}

#achOverlay #achContent{
  grid-column: 2;
  min-width: 0;                  /* CRITICAL: lets content shrink within its grid track */
}

/* safety so children don't force overflow */
#achOverlay .achv-wrap > *{
  min-width: 0;
  box-sizing: border-box;
}

/* Right-side vertical list under Achievements */
.right-rail{
  position: fixed;
  right: 16px;
  top: 180px;
  display: flex;
  flex-direction: column;  /* vertical list */
  gap: 16px;
  z-index: 8;
}

/* Use the rail footprint; ignore any old fixed/inset styles */
.right-rail #openBgSelector,
.right-rail #deleteToggleBtn{
  position: static !important;
  inset: auto !important;
  width: 76px; height: 76px;   /* same size as Achievements */
  margin: 0;
  display: grid; place-items: center;
}

/* Ensure the delete button is icon-only (no button background/border) */
#deleteToggleBtn.delete-toggle-btn{
  background: none !important;
  border: none !important;
  box-shadow: none !important;
}



/* === Red Money (top money banner override) === */
body.money-red .cash{
  background: linear-gradient(#ff4b5c, #8b0000) !important;
  border-color: #3a0a0a !important;
}

/* === Pet Shop: make overlay scrollable & keep the X reachable === */
#petOverlay{
  overflow: auto;
  padding: 24px 12px; /* breathing room so the dialog isn't flush to edges while scrolling */
}
#petOverlay .shop{
  max-height: min(92dvh, 840px); /* cap height so content fits on small screens */
  overflow: auto;                /* allow inner scrolling */
}
/* Keep the close button reachable while scrolling the Pet Shop */
/* Pet Shop close button: like before (absolute); reach it by scrolling to the top */
#petOverlay .shop .closeX{
  position: absolute;
  top: 8px;
  right: 12px;
  margin-left: 0;
  z-index: 20;
}
@media (max-width: 800px){
  #petOverlay .shop{ max-height: min(92dvh, 740px); }
}

</style>

<style>
/* === Cosmic Event (Limited Time) === */
.icon-cosmic{ background: radial-gradient(circle at 30% 30%, #1a2a6c, #000428); position:relative; }
.icon-cosmic::after{
  content:""; position:absolute; inset:0; border-radius:20px; pointer-events:none;
  background: radial-gradient(2px 2px at 25% 35%, #ffd84a 0 60%, transparent 60%),
              radial-gradient(2.5px 2.5px at 68% 22%, #8fd3ff 0 60%, transparent 60%),
              radial-gradient(1.6px 1.6px at 70% 64%, #ffd84a 0 60%, transparent 60%),
              radial-gradient(1.8px 1.8px at 44% 76%, #8fd3ff 0 60%, transparent 60%);
  animation: cosmicBtnSparkle 3.5s linear infinite;
}
@keyframes cosmicBtnSparkle {
  0% { opacity: .7; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.02); }
  100% { opacity: .7; transform: scale(1); }
}

/* Event Sheet */
#cosmicOverlay .sheet{ background: radial-gradient(1200px 600px at 50% -200px, #0b1a35, #151823) #151823;
  color:#e6f3ff; border-color:#0b0f1a; }
#cosmicOverlay h2{ color:#7fd0ff; text-shadow:0 2px 0 rgba(0,0,0,.6); }
.cosmic-grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }
.cosmic-card{ background:#1f2433; border-radius:22px; border:4px solid #0d1222; padding:18px; min-height:170px;
  box-shadow: 0 12px 28px rgba(0,0,0,.45) }
.cosmic-card h3{ margin:0; font-family:"Russo One"; color:#d7ecff; }
.cosmic-desc{ opacity:.9; font-size:18px; }
.cosmic-price{ font-weight:900; font-size:20px; }
.cosmic-buy{ align-self:flex-end; padding:10px 16px; font-weight:900; border:none; border-radius:14px; cursor:pointer;
  background:linear-gradient(#59a7ff,#2973e3); color:#fff; }
.cosmic-badge{ font-family:"Bungee"; letter-spacing:1px; font-size:24px; -webkit-text-stroke:2px #000; }

/* Cosmic rarity label + sparkle */
.t-cosmic{
  color:#8fd0ff;
  text-shadow:0 0 8px rgba(0,180,255,.65), 0 0 16px rgba(0,120,255,.4);
  position:relative; font-weight:900;
}
.t-cosmic::after{
  content:""; position:absolute; left:-6px; top:-6px; right:-6px; bottom:-6px; pointer-events:none;
  background: radial-gradient(1.5px 1.5px at 12% 30%, #ffd84a 0 60%, transparent 61%),
              radial-gradient(1.2px 1.2px at 72% 20%, #ffd84a 0 60%, transparent 61%),
              radial-gradient(1.8px 1.8px at 30% 78%, #ffd84a 0 60%, transparent 61%),
              radial-gradient(1.6px 1.6px at 86% 62%, #ffd84a 0 60%, transparent 61%);
  animation: cosmicSparkle 2.2s linear infinite;
}
@keyframes cosmicSparkle{
  0%{ background-position: 0 0, 0 0, 0 0, 0 0; opacity:.8; }
  50%{ background-position: 6px 6px, -4px 3px, 2px -5px, -6px -2px; opacity:1; }
  100%{ background-position: 0 0, 0 0, 0 0, 0 0; opacity:.8; }
}

/* Pull-up reward animation */
.cosmic-reveal{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1000;
  background: radial-gradient(800px 400px at 50% 50%, rgba(15,22,40,.86), rgba(0,0,0,.85));
}
.cosmic-reveal.show{ display:flex; }
.cosmic-reveal .card{
  background:#0e1628; border:5px solid #0a0f1a; border-radius:24px; padding:22px; text-align:center; color:#e6f3ff;
  box-shadow:0 0 80px rgba(80,180,255,.28), 0 20px 60px rgba(0,0,0,.65);
  animation: popin .25s ease-out;
}
@keyframes popin{ from{ transform: scale(.8); opacity:0; } to{ transform: scale(1); opacity:1; } }
.cosmic-reveal img{ width:110px; height:110px; border-radius:16px; display:block; margin:8px auto; }

/* Background: Space View */
body.bg-spaceview{background:url('space_view_files/space_view.png') center center / cover no-repeat fixed !important;}
body.bg-spaceview::before{
  content:""; position:fixed; inset:0; z-index:-2; background:#04060c;
  background-image:
    radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.9) 0 60%, transparent 61%),
    radial-gradient(1px 1px at 30% 80%, rgba(255,255,255,.8) 0 60%, transparent 61%),
    radial-gradient(2px 2px at 70% 10%, rgba(255,255,255,.9) 0 60%, transparent 61%),
    radial-gradient(1px 1px at 80% 70%, rgba(255,255,255,.9) 0 60%, transparent 61%);
  animation: starDrift 24s linear infinite;
}
@keyframes starDrift { 0%{ background-position: 0 0, 0 0, 0 0, 0 0; } 100%{ background-position: -500px 240px, -200px 160px, -600px 400px, -300px 260px; } }
</style>


<style>
/* === LA Dodgers Event === */

/* Improved icon rendering via CSS var (works even if <img> fails) */
.icon-dodger{ 
  background:linear-gradient(180deg, #ffffff 0%, #dff1ff 35%, #9fd5ff 100%); position:relative; overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  box-shadow: inset 0 0 0 2px #cfe9ff, 0 6px 16px rgba(0,84,164,.15);
}
.icon-dodger::after{
  content: ""; position:absolute; inset:14%; border-radius:12px;
  background: var(--dodger-icon, none) center/contain no-repeat;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.4));
}
.icon-dodger .fallback-text{
  font-family:"Bungee", system-ui; font-weight:900; font-size:22px; letter-spacing:1px;
  color:#0a5aa8; text-shadow:0 2px 0 rgba(255,255,255,.7);
}
#dodgerShopLogo{ width: 140px; height: 100px; object-fit: contain; }
#dodgerShopLogo.fallback{
  display:grid; place-items:center; background:linear-gradient(180deg,#ffffff,#e6f4ff); color:#0a5aa8; font-weight:900; 
  width: 140px; height: 100px; border-radius:14px; box-shadow: inset 0 0 0 2px #cfe9ff;
}

.icon-dodger{ background:#0b2e6e; position:relative; overflow:hidden; }
.icon-dodger img{ width:64%; height:64%; object-fit:contain; image-rendering:auto; filter:drop-shadow(0 2px 6px rgba(0,0,0,.4)); }

#dodgerOverlay .sheet{ background: radial-gradient(1200px 600px at 50% -200px,#ffffff,#e9f5ff 45%,#cfe9ff 75%); color:#0d2640; border-color:#d2ebff; }
#dodgerOverlay h2{ color:#0b74ff; text-shadow:0 1px 0 rgba(255,255,255,.9); }
.dodger-grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }
.dodger-card{ background:rgba(255,255,255,.96); border-radius:22px; border:3px solid #d8ecff; padding:18px; min-height:170px; box-shadow:0 12px 28px rgba(0,84,164,.12); }
.dodger-card h3{ margin:0; font-family:"Russo One"; color:#0d3b66; }
.dodger-desc{ opacity:.9; font-size:18px; color:#123b5f; }
.dodger-price{ font-weight:900; font-size:20px; }
.dodger-buy{ align-self:flex-end; padding:10px 16px; font-weight:900; border:none; border-radius:14px; cursor:pointer; background:linear-gradient(#a6d9ff,#65b9ff); color:#093054; }

/* Dodger rarity label */
.t-dodger{
  color:#0b74ff;
  text-shadow:0 0 10px rgba(255,255,255,.9), 0 0 18px rgba(11,116,255,.55);
  position:relative; font-weight:900;
}

/* Blue & white animated waves around the placed item when rarity=DODGER */
.placed.dodger-waves::before,
.placed.dodger-waves::after{
  content:""; position:absolute; inset:-6px; border-radius:16px; pointer-events:none;
  background: conic-gradient(from 0deg, rgba(255,255,255,0), rgba(255,255,255,.35) 15%, rgba(30,144,255,.55) 30%, rgba(255,255,255,.35) 45%, rgba(255,255,255,0) 60%);
  animation:dodgerSpin 3.2s linear infinite; mix-blend-mode: screen;
}
.placed.dodger-waves::after{ filter: blur(4px); animation-duration:5s; opacity:.6; }
@keyframes dodgerSpin{ to{ transform: rotate(360deg); } }

/* Background: Dodger Stadium Style */
body.bg-dodger{ background:url('la_dodgers_style_files/la_dodgers_style.png') center center / cover no-repeat fixed !important; }
</style>


<style>
/* === Backgrounds overlay: scrollable grid === */
#bgOverlay .sheet{
  max-height: min(92vh, 860px);
  display: flex;
  flex-direction: column;
  overflow: hidden; /* cap the dialog; inner grid will scroll */
}
#bgOverlay h2{ margin: 0 0 12px 0; }
#bgOverlay #bgGrid{
  flex: 1 1 auto;
  min-height: 0;
  overflow-y: auto;
  padding-right: 6px;   /* avoid content under scrollbar */
  scroll-behavior: smooth;
}

/* Optional: subtle custom scrollbar */
#bgOverlay #bgGrid::-webkit-scrollbar{ width: 10px; }
#bgOverlay #bgGrid::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.15); border-radius: 8px; }
#bgOverlay #bgGrid::-webkit-scrollbar-track{ background: transparent; }

@media (max-width: 800px){
  #bgOverlay .sheet{ max-height: min(92vh, 720px); }
}
</style>

</head>
<body>
<div class="game">
  <div class="topbar">
    <div class="cash" id="cash">$1,000,000</div>
    <div class="eps" id="eps">+ $0 / sec</div>
  </div>

  <div class="left-rail">
  <div id="userDisplay" style="margin-bottom:16px;text-align:center;font-weight:bold;font-size:1.2em;color:#222;background:#fff7e0;padding:8px 0;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.10);">
  <!-- Username will appear here -->
  </div>
    <button class="icon-btn icon-shop" id="openShop" aria-label="Open shop" title="Shop">
      <svg viewBox="0 0 24 24" fill="none" stroke="#e40000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="9" cy="21" r="1.8"></circle>
        <circle cx="20" cy="21" r="1.8"></circle>
        <path d="M1 2h3l3.6 12.4a2 2 0 0 0 2 1.6h7.8a2 2 0 0 0 2-1.6L23 6H6"></path>
      </svg>
    </button>
    <button class="icon-btn icon-tools" id="toolsBtn" aria-label="Tools" title="Tools (toggle fast refresh)">
      <svg viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22.7 19.3L13 9.6M16 3a5 5 0 0 0-6.2 6.2l-7.7 7.7a2.5 2.5 0 1 0 3.5 3.5l7.7-7.7A5 5 0 0 0 21 8"></path>
      </svg>
    </button>

    <!-- NEW: Pet Shop button (paw) -->
    <button class="icon-btn icon-pets" id="openPetShop" aria-label="Pet Shop" title="Pet Shop">
      <svg viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 21s-4-2.5-6.5-5.5C2.5 12 5 8 7.5 8c1.5 0 2.5 1 3.5 1s2-1 3.5-1C17 8 19.5 12 18.5 15.5 16 18.5 12 21 12 21z" fill="none"/>
        <circle cx="7" cy="7" r="2" fill="none"/>
        <circle cx="17" cy="7" r="2" fill="none"/>
        <circle cx="6" cy="12" r="1.5" fill="none"/>
        <circle cx="18" cy="12" r="1.5" fill="none"/>
      </svg>
    </button>

    <button class="icon-btn icon-music" id="musicBtn" aria-label="Toggle music" title="Toggle music">
      <svg viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M9 17V5l11-2v12"/><circle cx="6" cy="18" r="2"/><circle cx="17" cy="16" r="2"/></svg>
    </button>
  </div>

  <div class="stands" id="stands"></div>

  <!-- Pet row will be rendered directly under stands inside renderStands -->

  <!-- Forge button -->
  <button id="forgeBtn" title="Forge 4 Legendaries into 1 Mythic">FORGE</button>

  <!-- inventory is now fixed to bottom via CSS -->
  <div class="inventory-wrap">
    <div class="inventory" id="inventory"></div>
  </div>
</div>

<div class="overlay" id="shopOverlay" aria-hidden="true">
  <div class="shop" role="dialog" aria-modal="true" aria-labelledby="shopTitle">
    <button class="closeX" id="closeShop" aria-label="Close">âœ•</button>
    <h2 id="shopTitle">Shop</h2>
    <div class="grid" id="shopGrid"></div>
    <div class="refresh-note" id="refreshNote">Shop refreshes every 1:30</div>
  </div>
</div>

<!-- Pet Shop Overlay -->
<div class="overlay" id="petOverlay" aria-hidden="true">
  <div class="shop" role="dialog" aria-modal="true" aria-labelledby="petTitle">
    <button class="closeX" id="closePetShop" aria-label="Close">âœ•</button>
    <h2 id="petTitle">Pet Shop</h2>
    <div class="grid">
      <div class="card">
        <h3>Pet Pedestal</h3>
        <div style="font-size:18px; opacity:0.9;">Adds a pet pedestal below the pedestals. Max 2. Place eggs here to incubate.</div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="price">$15,000,000</div>
          <button class="buy" id="buyPetPedestal">Purchase</button>
        </div>
        <div id="petPedestalStatus" style="margin-top:6px;font-weight:700;color:#6dff79;"></div>
      </div>

      <div class="card">
        <h3>Legendary Egg</h3>
        <div style="font-size:18px; opacity:0.9;">Hatch into Dog / Cat / Gold Dog.</div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="price">$10,000,000</div>
          <button class="buy" id="buyLegendEgg">Purchase</button>
        </div>
      </div>

      <div class="card">
        <h3>Mythical Egg</h3>
        <div style="font-size:18px; opacity:0.9;">Hatch into Lion / Bear / Dino.</div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="price">$15,000,000</div>
          <button class="buy" id="buyMythEgg">Purchase</button>
        </div>
      </div>

      <div class="card">
        <h3>Enchanted Egg</h3>
        <div style="font-size:18px; opacity:0.9;">Hatch into Owl / Rainbow Panda / Flex T-Rex.</div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="price">$25,000,000</div>
          <button class="buy" id="buyEnchantedEgg">Purchase</button>
        </div>
      </div>

    
      <div class="card">
        <h3>Universal Egg</h3>
        <div style="font-size:18px; opacity:0.9;">Hatch into Lizard / Alien / Hudsonâ€“Drakeâ€“Molly / Flex Dragon.</div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="price">$1,000,000,000</div>
          <button class="buy" id="buyUniversalEgg">Purchase</button>
        </div>
      </div>
</div>
    <div class="refresh-note" id="petNote">Pets hatch in 10 minutes</div>
  </div>
</div>


<!-- Gear Overlay -->
<div class="overlay" id="gearOverlay" aria-hidden="true">
  <div class="shop" role="dialog" aria-modal="true" aria-labelledby="gearTitle">
    <button class="closeX" id="closeGear" aria-label="Close">âœ•</button>
    <h2 id="gearTitle" style="color:#ff5050;text-align:center;">Gear</h2>
    <div class="grid">

      <!-- Multiplier Tool -->
      <div class="card" id="multiplierCard">
        <h3>Multiplier x2</h3>
        <div style="font-size:18px; opacity:0.85;">Doubles EPS for 20 minutes.<br>Max 4x.<br>Cooldown: 30 min.</div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="price">$3,000,000</div>
          <button class="buy" id="buyMultiplier">Purchase</button>
        </div>
        <div id="multiplierStatus" style="margin-top:6px;font-weight:700;color:#6dff79;"></div>
      </div>

      <!-- Background Tool -->
      <div class="card" id="backgroundCard">
        <h3>Background Red/Blue</h3>
        <div style="font-size:18px; opacity:0.85;">Switch gradient to red/blue.<br>One-time purchase.</div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="price">$4,000,000</div>
          <button class="buy" id="buyBackground">Purchase</button>
        </div>
        <button id="toggleBackground" class="buy" style="display:none;background:linear-gradient(#ff7a7a,#6aaaff);">Disable</button>
      </div>



  
      <!-- Red Money Tool -->
      <div class="card" id="redMoneyCard">
        <h3>Red Money</h3>
        <div style="font-size:18px; opacity:0.85;">Changes the top money banner to red/dark red.<br>One-time purchase.</div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="price">$1,000,000,000,000</div>
          <button class="buy" id="buyRedMoney">Purchase</button>
        </div>
        <button id="toggleRedMoney" class="buy" style="display:none;background:linear-gradient(#ff6b6b,#8b0000);">Disable</button>
      </div>
<div id="settingsOverlay" class="overlay hidden">
    <h2>Settings</h2>

    <div>
      <button onclick="toggleBackground()">Toggle Background</button>
    </div>

    <div style="margin-top: 10px;">
      <button onclick="downloadSave()">Download Save</button>
    </div>

    <div style="margin-top: 10px;">
      <input type="file" id="uploadSaveInput" accept=".json" style="display:none"
             onchange="handleSaveUpload(event)">
      <button onclick="document.getElementById('uploadSaveInput').click()">Upload Save</button>
    </div>
  </div>


    </div>
  </div>
</div>


<!--
  NOTE:
  The JavaScript from your original file is compatible with these layout changes.
  I intentionally left the script logic intact (no changes) â€” only the styles and layout were updated so the
  inventory bar sits fixed at the bottom like your concept art, pedestals/placed items are raised above it,
  and slots have larger sizes and a thick outlined container matching the visual.
-->
<button id="resetGame" style="margin-left:20px;background:#e74c3c;color:#fff;padding:8px 16px;border-radius:12px;border:none;font-weight:bold;cursor:pointer;">Reset Game</button>
<script>
document.getElementById("resetGame").addEventListener("click", function() {
  if (confirm("Are you sure you want to reset your game? This cannot be undone.")) {
    localStorage.removeItem("flexSave");
    // Set a flag so boot knows NOT to load from localStorage
    sessionStorage.setItem("doGameReset", "1");
    location.reload();
  }
});
/* ---------------------------
   Paste your entire original JavaScript here (unchanged).
   For brevity in this example I am keeping the JS unchanged from your provided code.
   Make sure to copy the whole <script> contents from your original file into this spot.
   --------------------------- */

  /*****************
   * GAME CONSTANTS
   * (full JS from original file goes here)
   *****************/

  const MONEY_START = 1_000_000;
  const STAND_COUNT = 4;
  const SHOP_SLOTS = 4;

  const RARITY = {
    common: { label:'COMMON', color:'var(--c-common)', income: 50, price:[8_000, 40_000], prob: 0.60 },
    rare: { label:'RARE', color:'var(--c-rare)', income: 200, price:[40_000, 150_000], prob: 0.25 },
    epic: { label:'EPIC', color:'var(--c-epic)', income: 800, price:[150_000, 420_000], prob: 0.12 },
    legendary:{ label:'LEGENDARY', color:'var(--c-legendary)', income: 3000, price:[420_000, 920_000], prob: 0.03 },
    legacy:{ label:'LEGACY', color:'var(--c-legacy)', income: 8000, price:[900_000, 2_500_000], prob: 0.005 },
    birthday: { label:'BIRTHDAY', color:'#ff62d5', income: 15000, price:[0,0], prob: 0 },
    mythic:{ label:'MYTHIC', color:'var(--c-mythic)', income: 20000, price:[0,0], prob: 0 },
    unique:  { label:'UNIQUE', color:'navy', income: 10000, price:[2_500_000,4_000_000], prob: 0.003 },
    exotic:  { label:'EXOTIC', color:'cyan', income: 15000, price:[0,0], prob: 0 }
  };

  const ITEM_NAMES = [
    '24 King Crown','Donut','3D Printer','Space Nathan','Candy Blossom',
    'Frog Sneakers','Snake','Harry Potter\'s Wand','Retro Gameboy','Crystal Cube',
    'Swat Night','Flashforge','Blue Walls','Golden Spatula','Rainbow Headphones',
    'Red Government','Vecna','Aqua Drone','Burning Bud','Espresso',
    'Pixel Panda','Sabrina','Nether Portal','Alt','Natan',
    'Apple Watch','Chicken Jockey','67','Nathan\'s Playstation','Stale Goldfish Bag',
    'Duolingo','Dillon\'s PC','Apple','Icon of the Seas','North America',
    'Sheldon','Old Fan','$$$','McFlex','Junior Lifeguards',
    'Carl','Supreme','Nike Guy','Puma Socks','Blue',
    'Barbie','','Golden Jacket','Lucas Movies','Movie Clip Reel','Leo\'s Ethernet','Ryan\'s Hat','Lebron','Pigs\'s Blanket','Lamborghini','Dean\'s PC','USA','China','Iron Man\'s Helmet','Hanging Tree'
  ];
  while (ITEM_NAMES.length < 50) ITEM_NAMES.push('Item #' + (ITEM_NAMES.length+1));

  const ICON_PATHS = {
    "24 King Crown": `<path d="M18 62h60v10H18z M20 62l10-22 18 20 18-20 10 22" fill="none" stroke-width="6" stroke-linejoin="round"/>`,
    "Donut": `<circle cx="48" cy="48" r="26" fill="none" stroke-width="6"/><circle cx="48" cy="48" r="10" fill="none" stroke-width="6"/>`,
    "3D Printer": `<rect x="18" y="18" width="60" height="48" rx="6" fill="none" stroke-width="6"/><path d="M26 26h44v16H26zM48 42v20" fill="none" stroke-width="6"/>`,
    "Space Nathan": `<circle cx="48" cy="38" r="14" fill="none" stroke-width="6"/><rect x="34" y="52" width="28" height="22" rx="6" fill="none" stroke-width="6"/>`,
    "Candy Blossom": `<path d="M48 20v24M48 44c-14 0-14 18 0 18s14-18 0-18z" fill="none" stroke-width="6"/><circle cx="48" cy="20" r="6" fill="none" stroke-width="6"/>`,
    "Frog Sneakers": `<rect x="20" y="54" width="56" height="16" rx="8" fill="none" stroke-width="6"/><path d="M24 54c6-12 24-12 30 0" fill="none" stroke-width="6"/>`,
    "Snake": `<path d="M20 58c10-18 26-18 36-8s20 10 20 2-8-12-16-12" fill="none" stroke-width="6" stroke-linecap="round"/>`,
    "Harry Potter's Wand": `<path d="M20 74L76 18" fill="none" stroke-width="6"/><circle cx="76" cy="18" r="4" />`,
    "Retro Gameboy": `<rect x="28" y="16" width="40" height="64" rx="8" fill="none" stroke-width="6"/><rect x="34" y="22" width="28" height="24" rx="4" fill="none" stroke-width="6"/><circle cx="46" cy="56" r="4"/><circle cx="54" cy="60" r="4"/>`,
    "Crystal Cube": `<rect x="28" y="28" width="40" height="40" rx="6" fill="none" stroke-width="6"/><path d="M28 48h40M48 28v40" fill="none" stroke-width="6"/>`,
    "Swat Night": `<path d="M22 60h52l8-20H30z" fill="none" stroke-width="6"/><circle cx="34" cy="64" r="4"/><circle cx="62" cy="64" r="4"/>`,
    "Flashforge": `<path d="M24 48l24-24 24 24-24 24z" fill="none" stroke-width="6"/>`,
    "Blue Walls": `<rect x="20" y="24" width="56" height="44" rx="4" fill="none" stroke-width="6"/><path d="M20 46h56" fill="none" stroke-width="6"/>`,
    "Golden Spatula": `<path d="M48 22v44" fill="none" stroke-width="6"/><rect x="36" y="22" width="24" height="12" rx="2" fill="none" stroke-width="6"/>`,
    "Rainbow Headphones": `<path d="M26 48a22 22 0 0 1 44 0" fill="none" stroke-width="6"/><rect x="18" y="44" width="14" height="24" rx="6" fill="none" stroke-width="6"/><rect x="64" y="44" width="14" height="24" rx="6" fill="none" stroke-width="6"/>`,
    "Red Government": `<rect x="24" y="40" width="48" height="28" rx="4" fill="none" stroke-width="6"/><path d="M24 40l24-16 24 16" fill="none" stroke-width="6"/>`,
    "Vecna": `<path d="M48 20c-10 8-10 16 0 24 10-8 10-16 0-24z" fill="none" stroke-width="6"/><circle cx="48" cy="58" r="10" fill="none" stroke-width="6"/>`,
    "Aqua Drone": `<circle cx="48" cy="48" r="12" fill="none" stroke-width="6"/><path d="M20 48h16M60 48h16M48 20v16M48 60v16" fill="none" stroke-width="6"/>`,
    "Burning Bud": `<path d="M48 24c-18 12-18 28 0 40 18-12 18-28 0-40z" fill="none" stroke-width="6"/><path d="M36 66h24" fill="none" stroke-width="6"/>`,
    "Espresso": `<rect x="28" y="38" width="40" height="24" rx="4" fill="none" stroke-width="6"/><path d="M68 40h10v10a6 6 0 0 1-10 0z" fill="none" stroke-width="6"/>`,
    "Pixel Panda": `<rect x="28" y="28" width="40" height="40" fill="none" stroke-width="6"/><rect x="36" y="36" width="8" height="8"/><rect x="52" y="36" width="8" height="8"/>`,
    "Sabrina": `<circle cx="48" cy="38" r="12" fill="none" stroke-width="6"/><path d="M34 54h28l6 18H28z" fill="none" stroke-width="6"/>`,
    "Nether Portal": `<rect x="28" y="18" width="40" height="60" rx="6" fill="none" stroke-width="6"/><rect x="36" y="26" width="24" height="44" rx="3" fill="none" stroke-width="6" />`,
    "Alt": `<path d="M24 60l24-36 24 36" fill="none" stroke-width="6"/>`,
    "Natan": `<path d="M24 64l24-24 24 24" fill="none" stroke-width="6"/><circle cx="48" cy="34" r="6" fill="none" stroke-width="6"/>`,
    "Apple Watch": `<rect x="28" y="28" width="40" height="40" rx="10" fill="none" stroke-width="6"/><rect x="36" y="36" width="24" height="24" rx="6" fill="none" stroke-width="6"/>`,
    "Chicken Jockey": `<circle cx="36" cy="44" r="10" fill="none" stroke-width="6"/><rect x="42" y="48" width="26" height="18" rx="6" fill="none" stroke-width="6"/>`,
    "67": `<path d="M30 36h36M30 36v36M66 36v36M30 54h24" fill="none" stroke-width="6"/>`,
    "Nathan's Playstation": `<rect x="24" y="56" width="48" height="10" rx="4" fill="none" stroke-width="6"/><path d="M28 56h40l-6-16H34z" fill="none" stroke-width="6"/>`,
    "Stale Goldfish Bag": `<rect x="30" y="24" width="36" height="48" rx="6" fill="none" stroke-width="6"/><path d="M30 32h36" fill="none" stroke-width="6"/>`,
    "Duolingo": `<path d="M30 44l18-12 18 12-18 12z" fill="none" stroke-width="6"/><circle cx="40" cy="44" r="3"/><circle cx="56" cy="44" r="3"/>`,
    "Dillon's PC": `<rect x="24" y="28" width="48" height="30" rx="6" fill="none" stroke-width="6"/><rect x="34" y="60" width="28" height="6" rx="3" fill="none" stroke-width="6"/>`,
    "Apple": `<circle cx="48" cy="44" r="16" fill="none" stroke-width="6"/><path d="M48 26c4 0 6 2 8 4" fill="none" stroke-width="6"/>`,
    "Icon of the Seas": `<path d="M24 58h48l8-10H32z" fill="none" stroke-width="6"/><rect x="36" y="42" width="24" height="8" rx="2" fill="none" stroke-width="6"/>`,
    "North America": `<path d="M28 40l10-8 12 6 10-8 8 10-8 10-12 4-10-6z" fill="none" stroke-width="6"/>`,
    "Sheldon": `<circle cx="48" cy="36" r="10" fill="none" stroke-width="6"/><rect x="36" y="48" width="24" height="20" rx="8" fill="none" stroke-width="6"/>`,
    "Old Fan": `<circle cx="48" cy="48" r="18" fill="none" stroke-width="6"/><path d="M48 30v36M30 48h36" fill="none" stroke-width="6"/>`,
    "$$$": `<path d="M48 24v48M34 38c0-8 28-8 28 0s-28 8-28 16 28 8 28 0" fill="none" stroke-width="6"/>`,
    "McFlex": `<rect x="24" y="40" width="48" height="24" rx="6" fill="none" stroke-width="6"/><path d="M28 40c8-12 32-12 40 0" fill="none" stroke-width="6"/>`,
    "Junior Lifeguards": `<circle cx="48" cy="48" r="18" fill="none" stroke-width="6"/><path d="M48 30v36M30 48h36" fill="none" stroke-width="6"/>`,
    "Carl": `<path d="M36 32h24v12H36zM34 50h28v14H34z" fill="none" stroke-width="6"/>`,
    "Supreme": `<rect x="22" y="42" width="52" height="14" rx="7" fill="none" stroke-width="6"/>`,
    "Nike Guy": `<path d="M24 62c24-4 40-14 48-24-6 14-22 24-48 24z" fill="none" stroke-width="6" stroke-linecap="round"/>`,
    "Puma Socks": `<rect x="28" y="46" width="18" height="20" rx="4" fill="none" stroke-width="6"/><path d="M46 64h22v-14" fill="none" stroke-width="6"/>`,
    "Blue": `<circle cx="48" cy="48" r="20" fill="none" stroke-width="6"/>`,
    "Barbie": `<path d="M30 62c6-12 24-12 36 0" fill="none" stroke-width="6"/><circle cx="48" cy="40" r="10" fill="none" stroke-width="6"/>`,
    "": `<path d="M48 26l18 36H30z" fill="none" stroke-width="6"/>`,
    "Golden Jacket": `<rect x="26" y="28" width="44" height="36" rx="8" fill="none" stroke-width="6"/><path d="M26 44h44" fill="none" stroke-width="6"/>`,
    "Lucas Movies": `<rect x="26" y="34" width="44" height="28" rx="4" fill="none" stroke-width="6"/><rect x="24" y="38" width="8" height="20"/><rect x="64" y="38" width="8" height="20"/>`,
    "Movie Clip Reel": `<circle cx="36" cy="48" r="12" fill="none" stroke-width="6"/><circle cx="60" cy="48" r="12" fill="none" stroke-width="6"/><path d="M24 48h12M60 48h12" fill="none" stroke-width="6"/>`,
    "Leo's Ethernet": `<rect x="24" y="52" width="48" height="10" rx="3" fill="none" stroke-width="6"/><path d="M30 52V42h36v10" fill="none" stroke-width="6"/>`,
    "Ryan's Hat": `<path d="M24 54c8-18 40-18 48 0" fill="none" stroke-width="6"/><rect x="24" y="54" width="48" height="10" rx="5" fill="none" stroke-width="6"/>`,
    "Lebron": `<circle cx="48" cy="40" r="10" fill="none" stroke-width="6"/><rect x="34" y="52" width="28" height="20" rx="6" fill="none" stroke-width="6"/>`,
    "Pigs's Blanket": `<rect x="26" y="40" width="44" height="22" rx="6" fill="none" stroke-width="6"/><circle cx="34" cy="52" r="4"/>`,
    "Lamborghini": `<path d="M22 56h52l8-12H30z" fill="none" stroke-width="6"/><circle cx="34" cy="62" r="4"/><circle cx="62" cy="62" r="4"/>`,
    "Dean's PC": `<rect x="24" y="28" width="48" height="30" rx="6" fill="none" stroke-width="6"/><rect x="34" y="60" width="28" height="6" rx="3" fill="none" stroke-width="6"/>`,
    "USA": `<path d="M26 42h44M26 50h44M26 58h44" fill="none" stroke-width="6"/><rect x="26" y="34" width="16" height="16" fill="none" stroke-width="6"/>`,
    "China": `<rect x="28" y="34" width="40" height="28" fill="none" stroke-width="6"/><path d="M32 40l4-2 2 4" fill="none" stroke-width="6"/>`,
    "Iron Man's Helmet": `<path d="M32 24h32l8 16v20l-8 12H32L24 60V40z" fill="none" stroke-width="6"/>`,
    "Hanging Tree": `<path d="M30 66V26M30 32h28M58 32v22" fill="none" stroke-width="6"/><path d="M30 26c8-4 16-4 24 0" fill="none" stroke-width="6"/>`
  };

  function getItemSvg(name, idx, rarity){
    const size = 96;
    const accentByRarity = {
        common:'#8ee78e',
        rare:'#6ec8ff',
        epic:'#c28bff',
        legendary:'#ffd86a',
        legacy:'#ffffff',
        mythic:'#ffd86a',
        unique:'navy',
        exotic:'cyan'
    };
    const accent = accentByRarity[rarity] || '#cfd3d7';
    const hue = (idx*53 + (rarity==='legendary'?40:rarity==='epic'?20:0)) % 360;
    const bg = `hsl(${hue} 65% 24%)`;
    const body = ICON_PATHS.hasOwnProperty(name) ? ICON_PATHS[name] : `<circle cx="48" cy="48" r="20" fill="none" stroke-width="6"/>`;
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 96 96">
      <defs>
        <filter id="d${idx}" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.35"/>
        </filter>
      </defs>
      <rect x="4" y="4" width="88" height="88" rx="14" fill="${bg}" />
      <g transform="translate(0,0)" filter="url(#d${idx})" stroke="${accent}">
        ${body}
      </g>
    </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }

  /* Simple egg SVG generator */
  
  /* Simple egg SVG generator (with 'universal' red/blue gradient support) */
  function getEggSvg(eggType, seed){
    const size=96;
    const colorMap = { legendary: '#ffd86a', mythical:'#ff9900', enchanted:'#33cc33' };
    const gradId = `ueg${seed}`;

    const ellipseFill = (eggType==='universal')
      ? `url(#${gradId})`
      : (colorMap[eggType] || '#ddd');

    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 96 96">
      <defs>
        <filter id="eg${seed}" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.35"/>
        </filter>
        ${eggType==='universal' ? `<linearGradient id="${gradId}" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#ff4b5c"/>
          <stop offset="100%" stop-color="#4b6aff"/>
        </linearGradient>` : ``}
      </defs>
      <rect x="4" y="4" width="88" height="88" rx="14" fill="#333" />
      <g filter="url(#eg${seed})">
        <ellipse cx="48" cy="52" rx="22" ry="28" fill="${ellipseFill}" />
        <ellipse cx="40" cy="40" rx="6" ry="4" fill="#fff" opacity="0.65"/>
      </g>
    </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }


function getPetSvg(petName, seed){
  // Normalize filename
  const nameMap = { "Dog": "dog.png",
    "Cat": "cat.png",
    "Dino": "dino.png",
    "Bear": "bear.png",
    "Lion": "lion.png",
    "Gold Dog": "gold_dog.png",
    "Owl": "owl.png",
    "Rainbow Panda": "rainbow_panda.png",
    "Flex T-Rex": "flex_t_rex.png",
    "Lizard": "lizard.png",
    "Alien": "alien.png",
    "Hudson": "hudson.png",
    "Drake": "drake.png",
    "Molly": "molly.png",
    "Flex Dragon": "flex_dragon.png",
    
  };

  const file = nameMap[petName] || null;

  if (file) {
    // âœ… return direct PNG path (adjust folder if needed)
    return `pets/${file}`;
  }

  // ðŸ©¶ fallback placeholder if not found
  const size = 96;
  const hue = (seed * 97) % 360;
  const bg = `hsl(${hue} 60% 35%)`;
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 96 96">
    <rect x="4" y="4" width="88" height="88" rx="14" fill="${bg}" />
    <text x="48" y="58" font-size="14" font-weight="700" text-anchor="middle" fill="#fff">${escapeXml(petName.slice(0,6))}</text>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

  function escapeXml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function displayName(n){ return (n && n.trim()) ? n : 'Mystery'; }

  const LS_KEY = 'flex-save-v1';
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const state = {
    money: MONEY_START,
    eps: 0,
    inventory: [],
    stands: [null,null,null,null],
    placed: {},
    selectedItemUid: null,
    fastMode: false,
    shop: { items:[], nextRefreshAt:0 },

    // new pet-related state:
    petPedestalsPurchased: 0,           // 0..2
    petStands: [null,null],             // each entry: null or { uid,name,isEgg,eggType,petType,petEps,svg,baseIdx }
    petTimers: {},                      // map index -> timestamp (ms) when hatch will happen
    permanentPetMultiplier: 1           // becomes 5 if Flex T-Rex hatched
  };

  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
 const SERVER_BASE = 'https://flex-sdww.onrender.com/api/game'; // use your actual Render.com URL

// Identify user (for demo, use a prompt and store in localStorage)
let USER_ID = localStorage.getItem('flex-userid');
if (!USER_ID) {
  USER_ID = prompt('Enter your username (or type "guest"):');
  localStorage.setItem('flex-userid', USER_ID);
}
document.getElementById("userDisplay").textContent = USER_ID ? `User: ${USER_ID}` : "No user";

async function save() {
  const payload = {
    money: state.money,
    eps: state.eps,
    inventory: state.inventory.map(it=>({uid:it.uid,name:it.name,rarity:it.rarity,price:it.price,baseIdx:it.baseIdx,isEgg:it.isEgg,eggType:it.eggType,petType:it.petType,petEps:it.petEps,svg:it.svg})),
    stands: state.stands,
    shop: state.shop,
    fastMode: state.fastMode,
    multiplierLevel,
    multiplierActiveUntil,
    multiplierCooldownUntil,
    backgroundPurchased,
    backgroundEnabled,
    redMoneyPurchased,
    redMoneyEnabled,

    placed: {},
    petPedestalsPurchased: state.petPedestalsPurchased,
    petStands: {}, // serialized by index
    petTimers: state.petTimers,
    permanentPetMultiplier: state.permanentPetMultiplier,
    petDex: (state.petDex || {})
  };
  for(const k in state.placed){
    const it = state.placed[k];
    if(it) payload.placed[k] = { uid: it.uid, name: it.name, rarity: it.rarity, price: it.price, baseIdx: it.baseIdx, svg: it.svg };
  }
  // serialize pet stands
  state.petStands.forEach((ps, idx) => {
    if(ps) payload.petStands[idx] = { uid:ps.uid, name:ps.name, isEgg:!!ps.isEgg, eggType:ps.eggType||null, petType:ps.petType||null, petEps:ps.petEps||0, svg:ps.svg, baseIdx: ps.baseIdx||0 };
  });

  try {
    await fetch(`${SERVER_BASE}/save?user=${encodeURIComponent(USER_ID)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
  } catch (e) {
    console.error('Failed to save game:', e);
  }
}

async function load() {
  try {
    const res = await fetch(`${SERVER_BASE}/load?user=${encodeURIComponent(USER_ID)}`);
    if (!res.ok) return;
    const dat = await res.json();
    if (!dat) return;

    state.money = dat.money ?? state.money;
    state.eps = dat.eps ?? state.eps;
    state.inventory = (dat.inventory||[]).map(it=>({
      ...it, uid:it.uid, svg: it.svg || (it.isEgg ? getEggSvg(it.eggType || 'legendary', Math.floor(Math.random()*9999)) : getItemSvg(it.name, it.baseIdx||0, it.rarity)), baseIdx: it.baseIdx||0
    }));
    state.stands = dat.stands ?? state.stands;
    state.shop = dat.shop ?? state.shop;
    state.fastMode = dat.fastMode ?? state.fastMode;
    state.placed = {};
    // NEW Gear persistence
    multiplierLevel = dat.multiplierLevel ?? 1;
    multiplierActiveUntil = dat.multiplierActiveUntil ?? 0;
    multiplierCooldownUntil = dat.multiplierCooldownUntil ?? 0;
    backgroundPurchased = dat.backgroundPurchased ?? false;
    backgroundEnabled = dat.backgroundEnabled ?? false;

    // Red Money
    redMoneyPurchased = dat.redMoneyPurchased ?? false;
    redMoneyEnabled = dat.redMoneyEnabled ?? false;
    if(redMoneyEnabled){ document.body.classList.add('money-red'); }

    if (backgroundPurchased) {
       document.getElementById("buyBackground").style.display = "none";
      document.getElementById("toggleBackground").style.display = "inline-block";
    }
    if (backgroundEnabled) {
      document.body.classList.add("redblue");
    }

    if(dat.placed){
      for(const k in dat.placed){
        const it = dat.placed[k];
        state.placed[k] = { ...it, uid:it.uid, svg: it.svg || getItemSvg(it.name, it.baseIdx||0, it.rarity), baseIdx: it.baseIdx||0 };
      }
    }

    // load pet stuff
    state.petPedestalsPurchased = dat.petPedestalsPurchased ?? state.petPedestalsPurchased;
    if(dat.petStands){
      for(const k in dat.petStands){
        const p = dat.petStands[k];
        state.petStands[Number(k)] = {
          uid: p.uid,
          name: p.name,
          isEgg: !!p.isEgg,
          eggType: p.eggType || null,
          petType: p.petType || null,
          petEps: p.petEps || 0,
          svg: p.svg || (p.isEgg ? getEggSvg(p.eggType||'legendary', Number(k)+Math.floor(Math.random()*9999)) : getPetSvg(p.petType||p.name, Number(k)+Math.floor(Math.random()*9999))),
          baseIdx: p.baseIdx||0
        };
      }
    }
    state.petTimers = dat.petTimers ?? state.petTimers;
    state.permanentPetMultiplier = dat.permanentPetMultiplier ?? state.permanentPetMultiplier;
    // PetDex (owned pets across eggs)
    state.petDex = dat.petDex || state.petDex || {};
  } catch (e) {
    console.warn("load failed", e);
  }
}
  function fmt(n){ return n.toLocaleString(undefined,{maximumFractionDigits:0}); }
  function updateTop(){ $('#cash').textContent = '$' + fmt(Math.max(0, Math.floor(state.money))); $('#eps').textContent = '+ $' + fmt(state.eps) + ' / sec'; }
function recalcEPS(){
  // Recalculate base EPS without multiplier; tolerant to uppercase/missing rarities
  let baseTotal = 0;

  state.stands.forEach(uid => {
    if(!uid) return;
    const it = state.placed[uid] || state.inventory.find(x => x.uid === uid);
    if(!it) return;
    
    console.log('EPS item check:', it.name, it.rarity);  // <--- ADD THIS
    
    const key = String(it.rarity || 'common').toLowerCase();
    const incomeVal = (RARITY[key] && Number(RARITY[key].income)) ? Number(RARITY[key].income) : 0;
    if(!RARITY[key]) console.warn('recalcEPS: unknown rarity for item', it.name, 'rarity:', it.rarity);
    baseTotal += incomeVal;
  });

  // Sum pet EPS (unchanged but coerced to number)
  let petTotal = 0;
  state.petStands.forEach(ps => {
    if(!ps) return;
    if(ps.petEps) petTotal += Number(ps.petEps) || 0;
  });

  // Combine and apply multipliers safely
  let combined = (Number(baseTotal) || 0) + (Number(petTotal) || 0);
  combined = combined * (Number(multiplierLevel) || 1) * (Number(state.permanentPetMultiplier) || 1);

  baseEPS = baseTotal; // keep base for reference
  state.eps = Math.floor(combined) || 0;
  updateTop();
  save();
}
  let lastTick = performance.now();
  function tick(now){
    const dt = (now - lastTick)/1000;
    lastTick = now;
    if(state.eps>0){
      state.money += state.eps * dt;
      updateTop();
    }

    // Check pet timers (hatch)
    checkPetHatches();

    requestAnimationFrame(tick);
  }

function downloadSave() {
  try {
    const blob = new Blob([JSON.stringify(state)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "my-save.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    alert("Error saving file: " + err.message);
  }
}

function handleSaveUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      state = data; // overwrite game state

      // re-render everything
      renderStands();
      renderInventory();
      recalcEPS();
      save();

      alert("Save file loaded successfully!");
    } catch (err) {
      alert("Invalid save file.");
      console.error(err);
    }
  };
  reader.readAsText(file);
}



function rarityBadge(r){
  // normalize to lowercase key used in RARITY object
  const key = String(r || 'common').toLowerCase();
  const label = (RARITY[key] && RARITY[key].label) ? RARITY[key].label : String(r || 'COMMON');
  return `<span class="rar t-${key}">${label}</span>`;
}
  
  function renderInventory(){
    const wrap = $('#inventory');
    wrap.innerHTML='';
    state.inventory.forEach(it=>{
      const el = document.createElement('div');
      el.className = 'slot' + ((it.isEgg||it.petType)?' is-pet':'') + (state.selectedItemUid===it.uid?' selected':'');
      // badge: EGG or PET or rarity
      let badgeHtml = '';
      if(it.isEgg) badgeHtml = `<div class="rar" style="right:8px;bottom:8px;background:rgba(255,255,255,.12);color:#fff;">EGG</div>`;
      else badgeHtml = rarityBadge(it.rarity || 'common');

      el.innerHTML = `<img src='${it.svg}' alt='${escapeXml(displayName(it.name))}'/><div style="position:absolute;top:6px;left:8px;font-size:12px;color:#fff;font-weight:700;text-shadow:0 1px 0 #000">${escapeXml(displayName(it.name))}</div>${badgeHtml}`;
      el.style.setProperty('--rcolor', RARITY[it.rarity]?.color || 'var(--c-common)');
      const badge = el.querySelector('.rar');
      if(badge) {
        badge.style.border = '2px solid rgba(255,255,255,.25)';
        badge.style.color = '#111';
      }
      el.addEventListener('click',()=>{
        state.selectedItemUid = (state.selectedItemUid===it.uid?null:it.uid);
        renderInventory();
      });
      wrap.appendChild(el);
    });
  }

  function checkExoticForge() {
  const allLegacy = state.stands.every(uid => {
    if (!uid) return false;
    const it = state.placed[uid] || state.inventory.find(x => x.uid === uid);
    return it && it.rarity && it.rarity.toLowerCase() === 'legacy';
  });

  let btn = document.getElementById('exoticForgeBtn');
  if (allLegacy) {
    if (!btn) {
      btn = document.createElement('button');
      btn.id = 'exoticForgeBtn';
      btn.textContent = 'FORGE EXOTIC';
      btn.style.cssText = 'margin-top:6px;padding:10px 18px;border-radius:14px;background:linear-gradient(45deg, #7fefff, #4fd9ff);border:4px solid rgba(0,0,0,.35);color:#000;font-weight:900;box-shadow:0 8px 30px rgba(127,239,255,0.4);cursor:pointer;';
      btn.addEventListener('click', () => {
  // remove the 4 legacy items from stands
  for (const uid of state.stands) {
    if (uid) delete state.placed[uid];
  }
  state.stands = [null, null, null, null];

  // create new exotic item and place it on stand 0
  const name = ITEM_NAMES[Math.floor(Math.random() * ITEM_NAMES.length)];
  const newItem = {
    uid: uid(),
    name,
    rarity: 'exotic',
    price: 0,
    baseIdx: Math.floor(Math.random() * ITEM_NAMES.length),
    svg: getItemSvg(name, Math.floor(Math.random() * 9999), 'exotic')
  };

  state.placed[newItem.uid] = newItem;
  state.stands[0] = newItem.uid;  // place on first stand

  recalcEPS();
  renderInventory();
  renderStands();
  save();
});
      document.querySelector('.game').insertBefore(btn, document.querySelector('.inventory-wrap'));
    }
    btn.style.display = 'inline-block';
  } else if (btn) {
    btn.style.display = 'none';
  }
}

  
  function renderStands() {
  const area = document.getElementById('stands');
  area.innerHTML = '';
  for (let i = 0; i < STAND_COUNT; i++) {
    const box = document.createElement('div');
    box.className = 'stand';

    // The UID of the item placed on this stand (or null)
    const placed = state.stands[i];

    // Create the pedestal (always present)
    const ped = document.createElement('div');
    ped.className = 'pedestal';
    box.appendChild(ped);

    // If there is an item placed on this stand...
    if (placed) {
      // Find the item object (from placed or inventory)
      const it = state.placed[placed] || state.inventory.find(x => x.uid === placed);
      if (it) {
        // Create the div for the placed item
        const p = document.createElement('div');
        p.className = 'placed';
        p.innerHTML =
          `<img src='${it.svg}' style='width:64px;height:64px;border-radius:8px;margin-right:8px;' alt='${escapeXml(displayName(it.name))}'/>
           <div style="text-align:left">
             <strong>${escapeXml(displayName(it.name))}</strong><br>
             <span class="rar t-${it.rarity}">${RARITY[it.rarity].label}</span>
           </div>`;

        p.style.border = '4px solid rgba(0,0,0,.45)';
        p.style.color = '#fff';

        // --- BADGE ANIMATION LOGIC ---
        // Select the badge element (the rarity label)
        const badge = p.querySelector('.rar');

const rkey = String(it.rarity || '').toLowerCase();

// birthday
if (rkey === 'birthday') {
  badge.classList.add('t-birthday');
}

// legacy (rainbow)
if (rkey === 'legacy') {
  badge.style.color = 'transparent';
  badge.style.background = 'linear-gradient(90deg, #ff004c, #ff7a00, #ffd400, #18e300, #00e7ff, #3a31ff, #ff31ff, #ff004c)';
  badge.style.backgroundSize = '400% 100%';
  badge.style.webkitBackgroundClip = 'text';
  badge.style.backgroundClip = 'text';
  badge.style.animation = 'rainbowShift 4s linear infinite';
}

// mythic (gold shimmer)
if (rkey === 'mythic') {
  badge.classList.add('t-mythic');
  p.classList.add('glow');
}

// unique: sparkle-ish badge + glow
if (rkey === 'unique') {
  badge.classList.add('t-unique');
  // no glow
}

// exotic: cyan glow + badge
if (rkey === 'exotic') {
  badge.classList.add('t-exotic');
  p.classList.add('glow-exotic');  // apply to the <p> element with the SVG
}

        box.appendChild(p);
      }
    }

    // Add click listener for placing/removing items
    box.addEventListener('click', () => {
      // If no item selected, remove placed item (if any)
      if (!state.selectedItemUid) {
        if (state.stands[i]) {
          const oldUid = state.stands[i];
          const oldItem = state.placed[oldUid] || null;
          if (oldItem) {
            state.inventory.push(oldItem);
            delete state.placed[oldUid];
          }
          state.stands[i] = null;
          recalcEPS();
          renderInventory();
          renderStands();
          save();
        }
        return;
      }

      // Remove old placed item if there is one
      if (state.stands[i]) {
        const oldUid = state.stands[i];
        const oldItem = state.placed[oldUid] || null;
        if (oldItem) {
          state.inventory.push(oldItem);
          delete state.placed[oldUid];
        }
        state.stands[i] = null;
      }

      // Place new item
      const newItem = state.inventory.find(it => it.uid === state.selectedItemUid);
      if (!newItem) return;

      state.placed[newItem.uid] = newItem;
      state.stands[i] = newItem.uid;

      state.inventory = state.inventory.filter(it => it.uid !== newItem.uid);
      state.selectedItemUid = null;

      recalcEPS();
      renderInventory();
      renderStands();

      // Glow animation for mythic
      const placedDiv = box.querySelector('.placed');
      if (placedDiv) {
        placedDiv.classList.add('glow');
        setTimeout(() => placedDiv.classList.remove('glow'), 700);
      }
      save();
    });

    area.appendChild(box);
  }

  // --- PET ROW (below main pedestals) ---
  let petRow = document.querySelector('.pet-row');
  if(!petRow){
    petRow = document.createElement('div');
    petRow.className = 'pet-row';
  } else {
    petRow.innerHTML = '';
  }

  // We want pet pedestals aligned so that pet0 is under main stand #2 (index 1),
  // and pet1 is under main stand #3 (index 2). We'll render four columns and
  // only place pedestals in columns 2 and 3 when purchased.
  for(let col=0; col<4; col++){
    const pbox = document.createElement('div');
    pbox.className = 'pet-stand';
    // If column matches where pet pedestals go:
    let placeIndex = null;
    if(col === 1 && state.petPedestalsPurchased >= 1) placeIndex = 0;
    if(col === 2 && state.petPedestalsPurchased >= 2) placeIndex = 1;

    if(placeIndex !== null){
      const pPed = document.createElement('div');
      pPed.className = 'pet-pedestal';
      pbox.appendChild(pPed);

      const placed = state.petStands[placeIndex];
      if(placed){
        const p = document.createElement('div');
        p.className = 'pet-placed';
        // If it's an egg, show egg image and name; if pet, show pet and badge
        const nameLabel = escapeXml(displayName(placed.name || (placed.petType || 'Pet')));
        p.innerHTML = `<img src='${placed.svg}' alt='${nameLabel}'/><div style="text-align:left"><strong>${nameLabel}</strong><br><span style="font-size:12px;color:#fff;opacity:.9">${placed.isEgg ? (placed.eggType || 'Egg') : (placed.petType || '')}</span></div>`;
        pbox.appendChild(p);

        // If egg incubating show timer badge
        if(placed.isEgg && state.petTimers[placeIndex]){
          const timer = document.createElement('div');
          timer.className = 'pet-timer';
          timer.dataset.index = placeIndex;
          pbox.appendChild(timer);
        }

        // Add special glow for Flex T-Rex pet
        if(!placed.isEgg && placed.petType === 'Flex T-Rex'){
          p.classList.add('glow');
        }
      }

      // Click handling for pet pedestal
pbox.addEventListener('click', () => {
  // If no selected item: remove placed item back to inventory
  if (!state.selectedItemUid) {
    const existing = state.petStands[placeIndex];
    if (existing) {
      state.inventory.push(existing);
      state.petStands[placeIndex] = null;
      delete state.petTimers[placeIndex];
      recalcEPS();
      renderInventory();
      renderStands();
      save();
    }
    return;
  }

  const newItem = state.inventory.find(it => it.uid === state.selectedItemUid);
  if (!newItem) return;

  // âœ… Allow eggs or pets here
  if (!(newItem.isEgg || newItem.petType)) {
    alert('Only eggs or pets can be placed on pet pedestals.');
    return;
  }

  // If placing an egg, start hatch timer
  if (newItem.isEgg) {
    state.petStands[placeIndex] = newItem;
            if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
    state.petTimers[placeIndex] = Date.now() + HATCH_DURATION;
  } else {
    // If placing a pet, no timer needed
    state.petStands[placeIndex] = newItem;
            if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
  }

  // Remove from inventory
  state.inventory = state.inventory.filter(it => it.uid !== newItem.uid);
  state.selectedItemUid = null;

  recalcEPS();
  renderInventory();
  renderStands();
  save();
});

    }
    petRow.appendChild(pbox);
  }

  // Insert or reinsert petRow after main stands
  area.parentNode.insertBefore(petRow, area.nextSibling);

  checkForge();
  checkExoticForge();
}

function weightedPick(){
  const r = Math.random();
  if (r < 0.003) return 'unique';                       // 0.3%
  if (r < 0.003 + 0.005) return 'legacy';               // 0.5%
  if (r < 0.003 + 0.005 + 0.01) return 'legendary';     // 1% (cumulative)
  if (r < 0.003 + 0.005 + 0.01 + 0.08) return 'epic';    // 8%
  if (r < 0.003 + 0.005 + 0.01 + 0.08 + 0.10) return 'rare'; // 10%
  return 'common';
}
  function priceFor(rarity){ const [a,b] = RARITY[rarity].price; return Math.floor(a + Math.random()*(b-a)); }
  function makeShopItems(){
    const items = [];
    const pool = [...ITEM_NAMES];
    for(let i=0;i<SHOP_SLOTS;i++){
      const idx = Math.floor(Math.random()*pool.length);
      const name = pool.splice(idx,1)[0];
      const rarity = weightedPick();
      const baseIdx = idx;
      items.push({ uid: uid(), name, rarity, price: priceFor(rarity), svg: getItemSvg(name, baseIdx, rarity), baseIdx, purchased:false });
    }
    return items;
  }
  function ensureShop() {
  const now = Date.now();
  const REFRESH_INTERVAL = 90_000; // 1:30

  // Fix old saves or weird drift
  if (!state.shop.nextRefreshAt || state.shop.nextRefreshAt - now > REFRESH_INTERVAL) {
    state.shop.nextRefreshAt = now + REFRESH_INTERVAL;
  }

  // Refresh if needed
  if (now >= state.shop.nextRefreshAt || !state.shop.items?.length) {
    state.shop.items = makeShopItems();
    state.shop.nextRefreshAt = now + REFRESH_INTERVAL;
    save();
  }

  renderShop();
}
  function msToClock(ms){ ms = Math.max(0, ms); const s = Math.floor(ms/1000); const m = Math.floor(s/60); const sec = s%60; return `${m}:${String(sec).padStart(2,'0')}`; }
  let refreshTimer;
  function renderShop(){
    const grid = $('#shopGrid');
    grid.innerHTML='';
    state.shop.items.forEach((it, i)=>{
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `<div style='display:flex;gap:12px;align-items:center'>
        <img src='${it.svg}' style='width:72px;height:72px;border-radius:10px;flex:0 0 72px' alt='${escapeXml(displayName(it.name))}' />
        <div>
          <h3>${escapeXml(displayName(it.name))}</h3>
          <div class="tag t-${it.rarity}">${RARITY[it.rarity].label}</div>
        </div>
      </div>
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div class="price">$${fmt(it.price)}</div>
        <button class="buy">${it.purchased ? "Purchased!" : "Purchase"}</button>
      </div>`;
      const btn = card.querySelector('.buy');

      function setBtn(){
        if(it.purchased){
          btn.disabled = true;
          btn.textContent = 'Purchased!';
          btn.style.background = 'linear-gradient(#2ecc71,#1da85b)';
        } else {
          btn.disabled = state.money < it.price;
          btn.textContent = 'Purchase';
          btn.style.background = '';
        }
      }
      setBtn();

      btn.addEventListener('click',()=>{
        if(it.purchased) return;
        if(state.money < it.price) return;
        state.money -= it.price;
        const inv = { uid: uid(), name: it.name, rarity: it.rarity, price: it.price, svg: it.svg, baseIdx: it.baseIdx };
        state.inventory.push(inv);
        it.purchased = true;
        updateTop();
        renderInventory();
        save();
        setBtn();
      });
      grid.appendChild(card);
    });
    if(refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(()=>{
      const left = state.shop.nextRefreshAt - Date.now();
      $('#refreshNote').textContent = `Shop refreshes every ${msToClock(left)}`;
      if(left<=0){
        ensureShop();
      }
    }, 200);
  }

  let audioCtx, masterGain, musicOn=false;
  function initMusic(){ if(audioCtx) return; audioCtx = new (window.AudioContext || window.webkitAudioContext)(); masterGain = audioCtx.createGain(); masterGain.gain.value = 0.16; masterGain.connect(audioCtx.destination); const tempo = 90; const beat = 60/tempo; const pattern = [0,3,7,10,7,3]; const baseFreq = 220; function scheduleLoop(startTime){ for(let i=0;i<pattern.length;i++){ const t = startTime + i*beat*0.5; const freq = baseFreq * Math.pow(2, pattern[i]/12); const osc = audioCtx.createOscillator(); const g = audioCtx.createGain(); osc.type = 'square'; osc.frequency.value = freq; g.gain.value = 0; osc.connect(g); g.connect(masterGain); osc.start(t); g.gain.setValueAtTime(0.0, t); g.gain.linearRampToValueAtTime(0.08, t + 0.02); g.gain.linearRampToValueAtTime(0.0, t + beat*0.45); osc.stop(t + beat*0.5); } const pad = audioCtx.createOscillator(); const pg = audioCtx.createGain(); pad.type='sine'; pad.frequency.value = baseFreq*0.5; pg.gain.value=0.0; pad.connect(pg); pg.connect(masterGain); pad.start(startTime); pad.stop(startTime + pattern.length*beat*0.5); pg.gain.setValueAtTime(0.0, startTime); pg.gain.linearRampToValueAtTime(0.05, startTime + 0.1); pg.gain.linearRampToValueAtTime(0.0, startTime + pattern.length*beat*0.5); } function loop(){ const now = audioCtx.currentTime + 0.05; scheduleLoop(now); setTimeout(loop, (pattern.length*beat*0.5)*1000 - 40); } loop(); }
  function toggleMusic(){ if(!audioCtx){ initMusic(); } if(audioCtx.state === 'suspended') audioCtx.resume(); musicOn = !musicOn; masterGain.gain.value = musicOn ? 0.16 : 0.0; $('#musicBtn').style.filter = musicOn ? 'saturate(1.2)' : 'grayscale(1)'; }
  $('#musicBtn').addEventListener('click', ()=>{ toggleMusic(); });

  function checkForge(){
    const allLegendary = state.stands.every(uid=>{
      if(!uid) return false;
      const it = state.placed[uid] || state.inventory.find(x=>x.uid===uid);
      return it && it.rarity === 'legendary';
    });
    const btn = $('#forgeBtn');
    if(!btn) return;
    btn.style.display = allLegendary ? 'inline-block' : 'none';
  }
  function createMythicItem(){
    const idx = Math.floor(Math.random()*ITEM_NAMES.length);
    const name = ITEM_NAMES[idx] || ('Mythic Item');
    const baseIdx = idx;
    return { uid: uid(), name, rarity: 'mythic', price: 0, svg: getItemSvg(name, baseIdx, 'mythic'), baseIdx };
  }
  $('#forgeBtn').addEventListener('click', ()=>{
    if(!state.stands.every(uid => uid && (state.placed[uid]||state.inventory.find(x=>x.uid===uid)) && ((state.placed[uid]||state.inventory.find(x=>x.uid===uid)).rarity === 'legendary'))){
      return;
    }
    state.stands.forEach(uid => {
      if(uid && state.placed[uid]) delete state.placed[uid];
    });
    state.stands = Array(STAND_COUNT).fill(null);
    const mythic = createMythicItem();
    state.placed[mythic.uid] = mythic;
    state.stands[0] = mythic.uid;
    recalcEPS();
    renderInventory();
    renderStands();
    save();
  });
    
  

  $('#openShop').addEventListener('click',()=>{
    $('#shopOverlay').classList.add('show');
    ensureShop();
    $('#shopOverlay').setAttribute('aria-hidden','false');
  });
  $('#closeShop').addEventListener('click',()=>{
    $('#shopOverlay').classList.remove('show');
    $('#shopOverlay').setAttribute('aria-hidden','true');
  });
  $('#toolsBtn').addEventListener('click',()=>{
    state.fastMode = !state.fastMode;
    ensureShop();
    const msg = state.fastMode? 'Fast refresh: 15s' : 'Normal refresh: 5 min';
    $('#toolsBtn').title = 'Tools ('+msg+')';
    save();
  });

/* -------------------
   GEAR FEATURES
------------------- */
const MULTIPLIER_COST = 3_000_000;
const MULTIPLIER_DURATION = 20 * 60 * 1000; // 20 minutes
const MULTIPLIER_COOLDOWN = 30 * 60 * 1000; // 30 minutes
const BACKGROUND_COST = 4_000_000;

const RED_MONEY_COST = 1_000_000_000_000;
let redMoneyPurchased = false;
let redMoneyEnabled = false;

let multiplierActiveUntil = 0;
let multiplierCooldownUntil = 0;
let multiplierLevel = 1; // 1x, 2x, 4x max

function applyMultiplier(eps) {
  return eps * multiplierLevel;
}

let multiplierTimer;

function updateMultiplierStatus() {
  const status = document.getElementById("multiplierStatus");
  const btn = document.getElementById("buyMultiplier");
  if (!status || !btn) return;

  if (multiplierTimer) clearInterval(multiplierTimer);

  function refresh() {
    const now = Date.now();

    // ðŸŸ¢ Case: 2x Active (allow upgrading to 4x)
    if (multiplierLevel === 2 && now < multiplierActiveUntil) {
      const left = Math.ceil((multiplierActiveUntil - now) / 1000);
      const min = Math.floor(left / 60);
      const sec = left % 60;
      status.textContent = `Active: 2x (${min}:${String(sec).padStart(2,"0")} left)`;

      btn.disabled = state.money < MULTIPLIER_COST;
      btn.textContent = "Upgrade to 4x";
      btn.style.background = "linear-gradient(#2ecc71,#1da85b)";

    // ðŸŸ¢ Case: 4x Active (fully maxed)
    } else if (multiplierLevel === 4 && now < multiplierActiveUntil) {
      const left = Math.ceil((multiplierActiveUntil - now) / 1000);
      const min = Math.floor(left / 60);
      const sec = left % 60;
      status.textContent = `Active: 4x (${min}:${String(sec).padStart(2,"0")} left)`;

      btn.disabled = true;
      btn.textContent = "4x Active";
      btn.style.background = "linear-gradient(#2ecc71,#1da85b)";

    // Cooldown
    } else if (now < multiplierCooldownUntil) {
      const left = Math.ceil((multiplierCooldownUntil - now) / 1000);
      const min = Math.floor(left / 60);
      const sec = left % 60;
      status.textContent = `Cooldown: ${min}:${String(sec).padStart(2,"0")}`;

      btn.disabled = true;
      btn.textContent = "Cooldown";
      btn.style.background = "";

    // Ready to buy again (no active, no cooldown)
    } else {
      status.textContent = "";
      btn.disabled = state.money < MULTIPLIER_COST;
      btn.textContent = "Purchase";
      btn.style.background = "";
    }
  }

  refresh();
  multiplierTimer = setInterval(refresh, 1000);
}



function buyMultiplier() {
  const now = Date.now();
  if (state.money < MULTIPLIER_COST) return;

  // If already at 4x, stop
  if (multiplierLevel >= 4) return;

  // If no multiplier active yet
  if (multiplierLevel < 2) {
    // Block cooldown if one is still running
    if (now < multiplierCooldownUntil) return;

    multiplierLevel = 2;
    multiplierActiveUntil = now + MULTIPLIER_DURATION;
    multiplierCooldownUntil = now + MULTIPLIER_COOLDOWN;

  // If already at 2x, upgrade to 4x without resetting timers
  } else if (multiplierLevel === 2) {
    multiplierLevel = 4;
    // Do NOT change multiplierActiveUntil or multiplierCooldownUntil
  }

  state.money -= MULTIPLIER_COST;

  // ðŸŸ¢ Apply EPS boost immediately
  recalcEPS();
  updateTop();
  updateMultiplierStatus();
  save();
}

// Background feature
let backgroundPurchased = false;
let backgroundEnabled = false;

function buyBackground() {
  if (backgroundPurchased) return;
  if (state.money < BACKGROUND_COST) return;
  state.money -= BACKGROUND_COST;
  backgroundPurchased = true;
  backgroundEnabled = true;
  document.body.classList.add("redblue");
  updateTop();
  document.getElementById("buyBackground").style.display = "none";
  document.getElementById("toggleBackground").style.display = "inline-block";
  save();
}

function toggleBackground() {
  if (!backgroundPurchased) return;
  backgroundEnabled = !backgroundEnabled;

  if (backgroundEnabled) {
    document.body.classList.add("redblue");
    document.getElementById("toggleBackground").textContent = "Disable";
  } else {
    document.body.classList.remove("redblue");
    document.getElementById("toggleBackground").textContent = "Enable";
  }

  save();
}



function updateRedMoneyUI(){
  const buy = document.getElementById("buyRedMoney");
  const tog = document.getElementById("toggleRedMoney");
  if(!buy || !tog) return;
  if(redMoneyPurchased){
    buy.style.display = "none";
    tog.style.display = "inline-block";
    tog.textContent = redMoneyEnabled ? "Disable" : "Enable";
    tog.disabled = false;
  }else{
    buy.style.display = "inline-block";
    tog.style.display = "none";
    buy.disabled = (state.money||0) < RED_MONEY_COST;
  }
  document.body.classList.toggle("money-red", !!redMoneyEnabled);
}

function buyRedMoney(){
  if(redMoneyPurchased) return;
  if((state.money||0) < RED_MONEY_COST) return;
  state.money -= RED_MONEY_COST;
  redMoneyPurchased = true;
  redMoneyEnabled = true;
  updateTop();
  updateRedMoneyUI();
  save();
}

function toggleRedMoney(){
  if(!redMoneyPurchased) return;
  redMoneyEnabled = !redMoneyEnabled;
  updateRedMoneyUI();
  save();
}

// Open/close Gear overlay
document.getElementById("toolsBtn").addEventListener("click", () => {
  document.getElementById("gearOverlay").classList.add("show");
  document.getElementById("gearOverlay").setAttribute("aria-hidden", "false");
  updateMultiplierStatus();
  updateRedMoneyUI();
});
document.getElementById("closeGear").addEventListener("click", () => {
  document.getElementById("gearOverlay").classList.remove("show");
  document.getElementById("gearOverlay").setAttribute("aria-hidden", "true");
});

// Gear button actions
document.getElementById("buyMultiplier").addEventListener("click", buyMultiplier);
document.getElementById("buyBackground").addEventListener("click", buyBackground);
document.getElementById("toggleBackground").addEventListener("click", toggleBackground);
document.getElementById("buyRedMoney")?.addEventListener("click", buyRedMoney);
document.getElementById("toggleRedMoney")?.addEventListener("click", toggleRedMoney);

// Hook multiplier into EPS calculation
// --- Multiplier-aware EPS calculation ---
let baseEPS = 0;

const _recalcEPS = recalcEPS;
recalcEPS = function() {
  // Recalculate base EPS without multiplier
  let total = 0;
  state.stands.forEach(uid => {
    if (!uid) return;
    const it = state.placed[uid] || state.inventory.find(x => x.uid === uid);
    if (!it) return;
    total += RARITY[it.rarity].income;
  });
  baseEPS = total;

  // Sum pet EPS
  let petTotal = 0;
  state.petStands.forEach(ps => {
    if(!ps) return;
    if(ps.petEps) petTotal += ps.petEps;
  });

  let combined = baseEPS + petTotal;
  combined = combined * multiplierLevel * (state.permanentPetMultiplier || 1);
  state.eps = Math.floor(combined);

  updateTop();
  save();
};



/* -----------------------
   PET SHOP LOGIC
   ----------------------- */

const PET_PEDESTAL_COST = 15_000_000;
const EGG_COSTS = {legendary: 10_000_000, mythical: 15_000_000, enchanted: 25_000_000, universal: 1_000_000_000 };
const HATCH_DURATION = 10 * 60 * 1000;
const FOURTH_HATCH_DURATION = 2 * 60 * 1000; // 10 minutes (ms)

// pet outcome tables & EPS values

// === PetDex tracking & counts ===
function ensurePetDex(){ if(!state.petDex) state.petDex = {}; return state.petDex; }
function registerPetOwned(name){ const dex = ensurePetDex(); if(name) dex[name]=true; }
function petCountsByEgg(){
  const totals={}, owned={};
  const dex = ensurePetDex();
  for(const [egg, list] of Object.entries(PET_TABLES)){
    if(egg === 'galaxy') continue; // Exclude Galaxy Egg from Pet Quests tallies
    const names=[];
    list.forEach(e => { if(e.name==='IRL' && Array.isArray(e.subset)) names.push(...e.subset); else names.push(e.name); });
    totals[egg]=names.length; owned[egg]=names.filter(n => !!dex[n]).length;
  }
  return {totals, owned};
}
function hasAllPets(){ const pc = petCountsByEgg(); return Object.keys(pc.totals).every(k => pc.owned[k]===pc.totals[k]); }
const PET_TABLES = { legendary: [
    { name: 'Dog',    chance: 0.70, eps: 300 },
    { name: 'Cat',    chance: 0.20, eps: 1200 },
    { name: 'Gold Dog', chance: 0.10, eps: 4000 }
  ],
  mythical: [
    { name: 'Lion', chance: 0.80, eps: 2000 },
    { name: 'Bear', chance: 0.15, eps: 6000 },
    { name: 'Dino', chance: 0.05, eps: 15000 }
  ],
  enchanted: [
    { name: 'Owl', chance: 0.94, eps: 1000 },
    { name: 'Rainbow Panda', chance: 0.05, eps: 12000 },
    { name: 'Flex T-Rex', chance: 0.01, eps: 50000 } // special: grants permanent 5x
  ]
  , universal: [
    { name: 'Lizard', chance: 0.52, eps: 10_000 },
    { name: 'Alien', chance: 0.44, eps: 15_000 },
    { name: 'IRL', subset: ['Hudson','Drake','Molly'], chance: 0.03, eps: 45_000 },
    { name: 'Flex Dragon', chance: 0.01, eps: 65_000 } // grants permanent 5x
  ]

};

function weightedPetPick(eggType){
  const list = PET_TABLES[eggType];
  const r = Math.random();
  let acc = 0;
  for(const p of list){
    acc += p.chance;
    if(r <= acc) return p;
  }
  return list[list.length-1];
}

function updatePetButtonsUI(){
  const btn = document.getElementById('buyPetPedestal');
  const status = document.getElementById('petPedestalStatus');
  if(!btn || !status) return;
  btn.disabled = state.petPedestalsPurchased >= 2 || state.money < PET_PEDESTAL_COST;
  if(state.petPedestalsPurchased >= 2){
    status.textContent = 'Max pedestals purchased';
    btn.textContent = 'Purchased';
    btn.style.background = 'linear-gradient(#2ecc71,#1da85b)';
  } else {
    status.textContent = `Purchased: ${state.petPedestalsPurchased}/2`;
    btn.textContent = 'Purchase';
    btn.style.background = '';
  }

  // egg buttons enable based on money
  document.getElementById('buyLegendEgg').disabled = state.money < EGG_COSTS.legendary;
  document.getElementById('buyMythEgg').disabled = state.money < EGG_COSTS.mythical;
  document.getElementById('buyEnchantedEgg').disabled = state.money < EGG_COSTS.enchanted;
}

// buy pedestal
function buyPetPedestal(){
  if(state.petPedestalsPurchased >= 2) return;
  if(state.money < PET_PEDESTAL_COST) return;
  state.money -= PET_PEDESTAL_COST;
  state.petPedestalsPurchased++;
  updateTop();
  updatePetButtonsUI();
  renderStands();
  save();
}

// buy egg functions: create egg inventory item
function buyEgg(type){
  const cost = EGG_COSTS[type];
  if(state.money < cost) return;
  state.money -= cost;
  const inv = {
    uid: uid(),
    name: (type.charAt(0).toUpperCase() + type.slice(1)) + ' Egg',
    isEgg: true,
    eggType: type,
    svg: getEggSvg(type, Math.floor(Math.random()*99999)),
    baseIdx: 0
  };
  state.inventory.push(inv);
  updateTop();
  renderInventory();
  save();
}

// Check pet timers and hatch if needed
function checkPetHatches(){
  const now = Date.now();
  let changed=false;
  for(const idxStr in state.petTimers){
    const idx = Number(idxStr);
    const t = state.petTimers[idx];
    if(!t) continue;
    // update timer UI elements (if any)
    const timerEl = document.querySelector(`.pet-timer[data-index='${idx}']`);
    if(timerEl){
      const left = Math.max(0, t - now);
      const s = Math.floor(left/1000);
      const m = Math.floor(s/60);
      const sec = s%60;
      timerEl.textContent = `${m}:${String(sec).padStart(2,'0')}`;
    }
    if(now >= t){
      // hatch
      const placed = state.petStands[idx];
      if(placed && placed.isEgg){
        // determine result
        const result = weightedPetPick(placed.eggType || 'legendary');
        let hatchName = result.name;
        if (result.name === 'IRL' && Array.isArray(result.subset)) {
          hatchName = result.subset[Math.floor(Math.random()*result.subset.length)];
        }
        registerPetOwned(hatchName);
        const petObj = {
          uid: uid(),
          name: hatchName,
          isEgg: false,
          eggType: null,
          petType: hatchName,
          petEps: result.eps,
          svg: getPetSvg(hatchName, Math.floor(Math.random()*99999))
        };
        // apply Flex T-Rex permanent multiplier if hatched
        if(result.name === 'Flex T-Rex' || result.name === 'Flex Dragon'){
          state.permanentPetMultiplier = 5;
        }
        state.petStands[idx] = petObj;
        delete state.petTimers[idx];
        changed=true;
        if(hasAllPets()){
          state.ach = state.ach || {};
          if(!state.ach.petFourthUnlocked){ state.ach.petFourthUnlocked = true; }
        }
      } else {
        delete state.petTimers[idx];
      }
    }
  }
  if(changed){
    recalcEPS();
    renderInventory();
    renderStands();
    save();
  }
}

// Hook up pet UI open/close
$('#openPetShop').addEventListener('click', ()=>{
  $('#petOverlay').classList.add('show');
  $('#petOverlay').setAttribute('aria-hidden','false');
  updatePetButtonsUI();
});
$('#closePetShop').addEventListener('click', ()=>{
  $('#petOverlay').classList.remove('show');
  $('#petOverlay').setAttribute('aria-hidden','true');
});

document.getElementById('buyPetPedestal').addEventListener('click', buyPetPedestal);
document.getElementById('buyLegendEgg').addEventListener('click', ()=>buyEgg('legendary'));
document.getElementById('buyMythEgg').addEventListener('click', ()=>buyEgg('mythical'));
document.getElementById('buyEnchantedEgg').addEventListener('click', ()=>buyEgg('enchanted'));
document.getElementById('buyUniversalEgg').addEventListener('click', ()=>buyEgg('universal'));

/* -----------------------
   BOOT
----------------------- */


function reconcilePetDex(){
  try{
    if(!state.petDex) state.petDex = {};
    const add = (n)=>{ if(n) state.petDex[n]=true; };
    // from inventory
    (state.inventory||[]).forEach(it=>{ if(it && !it.isEgg){ add(it.petType || it.name); } });
    // from placed main pedestals
    Object.values(state.placed||{}).forEach(it=>{ if(it && !it.isEgg){ add(it.petType || it.name); } });
    // from pet pedestals
    (state.petStands||[]).forEach(p=>{ if(p && !p.isEgg){ add(p.petType || p.name); } });
  }catch(e){}
}
async function boot(){
  await load();
  reconcilePetDex();
  if(!state.money) state.money = MONEY_START;
  if(!state.stands || state.stands.length!==STAND_COUNT){
    state.stands = Array(STAND_COUNT).fill(null);
  }
  if(!state.placed) state.placed = {};
  updateTop();
  renderInventory();
  renderStands();
  recalcEPS();
  ensureShop();
  updateMultiplierStatus();

  requestAnimationFrame(tick);
}
boot();

document.getElementById("resetUserBtn").addEventListener("click", function() {
  if (confirm("Are you sure you want to reset your username? This will delete your save from this browser and you will have to enter a new name.")) {
    localStorage.removeItem("flex-userid");
    localStorage.removeItem("flex-save-v1");
    location.reload();
  }
});

  
window.addEventListener("beforeunload", save);
  window.addEventListener("beforeunload", save);

// Ensure Pet Shop opens scrolled to the top so the X is visible
(function(){
  const btn = document.getElementById('openPetShop');
  if (btn) {
    btn.addEventListener('click', () => {
      const overlay = document.getElementById('petOverlay');
      const sheet = overlay ? overlay.querySelector('.shop') : null;
      if (sheet) sheet.scrollTop = 0;
      if (overlay) overlay.scrollTop = 0;
    });
  }
})();

</script>

<!-- Right-side buttons -->
<div class="right-rail">
  <!-- Achievements -->
  <button id="openAchievements" class="icon-achievements" title="Achievements" onclick="document.getElementById('achOverlay').classList.add('show'); window.__achRefresh && window.__achRefresh();">
    <svg viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="8" r="6"></circle><path d="M8 14v6l4-2 4 2v-6"></path>
    </svg>
  </button>

  <!-- Background Changer (middle) -->
  <button id="openBgSelector" class="bg-selector-btn" title="Backgrounds" onclick="document.getElementById('bgOverlay').classList.add('show'); window.__renderBgGrid && window.__renderBgGrid();">
    <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 21H3V3h18zM7 17l3-4 2 3 3-5 2 6H7z"></path>
    </svg>
  </button>

  <!-- Delete Mode (bottom) -->
  <button id="deleteToggleBtn" class="delete-toggle-btn" aria-pressed="false" title="Toggle deletion mode">
  <svg viewBox="0 0 24 24" width="40" height="40" fill="none" stroke="#e84545" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <polyline points="3 6 5 6 21 6"></polyline>
    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
    <line x1="10" y1="11" x2="10" y2="17"></line>
    <line x1="14" y1="11" x2="14" y2="17"></line>
  </svg>
  </button>
</div>



<!-- Achievements Overlay -->
<div class="overlay" id="achOverlay" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="achTitle">
    <button class="closeX" id="closeAchievements" aria-label="Close" onclick="document.getElementById('achOverlay').classList.remove('show')">âœ•</button>
    <h2 id="achTitle">Achievements</h2>
    <div class="achv-wrap">
      <div class="rarity-rail" id="rarityRail">
        <div class="rail-btn" data-tab="quests"><span>QUESTS</span><span class="badge-dot" id="questsDot"></span></div>
<div class="rail-btn" data-tab="petquests"><span>PET QUESTS</span><span class="badge-dot" id="dot-petquests"></span></div>
        <div class="rail-btn" data-tab="common"><span>COMMON</span><span class="badge-dot" id="dot-common"></span></div>
        <div class="rail-btn" data-tab="rare"><span>RARE</span><span class="badge-dot" id="dot-rare"></span></div>
        <div class="rail-btn" data-tab="epic"><span>EPIC</span><span class="badge-dot" id="dot-epic"></span></div>
        <div class="rail-btn" data-tab="legendary"><span>LEGENDARY</span><span class="badge-dot" id="dot-legendary"></span></div>
        <div class="rail-btn" data-tab="legacy"><span>LEGACY</span><span class="badge-dot" id="dot-legacy"></span></div>
        <div class="rail-btn" data-tab="unique"><span>UNIQUE</span><span class="badge-dot" id="dot-unique"></span></div>
        <div class="rail-btn" data-tab="exotic"><span>EXOTIC</span><span class="badge-dot" id="dot-exotic"></span></div>
        <div class="rail-btn" data-tab="mythic"><span>MYTHIC</span><span class="badge-dot" id="dot-mythic"></span></div>
      </div>
      <div id="achContent"></div>
    </div>
  </div>
</div>




<!-- Background Selector Overlay -->
<div class="overlay" id="bgOverlay" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="bgTitle">
    <button class="closeX" id="closeBg" aria-label="Close" onclick="document.getElementById('bgOverlay').classList.remove('show')">âœ•</button>
    <h2 id="bgTitle">Backgrounds</h2>
    <div id="bgGrid" class="bg-grid"></div>
  </div>
</div>


<script>
(function(){
  const RLIST=['common','rare','epic','legendary','legacy','unique','exotic','mythic'];
  const R2BG={common:'green',rare:'blue',epic:'purple',legendary:'orange',legacy:'legacy',unique:'unique',exotic:'exotic',mythic:'mythic'};
  const BG={green:{c:'bg-green',l:'GREEN'},blue:{c:'bg-blue',l:'BLUE'},purple:{c:'bg-purple',l:'PURPLE'},orange:{c:'bg-orange',l:'ORANGE'},legacy:{c:'bg-legacy',l:'LEGACY'},unique:{c:'bg-unique',l:'UNIQUE'},exotic:{c:'bg-exotic',l:'EXOTIC'},mythic:{c:'bg-mythic',l:'MYTHIC'},redblue:{c:'redblue',l:'RED/BLUE'},rainbow:{c:'bg-rainbow',l:'RAINBOW'}};

  window.state=window.state||{};
  state.ach=state.ach||{questsDone:{},petPedestalGranted:false};
  state.unlockedBackgrounds=state.unlockedBackgrounds||{default:true};
  state.selectedBackground=state.selectedBackground||'default';

  const $=s=>document.querySelector(s);
  const $$=s=>Array.from(document.querySelectorAll(s));
  const keyOf=r=>String(r||'').toLowerCase();

  function countAll(fn){let n=0;(state.inventory||[]).forEach(i=>{try{if(fn(i))n++;}catch{}});Object.values(state.placed||{}).forEach(i=>{try{if(fn(i))n++;}catch{}});return n;}
  function countR(r){return countAll(i=>keyOf(i.rarity)===r);}
  function hasPlaced(r){return Object.values(state.placed||{}).some(i=>keyOf(i.rarity)===r);}
  function eggs(){return countAll(i=>!!i.isEgg);}

  function unlockBG(k){state.unlockedBackgrounds[k]=true;__renderBgGrid&&__renderBgGrid(); if(typeof save==='function') save();}
  function applyBG(k){
    document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-rainbow','redblue');
    if(k==='default'){state.selectedBackground='default';return;}
    const d=BG[k]; if(!d) return;
    document.body.classList.add(d.c); state.selectedBackground=k;
  }

  const GLOBAL=[
    {id:'g_c15',label:'Purchase 15 Common',check:()=>countR('common')>=15},
    {id:'g_r15',label:'Purchase 15 Rare',check:()=>countR('rare')>=15},
    {id:'g_e5', label:'Own 5 Epic',check:()=>countR('epic')>=5},
    {id:'g_l2', label:'Own 2 Legendary',check:()=>countR('legendary')>=2},
    {id:'g_eg5',label:'Purchase 5 Eggs',check:()=>eggs()>=5},
    {id:'g_pl4',label:'Fill all 4 pedestals',check:()=>Array.isArray(state.stands)&&state.stands.every(Boolean)},
    {id:'g_maxpet',label:'Max Pet Pedestals',check:()=>(state.petPedestalsPurchased||0)>=2},
    {id:'g_u1', label:'Own a Unique',check:()=>countR('unique')>=1},
    {id:'g_ex1',label:'Own an Exotic',check:()=>countR('exotic')>=1},
    {id:'g_my1',label:'Own a Mythic',check:()=>countR('mythic')>=1}
  ];

  function __isDone(q){ return (state.ach && state.ach.questsDone && !!state.ach.questsDone[q.id]) || (!!q.check && q.check()); }

  const RQ={
    common:[
      {id:'c_own15',label:'Own 15 Common',check:()=>countR('common')>=15},
      {id:'c_place',label:'Place a Common',check:()=>hasPlaced('common')},
      {id:'c_own30',label:'Own 30 Common',check:()=>countR('common')>=30}
    ],
    rare:[
      {id:'r_own15',label:'Own 15 Rare',check:()=>countR('rare')>=15},
      {id:'r_place',label:'Place a Rare',check:()=>hasPlaced('rare')},
      {id:'r_own25',label:'Own 25 Rare',check:()=>countR('rare')>=25}
    ],
    epic:[
      {id:'e_own5',label:'Own 5 Epic',check:()=>countR('epic')>=5},
      {id:'e_place',label:'Place an Epic',check:()=>hasPlaced('epic')},
      {id:'e_own10',label:'Own 10 Epic',check:()=>countR('epic')>=10}
    ],
    legendary:[
      {id:'l_own2',label:'Own 2 Legendary',check:()=>countR('legendary')>=2},
      {id:'l_place',label:'Place a Legendary',check:()=>hasPlaced('legendary')},
      {id:'l_own4',label:'Own 4 Legendary',check:()=>countR('legendary')>=4}
    ],
    legacy:[
      {id:'lc_own1',label:'Own 1 Legacy',check:()=>countR('legacy')>=1},
      {id:'lc_place',label:'Place a Legacy',check:()=>hasPlaced('legacy')},
      {id:'lc_own2',label:'Own 2 Legacy',check:()=>countR('legacy')>=2}
    ],
    unique:[
      {id:'u_own1',label:'Own 1 Unique',check:()=>countR('unique')>=1},
      {id:'u_place',label:'Place a Unique',check:()=>hasPlaced('unique')},
      {id:'u_own2',label:'Own 2 Unique',check:()=>countR('unique')>=2}
    ],
    exotic:[
      {id:'x_own1',label:'Own 1 Exotic',check:()=>countR('exotic')>=1},
      {id:'x_place',label:'Place an Exotic',check:()=>hasPlaced('exotic')},
      {id:'x_own2',label:'Own 2 Exotic',check:()=>countR('exotic')>=2}
    ],
    mythic:[
      {id:'m_own1',label:'Own 1 Mythic',check:()=>countR('mythic')>=1},
      {id:'m_place',label:'Place a Mythic',check:()=>hasPlaced('mythic')},
      {id:'m_own2',label:'Own 2 Mythic',check:()=>countR('mythic')>=2}
    ]
  };

  // Persist completions for ANY quest that is currently true (runs even when overlay is closed)
  function persistAllCompletions(){
    let changed=false;
    GLOBAL.forEach(q=>{ if(q.check && q.check() && !(state.ach.questsDone||{})[q.id]){ state.ach.questsDone[q.id]=true; changed=true; } });
    RLIST.forEach(r=>{ (RQ[r]||[]).forEach(q=>{ if(q.check && q.check() && !(state.ach.questsDone||{})[q.id]){ state.ach.questsDone[q.id]=true; changed=true; } }); });
    if(changed){ window.__addonSave&&__addonSave(); if(typeof save==='function') save(); }
  }

  function qRow(q){
    const now = !!(q.check && q.check());
    if(now){ state.ach.questsDone[q.id]=true; window.__addonSave&&__addonSave(); if(typeof save==='function') save(); }
    const ok = __isDone(q);
    const d=document.createElement('div');
    d.className='quest-card';
    d.innerHTML='<div class=\"q-left\">'
      + '<div class=\"q-check '+(ok?'ok':'')+'\">'+(ok?'âœ“':'')+'</div>'
      + '<div style=\"font-size:20px;font-weight:900;\">'+q.label+'</div>'
      + '</div>';
    return d;
  }

  function gDone(){ return GLOBAL.every(q => __isDone(q)); }

  function refresh(){
    // First, persist any newly-true quests permanently
    persistAllCompletions();

    const md=(id,done)=>{const el=document.getElementById(id); if(el) el.classList.toggle('done',!!done);};
    md('questsDot', gDone());
    RLIST.forEach(r=>{ const all=(RQ[r]||[]).every(q=>__isDone(q)); md('dot-'+r, all); });

    if(gDone() && !state.ach.petPedestalGranted){
  state.ach.petPedestalGranted=true;
  state.ach.petThirdUnlocked=true;
  if(!Array.isArray(state.petStands)) state.petStands=[null,null,null];
  if(!Array.isArray(state.petTimers)) state.petTimers=[null,null,null];
  if(typeof renderStands==='function') renderStands();
  if(typeof recalcEPS==='function') recalcEPS();
 window.__addonSave&&__addonSave();}

    Object.entries(R2BG).forEach(([r,b])=>{ if((RQ[r]||[]).every(q=>__isDone(q))) unlockBG(b); window.__addonSave&&__addonSave(); });
    if(RLIST.every(r => (RQ[r]||[]).every(q=>__isDone(q)))) unlockBG('rainbow'); window.__addonSave&&__addonSave();

    const active=document.querySelector('.rail-btn.active');
    if(active) renderTab(active.dataset.tab);

    if(typeof save==='function') save();
  }
  window.__achRefresh=refresh;

  function renderTab(tab){
    const host=document.getElementById('achContent'); if(!host) return;
    host.innerHTML='';
    if(tab==='quests'){
      const head=document.createElement('div');
      head.innerHTML='<h3 style=\"margin:8px 0 10px;font-family:Bungee;letter-spacing:1px;\">Quests</h3>'
        + '<div style=\"opacity:.85;margin-bottom:10px\">Complete the 10 quests to earn <span class=\"reward-pill\">+1 Pet Pedestal</span>.</div>';
      host.appendChild(head);
      GLOBAL.forEach(q=>host.appendChild(qRow(q)));
      const done=GLOBAL.filter(q=>__isDone(q)).length;
      const f=document.createElement('div'); f.style.cssText='margin-top:12px;font-weight:900;opacity:.9;';
      f.textContent='Progress: '+done+' / '+GLOBAL.length; host.appendChild(f);
      return;
    }
    if(tab!=='petquests'){
    const hdr=document.createElement('div');
    hdr.innerHTML='<h3 style=\"margin:8px 0 10px;font-family:Bungee;letter-spacing:1px;\">'+tab.toUpperCase()+'</h3>'
      + '<div style=\"opacity:.85;margin-bottom:10px\">Complete these to unlock a themed background '+(R2BG[tab]?'for this rarity':'')+'.</div>';
    host.appendChild(hdr);
    (RQ[tab]||[]).forEach(q=>host.appendChild(qRow(q)));
    const c=(RQ[tab]||[]).filter(q=>__isDone(q)).length;
    const f=document.createElement('div'); f.style.cssText='margin-top:12px;font-weight:900;opacity:.9;';
    f.textContent='Progress: '+c+' / '+(RQ[tab]||[]).length; host.appendChild(f);
    }
  
    if(tab==='petquests'){
      const head=document.createElement('div');
      head.innerHTML='<h3 style="margin:8px 0 10px;font-family:Bungee;letter-spacing:1px;">Pet Quests</h3>'
        + '<div style="opacity:.85;margin-bottom:10px">Collect pets from each egg. Complete them all to unlock a <span class="reward-pill">4th Pet Pedestal</span> (2â€‘minute hatch).</div>';
      host.appendChild(head);

      const pc = petCountsByEgg();
      Object.keys(PET_TABLES)
        .filter(k => k !== 'galaxy') // hide Galaxy Egg from Pet Quests UI
        .forEach(egg=>{
          const row=document.createElement('div');
        const owned = pc.owned[egg]||0, total = pc.totals[egg]||0;
        const pct = total? Math.floor((owned/total)*100) : 0;
        row.className='quest-card';
        row.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;width:100%;">'
          + '<div style="font-size:20px;font-weight:900;text-transform:capitalize;">'+egg+' Egg</div>'
          + '<div style="font-weight:900;">'+owned+' / '+total+'</div>'
          + '</div>'
          + '<div style="height:10px;background:rgba(0,0,0,.25);border-radius:8px;margin-top:6px;overflow:hidden;">'
          +   '<div style="height:100%;width:'+pct+'%;background:linear-gradient(90deg,#6dff79,#3ad0ff);"></div>'
          + '</div>';
        host.appendChild(row);
      });

      const all = hasAllPets();
      const f=document.createElement('div'); f.style.cssText='margin-top:12px;font-weight:900;opacity:.9;';
      f.textContent='Complete sets: '+ (all?'ALL DONE âœ…':'In progress');
      host.appendChild(f);
      const dot=document.getElementById('dot-petquests'); if(dot) dot.classList.toggle('done', all);
      if(all){ state.ach = state.ach || {}; state.ach.petFourthUnlocked = true; }
      return;
    }
}

  const rail=document.getElementById('rarityRail');
  if(rail){
    rail.addEventListener('click',e=>{
      const b=e.target.closest('.rail-btn'); if(!b) return;
      $$('.rail-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); renderTab(b.dataset.tab);
    });
    const first=rail.querySelector('[data-tab=\"quests\"]'); if(first){ first.classList.add('active'); renderTab('quests'); }
  }

  function __renderBgGrid(){
    const g=document.getElementById('bgGrid'); if(!g) return; g.innerHTML='';
    const tiles=[
      {k:'default',l:'DEFAULT',css:'background:linear-gradient(to bottom,#89CFF0,#90EE90);'},
      {k:'green',l:'GREEN',css:'background:linear-gradient(#3edc64,#1e6f2b);'},
      {k:'blue',l:'BLUE',css:'background:linear-gradient(#4aa3ff,#0b2e6e);'},
      {k:'purple',l:'PURPLE',css:'background:linear-gradient(#a76bff,#ff72c6);'},
      {k:'orange',l:'ORANGE',css:'background:linear-gradient(#ff9b3d,#b98200);'},
      {k:'legacy',l:'LEGACY',css:'background:linear-gradient(135deg,#ff7eb3,#ff2a68);'},
      {k:'unique',l:'UNIQUE',css:'background:linear-gradient(135deg,#0a1a4b,#123a8c);'},
      {k:'exotic',l:'EXOTIC',css:'background:linear-gradient(135deg,#cfefff,#a0a9b8);'},
      {k:'mythic',l:'MYTHIC',css:'background:linear-gradient(135deg,#FFD700,#B8860B);'},
      {k:'redblue',l:'RED/BLUE',css:'background:linear-gradient(#ff4b5c,#4b6aff);'},
      {k:'rainbow',l:'RAINBOW',css:'background:linear-gradient(135deg,#ff004c,#ff7a00,#ffd400,#18e300,#00e7ff,#3a31ff,#ff31ff);background-size:300% 300%;'}
    ];
    tiles.forEach(t=>{
      const el=document.createElement('div');
      el.className='bg-tile'+(!state.unlockedBackgrounds[t.k]?' locked':'');
      el.style.cssText+=t.css;
      el.innerHTML='<div style=\"font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)\">'+t.l+'</div>'
        + '<button class=\"buy bg-apply\" '+(!state.unlockedBackgrounds[t.k]?'disabled':'')+'>Apply</button>';
      el.querySelector('.bg-apply').onclick=()=>{ if(!state.unlockedBackgrounds[t.k])return; applyBG(t.k); if(typeof save==='function') save(); };
      g.appendChild(el);
    });
  }
  window.__renderBgGrid=__renderBgGrid;

  const tbtn=document.getElementById('toggleBackground');
  if(tbtn){ tbtn.addEventListener('click', ()=>{ state.unlockedBackgrounds.redblue=true; if(typeof save==='function') save(); }); }

  // Wrap lifecycle methods to ensure refresh runs on any major state change
  const _ri=window.renderInventory||function(){}; window.renderInventory=function(){ _ri(); refresh(); };
  const _rs=window.renderStands||function(){}; window.renderStands=function(){ _rs(); refresh(); };
  const _re=window.recalcEPS||function(){}; window.recalcEPS=function(){ _re(); refresh(); };

  // Initial sweep to persist any already-true quests
  setTimeout(()=>{ persistAllCompletions(); refresh(); },0);
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>


<script>
// --- Add-on: Third Pet Pedestal renderer (non-destructive) ---
(function(){
  const HATCH_DURATION = window.HATCH_DURATION || (60*1000*5); // fallback 5 min if not defined

  function ensureArrays(){
    if(!Array.isArray(state.petStands)) state.petStands=[];
    if(!Array.isArray(state.petTimers)) state.petTimers=[];
    while(state.petStands.length<3) state.petStands.push(null);
    while(state.petTimers.length<3) state.petTimers.push(null);
  }

  function renderThirdPetSlot(){
    if(!(state.ach && state.ach.petThirdUnlocked)) return;
    ensureArrays();
    const row = document.querySelector('.pet-row');
    if(!row) return;

    // If we already drew the second row once, clear it to avoid duplicates
    const old = row.querySelectorAll('.pet-stand.addon-second-row');
    old.forEach(n=>n.remove());

    // Create 4 boxes for the second row, but only col=1 gets the pedestal (index 2)
    for(let col=0; col<4; col++){
      const pbox=document.createElement('div');
      pbox.className='pet-stand addon-second-row';
      if(col===1){ // centered under the first two
        const placeIndex = 2;
        const pPed = document.createElement('div');
        pPed.className='pet-pedestal';
        pbox.appendChild(pPed);

        const placed = state.petStands[placeIndex];
        if(placed){
          const p = document.createElement('div');
          p.className='pet-placed';
          const nameLabel = (placed.name && placed.name.trim()) ? placed.name : (placed.petType||placed.eggType||'Pet');
          p.innerHTML = `<img src='${placed.svg}' alt='${nameLabel}' style="width:64px;height:64px;border-radius:12px;">`
                       + `<div class="name-badge"><span>${nameLabel}</span></div>`;
          pbox.appendChild(p);

          if(placed.isEgg && state.petTimers[placeIndex]){
            const timer=document.createElement('div');
            timer.className='pet-timer';
            timer.dataset.index=placeIndex;
            pbox.appendChild(timer);
          }
        }

        pbox.addEventListener('click', ()=>{
          // Remove if nothing selected
          if(!state.selectedItemUid){
            if(state.petStands[placeIndex]){
              state.inventory.push(state.petStands[placeIndex]);
              state.petStands[placeIndex]=null;
              state.petTimers[placeIndex]=null;
              if(typeof recalcEPS==='function') recalcEPS();
              if(typeof renderInventory==='function') renderInventory();
              if(typeof renderStands==='function') renderStands();
              if(typeof save==='function') save();
            }
            return;
          }

          const newItem = state.inventory.find(it => it.uid === state.selectedItemUid);
          if(!newItem) return;
          if(!(newItem.isEgg || newItem.petType)){
            alert('Only eggs or pets can be placed on pet pedestals.');
            return;
          }
          if(newItem.isEgg){
            state.petStands[placeIndex]=newItem;
            if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
            state.petTimers[placeIndex]=Date.now() + (window.HATCH_DURATION||HATCH_DURATION);
          }else{
            state.petStands[placeIndex]=newItem;
            if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
          }
          state.inventory = state.inventory.filter(it => it.uid !== newItem.uid);
          state.selectedItemUid = null;
          if(typeof recalcEPS==='function') recalcEPS();
          if(typeof renderInventory==='function') renderInventory();
          if(typeof renderStands==='function') renderStands();
          if(typeof save==='function') save();
        });
      }
      row.appendChild(pbox);
    }
  }

  // Wrap original renderStands safely
  const __origRenderStands = window.renderStands;
  if(typeof __origRenderStands==='function'){
    window.renderStands = function(){
      __origRenderStands.apply(this, arguments);
      try{ renderThirdPetSlot(); }catch(e){ /* no-op */ }
    };
  }

  // On load
  setTimeout(()=>{ try{ renderThirdPetSlot(); }catch(e){} }, 0);

  function renderFourthPetSlot(){
    if(!(state.ach && state.ach.petFourthUnlocked)) return;
    if(!Array.isArray(state.petStands)) state.petStands = [null,null,null,null];
    while(state.petStands.length<4) state.petStands.push(null);
    if(!Array.isArray(state.petTimers)) state.petTimers = [null,null,null,null];
    while(state.petTimers.length<4) state.petTimers.push(null);

    const row = document.querySelector('.pet-row'); if(!row) return;
    const old = row.querySelectorAll('.pet-stand.addon-fourth-slot'); old.forEach(n=>n.remove());

    for(let col=0; col<4; col++){
      const pbox=document.createElement('div');
      pbox.className='pet-stand addon-fourth-slot';
      if(col===2){
        const placeIndex = 3; // 4th slot
        const pPed = document.createElement('div'); pPed.className='pet-pedestal'; pbox.appendChild(pPed);
        const placed = state.petStands[placeIndex];
        if(placed){
          const p = document.createElement('div'); p.className='pet-placed';
          const nameLabel = (placed.name && placed.name.trim()) ? placed.name : (placed.petType||placed.eggType||'Pet');
          p.innerHTML = `<img src='${placed.svg}' alt='${nameLabel}' style="width:72px;height:72px;border-radius:12px;">`
            + `<div style="display:flex;flex-direction:column;margin-left:8px;">`
            + `<div style="font-weight:900;">${nameLabel}</div>`
            + `<div class="rar">${placed.isEgg ? (placed.eggType||'Egg') : (placed.petType||'')}</div>`
            + `</div>`;
          pbox.appendChild(p);
          if(placed.isEgg && state.petTimers[placeIndex]){
            const timer=document.createElement('div'); timer.className='pet-timer'; timer.dataset.index=placeIndex; pbox.appendChild(timer);
          }
        }
        pbox.addEventListener('click', ()=>{
          if(!state.selectedItemUid){
            if(state.petStands[placeIndex]){
              state.inventory.push(state.petStands[placeIndex]);
              state.petStands[placeIndex]=null; state.petTimers[placeIndex]=null;
              if(typeof recalcEPS==='function') recalcEPS();
              if(typeof renderInventory==='function') renderInventory();
              if(typeof renderStands==='function') renderStands();
              if(typeof save==='function') save();
            }
            return;
          }
          const newItem = state.inventory.find(it=>it.uid===state.selectedItemUid); if(!newItem) return;
          if(!(newItem.isEgg || newItem.petType)){ alert('Only eggs or pets can be placed on pet pedestals.'); return; }
          if(newItem.isEgg){
            state.petStands[placeIndex]=newItem;
            if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
            const TWO_MIN = 2*60*1000;
            state.petTimers[placeIndex]=Date.now() + (window.FOURTH_HATCH_DURATION || TWO_MIN);
          } else {
            state.petStands[placeIndex]=newItem;
            if(!newItem.isEgg) registerPetOwned(newItem.petType||newItem.name);
          }
          state.inventory = state.inventory.filter(it => it.uid !== newItem.uid);
          state.selectedItemUid=null;
          if(typeof recalcEPS==='function') recalcEPS();
          if(typeof renderInventory==='function') renderInventory();
          if(typeof renderStands==='function') renderStands();
          if(typeof save==='function') save();
        });
      }
      row.appendChild(pbox);
    }
  }

  (function(){
    const __rs = window.renderStands;
    if(typeof __rs==='function'){
      window.renderStands = function(){
        __rs.apply(this, arguments);
        try{ renderThirdPetSlot(); }catch(e){}
        try{ renderFourthPetSlot(); }catch(e){}
      };
    }
    setTimeout(()=>{ try{ renderFourthPetSlot(); }catch(e){} }, 0);
  })();
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>


<script>
// --- Add-on persistence for achievements + backgrounds ---
(function(){
  const KEY='flex_addon_persist_v1';
  function saveAddon(){
    try{
      const data={ach:state.ach, ubg:state.unlockedBackgrounds, sel:state.selectedBackground, pdx:(state.petDex||{})};
      localStorage.setItem(KEY, JSON.stringify(data));
    }catch(e){}
  }
  function loadAddon(){
    try{
      const raw=localStorage.getItem(KEY); if(!raw) return;
      const d=JSON.parse(raw);
      if(d.ach){
        state.ach=state.ach||{questsDone:{}};
        state.ach.questsDone={...(state.ach.questsDone||{}), ...(d.ach.questsDone||{})};
        state.ach.petPedestalGranted = state.ach.petPedestalGranted || !!d.ach.petPedestalGranted;
        state.ach.petThirdUnlocked = state.ach.petThirdUnlocked || !!d.ach.petThirdUnlocked;
      }
      if(d.ubg) state.unlockedBackgrounds={...(state.unlockedBackgrounds||{}), ...d.ubg};
      if(d.sel) { state.selectedBackground=d.sel; try{ if(state.selectedBackground!=='default'){ document.body.classList.add(state.selectedBackground.startsWith('bg-')?state.selectedBackground:({bg:'bg-'}) ); } }catch(e){} }
      if(d.pdx){ state.petDex = { ...(state.petDex||{}), ...d.pdx }; }
    }catch(e){}
  }
  // load immediately
  loadAddon();
  try{ if(state.selectedBackground && state.selectedBackground!=='default' && typeof applyBG==='function'){ applyBG(state.selectedBackground); } }catch(e){}

  // wrap global save to include addon data and persist locally
  const __save = window.save;
  window.save = async function(){
    try{ saveAddon(); }catch(e){}
    if(typeof __save === 'function'){ try{ return await __save.apply(this, arguments); }catch(e){ return; } }
  };
  window.addEventListener('beforeunload', saveAddon);
  window.__addonSave = saveAddon;
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>


<script>
(function(){
  // toggle button -> deletion mode
  window.state = window.state || {};
  state.deletionMode = false; // default OFF

  function reflectDeleteMode(){
    const on = !!state.deletionMode;
    document.body.classList.toggle('deleting', on);
    const btn = document.getElementById('deleteToggleBtn');
    if(btn){ btn.classList.toggle('active', on); btn.setAttribute('aria-pressed', on ? 'true' : 'false'); }
  }

  function augmentInventorySlots(){
    try{
      const slots = Array.from(document.querySelectorAll('#inventory .slot'));
      slots.forEach((slot, idx)=>{
        let del = slot.querySelector('.del-x');
        if(!del){
          del = document.createElement('button');
          del.className = 'del-x';
          del.type = 'button';
          del.title = 'Delete item';
          del.textContent = 'Ã—';
          slot.appendChild(del);
          del.addEventListener('click', (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            if(!state.deletionMode) return;
            if(!Array.isArray(state.inventory)) return;
            const item = state.inventory[idx];
            if(!item) return;
            state.inventory.splice(idx,1);
            if(typeof save==='function') try{ save(); }catch(e){}
            if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
          });
        }
      });
    }catch(e){}
  }

  // Initial reflect + augment once DOM is ready
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=>{ reflectDeleteMode(); augmentInventorySlots(); });
  }else{
    reflectDeleteMode(); augmentInventorySlots();
  }

  // Robust: delegate click to handle dynamic re-renders
  document.addEventListener('click', function(e){
    const btn = e.target.closest && e.target.closest('#deleteToggleBtn');
    if(!btn) return;
    e.preventDefault();
    state.deletionMode = !state.deletionMode;
    reflectDeleteMode();
    augmentInventorySlots();
    if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
  });

  // After every inventory render, augment again to ensure buttons exist
  const __ri_hook = window.renderInventory;
  if(typeof __ri_hook === 'function'){
    window.renderInventory = function(){
      __ri_hook.apply(this, arguments);
      try{ augmentInventorySlots(); reflectDeleteMode(); }catch(e){}
    };
  }

  // Wrap renderInventory to add delete badges mapped by index
  const __ri = window.renderInventory;
  if(typeof __ri==='function'){
    window.renderInventory = function(){
      __ri.apply(this, arguments);
      try{
        const list = Array.from(document.querySelectorAll('#inventory .slot'));
        list.forEach((el, idx)=>{
          let del = el.querySelector('.del-x');
          if(!del){
            del = document.createElement('button');
            del.className='del-x'; del.textContent='Ã—';
            el.appendChild(del);
            del.addEventListener('click', (ev)=>{
              ev.stopPropagation();
              if(!state.deletionMode) return;
              if(!Array.isArray(state.inventory)) return;
              const item = state.inventory[idx];
              if(!item) return;
              // remove item permanently
              state.inventory.splice(idx,1);
              if(typeof save==='function') save();
              if(window.__addonSave) __addonSave();
              renderInventory();
            });
          }
        });
      }catch(e){}
    };
  }

  // (Deletion mode does not add delete buttons to pedestals.)
</script>



<script>
(function(){
  window.state = window.state || {};
  state.deletionMode = false; // default OFF

  function addDeleteBadgesToInventory(){
    try{
      const slots = Array.from(document.querySelectorAll('#inventory .slot'));
      slots.forEach((slot, idx)=>{
        let del = slot.querySelector('.del-x');
        if(!del){
          del = document.createElement('button');
          del.className = 'del-x';
          del.type = 'button';
          del.title = 'Delete item';
          del.textContent = 'Ã—';
          slot.appendChild(del);
          del.addEventListener('click', (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            if(!state.deletionMode) return;
            if(!Array.isArray(state.inventory)) return;
            const item = state.inventory[idx];
            if(!item) return;
            // Delete item from inventory
            state.inventory.splice(idx,1);
            if(typeof save==='function') try{ save(); }catch(e){}
            if(typeof renderInventory==='function') try{ renderInventory(); }catch(e){}
          });
        }
      });
    }catch(e){ /* no-op */ }
  }

  function removeDeleteBadgesFromInventory(){
    document.querySelectorAll('#inventory .slot .del-x').forEach(el=>el.remove());
  }

  function reflectDelete(){
    const on = !!state.deletionMode;
    const btn = document.getElementById('deleteToggleBtn');
    document.body.classList.toggle('deleting', on);
    if(btn){ btn.classList.toggle('active', on); btn.setAttribute('aria-pressed', on?'true':'false'); }
    if(on){ addDeleteBadgesToInventory(); } else { removeDeleteBadgesFromInventory(); }
  }

  // Hook into renderInventory so badges sync with current mode after any render
  const __ri = window.renderInventory;
  if(typeof __ri === 'function'){
    window.renderInventory = function(){
      __ri.apply(this, arguments);
      reflectDelete();
    };
  }

  function init(){
    // always start OFF on load
    state.deletionMode = false;
    reflectDelete();
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();

  // Toggle button wiring
  document.addEventListener('click', function(e){
    const btn = e.target.closest && e.target.closest('#deleteToggleBtn');
    if(!btn) return;
    e.preventDefault();
    state.deletionMode = !state.deletionMode;
    reflectDelete();
  });

  // Safety: ensure OFF on reload
  window.addEventListener('beforeunload', ()=>{ state.deletionMode=false; });
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>



<!-- Cosmic Event Overlay -->
<div class="overlay" id="cosmicOverlay" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="cosmicTitle">
    <button class="closeX" id="closeCosmic" aria-label="Close">âœ•</button>
    <h2 id="cosmicTitle">COSMIC EVENT</h2>
    <div class="cosmic-grid">
      <div class="cosmic-card" id="cardSpacePack">
        <h3>Space Pack <span class="cosmic-badge t-legendary">LIMITED</span></h3>
        <p class="cosmic-desc">Open to receive a random Space Item in EPIC/LEGENDARY/LEGACY/MYTHIC/COSMIC. Cosmic is rarest and sparkles. Reward autoâ€‘adds to inventory.</p>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
          <div class="cosmic-price">$1,000,000,000</div>
          <button class="cosmic-buy" id="buySpacePack">Purchase</button>
        </div>
      </div>
      <div class="cosmic-card" id="cardSpaceView">
        <h3>Space View</h3>
        <p class="cosmic-desc">Animated galaxy background. After purchase, apply it from the Backgrounds menu.</p>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
          <div class="cosmic-price">$10,000,000,000,000</div>
          <button class="cosmic-buy" id="buySpaceView">Purchase</button>
        </div>
      </div>
      <div class="cosmic-card" id="cardGalaxyEgg">
        <h3>Galaxy Egg</h3>
        <p class="cosmic-desc">Hatches: Alien 91% (same as Universal), Cosmic Unicorn 6% (+$45,000 EPS), Robot 3% (+$55,000 EPS). Robot has a 25% hourly chance to convert a placed MYTHIC to COSMIC when both are on pedestals.</p>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
          <div class="cosmic-price">$20,000,000,000</div>
          <button class="cosmic-buy" id="buyGalaxyEgg">Purchase</button>
        </div>
      </div>
      <div class="cosmic-card">
        <h3>Cosmic Info</h3>
        <div class="cosmic-desc">
          Event items are limitedâ€‘time. The event button disappears when over, but anything you bought stays in your save forever.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick reward reveal -->
<div class="cosmic-reveal" id="cosmicReveal">
  <div class="card">
    <div style="font-family:'Bungee';font-size:28px;letter-spacing:1px;">You received</div>
    <img id="revealImg" alt="reward">
    <div id="revealName" style="font-weight:900;margin-top:6px;"></div>
    <div id="revealRarity" class="rar" style="margin:8px auto 0;padding:6px 12px;border-radius:12px;"></div>
  </div>
</div>

<script>
// === Cosmic Event bootstrap ===
(function(){
  // Add button to left rail (star)
  try{
    const rail = document.querySelector('.left-rail');
    if(rail && !document.getElementById('openCosmic')){
      const btn = document.createElement('button');
      btn.className = 'icon-btn icon-cosmic';
      btn.id = 'openCosmic';
      btn.title = 'Cosmic Event';
      btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="#ffd84a" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l2.9 6.2L22 9l-5 4.8 1.2 6.9L12 17.8 5.8 20.7 7 13.8 2 9l7.1-.8L12 2z"/></svg>';
      rail.insertBefore(btn, rail.children[1] || null);
      btn.addEventListener('click', ()=>{
        document.getElementById('cosmicOverlay').classList.add('show');
        document.getElementById('cosmicOverlay').setAttribute('aria-hidden','false');
        updateSpaceViewUI();
      });
    }
  }catch(e){}

  // Close handler
  document.getElementById('closeCosmic')?.addEventListener('click', ()=>{
    document.getElementById('cosmicOverlay').classList.remove('show');
    document.getElementById('cosmicOverlay').setAttribute('aria-hidden','true');
  });

  // Extend rarity table with COSMIC
  try{
    window.RARITY = window.RARITY || {};
    if(!RARITY.cosmic){
      RARITY.cosmic = { label:'COSMIC', color:'#8fd0ff', income: 35000, price:[0,0], prob: 0 };
    }
  }catch(e){}

  // Reward reveal helpers
  function showReveal(name, rarity, imgPath){
    const host = document.getElementById('cosmicReveal');
    const rn = document.getElementById('revealName');
    const rr = document.getElementById('revealRarity');
    const ri = document.getElementById('revealImg');
    ri.src = imgPath;
    rn.textContent = name;
    rr.textContent = (RARITY[String(rarity).toLowerCase()]?.label || String(rarity||'').toUpperCase());
    rr.className = 'rar t-' + String(rarity).toLowerCase();
    host.classList.add('show');
    setTimeout(()=>{ host.classList.remove('show'); }, 3000);
  }

  // Space Pack logic
  const SPACE_PACK_COST = 1_000_000_000;
  const SPACE_ITEMS = [
    ["Space Ship","space_ship.png"],
    ["Mars","mars.png"],
    ["Earth","earth.png"],
    ["Space Suit","space_suit.png"],
    ["Asteroid","asteroid.png"],
    ["Moon","moon.png"],
    ["Black Hole","black_hole.png"],
    ["Sun","sun.png"]
  ];
  // Weights: EPIC 60, LEGENDARY 25, LEGACY 10, MYTHIC 4, COSMIC 1
  const SP_RARITY_BUCKETS = [
    ["epic",58],["legendary",25],["legacy",10],["mythic",4],["cosmic",3]
  ];
  function pickWeighted(bucket){
    const total = bucket.reduce((s, r)=>s+r[1], 0);
    let roll = Math.random() * total;
    for(const [val,w] of bucket){
      roll -= w;
      if(roll <= 0) return val;
    }
    return bucket[bucket.length-1][0];
  }

  function buySpacePack(){
    if((state.money||0) < SPACE_PACK_COST) return;
    state.money -= SPACE_PACK_COST;
    const [name, file] = SPACE_ITEMS[Math.floor(Math.random()*SPACE_ITEMS.length)];
    const rar = pickWeighted(SP_RARITY_BUCKETS);
    const inv = {
      uid: (Math.random().toString(36).slice(2)+Date.now().toString(36)),
      name,
      rarity: rar,
      price: 0,
      baseIdx: 0,
      svg: 'space_pack_items/'+file
    };
    state.inventory.push(inv);
    showReveal(name, rar, inv.svg);
    if(typeof updateTop==='function') updateTop();
    if(typeof renderInventory==='function') renderInventory();
    if(typeof save==='function') save();
  }
  document.getElementById('buySpacePack')?.addEventListener('click', buySpacePack);

  // Space View purchase
  const SPACE_VIEW_COST = 10_000_000_000_000;
  function updateSpaceViewUI(){
    const btn = document.getElementById('buySpaceView');
    if(!btn) return;
    const owned = !!(state.unlockedBackgrounds && state.unlockedBackgrounds.spaceview);
    if(owned){
      btn.disabled = true;
      btn.textContent = 'Purchased';
      btn.style.background = 'linear-gradient(#2ecc71,#1da85b)';
    }else{
      btn.disabled = (state.money||0) < SPACE_VIEW_COST;
      btn.textContent = 'Purchase';
      btn.style.background = '';
    }
  }
  function buySpaceView(){
    if((state.unlockedBackgrounds||{}).spaceview) return;
    if((state.money||0) < SPACE_VIEW_COST) return;
    state.money -= SPACE_VIEW_COST;
    state.unlockedBackgrounds = state.unlockedBackgrounds || {};
    state.unlockedBackgrounds.spaceview = true;
    // add selectable tile now
    if(typeof window.__renderBgGrid==='function') window.__renderBgGrid();
    updateSpaceViewUI();
    if(typeof updateTop==='function') updateTop();
    if(typeof save==='function') save();
  }
  document.getElementById('buySpaceView')?.addEventListener('click', buySpaceView);

  // Extend Background grid with Space View option
  (function extendBgGrid(){
    const orig = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if(typeof orig === 'function') orig();
      try{
        const g=document.getElementById('bgGrid');
        if(!g) return;
        if(!g.querySelector('[data-spaceview]')){
          const el=document.createElement('div');
          el.setAttribute('data-spaceview','1');
          el.className='bg-tile'+(!(state.unlockedBackgrounds||{}).spaceview?' locked':'');
          el.style.cssText='background:radial-gradient(1200px 600px at 50% -200px,#091225,#04060c)';
          el.innerHTML='<div style="font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)">SPACE VIEW</div><button class="buy bg-apply" '+(!(state.unlockedBackgrounds||{}).spaceview?'disabled':'')+'>Apply</button>';
          el.querySelector('.bg-apply').onclick=()=>{
            if(!(state.unlockedBackgrounds||{}).spaceview) return;
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-rainbow','redblue');
            document.body.classList.add('bg-spaceview');
            state.selectedBackground='spaceview';
            if(typeof save==='function') save();
          };
          g.appendChild(el);
        }
      }catch(e){}
    };
  })();

  // Galaxy Egg purchase + hatch
  const GALAXY_EGG_COST = 20_000_000_000;
  function buyGalaxyEgg(){
    if((state.money||0) < GALAXY_EGG_COST) return;
    state.money -= GALAXY_EGG_COST;
    const egg = {
      uid: (Math.random().toString(36).slice(2)+Date.now().toString(36)),
      name: 'Galaxy Egg',
      isEgg: true,
      eggType: 'galaxy',
      svg: (function(){
        // sparkly yellow-blue blend
        const size=96, gid='gal'+Math.floor(Math.random()*99999);
        const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 96 96">
          <defs><linearGradient id="${gid}" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#ffdf6a"/><stop offset="100%" stop-color="#67b7ff"/></linearGradient></defs>
          <rect x="4" y="4" width="88" height="88" rx="14" fill="#333"/><ellipse cx="48" cy="52" rx="22" ry="28" fill="url(#${gid})"/>
        </svg>`;
        return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
      })()
    };
    state.inventory.push(egg);
    if(typeof updateTop==='function') updateTop();
    if(typeof renderInventory==='function') renderInventory();
    if(typeof save==='function') save();
  }
  document.getElementById('buyGalaxyEgg')?.addEventListener('click', buyGalaxyEgg);

  // Inject Galaxy table + robot passive
  (function extendPets(){
    try{
      window.PET_TABLES = window.PET_TABLES || {};
      // Alien same EPS as Universal egg table (fallback to 15000000 if unknown)
      let alienEPS = 15000000;
      try{
        const u = PET_TABLES.universal?.find(p=>p.name==='Alien');
        if(u && u.eps) alienEPS = u.eps;
      }catch(e){}
      PET_TABLES.galaxy = [
        { name:'Alien', chance: 0.91, eps: alienEPS },
        { name:'Cosmic Unicorn', chance: 0.06, eps: 45000 },
        { name:'Robot', chance: 0.03, eps: 55000 }
      ];
      // Ensure getPetSvg knows files (these were mentioned by the user)
      window.getPetSvg = (function(orig){
        return function(petName, seed){
          const map = {
            "Alien":"alien.png",
            "Cosmic Unicorn":"cosmic_unicorn.png",
            "Robot":"robot.png"
          };
          if(map[petName]) return 'pets/'+map[petName];
          try{ return orig ? orig(petName, seed) : 'pets/'+(map[petName]||'alien.png'); }catch(e){ return 'pets/'+(map[petName]||'alien.png'); }
        };
      })(window.getPetSvg);
    }catch(e){}
  })();

  // When a Robot is placed, once per hour do a 10% roll to turn a MYTHIC to COSMIC
  (function robotPassive(){
    state.__robotLastCheck = state.__robotLastCheck || 0;
    const HOUR = 3600*1000;
    function doCheck(){
      const now = Date.now();
      if(now - (state.__robotLastCheck||0) < HOUR) return;
      state.__robotLastCheck = now;
      // Is a Robot placed on any pet pedestal?
      const robotPlaced = (state.petStands||[]).some(p=>p && !p.isEgg && (p.petType==='Robot' || p.name==='Robot'));
      if(!robotPlaced) return;
      // Is there a MYTHIC on a main pedestal?
      let mythicUid = null;
      (state.stands||[]).forEach(uid=>{
        if(!uid) return;
        const it = state.placed[uid] || state.inventory.find(x=>x.uid===uid);
        if(it && String(it.rarity).toLowerCase()==='mythic' && !mythicUid) mythicUid = uid;
      });
      if(!mythicUid) return;
      // 10% chance
      if(Math.random() <= 0.25){
        const it = state.placed[mythicUid] || state.inventory.find(x=>x.uid===mythicUid);
        if(it){
          it.rarity = 'cosmic';
          // visuals update
          try{ it.svg = it.svg; }catch(e){}
          if(typeof recalcEPS==='function') recalcEPS();
          if(typeof renderStands==='function') renderStands();
          if(typeof renderInventory==='function') renderInventory();
          if(typeof save==='function') save();
        }
      }
    }
    // hook into the main tick
    const _tick = window.tick;
    window.tick = function(now){
      try{ doCheck(); }catch(e){}
      return _tick ? _tick.apply(this, arguments) : undefined;
    };
  })();
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>


<!-- LA Dodgers Event Overlay -->
<div class="overlay" id="dodgerOverlay" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="dodgerTitle">
    <button class="closeX" id="closeDodger" aria-label="Close">âœ•</button>
    <h2 id="dodgerTitle">LA DODGERS EVENT</h2>
    <div class="dodger-grid">
      <div class="dodger-card" id="cardLAPack">
        <h3>LA Pack <span class="cosmic-badge t-legendary">LIMITED</span></h3>
        <p class="dodger-desc">Open to receive a random LA item in EPIC/LEGENDARY/LEGACY/UNIQUE/MYTHIC/DODGER. Dodger is rarest and adds blueâ€“white waves. Reward autoâ€‘adds to inventory.</p>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
          <div class="dodger-price">$2,000,000,000</div>
          <button class="dodger-buy" id="buyLAPack">Purchase</button>
        </div>
      </div>
      <div class="dodger-card" id="cardDodgerStyle">
        <h3>Dodger Stadium Style</h3>
        <p class="dodger-desc">A themed stadium background. After purchase, apply it from Backgrounds.</p>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto;">
          <div class="dodger-price">$10,000,000,000,000</div>
          <button class="dodger-buy" id="buyDodgerStyle">Purchase</button>
        </div>
      </div>
      <div class="dodger-card">
        <h3>Dodger Info</h3>
        <div class="dodger-desc">Event items are limitedâ€‘time. When the event ends the button goes away, but your rewards stay forever. Dodger rarity gives +40,000 EPS with animated waves.</div>
      </div>
      <div class="dodger-card" style="display:grid;place-items:center;">
        <img id="dodgerShopLogo" alt="LA" style="height:120px;filter:drop-shadow(0 8px 30px rgba(30,144,255,.35));opacity:.95;">
      </div>
    </div>
  </div>
</div>

<!-- Dodgers Reward Reveal -->
<div class="cosmic-reveal" id="dodgerReveal">
  <div class="card" style="background:#0e1628;border-color:#0a0f1a;">
    <div style="font-family:'Bungee';font-size:28px;letter-spacing:1px;">You received</div>
    <img id="dodgerRevealImg" alt="reward">
    <div id="dodgerRevealName" style="font-weight:900;margin-top:6px;"></div>
    <div id="dodgerRevealRarity" class="rar" style="margin:8px auto 0;padding:6px 12px;border-radius:12px;"></div>
  </div>
</div>


<script>

// Helper to resolve assets by trying multiple extensions.
// Use base folder and a file *stem* (no extension), like ('la_dodgers_files','event')
function resolveAsset(base, stem, cb){
  const exts = ['.png', '.webp', '.jpg', ''];
  let i = 0;
  function tryNext(){
    const url = base + '/' + stem + exts[i];
    const img = new Image();
    img.onload = ()=>cb(url);
    img.onerror = ()=>{
      i++;
      if(i < exts.length) tryNext();
      else cb(base + '/' + stem + '.png'); // fall back
    };
  }
  tryNext();
}

// Set the event icon image in the shop card and left-rail button
function setDodgerEventIcons(btnEl){
  // If a specific button element is passed, use that; else search.
  const setBtnBg = function(url){
    try{
      const btn = btnEl || document.getElementById('openDodger');
      if(btn){
        btn.style.setProperty('--dodger-icon', "url('"+url+"')");
        const ft = btn.querySelector('.fallback-text');
        if(ft) ft.style.opacity = '0';
      }
    }catch(e){}
  };

  
  
  (function(){
    const candidates = [
      'la_dodgers_files/event.png',
      'la_dodgers_filesevent.png',
      'event.png'
    ];
    (function tryNext(i){
      if(i >= candidates.length){
        // final fallback: show "LA" text, leave CSS var unset
        const shopImg = document.getElementById('dodgerShopLogo');
        if(shopImg){
          shopImg.classList.add('fallback');
          shopImg.removeAttribute('src');
          shopImg.textContent = 'LA';
        }
        return;
      }
      const test = new Image();
      test.onload = function(){
        const url = candidates[i];
        const shopImg = document.getElementById('dodgerShopLogo');
        if(shopImg){
          shopImg.classList.remove('fallback');
          shopImg.src = url;
        }
        setBtnBg(url);
      };
      test.onerror = function(){ tryNext(i+1); };
      test.src = candidates[i];
    })(0);
  })();
}
// Prepare and cache the stadium background URL, update CSS and BG grid tile
var __dodgerBgURL = null;
function ensureDodgerBgURL(cb){
  if(__dodgerBgURL){ cb(__dodgerBgURL); return; }
  resolveAsset('la_dodgers_style_files','la_dodgers_style', function(url){
    __dodgerBgURL = url;
    // write/update CSS rule dynamically
    let st = document.getElementById('dodgerBgStyle');
    if(!st){
      st = document.createElement('style');
      st.id = 'dodgerBgStyle';
      document.head.appendChild(st);
    }
    st.textContent = "body.bg-dodger{background:url('"+url+"') center center / cover no-repeat fixed !important;}";
    cb(url);
  });
}

// === LA Dodgers Event bootstrap ===
(function(){
  // Add event icon button to left rail (uses provided PNG)
  try{
    const rail = document.querySelector('.left-rail');
    if(rail && !document.getElementById('openDodger')){
      const btn = document.createElement('button');
      btn.className = 'icon-btn icon-dodger';
      btn.id = 'openDodger';
      btn.title = 'LA Dodgers Event';
      btn.innerHTML = '<span class="fallback-text">LA</span>';
      setDodgerEventIcons(btn);
      rail.insertBefore(btn, rail.children[1] || null);
      btn.addEventListener('click', ()=>{
        document.getElementById('dodgerOverlay').classList.add('show');
        document.getElementById('dodgerOverlay').setAttribute('aria-hidden','false');
        updateDodgerStyleUI();
        setDodgerEventIcons();
      });
    }
  }catch(e){}

  document.getElementById('closeDodger')?.addEventListener('click', ()=>{
    document.getElementById('dodgerOverlay').classList.remove('show');
    document.getElementById('dodgerOverlay').setAttribute('aria-hidden','true');
  });

  // Extend rarity table with DODGER (40,000 EPS)
  try{
    window.RARITY = window.RARITY || {};
    if(!RARITY.dodger){
      RARITY.dodger = { label:'DODGER', color:'#1e90ff', income: 40000, price:[0,0], prob: 0 };
    }
  }catch(e){}

  // After every stand render, add the wave aura to any placed item with t-dodger badge
  (function hookDodgerWaves(){
    const orig = window.renderStands;
    window.renderStands = function(){
      if(typeof orig === 'function') orig.apply(this, arguments);
      try{
        document.querySelectorAll('.placed').forEach(el=>{
          const hasDodger = !!el.querySelector('.rar.t-dodger');
          el.classList.toggle('dodger-waves', hasDodger);
        });
      }catch(e){}
    };
    setTimeout(()=>{
      try{
        document.querySelectorAll('.placed').forEach(el=>{
          const hasDodger = !!el.querySelector('.rar.t-dodger');
          el.classList.toggle('dodger-waves', hasDodger);
        });
      }catch(e){}
    },0);
  })();

  // Reward reveal helper
  function showDodgerReveal(name, rarity, imgPath){
    const host = document.getElementById('dodgerReveal');
    const rn = document.getElementById('dodgerRevealName');
    const rr = document.getElementById('dodgerRevealRarity');
    const ri = document.getElementById('dodgerRevealImg');
    ri.src = imgPath;
    rn.textContent = name;
    rr.textContent = (RARITY[String(rarity).toLowerCase()]?.label || String(rarity||'').toUpperCase());
    rr.className = 'rar t-' + String(rarity).toLowerCase();
    host.classList.add('show');
    setTimeout(()=>{ host.classList.remove('show'); }, 3000);
  }

  // LA Pack purchase logic
  const LA_PACK_COST = 2_000_000_000;
  const LA_ITEMS = [
    ['Dodger Hat','dodger_hat.png'],
    ['Dodger Stadium','dodger_stadium.png'],
    ['World Series','world_series.png'],
    ['Shohei Ohtani','shohei_ohtani.png'],
    ['Will Smith','will_smith.png'],
    ['Freddie Freeman','freddie_freeman.png'],
    ['Mookie Betts','mookie_betts.png'],
    ['Dodger Baseball','dodger_baseball.png'],
    ['Dodger Welcome','dodger_welcome.png']
  ];
  // EPIC/LEGENDARY/LEGACY/UNIQUE/MYTHIC/DODGER (Dodger rarest)
  const LA_RARITY_BUCKETS = [
    ['epic',48], ['legendary',25], ['legacy',10], ['unique',8], ['mythic',5], ['dodger',4]
  ];
  function pickWeighted(bucket){
    const total = bucket.reduce((s, r)=>s+r[1], 0);
    let roll = Math.random() * total;
    for(const [val,w] of bucket){
      roll -= w;
      if(roll <= 0) return val;
    }
    return bucket[bucket.length-1][0];
  }
  function buyLAPack(){
    if((state.money||0) < LA_PACK_COST) return;
    state.money -= LA_PACK_COST;
    const [name, file] = LA_ITEMS[Math.floor(Math.random()*LA_ITEMS.length)];
    const rar = pickWeighted(LA_RARITY_BUCKETS);
    const inv = {
      uid: (Math.random().toString(36).slice(2)+Date.now().toString(36)),
      name,
      rarity: rar,
      price: 0,
      baseIdx: 0,
      svg: 'la_dodgers_items/' + file
    };
    state.inventory.push(inv);
    if(typeof updateTop==='function') updateTop();
    if(typeof renderInventory==='function') renderInventory();
    if(typeof save==='function') save();
    showDodgerReveal(name, rar, inv.svg);
  }
  document.getElementById('buyLAPack')?.addEventListener('click', buyLAPack);

  // Dodger Stadium Style background purchase
  const DODGER_STYLE_COST = 10_000_000_000_000;
  function updateDodgerStyleUI(){
    const btn = document.getElementById('buyDodgerStyle');
    if(!btn) return;
    const owned = !!(state.unlockedBackgrounds && state.unlockedBackgrounds.dodger);
    if(owned){
      btn.disabled = true;
      btn.textContent = 'Purchased';
      btn.style.background = 'linear-gradient(#2ecc71,#1da85b)';
    }else{
      btn.disabled = (state.money||0) < DODGER_STYLE_COST;
      btn.textContent = 'Purchase';
      btn.style.background = '';
    }
  }
  function buyDodgerStyle(){
    if((state.unlockedBackgrounds||{}).dodger) return;
    if((state.money||0) < DODGER_STYLE_COST) return;
    state.money -= DODGER_STYLE_COST;
    state.unlockedBackgrounds = state.unlockedBackgrounds || {};
    state.unlockedBackgrounds.dodger = true;
    updateDodgerStyleUI();
        setDodgerEventIcons();
    if(typeof window.__renderBgGrid==='function') window.__renderBgGrid();
    if(typeof updateTop==='function') updateTop();
    if(typeof save==='function') save();
  }
  document.getElementById('buyDodgerStyle')?.addEventListener('click', buyDodgerStyle);

  // Extend Background grid with Dodger style
  (function extendBgGrid(){
    const orig = window.__renderBgGrid;
    window.__renderBgGrid = function(){
      if(typeof orig === 'function') orig();
      try{
        const g=document.getElementById('bgGrid');
        if(!g) return;
        if(!g.querySelector('[data-dodgerbg]')){
          const el=document.createElement('div');
          el.setAttribute('data-dodgerbg','1');
          el.className='bg-tile'+(!(state.unlockedBackgrounds||{}).dodger?' locked':'');
          el.style.cssText='background-image:url("la_dodgers_style_files/la_dodgers_style.png");background-size:cover;background-position:center;';
          el.innerHTML='<div style="font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.35)">DODGER STADIUM STYLE</div><button class="buy bg-apply" '+(!(state.unlockedBackgrounds||{}).dodger?'disabled':'')+'>Apply</button>';
          el.querySelector('.bg-apply').onclick=()=>{
            if(!(state.unlockedBackgrounds||{}).dodger) return;
            document.body.classList.remove('bg-green','bg-blue','bg-purple','bg-orange','bg-legacy','bg-unique','bg-exotic','bg-mythic','bg-rainbow','redblue','bg-spaceview');
            document.body.classList.add('bg-dodger');
            state.selectedBackground='dodger';
            if(typeof save==='function') save();
          };
          g.appendChild(el);
        }
      }catch(e){}
    };
  })();
ensureDodgerBgURL(function(){});

// Re-apply icons on DOMContentLoaded
document.addEventListener('DOMContentLoaded', ()=> setDodgerEventIcons());
// MutationObserver to catch dynamic button insertion
new MutationObserver(()=> setDodgerEventIcons()).observe(document.body, {childList:true, subtree:true});

})();
</script>


<script>
(function(){
  const btn = document.getElementById('openBgSelector');
  if(btn){
    btn.addEventListener('click', ()=>{
      const overlay = document.getElementById('bgOverlay');
      const sheet = overlay ? overlay.querySelector('.sheet') : null;
      const grid = document.getElementById('bgGrid');
      if (overlay) overlay.scrollTop = 0;
      if (sheet) sheet.scrollTop = 0;
      if (grid) grid.scrollTop = 0;
    }, { passive: true });
  }
})();
</script>

</body>
</html>
