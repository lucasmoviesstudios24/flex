<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sushi Go — Compact Layout</title>

<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600&family=Raleway:wght@800&family=Oi&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#d9b989;
    --accent:#f25a43;
    --accent-dark:#cd4b3a;
    --slate:#3e3d3d;
    --dark:#2b2b2b;
    --muted:#6f6f6f;
    --gold:#ffd84e;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:'Lexend',sans-serif;
    background:var(--bg);
    color:var(--dark);
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:stretch;
  }

  /* Header tabs (slightly smaller) */
  header{ padding:10px 14px 0; }
  .tabbar{
    width:100%;
    max-width:1200px;
    margin:0 auto;
    display:grid;
    grid-template-columns: repeat(4, 1fr) 220px;
    gap:10px;
  }
  .tab, .tab-upgrades{
    background:var(--accent);
    border-radius:16px;
    border:3px solid #000;
    padding:5px;
    box-shadow: 0 3px 0 #000;
    position:relative;
  }
  .tab-inner{
    background:var(--slate);
    border:3px solid #000;
    border-radius:12px;
    height:58px;
    display:flex; align-items:center; justify-content:center;
    gap:8px;
    color:#e9e9e9;
    font-weight:700;
    font-size:24px;
    text-shadow: 0 2px 0 rgba(0,0,0,.35);
    cursor:pointer;
    transition: transform .08s, background .15s, color .15s;
  }
  .tab-inner img{ width:30px; height:30px; object-fit:contain; filter: drop-shadow(0 1px 0 rgba(0,0,0,.3)); }
  .tab.active .tab-inner{ color:var(--gold); transform: translateY(-1px); }
  /* decorative banner badge on the Upgrades slab */ 

  .tab-upgrades .tab-title{
    font-family:'Raleway',sans-serif; font-weight:800; font-size:28px; color:#fff; text-shadow: 0 2px 0 rgba(0,0,0,.35);
  }

  /* Main grid compact */
  main{
    position:relative;
    display:grid;
    grid-template-columns: 260px 1fr 300px;
    gap:14px;
    padding:14px;
    width:100%;
    max-width:1200px;
    margin:0 auto;
    flex:1;
    align-items:start;
  }

  /* Left stats */
  .left-panel{
    background:#2f2f2f; color:#fff;
    border-radius:16px; padding:14px;
    border:3px solid #000; box-shadow:0 3px 0 #000;
    display:flex; flex-direction:column; gap:10px; min-height:200px;
  }
  .statbox{ background:#4a4a4a; color:#fff; padding:10px; border:3px solid #000; border-radius:12px; }
  .stat-title{ font-family:'Raleway',sans-serif; font-weight:800; margin-bottom:6px; font-size:16px}
  .stat-row{ display:flex; justify-content:space-between; align-items:center; margin:4px 0; }
  .level-card { background:#3d3d3d; padding:8px; border-radius:10px; color:#fff; border:2px solid #000; }
  .level-name { font-family:'Raleway',sans-serif; font-weight:800; font-size:16px; }
  .level-progress { font-size:12px; color:#ffe1b3; margin-top:6px; }
  .progress-wrap { background:#2a2a2a; padding:5px; border-radius:10px; border:2px solid #000; margin-top:6px;}
  .progress-bar { height:10px; border-radius:8px; background:#1b1b1b; overflow:hidden; }
  .progress-inner { height:100%; width:0%; background:linear-gradient(90deg,#fff5,#ffd59b); transition:width .3s; }

  /* Center (smaller sushi ring) */
  .center-panel{ display:flex; flex-direction:column; align-items:center; gap:12px; min-height:360px; }
  .sushi-ring{ width:420px; height:340px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:7px solid #000; background:transparent; }
  .sushi{ width:280px; height:auto; cursor:pointer; user-select:none; transition:transform .08s; }
  #sushiCounter{ font-family:'Raleway',sans-serif; font-weight:800; font-size:56px; margin-top:6px; }

  /* Right upgrades (narrower & smaller items) */
  .right-panel-wrap{ position:relative; overflow:visible; }
  .right-panel{
    background:linear-gradient(180deg,var(--accent),var(--accent-dark));
    border-radius:16px; padding:12px; color:white;
    display:flex; flex-direction:column; gap:10px;
    box-shadow:0 3px 0 #000; min-height:220px; border:3px solid #000;
    transform-origin:right center; transition: transform .28s ease, opacity .28s ease;
  }
  .right-panel.hidden{ transform: translateX(20px) scale(.98); opacity:0; pointer-events:none; }
  .right-panel[aria-hidden="true"]{ display:none; }
  .right-panel h3{ margin:4px 0 6px; font-family:'Raleway',sans-serif; font-weight:800; font-size:18px; }

  .upgrade-row{
    background:rgba(0,0,0,0.12); border-radius:10px; padding:8px;
    display:flex; align-items:center; gap:8px; cursor:pointer;
    border:2px solid rgba(0,0,0,0.35);
    transition:background .12s, transform .08s, opacity .12s;
  }
  .upgrade-row:hover{ background:rgba(0,0,0,0.18); transform:translateY(-2px); }
  .upgrade-row.disabled{ opacity:.65; cursor:not-allowed; transform:none; }
  .upgrade-row img{ width:56px; height:56px; border-radius:8px; background:white; padding:6px; object-fit:contain; }
  .upgrade-title{ font-family:'Raleway',sans-serif; font-weight:800; font-size:14px; }
  .upgrade-sub{ font-size:12px; opacity:0.95; }
  .upgrade-info{ display:flex; flex-direction:column; gap:4px; flex:1; color:white; }
  .upgrade-cost{ font-weight:800; font-size:13px; min-width:70px; text-align:right; }

  /* Nameplate (smaller and raised) */
  .nameplate{
    transition: transform .28s ease, opacity .28s ease;

    position:absolute;
    left:12px; bottom:260px;   /* raised up from bottom */
    display:flex; align-items:center;
    min-width:280px; width:380px; height:92px;
    padding:12px 60px 12px 70px;
    background: linear-gradient(90deg, #f5df79, #ff9a6b);
    color:#fff;
    border-radius:20px;
    border:3px solid #000;
    box-shadow:0 3px 0 #000;
  }
  .nameplate .name-text{
    font-family:'Raleway',sans-serif; font-weight:800; font-size:44px;
    line-height:1; text-shadow: 0 2px 0 rgba(0,0,0,.35);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%;
  }
  .nameplate .settings-gear{
    position:absolute; right:12px; bottom:12px;
    width:36px; height:36px; border-radius:50%;
    background:var(--accent);
    display:grid; place-items:center;
    border:3px solid #000; box-shadow:0 2px 0 #000;
    cursor:pointer; transition: transform .08s;
  }
  .nameplate .settings-gear:hover{ transform:translateY(-1px); }
  .nameplate .settings-gear img{ width:20px; height:20px; filter: drop-shadow(0 1px 0 rgba(0,0,0,.3)); }
  .nameplate.hidden{ transform: translateY(24px) scale(.98); opacity:0; pointer-events:none; }
  .nameplate[aria-hidden="true"]{ display:none; }

  /* Modal & toast unchanged */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9998; }
  .modal{ width:min(520px, 92vw); background:#fff; border:4px solid #000; border-radius:18px; padding:22px; box-shadow:0 10px 0 #000; }
  .modal h3{ margin:0 0 10px; font-family:'Raleway',sans-serif; font-weight:800; font-size:26px; }
  .modal p{ margin:0 0 14px; color:#444; }
  .modal .row{ display:flex; gap:10px; }
  .modal input{ flex:1; font-size:18px; padding:12px 14px; border-radius:12px; border:3px solid #000; outline:none; }
  .modal button{ font-family:'Raleway',sans-serif; font-weight:800; font-size:18px; padding:12px 18px; border-radius:12px; border:3px solid #000; cursor:pointer; background:var(--accent); color:#fff; box-shadow:0 3px 0 #000; }

  .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:26px; background:rgba(0,0,0,0.86); color:white; padding:10px 16px; border-radius:10px; font-size:14px; display:none; z-index:9999; }

  /* Responsive */
  @media (max-width:1100px){
    .tabbar{ grid-template-columns: repeat(4, 1fr); max-width: 1000px; }
    .tab-upgrades{ display:none; }
    main{ grid-template-columns: 1fr; padding:12px; max-width:1000px; }
    .right-panel-wrap{ order:3; }
    .left-panel{ order:1; }
    .nameplate{
    transition: transform .28s ease, opacity .28s ease;
 position:fixed; left:10px; right:10px; bottom:70px; width:auto; }
  }
</style>

<!-- Supabase JS v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header>
  <div class="tabbar">
    <div class="tab active" id="nav-home"><div class="tab-inner"><img src="icons/home.png" alt=""><span class="tab-label">Home</span></div></div>
    <div class="tab" id="nav-mult"><div class="tab-inner"><img src="icons/multilpier.png" alt=""><span class="tab-label">Multiplier</span></div></div>
    <div class="tab" id="nav-stocks"><div class="tab-inner"><img src="icons/stocks.png" alt=""><span class="tab-label">Stock</span></div></div>
    <div class="tab" id="nav-goodies"><div class="tab-inner"><img src="icons/goodies.png" alt=""><span class="tab-label">Goodies</span></div></div>
    <div class="tab-upgrades"><div class="tab-title">Upgrades</div></div>
  </div>
</header>

<main>
  <section class="left-panel">
    <div class="statbox">
      <div class="stat-title">Stats</div>
      <div class="stat-row"><div>Sushi:</div><div id="stat-clicks">0</div></div>
      <div class="stat-row"><div>Per Click:</div><div id="stat-spc">1</div></div>
      <div class="stat-row"><div>Per Second:</div><div id="stat-cps">0</div></div>
      <div class="level-card" style="margin-top:8px">
        <div class="level-name" id="levelName">Avocado Roll</div>
        <div class="level-progress" id="levelProgress">—</div>
        <div class="progress-wrap"><div class="progress-bar"><div id="progressInner" class="progress-inner"></div></div></div>
      </div>
    </div>
  </section>

  <section class="center-panel" id="page-home">
    <div class="sushi-ring">
      <img id="sushiImg" class="sushi" src="icons/sushi_clicker.png" alt="Sushi Click">
    </div>
    <div id="sushiCounter">0</div>
    <div style="font-size:13px;color:var(--muted)">Upgrades on the right.</div>
  </section>

  <section class="center-panel" id="page-mult" style="display:none">
    <h2 class="stat-title" style="color:var(--dark)">Multiplier</h2>
    <div class="muted">Coming soon — keep clicking and upgrading!</div>
  </section>

  <section class="center-panel" id="page-stocks" style="display:none">
    <h2 class="stat-title" style="color:var(--dark)">Stocks</h2>
    <div class="muted">Fun extras will live here in a future build.</div>
  </section>

  <section class="center-panel" id="page-goodies" style="display:none">
    <h2 class="stat-title" style="color:var(--dark)">Goodies</h2>
    <div class="muted">Unlockable cosmetics and treats — stay tuned.</div>
  </section>

  <section class="center-panel" id="page-settings" style="display:none">
    <h2 class="stat-title" style="color:var(--dark)">Settings</h2>
    <div class="muted" style="margin-bottom:8px">Update your profile and look.</div>

    <div class="settings-card" style="width:min(560px, 92%); background:#fff; border:3px solid #000; border-radius:14px; padding:14px; box-shadow:0 3px 0 #000">
      <div style="font-family:'Raleway',sans-serif; font-weight:800; margin-bottom:8px">Change Username</div>
      <div style="display:flex; gap:8px; width:100%">
        <input id="settingsUsernameInput" type="text" placeholder="New username" maxlength="18" style="flex:1; font-size:18px; padding:10px 12px; border-radius:10px; border:3px solid #000; outline:none" />
        <button id="settingsUsernameBtn" style="font-family:'Raleway',sans-serif; font-weight:800; font-size:16px; padding:10px 16px; border-radius:10px; border:3px solid #000; cursor:pointer; background:var(--accent); color:#fff; box-shadow:0 3px 0 #000">Save</button>
      </div>
      <div class="muted" style="margin-top:6px">This will copy your current progress to the new name and switch accounts on this browser.</div>
    </div>

    <div class="settings-card" style="width:min(560px, 92%); background:#fff; border:3px solid #000; border-radius:14px; padding:14px; box-shadow:0 3px 0 #000; margin-top:12px">
      <div style="font-family:'Raleway',sans-serif; font-weight:800; margin-bottom:8px">Banner Color</div>
      <div style="display:flex; gap:8px; align-items:center">
        <select id="bannerThemeSelect" style="flex:1; font-size:16px; padding:10px 12px; border-radius:10px; border:3px solid #000; outline:none">
          <option value="classic">Classic (Gold → Orange)</option>
          <option value="ocean">Ocean (Teal → Blue)</option>
          <option value="sakura">Sakura (Pink → Rose)</option>
          <option value="jade">Jade (Green → Emerald)</option>
          <option value="midnight">Midnight (Purple → Indigo)</option>
        </select>
        <button id="bannerApplyBtn" style="font-family:'Raleway',sans-serif; font-weight:800; font-size:16px; padding:10px 16px; border-radius:10px; border:3px solid #000; cursor:pointer; background:var(--accent); color:#fff; box-shadow:0 3px 0 #000">Apply</button>
      </div>
      <div class="muted" style="margin-top:6px">Applies to the bottom nameplate. Saved only on this device.</div>
    </div>
  </section>

  <aside class="right-panel-wrap">
    <div id="rightPanel" class="right-panel">
      <h3>Upgrades</h3>

      <div class="upgrade-row" data-key="fishing_boat" data-base="20" data-cps="1">
        <img src="upgrades/fishing_boat.png" alt="Fishing Boat">
        <div class="upgrade-info">
          <div class="upgrade-title">Fishing Boat</div>
          <div class="upgrade-sub">+1 autoclick / sec</div>
        </div>
        <div class="upgrade-cost" id="cost-fishing_boat">20</div>
      </div>

      <div class="upgrade-row" data-key="sushi_chef" data-base="100" data-spc="1">
        <img src="upgrades/sushi_chef.png" alt="Sushi Chef">
        <div class="upgrade-info">
          <div class="upgrade-title">Sushi Chef</div>
          <div class="upgrade-sub">+1 sushi per click</div>
        </div>
        <div class="upgrade-cost" id="cost-sushi_chef">100</div>
      </div>

      <div class="upgrade-row" data-key="sushi_master" data-base="1200" data-spc="10">
        <img src="upgrades/sushi_master.png" alt="Sushi Master">
        <div class="upgrade-info">
          <div class="upgrade-title">Sushi Master</div>
          <div class="upgrade-sub">+10 sushi per click</div>
        </div>
        <div class="upgrade-cost" id="cost-sushi_master">1200</div>
      </div>

      <div class="upgrade-row" data-key="restaurant" data-base="3500" data-cps="2">
        <img src="upgrades/restaurant.png" alt="Restaurant">
        <div class="upgrade-info">
          <div class="upgrade-title">Restaurant</div>
          <div class="upgrade-sub">+2 sushi per autoclick</div>
        </div>
        <div class="upgrade-cost" id="cost-restaurant">3500</div>
      </div>

      <div class="upgrade-row" data-key="ingredient_vault" data-base="8000" data-cps="2">
        <img src="upgrades/ingredient_vault.png" alt="Ingredient Vault">
        <div class="upgrade-info">
          <div class="upgrade-title">Ingredient Vault</div>
          <div class="upgrade-sub">+2 autoclicks / sec</div>
        </div>
        <div class="upgrade-cost" id="cost-ingredient_vault">8000</div>
      </div>

      <div class="upgrade-row" data-key="import_plane" data-base="20000" data-burst="30">
        <img src="upgrades/import_plane.png" alt="Import Plane">
        <div class="upgrade-info">
          <div class="upgrade-title">Import Plane</div>
          <div class="upgrade-sub">Random +30 clicks (instant)</div>
        </div>
        <div class="upgrade-cost" id="cost-import_plane">20000</div>
      </div>

      <div class="upgrade-row" data-key="cargo_ship" data-base="60000" data-cps="100">
        <img src="upgrades/cargo_ship.png" alt="Cargo Ship">
        <div class="upgrade-info">
          <div class="upgrade-title">Cargo Ship</div>
          <div class="upgrade-sub">+100 autoclicks / sec</div>
        </div>
        <div class="upgrade-cost" id="cost-cargo_ship">60000</div>
      </div>

      <div class="upgrade-row" data-key="island" data-base="150000" data-cps="200">
        <img src="upgrades/island.png" alt="Island">
        <div class="upgrade-info">
          <div class="upgrade-title">Island</div>
          <div class="upgrade-sub">+200 autoclicks / sec</div>
        </div>
        <div class="upgrade-cost" id="cost-island">150000</div>
      </div>
    </div>
  </aside>

  <div class="nameplate" id="nameplate" aria-hidden="false">
    <div class="name-text" id="nameText">Player</div>
    <button id="settingsGear" class="settings-gear" title="Settings">
      <img src="icons/settings.png" alt="Settings">
    </button>
  </div>
</main>

<!-- Username modal -->
<div id="usernameModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="uTitle">
  <div class="modal">
    <h3 id="uTitle">Choose your username</h3>
    <p>This game now saves your progress using Supabase. Pick any name — you can change it later in Settings.</p>
    <div class="row">
      <input id="usernameInput" type="text" placeholder="Type a name…" maxlength="18" />
      <button id="usernameSave">Save</button>
    </div>
  </div>
</div>

<div id="toast" class="toast">Saved</div>

<script>
const SUPABASE_URL = "https://myficiwugbsmclfepcve.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15ZmljaXd1Z2JzbWNsZmVwY3ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjg3NDQsImV4cCI6MjA3ODkwNDc0NH0.KpoiL88hnLoq_qGP4QPefpBelNFLeXf0--a6ixiFv98";

let supabaseClient = null;

// Autosave flags
let saveDirty = false;
let saveDebounceT = null;

/* ======= LEVELS & LOCAL STATE ======= */
const LEVELS = [
  {lvl:0,name:"Avocado Roll"},{lvl:10,name:"Crunch Roll"},{lvl:20,name:"Tempura Roll"},{lvl:30,name:"Hand Roll"},
  {lvl:45,name:"Sesame Roll"},{lvl:60,name:"Rainbow Veggie Roll"},{lvl:70,name:"Cut Roll"},{lvl:85,name:"Spicy Veggie Roll"},
  {lvl:100,name:"Tuna Roll"},{lvl:150,name:"Spicy Tuna Roll"},{lvl:200,name:"Shrimp Roll"},{lvl:275,name:"California Roll"},
  {lvl:350,name:"Dragon Roll"},{lvl:400,name:"Yellowtail Roll"},{lvl:450,name:"Spicy Yellowtail Roll"},
  {lvl:500,name:"Salmon Roll"},{lvl:650,name:"Smoked Salmon Roll"},{lvl:800,name:"Volcano Roll"},{lvl:1000,name:"Tiger Shrimp Roll"},
  {lvl:1300,name:"Lobster Roll"},{lvl:1600,name:"Soft Shell Crab Roll"},{lvl:2000,name:"Eel Roll"},{lvl:2500,name:"Double Eel Roll"},
  {lvl:3000,name:"Bluefin Tuna Roll"},{lvl:3500,name:"King Salmon Roll"},{lvl:4000,name:"Whale Dragon Roll (fantasy / ultra-rare)"},
  {lvl:5000,name:"Swordfish Roll"},{lvl:6000,name:"Black Cod Roll"},{lvl:7000,name:"Uni (Sea Urchin) Roll"},
  {lvl:8000,name:"Omakase Roll"},{lvl:9000,name:"Chef’s Master Roll"},{lvl:10000,name:"Legendary Sushi Roll"}
].sort((a,b)=>a.lvl-b.lvl);

const XP_LEVEL_SCALE = 5; // XP required per level is multiplied by this factor

const state = {
  username: null,
  userId: null,      // Supabase users.id
  clicks: 0,
  xp: 0,
  level: 0,
  owned: {},         // upgrades JSONB
  cps: 0,
  spc: 1,
  page: 'home'
};

const LS_KEY_PROGRESS = "SushiGo_progress_v1";

function saveToLocal() {
  try {
    const payload = {
      username: state.username,
      clicks: state.clicks,
      xp: state.xp,
      level: state.level,
      owned: state.owned
    };
    localStorage.setItem(LS_KEY_PROGRESS, JSON.stringify(payload));
  } catch (e) {
    console.warn("local save error", e);
  }
}

function loadFromLocal() {
  try {
    const raw = localStorage.getItem(LS_KEY_PROGRESS);
    if (!raw) return;
    const payload = JSON.parse(raw);
    if (typeof payload.clicks === "number") state.clicks = payload.clicks;
    if (typeof payload.xp === "number") state.xp = payload.xp;
    if (typeof payload.level === "number") state.level = payload.level;
    if (payload.owned && typeof payload.owned === "object") state.owned = payload.owned;
    if (payload.username) {
      setUsername(payload.username);
      try { localStorage.setItem("SushiGo_username", payload.username);   updateLevelFromXP();
  renderAll();
} catch (_) {}
    }
  } catch (e) {
    console.warn("local load error", e);
  }
}

/* ======= SUPABASE HELPERS ======= */
async function initSupabase() {
  try {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  } catch (e) {
    console.error("Failed to init Supabase", e);
  }
}

/**
 * Ensure a row exists in users for this username.
 * Returns the user_id (UUID) or null.
 */
async function ensureUser(username) {
  if (!supabaseClient || !username) return null;
  if (state.userId) return state.userId;

  try {
    let { data, error } = await supabaseClient
      .from('users')
      .select('id, username')
      .eq('username', username)
      .maybeSingle();

    if (error) {
      console.warn("User lookup error:", error);
    }

    let row = data;
    if (!row) {
      const { data: ins, error: insErr } = await supabaseClient
        .from('users')
        .insert({ username })
        .select('id, username')
        .single();
      if (insErr) {
        console.warn("User insert error:", insErr);
        return null;
      }
      row = ins;
    }

    state.userId = row.id;
    try {
      localStorage.setItem("SushiGo_user_id", row.id);
      localStorage.setItem("SushiGo_username", username);
    } catch (_) {}
    return row.id;
  } catch (e) {
    console.error("ensureUser exception", e);
    return null;
  }
}

/**
 * Load or create the player_state row for this user.
 */
async function loadOrCreatePlayerState(userId) {
  if (!supabaseClient || !userId) return null;
  try {
    let { data, error } = await supabaseClient
      .from('player_state')
      .select('clicks, level, xp, upgrades')
      .eq('user_id', userId)
      .maybeSingle();

    if (error) {
      console.warn("player_state load error:", error);
    }

    let row = data;
    if (!row) {
      const payload = {
        user_id: userId,
        clicks: 0,
        level: 0,
        xp: 0,
        upgrades: {}
      };
      const { data: ins, error: insErr } = await supabaseClient
        .from('player_state')
        .insert(payload)
        .select('clicks, level, xp, upgrades')
        .single();
      if (insErr) {
        console.warn("player_state insert error:", insErr);
        return null;
      }
      row = ins;
    }
    return row;
  } catch (e) {
    console.error("loadOrCreatePlayerState exception", e);
    return null;
  }
}

/**
 * Save current state into player_state.
 * Uses user_id as the primary key.
 */
async function dbSave() {
  if (!supabaseClient || !state.userId) return;
  try {
    const payload = {
      user_id: state.userId,
      clicks: Math.floor(state.clicks),
      level: state.level,
      xp: Math.floor(state.xp),
      upgrades: state.owned,
      last_active: new Date().toISOString()
    };
    const { error } = await supabaseClient
      .from('player_state')
      .upsert(payload);
    if (error) {
      console.warn("Save error:", error);
    }
  } catch (e) {
    console.error("dbSave exception", e);
  }
}

/**
 * Insert a purchase row for analytics.
 */
async function logPurchase(upgradeKey, amount, price) {
  if (!supabaseClient || !state.userId) return;
  try {
    const payload = {
      user_id: state.userId,
      upgrade_key: upgradeKey,
      amount,
      price
    };
    const { error } = await supabaseClient
      .from('purchases')
      .insert(payload);
    if (error) {
      console.warn("Purchase log error:", error);
    }
  } catch (e) {
    console.error("logPurchase exception", e);
  }
}

/* ======= SAVE HELPERS (AUTOSAVE) ======= */
function markDirty() {
  saveDirty = true;
  saveToLocal();
  scheduleSave(1500);
}

function scheduleSave(ms = 1500) {
  if (saveDebounceT) clearTimeout(saveDebounceT);
  saveDebounceT = setTimeout(async () => {
    if (saveDirty) {
      await dbSave();
      saveDirty = false;
    }
  }, ms);
}

/* ======= DOM REFERENCES ======= */
const sushiImg = document.getElementById("sushiImg");
const sushiCounter = document.getElementById("sushiCounter");
const statClicks = document.getElementById("stat-clicks");
const statCPS = document.getElementById("stat-cps");
const statLevel = document.getElementById("stat-level");
const statSPC = document.getElementById("stat-spc");
const levelNameEl = document.getElementById("levelName");
const levelProgressEl = document.getElementById("levelProgress");
const progressInner = document.getElementById("progressInner");
const toast = document.getElementById("toast");
const upgradeRows = Array.from(document.querySelectorAll(".upgrade-row"));
const rightPanel = document.getElementById("rightPanel");
const nameplate = document.getElementById("nameplate");

const pages = {
  home: document.getElementById('page-home'),
  mult: document.getElementById('page-mult'),
  stocks: document.getElementById('page-stocks'),
  goodies: document.getElementById('page-goodies'),
  settings: document.getElementById('page-settings')
};
const navButtons = {
  home: document.getElementById('nav-home'),
  mult: document.getElementById('nav-mult'),
  stocks: document.getElementById('nav-stocks'),
  goodies: document.getElementById('nav-goodies')
};

const nameText = document.getElementById('nameText');
const settingsGear = document.getElementById('settingsGear');

const usernameModal = document.getElementById('usernameModal');
const usernameInput = document.getElementById('usernameInput');
const usernameSave = document.getElementById('usernameSave');

// Settings refs
const settingsUsernameInput = document.getElementById('settingsUsernameInput');
const settingsUsernameBtn = document.getElementById('settingsUsernameBtn');
const bannerThemeSelect = document.getElementById('bannerThemeSelect');
const bannerApplyBtn = document.getElementById('bannerApplyBtn');

/* ======= UI HELPERS ======= */
function showToast(msg, time = 1200) {
  toast.textContent = msg;
  toast.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(() => toast.style.display = "none", time);
}

function randName() {
  return "Player" + Math.floor(Math.random() * 9000 + 1000);
}

function setPage(p) {
  if (!pages[p]) return;
  Object.keys(pages).forEach(k => {
    pages[k].style.display = (k === p) ? '' : 'none';
  });
  Object.keys(navButtons).forEach(k => {
    navButtons[k].classList.toggle('active', k === p);
  });
  animateRightPanel(p === 'home');
  animateNameplate(p === 'home');

  // Settings page wiring
  if (p === 'settings') {
    const _input = document.getElementById('settingsUsernameInput');
    const _btn = document.getElementById('settingsUsernameBtn');
    const _sel = document.getElementById('bannerThemeSelect');
    const _apply = document.getElementById('bannerApplyBtn');

    if (_input) { _input.value = state.username || ''; }
    if (_btn) {
      _btn.onclick = () => changeUsername((_input && _input.value) || '');
    }
    if (_sel) {
      _sel.onchange = () => applyBannerTheme(_sel.value);
    }
    if (_apply) {
      _apply.onclick = () => applyBannerTheme((_sel && _sel.value) || 'classic');
    }
  }

  if (p === 'home') {
    loadBannerTheme();
  }

  state.page = p;
}

function animateRightPanel(show) {
  if (show) {
    rightPanel.setAttribute('aria-hidden','false');
    rightPanel.classList.remove('hidden');
  } else {
    rightPanel.classList.add('hidden');
    setTimeout(() => rightPanel.setAttribute('aria-hidden','true'), 300);
  }
}

function animateNameplate(show) {
  if (show) {
    nameplate.setAttribute('aria-hidden','false');
    nameplate.classList.remove('hidden');
  } else {
    nameplate.classList.add('hidden');
    setTimeout(() => nameplate.setAttribute('aria-hidden','true'), 300);
  }
}

/* ======= LEVEL / STATS ======= */
function levelForXP(xp) {
  const scaledXp = xp / XP_LEVEL_SCALE;
  let cur = LEVELS[0];
  for (let i = 0; i < LEVELS.length; i++) {
    if (scaledXp >= LEVELS[i].lvl) cur = LEVELS[i];
    else break;
  }
  return cur;
}
function nextLevelInfo(xp) {
  const scaledXp = xp / XP_LEVEL_SCALE;
  for (let i = 0; i < LEVELS.length; i++) {
    if (scaledXp < LEVELS[i].lvl) return LEVELS[i];
  }
  return null;
}
function updateLevelFromXP() {
  const cur = levelForXP(state.xp);
  state.level = cur.lvl;
  const next = nextLevelInfo(state.xp);
  levelNameEl.textContent = cur.name + (cur.lvl ? ` (Lv ${cur.lvl})` : " (Lv 0)");

  const scaledXp = state.xp / XP_LEVEL_SCALE;

  if (next) {
    const span = Math.max(1, next.lvl - cur.lvl);
    const progress = Math.min(
      100,
      Math.floor(((scaledXp - cur.lvl) / span) * 100)
    );
    const neededXp = Math.max(0, next.lvl * XP_LEVEL_SCALE - state.xp);
    levelProgressEl.textContent = `${state.xp} XP — ${neededXp} XP to ${next.name} (Lv ${next.lvl})`;
    progressInner.style.width = progress + "%";
  } else {
    levelProgressEl.textContent = `${state.xp} XP — Max rank reached`;
    progressInner.style.width = "100%";
  }
}

function recomputeSPC() {
  const chef = state.owned["sushi_chef"] || 0;
  const master = state.owned["sushi_master"] || 0;
  state.spc = 1 + chef * 1 + master * 10;
  statSPC.textContent = state.spc;
}

function recomputeCPS() {
  let total = 0;
  upgradeRows.forEach(row => {
    const key = row.dataset.key;
    const cps = Number(row.dataset.cps || 0);
    const owned = Number(state.owned[key] || 0);
    total += cps * owned;
  });
  state.cps = total;
  statCPS.textContent = total;
}

function currentCost(base, owned) {
  return Math.floor(base * Math.pow(1.6, owned));
}

function renderCosts() {
  upgradeRows.forEach(row => {
    const key = row.dataset.key;
    const base = Number(row.dataset.base || 0);
    const owned = Number(state.owned[key] || 0);
    const cost = currentCost(base, owned);
    const costEl = document.getElementById(`cost-${key}`);
    if (costEl) costEl.textContent = cost.toLocaleString();
    row.classList.toggle("disabled", state.clicks < cost);
  });
}

function renderAll() {
  sushiCounter.textContent = Math.floor(state.clicks).toLocaleString();
  statClicks.textContent = Math.floor(state.clicks).toLocaleString();
  recomputeSPC();
  recomputeCPS();
  updateLevelFromXP();
  renderCosts();
}

/* ======= BANNER THEME (LOCAL-ONLY) ======= */
const BANNER_THEMES = {
  classic: "linear-gradient(90deg, #f5df79, #ff9a6b)",
  ocean: "linear-gradient(90deg, #33c4c9, #2b6cb0)",
  sakura: "linear-gradient(90deg, #ff9acb, #ff5f7b)",
  jade: "linear-gradient(90deg, #43c68c, #1f8f4d)",
  midnight: "linear-gradient(90deg, #6b46c1, #2c5282)"
};

function applyBannerTheme(key) {
  const theme = BANNER_THEMES[key] || BANNER_THEMES.classic;
  if (nameplate) {
    nameplate.style.background = theme;
  }
  try {
    localStorage.setItem("SushiGo_banner_theme", key);
  } catch (_) {}
}

function loadBannerTheme() {
  let key = "classic";
  try {
    const stored = localStorage.getItem("SushiGo_banner_theme");
    if (stored) key = stored;
  } catch (_) {}
  applyBannerTheme(key);
  if (bannerThemeSelect) {
    bannerThemeSelect.value = key;
  }
}

/* ======= USERNAME / PROFILE FLOW ======= */
function setUsername(name) {
  state.username = name;
  if (nameText) nameText.textContent = name;
}

async function hydrateFromDB() {
  if (!state.username) return;
  const uid = await ensureUser(state.username);
  if (!uid) return;
  const row = await loadOrCreatePlayerState(uid);
  if (row) {
    state.clicks = Number(row.clicks || 0);
    state.xp = Number(row.xp || 0);
    state.level = Number(row.level || 0);
    try {
      state.owned = row.upgrades || {};
    } catch (_) {
      state.owned = {};
    }
    renderAll();
    saveToLocal();
    saveDirty = false;
    if (settingsUsernameInput) {
      settingsUsernameInput.value = state.username || '';
    }
    loadBannerTheme();
  }
}

async function maybePromptForUsername() {
  try {
    const storedName = localStorage.getItem("SushiGo_username");
    const storedId = localStorage.getItem("SushiGo_user_id");
    if (storedName && storedName.trim()) {
      setUsername(storedName.trim());
      if (storedId) {
        state.userId = storedId;
      }
      await hydrateFromDB();
      return;
    }
  } catch (e) {}

  usernameModal.style.display = "flex";
  setTimeout(() => usernameInput.focus(), 50);
}

async function saveUsernameFromModal() {
  const val = (usernameInput.value || "").trim();
  if (!val) {
    usernameInput.focus();
    return;
  }
  try {
    localStorage.setItem("SushiGo_username", val);
  } catch (e) {}
  setUsername(val);
  usernameModal.style.display = "none";
  showToast("Username saved");
  await hydrateFromDB();
}

/**
 * Settings: change username while copying progress to new account.
 */
async function changeUsername(newNameRaw) {
  const newName = (newNameRaw || "").trim();
  if (!newName) {
    showToast("Enter a name first");
    return;
  }
  if (newName === state.username) {
    showToast("Already using that name");
    return;
  }
  if (!supabaseClient) {
    showToast("Offline – can't change name");
    return;
  }

  try {
    let { data, error } = await supabaseClient
      .from('users')
      .select('id, username')
      .eq('username', newName)
      .maybeSingle();
    if (error) {
      console.warn("changeUsername lookup error:", error);
    }

    let targetRow = data;
    if (!targetRow) {
      const { data: ins, error: insErr } = await supabaseClient
        .from('users')
        .insert({ username: newName })
        .select('id, username')
        .single();
      if (insErr) {
        console.warn("changeUsername insert error:", insErr);
        showToast("Couldn't change name");
        return;
      }
      targetRow = ins;
    }

    const payload = {
      user_id: targetRow.id,
      clicks: Math.floor(state.clicks),
      level: state.level,
      xp: Math.floor(state.xp),
      upgrades: state.owned,
      last_active: new Date().toISOString()
    };
    const { error: psErr } = await supabaseClient
      .from('player_state')
      .upsert(payload);
    if (psErr) {
      console.warn("Copy state error:", psErr);
    }

    state.username = newName;
    state.userId = targetRow.id;
    if (nameText) nameText.textContent = newName;

    try {
      localStorage.setItem("SushiGo_username", newName);
      localStorage.setItem("SushiGo_user_id", targetRow.id);
    } catch (_) {}

    saveToLocal();

    if (settingsUsernameInput) {
      settingsUsernameInput.value = newName;
    }
    showToast("Username updated");
  } catch (e) {
    console.error("changeUsername exception", e);
    showToast("Couldn't change name");
  }
}

/* ======= GAME INTERACTION ======= */
if (sushiImg) {
  sushiImg.addEventListener("click", () => {
    state.clicks += state.spc;
    state.xp += state.spc;
    sushiImg.style.transform = "scale(0.96)";
    setTimeout(() => sushiImg.style.transform = "", 100);
    renderAll();
    markDirty();
  });
}

upgradeRows.forEach(row => {
  row.addEventListener("click", () => {
    const key = row.dataset.key;
    const base = Number(row.dataset.base || 0);
    const owned = Number(state.owned[key] || 0);
    const cost = currentCost(base, owned);
    if (state.clicks < cost) {
      showToast("Not enough sushi");
      return;
    }
    state.clicks -= cost;
    state.owned[key] = owned + 1;

    const burst = Number(row.dataset.burst || 0);
    if (burst) {
      state.clicks += burst;
      state.xp += burst;
      showToast(`Burst +${burst} sushi!`);
    }

    renderAll();
    markDirty();
    logPurchase(key, 1, cost);
    const titleEl = row.querySelector(".upgrade-title");
    if (titleEl) {
      showToast(`Bought ${titleEl.textContent}`);
    }
  });
});

/* Autoclicker tick + autosave flagging */
setInterval(() => {
  if (state.cps > 0) {
    state.clicks += state.cps;
    state.xp += state.cps;
    renderAll();
    markDirty();
  }
}, 1000);

/* Periodic autosave even if debounce hasn't fired yet */
setInterval(() => {
  if (saveDirty) {
    dbSave();
    saveDirty = false;
  }
}, 7000);

/* Save on tab close / hide */
window.addEventListener('beforeunload', () => {
  dbSave();
});
window.addEventListener('pagehide', () => {
  dbSave();
});
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    dbSave();
  }
});

/* ======= INITIALIZATION ======= */
(async function init() {
  await initSupabase();

  // Temporary display name until we hydrate a real one
  setUsername(randName());
  loadFromLocal();
  renderAll();

  // Nav
  if (navButtons.home) navButtons.home.addEventListener('click', () => setPage('home'));
  if (navButtons.mult) navButtons.mult.addEventListener('click', () => setPage('mult'));
  if (navButtons.stocks) navButtons.stocks.addEventListener('click', () => setPage('stocks'));
  if (navButtons.goodies) navButtons.goodies.addEventListener('click', () => setPage('goodies'));

  if (settingsGear) {
    settingsGear.addEventListener('click', () => setPage('settings'));
  }

  if (usernameSave) {
    usernameSave.addEventListener('click', saveUsernameFromModal);
  }
  if (usernameInput) {
    usernameInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') saveUsernameFromModal();
    });
  }

  // Settings initial wiring
  if (settingsUsernameInput) {
    settingsUsernameInput.value = state.username || '';
  }
  if (settingsUsernameBtn) {
    settingsUsernameBtn.addEventListener('click', () => changeUsername(settingsUsernameInput.value));
  }
  if (bannerApplyBtn && bannerThemeSelect) {
    bannerApplyBtn.addEventListener('click', () => applyBannerTheme(bannerThemeSelect.value));
  }
  if (bannerThemeSelect) {
    bannerThemeSelect.addEventListener('change', () => applyBannerTheme(bannerThemeSelect.value));
  }

  loadBannerTheme();
  await maybePromptForUsername();
  setPage('home');
})();
</script>
</body>
</html>
